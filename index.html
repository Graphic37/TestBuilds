<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMORPG - Room Based</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            overflow-x: hidden;
            overflow-y: hidden;
            user-select: none;
            image-rendering: crisp-edges;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #gameContainer {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 260px;
            width: calc(100% - 260px);
            height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            transition: left 0.3s, width 0.3s;
        }
        
        #gameCanvas.expanded {
            left: 20px;
            width: calc(100% - 20px);
        }

        /* Left Sidebar Menu */
        #leftSidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border-right: 2px solid #2a3a4a;
            z-index: 20;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s;
        }

        #leftSidebar.collapsed {
            transform: translateX(-240px);
        }

        .sidebar-toggle {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border: 2px solid #2a3a4a;
            border-left: none;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a9a8a;
            font-size: 18px;
        }

        .menu-section {
            margin-bottom: 10px;
            border-bottom: 1px solid #2a3a4a;
        }

        .menu-header {
            padding: 12px 20px;
            color: #8a9aaa;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #cad2da;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 15px;
        }

        .menu-item:hover {
            background: rgba(74, 154, 138, 0.2);
            color: #4a9a8a;
            padding-left: 25px;
        }

        .menu-item.active {
            background: rgba(74, 154, 138, 0.3);
            color: #5abaaa;
            border-left: 3px solid #5abaaa;
        }

        .menu-icon {
            width: 28px;
            height: 28px;
            margin-right: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Skills Grid */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            padding: 0 12px 8px 12px;
        }

        .skill-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(20, 30, 40, 0.5);
            border: 1px solid #2a3a4a;
            border-radius: 3px;
            padding: 3px 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-item:hover {
            background: rgba(74, 154, 138, 0.2);
            border-color: #4a9a8a;
            transform: scale(1.05);
        }

        .skill-icon {
            font-size: 14px;
            margin-right: 3px;
        }

        .skill-level {
            color: #8a9aaa;
            font-size: 11px;
            font-weight: bold;
        }

        .total-level {
            padding: 6px 12px;
            color: #5abaaa;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            border-top: 1px solid #2a3a4a;
        }

        <!-- Top UI Bar -->
        #topBar {
            position: absolute;
            top: 10px;
            left: 270px;
            right: 20px;
            height: 50px;
            background: linear-gradient(135deg, rgba(26, 35, 50, 0.95) 0%, rgba(15, 22, 32, 0.95) 100%);
            border: 2px solid #2a3a4a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 15;
            transition: left 0.3s;
        }

        .resource-display {
            display: flex;
            align-items: center;
            margin-right: 30px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .afk-toggle {
            padding: 8px 20px;
            background: linear-gradient(135deg, #2a5a4a, #1a4a3a);
            color: #5abaaa;
            border: 2px solid #3a6a5a;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: auto;
        }

        .afk-toggle:hover {
            background: linear-gradient(135deg, #3a6a5a, #2a5a4a);
            transform: translateY(-1px);
        }

        .afk-toggle.active {
            background: linear-gradient(135deg, #4a8a5a, #3a7a4a);
            border-color: #5a9a6a;
            color: #6afa6a;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Inventory UI - Exact Match */
        #inventoryUI {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%);
            border: 3px solid #2a4a5a;
            border-radius: 15px;
            display: none;
            z-index: 100;
            width: 1400px;
            max-width: 90vw;
            height: 85vh;
            max-height: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            overflow: hidden;
        }

        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid #2a4a5a;
        }

        .inv-header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .gold-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #2a3a30, #1a2a20);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #4a6a50;
        }

        .gold-display .coin-icon {
            width: 20px;
            height: 20px;
        }

        .gold-amount {
            color: #FFD700;
            font-weight: bold;
            font-size: 18px;
        }

        .space-display {
            color: #8a9aaa;
            font-size: 16px;
        }

        .inv-header-right {
            display: flex;
            gap: 10px;
        }

        .inv-header-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #2a5a5a, #1a4a4a);
            color: #5abaaa;
            border: 2px solid #3a6a6a;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .inv-header-btn:hover {
            background: linear-gradient(135deg, #3a6a6a, #2a5a5a);
            transform: translateY(-1px);
        }

        .lock-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8a3a3a, #6a2a2a);
            border: 2px solid #aa5a5a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .manage-btn {
            background: linear-gradient(135deg, #2a5a4a, #1a4a3a);
            border-color: #3a6a5a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #8a3a3a, #6a2a2a);
            border: 2px solid #aa5a5a;
            border-radius: 50%;
            color: #ff8a8a;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: linear-gradient(135deg, #9a4a4a, #7a3a3a);
            transform: scale(1.1);
        }

        .inv-search-bar {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(0,0,0,0.2);
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(10, 20, 30, 0.8);
            border: 2px solid #2a4a5a;
            border-radius: 8px;
            color: #8a9aaa;
            font-size: 14px;
            font-style: italic;
        }

        .search-input::placeholder {
            color: #5a6a7a;
        }

        .search-btn {
            padding: 10px 30px;
            background: linear-gradient(135deg, #2a5a5a, #1a4a4a);
            color: #5abaaa;
            border: 2px solid #3a6a6a;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .inv-body {
            display: flex;
            padding: 25px;
            gap: 20px;
        }

        .inv-main {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        /* Inventory Grid */
        .inv-grid-container {
            flex: 1;
            max-height: calc(85vh - 250px);
            min-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
            position: relative;
        }
        
        /* Fade indicator at bottom - removed to prevent blocking */
        
        /* Custom scrollbar for inventory */
        .inv-grid-container::-webkit-scrollbar {
            width: 12px;
        }
        
        .inv-grid-container::-webkit-scrollbar-track {
            background: rgba(20, 30, 40, 0.5);
            border-radius: 6px;
        }
        
        .inv-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-radius: 6px;
            border: 2px solid #2a3a4a;
        }
        
        .inv-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4a6a7a, #3a5a6a);
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            padding-bottom: 20px;
        }

        .inv-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .inv-slot:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
            transform: scale(1.05);
        }

        .inv-slot.empty {
            background: linear-gradient(135deg, #1a3a4a, #0a2a3a);
            border-color: #2a4a5a;
        }

        .inv-slot.occupied {
            background: linear-gradient(135deg, #6a4a4a, #5a3a3a);
            border-color: #8a5a5a;
            position: relative;
        }

        .item-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 56px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-quantity {
            position: absolute;
            bottom: 3px;
            right: 3px;
            background: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            font-size: 14px;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        }

        /* Category Icons */
        .category-bar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 60px;
        }

        .cat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5abaaa;
            font-size: 30px;
            transition: all 0.2s;
            position: relative;
        }

        .cat-icon:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
            transform: scale(1.1);
        }

        .cat-icon.active {
            background: linear-gradient(135deg, #4a7a6a, #3a6a5a);
            border-color: #5a8a7a;
        }

        .cat-icon.x-btn {
            background: linear-gradient(135deg, #3a5a5a, #2a4a4a);
        }

        /* Equipment Panel */
        .equipment-panel {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .equip-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .equip-slot-spacer {
            /* Empty spacer for centered items */
        }

        .equip-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .equip-slot.empty {
            background: linear-gradient(135deg, #1a2a3a, #0a1a2a);
            border-color: #2a3a4a;
            opacity: 0.6;
        }

        .equip-slot.equipped {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a7a8a;
            opacity: 1;
        }

        .equip-slot.equipped::before {
            opacity: 1;
            color: #5abaaa;
        }

        .equip-slot.empty::after {
            content: attr(data-slot);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3a4a5a;
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.5;
        }

        .equip-slot:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
            transform: scale(1.05);
        }

        .equip-slot::before {
            content: attr(data-icon);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3a5a6a;
            font-size: 40px;
        }

        .equipment-bonuses {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2a4a5a;
        }

        .bonus-header {
            color: #8a9aaa;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bonus-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #5a7a8a;
            font-size: 13px;
        }

        .bonus-icon {
            font-size: 16px;
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, #2a3a4a, #1a2a3a);
            border: 2px solid #4a6a7a;
            border-radius: 6px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
        }

        .tooltip.show {
            display: block;
        }

        .tooltip-empty {
            color: #8a9aaa;
        }

        .tooltip-item {
            color: #5abaaa;
        }

        /* Login Modal */
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border: 3px solid #2a3a4a;
            border-radius: 15px;
            padding: 40px;
            width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .login-title {
            color: #5abaaa;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .google-login-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: #444;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .google-login-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .guest-login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            color: #8a9aaa;
            border: 2px solid #4a6a7a;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .guest-login-btn:hover {
            background: linear-gradient(135deg, #4a6a7a, #3a5a6a);
            border-color: #5a7a8a;
            color: #9aaaba;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .guest-warning {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 150, 50, 0.1);
            border: 2px solid rgba(255, 150, 50, 0.3);
            border-radius: 8px;
            color: #ffaa66;
            font-size: 13px;
            line-height: 1.5;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-left: auto;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #5abaaa;
        }

        .user-name {
            color: #5abaaa;
            font-weight: bold;
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255, 50, 50, 0.2);
            color: #ff6666;
            border: 1px solid #ff4444;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 50, 50, 0.4);
        }


        /* Grand Exchange Modal - OSRS Style */

        /* OSRS-Style Input Controls */
        .ge-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .ge-minus-btn, .ge-plus-btn {
            width: 35px;
            height: 35px;
            background: #3a2f1e;
            border: 2px solid #5a4d3a;
            color: #ff9933;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ge-minus-btn:hover, .ge-plus-btn:hover {
            background: #4a3f2e;
            border-color: #ff9933;
        }

        .ge-form-input-center {
            flex: 1;
            padding: 10px;
            background: #2a1f0e;
            border: 2px solid #5a4d3a;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .ge-form-input-center:focus {
            outline: none;
            border-color: #ff9933;
        }

        .ge-price-btn-side {
            width: 35px;
            height: 35px;
            background: #3a2f1e;
            border: 2px solid #5a4d3a;
            color: #ff9933;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ge-price-btn-side:hover {
            background: #4a3f2e;
            border-color: #ff9933;
        }

        /* Selected Item Display */
        .ge-selected-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border: 2px solid #5a4d3a;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .ge-item-display {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .ge-item-icon-large {
            font-size: 36px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #5a4d3a;
            border-radius: 5px;
        }

        .ge-item-info {
            flex: 1;
        }

        .ge-item-name-large {
            color: #ff9933;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ge-item-available {
            color: #ffff00;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .ge-item-price-info {
            color: #00ff00;
            font-size: 12px;
        }

        /* Total Display OSRS Style */
        .ge-total-display-osrs {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #5a4d3a;
            text-align: center;
        }

        .ge-total-amount-large {
            color: #ffff00;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }

        /* Action Buttons OSRS Style */
        .ge-action-buttons-osrs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .ge-back-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #5a4d3a 0%, #4a3d2a 100%);
            border: 2px solid #6a5d4a;
            color: #ff9933;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-back-btn:hover {
            background: linear-gradient(135deg, #6a5d4a 0%, #5a4d3a 100%);
        }

        .ge-confirm-btn-osrs {
            flex: 2;
            padding: 15px;
            background: linear-gradient(135deg, #00aa00 0%, #008800 100%);
            border: 2px solid #00ff00;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-confirm-btn-osrs:hover {
            background: linear-gradient(135deg, #00cc00 0%, #00aa00 100%);
        }

        .ge-confirm-btn-osrs:disabled {
            background: #3a3a3a;
            border-color: #5a5a5a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .ge-download-icon, .ge-upload-icon {
            font-size: 14px;
            opacity: 0.7;
        }

        #grandExchangeModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            max-height: 90vh;
            background: linear-gradient(135deg, #3d3021 0%, #2e2014 100%);
            border: 3px solid #847256;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .ge-header {
            background: linear-gradient(135deg, #544633 0%, #433629 100%);
            border-bottom: 2px solid #847256;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ge-title {
            color: #ff9933;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }

        .ge-close-btn {
            width: 30px;
            height: 30px;
            background: #8b0000;
            color: white;
            border: 2px solid #660000;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }

        .ge-close-btn:hover {
            background: #a00000;
        }

        .ge-collect-all-btn {
            padding: 6px 16px;
            background: linear-gradient(135deg, #2a5a4a, #1a4a3a);
            color: #5abaaa;
            border: 2px solid #3a6a5a;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            margin-right: auto;
            margin-left: 20px;
            transition: all 0.2s;
        }

        .ge-collect-all-btn:hover {
            background: linear-gradient(135deg, #3a6a5a, #2a5a4a);
            transform: translateY(-1px);
        }

        .ge-collect-all-btn:active {
            transform: translateY(0);
        }

        .ge-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .ge-slots-container {
            width: 500px;
            padding: 20px;
            border-right: 2px solid #847256;
            overflow-y: auto;
        }

        .slots-section {
            margin-bottom: 25px;
        }

        .slots-section-title {
            color: #ff9933;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            text-shadow: 1px 1px 0 #000;
        }

        .offer-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .offer-slot {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #3a2f1e 0%, #2a1f0e 100%);
            border: 2px solid #5a4d3a;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }

        .offer-slot:hover {
            border-color: #ff9933;
            transform: scale(1.05);
        }

        .offer-slot.empty::before {
            content: '+';
            font-size: 40px;
            color: #5a4d3a;
        }

        .offer-slot.empty:hover::before {
            color: #ff9933;
        }
        
        /* Hide ::before when slot has content */
        .offer-slot:not(.empty)::before {
            display: none;
        }

        .offer-slot.active {
            border-color: #00ff00;
            background: linear-gradient(135deg, #2a3f1e 0%, #1a2f0e 100%);
        }

        .offer-slot.completed {
            border-color: #ffff00;
            background: linear-gradient(135deg, #4a4f1e 0%, #3a3f0e 100%);
        }

        .offer-slot.partial {
            border-color: #ffa500;
            background: linear-gradient(135deg, #4a3f1e 0%, #3a2f0e 100%);
        }

        .slot-item-icon {
            font-size: 32px;
            margin-bottom: 5px;
            display: block;
        }

        .slot-item-name {
            font-size: 10px;
            color: #ff9933;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .slot-quantity {
            font-size: 9px;
            color: #ffff00;
            display: block;
        }
        
        .slot-progress-bar {
            width: 90%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #3a2f1e;
            border-radius: 3px;
            margin: 3px 0;
            overflow: hidden;
        }
        
        .slot-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .slot-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            color: #00ff00;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .ge-details-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .ge-details-content {
            display: none;
        }

        .ge-details-content.active {
            display: block;
        }

        .details-title {
            color: #ff9933;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 1px 1px 0 #000;
        }

        .offer-form {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border: 2px solid #5a4d3a;
            border-radius: 5px;
        }

        .ge-form-group {
            margin-bottom: 20px;
        }

        .ge-form-label {
            color: #ff9933;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .ge-form-input {
            width: 100%;
            padding: 10px;
            background: #2a1f0e;
            border: 2px solid #5a4d3a;
            color: white;
            font-size: 14px;
        }

        .ge-form-input:focus {
            outline: none;
            border-color: #ff9933;
        }

        .ge-item-search {
            width: 100%;
            padding: 10px;
            background: #2a1f0e;
            border: 2px solid #5a4d3a;
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .ge-item-results {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #5a4d3a;
            background: #2a1f0e;
        }

        .ge-item-result {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #3a2d1a;
        }

        .ge-item-result:hover {
            background: #3a2f1e;
        }

        .ge-item-result-icon {
            font-size: 32px;
        }

        .ge-item-result-info {
            flex: 1;
        }

        .ge-item-result-name {
            color: #ff9933;
            font-weight: bold;
        }

        .ge-search-highlight {
            background: rgba(255, 215, 0, 0.4);
            padding: 2px 4px;
            border-radius: 3px;
            color: #FFD700;
            font-weight: bold;
        }

        .ge-item-result-price {
            color: #ffff00;
            font-size: 12px;
        }

        .ge-price-controls, .ge-quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .ge-price-btn, .ge-qty-btn {
            padding: 8px 12px;
            background: #3a2f1e;
            border: 2px solid #5a4d3a;
            color: #ff9933;
            cursor: pointer;
            font-weight: bold;
            min-width: 50px;
        }

        .ge-price-btn:hover, .ge-qty-btn:hover {
            background: #4a3f2e;
            border-color: #ff9933;
        }

        .ge-guide-price {
            color: #00ff00;
            font-size: 12px;
            margin-top: 5px;
        }

        .ge-total-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #5a4d3a;
            text-align: center;
        }

        .ge-total-label {
            color: #ff9933;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .ge-total-amount {
            color: #ffff00;
            font-size: 24px;
            font-weight: bold;
        }

        .ge-total-amount .gp {
            font-size: 14px;
            color: #ffa500;
        }

        .ge-offer-status-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border: 2px solid #5a4d3a;
            border-radius: 5px;
        }

        .ge-status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3a2d1a;
        }

        .ge-status-label {
            color: #ff9933;
            font-size: 14px;
        }

        .ge-status-value {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .ge-progress-bar {
            width: 100%;
            height: 20px;
            background: #2a1f0e;
            border: 2px solid #5a4d3a;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .ge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #00aa00 100%);
            transition: width 0.3s;
        }

        .ge-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .ge-confirm-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #00aa00 0%, #008800 100%);
            border: 2px solid #00ff00;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-confirm-btn:hover {
            background: linear-gradient(135deg, #00cc00 0%, #00aa00 100%);
        }

        .ge-confirm-btn:disabled {
            background: #3a3a3a;
            border-color: #5a5a5a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .ge-cancel-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #aa0000 0%, #880000 100%);
            border: 2px solid #ff0000;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-cancel-btn:hover {
            background: linear-gradient(135deg, #cc0000 0%, #aa0000 100%);
        }

        .ge-collect-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            border: 2px solid #ffcc00;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
            margin-top: 10px;
        }

        .ge-collect-btn:hover {
            background: linear-gradient(135deg, #ffcc00 0%, #ffaa00 100%);
        }

        .ge-empty-state {
            text-align: center;
            padding: 40px;
            color: #8a7a6a;
        }

        .ge-empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .ge-empty-state-text {
            font-size: 16px;
        }

        .ge-tax-notice {
            color: #ffa500;
            font-size: 12px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #ffa500;
            border-radius: 3px;
        }

        /* Market Wiki Styles */
        .wiki-filter-btn.active {
            box-shadow: 0 0 15px rgba(212, 167, 106, 0.6);
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .wiki-period-btn.active {
            background: #7a6a5a !important;
            border: 2px solid #9a8a7a !important;
            color: #FFD700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            transition: all 0.2s;
        }

        .wiki-filter-btn:hover, .wiki-period-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        /* Search Input Styles */
        #wikiSearchInput:focus {
            border-color: #d4a76a !important;
            box-shadow: 0 0 10px rgba(212, 167, 106, 0.5);
            outline: none;
        }

        #wikiSearchInput::placeholder {
            color: #6a5a4a;
        }

        #clearSearchBtn:hover {
            background: #8a6a6a !important;
        }

        /* Activity Tracker Pulse Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 8px #5abaaa;
            }
            50% {
                opacity: 0.6;
                box-shadow: 0 0 15px #5abaaa;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Left Sidebar -->
        <div id="leftSidebar">
            <div class="sidebar-toggle">‚ü©</div>
            
            <div class="menu-section">
                <div class="menu-header">Account</div>
                <div class="menu-item">
                    <span class="menu-icon">üè†</span>
                    <span>Profile</span>
                </div>
                <div class="menu-item active">
                    <span class="menu-icon">üéí</span>
                    <span>Inventory</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Community</div>
                <div class="menu-item">
                    <span class="menu-icon">üõ°Ô∏è</span>
                    <span>Clan</span>
                </div>
                <div class="menu-item">
                    <span class="menu-icon">üí±</span>
                    <span>Player market</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Activities ‚áÑ</div>
                <div class="menu-item" data-room="raids">
                    <span class="menu-icon">üè∞</span>
                    <span>Raids</span>
                </div>
                <div class="menu-item" data-room="combat">
                    <span class="menu-icon">‚öîÔ∏è</span>
                    <span>Combat</span>
                </div>

                <div class="menu-item" data-room="crafting">
                    <span class="menu-icon">üî®</span>
                    <span>Crafting</span>
                </div>

                <div class="menu-item" data-room="woodcutting">
                    <span class="menu-icon">ü™ì</span>
                    <span>Woodcutting</span>
                </div>
                <div class="menu-item" data-room="fishing">
                    <span class="menu-icon">üé£</span>
                    <span>Fishing</span>
                </div>
                <div class="menu-item" data-room="mining">
                    <span class="menu-icon">‚õèÔ∏è</span>
                    <span>Mining</span>
                </div>
                <div class="menu-item" data-room="cooking">
                    <span class="menu-icon">üç≥</span>
                    <span>Cooking</span>
                </div>
                <div class="menu-item" data-room="farming">
                    <span class="menu-icon">üå±</span>
                    <span>Farming</span>
                </div>
                <div class="menu-item" data-room="agility">
                    <span class="menu-icon">üèÉ</span>
                    <span>Agility</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Skills</div>
                <div class="skills-grid">
                    <div class="skill-item" title="Hitpoints">
                        <span class="skill-icon">‚ù§Ô∏è</span>
                        <span class="skill-level">10</span>
                    </div>
                    <div class="skill-item" title="Attack">
                        <span class="skill-icon">‚öîÔ∏è</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Mining">
                        <span class="skill-icon">‚õèÔ∏è</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Strength">
                        <span class="skill-icon">üí™</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Agility">
                        <span class="skill-icon">üèÉ</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Defence">
                        <span class="skill-icon">üõ°Ô∏è</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Fishing">
                        <span class="skill-icon">üé£</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Ranged">
                        <span class="skill-icon">üèπ</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Cooking">
                        <span class="skill-icon">üç≥</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Crafting">
                        <span class="skill-icon">üßµ</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Carpentry">
                        <span class="skill-icon">üî®</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Magic">
                        <span class="skill-icon">‚ú®</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Woodcutting">
                        <span class="skill-icon">ü™ì</span>
                        <span class="skill-level">1</span>
                    </div>


                    <div class="skill-item" title="Farming">
                        <span class="skill-icon">üå±</span>
                        <span class="skill-level">1</span>
                    </div>


                    <div class="skill-item" title="Combat">
                        <span class="skill-icon">‚öîÔ∏è</span>
                        <span class="skill-level">3</span>
                    </div>
                </div>
                <div class="total-level">Total: <span id="totalLevel">34</span></div>
            </div>
        </div>

        <!-- Top Bar -->
        <div id="topBar">
            <div class="resource-display">
                <div class="coin-icon"></div>
                <span style="color: #FFD700; font-weight: bold; font-size: 18px;" id="goldAmount">100,965</span>
            </div>
            <div class="resource-display" style="background: rgba(74, 154, 138, 0.2); border: 1px solid #4a9a8a;">
                <span style="color: #5abaaa;" id="currentRoom">Woodcutting Area</span>
            </div>
            
            <button class="afk-toggle active" id="afkToggle">AFK Mode</button>
        </div>

        <!-- Modern Activity Tracker - Separate Overlay -->
        <div id="activityTracker" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: linear-gradient(135deg, rgba(26, 35, 50, 0.98) 0%, rgba(15, 22, 32, 0.98) 100%); border: 2px solid #2a3a4a; border-radius: 12px; padding: 12px 16px; min-width: 280px; max-width: 320px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); cursor: move;">
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Activity Header (Draggable) -->
                <div id="trackerDragHandle" style="display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(90, 186, 170, 0.3); cursor: grab;">
                    <div style="width: 6px; height: 6px; border-radius: 50%; background: #5abaaa; box-shadow: 0 0 8px #5abaaa; animation: pulse 2s infinite;"></div>
                    <div style="color: #FFD700; font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;" id="activityName">Woodcutting</div>
                    <div style="margin-left: auto; color: #8a9aaa; font-size: 10px;">‚ãÆ‚ãÆ</div>
                </div>
                
                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <!-- Total Skill XP -->
                    <div style="background: linear-gradient(135deg, rgba(90, 186, 170, 0.15) 0%, rgba(90, 186, 170, 0.05) 100%); border: 1px solid rgba(90, 186, 170, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Total XP</div>
                        <div style="color: #5abaaa; font-size: 15px; font-weight: bold;" id="totalSkillXP">0</div>
                    </div>
                    
                    <!-- Session Items -->
                    <div style="background: linear-gradient(135deg, rgba(0, 191, 255, 0.15) 0%, rgba(0, 191, 255, 0.05) 100%); border: 1px solid rgba(0, 191, 255, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Session</div>
                        <div style="color: #00BFFF; font-size: 15px; font-weight: bold;" id="sessionItems">0</div>
                    </div>
                    
                    <!-- XP per Hour -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">XP/HR</div>
                        <div style="color: #FFD700; font-size: 15px; font-weight: bold;"><span id="xpPerHour">0</span></div>
                    </div>
                    
                    <!-- Items per Hour -->
                    <div style="background: linear-gradient(135deg, rgba(170, 90, 250, 0.15) 0%, rgba(170, 90, 250, 0.05) 100%); border: 1px solid rgba(170, 90, 250, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Items/HR</div>
                        <div style="color: #aa5afa; font-size: 15px; font-weight: bold;"><span id="itemsPerHour">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory UI -->
        <div id="inventoryUI">
            
            <div class="inv-header">
                <div class="inv-header-left">
                    <div class="gold-display">
                        <div class="coin-icon"></div>
                        <span class="gold-amount" id="invGold">100,965</span>
                    </div>
                    <div class="space-display">
                        Space: <span id="invSpace">38</span>/98
                    </div>
                </div>
                <div class="inv-header-right">
                    <div class="lock-btn">üîí</div>
                    <button class="inv-header-btn" id="sortBtn">Sort</button>
                    <button class="inv-header-btn manage-btn">
                        <span>‚öôÔ∏è</span>
                        <span>Manage</span>
                    </button>
                    <button class="close-btn" id="closeInventory">‚úñ</button>
                </div>
            </div>
            
            <div class="inv-search-bar">
                <input type="text" class="search-input" placeholder="Search for an item...">
                <button class="search-btn">Search</button>
                <button class="search-btn">Reset</button>
            </div>

            <div class="inv-body">
                <div class="inv-main">
                    <div class="inv-grid-container">
                        <div class="inv-grid" id="inventoryGrid"></div>
                    </div>
                    
                    <div class="category-bar">
                        <div class="cat-icon x-btn" title="Clear all">‚úñ</div>
                        <div class="cat-icon" title="Armor">üëî</div>
                        <div class="cat-icon" title="Weapons">‚öîÔ∏è</div>
                        <div class="cat-icon" title="Tools">üî®</div>
                        <div class="cat-icon" title="Materials">üì¶</div>
                        <div class="cat-icon" title="Fish">üêü</div>
                        <div class="cat-icon" title="Food">üçñ</div>
                        <div class="cat-icon" title="Potions">üß™</div>
                    </div>
                </div>

                <div class="equipment-panel">
                    <div class="equip-grid">
                        <!-- Row 1: Head (centered) -->
                        <div class="equip-slot-spacer"></div>
                        <div class="equip-slot empty" data-slot="Head" data-icon=""></div>
                        <div class="equip-slot-spacer"></div>
                        
                        <!-- Row 2: Cape, Amulet, Arrows -->
                        <div class="equip-slot empty" data-slot="Cape" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Amulet" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Arrows" data-icon=""></div>
                        
                        <!-- Row 3: Weapon, Chest, Off Hand -->
                        <div class="equip-slot empty" data-slot="Weapon" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Chest" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Off-Hand" data-icon=""></div>
                        
                        <!-- Row 4: Gloves, Pants, Ring -->
                        <div class="equip-slot empty" data-slot="Gloves" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Legs" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Ring" data-icon=""></div>
                        
                        <!-- Row 5: Boots (centered) -->
                        <div class="equip-slot-spacer"></div>
                        <div class="equip-slot empty" data-slot="Boots" data-icon=""></div>
                        <div class="equip-slot-spacer"></div>
                    </div>

                    <div class="equipment-bonuses">
                        <div class="bonus-header">EQUIPMENT BONUSES</div>
                        <div class="bonus-stat">
                            <span class="bonus-icon">‚öîÔ∏è</span>
                            <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                        </div>
                        <div class="bonus-stat">
                            <span class="bonus-icon">üèπ</span>
                            <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                        </div>
                        <div class="bonus-stat">
                            <span class="bonus-icon">üîÆ</span>
                            <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-container">
            <div class="login-title">üéÆ MMORPG Login</div>
            <button class="google-login-btn" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                    <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                    <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                    <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                </svg>
                Sign in with Google
            </button>
            
            <div style="margin: 20px 0; color: #6a8a9a; font-size: 14px;">- OR -</div>
            
            <button class="guest-login-btn" id="guestLoginBtn">
                üë§ Play as Guest
            </button>
            
            <div class="guest-warning">
                ‚ö†Ô∏è Guest mode: Your progress won't be saved and you can't access the player market
            </div>
        </div>
    </div>

    <!-- Grand Exchange Modal -->
    <div id="grandExchangeModal">
        <div class="ge-header">
            <div class="ge-title">üìú Grand Exchange</div>
            <button class="ge-collect-all-btn" onclick="openMarketWiki()" style="margin-right: 10px; background: linear-gradient(135deg, #d4a76a 0%, #b8915a 100%);">üìä Market Wiki</button>
            <button class="ge-collect-all-btn" id="collectAllOffers">Collect All</button>
            <button class="ge-close-btn" id="closeGE">‚úñ</button>
        </div>

        <div class="ge-content">
            <!-- Left Side - Offer Slots -->
            <div class="ge-slots-container">
                <div class="slots-section">
                    <div class="slots-section-title">üîΩ Buy Offers</div>
                    <div class="offer-slots" id="buySlots">
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="3"></div>
                    </div>
                </div>

                <div class="slots-section">
                    <div class="slots-section-title">üîº Sell Offers</div>
                    <div class="offer-slots" id="sellSlots">
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="3"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Offer Details -->
            <div class="ge-details-container">
                <!-- Empty State -->
                <div class="ge-details-content active" id="emptyState">
                    <div class="ge-empty-state">
                        <div class="ge-empty-state-icon">üì¶</div>
                        <div class="ge-empty-state-text">Select an offer slot to buy or sell items</div>
                    </div>
                </div>

                <!-- Create Buy Offer -->
                <div class="ge-details-content" id="createBuyOffer">
                    <div class="details-title">üîΩ Buy offer <span class="ge-download-icon">‚¨áÔ∏è</span></div>
                    
                    <!-- Item Display -->
                    <div class="ge-selected-item" id="buySelectedItem" style="display: none;">
                        <div class="ge-item-display">
                            <div class="ge-item-icon-large" id="buyItemIcon">ü™µ</div>
                            <div class="ge-item-info">
                                <div class="ge-item-name-large" id="buyItemName">Select an item</div>
                                <div class="ge-item-price-info" id="buyItemPriceInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="ge-form-group" id="buySearchGroup">
                        <label class="ge-form-label">Choose item:</label>
                        <input type="text" class="ge-item-search" id="buyItemSearch" placeholder="Start typing...">
                        <div class="ge-item-results" id="buyItemResults"></div>
                    </div>

                    <!-- Quantity Controls (OSRS Style) -->
                    <div class="ge-form-group" id="buyQuantityGroup" style="display: none;">
                        <label class="ge-form-label">Quantity:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="buyQtyMinus">‚àí</button>
                            <input type="number" class="ge-form-input-center" id="buyQuantity" min="1" value="1">
                            <button class="ge-plus-btn" id="buyQtyPlus">+</button>
                        </div>
                        <div class="ge-quantity-controls">
                            <button class="ge-qty-btn" data-qty="1">+1</button>
                            <button class="ge-qty-btn" data-qty="10">+10</button>
                            <button class="ge-qty-btn" data-qty="100">+100</button>
                            <button class="ge-qty-btn" data-qty="1000">+1k</button>
                            <button class="ge-qty-btn" data-qty="-max">All</button>
                        </div>
                    </div>

                    <!-- Price Controls (OSRS Style) -->
                    <div class="ge-form-group" id="buyPriceGroup" style="display: none;">
                        <label class="ge-form-label">Price per item:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="buyPriceMinus">‚ñº</button>
                            <input type="number" class="ge-form-input-center" id="buyPrice" min="1" value="1">
                            <button class="ge-plus-btn" id="buyPricePlus">‚ñ≤</button>
                            <button class="ge-price-btn-side" id="buyPriceGuide">üí∞</button>
                            <button class="ge-price-btn-side" id="buyPriceMore">‚ñ≤‚ñ≤</button>
                        </div>
                        <div class="ge-guide-price" id="buyGuidePrice"></div>
                    </div>

                    <!-- Total Display -->
                    <div class="ge-total-display-osrs" id="buyTotal" style="display: none;">
                        <div class="ge-total-amount-large"><span id="buyTotalAmount">0</span> coins</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="ge-action-buttons-osrs" id="buyActions" style="display: none;">
                        <button class="ge-back-btn" id="buyBackBtn">‚Üê Back</button>
                        <button class="ge-confirm-btn-osrs" id="confirmBuy">Confirm</button>
                    </div>
                </div>

                <!-- Create Sell Offer -->
                <div class="ge-details-content" id="createSellOffer">
                    <div class="details-title">üîº Sell offer <span class="ge-upload-icon">‚¨ÜÔ∏è</span></div>
                    
                    <!-- Item Display -->
                    <div class="ge-selected-item" id="sellSelectedItem" style="display: none;">
                        <div class="ge-item-display">
                            <div class="ge-item-icon-large" id="sellItemIcon">ü™µ</div>
                            <div class="ge-item-info">
                                <div class="ge-item-name-large" id="sellItemName">Select an item</div>
                                <div class="ge-item-available" id="sellItemAvailable">Available: 0</div>
                                <div class="ge-item-price-info" id="sellItemPriceInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="ge-form-group" id="sellSearchGroup">
                        <label class="ge-form-label">Choose item from inventory:</label>
                        <input type="text" class="ge-item-search" id="sellItemSearch" placeholder="Search your items...">
                        <div class="ge-item-results" id="sellItemResults"></div>
                    </div>

                    <!-- Quantity Controls (OSRS Style) -->
                    <div class="ge-form-group" id="sellQuantityGroup" style="display: none;">
                        <label class="ge-form-label">Quantity:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="sellQtyMinus">‚àí</button>
                            <input type="number" class="ge-form-input-center" id="sellQuantity" min="1" value="1">
                            <button class="ge-plus-btn" id="sellQtyPlus">+</button>
                        </div>
                        <div class="ge-quantity-controls">
                            <button class="ge-qty-btn" data-qty="1">+1</button>
                            <button class="ge-qty-btn" data-qty="10">+10</button>
                            <button class="ge-qty-btn" data-qty="100">+100</button>
                            <button class="ge-qty-btn" data-qty="max">All</button>
                        </div>
                    </div>

                    <!-- Price Controls (OSRS Style) -->
                    <div class="ge-form-group" id="sellPriceGroup" style="display: none;">
                        <label class="ge-form-label">Price per item:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="sellPriceMinus">‚ñº</button>
                            <input type="number" class="ge-form-input-center" id="sellPrice" min="1" value="1">
                            <button class="ge-plus-btn" id="sellPricePlus">‚ñ≤</button>
                            <button class="ge-price-btn-side" id="sellPriceGuide">üí∞</button>
                            <button class="ge-price-btn-side" id="sellPriceLess">‚ñº‚ñº</button>
                        </div>
                        <div class="ge-guide-price" id="sellGuidePrice"></div>
                        <div class="ge-tax-notice">‚ö†Ô∏è 1% tax will be deducted</div>
                    </div>

                    <!-- Total Display -->
                    <div class="ge-total-display-osrs" id="sellTotal" style="display: none;">
                        <div class="ge-total-label">You'll receive:</div>
                        <div class="ge-total-amount-large"><span id="sellTotalAmount">0</span> coins</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="ge-action-buttons-osrs" id="sellActions" style="display: none;">
                        <button class="ge-back-btn" id="sellBackBtn">‚Üê Back</button>
                        <button class="ge-confirm-btn-osrs" id="confirmSell">Confirm</button>
                    </div>
                </div>

                <!-- View Offer Status -->
                <div class="ge-details-content" id="viewOffer">
                    <div class="details-title" id="offerTitle">Offer Status</div>
                    <div class="ge-offer-status-display" id="offerStatus">
                        <!-- Status will be dynamically populated -->
                    </div>
                    <div class="ge-action-buttons">
                        <button class="ge-cancel-btn" id="cancelOffer">Cancel Offer</button>
                    </div>
                    <button class="ge-collect-btn" id="collectOffer" style="display: none;">Collect Items</button>
                </div>
            </div>
        </div>
    </div>

                <div class="slots-section">
                    <div class="slots-section-title">üîº Sell Offers</div>
                    <div class="offer-slots" id="sellSlots">
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="3"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Offer Details -->
            <div class="ge-details-container">
                <!-- Empty State -->
                <div class="ge-details-content active" id="emptyState">
                    <div class="ge-empty-state">
                        <div class="ge-empty-state-icon">üì¶</div>
                        <div class="ge-empty-state-text">Select an offer slot to buy or sell items</div>
                    </div>
                </div>

                <!-- Create Buy Offer -->
                <div class="ge-details-content" id="createBuyOffer">
                    <div class="details-title">üîΩ Create Buy Offer</div>
                    <div class="offer-form">
                        <div class="ge-form-group">
                            <label class="ge-form-label">Search for item:</label>
                            <input type="text" class="ge-item-search" id="buyItemSearch" placeholder="Type item name...">
                            <div class="ge-item-results" id="buyItemResults"></div>
                        </div>

                        <div class="ge-form-group" id="buyPriceGroup" style="display: none;">
                            <label class="ge-form-label">Price per item:</label>
                            <input type="number" class="ge-form-input" id="buyPrice" min="1" value="1">
                            <div class="ge-guide-price" id="buyGuidePrice"></div>
                            <div class="ge-price-controls">
                                <button class="ge-price-btn" data-action="guide">Guide Price</button>
                                <button class="ge-price-btn" data-action="5%">+5%</button>
                                <button class="ge-price-btn" data-action="10%">+10%</button>
                            </div>
                        </div>

                        <div class="ge-form-group" id="buyQuantityGroup" style="display: none;">
                            <label class="ge-form-label">Quantity:</label>
                            <input type="number" class="ge-form-input" id="buyQuantity" min="1" value="1">
                            <div class="ge-quantity-controls">
                                <button class="ge-qty-btn" data-qty="1">+1</button>
                                <button class="ge-qty-btn" data-qty="10">+10</button>
                                <button class="ge-qty-btn" data-qty="100">+100</button>
                                <button class="ge-qty-btn" data-qty="1000">+1k</button>
                            </div>
                        </div>

                        <div class="ge-total-display" id="buyTotal" style="display: none;">
                            <div class="ge-total-label">Total Cost:</div>
                            <div class="ge-total-amount"><span id="buyTotalAmount">0</span> <span class="gp">gp</span></div>
                        </div>

                        <div class="ge-action-buttons" id="buyActions" style="display: none;">
                            <button class="ge-confirm-btn" id="confirmBuy">Confirm Offer</button>
                        </div>
                    </div>
                </div>

                <!-- Create Sell Offer -->
                <div class="ge-details-content" id="createSellOffer">
                    <div class="details-title">üîº Create Sell Offer</div>
                    <div class="offer-form">
                        <div class="ge-form-group">
                            <label class="ge-form-label">Select item from inventory:</label>
                            <input type="text" class="ge-item-search" id="sellItemSearch" placeholder="Search your items...">
                            <div class="ge-item-results" id="sellItemResults"></div>
                        </div>

                        <div class="ge-form-group" id="sellPriceGroup" style="display: none;">
                            <label class="ge-form-label">Price per item:</label>
                            <input type="number" class="ge-form-input" id="sellPrice" min="1" value="1">
                            <div class="ge-guide-price" id="sellGuidePrice"></div>
                            <div class="ge-price-controls">
                                <button class="ge-price-btn" data-action="guide">Guide Price</button>
                                <button class="ge-price-btn" data-action="-5%">-5%</button>
                                <button class="ge-price-btn" data-action="-10%">-10%</button>
                            </div>
                        </div>

                        <div class="ge-form-group" id="sellQuantityGroup" style="display: none;">
                            <label class="ge-form-label">Quantity (Available: <span id="sellAvailable">0</span>):</label>
                            <input type="number" class="ge-form-input" id="sellQuantity" min="1" value="1">
                            <div class="ge-quantity-controls">
                                <button class="ge-qty-btn" data-qty="1">+1</button>
                                <button class="ge-qty-btn" data-qty="10">+10</button>
                                <button class="ge-qty-btn" data-qty="100">+100</button>
                                <button class="ge-qty-btn" data-qty="max">All</button>
                            </div>
                        </div>

                        <div class="ge-total-display" id="sellTotal" style="display: none;">
                            <div class="ge-total-label">You'll Receive (after 1% tax):</div>
                            <div class="ge-total-amount"><span id="sellTotalAmount">0</span> <span class="gp">gp</span></div>
                            <div class="ge-tax-notice">‚ö†Ô∏è 1% tax will be deducted from sale</div>
                        </div>

                        <div class="ge-action-buttons" id="sellActions" style="display: none;">
                            <button class="ge-confirm-btn" id="confirmSell">Confirm Offer</button>
                        </div>
                    </div>
                </div>

                <!-- View Offer Status -->
                <div class="ge-details-content" id="viewOffer">
                    <div class="details-title" id="offerTitle">Offer Status</div>
                    <div class="ge-offer-status-display" id="offerStatus">
                        <!-- Status will be dynamically populated -->
                    </div>
                    <div class="ge-action-buttons">
                        <button class="ge-cancel-btn" id="cancelOffer">Cancel Offer</button>
                    </div>
                    <button class="ge-collect-btn" id="collectOffer" style="display: none;">Collect Items</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Wiki Modal -->
    <div id="marketWikiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.9); z-index: 1001; padding: 20px; box-sizing: border-box;">
        <div style="max-width: 1400px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; background: linear-gradient(135deg, #2a1a0a 0%, #1a0f05 100%); border: 3px solid #6a4a2a; border-radius: 10px; overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #6a4a2a 0%, #5a3a1a 100%); padding: 20px; border-bottom: 2px solid #8a6a4a; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: #d4a76a; font-size: 24px; margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 32px;">üìä</span>
                    Market Price Wiki
                </h2>
                <button onclick="closeMarketWiki()" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">‚úñ Close</button>
            </div>

            <!-- Smart Search Bar -->
            <div style="background: #3a2a1a; padding: 15px; border-bottom: 2px solid #5a4a3a;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input 
                            type="text" 
                            id="wikiSearchInput" 
                            placeholder="üîç Search items by name..." 
                            style="width: 100%; padding: 12px 40px 12px 40px; background: #2a1a0a; border: 2px solid #6a5a4a; border-radius: 5px; color: #d4a76a; font-size: 14px; font-weight: bold; outline: none;"
                            oninput="filterWikiTable()"
                        >
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">üîç</span>
                        <button 
                            id="clearSearchBtn" 
                            onclick="clearWikiSearch()" 
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #6a4a4a; border: none; border-radius: 3px; padding: 4px 8px; color: #fff; cursor: pointer; font-size: 12px; display: none;"
                        >‚úñ</button>
                    </div>
                    <div style="background: #4a3a2a; padding: 10px 20px; border-radius: 5px; border: 2px solid #6a5a4a; white-space: nowrap;">
                        <span style="color: #8a7a6a; font-size: 12px; font-weight: bold;">Results: </span>
                        <span id="wikiResultCount" style="color: #FFD700; font-size: 14px; font-weight: bold;">0</span>
                    </div>
                </div>
                <div id="searchSuggestions" style="margin-top: 8px; display: none;">
                    <div style="color: #8a7a6a; font-size: 11px; margin-bottom: 4px;">Quick suggestions:</div>
                    <div id="suggestionTags" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div style="background: #3a2a1a; padding: 15px; border-bottom: 2px solid #5a4a3a;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="wiki-filter-btn active" data-filter="rises" style="flex: 1; padding: 12px; background: #4a6a4a; border: 2px solid #6a8a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Price Rises üìà</button>
                    <button class="wiki-filter-btn" data-filter="falls" style="flex: 1; padding: 12px; background: #6a4a4a; border: 2px solid #8a6a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Price Falls üìâ</button>
                    <button class="wiki-filter-btn" data-filter="valuable" style="flex: 1; padding: 12px; background: #6a6a4a; border: 2px solid #8a8a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Valuable Trades üíé</button>
                    <button class="wiki-filter-btn" data-filter="most-traded" style="flex: 1; padding: 12px; background: #d4a76a; border: 2px solid #e4b77a; border-radius: 5px; color: #2a1a0a; cursor: pointer; font-weight: bold; font-size: 14px;">Most Traded üî•</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="wiki-period-btn active" data-period="7" style="flex: 1; padding: 10px; background: #5a4a3a; border: 2px solid #7a6a5a; border-radius: 5px; color: #d4a76a; cursor: pointer; font-weight: bold;">Last 7 Days</button>
                    <button class="wiki-period-btn" data-period="30" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last Month</button>
                    <button class="wiki-period-btn" data-period="90" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last 3 Months</button>
                    <button class="wiki-period-btn" data-period="180" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last 6 Months</button>
                </div>
            </div>

            <!-- Table Container -->
            <div style="flex: 1; overflow-y: auto; background: #2a1a0a; padding: 20px;">
                <table style="width: 100%; border-collapse: collapse; background: #1a0f05;">
                    <thead style="position: sticky; top: 0; background: #4a3a2a; z-index: 10;">
                        <tr>
                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Item</th>
                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">üíé</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Start Price</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">End Price</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Total Rise</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Change %</th>
                        </tr>
                    </thead>
                    <tbody id="wikiTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Username Selection Modal (Shows on first login) -->
    <div id="usernameSelectionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; border-radius: 15px; padding: 40px; max-width: 500px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; margin-bottom: 15px;">üéÆ</div>
                <div style="color: #5abaaa; font-size: 28px; font-weight: bold; margin-bottom: 10px;">Choose Your Username</div>
                <div style="color: #8a9aaa; font-size: 14px;">This will be your permanent display name</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <input type="text" id="firstTimeUsernameInput" placeholder="Enter username (3-16 characters)" maxlength="16" style="width: 100%; padding: 15px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 8px; color: #fff; font-size: 16px; text-align: center; box-sizing: border-box;">
                <div id="usernameError" style="color: #ff4444; font-size: 12px; margin-top: 8px; text-align: center; min-height: 18px;"></div>
            </div>
            
            <button id="confirmUsername" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #2a5a4a, #1a4a3a); color: #5abaaa; border: 2px solid #3a6a5a; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">
                Confirm Username
            </button>
            
            <div style="color: #6a7a8a; font-size: 12px; text-align: center; margin-top: 20px;">
                ‚ö†Ô∏è Username cannot be changed once set!
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1200px; height: 85vh; background: linear-gradient(135deg, #1a2845 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1000; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 22px; font-weight: bold;">üë§ Player Profile</div>
            <button id="closeProfile" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">‚úñ</button>
        </div>

        <!-- Guest Mode Warning Banner -->
        <div id="guestModeBanner" style="display: none; background: linear-gradient(135deg, rgba(255, 170, 102, 0.2) 0%, rgba(255, 138, 51, 0.1) 100%); border-bottom: 2px solid rgba(255, 170, 102, 0.3); padding: 12px 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 24px;">‚ö†Ô∏è</div>
                <div>
                    <div style="color: #ffaa66; font-weight: bold; font-size: 14px;">Guest Mode - View Only</div>
                    <div style="color: #cc8844; font-size: 12px;">Sign in with Google to save your profile and join clans</div>
                </div>
            </div>
        </div>

        <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 70px); display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            
            <!-- Left Column: User Info + Buttons -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- User Info -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 15px;">User info</div>
                    <div style="color: #8a9aaa; font-size: 13px; line-height: 1.8;">
                        <div style="margin-bottom: 8px;">Username: <span id="profileUsername" style="color: #5abaaa; font-weight: bold;">Loading...</span></div>
                        <div style="margin-bottom: 8px;">Game mode: <span style="color: #fff;">Ironman</span></div>
                        <div style="margin-bottom: 8px;">Current activity: <span id="profileActivity" style="color: #fff;">Idle</span></div>
                        <div style="margin-bottom: 8px;">Total level: <span id="profileTotalLevelMain" style="color: #5abaaa; font-weight: bold;">0</span><span style="color: #6a7a8a;">/2400</span></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <button onclick="alert('PvM Stats coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">PvM stats</button>
                <button onclick="alert('Collection Log coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">Collection log</button>
                <button onclick="alert('Item Withdrawal coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">Item withdrawal box</button>
                
                <!-- Housing/Active Boosts -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="color: #fff; font-size: 16px; font-weight: bold;">Active boosts</div>
                        <button style="background: #2a5a5a; color: #5abaaa; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View breakdown</button>
                    </div>
                    <div style="color: #8a9aaa; font-size: 13px; line-height: 1.8;">
                        <div>Housing upgrade: <span style="color: #fff;">0%</span></div>
                        <div>Clan housing & upgrades: <span style="color: #fff;">0%</span></div>
                        <div>Equipment: <span style="color: #fff;">0%</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Skills + Pets/Shop -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Skills Grid -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 20px;">Skills</div>
                    <div id="profileSkillsGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px;">
                        <!-- Skills will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Pets and Shop Unlocks -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="color: #fff; font-size: 16px; font-weight: bold;">Pets (0)</div>
                            <button style="background: #2a5a5a; color: #5abaaa; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View</button>
                        </div>
                        <div style="color: #8a9aaa; font-size: 13px;">
                            <div>Activity: <span style="color: #fff;">None</span></div>
                            <div>Pet: <span style="color: #fff;">None</span></div>
                            <div>Task: <span style="color: #fff;">None</span></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                        <div style="color: #fff; font-size: 16px; font-weight: bold; margin-bottom: 15px;">Shop unlocks</div>
                        <div style="color: #8a9aaa; font-size: 13px;">Nothing yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clan Page Modal -->
    <div id="clanPageModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1200px; height: 85vh; background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%); border: 3px solid #2a4a5a; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); z-index: 1000; border-radius: 15px; overflow: hidden;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.95), rgba(15, 22, 32, 0.95)); border-bottom: 3px solid #2a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div id="clanPageTitle" style="color: #5abaaa; font-size: 24px; font-weight: bold; text-shadow: 0 0 10px rgba(90, 186, 170, 0.5);">üõ°Ô∏è <span id="clanDisplayName">Clan Name</span></div>
                <div id="clanMemberInfo" style="color: #8a9aaa; font-size: 14px; margin-top: 5px;">Members: <span id="clanMemberCount">0</span>/5</div>
            </div>
            <button id="closeClanPage" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px; font-weight: bold; transition: all 0.3s;">‚úñ</button>
        </div>

        <!-- Navigation Tabs -->
        <div style="background: rgba(0,0,0,0.3); border-bottom: 2px solid #2a4a5a; display: flex; gap: 5px; padding: 10px 20px; overflow-x: auto;">
            <button class="clan-tab active" data-tab="overview" style="padding: 10px 20px; background: rgba(74, 154, 138, 0.3); border: 2px solid #4a9a8a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s;">üè† Clan</button>
            <button class="clan-tab" data-tab="quests" style="padding: 10px 20px; background: rgba(20, 30, 40, 0.5); border: 2px solid #2a3a4a; border-radius: 8px; color: #8a9aaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s;">üìã Quests</button>
            <button class="clan-tab" data-tab="storage" style="padding: 10px 20px; background: rgba(20, 30, 40, 0.5); border: 2px solid #2a3a4a; border-radius: 8px; color: #8a9aaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s;">üè¶ Storage</button>
            <button class="clan-tab" data-tab="upgrades" style="padding: 10px 20px; background: rgba(20, 30, 40, 0.5); border: 2px solid #2a3a4a; border-radius: 8px; color: #8a9aaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s;">‚¨ÜÔ∏è Upgrades</button>
            <button class="clan-tab" data-tab="management" style="padding: 10px 20px; background: rgba(20, 30, 40, 0.5); border: 2px solid #2a3a4a; border-radius: 8px; color: #8a9aaa; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.3s;">‚öôÔ∏è Management</button>
        </div>

        <!-- Tab Content -->
        <div style="padding: 20px; height: calc(100% - 140px); overflow-y: auto;">
            <!-- Overview Tab (Clan) -->
            <div id="tab-overview" class="clan-tab-content">
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 100%;">
                    <!-- Left Side - Members and Actions -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Members List -->
                        <div style="background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 10px; padding: 15px; flex: 1; overflow-y: auto;">
                            <div style="color: #5abaaa; font-weight: bold; margin-bottom: 10px; font-size: 14px;">MEMBERS: <span id="memberCountDisplay">1</span>/5</div>
                            <div id="clanMembersList" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- Members will be listed here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button id="recruitmentCenterBtn" style="padding: 12px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold; transition: all 0.3s;">üë• Recruitment center</button>
                            <button id="bulletinBoardBtn" style="padding: 12px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold; transition: all 0.3s;">üìå Bulletin board</button>
                            <button id="leaveClanPageBtn" style="padding: 12px; background: linear-gradient(135deg, #8a2a2a, #7a1a1a); border: 2px solid #9a3a3a; border-radius: 8px; color: #ff6666; cursor: pointer; font-weight: bold; transition: all 0.3s;">üö™ Leave clan</button>
                        </div>
                    </div>

                    <!-- Right Side - Skills with Progress Bars -->
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 10px; padding: 20px; overflow-y: auto;">
                        <div style="color: #5abaaa; font-size: 18px; font-weight: bold; margin-bottom: 20px;">Clan Skills</div>
                        <div id="clanSkillsList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <!-- Skills will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other tabs (placeholders) -->
            <div id="tab-quests" class="clan-tab-content" style="display: none;">
                <div style="color: #8a9aaa; text-align: center; padding: 40px;">Clan Quests - Coming Soon</div>
            </div>
            <div id="tab-storage" class="clan-tab-content" style="display: none;">
                <!-- Storage/Vault Interface -->
                <div style="max-width: 900px; margin: 0 auto;">
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="color: #5abaaa; font-size: 20px; font-weight: bold; margin-bottom: 10px;">üè¶ Clan Vault</div>
                        <div style="color: #8a9aaa; font-size: 12px;">Total space: <span id="totalSpaceTab">0</span>/16</div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 10px; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="coin-icon" style="width: 24px; height: 24px;"></div>
                                    <span id="clanGoldTab" style="color: #FFD700; font-weight: bold; font-size: 18px;">0</span>
                                </div>
                                <button id="addMoneyBtn" style="padding: 8px 16px; background: linear-gradient(135deg, #5a8a2a, #4a7a1a); border: 2px solid #6a9a3a; border-radius: 8px; color: #aafa5a; cursor: pointer; font-weight: bold;">üí∞ Add Money</button>
                            </div>
                        </div>
                        <div id="clanStorageGridTab" style="display: grid; grid-template-columns: repeat(8, 60px); gap: 5px; padding: 10px; background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 8px; min-height: 400px;">
                            <!-- Storage slots will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-upgrades" class="clan-tab-content" style="display: none;">
                <div style="color: #8a9aaa; text-align: center; padding: 40px;">Clan Upgrades - Coming Soon</div>
            </div>
            <div id="tab-management" class="clan-tab-content" style="display: none;">
                <div style="color: #8a9aaa; text-align: center; padding: 40px;">Clan Management - Coming Soon</div>
            </div>
        </div>
    </div>

    <!-- Clan Storage Modal -->
    <div id="clanStorageModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; max-height: 80vh; background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%); border: 3px solid #2a4a5a; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); z-index: 1001; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.95), rgba(15, 22, 32, 0.95)); border-bottom: 3px solid #2a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="color: #5abaaa; font-size: 20px; font-weight: bold;">üè¶ Vault</div>
                <div style="color: #8a9aaa; font-size: 12px; margin-top: 5px;">Total space: <span id="totalSpace">0</span>/16</div>
            </div>
            <button id="closeClanStorage" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="coin-icon" style="width: 24px; height: 24px;"></div>
                    <span id="clanGold" style="color: #FFD700; font-weight: bold; font-size: 18px;">0</span>
                </div>
                <button id="manageStorageBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold;">‚öôÔ∏è Manage</button>
            </div>
            <div id="clanStorageGrid" style="display: grid; grid-template-columns: repeat(8, 60px); gap: 5px; padding: 10px; background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 8px; min-height: 400px;">
                <!-- Storage slots will be generated here -->
            </div>
        </div>
    </div>

    <!-- Recruitment Center Modal -->
    <div id="recruitmentCenterModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 700px; max-height: 80vh; background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%); border: 3px solid #2a4a5a; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); z-index: 1001; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.95), rgba(15, 22, 32, 0.95)); border-bottom: 3px solid #2a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 20px; font-weight: bold;">üë• Recruitment Center</div>
            <button id="closeRecruitment" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <!-- Recruitment Settings -->
            <div id="leaderRecruitmentSettings" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 8px;">
                <div style="color: #8a9aaa; font-size: 14px; margin-bottom: 10px;">Recruitment Status:</div>
                <div style="display: flex; gap: 10px;">
                    <button id="setOpenRecruitment" style="flex: 1; padding: 10px; background: rgba(74, 154, 138, 0.3); border: 2px solid #4a9a8a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold;">üì¢ Open to Applications</button>
                    <button id="setInviteOnly" style="flex: 1; padding: 10px; background: rgba(20, 30, 40, 0.5); border: 2px solid #2a3a4a; border-radius: 8px; color: #8a9aaa; cursor: pointer; font-weight: bold;">üîí Invite Only</button>
                </div>
                <div id="currentRecruitmentStatus" style="color: #5abaaa; font-size: 12px; margin-top: 10px; text-align: center;">Status: Open to Applications</div>
            </div>

            <!-- Invite Player Section -->
            <div id="invitePlayerSection" style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border: 2px solid #2a4a5a; border-radius: 8px;">
                <div style="color: #8a9aaa; font-size: 14px; margin-bottom: 10px;">Invite Player by Username:</div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="inviteUsernameInput" placeholder="Enter username..." style="flex: 1; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 8px; color: #fff; font-size: 14px;">
                    <button id="sendInviteBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold;">Send Invite</button>
                </div>
                <div style="color: #8a9aaa; font-size: 11px; margin-top: 8px;">üí° Tip: Suggest using Discord to find and coordinate with potential clan members</div>
            </div>

            <!-- Applications List -->
            <div style="color: #8a9aaa; font-size: 14px; margin-bottom: 10px;">Pending Applications:</div>
            <div id="applicationsList" style="max-height: 350px; overflow-y: auto;">
                <!-- Applications will be listed here -->
            </div>
        </div>
    </div>

    <!-- Bulletin Board Modal -->
    <div id="bulletinBoardModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 700px; max-height: 80vh; background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%); border: 3px solid #2a4a5a; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); z-index: 1001; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.95), rgba(15, 22, 32, 0.95)); border-bottom: 3px solid #2a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 20px; font-weight: bold;">üìå Bulletin Board</div>
            <button id="closeBulletinBoard" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <!-- Post Message -->
            <div style="margin-bottom: 20px;">
                <textarea id="bulletinMessageInput" placeholder="Post a message to the clan..." style="width: 100%; height: 80px; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 8px; color: #fff; font-size: 14px; resize: none; box-sizing: border-box;"></textarea>
                <button id="postBulletinBtn" style="width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 8px; color: #5abaaa; cursor: pointer; font-weight: bold;">Post Message</button>
            </div>
            
            <!-- Messages List -->
            <div id="bulletinMessagesList" style="max-height: 400px; overflow-y: auto;">
                <!-- Messages will be listed here -->
            </div>
        </div>
    </div>

    <!-- PvM Stats Modal -->
    <div id="pvmStatsModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-height: 80vh; background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%); border: 3px solid #2a4a5a; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); z-index: 1001; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.95), rgba(15, 22, 32, 0.95)); border-bottom: 3px solid #2a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 20px; font-weight: bold;">üìä PvM Statistics</div>
            <button id="closePvmStats" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <div style="color: #8a9aaa; text-align: center; padding: 40px;">Coming Soon - Track your clan's boss kills and achievements</div>
        </div>
    </div>

    <!-- Apply to Clan Modal -->
    <div id="applyClanModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1002; border-radius: 10px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5a8afa; font-size: 18px; font-weight: bold;">‚úâÔ∏è Apply to Clan</div>
            <button id="closeApplyClan" style="background: #3a2a2a; color: #fff; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; font-size: 16px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <div id="applyClanName" style="color: #5abaaa; font-size: 16px; font-weight: bold; margin-bottom: 15px;"></div>
            <div style="margin-bottom: 15px;">
                <label style="color: #8a9aaa; font-size: 12px; display: block; margin-bottom: 5px;">Application Message:</label>
                <textarea id="applicationMessage" placeholder="Tell them why you want to join..." maxlength="200" style="width: 100%; height: 100px; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 5px; color: #fff; font-size: 14px; resize: none; box-sizing: border-box;"></textarea>
                <div style="color: #8a9aaa; font-size: 11px; margin-top: 5px; text-align: right;"><span id="messageCharCount">0</span>/200</div>
            </div>
            <button id="confirmApplyClan" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 12px; cursor: pointer; border-radius: 5px; font-weight: bold; width: 100%;">Send Application</button>
        </div>
    </div>

    <!-- Profile Modal (Old - keeping clan modals) -->
    <div id="createClanModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1001; border-radius: 10px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5a8afa; font-size: 18px; font-weight: bold;">üõ°Ô∏è Create Clan</div>
            <button id="closeCreateClan" style="background: #3a2a2a; color: #fff; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; font-size: 16px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="color: #8a9aaa; font-size: 12px; display: block; margin-bottom: 5px;">Clan Name:</label>
                <input type="text" id="createClanName" placeholder="Enter clan name..." maxlength="20" style="width: 100%; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 5px; color: #fff; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="color: #8a9aaa; font-size: 12px; display: block; margin-bottom: 5px;">Clan Tag (3-4 letters):</label>
                <input type="text" id="createClanTag" placeholder="e.g., ABC" maxlength="4" style="width: 100%; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 5px; color: #fff; font-size: 14px; box-sizing: border-box; text-transform: uppercase;">
            </div>
            <button id="confirmCreateClan" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 12px; cursor: pointer; border-radius: 5px; font-weight: bold; width: 100%;">Create Clan</button>
        </div>
    </div>

    <!-- Join Clan Modal -->
    <div id="joinClanModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; max-height: 600px; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1001; border-radius: 10px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5a8afa; font-size: 18px; font-weight: bold;">üõ°Ô∏è Join Clan</div>
            <button id="closeJoinClan" style="background: #3a2a2a; color: #fff; border: none; padding: 8px 12px; cursor: pointer; border-radius: 5px; font-size: 16px;">‚úñ</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <input type="text" id="searchClanInput" placeholder="Search clans..." style="flex: 1; padding: 10px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 5px; color: #fff; font-size: 14px; box-sizing: border-box;">
                <button id="openCreateClanBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #2a5a8a, #1a4a7a); border: 2px solid #3a6a9a; border-radius: 5px; color: #5abaaa; cursor: pointer; font-weight: bold; white-space: nowrap;">+ Create Clan</button>
            </div>
            <div id="clanList" style="max-height: 400px; overflow-y: auto;">
                <!-- Clan list will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        function resizeCanvas() {
            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // If size changed, regenerate tiles and force redraw (only if game is initialized)
            if (oldWidth !== canvas.width || oldHeight !== canvas.height) {
                try {
                    // Regenerate room objects based on new canvas size
                    if (typeof initializeRoomObjects === 'function') {
                        initializeRoomObjects();
                    }
                    
                    // Only regenerate if game objects are initialized
                    if (typeof generateTiles === 'function') {
                        generateTiles();
                    }
                    
                    // Adjust player position if needed to stay in bounds
                    if (gameState && gameState.player) {
                        gameState.player.x = Math.min(gameState.player.x, canvas.width - 50);
                        gameState.player.y = Math.min(gameState.player.y, canvas.height - 50);
                    }
                } catch (e) {
                    // Ignore errors during initialization
                }
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game State
        const gameState = {
            currentRoom: 'woodcutting',
            player: {
                x: 400,
                y: 300,
                targetX: null,
                targetY: null,
                speed: 4,
                size: 20,
                gold: 100965,
                inventory: [],
                inventorySize: 98,
                equipment: {
                    head: null,
                    amulet: null,
                    cape: null,
                    chest: null,
                    legs: null,
                    boots: null,
                    gloves: null,
                    ring: null,
                    weapon: null,
                    'off-hand': null,
                    arrows: null
                },
                isPerformingAction: false,
                actionProgress: 0,
                actionDuration: 3000, // 3 seconds per action
                currentTarget: null,
                lastActionTime: 0,
                skills: {
                    hitpoints: 10,
                    attack: 1,
                    mining: 1,
                    strength: 1,
                    agility: 1,

                    defence: 1,

                    fishing: 1,
                    ranged: 1,

                    cooking: 1,

                    crafting: 1,
                    
                    carpentry: 1,

                    magic: 1,

                    woodcutting: 1,


                    farming: 1,


                    combat: 1
                },
                // XP tracking for each skill
                skillXP: {
                    hitpoints: 0,
                    attack: 0,
                    mining: 0,
                    strength: 0,
                    agility: 0,
                    defence: 0,
                    fishing: 0,
                    ranged: 0,
                    cooking: 0,
                    crafting: 0,
                    carpentry: 0,
                    magic: 0,
                    woodcutting: 0,
                    farming: 0,
                    combat: 0
                }
            },
            camera: {
                x: 0,
                y: 0
            },
            tiles: [],
            objects: [],
            particles: [],
            inventoryOpen: false,
            afkMode: true,
            nextTargetTime: 0,
            sprites: {},
            // Activity Tracker (OSRS-style)
            activityTracker: {
                startTime: Date.now(),
                itemsGained: 0,
                xpGained: 0,
                currentActivity: '',
                lastItem: null
            }
        };

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCsRx39EtpX9wv7sr-xSGG4VErBzehBQek",
  authDomain: "mmorpg-game-7c7c2.firebaseapp.com",
  databaseURL: "https://mmorpg-game-7c7c2-default-rtdb.firebaseio.com",
  projectId: "mmorpg-game-7c7c2",
  storageBucket: "mmorpg-game-7c7c2.firebasestorage.app",
  messagingSenderId: "984103556329",
  appId: "1:984103556329:web:aed09909095ec1eb5f0c78",
  measurementId: "G-B5NVV5PTC9"
};

        // Check if Firebase config is set up (not using placeholder values)
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY" && 
                                      firebaseConfig.projectId !== "YOUR_PROJECT_ID";

        // Initialize Firebase only if configured
        let auth = null;
        let database = null;
        
        if (isFirebaseConfigured) {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.log('Guest mode will work, but sign-in features disabled');
            }
        } else {
            console.log('Firebase not configured - Guest mode available, sign-in disabled');
        }

        // Auth state management
        let currentUser = null;
        let isGuestMode = false;

        // Google Sign In
        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            if (!isFirebaseConfigured || !auth) {
                showFloatingText('Firebase not configured. Please set up Firebase to use sign-in.', canvas.width / 2, 100, '#ff4444');
                showFloatingText('You can still play as guest!', canvas.width / 2, 140, '#ffaa66');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    currentUser = result.user;
                    isGuestMode = false;
                    document.getElementById('loginModal').style.display = 'none';
                    updateUserUI();
                    await loadPlayerProfile();
                    showFloatingText('Welcome ' + (playerProfile.username || currentUser.displayName) + '!', canvas.width / 2, 100, '#FFD700');
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    showFloatingText('Login failed: ' + error.message, canvas.width / 2, 100, '#ff4444');
                });
        });

        // Guest Login
        document.getElementById('guestLoginBtn').addEventListener('click', () => {
            isGuestMode = true;
            currentUser = null;
            document.getElementById('loginModal').style.display = 'none';
            updateUserUI();
            showFloatingText('Playing as Guest - Progress will not be saved', canvas.width / 2, 100, '#ffaa66');
            
            // Show reminder after a few seconds
            setTimeout(() => {
                showFloatingText('Tip: Sign in with Google to save progress and use the market', canvas.width / 2, 150, '#6a8a9a');
            }, 3000);
        });

        // ============================================
        // PROFILE & CLAN SYSTEM
        // ============================================
        
        let playerProfile = {
            username: null,
            clanId: null,
            clanName: null,
            clanRole: null,
            createdAt: Date.now()
        };

        // Load player profile
        async function loadPlayerProfile() {
            if (!currentUser || !database) return;
            
            const profileRef = database.ref(`players/${currentUser.uid}/profile`);
            const snapshot = await profileRef.once('value');
            
            if (snapshot.exists()) {
                playerProfile = snapshot.val();
                
                // Check if username exists, if not show selection modal
                if (!playerProfile.username) {
                    showUsernameSelectionModal();
                }
            } else {
                // New profile - show username selection
                showUsernameSelectionModal();
            }
            
            updateProfileDisplay();
        }
        
        // Show username selection modal
        function showUsernameSelectionModal() {
            const modal = document.getElementById('usernameSelectionModal');
            modal.style.display = 'flex';
            document.getElementById('firstTimeUsernameInput').focus();
        }
        
        // Confirm username selection
        document.getElementById('confirmUsername').addEventListener('click', async () => {
            if (!currentUser || !database) return;
            
            const username = document.getElementById('firstTimeUsernameInput').value.trim();
            const errorDiv = document.getElementById('usernameError');
            
            if (!username || username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters';
                return;
            }
            
            if (username.length > 16) {
                errorDiv.textContent = 'Username must be 16 characters or less';
                return;
            }
            
            // Check if username is taken
            const usernamesRef = database.ref('usernames');
            const snapshot = await usernamesRef.orderByValue().equalTo(username).once('value');
            
            if (snapshot.exists()) {
                errorDiv.textContent = 'Username already taken';
                return;
            }
            
            // Save username (permanent!)
            playerProfile = {
                username: username,
                clanId: null,
                clanName: null,
                clanRole: null,
                createdAt: Date.now()
            };
            
            await database.ref(`players/${currentUser.uid}/profile`).set(playerProfile);
            await database.ref(`usernames/${currentUser.uid}`).set(username);
            
            document.getElementById('usernameSelectionModal').style.display = 'none';
            showFloatingText(`Welcome, ${username}!`, canvas.width / 2, 100, '#5abaaa');
            updateProfileDisplay();
        });

        // Update profile display
        function updateProfileDisplay() {
            // Show/hide guest mode banner
            const guestBanner = document.getElementById('guestModeBanner');
            if (guestBanner) {
                guestBanner.style.display = isGuestMode ? 'block' : 'none';
            }
            
            // Update username
            const usernameEl = document.getElementById('profileUsername');
            if (usernameEl) {
                if (isGuestMode) {
                    usernameEl.textContent = 'Guest (not saved)';
                } else if (playerProfile && playerProfile.username) {
                    usernameEl.textContent = playerProfile.username;
                } else {
                    usernameEl.textContent = 'Not set';
                }
            }
            
            // Update current activity
            const activityEl = document.getElementById('profileActivity');
            if (activityEl) {
                const activityNames = {
                    'woodcutting': 'Woodcutting',
                    'mining': 'Mining',
                    'fishing': 'Fishing',
                    'farming': 'Farming',
                    'agility': 'Agility',
                    'cooking': 'Cooking',
                    'combat': 'Combat',
                    'crafting': 'Crafting',
                    'raids': 'Raiding'
                };
                activityEl.textContent = activityNames[gameState.currentRoom] || 'Idle';
            }
            
            // Update stats
            const totalLevel = Object.values(gameState.player.skills).reduce((a, b) => a + b, 0);
            const totalLevelEl = document.getElementById('profileTotalLevelMain');
            if (totalLevelEl) {
                totalLevelEl.textContent = totalLevel;
            }
            
            // Populate skills grid
            const skillsGrid = document.getElementById('profileSkillsGrid');
            if (skillsGrid) {
                const skillIcons = {
                    hitpoints: '‚ù§Ô∏è',
                    attack: '‚öîÔ∏è',
                    strength: 'üí™',
                    defence: 'üõ°Ô∏è',
                    ranged: 'üèπ',
                    magic: '‚ú®',
                    woodcutting: 'ü™ì',
                    mining: '‚õèÔ∏è',
                    fishing: 'üé£',
                    cooking: 'üçó',
                    crafting: 'üßµ',
                    carpentry: 'üî®',
                    farming: 'üå±',
                    agility: 'üèÉ',
                    combat: '‚öîÔ∏è'
                };
                
                skillsGrid.innerHTML = '';
                for (let [skill, level] of Object.entries(gameState.player.skills)) {
                    const skillDiv = document.createElement('div');
                    skillDiv.style.cssText = 'text-align: center;';
                    skillDiv.innerHTML = `
                        <div style="font-size: 32px; margin-bottom: 5px;">${skillIcons[skill] || 'üìä'}</div>
                        <div style="color: #fff; font-size: 14px; font-weight: bold;">Level: ${level}</div>
                    `;
                    skillsGrid.appendChild(skillDiv);
                }
            }
            
            // Clan display (still available for logged in users)
            if (!isGuestMode && playerProfile && playerProfile.clanId && playerProfile.clanName) {
                // Clan info can be shown elsewhere if needed
            }
        }

        // Load clan member count
        async function loadClanMemberCount() {
            if (!playerProfile.clanId || !database) return;
            
            const membersRef = database.ref(`clans/${playerProfile.clanId}/members`);
            const snapshot = await membersRef.once('value');
            const count = snapshot.numChildren();
            document.getElementById('clanMembersDisplay').textContent = count;
        }


        // Open profile modal
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Profile')) {
                item.addEventListener('click', () => {
                    if (!currentUser && !isGuestMode) {
                        showFloatingText('Sign in to view profile', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    
                    if (isGuestMode) {
                        // Guest mode: Show limited profile view
                        document.getElementById('profileModal').style.display = 'block';
                        updateProfileDisplay();
                        showFloatingText('‚ö†Ô∏è Sign in to save profile data', canvas.width / 2, 150, '#ffaa66');
                    } else {
                        document.getElementById('profileModal').style.display = 'block';
                        updateProfileDisplay();
                    }
                });
            }
        });

        // Close profile modal
        document.getElementById('closeProfile').addEventListener('click', () => {
            document.getElementById('profileModal').style.display = 'none';
        });

        // Open clan menu (shortcut to profile clan section)
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Clan')) {
                item.addEventListener('click', () => {
                    if (!currentUser && !isGuestMode) {
                        showFloatingText('Sign in to join a clan', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    // Open profile modal and scroll to clan section
                    document.getElementById('profileModal').style.display = 'block';
                    updateProfileDisplay();
                    
                    if (isGuestMode) {
                        showFloatingText('‚ö†Ô∏è Sign in to create or join clans', canvas.width / 2, 150, '#ffaa66');
                    }
                });
            }
        });

        // Create clan button (if exists - old profile UI)
        const createClanBtn = document.getElementById('createClanBtn');
        if (createClanBtn) {
            createClanBtn.addEventListener('click', () => {
                document.getElementById('createClanModal').style.display = 'block';
            });
        }

        // Close create clan modal
        const closeCreateClan = document.getElementById('closeCreateClan');
        if (closeCreateClan) {
            closeCreateClan.addEventListener('click', () => {
                document.getElementById('createClanModal').style.display = 'none';
            });
        }

        // Confirm create clan
        const confirmCreateClan = document.getElementById('confirmCreateClan');
        if (confirmCreateClan) {
            confirmCreateClan.addEventListener('click', async () => {
            if (!currentUser || !database) return;
            
            const clanName = document.getElementById('createClanName').value.trim();
            const clanTag = document.getElementById('createClanTag').value.trim().toUpperCase();
            
            if (!clanName || clanName.length < 3) {
                showFloatingText('Clan name must be at least 3 characters', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            if (!clanTag || clanTag.length < 3 || clanTag.length > 4) {
                showFloatingText('Clan tag must be 3-4 letters', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Check if clan name is taken
            const clansRef = database.ref('clans');
            const snapshot = await clansRef.orderByChild('name').equalTo(clanName).once('value');
            
            if (snapshot.exists()) {
                showFloatingText('Clan name already taken', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Create clan
            const newClanRef = clansRef.push();
            const clanId = newClanRef.key;
            
            await newClanRef.set({
                name: clanName,
                tag: clanTag,
                leaderId: currentUser.uid,
                leaderName: playerProfile.username,
                createdAt: Date.now(),
                memberCount: 1
            });
            
            // Add member
            await database.ref(`clans/${clanId}/members/${currentUser.uid}`).set({
                username: playerProfile.username,
                role: 'Leader',
                joinedAt: Date.now()
            });
            
            // Update player profile
            playerProfile.clanId = clanId;
            playerProfile.clanName = clanName;
            playerProfile.clanRole = 'Leader';
            await database.ref(`players/${currentUser.uid}/profile`).update({
                clanId: clanId,
                clanName: clanName,
                clanRole: 'Leader'
            });
            
            document.getElementById('createClanModal').style.display = 'none';
            document.getElementById('joinClanModal').style.display = 'none';
            updateProfileDisplay();
            showFloatingText(`Clan "${clanName}" created!`, canvas.width / 2, 100, '#5abaaa');
            
            // Open the clan page after creation
            setTimeout(async () => {
                await openClanPage();
            }, 500);
            });
        }

        // Join clan button (if exists - old profile UI)
        const joinClanBtn = document.getElementById('joinClanBtn');
        if (joinClanBtn) {
            joinClanBtn.addEventListener('click', async () => {
                document.getElementById('joinClanModal').style.display = 'block';
                await loadClanListWithApplications();
            });
        }

        // Close join clan modal
        const closeJoinClan = document.getElementById('closeJoinClan');
        if (closeJoinClan) {
            closeJoinClan.addEventListener('click', () => {
                document.getElementById('joinClanModal').style.display = 'none';
            });
        }

        // Open create clan modal from join clan modal
        const openCreateClanBtn = document.getElementById('openCreateClanBtn');
        if (openCreateClanBtn) {
            openCreateClanBtn.addEventListener('click', () => {
                document.getElementById('joinClanModal').style.display = 'none';
                document.getElementById('createClanModal').style.display = 'block';
            });
        }

        // Load clan list
        async function loadClanList() {
            if (!database) return;
            
            const clansRef = database.ref('clans');
            const snapshot = await clansRef.limitToFirst(50).once('value');
            
            const clanListDiv = document.getElementById('clanList');
            clanListDiv.innerHTML = '';
            
            if (!snapshot.exists()) {
                clanListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No clans available</div>';
                return;
            }
            
            snapshot.forEach((clanSnap) => {
                const clan = clanSnap.val();
                const clanId = clanSnap.key;
                
                const clanDiv = document.createElement('div');
                clanDiv.style.cssText = 'background: rgba(90, 138, 250, 0.1); border: 2px solid #2a3a4a; border-radius: 5px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;';
                clanDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #5a8afa; font-weight: bold; font-size: 16px;">[${clan.tag}] ${clan.name}</div>
                            <div style="color: #8a9aaa; font-size: 12px; margin-top: 5px;">Leader: ${clan.leaderName} ‚Ä¢ Members: ${clan.memberCount || 0}</div>
                        </div>
                        <button class="joinClanButton" data-clan-id="${clanId}" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;">Join</button>
                    </div>
                `;
                
                clanDiv.addEventListener('mouseenter', () => {
                    clanDiv.style.background = 'rgba(90, 138, 250, 0.2)';
                });
                
                clanDiv.addEventListener('mouseleave', () => {
                    clanDiv.style.background = 'rgba(90, 138, 250, 0.1)';
                });
                
                clanListDiv.appendChild(clanDiv);
            });
            
            // Add join button handlers
            document.querySelectorAll('.joinClanButton').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const clanId = btn.dataset.clanId;
                    await joinClan(clanId);
                });
            });
        }

        // Join clan
        async function joinClan(clanId) {
            if (!currentUser || !database) return;
            
            // Get clan info
            const clanRef = database.ref(`clans/${clanId}`);
            const clanSnapshot = await clanRef.once('value');
            
            if (!clanSnapshot.exists()) {
                showFloatingText('Clan not found', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            const clan = clanSnapshot.val();
            
            // Add member
            await database.ref(`clans/${clanId}/members/${currentUser.uid}`).set({
                username: playerProfile.username,
                role: 'Member',
                joinedAt: Date.now()
            });
            
            // Update member count
            await clanRef.update({
                memberCount: (clan.memberCount || 0) + 1
            });
            
            // Update player profile
            playerProfile.clanId = clanId;
            playerProfile.clanName = clan.name;
            playerProfile.clanRole = 'Member';
            await database.ref(`players/${currentUser.uid}/profile`).update({
                clanId: clanId,
                clanName: clan.name,
                clanRole: 'Member'
            });
            
            document.getElementById('joinClanModal').style.display = 'none';
            updateProfileDisplay();
            showFloatingText(`Joined clan "${clan.name}"!`, canvas.width / 2, 100, '#5abaaa');
        }

        // Leave clan button (if exists - old profile UI)
        const leaveClanBtn = document.getElementById('leaveClanBtn');
        if (leaveClanBtn) {
            leaveClanBtn.addEventListener('click', async () => {
                if (!currentUser || !database || !playerProfile.clanId) return;
                
                if (!confirm('Are you sure you want to leave your clan?')) return;
                
                const clanId = playerProfile.clanId;
                
                // Remove from clan members
                await database.ref(`clans/${clanId}/members/${currentUser.uid}`).remove();
                
                // Update member count
                const clanRef = database.ref(`clans/${clanId}`);
                const clanSnapshot = await clanRef.once('value');
                const clan = clanSnapshot.val();
                
                const newMemberCount = (clan.memberCount || 1) - 1;
                
                if (newMemberCount === 0) {
                    // Delete clan if no members left
                    await clanRef.remove();
                } else {
                    await clanRef.update({ memberCount: newMemberCount });
                }
                
                // Update player profile
                playerProfile.clanId = null;
                playerProfile.clanName = null;
                playerProfile.clanRole = null;
                await database.ref(`players/${currentUser.uid}/profile`).update({
                    clanId: null,
                    clanName: null,
                    clanRole: null
                });
                
                updateProfileDisplay();
                showFloatingText('Left clan', canvas.width / 2, 100, '#8a9aaa');
            });
        }

        // Search clans (if exists - old profile UI)
        const searchClanInput = document.getElementById('searchClanInput');
        if (searchClanInput) {
            searchClanInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    await loadClanListWithApplications();
                    return;
                }
                
                const clansRef = database.ref('clans');
                const snapshot = await clansRef.once('value');
                
                const clanListDiv = document.getElementById('clanList');
                clanListDiv.innerHTML = '';
                
                let foundClans = false;
                
                snapshot.forEach((clanSnap) => {
                    const clan = clanSnap.val();
                    const clanId = clanSnap.key;
                    
                    if (clan.name.toLowerCase().includes(searchTerm) || clan.tag.toLowerCase().includes(searchTerm)) {
                        foundClans = true;
                        
                        const isFull = (clan.memberCount || 0) >= 5;
                        const isInviteOnly = clan.inviteOnly || false;
                        const canApply = !isFull && !isInviteOnly;
                        
                        let statusBadge = '';
                        if (isFull) {
                            statusBadge = '<span style="background: #8a2a2a; color: #ff6666; padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold;">FULL</span>';
                        } else if (isInviteOnly) {
                            statusBadge = '<span style="background: #5a4a2a; color: #ffaa66; padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold;">üîí INVITE ONLY</span>';
                        }
                        
                        const clanDiv = document.createElement('div');
                        clanDiv.style.cssText = 'background: rgba(90, 138, 250, 0.1); border: 2px solid #2a3a4a; border-radius: 5px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;';
                        clanDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                        <div style="color: #5a8afa; font-weight: bold; font-size: 16px;">[${clan.tag}] ${clan.name}</div>
                                        ${statusBadge}
                                    </div>
                                    <div style="color: #8a9aaa; font-size: 12px;">Leader: ${clan.leaderName} ‚Ä¢ Members: ${clan.memberCount || 0}/5</div>
                                </div>
                                ${canApply ? `<button class="applyClanButton" data-clan-id="${clanId}" data-clan-name="[${clan.tag}] ${clan.name}" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;">Apply</button>` : ''}
                            </div>
                        `;
                        
                        clanListDiv.appendChild(clanDiv);
                    }
                });
                
                if (!foundClans) {
                    clanListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No clans found</div>';
                }
                
                // Add apply button handlers
                document.querySelectorAll('.applyClanButton').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentApplyingClanId = btn.dataset.clanId;
                        document.getElementById('applyClanName').textContent = btn.dataset.clanName;
                        document.getElementById('applyClanModal').style.display = 'block';
                        document.getElementById('applicationMessage').value = '';
                        document.getElementById('messageCharCount').textContent = '0';
                    });
                });
            });
        }

        // ============================================
        // ENHANCED CLAN PAGE SYSTEM
        // ============================================

        let currentApplyingClanId = null;

        // Open clan page
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Clan')) {
                item.addEventListener('click', async () => {
                    if (!currentUser && !isGuestMode) {
                        showFloatingText('Sign in to view clans', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    
                    if (isGuestMode) {
                        showFloatingText('‚ö†Ô∏è Sign in to create or join clans', canvas.width / 2, 150, '#ffaa66');
                        return;
                    }

                    // Check if player has a clan
                    if (playerProfile && playerProfile.clanId) {
                        await openClanPage();
                    } else {
                        // Show join/create clan modal
                        document.getElementById('joinClanModal').style.display = 'block';
                        await loadClanListWithApplications();
                    }
                });
            }
        });

        // Open clan page
        async function openClanPage() {
            if (!playerProfile.clanId || !database) return;

            const clanRef = database.ref(`clans/${playerProfile.clanId}`);
            const snapshot = await clanRef.once('value');
            
            if (!snapshot.exists()) {
                showFloatingText('Clan not found', canvas.width / 2, 100, '#ff4444');
                return;
            }

            const clanData = snapshot.val();
            
            // Update clan page display
            document.getElementById('clanDisplayName').textContent = `[${clanData.tag}] ${clanData.name}`;
            document.getElementById('clanMemberCount').textContent = clanData.memberCount || 0;
            document.getElementById('memberCountDisplay').textContent = clanData.memberCount || 0;
            
            // Calculate and display clan skills
            await updateClanSkillsDisplay();

            // Load clan members
            await loadClanMembers();
            
            // Show/hide leader controls
            const isLeader = playerProfile.clanRole === 'Leader';
            document.getElementById('leaderRecruitmentSettings').style.display = isLeader ? 'block' : 'none';
            document.getElementById('invitePlayerSection').style.display = isLeader ? 'block' : 'none';

            // Initialize clan storage
            initializeClanStorage();

            document.getElementById('clanPageModal').style.display = 'block';
        }

        // Update clan skills display with progress bars
        async function updateClanSkillsDisplay() {
            if (!playerProfile.clanId || !database) return;

            const membersRef = database.ref(`clans/${playerProfile.clanId}/members`);
            const membersSnapshot = await membersRef.once('value');
            
            const skillTotals = {};
            const maxPerSkill = 495; // 99 * 5 members
            
            if (membersSnapshot.exists()) {
                const memberPromises = [];
                
                membersSnapshot.forEach((memberSnap) => {
                    const memberId = memberSnap.key;
                    const playerSkillsPromise = database.ref(`players/${memberId}/skills`).once('value');
                    memberPromises.push(playerSkillsPromise);
                });
                
                const skillSnapshots = await Promise.all(memberPromises);
                
                skillSnapshots.forEach((skillSnapshot) => {
                    if (skillSnapshot.exists()) {
                        const skills = skillSnapshot.val();
                        for (const [skillName, level] of Object.entries(skills)) {
                            skillTotals[skillName] = (skillTotals[skillName] || 0) + (level || 0);
                        }
                    }
                });
            }
            
            // Filter out PVM stats (combat skills)
            const pvmSkills = ['hitpoints', 'attack', 'strength', 'defence', 'ranged', 'magic', 'combat'];
            for (const pvmSkill of pvmSkills) {
                delete skillTotals[pvmSkill];
            }
            
            // Skill icons mapping
            const skillIcons = {
                woodcutting: 'ü™ì',
                mining: '‚õèÔ∏è',
                fishing: 'üé£',
                cooking: 'üçó',
                crafting: 'üßµ',
                carpentry: 'üî®',
                farming: 'üå±',
                agility: 'üèÉ'
            };
            
            const skillsList = document.getElementById('clanSkillsList');
            skillsList.innerHTML = '';
            
            // Create skill display for each skill
            for (const [skillName, level] of Object.entries(skillTotals)) {
                const icon = skillIcons[skillName] || 'üìä';
                const percentage = (level / maxPerSkill) * 100;
                
                const skillDiv = document.createElement('div');
                skillDiv.style.cssText = 'background: rgba(0,0,0,0.3); border: 2px solid #2a3a4a; border-radius: 8px; padding: 10px;';
                
                skillDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                        <div style="font-size: 20px;">${icon}</div>
                        <div style="color: #fff; font-size: 13px; font-weight: bold;">${level}/${maxPerSkill}</div>
                    </div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #4a9a8a, #5abaaa); transition: width 0.3s;"></div>
                    </div>
                `;
                
                skillsList.appendChild(skillDiv);
            }
            
            // If no skills, show message
            if (Object.keys(skillTotals).length === 0) {
                skillsList.innerHTML = '<div style="grid-column: 1 / -1; color: #8a9aaa; text-align: center; padding: 20px;">No skills data available</div>';
            }
        }

        // Load clan members
        async function loadClanMembers() {
            if (!playerProfile.clanId || !database) return;

            const membersRef = database.ref(`clans/${playerProfile.clanId}/members`);
            const snapshot = await membersRef.once('value');
            
            const membersList = document.getElementById('clanMembersList');
            membersList.innerHTML = '';

            if (!snapshot.exists()) {
                membersList.innerHTML = '<div style="color: #8a9aaa; text-align: center; padding: 10px;">No members</div>';
                return;
            }

            const maxPerSkill = 495; // 99 * 5 members max

            for (const memberSnap of snapshot.val() ? Object.entries(snapshot.val()) : []) {
                const [memberId, member] = memberSnap;
                const isCurrentUser = memberId === currentUser.uid;
                const isLeader = member.role === 'Leader';
                const canKick = playerProfile.clanRole === 'Leader' && !isLeader && !isCurrentUser;

                // Fetch member's skills
                const skillsSnapshot = await database.ref(`players/${memberId}/skills`).once('value');
                const skills = skillsSnapshot.val() || {};

                const memberDiv = document.createElement('div');
                memberDiv.style.cssText = 'padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid #2a3a4a; border-radius: 8px; margin-bottom: 8px;';
                
                let roleIcon = '';
                if (isLeader) roleIcon = 'üëë';
                
                // Build stats display with progress bars
                const statsToShow = [
                    { name: 'HP', skill: 'hitpoints', icon: '‚ù§Ô∏è' },
                    { name: 'Attack', skill: 'attack', icon: '‚öîÔ∏è' },
                    { name: 'Strength', skill: 'strength', icon: 'üí™' },
                    { name: 'Defence', skill: 'defence', icon: 'üõ°Ô∏è' },
                    { name: 'Ranged', skill: 'ranged', icon: 'üèπ' },
                    { name: 'Magic', skill: 'magic', icon: '‚ú®' }
                ];

                let statsHTML = '';
                for (const stat of statsToShow) {
                    const level = skills[stat.skill] || 1;
                    const percentage = (level / maxPerSkill) * 100;
                    statsHTML += `
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                                <span style="color: #8a9aaa; font-size: 11px;">${stat.icon} ${stat.name}</span>
                                <span style="color: #fff; font-size: 11px; font-weight: bold;">${level}/${maxPerSkill}</span>
                            </div>
                            <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #4a9a8a, #5abaaa); transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }
                
                memberDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="color: ${isLeader ? '#FFD700' : '#5abaaa'}; font-weight: bold; font-size: 13px;">${roleIcon} ${member.username}</div>
                            <div style="color: #8a9aaa; font-size: 11px;">${member.role}</div>
                        </div>
                        ${canKick ? `<button class="kick-member-btn" data-member-id="${memberId}" style="padding: 4px 8px; background: #8a2a2a; border: 1px solid #9a3a3a; border-radius: 5px; color: #ff6666; cursor: pointer; font-size: 11px; font-weight: bold;">Kick</button>` : ''}
                    </div>
                    ${statsHTML}
                `;
                
                membersList.appendChild(memberDiv);
            }

            // Add kick handlers
            document.querySelectorAll('.kick-member-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const memberId = btn.dataset.memberId;
                    if (confirm('Are you sure you want to kick this member?')) {
                        await kickMember(memberId);
                    }
                });
            });
        }

        // Kick member
        async function kickMember(memberId) {
            if (!playerProfile.clanId || !database) return;

            const clanId = playerProfile.clanId;
            
            // Remove from clan members
            await database.ref(`clans/${clanId}/members/${memberId}`).remove();
            
            // Update member count
            const clanRef = database.ref(`clans/${clanId}`);
            const clanSnapshot = await clanRef.once('value');
            const clan = clanSnapshot.val();
            await clanRef.update({ memberCount: (clan.memberCount || 1) - 1 });
            
            // Update kicked player's profile
            await database.ref(`players/${memberId}/profile`).update({
                clanId: null,
                clanName: null,
                clanRole: null
            });
            
            showFloatingText('Member kicked', canvas.width / 2, 100, '#ff6666');
            await loadClanMembers();
        }

        // Initialize clan storage
        function initializeClanStorage() {
            const storageGrid = document.getElementById('clanStorageGrid');
            storageGrid.innerHTML = '';
            
            // Create 16 storage slots (free)
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.style.cssText = 'width: 60px; height: 60px; background: rgba(0,0,0,0.5); border: 2px solid #2a3a4a; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;';
                slot.innerHTML = '<div style="color: #4a5a6a; font-size: 24px;">üîí</div>';
                slot.addEventListener('mouseenter', () => {
                    slot.style.borderColor = '#4a6a8a';
                });
                slot.addEventListener('mouseleave', () => {
                    slot.style.borderColor = '#2a3a4a';
                });
                storageGrid.appendChild(slot);
            }
            
            document.getElementById('clanGold').textContent = '0';
            document.getElementById('totalSpace').textContent = '0';
        }

        // Initialize clan storage in the Storage tab
        async function initializeClanStorageTab() {
            const storageGrid = document.getElementById('clanStorageGridTab');
            storageGrid.innerHTML = '';
            
            // Create 16 storage slots (free)
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.style.cssText = 'width: 60px; height: 60px; background: rgba(0,0,0,0.5); border: 2px solid #2a3a4a; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s;';
                slot.innerHTML = '<div style="color: #4a5a6a; font-size: 24px;">üîí</div>';
                slot.addEventListener('mouseenter', () => {
                    slot.style.borderColor = '#4a6a8a';
                });
                slot.addEventListener('mouseleave', () => {
                    slot.style.borderColor = '#2a3a4a';
                });
                storageGrid.appendChild(slot);
            }
            
            // Load clan gold from Firebase
            if (playerProfile.clanId && database) {
                const clanGoldRef = database.ref(`clans/${playerProfile.clanId}/gold`);
                const snapshot = await clanGoldRef.once('value');
                const clanGold = snapshot.val() || 0;
                document.getElementById('clanGoldTab').textContent = clanGold;
            } else {
                document.getElementById('clanGoldTab').textContent = '0';
            }
            
            document.getElementById('totalSpaceTab').textContent = '0';
        }

        // Close clan page
        document.getElementById('closeClanPage').addEventListener('click', () => {
            document.getElementById('clanPageModal').style.display = 'none';
        });

        // Clan tab switching
        document.querySelectorAll('.clan-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.clan-tab').forEach(t => {
                    t.style.background = 'rgba(20, 30, 40, 0.5)';
                    t.style.borderColor = '#2a3a4a';
                    t.style.color = '#8a9aaa';
                    t.classList.remove('active');
                });
                tab.style.background = 'rgba(74, 154, 138, 0.3)';
                tab.style.borderColor = '#4a9a8a';
                tab.style.color = '#5abaaa';
                tab.classList.add('active');
                
                // Show corresponding content
                document.querySelectorAll('.clan-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`tab-${tabName}`).style.display = 'block';
                
                // Initialize storage if storage tab is opened
                if (tabName === 'storage') {
                    initializeClanStorageTab();
                }
            });
        });

        // Clan storage modal
        // PvM stats button removed - keeping modal code for reference
        /*
        document.getElementById('pvmStatsBtn').addEventListener('click', () => {
            document.getElementById('pvmStatsModal').style.display = 'block';
        });
        */

        document.getElementById('closePvmStats').addEventListener('click', () => {
            document.getElementById('pvmStatsModal').style.display = 'none';
        });

        // Add Money button (in Storage tab)
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.id === 'addMoneyBtn') {
                if (!currentUser || !database || !playerProfile.clanId) {
                    showFloatingText('Error: Not in a clan or not signed in', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                const amount = prompt('How much gold do you want to add to the clan vault?');
                if (!amount || isNaN(amount) || parseInt(amount) <= 0) {
                    showFloatingText('Invalid amount', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                const goldAmount = parseInt(amount);
                
                // Check if player has enough gold
                if (gameState.player.gold < goldAmount) {
                    showFloatingText('Not enough gold', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                // Deduct from player
                gameState.player.gold -= goldAmount;
                
                // Add to clan vault
                const clanRef = database.ref(`clans/${playerProfile.clanId}/gold`);
                const snapshot = await clanRef.once('value');
                const currentClanGold = snapshot.val() || 0;
                await clanRef.set(currentClanGold + goldAmount);
                
                // Update display
                document.getElementById('clanGoldTab').textContent = currentClanGold + goldAmount;
                updateGoldDisplay();
                
                showFloatingText(`Added ${goldAmount} gold to clan vault`, canvas.width / 2, 100, '#5abaaa');
            }
        });

        // Recruitment center
        document.getElementById('recruitmentCenterBtn').addEventListener('click', async () => {
            document.getElementById('recruitmentCenterModal').style.display = 'block';
            await loadApplications();
            await loadRecruitmentStatus();
        });

        document.getElementById('closeRecruitment').addEventListener('click', () => {
            document.getElementById('recruitmentCenterModal').style.display = 'none';
        });

        // Load recruitment status
        async function loadRecruitmentStatus() {
            if (!playerProfile.clanId || !database) return;

            const clanRef = database.ref(`clans/${playerProfile.clanId}`);
            const snapshot = await clanRef.once('value');
            const clan = snapshot.val();

            const isInviteOnly = clan.inviteOnly || false;
            const statusText = isInviteOnly ? 'Invite Only' : 'Open to Applications';
            document.getElementById('currentRecruitmentStatus').textContent = `Status: ${statusText}`;

            // Update button styles
            if (isInviteOnly) {
                document.getElementById('setOpenRecruitment').style.background = 'rgba(20, 30, 40, 0.5)';
                document.getElementById('setOpenRecruitment').style.borderColor = '#2a3a4a';
                document.getElementById('setOpenRecruitment').style.color = '#8a9aaa';
                
                document.getElementById('setInviteOnly').style.background = 'rgba(74, 154, 138, 0.3)';
                document.getElementById('setInviteOnly').style.borderColor = '#4a9a8a';
                document.getElementById('setInviteOnly').style.color = '#5abaaa';
            } else {
                document.getElementById('setOpenRecruitment').style.background = 'rgba(74, 154, 138, 0.3)';
                document.getElementById('setOpenRecruitment').style.borderColor = '#4a9a8a';
                document.getElementById('setOpenRecruitment').style.color = '#5abaaa';
                
                document.getElementById('setInviteOnly').style.background = 'rgba(20, 30, 40, 0.5)';
                document.getElementById('setInviteOnly').style.borderColor = '#2a3a4a';
                document.getElementById('setInviteOnly').style.color = '#8a9aaa';
            }
        }

        // Set recruitment status
        document.getElementById('setOpenRecruitment').addEventListener('click', async () => {
            if (!playerProfile.clanId || !database || playerProfile.clanRole !== 'Leader') return;
            
            await database.ref(`clans/${playerProfile.clanId}`).update({ inviteOnly: false });
            await loadRecruitmentStatus();
            showFloatingText('Clan is now open to applications', canvas.width / 2, 100, '#5abaaa');
        });

        document.getElementById('setInviteOnly').addEventListener('click', async () => {
            if (!playerProfile.clanId || !database || playerProfile.clanRole !== 'Leader') return;
            
            await database.ref(`clans/${playerProfile.clanId}`).update({ inviteOnly: true });
            await loadRecruitmentStatus();
            showFloatingText('Clan is now invite-only', canvas.width / 2, 100, '#5abaaa');
        });

        // Send invite
        document.getElementById('sendInviteBtn').addEventListener('click', async () => {
            if (!playerProfile.clanId || !database || playerProfile.clanRole !== 'Leader') return;
            
            const username = document.getElementById('inviteUsernameInput').value.trim();
            if (!username) {
                showFloatingText('Please enter a username', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Find player by username
            const usernamesRef = database.ref('usernames');
            const snapshot = await usernamesRef.orderByValue().equalTo(username).once('value');
            
            if (!snapshot.exists()) {
                showFloatingText('Username not found', canvas.width / 2, 100, '#ff4444');
                return;
            }

            let targetUserId = null;
            snapshot.forEach((snap) => {
                targetUserId = snap.key;
            });

            // Check if already in a clan
            const playerRef = database.ref(`players/${targetUserId}/profile`);
            const playerSnapshot = await playerRef.once('value');
            const targetPlayer = playerSnapshot.val();

            if (targetPlayer && targetPlayer.clanId) {
                showFloatingText('Player is already in a clan', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Send invite
            await database.ref(`clanInvites/${targetUserId}/${playerProfile.clanId}`).set({
                clanName: playerProfile.clanName,
                from: playerProfile.username,
                timestamp: Date.now()
            });

            document.getElementById('inviteUsernameInput').value = '';
            showFloatingText(`Invite sent to ${username}`, canvas.width / 2, 100, '#5abaaa');
        });

        // Load applications
        async function loadApplications() {
            if (!playerProfile.clanId || !database) return;

            const applicationsRef = database.ref(`clanApplications/${playerProfile.clanId}`);
            const snapshot = await applicationsRef.once('value');
            
            const applicationsList = document.getElementById('applicationsList');
            applicationsList.innerHTML = '';

            if (!snapshot.exists()) {
                applicationsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No pending applications</div>';
                return;
            }

            snapshot.forEach((appSnap) => {
                const application = appSnap.val();
                const applicantId = appSnap.key;

                const appDiv = document.createElement('div');
                appDiv.style.cssText = 'background: rgba(0,0,0,0.3); border: 2px solid #2a3a4a; border-radius: 8px; padding: 15px; margin-bottom: 10px;';
                appDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="color: #5abaaa; font-weight: bold; font-size: 14px;">${application.username}</div>
                            <div style="color: #8a9aaa; font-size: 11px;">Applied ${new Date(application.timestamp).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div style="color: #cad2da; font-size: 13px; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">${application.message || 'No message'}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="accept-app-btn" data-applicant-id="${applicantId}" data-username="${application.username}" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #2a5a4a, #1a4a3a); border: 2px solid #3a6a5a; border-radius: 5px; color: #5abaaa; cursor: pointer; font-weight: bold;">‚úì Accept</button>
                        <button class="decline-app-btn" data-applicant-id="${applicantId}" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #5a2a2a, #4a1a1a); border: 2px solid #6a3a3a; border-radius: 5px; color: #ff6666; cursor: pointer; font-weight: bold;">‚úó Decline</button>
                    </div>
                `;
                
                applicationsList.appendChild(appDiv);
            });

            // Add accept/decline handlers
            document.querySelectorAll('.accept-app-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const applicantId = btn.dataset.applicantId;
                    const username = btn.dataset.username;
                    await acceptApplication(applicantId, username);
                });
            });

            document.querySelectorAll('.decline-app-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const applicantId = btn.dataset.applicantId;
                    await declineApplication(applicantId);
                });
            });
        }

        // Accept application
        async function acceptApplication(applicantId, username) {
            if (!playerProfile.clanId || !database) return;

            const clanId = playerProfile.clanId;
            const clanRef = database.ref(`clans/${clanId}`);
            const clanSnapshot = await clanRef.once('value');
            const clan = clanSnapshot.val();

            // Check if clan is full (max 5 members)
            if ((clan.memberCount || 0) >= 5) {
                showFloatingText('Clan is full (max 5 members)', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Add member
            await database.ref(`clans/${clanId}/members/${applicantId}`).set({
                username: username,
                role: 'Member',
                joinedAt: Date.now()
            });

            // Update member count
            await clanRef.update({
                memberCount: (clan.memberCount || 0) + 1
            });

            // Update applicant's profile
            await database.ref(`players/${applicantId}/profile`).update({
                clanId: clanId,
                clanName: clan.name,
                clanRole: 'Member'
            });

            // Remove application
            await database.ref(`clanApplications/${clanId}/${applicantId}`).remove();

            showFloatingText(`${username} accepted into clan`, canvas.width / 2, 100, '#5abaaa');
            await loadApplications();
            await loadClanMembers();
        }

        // Decline application
        async function declineApplication(applicantId) {
            if (!playerProfile.clanId || !database) return;

            await database.ref(`clanApplications/${playerProfile.clanId}/${applicantId}`).remove();
            showFloatingText('Application declined', canvas.width / 2, 100, '#8a9aaa');
            await loadApplications();
        }

        // Bulletin board
        document.getElementById('bulletinBoardBtn').addEventListener('click', async () => {
            document.getElementById('bulletinBoardModal').style.display = 'block';
            await loadBulletinMessages();
        });

        document.getElementById('closeBulletinBoard').addEventListener('click', () => {
            document.getElementById('bulletinBoardModal').style.display = 'none';
        });

        // Post bulletin message
        document.getElementById('postBulletinBtn').addEventListener('click', async () => {
            if (!playerProfile.clanId || !database) return;

            const message = document.getElementById('bulletinMessageInput').value.trim();
            if (!message) {
                showFloatingText('Please enter a message', canvas.width / 2, 100, '#ff4444');
                return;
            }

            await database.ref(`clanBulletins/${playerProfile.clanId}`).push({
                username: playerProfile.username,
                message: message,
                timestamp: Date.now()
            });

            document.getElementById('bulletinMessageInput').value = '';
            showFloatingText('Message posted', canvas.width / 2, 100, '#5abaaa');
            await loadBulletinMessages();
        });

        // Load bulletin messages
        async function loadBulletinMessages() {
            if (!playerProfile.clanId || !database) return;

            const bulletinsRef = database.ref(`clanBulletins/${playerProfile.clanId}`);
            const snapshot = await bulletinsRef.limitToLast(20).once('value');
            
            const messagesList = document.getElementById('bulletinMessagesList');
            messagesList.innerHTML = '';

            if (!snapshot.exists()) {
                messagesList.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No messages yet</div>';
                return;
            }

            const messages = [];
            snapshot.forEach((msgSnap) => {
                messages.push({ key: msgSnap.key, ...msgSnap.val() });
            });

            // Reverse to show newest first
            messages.reverse().forEach((message) => {
                const msgDiv = document.createElement('div');
                msgDiv.style.cssText = 'background: rgba(0,0,0,0.3); border: 2px solid #2a3a4a; border-radius: 8px; padding: 12px; margin-bottom: 10px;';
                
                const date = new Date(message.timestamp);
                msgDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div style="color: #5abaaa; font-weight: bold; font-size: 13px;">${message.username}</div>
                        <div style="color: #8a9aaa; font-size: 11px;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                    </div>
                    <div style="color: #cad2da; font-size: 13px;">${message.message}</div>
                `;
                
                messagesList.appendChild(msgDiv);
            });
        }

        // Leave clan from clan page
        document.getElementById('leaveClanPageBtn').addEventListener('click', async () => {
            if (!currentUser || !database || !playerProfile.clanId) return;
            
            if (!confirm('Are you sure you want to leave your clan?')) return;
            
            const clanId = playerProfile.clanId;
            
            // Remove from clan members
            await database.ref(`clans/${clanId}/members/${currentUser.uid}`).remove();
            
            // Update member count
            const clanRef = database.ref(`clans/${clanId}`);
            const clanSnapshot = await clanRef.once('value');
            const clan = clanSnapshot.val();
            
            const newMemberCount = (clan.memberCount || 1) - 1;
            
            if (newMemberCount === 0) {
                // Delete clan if no members left
                await clanRef.remove();
            } else {
                await clanRef.update({ memberCount: newMemberCount });
            }
            
            // Update player profile
            playerProfile.clanId = null;
            playerProfile.clanName = null;
            playerProfile.clanRole = null;
            await database.ref(`players/${currentUser.uid}/profile`).update({
                clanId: null,
                clanName: null,
                clanRole: null
            });
            
            document.getElementById('clanPageModal').style.display = 'none';
            updateProfileDisplay();
            showFloatingText('Left clan', canvas.width / 2, 100, '#8a9aaa');
        });

        // Enhanced clan list with applications
        async function loadClanListWithApplications() {
            if (!database) return;
            
            const clansRef = database.ref('clans');
            const snapshot = await clansRef.limitToFirst(50).once('value');
            
            const clanListDiv = document.getElementById('clanList');
            clanListDiv.innerHTML = '';
            
            if (!snapshot.exists()) {
                clanListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No clans available</div>';
                return;
            }
            
            snapshot.forEach((clanSnap) => {
                const clan = clanSnap.val();
                const clanId = clanSnap.key;
                
                const isFull = (clan.memberCount || 0) >= 5;
                const isInviteOnly = clan.inviteOnly || false;
                const canApply = !isFull && !isInviteOnly;
                
                let statusBadge = '';
                if (isFull) {
                    statusBadge = '<span style="background: #8a2a2a; color: #ff6666; padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold;">FULL</span>';
                } else if (isInviteOnly) {
                    statusBadge = '<span style="background: #5a4a2a; color: #ffaa66; padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold;">üîí INVITE ONLY</span>';
                }
                
                const clanDiv = document.createElement('div');
                clanDiv.style.cssText = 'background: rgba(90, 138, 250, 0.1); border: 2px solid #2a3a4a; border-radius: 5px; padding: 15px; margin-bottom: 10px; transition: all 0.3s;';
                clanDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <div style="color: #5a8afa; font-weight: bold; font-size: 16px;">[${clan.tag}] ${clan.name}</div>
                                ${statusBadge}
                            </div>
                            <div style="color: #8a9aaa; font-size: 12px;">Leader: ${clan.leaderName} ‚Ä¢ Members: ${clan.memberCount || 0}/5</div>
                        </div>
                        ${canApply ? `<button class="applyClanButton" data-clan-id="${clanId}" data-clan-name="[${clan.tag}] ${clan.name}" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;">Apply</button>` : ''}
                    </div>
                `;
                
                clanDiv.addEventListener('mouseenter', () => {
                    if (canApply) clanDiv.style.background = 'rgba(90, 138, 250, 0.2)';
                });
                
                clanDiv.addEventListener('mouseleave', () => {
                    clanDiv.style.background = 'rgba(90, 138, 250, 0.1)';
                });
                
                clanListDiv.appendChild(clanDiv);
            });
            
            // Add apply button handlers
            document.querySelectorAll('.applyClanButton').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentApplyingClanId = btn.dataset.clanId;
                    document.getElementById('applyClanName').textContent = btn.dataset.clanName;
                    document.getElementById('applyClanModal').style.display = 'block';
                    document.getElementById('applicationMessage').value = '';
                    document.getElementById('messageCharCount').textContent = '0';
                });
            });
        }

        // Application message character count
        document.getElementById('applicationMessage').addEventListener('input', (e) => {
            document.getElementById('messageCharCount').textContent = e.target.value.length;
        });

        // Close apply clan modal
        document.getElementById('closeApplyClan').addEventListener('click', () => {
            document.getElementById('applyClanModal').style.display = 'none';
        });

        // Confirm application
        document.getElementById('confirmApplyClan').addEventListener('click', async () => {
            if (!currentUser || !database || !currentApplyingClanId) return;

            const message = document.getElementById('applicationMessage').value.trim();
            
            // Submit application
            await database.ref(`clanApplications/${currentApplyingClanId}/${currentUser.uid}`).set({
                username: playerProfile.username,
                message: message,
                timestamp: Date.now()
            });

            document.getElementById('applyClanModal').style.display = 'none';
            showFloatingText('Application sent!', canvas.width / 2, 100, '#5abaaa');
        });

        // Close clan storage modal
        document.getElementById('closeClanStorage').addEventListener('click', () => {
            document.getElementById('clanStorageModal').style.display = 'none';
        });

        // END PROFILE & CLAN SYSTEM
        // ============================================

        // Check auth state on load - only if Firebase is configured
        if (isFirebaseConfigured && auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    isGuestMode = false;
                    document.getElementById('loginModal').style.display = 'none';
                    updateUserUI();
                    await loadPlayerProfile(); // Load username and clan info
                } else if (!isGuestMode) {
                    currentUser = null;
                    document.getElementById('loginModal').style.display = 'flex';
                }
            });
        } else {
            // Firebase not configured - show login modal (guest mode available)
            document.getElementById('loginModal').style.display = 'flex';
        }

        // Update user UI in top bar
        function updateUserUI() {
            const topBar = document.getElementById('topBar');
            // Remove old user info if exists
            const oldInfo = document.querySelector('.user-info');
            if (oldInfo) oldInfo.remove();
            
            if (currentUser && auth) {
                // Logged in with Google
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar">
                    <span class="user-name">${currentUser.displayName}</span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                `;
                topBar.appendChild(userInfo);
                
                // Logout handler
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (auth) {
                        auth.signOut();
                        showFloatingText('Logged out', canvas.width / 2, 100, '#8a9aaa');
                    }
                });
            } else if (isGuestMode) {
                // Playing as guest
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                
                if (isFirebaseConfigured) {
                    // Firebase is set up, show login option
                    userInfo.innerHTML = `
                        <span class="user-name" style="color: #8a9aaa;">üë§ Guest Mode</span>
                        <button class="logout-btn" id="loginBtn" style="background: linear-gradient(135deg, #4a7a6a, #3a6a5a); color: #5abaaa; border-color: #5a8a7a;">Login</button>
                    `;
                } else {
                    // Firebase not configured, can't login
                    userInfo.innerHTML = `
                        <span class="user-name" style="color: #8a9aaa;">üë§ Guest Mode</span>
                        <span style="color: #6a8a9a; font-size: 11px; margin-left: 10px;">(Login requires Firebase setup)</span>
                    `;
                }
                
                topBar.appendChild(userInfo);
                
                // Login button handler (only if Firebase configured)
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        isGuestMode = false;
                        document.getElementById('loginModal').style.display = 'flex';
                    });
                }
            }
        }


        // ========================================
        // GRAND EXCHANGE SYSTEM (OSRS-Style)
        // ========================================

        // Tradeable Resources
        // Sprite URLs (from game)
        const spriteUrls = {
            log: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Log%20T1%20Common.png',
            log_uncommon_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Log%20T1%20Uncommon.png',
            log_rare_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Log%20T1%20Rare.png',
            log_epic_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Log%20T1%20Epic.png',
            log_perfect_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Log%20T1%20Perfect.png',
            ore: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/ore.png',
            fish: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/Fish%20T1.png'
        };

        // Generate TRADEABLE_ITEMS with all rarity variations
        const TRADEABLE_ITEMS = {};
        
        // Rarity multipliers for pricing
        const rarityMultipliers = {
            'Common': 1,
            'Uncommon': 1.5,
            'Rare': 2.5,
            'Epic': 4,
            'Perfect': 7
        };
        
        // Base items with their tier prices
        const baseItems = [
            { name: 'Logs', icon: 'ü™µ', sprite: 'log', prices: [10, 25, 50, 75, 100] },
            { name: 'Ore', icon: '‚õèÔ∏è', sprite: 'ore', prices: [15, 30, 60, 90, 120] },
            { name: 'Fish', icon: 'üêü', sprite: 'fish', prices: [12, 28, 55, 80, 110] },
            { name: 'Herb', icon: 'üåø', sprite: 'herb', prices: [8, 20, 45, 70, 95] }
        ];
        
        // Generate entries for all tier and rarity combinations
        baseItems.forEach(item => {
            for (let tier = 1; tier <= 5; tier++) {
                const basePrice = item.prices[tier - 1];
                Object.keys(rarityMultipliers).forEach(rarity => {
                    const itemKey = `T${tier} ${rarity} ${item.name}`;
                    TRADEABLE_ITEMS[itemKey] = {
                        icon: item.icon,
                        basePrice: Math.floor(basePrice * rarityMultipliers[rarity]),
                        tier: tier,
                        rarity: rarity,
                        sprite: spriteUrls[item.sprite] || item.icon
                    };
                });
            }
        });
        
        // Debug: Log some examples
        console.log('TRADEABLE_ITEMS generated:', {
            'T1 Common Ore': TRADEABLE_ITEMS['T1 Common Ore'],
            'T1 Uncommon Ore': TRADEABLE_ITEMS['T1 Uncommon Ore'],
            'T1 Rare Ore': TRADEABLE_ITEMS['T1 Rare Ore'],
            totalItems: Object.keys(TRADEABLE_ITEMS).length
        });

        // Grand Exchange State
        let playerOffers = {
            buy: [null, null, null, null],
            sell: [null, null, null, null]
        };
        let guidePrices = {};
        let selectedSlot = null;
        let selectedGEItem = null;
        let selectedGEItemMaxQty = 0;
        let selectedGEItemFullName = null; // Full name with rarity for sell items
        let geListeners = [];
        let geInitialized = false;

        // Initialize Grand Exchange
        function initGrandExchange() {
            if (!isFirebaseConfigured || !database) {
                console.log('Grand Exchange requires Firebase');
                return;
            }
            
            loadPlayerOffers();
            loadGuidePrices();
            setupGEEventListeners();
            startOfferMatching();
            initializeMarketTracking(); // Track market trends and price history
        }

        // Load player's offers from Firebase
        function loadPlayerOffers() {
            if (!currentUser) return;

            const offersRef = database.ref(`grandExchange/playerOffers/${currentUser.uid}`);
            offersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Ensure both buy and sell are actual arrays, not objects
                    // Firebase can convert arrays with nulls to objects
                    const buyArray = data.buy ? Object.values(data.buy) : [null, null, null, null];
                    const sellArray = data.sell ? Object.values(data.sell) : [null, null, null, null];
                    
                    // Ensure arrays have exactly 4 slots
                    while (buyArray.length < 4) buyArray.push(null);
                    while (sellArray.length < 4) sellArray.push(null);
                    
                    playerOffers = {
                        buy: buyArray.slice(0, 4),
                        sell: sellArray.slice(0, 4)
                    };
                    updateOfferSlots();
                }
            });
        }

        // Load guide prices
        function loadGuidePrices() {
            const pricesRef = database.ref('grandExchange/guidePrices');
            pricesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    guidePrices = data;
                } else {
                    // Initialize with base prices
                    Object.keys(TRADEABLE_ITEMS).forEach(itemName => {
                        guidePrices[itemName] = TRADEABLE_ITEMS[itemName].basePrice;
                    });
                    database.ref('grandExchange/guidePrices').set(guidePrices);
                }
            });
        }

        // Update offer slots display
        function updateOfferSlots() {
            console.log('updateOfferSlots called, playerOffers:', playerOffers);
            
            // Ensure playerOffers has proper structure
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];
            
            ['buy', 'sell'].forEach(type => {
                playerOffers[type].forEach((offer, index) => {
                    const slot = document.querySelector(`.offer-slot[data-slot-type="${type}"][data-slot-index="${index}"]`);
                    console.log(`Slot ${type}[${index}]:`, { slot, offer });
                    if (!slot) {
                        console.warn(`Slot not found for ${type}[${index}]`);
                        return;
                    }
                    
                    if (offer) {
                        slot.classList.remove('empty');
                        
                        const progress = (offer.quantityFilled / offer.quantity) * 100;
                        
                        if (offer.quantityFilled >= offer.quantity) {
                            slot.classList.add('completed');
                            slot.classList.remove('active', 'partial');
                        } else if (offer.quantityFilled > 0) {
                            slot.classList.add('partial');
                            slot.classList.remove('active', 'completed');
                        } else {
                            slot.classList.add('active');
                            slot.classList.remove('partial', 'completed');
                        }

                        let itemData = TRADEABLE_ITEMS[offer.itemName];
                        
                        // BACKWARDS COMPATIBILITY: Handle old format "Logs (Tier 1)" -> "T1 Common Logs"
                        if (!itemData && offer.itemName) {
                            const oldFormatMatch = offer.itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                            if (oldFormatMatch) {
                                const [, baseName, tier] = oldFormatMatch;
                                const newItemName = `T${tier} Common ${baseName}`;
                                console.log('Converting old format:', { old: offer.itemName, new: newItemName });
                                itemData = TRADEABLE_ITEMS[newItemName];
                                // Update the offer itemName for future use
                                offer.itemName = newItemName;
                            }
                        }
                        
                        const iconDisplay = itemData?.sprite ? 
                            `<img src="${itemData.sprite}" style="width: 32px; height: 32px; object-fit: contain;">` : 
                            (itemData?.icon || 'üì¶');
                        
                        // Determine progress bar color
                        let progressColor = '#00ff00'; // Green for completed
                        if (progress === 0) {
                            progressColor = '#555555'; // Dark gray for empty
                        } else if (progress < 100) {
                            progressColor = '#ffaa00'; // Yellow/orange for partial
                        }
                        
                        const displayName = offer.itemName || 'Unknown Item';
                        
                        const html = `
                            <div class="slot-item-icon">${iconDisplay}</div>
                            <div class="slot-item-name">${displayName}</div>
                            <div class="slot-quantity">${offer.quantityFilled}/${offer.quantity}</div>
                            <div class="slot-progress-bar">
                                <div class="slot-progress-fill" style="width: ${progress}%; background-color: ${progressColor};"></div>
                            </div>
                            <div class="slot-status">${offer.pricePerItem} gp</div>
                        `;
                        console.log(`Setting slot ${type}[${index}] HTML:`, html);
                        slot.innerHTML = html;
                    } else {
                        slot.classList.add('empty');
                        slot.classList.remove('active', 'partial', 'completed');
                        slot.innerHTML = '';
                    }
                });
            });
        }

        // Setup event listeners
        function setupGEEventListeners() {
            // Slot clicks
            document.querySelectorAll('.offer-slot').forEach(slot => {
                slot.addEventListener('click', () => handleSlotClick(slot));
            });

            // Close button
            document.getElementById('closeGE').addEventListener('click', () => {
                document.getElementById('grandExchangeModal').style.display = 'none';
            });
            
            // Collect All button
            document.getElementById('collectAllOffers').addEventListener('click', collectAllOffers);

            // Buy offer form
            setupBuyOfferForm();
            
            // Sell offer form
            setupSellOfferForm();
            
            // Cancel/collect buttons
            document.getElementById('cancelOffer').addEventListener('click', handleCancelOffer);
            document.getElementById('collectOffer').addEventListener('click', handleCollectOffer);
        }

        // Handle slot click
        function handleSlotClick(slot) {
            const type = slot.dataset.slotType;
            const index = parseInt(slot.dataset.slotIndex);
            selectedSlot = { type, index };

            const offer = playerOffers[type][index];

            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));

            if (offer) {
                displayOfferStatus(offer, type, index);
                document.getElementById('viewOffer').classList.add('active');
            } else {
                if (type === 'buy') {
                    resetBuyForm();
                    document.getElementById('createBuyOffer').classList.add('active');
                } else {
                    resetSellForm();
                    loadGEInventory();
                    document.getElementById('createSellOffer').classList.add('active');
                }
            }
        }

        // Setup buy offer form
        function setupBuyOfferForm() {
            const searchInput = document.getElementById('buyItemSearch');
            const resultsDiv = document.getElementById('buyItemResults');
            const priceInput = document.getElementById('buyPrice');
            const quantityInput = document.getElementById('buyQuantity');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                if (query.length === 0) {
                    resultsDiv.innerHTML = '';
                    return;
                }

                // Use smart search with multi-word AND logic
                const results = Object.keys(TRADEABLE_ITEMS).filter(name => 
                    smartSearchMatch(name, query)
                );

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 20px; color: #8a7a6a; text-align: center;">No items found. Try different keywords.</div>';
                    return;
                }

                resultsDiv.innerHTML = results.map(itemName => {
                    const item = TRADEABLE_ITEMS[itemName];
                    const guidePrice = guidePrices[itemName] || item.basePrice;
                    
                    return `
                        <div class="ge-item-result" data-item="${itemName}">
                            <div class="ge-item-result-icon">${item.icon}</div>
                            <div class="ge-item-result-info">
                                <div class="ge-item-result-name">${itemName}</div>
                                <div class="ge-item-result-price">Guide: ${guidePrice} gp</div>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsDiv.querySelectorAll('.ge-item-result').forEach(result => {
                    result.addEventListener('click', () => {
                        selectBuyItem(result.dataset.item);
                    });
                });
            });

            // OSRS-Style +/- buttons for quantity
            const buyQtyMinus = document.getElementById('buyQtyMinus');
            const buyQtyPlus = document.getElementById('buyQtyPlus');
            if (buyQtyMinus) {
                buyQtyMinus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.max(1, current - 1);
                    updateBuyTotal();
                });
            }
            if (buyQtyPlus) {
                buyQtyPlus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = current + 1;
                    updateBuyTotal();
                });
            }

            // OSRS-Style +/- buttons for price
            const buyPriceMinus = document.getElementById('buyPriceMinus');
            const buyPricePlus = document.getElementById('buyPricePlus');
            const buyPriceGuide = document.getElementById('buyPriceGuide');
            const buyPriceMore = document.getElementById('buyPriceMore');
            
            if (buyPriceMinus) {
                buyPriceMinus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = Math.max(1, current - 1);
                    updateBuyTotal();
                });
            }
            if (buyPricePlus) {
                buyPricePlus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = current + 1;
                    updateBuyTotal();
                });
            }
            if (buyPriceGuide) {
                buyPriceGuide.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = guidePrice;
                    updateBuyTotal();
                });
            }
            if (buyPriceMore) {
                buyPriceMore.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = Math.ceil(guidePrice * 1.05);
                    updateBuyTotal();
                });
            }

            // Price controls (old style - keep for compatibility)
            document.querySelectorAll('#createBuyOffer .ge-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (!selectedGEItem) return;
                    
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    
                    if (action === 'guide') {
                        priceInput.value = guidePrice;
                    } else if (action === '5%') {
                        priceInput.value = Math.ceil(guidePrice * 1.05);
                    } else if (action === '10%') {
                        priceInput.value = Math.ceil(guidePrice * 1.10);
                    }
                    updateBuyTotal();
                });
            });

            // Quantity controls
            document.querySelectorAll('#createBuyOffer .ge-qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const qtyStr = btn.dataset.qty;
                    const current = parseInt(quantityInput.value) || 1;
                    
                    if (qtyStr === '-max') {
                        quantityInput.value = 1;
                    } else {
                        const qty = parseInt(qtyStr);
                        quantityInput.value = current + qty;
                    }
                    updateBuyTotal();
                });
            });

            // Back button
            const buyBackBtn = document.getElementById('buyBackBtn');
            if (buyBackBtn) {
                buyBackBtn.addEventListener('click', () => {
                    resetBuyForm();
                    document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                    document.getElementById('emptyState').classList.add('active');
                });
            }

            priceInput.addEventListener('input', updateBuyTotal);
            quantityInput.addEventListener('input', updateBuyTotal);

            document.getElementById('confirmBuy').addEventListener('click', confirmBuyOffer);
        }

        // Select buy item
        function selectBuyItem(itemName) {
            selectedGEItem = itemName;
            const item = TRADEABLE_ITEMS[itemName];
            const guidePrice = guidePrices[itemName] || item.basePrice;

            // Hide search, show item display
            document.getElementById('buySearchGroup').style.display = 'none';
            document.getElementById('buySelectedItem').style.display = 'block';
            
            // Update item display with GitHub sprite image
            const iconEl = document.getElementById('buyItemIcon');
            if (item.sprite) {
                iconEl.innerHTML = `<img src="${item.sprite}" style="width: 100%; height: 100%; object-fit: contain;">`;
            } else {
                iconEl.textContent = item.icon;
            }
            
            document.getElementById('buyItemName').textContent = itemName;
            
            // Enhanced price info with market trends
            let priceInfo = `Guide price: ${guidePrice} gp`;
            if (marketData[itemName]) {
                const data = marketData[itemName];
                const arrow = data.priceChange > 0 ? 'üìà' : data.priceChange < 0 ? 'üìâ' : '‚û°Ô∏è';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                priceInfo += ` <span style="color: ${changeColor};">${arrow} ${data.priceChange !== 0 ? data.priceChange.toFixed(1) + '%' : ''}</span>`;
                if (data.totalVolume > 0) {
                    priceInfo += `<br><span style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</span>`;
                }
            }
            document.getElementById('buyItemPriceInfo').innerHTML = priceInfo;

            document.getElementById('buyItemSearch').value = itemName;
            document.getElementById('buyItemResults').innerHTML = '';
            document.getElementById('buyPrice').value = guidePrice;
            document.getElementById('buyGuidePrice').textContent = `Guide price: ${guidePrice} gp`;
            
            document.getElementById('buyPriceGroup').style.display = 'block';
            document.getElementById('buyQuantityGroup').style.display = 'block';
            document.getElementById('buyTotal').style.display = 'block';
            document.getElementById('buyActions').style.display = 'flex';

            updateBuyTotal();
        }

        // Update buy total
        function updateBuyTotal() {
            const price = parseInt(document.getElementById('buyPrice').value) || 0;
            const quantity = parseInt(document.getElementById('buyQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('buyTotalAmount').textContent = total.toLocaleString();
        }

        // Confirm buy offer
        async function confirmBuyOffer() {
            if (!selectedSlot || !selectedGEItem) return;

            const price = parseInt(document.getElementById('buyPrice').value);
            const quantity = parseInt(document.getElementById('buyQuantity').value);
            const total = price * quantity;

            if (price <= 0 || quantity <= 0) {
                showFloatingText('Invalid price or quantity', canvas.width / 2, 100, '#ff4444');
                return;
            }

            if (gameState.player.gold < total) {
                showFloatingText('Not enough gold!', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Deduct gold
            gameState.player.gold -= total;

            const offer = {
                itemName: selectedGEItem,
                pricePerItem: price,
                quantity: quantity,
                quantityFilled: 0,
                type: 'buy',
                playerId: currentUser.uid,
                playerName: currentUser.email ? currentUser.email.split('@')[0] : 'Player',
                timestamp: Date.now(),
                status: 'active',
                collectedItems: 0,
                goldSpent: total
            };

            // Ensure playerOffers has both buy and sell arrays
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];

            playerOffers.buy[selectedSlot.index] = offer;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            const offerRef = database.ref('grandExchange/activeOffers/buy').push();
            await offerRef.set({
                ...offer,
                offerId: offerRef.key,
                slotIndex: selectedSlot.index
            });

            // Update UI immediately
            updateOfferSlots();
            
            resetBuyForm();
            showFloatingText('Buy offer created!', canvas.width / 2, 100, '#00ff00');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Reset buy form
        function resetBuyForm() {
            document.getElementById('buyItemSearch').value = '';
            document.getElementById('buyItemResults').innerHTML = '';
            document.getElementById('buySearchGroup').style.display = 'block';
            document.getElementById('buySelectedItem').style.display = 'none';
            document.getElementById('buyPriceGroup').style.display = 'none';
            document.getElementById('buyQuantityGroup').style.display = 'none';
            document.getElementById('buyTotal').style.display = 'none';
            document.getElementById('buyActions').style.display = 'none';
            selectedGEItem = null;
        }

        // Setup sell offer form
        function setupSellOfferForm() {
            const searchInput = document.getElementById('sellItemSearch');
            const resultsDiv = document.getElementById('sellItemResults');
            const priceInput = document.getElementById('sellPrice');
            const quantityInput = document.getElementById('sellQuantity');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                loadGEInventory(query);
            });


            // OSRS-Style +/- buttons for quantity
            const sellQtyMinus = document.getElementById('sellQtyMinus');
            const sellQtyPlus = document.getElementById('sellQtyPlus');
            if (sellQtyMinus) {
                sellQtyMinus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.max(1, current - 1);
                    updateSellTotal();
                });
            }
            if (sellQtyPlus) {
                sellQtyPlus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.min(current + 1, selectedGEItemMaxQty);
                    updateSellTotal();
                });
            }

            // OSRS-Style +/- buttons for price
            const sellPriceMinus = document.getElementById('sellPriceMinus');
            const sellPricePlus = document.getElementById('sellPricePlus');
            const sellPriceGuide = document.getElementById('sellPriceGuide');
            const sellPriceLess = document.getElementById('sellPriceLess');
            
            if (sellPriceMinus) {
                sellPriceMinus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = Math.max(1, current - 1);
                    updateSellTotal();
                });
            }
            if (sellPricePlus) {
                sellPricePlus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = current + 1;
                    updateSellTotal();
                });
            }
            if (sellPriceGuide) {
                sellPriceGuide.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = guidePrice;
                    updateSellTotal();
                });
            }
            if (sellPriceLess) {
                sellPriceLess.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = Math.floor(guidePrice * 0.95);
                    updateSellTotal();
                });
            }

            // Back button
            const sellBackBtn = document.getElementById('sellBackBtn');
            if (sellBackBtn) {
                sellBackBtn.addEventListener('click', () => {
                    resetSellForm();
                    document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                    document.getElementById('emptyState').classList.add('active');
                });
            }


            // Price controls
            document.querySelectorAll('#createSellOffer .ge-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (!selectedGEItem) return;
                    
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    
                    if (action === 'guide') {
                        priceInput.value = guidePrice;
                    } else if (action === '-5%') {
                        priceInput.value = Math.floor(guidePrice * 0.95);
                    } else if (action === '-10%') {
                        priceInput.value = Math.floor(guidePrice * 0.90);
                    }
                    updateSellTotal();
                });
            });

            // Quantity controls
            document.querySelectorAll('#createSellOffer .ge-qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.qty === 'max') {
                        quantityInput.value = selectedGEItemMaxQty;
                    } else {
                        const qty = parseInt(btn.dataset.qty);
                        const current = parseInt(quantityInput.value) || 0;
                        quantityInput.value = Math.min(current + qty, selectedGEItemMaxQty);
                    }
                    updateSellTotal();
                });
            });

            priceInput.addEventListener('input', updateSellTotal);
            quantityInput.addEventListener('input', () => {
                const val = parseInt(quantityInput.value) || 0;
                quantityInput.value = Math.min(val, selectedGEItemMaxQty);
                updateSellTotal();
            });

            document.getElementById('confirmSell').addEventListener('click', confirmSellOffer);
        }

        // Load inventory for GE
        function loadGEInventory(searchQuery = '') {
            const resultsDiv = document.getElementById('sellItemResults');
            
            console.log('loadGEInventory called with search:', searchQuery);
            console.log('Current inventory:', gameState.player.inventory.filter(i => i).map(i => ({ name: i.name, tier: i.tier, rarity: i.rarity })));
            
            // Filter inventory for tradeable items using smart search
            const tradeableInventory = gameState.player.inventory.filter(item => {
                if (!item) return false;
                
                // Use the full item name (includes tier and rarity)
                const isTradeable = TRADEABLE_ITEMS[item.name];
                if (!isTradeable) {
                    console.log('Item NOT tradeable:', { itemName: item.name, allKeys: Object.keys(TRADEABLE_ITEMS).slice(0, 10) });
                }
                return isTradeable && smartSearchMatch(item.name, searchQuery);
            });

            if (tradeableInventory.length === 0) {
                const message = searchQuery 
                    ? `No items found matching "${searchQuery}". Try different keywords.`
                    : 'No tradeable items';
                resultsDiv.innerHTML = `<div style="padding: 20px; color: #8a7a6a; text-align: center;">${message}</div>`;
                return;
            }

            resultsDiv.innerHTML = tradeableInventory.map(item => {
                const itemData = TRADEABLE_ITEMS[item.name];
                const guidePrice = guidePrices[item.name] || itemData.basePrice;
                
                // Debug logging
                console.log('GE Sell Item Debug:', {
                    name: item.name,
                    icon: item.icon,
                    tier: item.tier,
                    rarity: item.rarity,
                    spriteKey: item.icon,
                    spriteUrl: spriteUrls[item.icon],
                    allSpriteUrls: Object.keys(spriteUrls)
                });
                
                // Get sprite from inventory item (it has the rarity-specific sprite)
                let spriteUrl = null;
                
                // First try to use the item's icon property as a key
                if (item.icon && spriteUrls[item.icon]) {
                    spriteUrl = spriteUrls[item.icon];
                }
                // If that doesn't work, use the default sprite from TRADEABLE_ITEMS
                else if (itemData.sprite) {
                    spriteUrl = itemData.sprite;
                }
                
                const iconDisplay = spriteUrl ? 
                    `<img src="${spriteUrl}" style="width: 100%; height: 100%; object-fit: contain;">` : 
                    itemData.icon;
                
                // Show item name with quantity
                const displayName = `${item.name} (${item.quantity})`;
                
                return `
                    <div class="ge-item-result" data-item="${item.name}" data-quantity="${item.quantity}">
                        <div class="ge-item-result-icon">${iconDisplay}</div>
                        <div class="ge-item-result-info">
                            <div class="ge-item-result-name">${displayName}</div>
                            <div class="ge-item-result-price">Guide: ${guidePrice} gp</div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.querySelectorAll('.ge-item-result').forEach(result => {
                result.addEventListener('click', () => {
                    selectSellItem(result.dataset.item, parseInt(result.dataset.quantity));
                });
            });
        }

        // Select sell item
        function selectSellItem(itemName, availableQty) {
            console.log('selectSellItem called with:', { itemName, availableQty });
            selectedGEItem = itemName;
            selectedGEItemMaxQty = availableQty;
            selectedGEItemFullName = itemName; // Full name is the same as itemName now
            const item = TRADEABLE_ITEMS[itemName];
            console.log('TRADEABLE_ITEMS lookup:', { itemName, item, exists: !!item });
            
            if (!item) {
                console.error('Item not found in TRADEABLE_ITEMS!', { itemName, availableKeys: Object.keys(TRADEABLE_ITEMS).filter(k => k.includes('Ore')) });
                showFloatingText('Error: Item not tradeable!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            const guidePrice = guidePrices[itemName] || item.basePrice;

            // Get the actual inventory item to use its sprite
            const invItem = gameState.player.inventory.find(i => i && i.name === itemName);
            
            // Try to get sprite URL with fallbacks
            let spriteUrl = null;
            if (invItem && invItem.icon && spriteUrls[invItem.icon]) {
                spriteUrl = spriteUrls[invItem.icon];
            } else if (item.sprite) {
                spriteUrl = item.sprite;
            }

            // Hide search, show item display
            document.getElementById('sellSearchGroup').style.display = 'none';
            document.getElementById('sellSelectedItem').style.display = 'block';
            
            // Update item display with GitHub sprite image from inventory
            const iconEl = document.getElementById('sellItemIcon');
            if (spriteUrl) {
                iconEl.innerHTML = `<img src="${spriteUrl}" style="width: 100%; height: 100%; object-fit: contain;">`;
            } else {
                iconEl.textContent = item.icon;
            }
            
            document.getElementById('sellItemName').textContent = itemName; // Show full name with rarity
            document.getElementById('sellItemAvailable').textContent = `Available: ${availableQty}`;
            
            // Enhanced price info with market trends
            let priceInfo = `Guide price: ${guidePrice} gp`;
            if (marketData[itemName]) {
                const data = marketData[itemName];
                const arrow = data.priceChange > 0 ? 'üìà' : data.priceChange < 0 ? 'üìâ' : '‚û°Ô∏è';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                priceInfo += ` <span style="color: ${changeColor};">${arrow} ${data.priceChange !== 0 ? data.priceChange.toFixed(1) + '%' : ''}</span>`;
                if (data.totalVolume > 0) {
                    priceInfo += `<br><span style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</span>`;
                }
            }
            document.getElementById('sellItemPriceInfo').innerHTML = priceInfo;

            document.getElementById('sellItemSearch').value = itemName;
            document.getElementById('sellPrice').value = guidePrice;
            document.getElementById('sellQuantity').max = availableQty;
            document.getElementById('sellQuantity').value = 1;
            document.getElementById('sellGuidePrice').textContent = `Guide price: ${guidePrice} gp`;
            
            document.getElementById('sellPriceGroup').style.display = 'block';
            document.getElementById('sellQuantityGroup').style.display = 'block';
            document.getElementById('sellTotal').style.display = 'block';
            document.getElementById('sellActions').style.display = 'flex';

            updateSellTotal();
        }

        // Update sell total
        function updateSellTotal() {
            const price = parseInt(document.getElementById('sellPrice').value) || 0;
            const quantity = parseInt(document.getElementById('sellQuantity').value) || 0;
            const total = price * quantity;
            const afterTax = Math.floor(total * 0.99);
            document.getElementById('sellTotalAmount').textContent = afterTax.toLocaleString();
        }

        // Confirm sell offer
        async function confirmSellOffer() {
            console.log('confirmSellOffer called:', { selectedSlot, selectedGEItem, selectedGEItemFullName });
            if (!selectedSlot || !selectedGEItem) return;

            const price = parseInt(document.getElementById('sellPrice').value);
            const quantity = parseInt(document.getElementById('sellQuantity').value);

            if (price <= 0 || quantity <= 0) {
                showFloatingText('Invalid price or quantity', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Remove items from inventory using full name (includes rarity)
            const itemIndex = gameState.player.inventory.findIndex(item => 
                item && item.name === selectedGEItemFullName
            );

            if (itemIndex === -1 || gameState.player.inventory[itemIndex].quantity < quantity) {
                showFloatingText('Not enough items!', canvas.width / 2, 100, '#ff4444');
                return;
            }

            gameState.player.inventory[itemIndex].quantity -= quantity;
            if (gameState.player.inventory[itemIndex].quantity <= 0) {
                gameState.player.inventory[itemIndex] = null;
            }

            console.log('Creating sell offer with itemName:', selectedGEItem);
            const offer = {
                itemName: selectedGEItem,
                pricePerItem: price,
                quantity: quantity,
                quantityFilled: 0,
                type: 'sell',
                playerId: currentUser.uid,
                playerName: currentUser.email ? currentUser.email.split('@')[0] : 'Player',
                timestamp: Date.now(),
                status: 'active',
                collectedGold: 0
            };
            console.log('Created offer object:', offer);

            // Ensure playerOffers has both buy and sell arrays
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];
            
            playerOffers.sell[selectedSlot.index] = offer;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            const offerRef = database.ref('grandExchange/activeOffers/sell').push();
            await offerRef.set({
                ...offer,
                offerId: offerRef.key,
                slotIndex: selectedSlot.index
            });

            // Update UI immediately
            updateOfferSlots();
            updateInventoryDisplay();
            
            resetSellForm();
            showFloatingText('Sell offer created!', canvas.width / 2, 100, '#00ff00');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Reset sell form
        function resetSellForm() {
            document.getElementById('sellItemSearch').value = '';
            document.getElementById('sellItemResults').innerHTML = '';
            document.getElementById('sellSearchGroup').style.display = 'block';
            document.getElementById('sellSelectedItem').style.display = 'none';
            document.getElementById('sellPriceGroup').style.display = 'none';
            document.getElementById('sellQuantityGroup').style.display = 'none';
            document.getElementById('sellTotal').style.display = 'none';
            document.getElementById('sellActions').style.display = 'none';
            selectedGEItem = null;
            selectedGEItemMaxQty = 0;
            selectedGEItemFullName = null;
        }

        // Display offer status
        function displayOfferStatus(offer, type, index) {
            const statusDiv = document.getElementById('offerStatus');
            const percentage = (offer.quantityFilled / offer.quantity * 100).toFixed(0);
            
            // BACKWARDS COMPATIBILITY: Handle old format
            let displayItemName = offer.itemName;
            if (!TRADEABLE_ITEMS[offer.itemName]) {
                const oldFormatMatch = offer.itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                if (oldFormatMatch) {
                    const [, baseName, tier] = oldFormatMatch;
                    displayItemName = `T${tier} Common ${baseName}`;
                }
            }
            
            statusDiv.innerHTML = `
                <div class="ge-status-row">
                    <span class="ge-status-label">Item:</span>
                    <span class="ge-status-value">${displayItemName}</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Type:</span>
                    <span class="ge-status-value">${type === 'buy' ? 'üîΩ Buying' : 'üîº Selling'}</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Price per item:</span>
                    <span class="ge-status-value">${offer.pricePerItem} gp</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Progress:</span>
                    <span class="ge-status-value">${offer.quantityFilled} / ${offer.quantity}</span>
                </div>
                <div class="ge-progress-bar">
                    <div class="ge-progress-fill" style="width: ${percentage}%"></div>
                    <div class="ge-progress-text">${percentage}%</div>
                </div>
            `;

            if (offer.quantityFilled >= offer.quantity) {
                document.getElementById('collectOffer').style.display = 'block';
            } else {
                document.getElementById('collectOffer').style.display = 'none';
            }
        }

        // Handle cancel offer
        async function handleCancelOffer() {
            if (!selectedSlot) return;

            const { type, index } = selectedSlot;
            const offer = playerOffers[type][index];

            if (!offer) return;

            if (!confirm('Cancel this offer? Partial fills will be returned.')) return;

            // Return items/gold for partial fills
            if (type === 'buy') {
                const unfilled = offer.quantity - offer.quantityFilled;
                const goldToReturn = unfilled * offer.pricePerItem;
                gameState.player.gold += goldToReturn;
                
                // Return filled items if any
                if (offer.quantityFilled > 0) {
                    // BACKWARDS COMPATIBILITY: Convert old format to new
                    let itemName = offer.itemName;
                    if (!TRADEABLE_ITEMS[itemName]) {
                        const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                        if (oldFormatMatch) {
                            const [, baseName, tier] = oldFormatMatch;
                            itemName = `T${tier} Common ${baseName}`;
                        }
                    }
                    
                    const itemData = TRADEABLE_ITEMS[itemName];
                    if (!itemData) {
                        console.error('Cannot return items: item not found', { itemName, offer });
                        showFloatingText('Error returning items!', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    
                    const itemToAdd = {
                        name: itemName,
                        tier: itemData.tier,
                        rarity: itemData.rarity,
                        rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                        icon: itemData.icon,
                        stackable: true,
                        type: 'resource'
                    };
                    
                    for (let i = 0; i < offer.quantityFilled; i++) {
                        addToInventory(itemToAdd);
                    }
                }
            } else {
                // Return unsold items
                const unsold = offer.quantity - offer.quantityFilled;
                if (unsold > 0) {
                    // BACKWARDS COMPATIBILITY: Convert old format to new
                    let itemName = offer.itemName;
                    if (!TRADEABLE_ITEMS[itemName]) {
                        const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                        if (oldFormatMatch) {
                            const [, baseName, tier] = oldFormatMatch;
                            itemName = `T${tier} Common ${baseName}`;
                        }
                    }
                    
                    const itemData = TRADEABLE_ITEMS[itemName];
                    if (!itemData) {
                        console.error('Cannot return items: item not found', { itemName, offer });
                        showFloatingText('Error returning items!', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    
                    const itemToAdd = {
                        name: itemName,
                        tier: itemData.tier,
                        rarity: itemData.rarity,
                        rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                        icon: itemData.icon,
                        stackable: true,
                        type: 'resource'
                    };
                    
                    for (let i = 0; i < unsold; i++) {
                        addToInventory(itemToAdd);
                    }
                }
                
                // Return collected gold if any
                if (offer.quantityFilled > 0) {
                    const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                    gameState.player.gold += goldReceived;
                }
            }

            // Remove from active offers
            const activeOffersRef = database.ref(`grandExchange/activeOffers/${type}`);
            const snapshot = await activeOffersRef.once('value');
            snapshot.forEach(child => {
                if (child.val().playerId === currentUser.uid && child.val().slotIndex === index) {
                    child.ref.remove();
                }
            });

            playerOffers[type][index] = null;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            updateOfferSlots();
            updateInventoryDisplay();
            
            showFloatingText('Offer cancelled', canvas.width / 2, 100, '#ffaa66');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Handle collect offer
        async function handleCollectOffer() {
            if (!selectedSlot) return;

            const { type, index } = selectedSlot;
            const offer = playerOffers[type][index];

            if (!offer || offer.quantityFilled < offer.quantity) return;

            if (type === 'buy') {
                // BACKWARDS COMPATIBILITY: Convert old format to new
                let itemName = offer.itemName;
                if (!TRADEABLE_ITEMS[itemName]) {
                    const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                    if (oldFormatMatch) {
                        const [, baseName, tier] = oldFormatMatch;
                        itemName = `T${tier} Common ${baseName}`;
                    }
                }
                
                // Add items to inventory - itemName now includes full rarity info
                const itemData = TRADEABLE_ITEMS[itemName];
                
                if (!itemData) {
                    console.error('Cannot collect: item not found in TRADEABLE_ITEMS', { itemName, offer });
                    showFloatingText('Error collecting items!', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                // Create item with the exact name from the offer
                const itemToAdd = {
                    name: itemName,
                    tier: itemData.tier,
                    rarity: itemData.rarity,
                    rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                    icon: itemData.icon,
                    stackable: true,
                    type: 'resource'
                };
                
                // Add all collected items
                for (let i = 0; i < offer.quantityFilled; i++) {
                    addToInventory(itemToAdd);
                }
                
                showFloatingText(`Collected ${offer.quantityFilled}x ${itemName}!`, canvas.width / 2, 100, '#FFD700');
            } else {
                // Add gold
                const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                gameState.player.gold += goldReceived;
                showFloatingText(`Collected ${goldReceived} gold!`, canvas.width / 2, 100, '#FFD700');
            }

            // Clear the offer
            playerOffers[type][index] = null;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Collect all completed offers
        async function collectAllOffers() {
            let totalGold = 0;
            let totalItems = 0;
            let offersCleared = false;

            // Check all buy and sell offers
            for (let type of ['buy', 'sell']) {
                for (let index = 0; index < playerOffers[type].length; index++) {
                    const offer = playerOffers[type][index];
                    
                    // Only collect completed offers
                    if (offer && offer.quantityFilled >= offer.quantity) {
                        offersCleared = true;
                        
                        if (type === 'buy') {
                            // BACKWARDS COMPATIBILITY: Convert old format to new
                            let itemName = offer.itemName;
                            if (!TRADEABLE_ITEMS[itemName]) {
                                const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                                if (oldFormatMatch) {
                                    const [, baseName, tier] = oldFormatMatch;
                                    itemName = `T${tier} Common ${baseName}`;
                                }
                            }
                            
                            // Add items to inventory - itemName now includes full rarity info
                            const itemData = TRADEABLE_ITEMS[itemName];
                            
                            if (itemData) {
                                const itemToAdd = {
                                    name: itemName,
                                    tier: itemData.tier,
                                    rarity: itemData.rarity,
                                    rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                                    icon: itemData.icon,
                                    stackable: true,
                                    type: 'resource'
                                };
                                
                                for (let i = 0; i < offer.quantityFilled; i++) {
                                    addToInventory(itemToAdd);
                                }
                                
                                totalItems += offer.quantityFilled;
                            } else {
                                console.error('collectAllOffers: Item not found', { itemName, offer });
                            }
                        } else {
                            // Add gold
                            const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                            gameState.player.gold += goldReceived;
                            totalGold += goldReceived;
                        }
                        
                        // Clear the offer
                        playerOffers[type][index] = null;
                    }
                }
            }

            if (offersCleared) {
                // Save to Firebase
                await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);
                
                // Update UI
                updateOfferSlots();
                updateInventoryDisplay();
                
                // Show summary message
                let message = 'Collected: ';
                if (totalItems > 0) message += `${totalItems} items`;
                if (totalGold > 0 && totalItems > 0) message += ' + ';
                if (totalGold > 0) message += `${totalGold} gold`;
                
                showFloatingText(message, canvas.width / 2, 100, '#FFD700');
            } else {
                showFloatingText('No completed offers to collect', canvas.width / 2, 100, '#ff9933');
            }
        }

        // Start automatic matching system
        function startOfferMatching() {
            database.ref('grandExchange/activeOffers/buy').on('child_added', matchBuyOffer);
            database.ref('grandExchange/activeOffers/sell').on('child_added', matchSellOffer);
        }

        // Match buy offers
        async function matchBuyOffer(buySnapshot) {
            const buyOffer = buySnapshot.val();
            
            if (buyOffer.quantityFilled >= buyOffer.quantity) return;

            const sellOffersRef = database.ref('grandExchange/activeOffers/sell');
            const sellSnapshot = await sellOffersRef.orderByChild('itemName').equalTo(buyOffer.itemName).once('value');

            const sellOffers = [];
            sellSnapshot.forEach((sellSnap) => {
                sellOffers.push({ snap: sellSnap, offer: sellSnap.val() });
            });

            // Sort by price (lowest first) for fair matching
            sellOffers.sort((a, b) => a.offer.pricePerItem - b.offer.pricePerItem);

            for (const { snap: sellSnap, offer: sellOffer } of sellOffers) {
                // Check if buy offer is already filled
                if (buyOffer.quantityFilled >= buyOffer.quantity) break;
                
                if (sellOffer.pricePerItem <= buyOffer.pricePerItem && 
                    sellOffer.quantityFilled < sellOffer.quantity) {
                    
                    const buyerNeed = buyOffer.quantity - buyOffer.quantityFilled;
                    const sellerHas = sellOffer.quantity - sellOffer.quantityFilled;
                    const tradeQty = Math.min(buyerNeed, sellerHas);

                    await executeTrade(buyOffer, sellOffer, tradeQty, buySnapshot.key, sellSnap.key);
                }
            }
        }

        // Match sell offers
        async function matchSellOffer(sellSnapshot) {
            const sellOffer = sellSnapshot.val();
            
            if (sellOffer.quantityFilled >= sellOffer.quantity) return;

            const buyOffersRef = database.ref('grandExchange/activeOffers/buy');
            const buySnapshot = await buyOffersRef.orderByChild('itemName').equalTo(sellOffer.itemName).once('value');

            const buyOffers = [];
            buySnapshot.forEach((buySnap) => {
                buyOffers.push({ snap: buySnap, offer: buySnap.val() });
            });

            // Sort by price (highest first) for fair matching
            buyOffers.sort((a, b) => b.offer.pricePerItem - a.offer.pricePerItem);

            for (const { snap: buySnap, offer: buyOffer } of buyOffers) {
                // Check if sell offer is already filled
                if (sellOffer.quantityFilled >= sellOffer.quantity) break;
                
                if (buyOffer.pricePerItem >= sellOffer.pricePerItem && 
                    buyOffer.quantityFilled < buyOffer.quantity) {
                    
                    const buyerNeed = buyOffer.quantity - buyOffer.quantityFilled;
                    const sellerHas = sellOffer.quantity - sellOffer.quantityFilled;
                    const tradeQty = Math.min(buyerNeed, sellerHas);

                    await executeTrade(buyOffer, sellOffer, tradeQty, buySnap.key, sellSnapshot.key);
                }
            }
        }

        // Execute trade
        async function executeTrade(buyOffer, sellOffer, quantity, buyOfferId, sellOfferId) {
            buyOffer.quantityFilled += quantity;
            sellOffer.quantityFilled += quantity;

            const sellerReceives = Math.floor(sellOffer.pricePerItem * quantity * 0.99);

            // Update player offers
            await database.ref(`grandExchange/playerOffers/${buyOffer.playerId}/buy/${buyOffer.slotIndex}`).update({
                quantityFilled: buyOffer.quantityFilled
            });

            await database.ref(`grandExchange/playerOffers/${sellOffer.playerId}/sell/${sellOffer.slotIndex}`).update({
                quantityFilled: sellOffer.quantityFilled,
                collectedGold: firebase.database.ServerValue.increment(sellerReceives)
            });

            // Update active offers
            await database.ref(`grandExchange/activeOffers/buy/${buyOfferId}`).update({
                quantityFilled: buyOffer.quantityFilled
            });

            await database.ref(`grandExchange/activeOffers/sell/${sellOfferId}`).update({
                quantityFilled: sellOffer.quantityFilled
            });

            // Update guide price
            const currentGuide = guidePrices[buyOffer.itemName] || TRADEABLE_ITEMS[buyOffer.itemName].basePrice;
            const transactionPrice = (buyOffer.pricePerItem + sellOffer.pricePerItem) / 2;
            const newGuide = Math.floor((currentGuide * 0.9) + (transactionPrice * 0.1));
            
            await database.ref(`grandExchange/guidePrices/${buyOffer.itemName}`).set(newGuide);

            // Record trade
            await database.ref('grandExchange/tradeHistory').push({
                itemName: buyOffer.itemName,
                quantity: quantity,
                price: transactionPrice,
                buyerId: buyOffer.playerId,
                sellerId: sellOffer.playerId,
                timestamp: Date.now()
            });

            // Remove completed offers
            if (buyOffer.quantityFilled >= buyOffer.quantity) {
                await database.ref(`grandExchange/activeOffers/buy/${buyOfferId}`).remove();
            }
            if (sellOffer.quantityFilled >= sellOffer.quantity) {
                await database.ref(`grandExchange/activeOffers/sell/${sellOfferId}`).remove();
            }
        }

        // MARKET TRENDS & ANALYTICS (OSRS-Style)
        let marketData = {}; // Stores price history and volume for each item
        
        // Smart search function for GE item filtering
        function smartSearchMatch(itemName, searchQuery) {
            if (!searchQuery || searchQuery.trim() === '') return true;
            
            const itemLower = itemName.toLowerCase();
            const searchWords = searchQuery.toLowerCase().trim().split(/\s+/).filter(w => w.length > 0);
            
            // Item must match ALL search words (AND logic)
            return searchWords.every(word => itemLower.includes(word));
        }
        
        // Initialize market data tracking
        function initializeMarketTracking() {
            if (!database) return;
            
            // Listen for trades to track market activity
            database.ref('grandExchange/tradeHistory').limitToLast(50).on('child_added', (snapshot) => {
                const trade = snapshot.val();
                if (!marketData[trade.itemName]) {
                    marketData[trade.itemName] = {
                        prices: [],
                        volumes: [],
                        lastPrice: trade.price,
                        totalVolume: 0,
                        priceChange: 0
                    };
                }
                
                const item = marketData[trade.itemName];
                item.prices.push({ price: trade.price, time: trade.timestamp });
                item.volumes.push(trade.quantity);
                item.totalVolume += trade.quantity;
                
                // Calculate price change
                if (item.prices.length > 1) {
                    const oldPrice = item.prices[item.prices.length - 2].price;
                    item.priceChange = ((trade.price - oldPrice) / oldPrice) * 100;
                }
                
                item.lastPrice = trade.price;
                
                // Keep only last 20 trades per item
                if (item.prices.length > 20) {
                    item.prices.shift();
                    item.volumes.shift();
                }
            });
        }
        
        // Show market trends UI
        function showMarketTrends() {
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            
            const trendsDiv = document.getElementById('marketTrends');
            if (!trendsDiv) {
                // Create the market trends section if it doesn't exist
                createMarketTrendsUI();
            }
            
            updateTrendingItems();
            updateRecentTrades();
            
            const trendsElement = document.getElementById('marketTrends');
            if (trendsElement) {
                trendsElement.style.display = 'block';
            }
        }
        
        // Create market trends UI if not exists
        function createMarketTrendsUI() {
            const emptyState = document.getElementById('emptyState');
            if (!emptyState) return;
            
            const trendsHTML = `
                <div class="ge-details-content" id="marketTrends" style="display: none;">
                    <div class="details-title">üìà Market Activity</div>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(74, 154, 138, 0.1); border-radius: 5px;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 10px; font-size: 14px;">üî• Most Traded Items</div>
                        <div id="trendingItems" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
                    </div>
                    
                    <div style="padding: 10px; background: rgba(90, 138, 250, 0.1); border-radius: 5px;">
                        <div style="color: #5a8afa; font-weight: bold; margin-bottom: 10px; font-size: 14px;">üìä Recent Trades</div>
                        <div id="recentTrades" style="max-height: 250px; overflow-y: auto; font-size: 12px;"></div>
                    </div>
                    
                    <button class="ge-action-btn" onclick="closeMarketTrends()" style="margin-top: 15px; width: 100%;">Close</button>
                </div>
            `;
            
            emptyState.insertAdjacentHTML('afterend', trendsHTML);
        }
        
        // Update trending items display
        function updateTrendingItems() {
            const trendingDiv = document.getElementById('trendingItems');
            if (!trendingDiv) return;
            
            // Sort items by total volume
            const sortedItems = Object.entries(marketData)
                .sort(([, a], [, b]) => b.totalVolume - a.totalVolume)
                .slice(0, 10);
            
            if (sortedItems.length === 0) {
                trendingDiv.innerHTML = '<div style="color: #8a7a6a; padding: 10px; text-align: center;">No market data yet</div>';
                return;
            }
            
            trendingDiv.innerHTML = sortedItems.map(([itemName, data]) => {
                const arrow = data.priceChange > 0 ? 'üìà' : data.priceChange < 0 ? 'üìâ' : '‚û°Ô∏è';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                const changeText = data.priceChange !== 0 ? `${data.priceChange.toFixed(1)}%` : 'Stable';
                
                return `
                    <div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 3px; border-left: 3px solid ${changeColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #cad2da; font-weight: bold;">${itemName}</div>
                                <div style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #FFD700;">${data.lastPrice.toLocaleString()} gp</div>
                                <div style="color: ${changeColor}; font-size: 11px;">${arrow} ${changeText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update recent trades display
        function updateRecentTrades() {
            if (!database) return;
            
            const tradesDiv = document.getElementById('recentTrades');
            if (!tradesDiv) return;
            
            database.ref('grandExchange/tradeHistory').limitToLast(15).once('value', (snapshot) => {
                const trades = [];
                snapshot.forEach(child => trades.push(child.val()));
                trades.reverse(); // Show newest first
                
                if (trades.length === 0) {
                    tradesDiv.innerHTML = '<div style="color: #8a7a6a; padding: 10px; text-align: center;">No recent trades</div>';
                    return;
                }
                
                tradesDiv.innerHTML = trades.map(trade => {
                    const timeAgo = getTimeAgo(trade.timestamp);
                    const total = trade.price * trade.quantity;
                    
                    return `
                        <div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 3px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="color: #5abaaa; font-weight: bold;">${trade.itemName}</span>
                                <span style="color: #8a7a6a; font-size: 11px;">${timeAgo}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px;">
                                <span style="color: #cad2da;">${trade.quantity}x @ ${trade.price.toLocaleString()} gp</span>
                                <span style="color: #FFD700;">Total: ${total.toLocaleString()} gp</span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }
        
        // Helper function to format time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        // Close market trends
        function closeMarketTrends() {
            const trendsDiv = document.getElementById('marketTrends');
            if (trendsDiv) {
                trendsDiv.style.display = 'none';
            }
            document.getElementById('emptyState').classList.add('active');
        }
        
        // MARKET WIKI FUNCTIONS
        let currentWikiFilter = 'rises';
        let currentWikiPeriod = 7;
        
        function openMarketWiki() {
            document.getElementById('marketWikiModal').style.display = 'flex';
            updateWikiTable();
            generateSearchSuggestions();
        }
        
        function closeMarketWiki() {
            document.getElementById('marketWikiModal').style.display = 'none';
            // Clear search when closing
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) searchInput.value = '';
        }
        
        // Generate smart search suggestions based on available items
        function generateSearchSuggestions() {
            const suggestionTags = document.getElementById('suggestionTags');
            if (!suggestionTags) return;
            
            // Extract common keywords from item names
            const keywords = new Set();
            Object.keys(marketData).forEach(itemName => {
                const words = itemName.toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length >= 2) { // Only meaningful words
                        keywords.add(word);
                    }
                });
            });
            
            // Common search terms (always show these)
            const commonTerms = ['t1', 't2', 't3', 'logs', 'ore', 'common', 'uncommon', 'rare', 'epic', 'perfect'];
            const suggestionsSet = new Set([...commonTerms, ...Array.from(keywords).slice(0, 10)]);
            const suggestions = Array.from(suggestionsSet).slice(0, 12);
            
            if (suggestions.length > 0) {
                suggestionTags.innerHTML = suggestions.map(tag => `
                    <button 
                        onclick="applySearchSuggestion('${tag}')" 
                        style="background: #5a4a3a; border: 2px solid #7a6a5a; border-radius: 15px; padding: 6px 12px; color: #d4a76a; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.2s;"
                        onmouseover="this.style.background='#6a5a4a'; this.style.transform='scale(1.05)'"
                        onmouseout="this.style.background='#5a4a3a'; this.style.transform='scale(1)'"
                    >
                        ${tag}
                    </button>
                `).join('');
                document.getElementById('searchSuggestions').style.display = 'block';
            }
        }
        
        // Apply search suggestion when clicked
        function applySearchSuggestion(term) {
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) {
                const currentValue = searchInput.value.trim();
                // Add term to existing search or replace
                searchInput.value = currentValue ? `${currentValue} ${term}` : term;
                filterWikiTable();
                searchInput.focus();
            }
        }
        
        function updateWikiTable() {
            const tbody = document.getElementById('wikiTableBody');
            const resultCount = document.getElementById('wikiResultCount');
            if (!tbody) return;
            
            // Get search query
            const searchInput = document.getElementById('wikiSearchInput');
            const searchQuery = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            // Get all items from marketData
            let items = Object.entries(marketData).map(([name, data]) => {
                // Calculate start and end prices
                const prices = data.prices || [];
                if (prices.length < 2) return null;
                
                const startPrice = prices[0].price;
                const endPrice = prices[prices.length - 1].price;
                const rise = endPrice - startPrice;
                const changePercent = ((rise / startPrice) * 100);
                
                // Check if valuable (change >= 50%)
                const isValuable = Math.abs(changePercent) >= 50;
                
                return {
                    name,
                    startPrice,
                    endPrice,
                    rise,
                    changePercent,
                    isValuable,
                    volume: data.totalVolume || 0
                };
            }).filter(item => item !== null);
            
            // Apply smart search filter
            if (searchQuery) {
                // Split search into words
                const searchWords = searchQuery.split(/\s+/).filter(w => w.length > 0);
                
                items = items.filter(item => {
                    const itemNameLower = item.name.toLowerCase();
                    
                    // Item must match ALL search words (AND logic)
                    return searchWords.every(word => {
                        // Check if item name contains this word
                        return itemNameLower.includes(word);
                    });
                });
                
                // Show clear button
                const clearBtn = document.getElementById('clearSearchBtn');
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                // Hide clear button
                const clearBtn = document.getElementById('clearSearchBtn');
                if (clearBtn) clearBtn.style.display = 'none';
            }
            
            // Apply filters (only if not searching, or combine with search)
            if (currentWikiFilter === 'rises') {
                items = items.filter(item => item.rise > 0).sort((a, b) => b.changePercent - a.changePercent);
            } else if (currentWikiFilter === 'falls') {
                items = items.filter(item => item.rise < 0).sort((a, b) => a.changePercent - b.changePercent);
            } else if (currentWikiFilter === 'valuable') {
                items = items.filter(item => item.isValuable).sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
            } else if (currentWikiFilter === 'most-traded') {
                items = items.sort((a, b) => b.volume - a.volume);
            }
            
            // Update result count
            if (resultCount) {
                resultCount.textContent = items.length;
            }
            
            // Generate table rows
            if (items.length === 0) {
                const noResultsMsg = searchQuery 
                    ? `No items found matching "${searchQuery}". Try different keywords or clear search.`
                    : 'No market data available yet. Start trading items to see price statistics!';
                    
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: #8a7a6a; font-size: 16px;">
                            ${noResultsMsg}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = items.map(item => {
                const changeColor = item.changePercent > 0 ? '#00ff00' : item.changePercent < 0 ? '#ff4444' : '#8a7a6a';
                const arrow = item.changePercent > 0 ? 'üìà' : item.changePercent < 0 ? 'üìâ' : '‚û°Ô∏è';
                const checkmark = item.isValuable ? '‚úì' : '';
                
                return `
                    <tr style="border-bottom: 1px solid #3a2a1a;">
                        <td style="padding: 15px; color: #d4a76a; font-size: 14px; font-weight: bold;">
                            ${item.name}
                        </td>
                        <td style="padding: 15px; text-align: center; color: #FFD700; font-size: 18px;">
                            ${checkmark}
                        </td>
                        <td style="padding: 15px; text-align: right; color: #cad2da; font-size: 14px;">
                            ${item.startPrice.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: #cad2da; font-size: 14px;">
                            ${item.endPrice.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: ${changeColor}; font-size: 14px; font-weight: bold;">
                            ${item.rise > 0 ? '+' : ''}${item.rise.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: ${changeColor}; font-size: 14px; font-weight: bold;">
                            ${arrow} ${item.changePercent > 0 ? '+' : ''}${item.changePercent.toFixed(0)}%
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Smart filter function for wiki table
        function filterWikiTable() {
            updateWikiTable();
        }
        
        // Clear search function
        function clearWikiSearch() {
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterWikiTable();
            }
        }
        
        // Set up wiki filter buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Filter buttons
            document.querySelectorAll('.wiki-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.wiki-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentWikiFilter = btn.dataset.filter;
                    updateWikiTable();
                });
            });
            
            // Period buttons
            document.querySelectorAll('.wiki-period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.wiki-period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentWikiPeriod = parseInt(btn.dataset.period);
                    updateWikiTable();
                });
            });
        });
        
        // Enhanced item display with price history
        function showItemPriceHistory(itemName) {
            const data = marketData[itemName];
            if (!data || data.prices.length < 2) {
                return 'No price history available';
            }
            
            const minPrice = Math.min(...data.prices.map(p => p.price));
            const maxPrice = Math.max(...data.prices.map(p => p.price));
            const avgPrice = data.prices.reduce((sum, p) => sum + p.price, 0) / data.prices.length;
            
            return `
                <div style="font-size: 11px; color: #8a7a6a; margin-top: 5px;">
                    Avg: ${Math.floor(avgPrice)} gp | Min: ${minPrice} gp | Max: ${maxPrice} gp
                </div>
            `;
        }


        // Load sprites - extend existing spriteUrls with additional variants
        Object.assign(spriteUrls, {
            ore_uncommon_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/uncommon%20t1%20ore.png',
            ore_rare_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/rare%20tier%201.png',
            ore_epic_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/epic%20tier%201.png',
            ore_perfect_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/perfect%20tier%201.png',
            // Add more tier sprites as they become available
        });
        
        // Tilemap data from exported JSON
        const mapData = {"tileSize":16,"mapWidth":55,"mapHeight":45,"layers":[{"name":"Layer_1","tiles":[{"id":"0","x":23,"y":23},{"id":"1","x":24,"y":23},{"id":"2","x":25,"y":23},{"id":"3","x":26,"y":23},{"id":"4","x":23,"y":24},{"id":"5","x":24,"y":24},{"id":"6","x":25,"y":24},{"id":"7","x":26,"y":24},{"id":"8","x":23,"y":25},{"id":"9","x":24,"y":25},{"id":"10","x":25,"y":25},{"id":"11","x":26,"y":25},{"id":"12","x":23,"y":26},{"id":"13","x":24,"y":26},{"id":"14","x":25,"y":26},{"id":"15","x":26,"y":26},{"id":"16","x":23,"y":27},{"id":"17","x":24,"y":27},{"id":"18","x":25,"y":27},{"id":"19","x":26,"y":27}],"collider":false}]}; // Truncated for brevity
        
        // Tile type definitions - map tile IDs to types
        const tileTypes = {
            // Trees (0-19 appear to be tree tiles in 4x5 blocks)
            trees: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
            // Stone borders (20-35 appear to be stone tiles)
            stones: [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35],
            // Grass/ground (36 and others)
            grass: [36],
            // Border/edge tiles
            borders: [60, 61, 62, 63, 64, 65, 66, 67]
        };
        
        // Tilemap data - will be loaded from JSON
        let tilemapData = null;
        
        // Load the tilemap JSON
        async function loadTilemap() {
            try {
                // Using embedded data instead of fetch for simplicity
                tilemapData = {
                    tileSize: 16,
                    mapWidth: 55,
                    mapHeight: 45,
                    layers: [{
                        name: "Layer_1",
                        tiles: [] // Simplified - would contain full tile data
                    }]
                };
                console.log('Tilemap data initialized');
            } catch (error) {
                console.log('Tilemap loading failed, using procedural generation');
            }
        }
        
        // Extract tree positions from tilemap for interactions
        function extractTreesFromTilemap() {
            // Pre-calculated tree positions from the tilemap
            // These are the 6 trees found in the map
            const treePositions = [
                { x: 800, y: 816 },   // Tree at grid (23, 23)
                { x: 320, y: 1104 },  // Tree at grid (8, 32)
                { x: 1472, y: 1104 }, // Tree at grid (44, 32)
                { x: 1440, y: 208 },  // Tree at grid (43, 4)
                { x: 1248, y: 592 },  // Tree at grid (37, 16)
                { x: 448, y: 528 }    // Tree at grid (12, 14)
            ];
            
            // Convert to tree objects with variants
            const treeObjects = treePositions.map(pos => ({
                type: 'tree',
                x: pos.x,
                y: pos.y,
                variant: ['oak', 'maple', 'birch'][Math.floor(Math.random() * 3)]
            }));
            
            // Return tree objects instead of directly updating rooms
            return treeObjects;
        }
        
        // Render tilemap background
        function drawTilemap() {
            if (!tilemapData || !rooms || !rooms[gameState.currentRoom] || !rooms[gameState.currentRoom].usesTilemap) {
                drawTiles(); // Use original tile system
                return;
            }
            
            const layer = tilemapData.layers[0];
            const scaleFactor = 2; // Scale up the 16x16 tiles
            
            // Create a map for quick tile lookup
            const tileMap = new Map();
            layer.tiles.forEach(tile => {
                const key = `${tile.x},${tile.y}`;
                tileMap.set(key, tile.id);
            });
            
            // Draw all tiles
            for (let y = 0; y < tilemapData.mapHeight; y++) {
                for (let x = 0; x < tilemapData.mapWidth; x++) {
                    const key = `${x},${y}`;
                    const tileId = tileMap.get(key);
                    
                    const drawX = x * tilemapData.tileSize * scaleFactor - gameState.camera.x;
                    const drawY = y * tilemapData.tileSize * scaleFactor - gameState.camera.y;
                    
                    // Skip if outside viewport
                    if (drawX < -32 || drawX > canvas.width || drawY < -32 || drawY > canvas.height) {
                        continue;
                    }
                    
                    // Draw based on tile ID
                    if (tileId !== undefined) {
                        drawTileById(parseInt(tileId), drawX, drawY, scaleFactor);
                    } else {
                        // Draw default grass
                        ctx.fillStyle = '#4a6a5a';
                        ctx.fillRect(drawX, drawY, tilemapData.tileSize * scaleFactor, tilemapData.tileSize * scaleFactor);
                    }
                }
            }
        }
        
        // Draw individual tile based on its ID
        function drawTileById(id, x, y, scale) {
            const size = tilemapData.tileSize * scale;
            
            if (id >= 0 && id <= 19) {
                // Tree tiles - draw as brown/green
                const treeColors = ['#228B22', '#32CD32', '#2E8B57', '#3CB371'];
                ctx.fillStyle = treeColors[id % 4];
                ctx.fillRect(x, y, size, size);
                
                // Add some texture
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fillRect(x + 2, y + 2, size - 4, size - 4);
            } else if (id >= 20 && id <= 35) {
                // Stone border tiles
                ctx.fillStyle = '#8B7D6B';
                ctx.fillRect(x, y, size, size);
                
                // Stone texture
                ctx.fillStyle = '#A0826D';
                ctx.fillRect(x + 4, y + 4, size - 8, size - 8);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + 1, y + 1, size - 2, size - 2);
            } else if (id === 36) {
                // Grass tile
                ctx.fillStyle = '#4a6a5a';
                ctx.fillRect(x, y, size, size);
                
                // Grass texture
                for (let i = 0; i < 3; i++) {
                    ctx.strokeStyle = `rgba(0,0,0,${0.05 + i * 0.02})`;
                    ctx.beginPath();
                    ctx.moveTo(x + Math.random() * size, y + size);
                    ctx.lineTo(x + Math.random() * size, y + size - 5);
                    ctx.stroke();
                }
            } else if (id >= 60 && id <= 67) {
                // Border/edge tiles
                ctx.fillStyle = '#2a3a2a';
                ctx.fillRect(x, y, size, size);
            } else {
                // Default tile
                ctx.fillStyle = '#3a5a4a';
                ctx.fillRect(x, y, size, size);
            }
        }
        
        // Initialize tilemap loading
        loadTilemap();
        
        // Resource tier definitions with level requirements
        const resourceRarities = {
            common: { name: 'Common', multiplier: 1, color: '#8a8a8a', chance: 0.5 },
            uncommon: { name: 'Uncommon', multiplier: 1.2, color: '#5abaaa', chance: 0.3 },
            rare: { name: 'Rare', multiplier: 1.5, color: '#5a8afa', chance: 0.15 },
            epic: { name: 'Epic', multiplier: 2, color: '#aa5afa', chance: 0.04 },
            perfect: { name: 'Perfect', multiplier: 3, color: '#fa5a5a', chance: 0.01 }
        };
        
        const resourceTiers = {
            woodcutting: [
                { name: 'Logs', tier: 1, baseIcon: 'log', levelReq: 1, exp: 10 },
                { name: 'Logs', tier: 2, baseIcon: 'log', levelReq: 20, exp: 25 },
                { name: 'Logs', tier: 3, baseIcon: 'log', levelReq: 40, exp: 50 },
                { name: 'Logs', tier: 4, baseIcon: 'log', levelReq: 60, exp: 75 },
                { name: 'Logs', tier: 5, baseIcon: 'log', levelReq: 80, exp: 100 }
            ],
            mining: [
                { name: 'Ore', tier: 1, baseIcon: 'ore', levelReq: 1, exp: 10 },
                { name: 'Ore', tier: 2, baseIcon: 'ore', levelReq: 20, exp: 25 },
                { name: 'Ore', tier: 3, baseIcon: 'ore', levelReq: 40, exp: 50 },
                { name: 'Ore', tier: 4, baseIcon: 'ore', levelReq: 60, exp: 75 },
                { name: 'Ore', tier: 5, baseIcon: 'ore', levelReq: 80, exp: 100 }
            ],
            fishing: [
                { name: 'Fish', tier: 1, baseIcon: 'fish', levelReq: 1, exp: 10 },
                { name: 'Fish', tier: 2, baseIcon: 'fish', levelReq: 20, exp: 25 },
                { name: 'Fish', tier: 3, baseIcon: 'fish', levelReq: 40, exp: 50 },
                { name: 'Fish', tier: 4, baseIcon: 'fish', levelReq: 60, exp: 75 },
                { name: 'Fish', tier: 5, baseIcon: 'fish', levelReq: 80, exp: 100 }
            ],
            farming: [
                { name: 'Herb', tier: 1, baseIcon: 'herb', levelReq: 1, exp: 10 },
                { name: 'Herb', tier: 2, baseIcon: 'herb', levelReq: 20, exp: 25 },
                { name: 'Herb', tier: 3, baseIcon: 'herb', levelReq: 40, exp: 50 },
                { name: 'Herb', tier: 4, baseIcon: 'herb', levelReq: 60, exp: 75 },
                { name: 'Herb', tier: 5, baseIcon: 'herb', levelReq: 80, exp: 100 }
            ],
            agility: [
                { name: 'Lap', tier: 1, baseIcon: 'ticket', levelReq: 1, exp: 10 },
                { name: 'Lap', tier: 2, baseIcon: 'ticket', levelReq: 20, exp: 25 },
                { name: 'Lap', tier: 3, baseIcon: 'ticket', levelReq: 40, exp: 50 },
                { name: 'Lap', tier: 4, baseIcon: 'ticket', levelReq: 60, exp: 75 },
                { name: 'Lap', tier: 5, baseIcon: 'ticket', levelReq: 80, exp: 100 }
            ]
        };
        
        // Get rarity for a resource
        function getRarity() {
            const roll = Math.random();
            let cumulative = 0;
            
            for (const [key, rarity] of Object.entries(resourceRarities)) {
                cumulative += rarity.chance;
                if (roll <= cumulative) {
                    return { key, ...rarity };
                }
            }
            
            return { key: 'common', ...resourceRarities.common };
        }
        
        // Get icon name based on resource, tier, and rarity
        function getResourceIcon(baseIcon, tier, rarity) {
            // Special case for tier 1 logs with sprite variants
            if (baseIcon === 'log' && tier === 1) {
                if (rarity === 'uncommon') return 'log_uncommon_t1';
                if (rarity === 'rare') return 'log_rare_t1';
                if (rarity === 'epic') return 'log_epic_t1';
                if (rarity === 'perfect') return 'log_perfect_t1';
            }
            // Special case for tier 1 ores with sprite variants
            if (baseIcon === 'ore' && tier === 1) {
                if (rarity === 'uncommon') return 'ore_uncommon_t1';
                if (rarity === 'rare') return 'ore_rare_t1';
                if (rarity === 'epic') return 'ore_epic_t1';
                if (rarity === 'perfect') return 'ore_perfect_t1';
            }
            // Default to base icon for common or unavailable sprites
            return baseIcon;
        }
        
        // Get available tier based on skill level
        function getAvailableTier(skill, skillLevel) {
            const tiers = resourceTiers[skill];
            if (!tiers) return null;
            
            // Filter to only tiers the player can gather at their level
            const availableTiers = tiers.filter(t => skillLevel >= t.levelReq);
            if (availableTiers.length === 0) return null;
            
            // Calculate chances based on available tiers
            // Higher tiers are rarer, but become more common as you level up
            const maxTier = availableTiers[availableTiers.length - 1].tier;
            const weights = availableTiers.map(t => {
                // Base weight decreases for higher tiers
                let weight = Math.pow(0.5, t.tier - 1);
                // Boost weight if player is significantly over-leveled for this tier
                if (skillLevel > t.levelReq + 20) {
                    weight *= 0.5; // Make lower tiers less common when over-leveled
                }
                return weight;
            });
            
            // Normalize weights
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            const normalizedWeights = weights.map(w => w / totalWeight);
            
            // Roll for tier
            const roll = Math.random();
            let cumulative = 0;
            
            for (let i = 0; i < availableTiers.length; i++) {
                cumulative += normalizedWeights[i];
                if (roll <= cumulative) {
                    return availableTiers[i];
                }
            }
            
            // Fallback to highest available
            return availableTiers[availableTiers.length - 1];
        }

        // Load sprite images
        Object.keys(spriteUrls).forEach(key => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = spriteUrls[key];
            img.onload = () => {
                gameState.sprites[key] = img;
                if (gameState.inventoryOpen) {
                    updateInventoryDisplay();
                }
            };
            img.onerror = () => {
                console.error(`Failed to load sprite: ${key}`);
            };
        });

        // Room Configurations with better graphics
        const rooms = {
            woodcutting: {
                name: 'Woodcutting Area',
                groundTiles: ['#4a6a5a', '#3a5a4a', '#5a7a6a'],
                pathTiles: ['#8a7a6a', '#7a6a5a'],
                decorations: ['grass', 'rock', 'flower'],
                objects: [] // Will be populated dynamically
            },
            fishing: {
                name: 'Fishing Spot',
                groundTiles: ['#3a5a6a', '#2a4a5a', '#4a6a7a'],
                pathTiles: ['#6a5a4a', '#5a4a3a'],
                decorations: ['rock', 'reed'],
                objects: [] // Will be populated dynamically
            },
            mining: {
                name: 'Mine',
                groundTiles: ['#3a3a4a', '#2a2a3a', '#4a4a5a'],
                pathTiles: ['#5a5a6a', '#4a4a5a'],
                decorations: ['rock', 'crystal'],
                objects: [] // Will be populated dynamically
            },
            combat: {
                name: 'Combat Training (Auto)', // Auto/idle combat area
                groundTiles: ['#5a4a4a', '#4a3a3a', '#6a5a5a'],
                pathTiles: ['#7a6a6a', '#6a5a5a'],
                decorations: ['weapon_rack', 'banner'],
                objects: [] // Will be populated dynamically
            },
            cooking: {
                name: 'Cooking Area',
                groundTiles: ['#6a5a4a', '#5a4a3a', '#7a6a5a'],
                pathTiles: ['#8a7a6a', '#7a6a5a'],
                decorations: ['barrel', 'crate'],
                objects: [] // Will be populated dynamically
            },
            raids: {
                name: 'Boss Arena (Manual)', // Manual combat bossing area
                groundTiles: ['#4a3a3a', '#3a2a2a', '#5a4a4a'],
                pathTiles: ['#6a5a5a', '#5a4a4a'],
                decorations: ['skull', 'torch'],
                objects: [] // Will be populated dynamically
            },

            crafting: {
                name: 'Crafting Workshop',
                groundTiles: ['#5a4a3a', '#4a3a2a', '#6a5a4a'],
                pathTiles: ['#7a6a5a', '#6a5a4a'],
                decorations: ['tools', 'blueprint'],
                objects: [] // Will be populated dynamically
            },
            farming: {
                name: 'Farming Area',
                groundTiles: ['#4a5a3a', '#3a4a2a', '#5a6a4a'],
                pathTiles: ['#7a6a5a', '#6a5a4a'],
                decorations: ['grass', 'flower'],
                objects: [] // Will be populated dynamically
            },
            agility: {
                name: 'Agility Course',
                groundTiles: ['#5a5a4a', '#4a4a3a', '#6a6a5a'],
                pathTiles: ['#7a7a6a', '#6a6a5a'],
                decorations: ['marker', 'flag'],
                objects: [] // Will be populated dynamically
            }

        };
        
        // Initialize objects for each room based on canvas size
        function initializeRoomObjects() {
            const w = canvas.width;
            const h = canvas.height;
            const margin = 150; // Keep objects away from edges
            
            // Woodcutting - spread trees across the area
            rooms.woodcutting.objects = [
                { type: 'tree', x: w * 0.2, y: h * 0.3, variant: 'oak' },
                { type: 'tree', x: w * 0.4, y: h * 0.25, variant: 'maple' },
                { type: 'tree', x: w * 0.6, y: h * 0.4, variant: 'birch' },
                { type: 'tree', x: w * 0.75, y: h * 0.35, variant: 'oak' },
                { type: 'tree', x: w * 0.3, y: h * 0.6, variant: 'maple' },
                { type: 'tree', x: w * 0.65, y: h * 0.65, variant: 'birch' },
                { type: 'tree', x: w * 0.45, y: h * 0.5, variant: 'oak' },
                { type: 'tree', x: w * 0.8, y: h * 0.6, variant: 'maple' }
            ];
            
            // Fishing - pond in center with spots around it
            const pondW = w * 0.3;
            const pondH = h * 0.25;
            rooms.fishing.objects = [
                { type: 'pond', x: w * 0.5, y: h * 0.45, width: pondW, height: pondH },
                { type: 'fishingSpot', x: w * 0.4, y: h * 0.4 },
                { type: 'fishingSpot', x: w * 0.6, y: h * 0.4 },
                { type: 'fishingSpot', x: w * 0.5, y: h * 0.6 }
            ];
            
            // Mining - rocks spread around
            rooms.mining.objects = [
                { type: 'ore', x: w * 0.25, y: h * 0.3, variant: 'copper' },
                { type: 'ore', x: w * 0.5, y: h * 0.25, variant: 'iron' },
                { type: 'ore', x: w * 0.35, y: h * 0.5, variant: 'silver' },
                { type: 'ore', x: w * 0.65, y: h * 0.4, variant: 'gold' },
                { type: 'ore', x: w * 0.75, y: h * 0.6, variant: 'iron' },
                { type: 'ore', x: w * 0.45, y: h * 0.65, variant: 'copper' }
            ];
            
            // Combat - dummies in a line
            rooms.combat.objects = [
                { type: 'dummy', x: w * 0.3, y: h * 0.4 },
                { type: 'dummy', x: w * 0.5, y: h * 0.4 },
                { type: 'dummy', x: w * 0.7, y: h * 0.4 },
                { type: 'dummy', x: w * 0.4, y: h * 0.6 },
                { type: 'dummy', x: w * 0.6, y: h * 0.6 }
            ];
            
            // Cooking
            rooms.cooking.objects = [
                { type: 'stove', x: w * 0.3, y: h * 0.35 },
                { type: 'stove', x: w * 0.5, y: h * 0.35 },
                { type: 'stove', x: w * 0.7, y: h * 0.35 },
                { type: 'table', x: w * 0.5, y: h * 0.6 }
            ];
            
            // Raids
            rooms.raids.objects = [
                { type: 'chest', x: w * 0.3, y: h * 0.3 },
                { type: 'chest', x: w * 0.7, y: h * 0.3 },
                { type: 'chest', x: w * 0.5, y: h * 0.25 },
                { type: 'boss', x: w * 0.5, y: h * 0.6 }
            ];
            
            // Crafting
            rooms.crafting.objects = [
                { type: 'workbench', x: w * 0.3, y: h * 0.35 },
                { type: 'anvil', x: w * 0.55, y: h * 0.35 },
                { type: 'forge', x: w * 0.7, y: h * 0.35 }
            ];
            
            // Farming - crops in rows
            rooms.farming.objects = [
                { type: 'crop', x: w * 0.25, y: h * 0.3 },
                { type: 'crop', x: w * 0.35, y: h * 0.3 },
                { type: 'crop', x: w * 0.45, y: h * 0.3 },
                { type: 'crop', x: w * 0.55, y: h * 0.3 },
                { type: 'crop', x: w * 0.65, y: h * 0.3 },
                { type: 'crop', x: w * 0.3, y: h * 0.5 },
                { type: 'crop', x: w * 0.4, y: h * 0.5 },
                { type: 'crop', x: w * 0.5, y: h * 0.5 },
                { type: 'crop', x: w * 0.6, y: h * 0.5 }
            ];
            
            // Agility - obstacles in a course
            rooms.agility.objects = [
                { type: 'obstacle', x: w * 0.25, y: h * 0.3 },
                { type: 'obstacle', x: w * 0.5, y: h * 0.25 },
                { type: 'obstacle', x: w * 0.7, y: h * 0.35 },
                { type: 'obstacle', x: w * 0.65, y: h * 0.6 },
                { type: 'obstacle', x: w * 0.35, y: h * 0.65 }
            ];
        }

        // Initialize tiles for better graphics
        function generateTiles() {
            const room = rooms[gameState.currentRoom];
            gameState.tiles = [];
            const tileSize = 50;
            
            for (let x = 0; x < canvas.width + tileSize; x += tileSize) {
                for (let y = 0; y < canvas.height + tileSize; y += tileSize) {
                    const tileType = Math.random() > 0.8 ? 'path' : 'ground';
                    const tiles = tileType === 'path' ? room.pathTiles : room.groundTiles;
                    const color = tiles[Math.floor(Math.random() * tiles.length)];
                    
                    gameState.tiles.push({
                        x, y,
                        size: tileSize,
                        color,
                        type: tileType
                    });
                }
            }
        }

        // Draw functions with better graphics
        function drawTiles() {
            gameState.tiles.forEach(tile => {
                // Main tile
                ctx.fillStyle = tile.color;
                ctx.fillRect(tile.x - gameState.camera.x, tile.y - gameState.camera.y, tile.size, tile.size);
                
                // Add subtle grid lines
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1;
                ctx.strokeRect(tile.x - gameState.camera.x, tile.y - gameState.camera.y, tile.size, tile.size);
                
                // Add texture
                if (tile.type === 'path') {
                    ctx.fillStyle = 'rgba(0,0,0,0.1)';
                    ctx.fillRect(
                        tile.x - gameState.camera.x + 5, 
                        tile.y - gameState.camera.y + 5, 
                        tile.size - 10, 
                        tile.size - 10
                    );
                }
            });
        }

        function drawTree(x, y, variant) {
            const colors = {
                oak: { trunk: '#654321', leaves: ['#228B22', '#32CD32', '#3CB371'] },
                maple: { trunk: '#8B4513', leaves: ['#FF8C00', '#FF7F50', '#FF6347'] },
                birch: { trunk: '#F5F5DC', leaves: ['#90EE90', '#98FB98', '#8FBC8F'] }
            };
            
            const tree = colors[variant] || colors.oak;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + 30, 35, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Trunk
            const gradient = ctx.createLinearGradient(x - 20, y, x + 20, y);
            gradient.addColorStop(0, tree.trunk);
            gradient.addColorStop(0.5, '#8B7355');
            gradient.addColorStop(1, tree.trunk);
            ctx.fillStyle = gradient;
            ctx.fillRect(x - 20, y - 20, 40, 60);
            
            // Leaves layers
            tree.leaves.forEach((color, i) => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x - 20 + i * 10, y - 30 - i * 5, 35 - i * 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + 20 - i * 10, y - 25 - i * 5, 30 - i * 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x, y - 50 - i * 5, 40 - i * 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Highlight
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            ctx.arc(x - 10, y - 45, 15, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawOre(x, y, variant) {
            const colors = {
                copper: ['#B87333', '#CD7F32', '#A0522D'],
                iron: ['#434343', '#565656', '#2F2F2F'],
                silver: ['#C0C0C0', '#D3D3D3', '#A9A9A9'],
                gold: ['#FFD700', '#FFED4E', '#FFA500']
            };
            
            const ore = colors[variant] || colors.iron;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(x, y + 20, 30, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Rock base
            ctx.fillStyle = '#2a2a3a';
            ctx.beginPath();
            ctx.moveTo(x - 35, y + 20);
            ctx.lineTo(x - 25, y - 30);
            ctx.lineTo(x, y - 35);
            ctx.lineTo(x + 25, y - 30);
            ctx.lineTo(x + 35, y + 20);
            ctx.closePath();
            ctx.fill();
            
            // Ore veins
            ore.forEach((color, i) => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 4 - i;
                ctx.beginPath();
                ctx.moveTo(x - 20 + i * 5, y - 20);
                ctx.lineTo(x + 20 - i * 5, y + 10);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(x - 10, y - 25 + i * 5);
                ctx.lineTo(x + 15, y - 5 + i * 5);
                ctx.stroke();
            });
            
            // Sparkle effect
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 3; i++) {
                const sparkleX = x - 15 + Math.random() * 30;
                const sparkleY = y - 20 + Math.random() * 30;
                ctx.beginPath();
                ctx.arc(sparkleX, sparkleY, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawPlayer() {
            const { x, y, size } = gameState.player;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + size, size * 0.8, size * 0.4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Body
            const bodyGradient = ctx.createLinearGradient(x - size, y - size, x + size, y + size);
            bodyGradient.addColorStop(0, '#4a7a8a');
            bodyGradient.addColorStop(0.5, '#5a8a9a');
            bodyGradient.addColorStop(1, '#3a6a7a');
            ctx.fillStyle = bodyGradient;
            ctx.fillRect(x - size * 0.6, y - size * 0.5, size * 1.2, size * 1.5);
            
            // Head
            ctx.fillStyle = '#f4c2a0';
            ctx.beginPath();
            ctx.arc(x, y - size, size * 0.6, 0, Math.PI * 2);
            ctx.fill();
            
            // Hair
            ctx.fillStyle = '#3a2a1a';
            ctx.beginPath();
            ctx.arc(x, y - size * 1.1, size * 0.6, Math.PI, 0);
            ctx.fill();
            
            // Name (show username if available)
            const displayName = (playerProfile && playerProfile.username) ? playerProfile.username : 'Player';
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.strokeText(displayName, x, y - size * 2);
            ctx.fillText(displayName, x, y - size * 2);
        }

        function drawRoom() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a2a3a');
            gradient.addColorStop(1, '#0a1a2a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw tiles or tilemap
            if (rooms[gameState.currentRoom] && rooms[gameState.currentRoom].usesTilemap && tilemapData) {
                drawTilemap();
            } else {
                drawTiles();
            }
            
            // Draw room objects
            const room = rooms[gameState.currentRoom];
            if (room.objects) {
                room.objects.forEach(obj => {
                    const drawX = obj.x - gameState.camera.x;
                    const drawY = obj.y - gameState.camera.y;
                    
                    switch(obj.type) {
                        case 'tree':
                            drawTree(drawX, drawY, obj.variant);
                            break;
                        case 'ore':
                            drawOre(drawX, drawY, obj.variant);
                            break;
                        case 'pond':
                            ctx.fillStyle = '#4682B4';
                            ctx.fillRect(drawX - obj.width/2, drawY - obj.height/2, obj.width, obj.height);
                            break;
                        case 'fishingSpot':
                            ctx.fillStyle = 'rgba(100, 150, 200, 0.5)';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY, 20, 0, Math.PI * 2);
                            ctx.fill();
                            break;
                        case 'dummy':
                            // Combat dummy
                            ctx.fillStyle = '#8B7355';
                            ctx.fillRect(drawX - 15, drawY - 10, 30, 40);
                            ctx.fillStyle = '#A0826D';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY - 25, 15, 0, Math.PI * 2);
                            ctx.fill();
                            break;
                        case 'stove':
                            // Cooking stove
                            ctx.fillStyle = '#3a3a3a';
                            ctx.fillRect(drawX - 30, drawY - 20, 60, 40);
                            // Fire
                            ctx.fillStyle = '#FF4500';
                            for (let i = 0; i < 3; i++) {
                                ctx.fillRect(drawX - 20 + i * 15, drawY - 10, 10, 15);
                            }
                            break;
                        case 'table':
                            ctx.fillStyle = '#8B6508';
                            ctx.fillRect(drawX - 40, drawY - 15, 80, 30);
                            break;
                        case 'chest':
                            // Treasure chest
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(drawX - 25, drawY - 15, 50, 30);
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(drawX - 5, drawY - 10, 10, 15);
                            ctx.strokeStyle = '#654321';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(drawX - 25, drawY - 15, 50, 30);
                            break;
                        case 'boss':
                            // Boss enemy
                            ctx.fillStyle = '#8B0000';
                            ctx.fillRect(drawX - 20, drawY - 15, 40, 50);
                            ctx.fillStyle = '#FF0000';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY - 30, 18, 0, Math.PI * 2);
                            ctx.fill();
                            break;
                        case 'pest':
                            // Pest (rat/spider)
                            if (obj.variant === 'rat') {
                                ctx.fillStyle = '#5a4a3a';
                                ctx.beginPath();
                                ctx.ellipse(drawX, drawY, 15, 10, 0, 0, Math.PI * 2);
                                ctx.fill();
                            } else {
                                ctx.fillStyle = '#2a2a2a';
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 12, 0, Math.PI * 2);
                                ctx.fill();
                                // Spider legs
                                ctx.strokeStyle = '#2a2a2a';
                                ctx.lineWidth = 2;
                                for (let i = 0; i < 8; i++) {
                                    const angle = (i / 8) * Math.PI * 2;
                                    ctx.beginPath();
                                    ctx.moveTo(drawX, drawY);
                                    ctx.lineTo(drawX + Math.cos(angle) * 20, drawY + Math.sin(angle) * 20);
                                    ctx.stroke();
                                }
                            }
                            break;
                        case 'workbench':
                            // Crafting workbench
                            ctx.fillStyle = '#654321';
                            ctx.fillRect(drawX - 35, drawY - 15, 70, 35);
                            ctx.fillStyle = '#8B7355';
                            ctx.fillRect(drawX - 30, drawY - 12, 60, 5);
                            break;
                        case 'anvil':
                            // Blacksmith anvil
                            ctx.fillStyle = '#2a2a3a';
                            ctx.fillRect(drawX - 20, drawY - 10, 40, 25);
                            ctx.fillStyle = '#3a3a4a';
                            ctx.beginPath();
                            ctx.moveTo(drawX - 25, drawY - 10);
                            ctx.lineTo(drawX + 25, drawY - 10);
                            ctx.lineTo(drawX + 20, drawY - 20);
                            ctx.lineTo(drawX - 20, drawY - 20);
                            ctx.closePath();
                            ctx.fill();
                            break;
                        case 'forge':
                            // Forge/furnace
                            ctx.fillStyle = '#3a3a3a';
                            ctx.fillRect(drawX - 30, drawY - 25, 60, 50);
                            // Fire inside
                            ctx.fillStyle = '#FF6500';
                            ctx.fillRect(drawX - 20, drawY - 5, 40, 20);
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(drawX - 15, drawY, 30, 10);
                            break;
                        case 'treasure':
                            // Treasure spot
                            if (obj.variant === 'buried') {
                                // X marks the spot
                                ctx.strokeStyle = '#8B4513';
                                ctx.lineWidth = 4;
                                ctx.beginPath();
                                ctx.moveTo(drawX - 20, drawY - 20);
                                ctx.lineTo(drawX + 20, drawY + 20);
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(drawX - 20, drawY + 20);
                                ctx.lineTo(drawX + 20, drawY - 20);
                                ctx.stroke();
                            } else {
                                // Treasure chest
                                ctx.fillStyle = '#FFD700';
                                ctx.fillRect(drawX - 25, drawY - 15, 50, 30);
                                ctx.strokeStyle = '#8B4513';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(drawX - 25, drawY - 15, 50, 30);
                                // Gems
                                ctx.fillStyle = '#FF0000';
                                ctx.beginPath();
                                ctx.arc(drawX - 10, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.fillStyle = '#00FF00';
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.fillStyle = '#0000FF';
                                ctx.beginPath();
                                ctx.arc(drawX + 10, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                            }
                            break;
                    }
                });
            }
            
            // Draw particles
            gameState.particles.forEach((particle, index) => {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.alpha;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                
                // Update particle
                particle.y -= particle.speed;
                particle.alpha -= 0.02;
                particle.size *= 0.98;
                
                if (particle.alpha <= 0) {
                    gameState.particles.splice(index, 1);
                }
            });
        }

        // Movement
        function movePlayer() {
            if (gameState.player.targetX !== null) {
                const dx = gameState.player.targetX - gameState.player.x;
                const dy = gameState.player.targetY - gameState.player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    gameState.player.x += (dx / distance) * gameState.player.speed;
                    gameState.player.y += (dy / distance) * gameState.player.speed;
                    
                    // Add movement particles
                    if (Math.random() > 0.7) {
                        gameState.particles.push({
                            x: gameState.player.x + (Math.random() - 0.5) * 20,
                            y: gameState.player.y + 20,
                            size: 3,
                            color: '#8a7a6a',
                            speed: 1,
                            alpha: 0.5
                        });
                    }
                } else {
                    gameState.player.targetX = null;
                    gameState.player.targetY = null;
                    
                    // Start performing action if we reached target
                    if (gameState.player.currentTarget && !gameState.player.isPerformingAction) {
                        gameState.player.isPerformingAction = true;
                        gameState.player.actionProgress = 0;
                        gameState.player.lastActionTime = Date.now();
                    }
                }
            }
        }

        // AFK Activity System
        function selectNextTarget() {
            if (gameState.currentRoom === 'combat') return; // Combat is not AFK
            
            const room = rooms[gameState.currentRoom];
            if (!room.objects || room.objects.length === 0) return;
            
            // Select random object
            const availableObjects = room.objects.filter(obj => 
                obj.type !== 'pond' // Don't target ponds, only fishing spots
            );
            
            if (availableObjects.length > 0) {
                const target = availableObjects[Math.floor(Math.random() * availableObjects.length)];
                gameState.player.currentTarget = target;
                gameState.player.targetX = target.x;
                gameState.player.targetY = target.y;
            }
        }

        function performAction() {
            if (!gameState.player.isPerformingAction || !gameState.player.currentTarget) return;
            
            const now = Date.now();
            const elapsed = now - gameState.player.lastActionTime;
            gameState.player.actionProgress = Math.min(elapsed / gameState.player.actionDuration, 1);
            
            // Draw progress bar above player
            drawActionProgress();
            
            // Action complete
            if (gameState.player.actionProgress >= 1) {
                completeAction();
                gameState.player.isPerformingAction = false;
                gameState.player.currentTarget = null;
                
                // Schedule next action
                gameState.nextTargetTime = now + 1000; // Wait 1 second before next action
            }
        }

        function completeAction() {
            const room = rooms[gameState.currentRoom];
            
            // Get tier-based reward for resource gathering rooms
            let reward = null;
            
            if (['woodcutting', 'mining', 'fishing', 'farming', 'agility'].includes(gameState.currentRoom)) {
                // Get the skill level for this activity
                const skillLevel = gameState.player.skills[gameState.currentRoom] || 1;
                
                // Get available tier based on skill level
                const resource = getAvailableTier(gameState.currentRoom, skillLevel);
                
                if (resource) {
                    // Roll for rarity
                    const rarity = getRarity();
                    const tierBonus = resource.tier;
                    
                    // Calculate rewards with rarity multiplier
                    const goldReward = Math.floor((10 * tierBonus + Math.floor(Math.random() * 10)) * rarity.multiplier);
                    const expReward = Math.floor(resource.exp * rarity.multiplier);
                    
                    // Get appropriate icon based on rarity
                    const iconName = getResourceIcon(resource.baseIcon, resource.tier, rarity.key);
                    
                    // Create item name with tier and rarity
                    const itemName = `T${resource.tier} ${rarity.name} ${resource.name}`;
                    
                    reward = {
                        gold: goldReward,
                        xp: expReward,
                        item: {
                            name: itemName,
                            icon: iconName,
                            tier: resource.tier,
                            rarity: rarity.key,
                            rarityColor: rarity.color,
                            stackable: true,
                            type: 'resource'
                        },
                        skill: gameState.currentRoom
                    };
                    
                    // Special effects for rare drops
                    if (rarity.key === 'perfect') {
                        // Add extra particles for perfect drops
                        for (let i = 0; i < 20; i++) {
                            gameState.particles.push({
                                x: gameState.player.x + (Math.random() - 0.5) * 60,
                                y: gameState.player.y + (Math.random() - 0.5) * 60,
                                size: 8,
                                color: '#fa5a5a',
                                speed: 3,
                                alpha: 1
                            });
                        }
                    } else if (rarity.key === 'epic') {
                        // Epic drop
                    }
                    
                } else {
                    // Shouldn't happen, but fallback
                    reward = {
                        gold: 10,
                        xp: 10,
                        item: null,
                        skill: gameState.currentRoom
                    };
                }
            } else {
                // Use default rewards for other rooms
                const rewards = {
                    cooking: { gold: 18, xp: 28, item: { name: 'Cooked Food', icon: 'üçñ', stackable: true, type: 'food' }, skill: 'cooking' },
                    crafting: { gold: 30, xp: 40, item: { name: 'Crafted Item', icon: 'üî®', stackable: true, type: 'material' }, skill: 'crafting' },
                    raids: { gold: 100, xp: 80, item: { name: 'Raid Loot', icon: 'üíé', stackable: false, type: 'valuable' }, skill: 'combat' },
                    combat: { gold: 35, xp: 50, item: null, skill: 'combat' }
                };
                
                reward = rewards[gameState.currentRoom] || { gold: 10, xp: 20, item: null, skill: 'combat' };
            }
            
            // Add gold
            gameState.player.gold += reward.gold;
            document.getElementById('goldAmount').textContent = gameState.player.gold.toLocaleString();
            document.getElementById('invGold').textContent = gameState.player.gold.toLocaleString();
            
            // Add item to inventory
            if (reward.item) {
                addToInventory(reward.item);
            }
            
            // Add XP and check for level up
            console.log('Reward received:', reward);
            if (reward.xp && reward.skill) {
                console.log(`Calling addSkillXP(${reward.skill}, ${reward.xp})`);
                addSkillXP(reward.skill, reward.xp);
                
                // Track activity for stats display
                gameState.activityTracker.xpGained += reward.xp;
            } else {
                console.warn('No XP or skill in reward:', { xp: reward.xp, skill: reward.skill });
            }
            
            // Track items gained
            if (reward.item) {
                gameState.activityTracker.itemsGained++;
                gameState.activityTracker.lastItem = reward.item.name;
            }
            
            // Update activity tracker display
            updateActivityTracker();
            
            // Add success particles
            for (let i = 0; i < 10; i++) {
                gameState.particles.push({
                    x: gameState.player.x + (Math.random() - 0.5) * 40,
                    y: gameState.player.y + (Math.random() - 0.5) * 40,
                    size: 5,
                    color: '#FFD700',
                    speed: 2,
                    alpha: 1
                });
            }
            
            // Show floating text
            showFloatingText(`+${reward.gold} Gold`, gameState.player.x, gameState.player.y - 40, '#FFD700');
            if (reward.xp) {
                showFloatingText(`+${reward.xp} XP`, gameState.player.x, gameState.player.y - 46, '#00BFFF');
            }
            if (reward.item) {
                showFloatingText(`+1 - ${reward.item.name}`, gameState.player.x, gameState.player.y - 52, reward.item.rarityColor || '#5abaaa');
            }
        }
        
        // Update Activity Tracker Display (OSRS-style)
        function updateActivityTracker() {
            const tracker = gameState.activityTracker;
            const elapsedSeconds = (Date.now() - tracker.startTime) / 1000;
            const elapsedHours = elapsedSeconds / 3600;
            
            // Calculate per-hour rates
            const itemsPerHour = elapsedHours > 0 ? Math.floor(tracker.itemsGained / elapsedHours) : 0;
            const xpPerHour = elapsedHours > 0 ? Math.floor(tracker.xpGained / elapsedHours) : 0;
            
            // Update display
            document.getElementById('itemsPerHour').textContent = itemsPerHour.toLocaleString();
            document.getElementById('xpPerHour').textContent = xpPerHour.toLocaleString();
            
            // Update session items
            document.getElementById('sessionItems').textContent = tracker.itemsGained.toLocaleString();
            
            // Update total skill XP
            const currentSkill = gameState.currentRoom;
            const totalXP = gameState.player.skillXP[currentSkill] || 0;
            document.getElementById('totalSkillXP').textContent = totalXP.toLocaleString();
            
            // Update activity name
            const activityNames = {
                'woodcutting': 'Woodcutting',
                'mining': 'Mining',
                'fishing': 'Fishing',
                'farming': 'Farming',
                'agility': 'Agility',
                'cooking': 'Cooking',
                'combat': 'Combat',
                'crafting': 'Crafting',
                'raids': 'Raiding'
            };
            document.getElementById('activityName').textContent = activityNames[gameState.currentRoom] || gameState.currentRoom;
        }
        
        // Reset activity tracker when changing rooms
        function resetActivityTracker() {
            gameState.activityTracker = {
                startTime: Date.now(),
                itemsGained: 0,
                xpGained: 0,
                currentActivity: gameState.currentRoom,
                lastItem: null
            };
            updateActivityTracker();
        }
        
        // Calculate XP required for a level (uses exponential formula like OSRS)
        function getXPForLevel(level) {
            let total = 0;
            for (let i = 1; i < level; i++) {
                total += Math.floor(i + 300 * Math.pow(2, i / 7));
            }
            return Math.floor(total / 4);
        }
        
        // Add XP to a skill and check for level ups
        function addSkillXP(skill, xp) {
            // Ensure skillXP object exists
            if (!gameState.player.skillXP) {
                console.warn('skillXP object not initialized, creating it now');
                gameState.player.skillXP = {
                    hitpoints: 0, attack: 0, mining: 0, strength: 0, agility: 0,
                    defence: 0, fishing: 0, ranged: 0, cooking: 0, crafting: 0,
                    magic: 0, woodcutting: 0, farming: 0, combat: 0
                };
            }
            
            if (!gameState.player.skillXP[skill]) {
                gameState.player.skillXP[skill] = 0;
            }
            
            gameState.player.skillXP[skill] += xp;
            console.log(`Added ${xp} XP to ${skill}. Total XP: ${gameState.player.skillXP[skill]}`);
            
            // Update skills display to show new XP
            updateSkillsDisplay();
            
            // Check for level up
            const currentLevel = gameState.player.skills[skill] || 1;
            const xpForNextLevel = getXPForLevel(currentLevel + 1);
            
            console.log(`${skill} - Level: ${currentLevel}, XP: ${gameState.player.skillXP[skill]}/${xpForNextLevel}`);
            
            if (gameState.player.skillXP[skill] >= xpForNextLevel) {
                gameState.player.skills[skill]++;
                console.log(`LEVEL UP! ${skill} is now level ${gameState.player.skills[skill]}`);
                updateSkillsDisplay();
                showFloatingText(`Level Up! ${skill} ${gameState.player.skills[skill]}`, 
                                gameState.player.x, gameState.player.y - 80, '#FFD700');
                
                // Extra particles for level up
                for (let i = 0; i < 30; i++) {
                    gameState.particles.push({
                        x: gameState.player.x + (Math.random() - 0.5) * 80,
                        y: gameState.player.y + (Math.random() - 0.5) * 80,
                        size: 8,
                        color: '#FFD700',
                        speed: 3,
                        alpha: 1
                    });
                }
            }
        }

        function addToInventory(item) {
            // Check if item is stackable and already exists
            if (item.stackable) {
                const existingItem = gameState.player.inventory.find(invItem => 
                    invItem && invItem.name === item.name && 
                    invItem.rarity === item.rarity // Only stack if same rarity
                );
                
                if (existingItem) {
                    existingItem.quantity++;
                } else if (gameState.player.inventory.length < gameState.player.inventorySize) {
                    gameState.player.inventory.push({
                        ...item,
                        quantity: 1
                    });
                }
            } else {
                // Non-stackable items
                if (gameState.player.inventory.length < gameState.player.inventorySize) {
                    gameState.player.inventory.push({
                        ...item,
                        quantity: 1
                    });
                }
            }
            
            updateInventoryDisplay();
        }

        function updateSkillsDisplay() {
            // Ensure skillXP exists
            if (!gameState.player.skillXP) {
                gameState.player.skillXP = {
                    hitpoints: 0, attack: 0, mining: 0, strength: 0, agility: 0,
                    defence: 0, fishing: 0, ranged: 0, cooking: 0, crafting: 0,
                    carpentry: 0, magic: 0, woodcutting: 0, farming: 0, combat: 0
                };
            }
            
            // Update skill levels in the sidebar
            const skillNames = ['hitpoints', 'attack', 'mining', 'strength', 'agility', 
                               'defence', 'fishing', 'ranged', 'cooking', 
                               'crafting', 'carpentry', 'magic', 'woodcutting',
                               'farming', 'combat'];
            
            const skillItems = document.querySelectorAll('.skill-item');
            let totalLevel = 0;
            
            skillItems.forEach((item, index) => {
                if (skillNames[index]) {
                    const skillName = skillNames[index];
                    const level = gameState.player.skills[skillName] || 1;
                    const currentXP = gameState.player.skillXP[skillName] || 0;
                    const xpForThisLevel = getXPForLevel(level);
                    const xpForNextLevel = getXPForLevel(level + 1);
                    const xpNeeded = xpForNextLevel - currentXP;
                    const xpProgress = currentXP - xpForThisLevel;
                    const xpToLevel = xpForNextLevel - xpForThisLevel;
                    const percentToLevel = Math.max(0, Math.min(100, Math.floor((xpProgress / xpToLevel) * 100)));
                    
                    const levelSpan = item.querySelector('.skill-level');
                    if (levelSpan) {
                        levelSpan.textContent = level;
                        totalLevel += level;
                        
                        // Add tier info for gathering skills
                        if (['mining', 'fishing', 'woodcutting', 'farming', 'agility', 'carpentry'].includes(skillName)) {
                            let tierInfo = 'T1';
                            if (level >= 80) tierInfo = 'T5';
                            else if (level >= 60) tierInfo = 'T4';
                            else if (level >= 40) tierInfo = 'T3';
                            else if (level >= 20) tierInfo = 'T2';
                            
                            // Show next tier requirement
                            let nextTier = '';
                            if (level < 20) nextTier = `\nT2 unlocks at level 20`;
                            else if (level < 40) nextTier = `\nT3 unlocks at level 40`;
                            else if (level < 60) nextTier = `\nT4 unlocks at level 60`;
                            else if (level < 80) nextTier = `\nT5 unlocks at level 80`;
                            
                            item.title = `${skillName.charAt(0).toUpperCase() + skillName.slice(1)}\nLevel: ${level} (${tierInfo})\nXP: ${currentXP.toLocaleString()} / ${xpForNextLevel.toLocaleString()}\n${xpNeeded.toLocaleString()} XP to next level (${percentToLevel}%)${nextTier}`;
                        } else {
                            item.title = `${skillName.charAt(0).toUpperCase() + skillName.slice(1)}\nLevel: ${level}\nXP: ${currentXP.toLocaleString()} / ${xpForNextLevel.toLocaleString()}\n${xpNeeded.toLocaleString()} XP to next level (${percentToLevel}%)`;
                        }
                    }
                }
            });
            
            document.getElementById('totalLevel').textContent = totalLevel;
        }

        function showFloatingText(text, x, y, color) {
            if (!gameState.floatingTexts) gameState.floatingTexts = [];
            
            // Check for recently created floating texts at similar positions
            // and offset this one to prevent overlapping
            let yOffset = -10; // Base offset
            const recentTexts = gameState.floatingTexts.filter(t => {
                // Check if text is at similar x position (within 50 pixels)
                // and was created recently (alpha still high)
                return Math.abs(t.x - x) < 50 && t.alpha > 0.9;
            });
            
            // Stack new texts above existing ones
            if (recentTexts.length > 0) {
                // Each additional text gets stacked 25 pixels higher
                yOffset -= recentTexts.length * 25;
            }
            
            const floatingText = {
                text,
                x,
                y: y + yOffset,
                color,
                alpha: 1,
                speed: 0.8 // Slower upward movement
            };
            
            gameState.floatingTexts.push(floatingText);
        }

        function drawActionProgress() {
            if (!gameState.player.isPerformingAction) return;
            
            const barWidth = 60;
            const barHeight = 8;
            const x = gameState.player.x - barWidth / 2;
            const y = gameState.player.y - gameState.player.size * 2.5;
            
            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Progress
            ctx.fillStyle = '#5abaaa';
            ctx.fillRect(x, y, barWidth * gameState.player.actionProgress, barHeight);
            
            // Border
            ctx.strokeStyle = '#2a4a5a';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, barWidth, barHeight);
        }

        function drawFloatingTexts() {
            if (!gameState.floatingTexts) return;
            
            gameState.floatingTexts.forEach((text, index) => {
                // Add shadow for better readability
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                ctx.fillStyle = text.color;
                ctx.globalAlpha = text.alpha;
                ctx.font = 'bold 18px Arial'; // Larger font
                ctx.textAlign = 'center';
                ctx.fillText(text.text, text.x, text.y);
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                ctx.globalAlpha = 1;
                
                // Update - much slower movement and fade
                text.y -= text.speed * 0.4; // Slower upward drift
                text.alpha -= 0.004; // Fade 5x slower (was 0.02) - stays visible much longer
                
                if (text.alpha <= 0) {
                    gameState.floatingTexts.splice(index, 1);
                }
            });
        }

        function checkInteraction() {
            // Only for combat room (manual interaction)
            if (gameState.currentRoom !== 'combat') return;
            
            const room = rooms[gameState.currentRoom];
            if (!room.objects) return;
            
            room.objects.forEach(obj => {
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - obj.x, 2) + 
                    Math.pow(gameState.player.y - obj.y, 2)
                );
                
                if (distance < 80) {
                    // Combat action
                    gameState.player.gold += 35;
                    document.getElementById('goldAmount').textContent = gameState.player.gold.toLocaleString();
                    document.getElementById('invGold').textContent = gameState.player.gold.toLocaleString();
                    
                    // Combat particles
                    for (let i = 0; i < 15; i++) {
                        gameState.particles.push({
                            x: obj.x + (Math.random() - 0.5) * 40,
                            y: obj.y + (Math.random() - 0.5) * 40,
                            size: 5,
                            color: '#FF4500',
                            speed: 3,
                            alpha: 1
                        });
                    }
                    
                    showFloatingText('Hit!', obj.x, obj.y - 40, '#FF4500');
                    showFloatingText('+35 Gold', gameState.player.x, gameState.player.y - 40, '#FFD700');
                }
            });
        }

        // Initialize inventory
        function initInventory() {
            updateInventoryDisplay();
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            // Create all 98 slots
            for (let i = 0; i < 98; i++) {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                slot.dataset.index = i;
                
                if (i < gameState.player.inventory.length) {
                    const item = gameState.player.inventory[i];
                    if (item) {
                        slot.classList.add('occupied');
                        slot.style.position = 'relative';
                        
                        // Add rarity border
                        if (item.rarityColor) {
                            slot.style.borderColor = item.rarityColor;
                            slot.style.boxShadow = `0 0 5px ${item.rarityColor}40`;
                        }
                        
                        // Create container for item display - fill entire slot
                        const itemDisplay = document.createElement('div');
                        itemDisplay.style.position = 'absolute';
                        itemDisplay.style.top = '4px';  // Small padding
                        itemDisplay.style.left = '4px';
                        itemDisplay.style.right = '4px';
                        itemDisplay.style.bottom = '4px';
                        
                        // Use sprite image if available
                        if (gameState.sprites[item.icon]) {
                            const img = document.createElement('img');
                            img.src = gameState.sprites[item.icon].src;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'contain';
                            img.style.imageRendering = 'pixelated';
                            img.style.imageRendering = '-moz-crisp-edges';
                            img.style.imageRendering = 'crisp-edges';
                            itemDisplay.appendChild(img);
                            
                            // Add tier and rarity indicator for resources
                            if (item.tier) {
                                const tierBadge = document.createElement('div');
                                tierBadge.style.position = 'absolute';
                                tierBadge.style.top = '2px';
                                tierBadge.style.left = '2px';
                                tierBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                tierBadge.style.color = item.rarityColor || ['#8a8a8a', '#5abaaa', '#5a8afa', '#aa5afa', '#fa5a5a'][item.tier - 1];
                                tierBadge.style.fontSize = '10px';
                                tierBadge.style.fontWeight = 'bold';
                                tierBadge.style.padding = '2px 4px';
                                tierBadge.style.borderRadius = '3px';
                                tierBadge.style.border = `1px solid ${item.rarityColor || '#8a8a8a'}`;
                                tierBadge.textContent = `T${item.tier}`;
                                itemDisplay.appendChild(tierBadge);
                                
                                // Add rarity indicator if not common
                                if (item.rarity && item.rarity !== 'common') {
                                    const rarityBadge = document.createElement('div');
                                    rarityBadge.style.position = 'absolute';
                                    rarityBadge.style.top = '2px';
                                    rarityBadge.style.right = '2px';
                                    rarityBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                    rarityBadge.style.color = item.rarityColor;
                                    rarityBadge.style.fontSize = '8px';
                                    rarityBadge.style.fontWeight = 'bold';
                                    rarityBadge.style.padding = '1px 3px';
                                    rarityBadge.style.borderRadius = '3px';
                                    rarityBadge.style.border = `1px solid ${item.rarityColor}`;
                                    rarityBadge.textContent = item.rarity.charAt(0).toUpperCase();
                                    itemDisplay.appendChild(rarityBadge);
                                }
                            }
                        } else if (item.icon === 'ore') {
                            // Fallback canvas drawing for ore if sprite not loaded
                            const canvas = document.createElement('canvas');
                            const slotSize = slot.offsetWidth || 50;
                            canvas.width = slotSize - 8;
                            canvas.height = slotSize - 8;
                            const ctx = canvas.getContext('2d');
                            ctx.imageSmoothingEnabled = false;
                            
                            // Draw ore
                            ctx.fillStyle = '#696969';
                            ctx.fillRect(canvas.width * 0.2, canvas.height * 0.3, canvas.width * 0.6, canvas.height * 0.4);
                            ctx.fillStyle = '#C0C0C0';
                            ctx.fillRect(canvas.width * 0.3, canvas.height * 0.35, canvas.width * 0.4, canvas.height * 0.3);
                            
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            itemDisplay.appendChild(canvas);
                        } else if (item.icon === 'fish') {
                            // Fallback for fish - use emoji
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 42px; text-align: center; line-height: 1.2;">üêü</div>`;
                        } else if (item.icon === 'log') {
                            // Fallback canvas drawing if image not loaded - fill slot
                            const canvas = document.createElement('canvas');
                            const slotSize = slot.offsetWidth || 50;  // Get actual slot size
                            canvas.width = slotSize - 8;  // Account for padding
                            canvas.height = slotSize - 8;
                            const ctx = canvas.getContext('2d');
                            ctx.imageSmoothingEnabled = false;
                            
                            // Draw log to fill canvas
                            const logHeight = canvas.height * 0.5;
                            const logY = (canvas.height - logHeight) / 2;
                            
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(4, logY, canvas.width - 8, logHeight);
                            ctx.fillStyle = '#654321';
                            ctx.fillRect(4, logY, canvas.width - 8, logHeight * 0.25);
                            ctx.fillStyle = '#A0522D';
                            ctx.fillRect(6, logY + logHeight * 0.3, canvas.width - 12, logHeight * 0.4);
                            
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            itemDisplay.appendChild(canvas);
                        } else {
                            // Use emoji for other items - make it larger
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 48px; text-align: center; line-height: 1.2;">${item.icon || 'üì¶'}</div>`;
                        }
                        
                        slot.appendChild(itemDisplay);
                        
                        // Add quantity display
                        if (item.quantity > 1) {
                            const qty = document.createElement('div');
                            qty.className = 'item-quantity';
                            qty.textContent = item.quantity > 999 ? '999+' : item.quantity;
                            slot.appendChild(qty);
                        }
                        
                        slot.dataset.item = JSON.stringify(item);
                        
                        // Add click handler for equipping
                        slot.addEventListener('click', () => handleItemClick(i, item));
                    }
                } else {
                    slot.classList.add('empty');
                }
                
                grid.appendChild(slot);
            }
            
            // Update space counter
            document.getElementById('invSpace').textContent = gameState.player.inventory.length;
        }

        function handleItemClick(index, item) {
            // Check if item is tradeable (resources)
            const isTradeable = TRADEABLE_ITEMS[item.name];
            
            if (isTradeable && item.type === 'resource') {
                // Quick-sell feature: Open Grand Exchange with item pre-selected
                if (isFirebaseConfigured && database) {
                    // Allow guests for testing purposes
                    if (isGuestMode && !currentUser) {
                        currentUser = {
                            uid: 'guest-' + Math.random().toString(36).substr(2, 9),
                            email: 'guest@temporary.com',
                            displayName: 'Guest'
                        };
                        showFloatingText('‚ö†Ô∏è Testing as Guest - Data will not persist!', canvas.width / 2, 100, '#ffaa66');
                    }
                    
                    // Open Grand Exchange
                    document.getElementById('grandExchangeModal').style.display = 'flex';
                    if (!geInitialized) {
                        initGrandExchange();
                        geInitialized = true;
                    }
                    
                    // Wait a moment for modal to render, then select a sell slot and item
                    setTimeout(() => {
                        // Find first empty sell slot
                        const sellSlots = document.querySelectorAll('.offer-slot[data-slot-type="sell"]');
                        let emptySlot = null;
                        
                        for (let slot of sellSlots) {
                            if (slot.classList.contains('empty')) {
                                emptySlot = slot;
                                break;
                            }
                        }
                        
                        if (emptySlot) {
                            // Simulate clicking the empty slot
                            emptySlot.click();
                            
                            // Wait another moment for the sell form to show
                            setTimeout(() => {
                                // Pre-select the item
                                selectSellItem(item.name, item.quantity);
                            }, 100);
                        } else {
                            showFloatingText('All sell slots are full!', canvas.width / 2, 100, '#ff4444');
                        }
                    }, 100);
                    
                    showFloatingText(`Quick-sell: ${item.name}`, canvas.width / 2, 200, '#5abaaa');
                } else {
                    showFloatingText('Grand Exchange requires Firebase setup', canvas.width / 2, 100, '#ff4444');
                }
                return;
            }
            
            // Determine if item is equippable
            const equipSlots = ['head', 'amulet', 'cape', 'chest', 'legs', 'boots', 'gloves', 'ring', 'weapon', 'off-hand', 'arrows'];
            
            if (item.type && equipSlots.includes(item.type)) {
                // Equip the item
                const currentEquipped = gameState.player.equipment[item.type];
                
                // Swap items
                gameState.player.equipment[item.type] = item;
                
                // Remove from inventory
                gameState.player.inventory.splice(index, 1);
                
                // Add previously equipped item back to inventory if exists
                if (currentEquipped) {
                    gameState.player.inventory.push(currentEquipped);
                }
                
                updateInventoryDisplay();
                updateEquipmentDisplay();
                showFloatingText(`Equipped ${item.name}`, canvas.width / 2, 200, '#5abaaa');
            }
        }

        function updateEquipmentDisplay() {
            const equipSlots = document.querySelectorAll('.equip-slot');
            
            equipSlots.forEach(slot => {
                const slotName = slot.dataset.slot;
                if (!slotName) return; // Skip if no slot name (shouldn't happen)
                
                // Convert slot name to equipment key (e.g., "Off-Hand" -> "off-hand")
                const slotKey = slotName.toLowerCase().replace(' ', '-');
                const equipped = gameState.player.equipment[slotKey];
                
                if (equipped) {
                    slot.classList.remove('empty');
                    slot.classList.add('equipped');
                    slot.dataset.icon = equipped.icon || '';
                    slot.dataset.item = equipped.name;
                } else {
                    slot.classList.add('empty');
                    slot.classList.remove('equipped');
                    slot.dataset.icon = '';
                    slot.dataset.item = '';
                }
                
                // Remove existing click handlers by cloning
                const newSlot = slot.cloneNode(true);
                slot.parentNode.replaceChild(newSlot, slot);
                
                // Add click handler for unequipping
                newSlot.addEventListener('click', () => {
                    const currentEquipped = gameState.player.equipment[slotKey];
                    if (currentEquipped) {
                        // Unequip item
                        gameState.player.equipment[slotKey] = null;
                        gameState.player.inventory.push(currentEquipped);
                        updateInventoryDisplay();
                        updateEquipmentDisplay();
                        showFloatingText(`Unequipped ${currentEquipped.name}`, canvas.width / 2, 200, '#8a9aaa');
                    }
                });
            });
            
            // Re-setup tooltips after updating
            if (typeof setupEquipmentTooltips === 'function') {
                setupEquipmentTooltips();
            }
        }

        // Setup equipment slot tooltips
        function setupEquipmentTooltips() {
            const tooltip = document.querySelector('.tooltip');
            if (!tooltip) return;
            
            document.querySelectorAll('.equip-slot').forEach(slot => {
                // Remove existing listeners by cloning
                const newSlot = slot.cloneNode(true);
                slot.parentNode.replaceChild(newSlot, slot);
                
                newSlot.addEventListener('mouseenter', (e) => {
                    const slotName = newSlot.dataset.slot;
                    const itemName = newSlot.dataset.item;
                    
                    if (itemName) {
                        tooltip.innerHTML = `<span class="tooltip-item">${slotName} slot: ${itemName}</span>`;
                    } else {
                        tooltip.innerHTML = `<span class="tooltip-empty">${slotName} slot: Empty</span>`;
                    }
                    
                    tooltip.classList.add('show');
                    
                    // Position tooltip
                    const rect = newSlot.getBoundingClientRect();
                    tooltip.style.left = (rect.left - tooltip.offsetWidth - 10) + 'px';
                    tooltip.style.top = (rect.top + rect.height/2 - tooltip.offsetHeight/2) + 'px';
                });
                
                newSlot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });
        }

        // Game loop
        function gameLoop() {
            drawRoom();
            
            // AFK Activity Logic (only if AFK mode is enabled)
            if (gameState.currentRoom !== 'combat' && gameState.afkMode) {
                // Select new target if needed
                if (!gameState.player.currentTarget && !gameState.player.targetX && Date.now() > gameState.nextTargetTime) {
                    selectNextTarget();
                }
                
                // Perform current action
                performAction();
            } else if (!gameState.afkMode) {
                // Manual mode - only perform action if player clicked on something
                if (gameState.player.isPerformingAction) {
                    performAction();
                }
            }
            
            movePlayer();
            drawPlayer();
            drawActionProgress();
            drawFloatingTexts();
            
            requestAnimationFrame(gameLoop);
        }

        // Event listeners
        canvas.addEventListener('click', (e) => {
            if (!gameState.inventoryOpen) {
                // Allow manual clicking in all rooms when not in AFK mode
                if (gameState.currentRoom === 'combat' || !gameState.afkMode) {
                    // Get canvas-relative coordinates
                    const rect = canvas.getBoundingClientRect();
                    gameState.player.targetX = e.clientX - rect.left;
                    gameState.player.targetY = e.clientY - rect.top;
                }
            }
        });

        // AFK Mode toggle
        document.getElementById('afkToggle').addEventListener('click', () => {
            gameState.afkMode = !gameState.afkMode;
            const btn = document.getElementById('afkToggle');
            
            if (gameState.afkMode) {
                btn.textContent = 'AFK Mode';
                btn.classList.add('active');
                showFloatingText('AFK Mode Enabled', canvas.width / 2, 150, '#5abaaa');
                // Reset target for AFK mode to start
                gameState.nextTargetTime = Date.now() + 1000;
            } else {
                btn.textContent = 'Manual Mode';
                btn.classList.remove('active');
                showFloatingText('Manual Mode Enabled', canvas.width / 2, 150, '#FFD700');
                // Clear any current AFK targets
                gameState.player.currentTarget = null;
                gameState.player.targetX = null;
                gameState.player.targetY = null;
                gameState.player.isPerformingAction = false;
            }
        });

        // Grand Exchange / Player Market menu handler
        document.querySelectorAll('.menu-item').forEach(item => {
            const text = item.textContent.trim();
            if (text.includes('Player market')) {
                item.addEventListener('click', () => {
                    if (isFirebaseConfigured && database) {
                        // Allow guests for testing purposes
                        if (isGuestMode && !currentUser) {
                            // Create temporary guest user
                            currentUser = {
                                uid: 'guest-' + Math.random().toString(36).substr(2, 9),
                                email: 'guest@temporary.com',
                                displayName: 'Guest'
                            };
                            showFloatingText('‚ö†Ô∏è Testing as Guest - Data will not persist!', canvas.width / 2, 100, '#ffaa66');
                        }
                        
                        document.getElementById('grandExchangeModal').style.display = 'flex';
                        if (!geInitialized) {
                            initGrandExchange();
                            geInitialized = true;
                        }
                    } else {
                        showFloatingText('Grand Exchange requires Firebase setup', canvas.width / 2, 100, '#ff4444');
                    }
                });
            }
        });

        // Room switching from sidebar
        document.querySelectorAll('.menu-item[data-room]').forEach(item => {
            item.addEventListener('click', () => {
                const room = item.dataset.room;
                if (rooms[room]) {
                    // Update active state
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Change room
                    gameState.currentRoom = room;
                    let roomDisplayName = rooms[room].name;
                    
                    // Add tier info for gathering rooms
                    if (['woodcutting', 'mining', 'fishing', 'farming', 'agility'].includes(room)) {
                        const skillLevel = gameState.player.skills[room] || 1;
                        let maxTier = 1;
                        if (skillLevel >= 80) maxTier = 5;
                        else if (skillLevel >= 60) maxTier = 4;
                        else if (skillLevel >= 40) maxTier = 3;
                        else if (skillLevel >= 20) maxTier = 2;
                        
                        roomDisplayName += ` (T1-T${maxTier} Available)`;
                    }
                    
                    document.getElementById('currentRoom').textContent = roomDisplayName;
                    generateTiles();
                    
                    // Reset player position and state
                    gameState.player.x = canvas.width / 2;
                    gameState.player.y = canvas.height / 2;
                    gameState.player.targetX = null;
                    gameState.player.targetY = null;
                    gameState.player.currentTarget = null;
                    gameState.player.isPerformingAction = false;
                    gameState.nextTargetTime = Date.now() + 1000; // Start activities after 1 second
                    
                    // Show room info based on mode with tier info
                    let infoText = gameState.afkMode ? 
                        (room === 'combat' ? 'Combat - Manual Only!' : `AFK Mode - Auto ${room.charAt(0).toUpperCase() + room.slice(1)}`) :
                        `Manual Mode - ${room.charAt(0).toUpperCase() + room.slice(1)}`;
                    
                    // Add skill level and tier info for gathering rooms
                    if (['woodcutting', 'mining', 'fishing', 'farming', 'agility'].includes(room)) {
                        const skillLevel = gameState.player.skills[room] || 1;
                        let maxTier = 1;
                        if (skillLevel >= 80) maxTier = 5;
                        else if (skillLevel >= 60) maxTier = 4;
                        else if (skillLevel >= 40) maxTier = 3;
                        else if (skillLevel >= 20) maxTier = 2;
                        
                        infoText += ` - Level ${skillLevel} (T${maxTier} Max)`;
                    }
                    
                    showFloatingText(infoText, canvas.width / 2, 100, '#FFD700');
                }
            });
        });

        // Sidebar toggle
        // Sidebar toggle
        document.querySelector('.sidebar-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('leftSidebar');
            const canvas = document.getElementById('gameCanvas');
            sidebar.classList.toggle('collapsed');
            this.textContent = sidebar.classList.contains('collapsed') ? '‚ü©' : '‚ü®';
            
            // Adjust canvas position
            if (sidebar.classList.contains('collapsed')) {
                canvas.classList.add('expanded');
            } else {
                canvas.classList.remove('expanded');
            }
            
            // Adjust top bar position
            const topBar = document.getElementById('topBar');
            topBar.style.left = sidebar.classList.contains('collapsed') ? '30px' : '270px';
        });
        
        // Inventory toggle
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                gameState.inventoryOpen = !gameState.inventoryOpen;
                document.getElementById('inventoryUI').style.display = 
                    gameState.inventoryOpen ? 'block' : 'none';
            }
            
            // Toggle AFK mode with 'A' key
            if (e.key === 'a' || e.key === 'A') {
                document.getElementById('afkToggle').click();
            }
        });

        // Close button
        document.getElementById('closeInventory').addEventListener('click', () => {
            gameState.inventoryOpen = false;
            document.getElementById('inventoryUI').style.display = 'none';
        });

        // Inventory button
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Inventory')) {
                item.addEventListener('click', () => {
                    gameState.inventoryOpen = true;
                    document.getElementById('inventoryUI').style.display = 'block';
                });
            }
        });

        // Sort button
        document.getElementById('sortBtn').addEventListener('click', () => {
            // Define rarity order (lower index = lower rarity)
            const rarityOrder = {
                'common': 0,
                'uncommon': 1,
                'rare': 2,
                'epic': 3,
                'perfect': 4,
                'legendary': 5
            };
            
            // Define resource type order
            const getResourceType = (itemName) => {
                const nameLower = itemName.toLowerCase();
                if (nameLower.includes('log')) return 'wood';
                if (nameLower.includes('ore')) return 'ore';
                if (nameLower.includes('fish')) return 'fish';
                if (nameLower.includes('cooked')) return 'food';
                // Equipment types
                if (nameLower.includes('sword') || nameLower.includes('dagger') || 
                    nameLower.includes('bow') || nameLower.includes('staff')) return 'weapon';
                if (nameLower.includes('armor') || nameLower.includes('helm') || 
                    nameLower.includes('boots') || nameLower.includes('gloves')) return 'armor';
                if (nameLower.includes('ring') || nameLower.includes('amulet')) return 'accessory';
                return 'other';
            };
            
            const resourceTypeOrder = {
                'wood': 0,
                'ore': 1,
                'fish': 2,
                'food': 3,
                'weapon': 4,
                'armor': 5,
                'accessory': 6,
                'other': 7
            };
            
            // Sort inventory
            gameState.player.inventory.sort((a, b) => {
                // Skip null/undefined items
                if (!a) return 1;
                if (!b) return -1;
                
                // First, sort by resource type
                const typeA = getResourceType(a.name || '');
                const typeB = getResourceType(b.name || '');
                const typeOrder = (resourceTypeOrder[typeA] || 999) - (resourceTypeOrder[typeB] || 999);
                if (typeOrder !== 0) return typeOrder;
                
                // Then sort by tier (if items have tiers)
                const tierA = a.tier || 0;
                const tierB = b.tier || 0;
                if (tierA !== tierB) return tierA - tierB;
                
                // Finally sort by rarity
                const rarityA = rarityOrder[a.rarity] !== undefined ? rarityOrder[a.rarity] : 999;
                const rarityB = rarityOrder[b.rarity] !== undefined ? rarityOrder[b.rarity] : 999;
                return rarityA - rarityB;
            });
            
            // Update display
            updateInventoryDisplay();
            showFloatingText('Inventory Sorted!', canvas.width / 2, 200, '#5abaaa');
            
            // Visual feedback on inventory slots
            const slots = document.querySelectorAll('.inv-slot');
            slots.forEach((slot, index) => {
                setTimeout(() => {
                    slot.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        slot.style.transform = 'scale(1)';
                    }, 100);
                }, index * 20);
            });
        });

        // Initialize
        // Ensure skillXP is initialized (for backwards compatibility with old saves)
        if (!gameState.player.skillXP) {
            console.log('Initializing skillXP object');
            gameState.player.skillXP = {
                hitpoints: 0,
                attack: 0,
                mining: 0,
                strength: 0,
                agility: 0,
                defence: 0,
                fishing: 0,
                ranged: 0,
                cooking: 0,
                crafting: 0,
                carpentry: 0,
                magic: 0,
                woodcutting: 0,
                farming: 0,
                combat: 0
            };
        }
        
        // Ensure carpentry skill exists (for backwards compatibility)
        if (!gameState.player.skills.carpentry) {
            gameState.player.skills.carpentry = 1;
        }
        if (!gameState.player.skillXP.carpentry) {
            gameState.player.skillXP.carpentry = 0;
        }
        
        // Initialize room objects based on screen size
        initializeRoomObjects();
        
        generateTiles();
        initInventory();
        updateEquipmentDisplay();
        updateSkillsDisplay();
        
        // Set initial room display with tier info
        if (['woodcutting', 'mining', 'fishing', 'farming', 'agility'].includes(gameState.currentRoom)) {
            const skillLevel = gameState.player.skills[gameState.currentRoom] || 1;
            let maxTier = 1;
            if (skillLevel >= 80) maxTier = 5;
            else if (skillLevel >= 60) maxTier = 4;
            else if (skillLevel >= 40) maxTier = 3;
            else if (skillLevel >= 20) maxTier = 2;
            
            const roomName = rooms[gameState.currentRoom].name;
            document.getElementById('currentRoom').textContent = `${roomName} (T1-T${maxTier} Available)`;
        }
        
        gameLoop();
        
        // Add tooltip element to body
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        document.body.appendChild(tooltip);
        
        // Initial tooltip setup
        setupEquipmentTooltips();
        
        // Make Activity Tracker Draggable
        const activityTracker = document.getElementById('activityTracker');
        const dragHandle = document.getElementById('trackerDragHandle');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        // Load saved position from localStorage
        const savedPosition = localStorage.getItem('activityTrackerPosition');
        if (savedPosition) {
            const { x, y } = JSON.parse(savedPosition);
            activityTracker.style.left = x + 'px';
            activityTracker.style.right = 'auto';
            activityTracker.style.top = y + 'px';
            xOffset = x;
            yOffset = y;
        }

        dragHandle.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === dragHandle || dragHandle.contains(e.target)) {
                isDragging = true;
                dragHandle.style.cursor = 'grabbing';
                activityTracker.style.cursor = 'grabbing';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                // Keep tracker within viewport bounds
                const rect = activityTracker.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                xOffset = Math.max(0, Math.min(xOffset, maxX));
                yOffset = Math.max(0, Math.min(yOffset, maxY));

                activityTracker.style.left = xOffset + 'px';
                activityTracker.style.right = 'auto';
                activityTracker.style.top = yOffset + 'px';
            }
        }

        function dragEnd(e) {
            if (isDragging) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                dragHandle.style.cursor = 'grab';
                activityTracker.style.cursor = 'move';
                
                // Save position to localStorage
                localStorage.setItem('activityTrackerPosition', JSON.stringify({ x: xOffset, y: yOffset }));
            }
        }
        
        // X button functionality  
        const xButton = document.querySelector('.cat-icon.x-btn');
        if (xButton) {
            xButton.addEventListener('click', () => {
                // Clear all category filters
                document.querySelectorAll('.cat-icon').forEach(cat => {
                    cat.classList.remove('active');
                });
                // Clear selected items
                document.querySelectorAll('.inv-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                });
                showFloatingText('Cleared', canvas.width / 2, 200, '#5abaaa');
            });
        }
        
        // Handle monitor/window changes - force redraw when window becomes visible or is focused
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                resizeCanvas();
            }
        });
        
        window.addEventListener('focus', () => {
            resizeCanvas();
        });
        
        // Start AFK activities after a short delay
        setTimeout(() => {
            showFloatingText('AFK Mode Active - Press A to toggle', canvas.width / 2, 100, '#FFD700');
        }, 500);
    </script>
</body>
</html>