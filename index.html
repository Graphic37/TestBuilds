<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMORPG - Room Based</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            overflow-x: hidden;
            overflow-y: hidden;
            user-select: none;
            image-rendering: crisp-edges;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #gameContainer {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 260px;
            width: calc(100% - 260px);
            height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            transition: left 0.3s, width 0.3s;
            z-index: 1;
        }
        
        #gameCanvas.expanded {
            left: 20px;
            width: calc(100% - 20px);
        }

        /* Left Sidebar Menu */
        #leftSidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border-right: 2px solid #2a3a4a;
            z-index: 20;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s;
        }

        #leftSidebar.collapsed {
            transform: translateX(-240px);
        }

        .sidebar-toggle {
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border: 2px solid #2a3a4a;
            border-left: none;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a9a8a;
            font-size: 18px;
        }

        .menu-section {
            margin-bottom: 10px;
            border-bottom: 1px solid #2a3a4a;
        }

        .menu-header {
            padding: 12px 20px;
            color: #8a9aaa;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #cad2da;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 15px;
        }

        .menu-item:hover {
            background: rgba(74, 154, 138, 0.2);
            color: #4a9a8a;
            padding-left: 25px;
        }

        .menu-item.active {
            background: rgba(74, 154, 138, 0.3);
            color: #5abaaa;
            border-left: 3px solid #5abaaa;
        }

        .menu-icon {
            width: 28px;
            height: 28px;
            margin-right: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Skills Grid */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            padding: 0 12px 8px 12px;
        }

        .skill-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(20, 30, 40, 0.5);
            border: 1px solid #2a3a4a;
            border-radius: 3px;
            padding: 3px 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-item:hover {
            background: rgba(74, 154, 138, 0.2);
            border-color: #4a9a8a;
            transform: scale(1.05);
        }

        .skill-icon {
            font-size: 14px;
            margin-right: 3px;
        }

        .skill-level {
            color: #8a9aaa;
            font-size: 11px;
            font-weight: bold;
        }

        .total-level {
            padding: 6px 12px;
            color: #5abaaa;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            border-top: 1px solid #2a3a4a;
        }

        <!-- Top UI Bar -->
        #topBar {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 800px;
            max-width: 1200px;
            height: auto;
            background: linear-gradient(135deg, rgba(15, 22, 32, 0.98) 0%, rgba(26, 35, 50, 0.98) 100%);
            border: 4px solid #FFD700;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 25px;
            gap: 20px;
            z-index: 999;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), 0 0 40px rgba(255, 215, 0, 0.4);
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 15px;
                opacity: 1;
            }
        }

        .resource-display {
            display: flex;
            align-items: center;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(90, 186, 170, 0.5);
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .resource-display:hover {
            background: rgba(0, 0, 0, 0.7);
            border-color: #5abaaa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(90, 186, 170, 0.3);
        }

        .afk-toggle {
            padding: 10px 24px;
            background: linear-gradient(135deg, #8a4a3a, #6a3a2a);
            color: #fff;
            border: 3px solid #9a5a4a;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(138, 74, 58, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .afk-toggle::before {
            content: 'ðŸ”´';
            font-size: 12px;
            animation: pulse 2s infinite;
        }

        .afk-toggle:hover {
            background: linear-gradient(135deg, #9a5a4a, #7a4a3a);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(138, 74, 58, 0.6);
        }

        .afk-toggle.active {
            background: linear-gradient(135deg, #4a8a5a, #3a7a4a);
            border-color: #5a9a6a;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(74, 138, 90, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .afk-toggle.active::before {
            content: 'ðŸŸ¢';
            animation: none;
        }

        .coin-icon {
            width: 28px;
            height: 28px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            border-radius: 50%;
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.4);
        }

        /* Inventory UI - Exact Match */
        #inventoryUI {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a2936 0%, #0f1820 100%);
            border: 3px solid #2a4a5a;
            border-radius: 15px;
            display: none;
            z-index: 100;
            width: 1400px;
            max-width: 90vw;
            height: 85vh;
            max-height: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            overflow: hidden;
        }

        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid #2a4a5a;
        }

        .inv-header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .gold-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #2a3a30, #1a2a20);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #4a6a50;
        }

        .gold-display .coin-icon {
            width: 20px;
            height: 20px;
        }

        .gold-amount {
            color: #FFD700;
            font-weight: bold;
            font-size: 18px;
        }

        .space-display {
            color: #8a9aaa;
            font-size: 16px;
        }

        .inv-header-right {
            display: flex;
            gap: 10px;
        }

        .inv-header-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #2a5a5a, #1a4a4a);
            color: #5abaaa;
            border: 2px solid #3a6a6a;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .inv-header-btn:hover {
            background: linear-gradient(135deg, #3a6a6a, #2a5a5a);
            transform: translateY(-1px);
        }

        .lock-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8a3a3a, #6a2a2a);
            border: 2px solid #aa5a5a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .manage-btn {
            background: linear-gradient(135deg, #2a5a4a, #1a4a3a);
            border-color: #3a6a5a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #8a3a3a, #6a2a2a);
            border: 2px solid #aa5a5a;
            border-radius: 50%;
            color: #ff8a8a;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: linear-gradient(135deg, #9a4a4a, #7a3a3a);
            transform: scale(1.1);
        }

        .inv-search-bar {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(0,0,0,0.2);
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(10, 20, 30, 0.8);
            border: 2px solid #2a4a5a;
            border-radius: 8px;
            color: #8a9aaa;
            font-size: 14px;
            font-style: italic;
        }

        .search-input::placeholder {
            color: #5a6a7a;
        }

        .search-btn {
            padding: 10px 30px;
            background: linear-gradient(135deg, #2a5a5a, #1a4a4a);
            color: #5abaaa;
            border: 2px solid #3a6a6a;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .inv-body {
            display: flex;
            padding: 25px;
            gap: 20px;
            overflow: hidden;
        }

        .inv-main {
            flex: 1;
            display: flex;
            gap: 20px;
            overflow: hidden;
        }

        /* Inventory Grid */
        .inv-grid-container {
            flex: 1;
            max-height: calc(85vh - 280px);
            min-height: 450px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 10px;
            padding-bottom: 20px;
            position: relative;
        }
        
        /* Fade indicator at bottom - removed to prevent blocking */
        
        /* Custom scrollbar for inventory */
        .inv-grid-container::-webkit-scrollbar {
            width: 12px;
        }
        
        .inv-grid-container::-webkit-scrollbar-track {
            background: rgba(20, 30, 40, 0.5);
            border-radius: 6px;
        }
        
        .inv-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-radius: 6px;
            border: 2px solid #2a3a4a;
        }
        
        .inv-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4a6a7a, #3a5a6a);
        }

        .inv-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            padding-bottom: 20px;
        }

        .inv-slot {
            aspect-ratio: 1;
            background: rgba(30, 50, 60, 0.4);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .inv-slot:hover {
            background: rgba(50, 70, 80, 0.5);
            border-color: #4a6a7a;
            transform: scale(1.05);
            z-index: 10;
        }

        .inv-slot.empty {
            background: rgba(20, 40, 50, 0.3);
            border-color: #2a4a5a;
        }

        .inv-slot.occupied {
            background: rgba(30, 40, 50, 0.3);
            border-color: #8a5a5a;
            position: relative;
        }

        .item-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 56px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-quantity {
            position: absolute;
            bottom: 3px;
            right: 3px;
            background: rgba(0, 0, 0, 0.8);
            color: #FFD700;
            font-size: 14px;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        }

        /* Category Icons */
        .category-bar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 60px;
        }

        .cat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5abaaa;
            font-size: 30px;
            transition: all 0.2s;
            position: relative;
        }

        .cat-icon:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
            transform: scale(1.1);
        }

        .cat-icon.active {
            background: linear-gradient(135deg, #4a7a6a, #3a6a5a);
            border-color: #5a8a7a;
        }

        .cat-icon.x-btn {
            background: linear-gradient(135deg, #3a5a5a, #2a4a4a);
        }

        /* Equipment Panel */
        .equipment-panel {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .equipment-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .equipment-toggle-btn {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            color: #5a7a8a;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .equipment-toggle-btn:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
        }
        
        .equipment-toggle-btn.active {
            background: linear-gradient(135deg, #4a7a6a, #3a6a5a);
            border-color: #5a8a7a;
            color: #5abaaa;
        }

        .equip-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .tools-grid {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .tools-grid.active {
            display: grid;
        }
        
        .equip-slot-spacer {
            /* Empty spacer for centered items */
        }

        .equip-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #2a4a5a, #1a3a4a);
            border: 2px solid #3a5a6a;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .equip-slot.empty {
            background: linear-gradient(135deg, #1a2a3a, #0a1a2a);
            border-color: #2a3a4a;
            opacity: 0.6;
        }

        .equip-slot.equipped {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a7a8a;
            opacity: 1;
        }

        .equip-slot.equipped::before {
            opacity: 1;
            color: #5abaaa;
        }

        .equip-slot.empty::after {
            content: attr(data-slot);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3a4a5a;
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.5;
        }

        .equip-slot:hover {
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            border-color: #4a6a7a;
            transform: scale(1.05);
        }

        .equip-slot::before {
            content: attr(data-icon);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #3a5a6a;
            font-size: 40px;
        }

        .equipment-bonuses {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2a4a5a;
        }

        .bonus-header {
            color: #8a9aaa;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bonus-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: #5a7a8a;
            font-size: 13px;
        }

        .bonus-icon {
            font-size: 16px;
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            background: linear-gradient(135deg, #2a3a4a, #1a2a3a);
            border: 2px solid #4a6a7a;
            border-radius: 6px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
        }

        .tooltip.show {
            display: block;
        }

        .tooltip-empty {
            color: #8a9aaa;
        }

        .tooltip-item {
            color: #5abaaa;
        }

        /* Login Modal */
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border: 3px solid #2a3a4a;
            border-radius: 15px;
            padding: 40px;
            width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .login-title {
            color: #5abaaa;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .google-login-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: #444;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .google-login-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .guest-login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3a5a6a, #2a4a5a);
            color: #8a9aaa;
            border: 2px solid #4a6a7a;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .guest-login-btn:hover {
            background: linear-gradient(135deg, #4a6a7a, #3a5a6a);
            border-color: #5a7a8a;
            color: #9aaaba;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .guest-warning {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 150, 50, 0.1);
            border: 2px solid rgba(255, 150, 50, 0.3);
            border-radius: 8px;
            color: #ffaa66;
            font-size: 13px;
            line-height: 1.5;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-left: auto;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #5abaaa;
        }

        .user-name {
            color: #5abaaa;
            font-weight: bold;
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255, 50, 50, 0.2);
            color: #ff6666;
            border: 1px solid #ff4444;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 50, 50, 0.4);
        }


        /* Grand Exchange Modal - OSRS Style */

        /* Modern Input Controls */
        .ge-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .ge-minus-btn, .ge-plus-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(80, 120, 200, 0.8) 0%, rgba(60, 90, 160, 0.8) 100%);
            border: 2px solid rgba(132, 194, 255, 0.5);
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .ge-minus-btn:hover, .ge-plus-btn:hover {
            background: linear-gradient(135deg, rgba(100, 140, 220, 0.9) 0%, rgba(80, 110, 180, 0.9) 100%);
            border-color: rgba(132, 194, 255, 0.8);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(132, 194, 255, 0.4);
        }

        .ge-form-input-center {
            flex: 1;
            padding: 12px;
            background: rgba(20, 30, 45, 0.8);
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
        }

        .ge-form-input-center:focus {
            outline: none;
            border-color: rgba(132, 194, 255, 0.8);
            background: rgba(30, 40, 60, 0.9);
            box-shadow: 0 0 20px rgba(132, 194, 255, 0.2);
        }

        .ge-price-btn-side {
            width: 35px;
            height: 35px;
            background: #3a2f1e;
            border: 2px solid #5a4d3a;
            color: #ff9933;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ge-price-btn-side:hover {
            background: #4a3f2e;
            border-color: #ff9933;
        }

        /* Selected Item Display */
        .ge-selected-item {
            background: linear-gradient(135deg, rgba(20, 30, 50, 0.7) 0%, rgba(10, 20, 40, 0.7) 100%);
            padding: 25px;
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 12px;
            margin-bottom: 25px;
            backdrop-filter: blur(5px);
        }

        .ge-item-display {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .ge-item-icon-large {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(50, 80, 120, 0.5) 0%, rgba(30, 60, 100, 0.5) 100%);
            border: 2px solid rgba(132, 194, 255, 0.4);
            border-radius: 12px;
            overflow: hidden;
        }

        .ge-item-icon-large img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .ge-item-info {
            flex: 1;
        }

        .ge-item-name-large {
            color: #84c2ff;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 5px rgba(132, 194, 255, 0.4);
        }

        .ge-item-available {
            color: #ffdd00;
            font-size: 16px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .ge-item-price-info {
            color: #7fff7f;
            font-size: 14px;
            font-weight: 500;
        }

        /* Total Display Modern Style */
        .ge-total-display-osrs {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6) 0%, rgba(10, 10, 20, 0.6) 100%);
            padding: 25px;
            margin-top: 25px;
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .ge-total-amount-large {
            color: #ffdd00;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 3px 10px rgba(255, 221, 0, 0.5);
            letter-spacing: 1px;
        }

        /* Action Buttons Modern Style */
        .ge-action-buttons-osrs {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .ge-back-btn {
            flex: 1;
            padding: 18px;
            background: linear-gradient(135deg, rgba(100, 100, 120, 0.8) 0%, rgba(70, 70, 90, 0.8) 100%);
            border: 2px solid rgba(150, 150, 180, 0.4);
            border-radius: 10px;
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .ge-back-btn:hover {
            background: linear-gradient(135deg, rgba(120, 120, 140, 0.9) 0%, rgba(90, 90, 110, 0.9) 100%);
            transform: translateX(-3px);
        }

        .ge-confirm-btn-osrs {
            flex: 2;
            padding: 18px;
            background: linear-gradient(135deg, rgba(50, 200, 100, 0.8) 0%, rgba(30, 150, 70, 0.8) 100%);
            border: 2px solid rgba(100, 255, 150, 0.5);
            border-radius: 10px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .ge-confirm-btn-osrs:hover {
            background: linear-gradient(135deg, rgba(70, 220, 120, 0.9) 0%, rgba(50, 170, 90, 0.9) 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(100, 255, 150, 0.4);
        }

        .ge-confirm-btn-osrs:disabled {
            background: linear-gradient(135deg, rgba(60, 60, 60, 0.6) 0%, rgba(40, 40, 40, 0.6) 100%);
            border-color: rgba(100, 100, 100, 0.3);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .ge-download-icon, .ge-upload-icon {
            font-size: 14px;
            opacity: 0.7;
        }

        #grandExchangeModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 1200px;
            height: 80vh;
            background: linear-gradient(145deg, #1e2630 0%, #141921 100%);
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 
                        0 0 80px rgba(132, 194, 255, 0.1),
                        inset 0 0 30px rgba(132, 194, 255, 0.05);
            display: none;
            flex-direction: column;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .ge-header {
            background: linear-gradient(135deg, rgba(100, 150, 255, 0.15) 0%, rgba(50, 100, 200, 0.1) 100%);
            border-bottom: 2px solid rgba(132, 194, 255, 0.3);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .ge-title {
            color: #ffffff;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(132, 194, 255, 0.6);
            letter-spacing: 1px;
        }

        .ge-close-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.8), rgba(200, 30, 30, 0.8));
            color: white;
            border: 2px solid rgba(255, 100, 100, 0.5);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 20px;
            transition: all 0.3s;
        }

        .ge-close-btn:hover {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.9), rgba(220, 50, 50, 0.9));
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 100, 100, 0.4);
        }

        .ge-collect-all-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, rgba(90, 200, 150, 0.8), rgba(50, 150, 100, 0.8));
            color: #ffffff;
            border: 2px solid rgba(100, 255, 200, 0.4);
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-right: auto;
            margin-left: 20px;
            transition: all 0.3s;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .ge-collect-all-btn:hover {
            background: linear-gradient(135deg, rgba(100, 220, 170, 0.9), rgba(60, 170, 120, 0.9));
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(100, 255, 200, 0.3);
        }

        .ge-collect-all-btn:active {
            transform: translateY(0);
        }

        .ge-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 15px;
            gap: 15px;
        }

        .ge-slots-container {
            width: 500px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(132, 194, 255, 0.2);
            overflow-y: auto;
        }

        .slots-section {
            margin-bottom: 30px;
        }

        .slots-section-title {
            color: #84c2ff;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 5px rgba(132, 194, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .offer-slots {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .offer-slot {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(30, 40, 60, 0.8) 0%, rgba(20, 30, 45, 0.8) 100%);
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }

        .offer-slot:hover {
            background: linear-gradient(135deg, rgba(50, 80, 120, 0.9) 0%, rgba(40, 60, 90, 0.9) 100%);
            border-color: rgba(132, 194, 255, 0.8);
            transform: scale(1.08);
            box-shadow: 0 5px 25px rgba(132, 194, 255, 0.4);
        }

        .offer-slot.empty::before {
            content: '+';
            font-size: 48px;
            color: rgba(132, 194, 255, 0.3);
            transition: all 0.3s;
        }

        .offer-slot.empty:hover::before {
            color: rgba(132, 194, 255, 0.8);
            transform: scale(1.2);
        }
        
        /* Hide ::before when slot has content */
        .offer-slot:not(.empty)::before {
            display: none;
        }

        .offer-slot.active {
            border-color: #00ff00;
            background: linear-gradient(135deg, #2a3f1e 0%, #1a2f0e 100%);
        }

        .offer-slot.completed {
            border-color: #ffff00;
            background: linear-gradient(135deg, #4a4f1e 0%, #3a3f0e 100%);
        }

        .offer-slot.partial {
            border-color: #ffa500;
            background: linear-gradient(135deg, #4a3f1e 0%, #3a2f0e 100%);
        }

        .slot-item-icon {
            font-size: 32px;
            margin-bottom: 5px;
            display: block;
        }

        .slot-item-name {
            font-size: 10px;
            color: #ff9933;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }

        .slot-quantity {
            font-size: 9px;
            color: #ffff00;
            display: block;
        }
        
        .slot-progress-bar {
            width: 90%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #3a2f1e;
            border-radius: 3px;
            margin: 3px 0;
            overflow: hidden;
        }
        
        .slot-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .slot-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            color: #00ff00;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .ge-details-container {
            flex: 1;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(132, 194, 255, 0.2);
            overflow-y: auto;
            position: relative;
        }

        .ge-details-content {
            display: none;
            height: 100%;
            padding: 15px;
        }

        .ge-details-content.active {
            display: block;
        }

        .details-title {
            color: #84c2ff;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: 0 2px 10px rgba(132, 194, 255, 0.5);
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(132, 194, 255, 0.2);
        }

        .offer-form {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border: 2px solid #5a4d3a;
            border-radius: 5px;
        }

        .ge-form-group {
            margin-bottom: 25px;
        }

        .ge-form-label {
            color: #a0c4ff;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px rgba(132, 194, 255, 0.3);
        }

        .ge-form-input {
            width: 100%;
            padding: 14px;
            background: rgba(20, 30, 45, 0.8);
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .ge-form-input:focus {
            outline: none;
            border-color: rgba(132, 194, 255, 0.8);
            background: rgba(30, 40, 60, 0.9);
            box-shadow: 0 0 20px rgba(132, 194, 255, 0.2);
        }

        .ge-item-search {
            width: 100%;
            padding: 14px;
            background: rgba(20, 30, 45, 0.8);
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .ge-item-results {
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid rgba(132, 194, 255, 0.3);
            border-radius: 10px;
            background: rgba(20, 30, 45, 0.8);
            backdrop-filter: blur(5px);
        }

        .ge-item-result {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(132, 194, 255, 0.1);
            transition: all 0.2s;
        }

        .ge-item-result:hover {
            background: rgba(50, 80, 120, 0.6);
            padding-left: 20px;
        }

        .ge-item-result-icon {
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ge-item-result-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
        }

        .ge-item-result-info {
            flex: 1;
        }

        .ge-item-result-name {
            color: #ff9933;
            font-weight: bold;
        }

        .ge-search-highlight {
            background: rgba(255, 215, 0, 0.4);
            padding: 2px 4px;
            border-radius: 3px;
            color: #FFD700;
            font-weight: bold;
        }

        .ge-item-result-price {
            color: #ffff00;
            font-size: 12px;
        }

        .ge-price-controls, .ge-quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .ge-price-btn, .ge-qty-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(70, 110, 170, 0.7) 0%, rgba(50, 80, 140, 0.7) 100%);
            border: 2px solid rgba(132, 194, 255, 0.4);
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            font-weight: bold;
            min-width: 60px;
            transition: all 0.3s;
            font-size: 14px;
        }

        .ge-price-btn:hover, .ge-qty-btn:hover {
            background: linear-gradient(135deg, rgba(90, 130, 190, 0.8) 0%, rgba(70, 100, 160, 0.8) 100%);
            border-color: rgba(132, 194, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(132, 194, 255, 0.3);
        }

        .ge-guide-price {
            color: #7fff7f;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 255, 0, 0.3);
        }

        .ge-total-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #5a4d3a;
            text-align: center;
        }

        .ge-total-label {
            color: #ff9933;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .ge-total-amount {
            color: #ffff00;
            font-size: 24px;
            font-weight: bold;
        }

        .ge-total-amount .gp {
            font-size: 14px;
            color: #ffa500;
        }

        .ge-offer-status-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border: 2px solid #5a4d3a;
            border-radius: 5px;
        }

        .ge-status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3a2d1a;
        }

        .ge-status-label {
            color: #ff9933;
            font-size: 14px;
        }

        .ge-status-value {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .ge-progress-bar {
            width: 100%;
            height: 20px;
            background: #2a1f0e;
            border: 2px solid #5a4d3a;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .ge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #00aa00 100%);
            transition: width 0.3s;
        }

        .ge-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .ge-confirm-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #00aa00 0%, #008800 100%);
            border: 2px solid #00ff00;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-confirm-btn:hover {
            background: linear-gradient(135deg, #00cc00 0%, #00aa00 100%);
        }

        .ge-confirm-btn:disabled {
            background: #3a3a3a;
            border-color: #5a5a5a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .ge-cancel-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #aa0000 0%, #880000 100%);
            border: 2px solid #ff0000;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }

        .ge-cancel-btn:hover {
            background: linear-gradient(135deg, #cc0000 0%, #aa0000 100%);
        }

        .ge-collect-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            border: 2px solid #ffcc00;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
            margin-top: 10px;
        }

        .ge-collect-btn:hover {
            background: linear-gradient(135deg, #ffcc00 0%, #ffaa00 100%);
        }

        .ge-empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #a0c4ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .ge-empty-state-icon {
            font-size: 72px;
            margin-bottom: 25px;
            opacity: 0.7;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .ge-empty-state-text {
            font-size: 20px;
            font-weight: 500;
            opacity: 0.9;
            text-shadow: 0 2px 5px rgba(132, 194, 255, 0.3);
        }

        .ge-tax-notice {
            color: #ffa500;
            font-size: 12px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #ffa500;
            border-radius: 3px;
        }

        /* Market Wiki Styles */
        .wiki-filter-btn.active {
            box-shadow: 0 0 15px rgba(212, 167, 106, 0.6);
            transform: scale(1.05);
            transition: all 0.2s;
        }

        .wiki-period-btn.active {
            background: #7a6a5a !important;
            border: 2px solid #9a8a7a !important;
            color: #FFD700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            transition: all 0.2s;
        }

        .wiki-filter-btn:hover, .wiki-period-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
            transition: all 0.2s;
        }

        /* Search Input Styles */
        #wikiSearchInput:focus {
            border-color: #d4a76a !important;
            box-shadow: 0 0 10px rgba(212, 167, 106, 0.5);
            outline: none;
        }

        #wikiSearchInput::placeholder {
            color: #6a5a4a;
        }

        #clearSearchBtn:hover {
            background: #8a6a6a !important;
        }

        /* Activity Tracker Pulse Animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 8px #5abaaa;
            }
            50% {
                opacity: 0.6;
                box-shadow: 0 0 15px #5abaaa;
            }
        }

        /* Clue Scroll UI */
        .clue-scroll-panel {
            position: absolute;
            top: 320px;
            right: 30px;
            z-index: 100;
            background: linear-gradient(135deg, rgba(60, 50, 40, 0.98) 0%, rgba(40, 30, 20, 0.98) 100%);
            border: 3px solid #d4a76a;
            border-radius: 12px;
            padding: 0;
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 8px 20px rgba(212, 167, 106, 0.4), inset 0 0 30px rgba(212, 167, 106, 0.1);
            display: none;
            overflow: hidden;
        }

        .clue-scroll-panel.active {
            display: block;
            animation: clueAppear 0.4s ease-out;
        }

        .clue-scroll-panel.minimized .clue-scroll-body,
        .clue-scroll-panel.minimized .clue-scroll-footer {
            display: none;
        }

        .clue-scroll-panel.minimized {
            min-width: 200px;
            max-width: 200px;
        }

        @keyframes clueAppear {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .clue-scroll-header {
            background: linear-gradient(135deg, #d4a76a 0%, #b8935a 100%);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #8a6a3a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            cursor: grab;
        }

        .clue-scroll-header:active {
            cursor: grabbing;
        }

        .clue-scroll-header .drag-indicator {
            color: #4a3a2a;
            font-size: 10px;
            margin-right: 5px;
        }

        .clue-minimize-btn {
            margin-left: auto;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #6a4a2a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #2a1a0a;
            font-weight: bold;
        }

        .clue-minimize-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: #8a6a4a;
            transform: scale(1.1);
        }

        .clue-scroll-icon {
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #6a4a2a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .clue-scroll-title {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .clue-scroll-name {
            color: #2a1a0a;
            font-size: 15px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.3);
        }

        .clue-scroll-subtitle {
            color: #4a3a2a;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clue-scroll-body {
            padding: 16px;
            background: linear-gradient(180deg, rgba(50, 40, 30, 0.5) 0%, rgba(30, 20, 10, 0.5) 100%);
        }

        .clue-scroll-tasks {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .clue-task {
            background: linear-gradient(135deg, rgba(40, 30, 20, 0.8) 0%, rgba(30, 20, 10, 0.8) 100%);
            border: 2px solid #5a4a3a;
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .clue-task::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #8a6a4a;
            transition: all 0.3s;
        }

        .clue-task.completed {
            border-color: #5abaaa;
            background: linear-gradient(135deg, rgba(26, 50, 40, 0.8) 0%, rgba(15, 30, 25, 0.8) 100%);
        }

        .clue-task.completed::before {
            background: #5abaaa;
            box-shadow: 0 0 10px #5abaaa;
        }

        .clue-task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #6a5a4a;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .clue-task.completed .clue-task-checkbox {
            background: #5abaaa;
            border-color: #5abaaa;
            box-shadow: 0 0 10px rgba(90, 186, 170, 0.5);
        }

        .clue-task-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .clue-task-number {
            color: #d4a76a;
            font-size: 9px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clue-task.completed .clue-task-number {
            color: #5abaaa;
        }

        .clue-task-description {
            color: #cad2da;
            font-size: 13px;
            font-weight: 500;
        }

        .clue-task.completed .clue-task-description {
            color: #8ab0a0;
            text-decoration: line-through;
            opacity: 0.7;
        }

        .clue-scroll-footer {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(20, 10, 5, 0.9) 100%);
            border-top: 2px solid #4a3a2a;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .clue-progress-bar-container {
            width: 100%;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #5a4a3a;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .clue-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4a76a 0%, #FFD700 100%);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(212, 167, 106, 0.6);
        }

        .clue-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
            letter-spacing: 0.5px;
        }

        .clue-reward-hint {
            color: #FFD700;
            font-size: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }

        @keyframes scrollShine {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        .clue-scroll-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: scrollShine 3s infinite;
        }

        /* Clue Chest Reward Popup */
        #clueRewardModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        #clueRewardModal.active {
            display: flex;
        }

        .clue-reward-container {
            background: linear-gradient(135deg, #c4a672 0%, #a08556 100%);
            border: 4px solid #8b6f47;
            border-radius: 12px;
            padding: 0;
            width: 500px;
            max-width: 90vw;
            box-shadow: 0 0 40px rgba(212, 167, 106, 0.6), inset 0 0 30px rgba(0, 0, 0, 0.2);
            animation: rewardAppear 0.4s ease-out;
        }

        @keyframes rewardAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }


        .clue-reward-header {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5437 100%);
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid #5a4a3a;
        }

        .clue-reward-title {
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .clue-reward-subtitle {
            color: #d4a76a;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clue-reward-body {
            padding: 30px 20px;
            background: linear-gradient(180deg, rgba(180, 160, 120, 0.3) 0%, rgba(140, 120, 90, 0.3) 100%);
        }

        .clue-reward-items {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .clue-reward-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, rgba(40, 30, 20, 0.8) 0%, rgba(30, 20, 10, 0.8) 100%);
            border: 3px solid #6a5a4a;
            border-radius: 10px;
            padding: 15px;
            min-width: 120px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .clue-reward-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            animation: itemGlow 2s ease-in-out infinite;
        }

        @keyframes itemGlow {
            0%, 100% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        .clue-reward-item:hover {
            transform: translateY(-5px) scale(1.05);
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .clue-reward-item-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.3));
        }

        .clue-reward-item-name {
            color: #FFD700;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .clue-reward-item-quantity {
            color: #5abaaa;
            font-size: 16px;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .clue-reward-footer {
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(30, 20, 10, 0.9) 0%, rgba(20, 10, 5, 0.9) 100%);
            border-top: 2px solid #5a4a3a;
            border-radius: 0 0 8px 8px;
        }

        .clue-reward-ok-btn {
            padding: 12px 40px;
            background: linear-gradient(135deg, #5a8a4a 0%, #4a7a3a 100%);
            border: 3px solid #6a9a5a;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #3a5a2a;
            position: relative;
            top: 0;
        }

        .clue-reward-ok-btn:hover {
            background: linear-gradient(135deg, #6a9a5a 0%, #5a8a4a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3a5a2a;
        }

        .clue-reward-ok-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3a5a2a;
        }

        /* Raid Lobby Styles */
        #raidLobbyModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .lobby-container {
            background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
            border: 2px solid #2a3a4a;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 0;
        }

        .lobby-header {
            background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%);
            padding: 20px 30px;
            border-bottom: 2px solid #3a4a5a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .lobby-title {
            font-size: 26px;
            font-weight: bold;
            color: #5abaaa;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .lobby-close-btn {
            background: #ff4444;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .lobby-close-btn:hover {
            background: #ff6666;
            transform: scale(1.1);
        }

        .lobby-content {
            padding: 30px;
        }

        .lobby-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .lobby-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4a9a8a, #3a8a7a);
            color: white;
            border: 2px solid #5abaaa;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
        }

        .lobby-btn:hover {
            background: linear-gradient(135deg, #5abaaa, #4a9a8a);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 186, 170, 0.3);
        }

        .lobby-btn.secondary {
            background: linear-gradient(135deg, #6a5a4a, #5a4a3a);
            border-color: #7a6a5a;
        }

        .lobby-btn.secondary:hover {
            background: linear-gradient(135deg, #7a6a5a, #6a5a4a);
        }

        .lobby-section {
            margin-bottom: 30px;
        }

        .lobby-section-title {
            font-size: 20px;
            color: #5abaaa;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 2px solid #2a3a4a;
            padding-bottom: 10px;
        }

        .lobbies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .lobby-card {
            background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%);
            border: 2px solid #3a4a5a;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lobby-card:hover {
            border-color: #5abaaa;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(90, 186, 170, 0.2);
        }

        .lobby-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lobby-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .lobby-card-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .lobby-card-status.waiting {
            background: #4a8a5a;
            color: #6afa6a;
        }

        .lobby-card-status.in-progress {
            background: #8a7a4a;
            color: #fad46a;
        }

        .lobby-card-status.full {
            background: #8a4a4a;
            color: #fa6a6a;
        }

        .lobby-card-info {
            color: #8a9aaa;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .lobby-card-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .lobby-card-leader {
            color: #5abaaa;
            font-weight: bold;
        }

        .lobby-card-members {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .lobby-member-badge {
            background: rgba(90, 186, 170, 0.2);
            border: 1px solid #5abaaa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #5abaaa;
        }

        .lobby-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .lobby-card-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #5abaaa;
            background: rgba(90, 186, 170, 0.1);
            color: #5abaaa;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .lobby-card-btn:hover {
            background: rgba(90, 186, 170, 0.3);
        }

        .lobby-card-btn.join {
            background: linear-gradient(135deg, #4a9a8a, #3a8a7a);
            color: white;
        }

        .lobby-card-btn.join:hover {
            background: linear-gradient(135deg, #5abaaa, #4a9a8a);
        }

        /* Create Lobby Form */
        .create-lobby-form {
            background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%);
            border: 2px solid #3a4a5a;
            border-radius: 10px;
            padding: 25px;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #8a9aaa;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3a4a5a;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #5abaaa;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3a4a5a;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .form-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .form-btn.primary {
            background: linear-gradient(135deg, #4a9a8a, #3a8a7a);
            color: white;
        }

        .form-btn.primary:hover {
            background: linear-gradient(135deg, #5abaaa, #4a9a8a);
            transform: translateY(-2px);
        }

        .form-btn.secondary {
            background: linear-gradient(135deg, #6a5a4a, #5a4a3a);
            color: white;
        }

        .form-btn.secondary:hover {
            background: linear-gradient(135deg, #7a6a5a, #6a5a4a);
        }

        .no-lobbies {
            text-align: center;
            padding: 60px 20px;
            color: #6a7a8a;
        }

        .no-lobbies-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-lobbies-text {
            font-size: 18px;
        }

        /* Active Lobby View */
        .active-lobby-view {
            background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%);
            border: 2px solid #5abaaa;
            border-radius: 10px;
            padding: 25px;
        }

        .active-lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3a4a5a;
        }

        .active-lobby-name {
            font-size: 24px;
            font-weight: bold;
            color: #5abaaa;
        }

        .active-lobby-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .member-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3a4a5a;
            border-radius: 8px;
            padding: 15px;
        }

        .member-card.leader {
            border-color: #FFD700;
        }

        .member-name {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .member-role {
            font-size: 12px;
            color: #8a9aaa;
        }

        .member-role.leader {
            color: #FFD700;
        }

        .lobby-chat {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #3a4a5a;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .lobby-chat-message {
            margin-bottom: 10px;
            color: #cad2da;
            font-size: 14px;
        }

        .lobby-chat-sender {
            color: #5abaaa;
            font-weight: bold;
        }

        /* Building Contribution Sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #1a2a3a 0%, #2a3a4a 100%);
            outline: none;
            border-radius: 4px;
            border: 1px solid #2a3a4a;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #5abaaa, #4a9a8a);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #6acaba;
            box-shadow: 0 2px 8px rgba(90, 186, 170, 0.4);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: linear-gradient(135deg, #6acaba, #5abaaa);
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(90, 186, 170, 0.6);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #5abaaa, #4a9a8a);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #6acaba;
            box-shadow: 0 2px 8px rgba(90, 186, 170, 0.4);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: linear-gradient(135deg, #6acaba, #5abaaa);
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(90, 186, 170, 0.6);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #4a9a8a 0%, #5abaaa 100%);
            border-radius: 4px;
        }

        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #4a9a8a 0%, #5abaaa 100%);
            border-radius: 4px;
        }
        
        /* Combat Prep Modal Button Hover Effects */
        #leavePrepBtn:hover {
            background: linear-gradient(135deg, #ff7b7b, #ff5555) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        #createPartyBtn:hover {
            background: linear-gradient(135deg, #6a8aaa, #5a7a9a) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(90, 122, 154, 0.4);
        }
        
        #startFightBtn:hover {
            background: linear-gradient(135deg, #5aaa9a, #4a9a8a) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 154, 138, 0.4);
        }
        
        #leavePrepBtn:active,
        #createPartyBtn:active,
        #startFightBtn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Left Sidebar -->
        <div id="leftSidebar">
            <div class="sidebar-toggle">âŸ©</div>
            
            <div class="menu-section">
                <div class="menu-header">Account</div>
                <div class="menu-item">
                    <span class="menu-icon">ðŸ </span>
                    <span>Profile</span>
                </div>
                <div class="menu-item active">
                    <span class="menu-icon">ðŸŽ’</span>
                    <span>Inventory</span>
                </div>
                <div class="menu-item" id="buildMenuItem">
                    <span class="menu-icon">ðŸ—ï¸</span>
                    <span>Build</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Community</div>
                <div class="menu-item">
                    <span class="menu-icon">ðŸ’±</span>
                    <span>Player market</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Activities</div>
                <div class="menu-item" data-room="raids">
                    <span class="menu-icon">ðŸ°</span>
                    <span>Raids</span>
                </div>
                <div class="menu-item" data-room="combat">
                    <span class="menu-icon">âš”ï¸</span>
                    <span>Combat</span>
                </div>

                <div class="menu-item" data-room="crafting">
                    <span class="menu-icon">ðŸ”¨</span>
                    <span>Crafting</span>
                </div>

                <div class="menu-item" data-room="woodcutting">
                    <span class="menu-icon">ðŸª“</span>
                    <span>Woodcutting</span>
                </div>
                <div class="menu-item" data-room="fishing">
                    <span class="menu-icon">ðŸŽ£</span>
                    <span>Fishing</span>
                </div>
                <div class="menu-item" data-room="mining">
                    <span class="menu-icon">â›ï¸</span>
                    <span>Mining</span>
                </div>
                <div class="menu-item" data-room="cooking">
                    <span class="menu-icon">ðŸ³</span>
                    <span>Cooking</span>
                </div>
                <div class="menu-item" data-room="plundering">
                    <span class="menu-icon">ðŸ’°</span>
                    <span>Plundering</span>
                </div>
                <div class="menu-item" data-room="agility">
                    <span class="menu-icon">ðŸƒ</span>
                    <span>Agility</span>
                </div>
                <div class="menu-item" data-room="smithwright">
                    <span class="menu-icon">ðŸ”¥</span>
                    <span>Smithwright</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-header">Skills</div>
                <div class="skills-grid">
                    <div class="skill-item" title="Hitpoints">
                        <span class="skill-icon">â¤ï¸</span>
                        <span class="skill-level">10</span>
                    </div>
                    <div class="skill-item" title="Attack">
                        <span class="skill-icon">âš”ï¸</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Mining">
                        <span class="skill-icon">â›ï¸</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Strength">
                        <span class="skill-icon">ðŸ’ª</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Agility">
                        <span class="skill-icon">ðŸƒ</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Defence">
                        <span class="skill-icon">ðŸ›¡ï¸</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Fishing">
                        <span class="skill-icon">ðŸŽ£</span>
                        <span class="skill-level">1</span>
                    </div>
                    <div class="skill-item" title="Ranged">
                        <span class="skill-icon">ðŸ¹</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Cooking">
                        <span class="skill-icon">ðŸ³</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Crafting">
                        <span class="skill-icon">ðŸ§µ</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Carpentry">
                        <span class="skill-icon">ðŸ”¨</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Magic">
                        <span class="skill-icon">âœ¨</span>
                        <span class="skill-level">1</span>
                    </div>

                    <div class="skill-item" title="Woodcutting">
                        <span class="skill-icon">ðŸª“</span>
                        <span class="skill-level">1</span>
                    </div>


                    <div class="skill-item" title="Plundering">
                        <span class="skill-icon">ðŸ’°</span>
                        <span class="skill-level">1</span>
                    </div>


                    <div class="skill-item" title="Combat">
                        <span class="skill-icon">âš”ï¸</span>
                        <span class="skill-level">3</span>
                    </div>
                </div>
                <div class="total-level">Total: <span id="totalLevel">34</span></div>
            </div>
        </div>

        <!-- Top Control Panel -->
        <div id="topBar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="resource-display">
                    <div class="coin-icon"></div>
                    <span style="color: #FFD700; font-weight: bold; font-size: 18px; margin-left: 8px;" id="goldAmount">100,965</span>
                </div>
                <div class="resource-display">
                    <span style="color: #5abaaa; font-size: 16px; font-weight: bold;" id="currentRoom">Woodcutting Area</span>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
                <div id="autoResumeIndicator" style="display: none; background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 180, 0, 0.3)); border: 2px solid #FFD700; border-radius: 12px; padding: 6px 16px; font-size: 13px; font-weight: bold; color: #FFD700; box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4); animation: pulse 1.5s infinite;">
                    â±ï¸ Auto-resume: <span id="autoResumeCountdown">3</span>s
                </div>
                <button class="afk-toggle active" id="afkToggle">
                    <span id="afkModeText">AFK Mode</span>
                </button>
            </div>
        </div>

        <!-- Modern Activity Tracker - Separate Overlay -->
        <div id="activityTracker" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: linear-gradient(135deg, rgba(26, 35, 50, 0.98) 0%, rgba(15, 22, 32, 0.98) 100%); border: 2px solid #2a3a4a; border-radius: 12px; padding: 12px 16px; min-width: 280px; max-width: 320px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);">
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Activity Header (Draggable) -->
                <div id="trackerDragHandle" style="display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(90, 186, 170, 0.3); cursor: grab;">
                    <div style="width: 6px; height: 6px; border-radius: 50%; background: #5abaaa; box-shadow: 0 0 8px #5abaaa; animation: pulse 2s infinite;"></div>
                    <div style="color: #FFD700; font-size: 13px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;" id="activityName">Woodcutting</div>
                    <div style="margin-left: auto; color: #8a9aaa; font-size: 10px;">â‹®â‹®</div>
                </div>
                
                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <!-- Total Skill XP -->
                    <div style="background: linear-gradient(135deg, rgba(90, 186, 170, 0.15) 0%, rgba(90, 186, 170, 0.05) 100%); border: 1px solid rgba(90, 186, 170, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Total XP</div>
                        <div style="color: #5abaaa; font-size: 15px; font-weight: bold;" id="totalSkillXP">0</div>
                    </div>
                    
                    <!-- Nodes Collected -->
                    <div style="background: linear-gradient(135deg, rgba(0, 191, 255, 0.15) 0%, rgba(0, 191, 255, 0.05) 100%); border: 1px solid rgba(0, 191, 255, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Nodes</div>
                        <div style="color: #00BFFF; font-size: 15px; font-weight: bold;" id="sessionItems">0</div>
                    </div>
                    
                    <!-- XP per Hour -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.05) 100%); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">XP/HR</div>
                        <div style="color: #FFD700; font-size: 15px; font-weight: bold;"><span id="xpPerHour">0</span></div>
                    </div>
                    
                    <!-- Items per Hour -->
                    <div style="background: linear-gradient(135deg, rgba(170, 90, 250, 0.15) 0%, rgba(170, 90, 250, 0.05) 100%); border: 1px solid rgba(170, 90, 250, 0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #8a9aaa; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Items/HR</div>
                        <div style="color: #aa5afa; font-size: 15px; font-weight: bold;"><span id="itemsPerHour">0</span></div>
                    </div>
                </div>
                
                <!-- Level Progress Bar -->
                <div id="levelProgressContainer" style="margin-top: 8px; padding: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid rgba(90, 186, 170, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="color: #5abaaa; font-size: 11px; font-weight: bold;">
                            <span id="currentLevel">Lvl 1</span>
                        </div>
                        <div style="color: #FFD700; font-size: 10px; font-weight: bold;">
                            <span id="levelProgress">0%</span> to <span id="nextLevel">Lvl 2</span>
                        </div>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(0, 0, 0, 0.5); border-radius: 6px; overflow: hidden; border: 1px solid rgba(90, 186, 170, 0.3);">
                        <div id="levelProgressBar" style="height: 100%; background: linear-gradient(90deg, #5abaaa 0%, #FFD700 100%); width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="color: #8a9aaa; font-size: 9px; margin-top: 3px; text-align: center;">
                        <span id="xpToNextLevel">0 XP to level</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clue Scroll Panels (T1-T5) -->
        <div id="clueScrollPanel_T1" class="clue-scroll-panel" style="top: 320px; right: 30px;">
            <div class="clue-scroll-header">
                <div class="drag-indicator">â‹®â‹®</div>
                <div class="clue-scroll-icon">ðŸ“œ</div>
                <div class="clue-scroll-title">
                    <div class="clue-scroll-name">T1 Clue Scroll</div>
                    <div class="clue-scroll-subtitle">Complete all tasks</div>
                </div>
                <div class="clue-minimize-btn" data-tier="T1">âˆ’</div>
            </div>
            
            <div class="clue-scroll-body">
                <div class="clue-scroll-tasks" id="clueScrollTasks_T1">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
            
            <div class="clue-scroll-footer">
                <div class="clue-progress-bar-container">
                    <div class="clue-progress-bar" id="clueProgressBar_T1"></div>
                    <div class="clue-progress-text" id="clueProgressText_T1">0/2 Complete</div>
                </div>
                <div class="clue-reward-hint">ðŸŽ Complete for rewards!</div>
            </div>
        </div>

        <div id="clueScrollPanel_T2" class="clue-scroll-panel" style="top: 320px; right: 360px;">
            <div class="clue-scroll-header">
                <div class="drag-indicator">â‹®â‹®</div>
                <div class="clue-scroll-icon">ðŸ“œ</div>
                <div class="clue-scroll-title">
                    <div class="clue-scroll-name">T2 Clue Scroll</div>
                    <div class="clue-scroll-subtitle">Complete all tasks</div>
                </div>
                <div class="clue-minimize-btn" data-tier="T2">âˆ’</div>
            </div>
            
            <div class="clue-scroll-body">
                <div class="clue-scroll-tasks" id="clueScrollTasks_T2">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
            
            <div class="clue-scroll-footer">
                <div class="clue-progress-bar-container">
                    <div class="clue-progress-bar" id="clueProgressBar_T2"></div>
                    <div class="clue-progress-text" id="clueProgressText_T2">0/2 Complete</div>
                </div>
                <div class="clue-reward-hint">ðŸŽ Complete for rewards!</div>
            </div>
        </div>

        <div id="clueScrollPanel_T3" class="clue-scroll-panel" style="top: 320px; right: 690px;">
            <div class="clue-scroll-header">
                <div class="drag-indicator">â‹®â‹®</div>
                <div class="clue-scroll-icon">ðŸ“œ</div>
                <div class="clue-scroll-title">
                    <div class="clue-scroll-name">T3 Clue Scroll</div>
                    <div class="clue-scroll-subtitle">Complete all tasks</div>
                </div>
                <div class="clue-minimize-btn" data-tier="T3">âˆ’</div>
            </div>
            
            <div class="clue-scroll-body">
                <div class="clue-scroll-tasks" id="clueScrollTasks_T3">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
            
            <div class="clue-scroll-footer">
                <div class="clue-progress-bar-container">
                    <div class="clue-progress-bar" id="clueProgressBar_T3"></div>
                    <div class="clue-progress-text" id="clueProgressText_T3">0/2 Complete</div>
                </div>
                <div class="clue-reward-hint">ðŸŽ Complete for rewards!</div>
            </div>
        </div>

        <div id="clueScrollPanel_T4" class="clue-scroll-panel" style="top: 560px; right: 30px;">
            <div class="clue-scroll-header">
                <div class="drag-indicator">â‹®â‹®</div>
                <div class="clue-scroll-icon">ðŸ“œ</div>
                <div class="clue-scroll-title">
                    <div class="clue-scroll-name">T4 Clue Scroll</div>
                    <div class="clue-scroll-subtitle">Complete all tasks</div>
                </div>
                <div class="clue-minimize-btn" data-tier="T4">âˆ’</div>
            </div>
            
            <div class="clue-scroll-body">
                <div class="clue-scroll-tasks" id="clueScrollTasks_T4">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
            
            <div class="clue-scroll-footer">
                <div class="clue-progress-bar-container">
                    <div class="clue-progress-bar" id="clueProgressBar_T4"></div>
                    <div class="clue-progress-text" id="clueProgressText_T4">0/2 Complete</div>
                </div>
                <div class="clue-reward-hint">ðŸŽ Complete for rewards!</div>
            </div>
        </div>

        <div id="clueScrollPanel_T5" class="clue-scroll-panel" style="top: 560px; right: 360px;">
            <div class="clue-scroll-header">
                <div class="drag-indicator">â‹®â‹®</div>
                <div class="clue-scroll-icon">ðŸ“œ</div>
                <div class="clue-scroll-title">
                    <div class="clue-scroll-name">T5 Clue Scroll</div>
                    <div class="clue-scroll-subtitle">Complete all tasks</div>
                </div>
                <div class="clue-minimize-btn" data-tier="T5">âˆ’</div>
            </div>
            
            <div class="clue-scroll-body">
                <div class="clue-scroll-tasks" id="clueScrollTasks_T5">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
            
            <div class="clue-scroll-footer">
                <div class="clue-progress-bar-container">
                    <div class="clue-progress-bar" id="clueProgressBar_T5"></div>
                    <div class="clue-progress-text" id="clueProgressText_T5">0/2 Complete</div>
                </div>
                <div class="clue-reward-hint">ðŸŽ Complete for rewards!</div>
            </div>
        </div>

        <!-- Clue Chest Reward Modal -->
        <div id="clueRewardModal">
            <div class="clue-reward-container">
                <div class="clue-reward-header">
                    <div class="clue-reward-title" id="clueRewardTitle">CLUE SCROLL COMPLETE!</div>
                    <div class="clue-reward-subtitle">Your Rewards</div>
                </div>
                
                <div class="clue-reward-body">
                    <div class="clue-reward-items" id="clueRewardItems">
                        <!-- Reward items will be added here dynamically -->
                    </div>
                </div>
                
                <div class="clue-reward-footer">
                    <button class="clue-reward-ok-btn" id="clueRewardOkBtn">OK</button>
                </div>
            </div>
        </div>

        <!-- Inventory UI -->
        <div id="inventoryUI">
            
            <div class="inv-header">
                <div class="inv-header-left">
                    <div class="gold-display">
                        <div class="coin-icon"></div>
                        <span class="gold-amount" id="invGold">100,965</span>
                    </div>
                    <div class="space-display">
                        Space: <span id="invSpace">38</span>/98
                    </div>
                </div>
                <div class="inv-header-right">
                    <button class="inv-header-btn" id="sortBtn">Sort</button>
                    <button class="inv-header-btn manage-btn">
                        <span>âš™ï¸</span>
                        <span>Manage</span>
                    </button>
                    <button class="close-btn" id="closeInventory">âœ–</button>
                </div>
            </div>
            
            <div class="inv-search-bar">
                <input type="text" class="search-input" placeholder="Search for an item...">
                <button class="search-btn">Search</button>
                <button class="search-btn">Reset</button>
            </div>

            <div class="inv-body">
                <div class="inv-main">
                    <div class="inv-grid-container">
                        <div class="inv-grid" id="inventoryGrid"></div>
                    </div>
                    
                    <div class="category-bar">
                        <div class="cat-icon x-btn" title="Clear all">âœ–</div>
                        <div class="cat-icon" title="Armor">ðŸ‘”</div>
                        <div class="cat-icon" title="Weapons">âš”ï¸</div>
                        <div class="cat-icon" title="Tools">ðŸ”¨</div>
                        <div class="cat-icon" title="Materials">ðŸ“¦</div>
                        <div class="cat-icon" title="Fish">ðŸŸ</div>
                        <div class="cat-icon" title="Food">ðŸ–</div>
                        <div class="cat-icon" title="Potions">ðŸ§ª</div>
                    </div>
                </div>

                <div class="equipment-panel">
                    <!-- Toggle Buttons -->
                    <div class="equipment-toggle">
                        <button class="equipment-toggle-btn active" id="gearToggleBtn">âš”ï¸ Gear</button>
                        <button class="equipment-toggle-btn" id="toolsToggleBtn">ðŸ”¨ Tools</button>
                    </div>
                
                    <!-- Gear Grid -->
                    <div class="equip-grid" id="gearGrid">
                        <!-- Row 1: Empty -->
                        <div class="equip-slot-spacer"></div>
                        <div class="equip-slot-spacer"></div>
                        <div class="equip-slot-spacer"></div>
                        
                        <!-- Row 2: Amulet, Head, Cape -->
                        <div class="equip-slot empty" data-slot="Amulet" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Head" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Cape" data-icon=""></div>
                        
                        <!-- Row 3: Weapon, Chest, Arrows -->
                        <div class="equip-slot empty" data-slot="Weapon" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Chest" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Arrows" data-icon=""></div>
                        
                        <!-- Row 4: Gloves, Legs, Ring -->
                        <div class="equip-slot empty" data-slot="Gloves" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Legs" data-icon=""></div>
                        <div class="equip-slot empty" data-slot="Ring" data-icon=""></div>
                        
                        <!-- Row 5: Boots (centered) -->
                        <div class="equip-slot-spacer"></div>
                        <div class="equip-slot empty" data-slot="Boots" data-icon=""></div>
                        <div class="equip-slot-spacer"></div>
                    </div>
                    
                    <!-- Tools Grid -->
                    <div class="tools-grid" id="toolsGrid">
                        <!-- Row 1: Woodcutting, Mining, Fishing -->
                        <div class="equip-slot empty" data-slot="Axe" data-icon="ðŸª“" data-skill="woodcutting"></div>
                        <div class="equip-slot empty" data-slot="Pickaxe" data-icon="â›ï¸" data-skill="mining"></div>
                        <div class="equip-slot empty" data-slot="Fishing Rod" data-icon="ðŸŽ£" data-skill="fishing"></div>
                        
                        <!-- Row 2: Cooking, Plundering, Carpentry -->
                        <div class="equip-slot empty" data-slot="Cooking Utensils" data-icon="ðŸ³" data-skill="cooking"></div>
                        <div class="equip-slot empty" data-slot="Lockpick" data-icon="ðŸ—ï¸" data-skill="plundering"></div>
                        <div class="equip-slot empty" data-slot="Hammer" data-icon="ðŸ”¨" data-skill="carpentry"></div>
                        
                        <!-- Row 3: Crafting, Smithwright, Agility -->
                        <div class="equip-slot empty" data-slot="Needle" data-icon="ðŸª¡" data-skill="crafting"></div>
                        <div class="equip-slot empty" data-slot="Tongs" data-icon="ðŸ”§" data-skill="smithwright"></div>
                        <div class="equip-slot empty" data-slot="Grappling Hook" data-icon="ðŸª" data-skill="agility"></div>
                    </div>

                    <div class="equipment-bonuses">
                        <div class="bonus-header" id="bonusHeader">EQUIPMENT BONUSES</div>
                        <div id="gearBonuses">
                            <div class="bonus-stat">
                                <span class="bonus-icon">âš”ï¸</span>
                                <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                            </div>
                            <div class="bonus-stat">
                                <span class="bonus-icon">ðŸ¹</span>
                                <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                            </div>
                            <div class="bonus-stat">
                                <span class="bonus-icon">ðŸ”®</span>
                                <span style="font-size: 12px;">Str: 0 | Acc: 0 | Def: 0</span>
                            </div>
                        </div>
                        <div id="toolBonuses" style="display: none;">
                            <!-- Tool bonuses will be dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-container">
            <div class="login-title">ðŸŽ® MMORPG Login</div>
            <button class="google-login-btn" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/>
                    <path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/>
                    <path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/>
                    <path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/>
                </svg>
                Sign in with Google
            </button>
            
            <div style="margin: 20px 0; color: #6a8a9a; font-size: 14px;">- OR -</div>
            
            <button class="guest-login-btn" id="guestLoginBtn">
                ðŸ‘¤ Play as Guest
            </button>
            
            <div class="guest-warning">
                ðŸ§ª Testing Mode: Full access to all features including Player Market and Raids!
            </div>
        </div>
    </div>

    <!-- Grand Exchange Modal -->
    <div id="grandExchangeModal">
        <div class="ge-header">
            <div class="ge-title">ðŸ“œ Grand Exchange</div>
            <button class="ge-collect-all-btn" onclick="openMarketWiki()" style="margin-right: 10px; background: linear-gradient(135deg, #d4a76a 0%, #b8915a 100%);">ðŸ“Š Market Wiki</button>
            <button class="ge-collect-all-btn" id="collectAllOffers">Collect All</button>
            <button class="ge-collect-all-btn" id="cancelAllOffers" style="margin-left: 5px; margin-right: 10px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5555 100%);">Cancel All</button>
            <button class="ge-close-btn" id="closeGE">âœ–</button>
        </div>

        <div class="ge-content">
            <!-- Left Side - Offer Slots -->
            <div class="ge-slots-container">
                <div class="slots-section">
                    <div class="slots-section-title">ðŸ”½ Buy Offers</div>
                    <div class="offer-slots" id="buySlots">
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="buy" data-slot-index="3"></div>
                    </div>
                </div>

                <div class="slots-section">
                    <div class="slots-section-title">ðŸ”¼ Sell Offers</div>
                    <div class="offer-slots" id="sellSlots">
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="3"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Offer Details -->
            <div class="ge-details-container">
                <!-- Empty State -->
                <div class="ge-details-content active" id="emptyState">
                    <div class="ge-empty-state">
                        <div class="ge-empty-state-icon">ðŸ“¦</div>
                        <div class="ge-empty-state-text">Select an offer slot to buy or sell items</div>
                    </div>
                </div>

                <!-- Create Buy Offer -->
                <div class="ge-details-content" id="createBuyOffer">
                    <div class="details-title">ðŸ”½ Buy offer <span class="ge-download-icon">â¬‡ï¸</span></div>
                    
                    <!-- Item Display -->
                    <div class="ge-selected-item" id="buySelectedItem" style="display: none;">
                        <div class="ge-item-display">
                            <div class="ge-item-icon-large" id="buyItemIcon">ðŸªµ</div>
                            <div class="ge-item-info">
                                <div class="ge-item-name-large" id="buyItemName">Select an item</div>
                                <div class="ge-item-price-info" id="buyItemPriceInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="ge-form-group" id="buySearchGroup">
                        <label class="ge-form-label">Choose item:</label>
                        <input type="text" class="ge-item-search" id="buyItemSearch" placeholder="Start typing...">
                        <div class="ge-item-results" id="buyItemResults"></div>
                    </div>

                    <!-- Quantity Controls (OSRS Style) -->
                    <div class="ge-form-group" id="buyQuantityGroup" style="display: none;">
                        <label class="ge-form-label">Quantity:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="buyQtyMinus">âˆ’</button>
                            <input type="number" class="ge-form-input-center" id="buyQuantity" min="1" value="1">
                            <button class="ge-plus-btn" id="buyQtyPlus">+</button>
                        </div>
                        <div class="ge-quantity-controls">
                            <button class="ge-qty-btn" data-qty="1">+1</button>
                            <button class="ge-qty-btn" data-qty="10">+10</button>
                            <button class="ge-qty-btn" data-qty="100">+100</button>
                            <button class="ge-qty-btn" data-qty="1000">+1k</button>
                            <button class="ge-qty-btn" data-qty="-max">All</button>
                        </div>
                    </div>

                    <!-- Price Controls (OSRS Style) -->
                    <div class="ge-form-group" id="buyPriceGroup" style="display: none;">
                        <label class="ge-form-label">Price per item:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="buyPriceMinus">â–¼</button>
                            <input type="number" class="ge-form-input-center" id="buyPrice" min="1" value="1">
                            <button class="ge-plus-btn" id="buyPricePlus">â–²</button>
                            <button class="ge-price-btn-side" id="buyPriceGuide">ðŸ’°</button>
                            <button class="ge-price-btn-side" id="buyPriceMore">â–²â–²</button>
                        </div>
                        <div class="ge-guide-price" id="buyGuidePrice"></div>
                    </div>

                    <!-- Total Display -->
                    <div class="ge-total-display-osrs" id="buyTotal" style="display: none;">
                        <div class="ge-total-amount-large"><span id="buyTotalAmount">0</span> coins</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="ge-action-buttons-osrs" id="buyActions" style="display: none;">
                        <button class="ge-back-btn" id="buyBackBtn">â† Back</button>
                        <button class="ge-confirm-btn-osrs" id="confirmBuy">Confirm</button>
                    </div>
                </div>

                <!-- Create Sell Offer -->
                <div class="ge-details-content" id="createSellOffer">
                    <div class="details-title">ðŸ”¼ Sell offer</div>
                    
                    <!-- Item Display -->
                    <div class="ge-selected-item" id="sellSelectedItem" style="display: none;">
                        <div class="ge-item-display">
                            <div class="ge-item-icon-large" id="sellItemIcon">ðŸªµ</div>
                            <div class="ge-item-info">
                                <div class="ge-item-name-large" id="sellItemName">Select an item</div>
                                <div class="ge-item-available" id="sellItemAvailable">Available: 0</div>
                                <div class="ge-item-price-info" id="sellItemPriceInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="ge-form-group" id="sellSearchGroup">
                        <label class="ge-form-label">Choose item from inventory:</label>
                        <input type="text" class="ge-item-search" id="sellItemSearch" placeholder="Search your items...">
                        <div class="ge-item-results" id="sellItemResults"></div>
                    </div>

                    <!-- Quantity Controls (OSRS Style) -->
                    <div class="ge-form-group" id="sellQuantityGroup" style="display: none;">
                        <label class="ge-form-label">Quantity:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="sellQtyMinus">âˆ’</button>
                            <input type="number" class="ge-form-input-center" id="sellQuantity" min="1" value="1">
                            <button class="ge-plus-btn" id="sellQtyPlus">+</button>
                        </div>
                        <div class="ge-quantity-controls">
                            <button class="ge-qty-btn" data-qty="1">+1</button>
                            <button class="ge-qty-btn" data-qty="10">+10</button>
                            <button class="ge-qty-btn" data-qty="100">+100</button>
                            <button class="ge-qty-btn" data-qty="max">All</button>
                        </div>
                    </div>

                    <!-- Price Controls (OSRS Style) -->
                    <div class="ge-form-group" id="sellPriceGroup" style="display: none;">
                        <label class="ge-form-label">Price per item:</label>
                        <div class="ge-input-row">
                            <button class="ge-minus-btn" id="sellPriceMinus">â–¼</button>
                            <input type="number" class="ge-form-input-center" id="sellPrice" min="1" value="1">
                            <button class="ge-plus-btn" id="sellPricePlus">â–²</button>
                            <button class="ge-price-btn-side" id="sellPriceGuide">ðŸ’°</button>
                        </div>
                        <div class="ge-guide-price" id="sellGuidePrice"></div>
                        <div class="ge-tax-notice">âš ï¸ 1% tax will be deducted</div>
                    </div>

                    <!-- Total Display -->
                    <div class="ge-total-display-osrs" id="sellTotal" style="display: none;">
                        <div class="ge-total-label">You'll receive:</div>
                        <div class="ge-total-amount-large"><span id="sellTotalAmount">0</span> coins</div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="ge-action-buttons-osrs" id="sellActions" style="display: none;">
                        <button class="ge-back-btn" id="sellBackBtn">â† Back</button>
                        <button class="ge-confirm-btn-osrs" id="confirmSell">Confirm</button>
                    </div>
                </div>

                <!-- View Offer Status -->
                <div class="ge-details-content" id="viewOffer">
                    <div class="details-title" id="offerTitle">Offer Status</div>
                    <div class="ge-offer-status-display" id="offerStatus">
                        <!-- Status will be dynamically populated -->
                    </div>
                    <div class="ge-action-buttons">
                        <button class="ge-cancel-btn" id="cancelOffer">Cancel Offer</button>
                    </div>
                    <button class="ge-collect-btn" id="collectOffer" style="display: none;">Collect Items</button>
                </div>
            </div>
        </div>
    </div>

                <div class="slots-section">
                    <div class="slots-section-title">ðŸ”¼ Sell Offers</div>
                    <div class="offer-slots" id="sellSlots">
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="0"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="1"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="2"></div>
                        <div class="offer-slot empty" data-slot-type="sell" data-slot-index="3"></div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Offer Details -->
            <div class="ge-details-container">
                <!-- Empty State -->
                <div class="ge-details-content active" id="emptyState">
                    <div class="ge-empty-state">
                        <div class="ge-empty-state-icon">ðŸ“¦</div>
                        <div class="ge-empty-state-text">Select an offer slot to buy or sell items</div>
                    </div>
                </div>

                <!-- Create Buy Offer -->
                <div class="ge-details-content" id="createBuyOffer">
                    <div class="details-title">ðŸ”½ Create Buy Offer</div>
                    <div class="offer-form">
                        <div class="ge-form-group">
                            <label class="ge-form-label">Search for item:</label>
                            <input type="text" class="ge-item-search" id="buyItemSearch" placeholder="Type item name...">
                            <div class="ge-item-results" id="buyItemResults"></div>
                        </div>

                        <div class="ge-form-group" id="buyPriceGroup" style="display: none;">
                            <label class="ge-form-label">Price per item:</label>
                            <input type="number" class="ge-form-input" id="buyPrice" min="1" value="1">
                            <div class="ge-guide-price" id="buyGuidePrice"></div>
                            <div class="ge-price-controls">
                                <button class="ge-price-btn" data-action="guide">Guide Price</button>
                                <button class="ge-price-btn" data-action="5%">+5%</button>
                                <button class="ge-price-btn" data-action="10%">+10%</button>
                            </div>
                        </div>

                        <div class="ge-form-group" id="buyQuantityGroup" style="display: none;">
                            <label class="ge-form-label">Quantity:</label>
                            <input type="number" class="ge-form-input" id="buyQuantity" min="1" value="1">
                            <div class="ge-quantity-controls">
                                <button class="ge-qty-btn" data-qty="1">+1</button>
                                <button class="ge-qty-btn" data-qty="10">+10</button>
                                <button class="ge-qty-btn" data-qty="100">+100</button>
                                <button class="ge-qty-btn" data-qty="1000">+1k</button>
                            </div>
                        </div>

                        <div class="ge-total-display" id="buyTotal" style="display: none;">
                            <div class="ge-total-label">Total Cost:</div>
                            <div class="ge-total-amount"><span id="buyTotalAmount">0</span> <span class="gp">gp</span></div>
                        </div>

                        <div class="ge-action-buttons" id="buyActions" style="display: none;">
                            <button class="ge-confirm-btn" id="confirmBuy">Confirm Offer</button>
                        </div>
                    </div>
                </div>

                <!-- Create Sell Offer -->
                <div class="ge-details-content" id="createSellOffer">
                    <div class="details-title">ðŸ”¼ Create Sell Offer</div>
                    <div class="offer-form">
                        <div class="ge-form-group">
                            <label class="ge-form-label">Select item from inventory:</label>
                            <input type="text" class="ge-item-search" id="sellItemSearch" placeholder="Search your items...">
                            <div class="ge-item-results" id="sellItemResults"></div>
                        </div>

                        <div class="ge-form-group" id="sellPriceGroup" style="display: none;">
                            <label class="ge-form-label">Price per item:</label>
                            <input type="number" class="ge-form-input" id="sellPrice" min="1" value="1">
                            <div class="ge-guide-price" id="sellGuidePrice"></div>
                            <div class="ge-price-controls">
                                <button class="ge-price-btn" data-action="guide">Guide Price</button>
                                <button class="ge-price-btn" data-action="-5%">-5%</button>
                                <button class="ge-price-btn" data-action="-10%">-10%</button>
                            </div>
                        </div>

                        <div class="ge-form-group" id="sellQuantityGroup" style="display: none;">
                            <label class="ge-form-label">Quantity (Available: <span id="sellAvailable">0</span>):</label>
                            <input type="number" class="ge-form-input" id="sellQuantity" min="1" value="1">
                            <div class="ge-quantity-controls">
                                <button class="ge-qty-btn" data-qty="1">+1</button>
                                <button class="ge-qty-btn" data-qty="10">+10</button>
                                <button class="ge-qty-btn" data-qty="100">+100</button>
                                <button class="ge-qty-btn" data-qty="max">All</button>
                            </div>
                        </div>

                        <div class="ge-total-display" id="sellTotal" style="display: none;">
                            <div class="ge-total-label">You'll Receive (after 1% tax):</div>
                            <div class="ge-total-amount"><span id="sellTotalAmount">0</span> <span class="gp">gp</span></div>
                            <div class="ge-tax-notice">âš ï¸ 1% tax will be deducted from sale</div>
                        </div>

                        <div class="ge-action-buttons" id="sellActions" style="display: none;">
                            <button class="ge-confirm-btn" id="confirmSell">Confirm Offer</button>
                        </div>
                    </div>
                </div>

                <!-- View Offer Status -->
                <div class="ge-details-content" id="viewOffer">
                    <div class="details-title" id="offerTitle">Offer Status</div>
                    <div class="ge-offer-status-display" id="offerStatus">
                        <!-- Status will be dynamically populated -->
                    </div>
                    <div class="ge-action-buttons">
                        <button class="ge-cancel-btn" id="cancelOffer">Cancel Offer</button>
                    </div>
                    <button class="ge-collect-btn" id="collectOffer" style="display: none;">Collect Items</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Stats UI -->
    <div id="characterStatsUI" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; background: linear-gradient(135deg, #2a1a0a 0%, #1a0f05 100%); border: 3px solid #6a4a2a; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.9); z-index: 999; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #6a4a2a 0%, #5a3a1a 100%); padding: 15px 20px; border-bottom: 2px solid #8a6a4a; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: #d4a76a; font-size: 22px; margin: 0; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 28px;">âš”ï¸</span>
                Character Stats
            </h2>
            <button onclick="document.getElementById('characterStatsUI').style.display='none'" style="background: #ff4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">âœ–</button>
        </div>

        <!-- Content -->
        <div style="display: flex; padding: 20px; gap: 20px;">
            <!-- Left Side - Stats -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
                <!-- Level Display -->
                <div style="background: #3a2a1a; padding: 15px; border: 2px solid #6a5a4a; border-radius: 8px;">
                    <div style="color: #8a7a6a; font-size: 12px; font-weight: bold; margin-bottom: 5px;">LEVEL</div>
                    <div id="charLevel" style="color: #d4a76a; font-size: 32px; font-weight: bold;">1</div>
                </div>

                <!-- Stats Sections -->
                <div style="background: #3a2a1a; padding: 15px; border: 2px solid #6a5a4a; border-radius: 8px;">
                    <div style="color: #ff6b6b; font-size: 14px; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #5a4a3a;">OFFENSE</div>
                    <div id="charOffense" style="color: #d4a76a; font-size: 12px; line-height: 1.8;">
                        <div>Damage: <span style="float: right; color: #fff;">0</span></div>
                        <div>Attack: <span style="float: right; color: #fff;">1</span></div>
                        <div>Strength: <span style="float: right; color: #fff;">1</span></div>
                        <div>Ranged: <span style="float: right; color: #fff;">1</span></div>
                        <div>Magic: <span style="float: right; color: #fff;">1</span></div>
                    </div>
                </div>

                <div style="background: #3a2a1a; padding: 15px; border: 2px solid #6a5a4a; border-radius: 8px;">
                    <div style="color: #5a9aff; font-size: 14px; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #5a4a3a;">DEFENSE</div>
                    <div id="charDefense" style="color: #d4a76a; font-size: 12px; line-height: 1.8;">
                        <div>Defense: <span style="float: right; color: #fff;">1</span></div>
                        <div>Armor: <span style="float: right; color: #fff;">0</span></div>
                    </div>
                </div>

                <div style="background: #3a2a1a; padding: 15px; border: 2px solid #6a5a4a; border-radius: 8px;">
                    <div style="color: #ff5a5a; font-size: 14px; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #5a4a3a;">LIFE</div>
                    <div id="charLife" style="color: #d4a76a; font-size: 12px; line-height: 1.8;">
                        <div>Hitpoints: <span style="float: right; color: #fff;">10</span></div>
                    </div>
                </div>
            </div>

            <!-- Right Side - Equipment -->
            <div style="flex: 1;">
                <div style="background: #3a2a1a; padding: 15px; border: 2px solid #6a5a4a; border-radius: 8px; height: 100%;">
                    <div style="color: #d4a76a; font-size: 14px; font-weight: bold; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #5a4a3a;">EQUIPMENT</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 280px; margin: 0 auto;">
                        <!-- Row 1: Empty -->
                        <div></div>
                        <div></div>
                        <div></div>
                        
                        <!-- Row 2: AMULET, HEAD, ARROWS -->
                        <div id="charSlotAmulet" class="char-equip-slot" data-slot="amulet" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">AMULET</span>
                        </div>
                        <div id="charSlotHead" class="char-equip-slot" data-slot="head" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">HEAD</span>
                        </div>
                        <div id="charSlotArrows" class="char-equip-slot" data-slot="arrows" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">ARROWS</span>
                        </div>
                        
                        <!-- Row 3: WEAPON, CHEST, CAPE -->
                        <div id="charSlotWeapon" class="char-equip-slot" data-slot="weapon" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">WEAPON</span>
                        </div>
                        <div id="charSlotChest" class="char-equip-slot" data-slot="chest" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">CHEST</span>
                        </div>
                        <div id="charSlotCape" class="char-equip-slot" data-slot="cape" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">CAPE</span>
                        </div>
                        
                        <!-- Row 4: GLOVES, LEGS, RING -->
                        <div id="charSlotGloves" class="char-equip-slot" data-slot="gloves" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">GLOVES</span>
                        </div>
                        <div id="charSlotLegs" class="char-equip-slot" data-slot="legs" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">LEGS</span>
                        </div>
                        <div id="charSlotRing" class="char-equip-slot" data-slot="ring" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">RING</span>
                        </div>
                        
                        <!-- Row 5: Empty, BOOTS, Empty -->
                        <div></div>
                        <div id="charSlotBoots" class="char-equip-slot" data-slot="boots" style="background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #6a5a4a; font-size: 20px; cursor: pointer; position: relative;">
                            <span style="position: absolute; top: 2px; left: 4px; font-size: 9px; color: #8a7a6a;">BOOTS</span>
                        </div>
                        <div></div>
                    </div>

                    <!-- Gold Display -->
                    <div style="margin-top: 15px; padding: 10px; background: #2a1a0a; border: 2px solid #5a4a3a; border-radius: 5px; text-align: center;">
                        <div style="color: #8a7a6a; font-size: 11px; margin-bottom: 3px;">GOLD</div>
                        <div id="charGold" style="color: #FFD700; font-size: 18px; font-weight: bold;">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Wiki Modal -->
    <div id="marketWikiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.9); z-index: 1001; padding: 20px; box-sizing: border-box;">
        <div style="max-width: 1400px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; background: linear-gradient(135deg, #2a1a0a 0%, #1a0f05 100%); border: 3px solid #6a4a2a; border-radius: 10px; overflow: hidden;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #6a4a2a 0%, #5a3a1a 100%); padding: 20px; border-bottom: 2px solid #8a6a4a; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color: #d4a76a; font-size: 24px; margin: 0; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 32px;">ðŸ“Š</span>
                    Market Price Wiki
                </h2>
                <button onclick="closeMarketWiki()" style="background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">âœ– Close</button>
            </div>

            <!-- Smart Search Bar -->
            <div style="background: #3a2a1a; padding: 15px; border-bottom: 2px solid #5a4a3a;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input 
                            type="text" 
                            id="wikiSearchInput" 
                            placeholder="ðŸ” Search items by name..." 
                            style="width: 100%; padding: 12px 40px 12px 40px; background: #2a1a0a; border: 2px solid #6a5a4a; border-radius: 5px; color: #d4a76a; font-size: 14px; font-weight: bold; outline: none;"
                            oninput="filterWikiTable()"
                        >
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">ðŸ”</span>
                        <button 
                            id="clearSearchBtn" 
                            onclick="clearWikiSearch()" 
                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #6a4a4a; border: none; border-radius: 3px; padding: 4px 8px; color: #fff; cursor: pointer; font-size: 12px; display: none;"
                        >âœ–</button>
                    </div>
                    <div style="background: #4a3a2a; padding: 10px 20px; border-radius: 5px; border: 2px solid #6a5a4a; white-space: nowrap;">
                        <span style="color: #8a7a6a; font-size: 12px; font-weight: bold;">Results: </span>
                        <span id="wikiResultCount" style="color: #FFD700; font-size: 14px; font-weight: bold;">0</span>
                    </div>
                </div>
                <div id="searchSuggestions" style="margin-top: 8px; display: none;">
                    <div style="color: #8a7a6a; font-size: 11px; margin-bottom: 4px;">Quick suggestions:</div>
                    <div id="suggestionTags" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div style="background: #3a2a1a; padding: 15px; border-bottom: 2px solid #5a4a3a;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="wiki-filter-btn active" data-filter="rises" style="flex: 1; padding: 12px; background: #4a6a4a; border: 2px solid #6a8a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Price Rises ðŸ“ˆ</button>
                    <button class="wiki-filter-btn" data-filter="falls" style="flex: 1; padding: 12px; background: #6a4a4a; border: 2px solid #8a6a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Price Falls ðŸ“‰</button>
                    <button class="wiki-filter-btn" data-filter="valuable" style="flex: 1; padding: 12px; background: #6a6a4a; border: 2px solid #8a8a6a; border-radius: 5px; color: #fff; cursor: pointer; font-weight: bold; font-size: 14px;">Valuable Trades ðŸ’Ž</button>
                    <button class="wiki-filter-btn" data-filter="most-traded" style="flex: 1; padding: 12px; background: #d4a76a; border: 2px solid #e4b77a; border-radius: 5px; color: #2a1a0a; cursor: pointer; font-weight: bold; font-size: 14px;">Most Traded ðŸ”¥</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="wiki-period-btn active" data-period="7" style="flex: 1; padding: 10px; background: #5a4a3a; border: 2px solid #7a6a5a; border-radius: 5px; color: #d4a76a; cursor: pointer; font-weight: bold;">Last 7 Days</button>
                    <button class="wiki-period-btn" data-period="30" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last Month</button>
                    <button class="wiki-period-btn" data-period="90" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last 3 Months</button>
                    <button class="wiki-period-btn" data-period="180" style="flex: 1; padding: 10px; background: #4a3a2a; border: 2px solid #6a5a4a; border-radius: 5px; color: #a48a6a; cursor: pointer; font-weight: bold;">Last 6 Months</button>
                </div>
            </div>

            <!-- Table Container -->
            <div style="flex: 1; overflow-y: auto; background: #2a1a0a; padding: 20px;">
                <table style="width: 100%; border-collapse: collapse; background: #1a0f05;">
                    <thead style="position: sticky; top: 0; background: #4a3a2a; z-index: 10;">
                        <tr>
                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Item</th>
                            <th style="padding: 15px; text-align: center; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">ðŸ’Ž</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Start Price</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">End Price</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Total Rise</th>
                            <th style="padding: 15px; text-align: right; border-bottom: 2px solid #6a5a4a; color: #d4a76a; font-size: 14px;">Change %</th>
                        </tr>
                    </thead>
                    <tbody id="wikiTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Ammunition Crafting Modal -->
    <div id="ammunitionCraftingModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1400px; height: 85vh; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.9); z-index: 999; overflow: hidden;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 22px; font-weight: bold;">ðŸ”¨ Crafting Station</div>
            <button id="closeCraftingModal" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">âœ–</button>
        </div>

        <!-- Tabs -->
        <div style="background: rgba(0,0,0,0.3); border-bottom: 2px solid #2a3a4a; display: flex;">
            <div class="craft-tab active" data-tab="ammunition" style="padding: 15px 30px; color: #5abaaa; font-weight: bold; cursor: pointer; border-bottom: 3px solid #5abaaa; background: rgba(90, 186, 170, 0.1);">Ammunition</div>
            <div class="craft-tab" data-tab="amulets" style="padding: 15px 30px; color: #8a9aaa; font-weight: bold; cursor: pointer; opacity: 0.6;">Amulets</div>
            <div class="craft-tab" data-tab="rings" style="padding: 15px 30px; color: #8a9aaa; font-weight: bold; cursor: pointer; opacity: 0.6;">Rings</div>
        </div>

        <!-- Auto Craft All Button -->
        <div style="background: rgba(0,0,0,0.15); border-bottom: 2px solid #2a3a4a; padding: 12px 20px; display: flex; justify-content: center; align-items: center; gap: 15px;">
            <button id="autoCraftAllCrafting" style="padding: 12px 30px; background: #4a9a8a; color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                Auto Craft All
            </button>
        </div>

        <!-- Content -->
        <div id="craftingContent" style="padding: 30px; overflow-y: auto; height: calc(85vh - 190px);">
            <!-- Ammunition Tab Content -->
            <div id="ammunitionTab" class="craft-tab-content">
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;">
                    <!-- T1 Arrow Card -->
                    <div class="arrow-craft-card" data-tier="1" style="background: linear-gradient(135deg, rgba(158, 158, 158, 0.3), rgba(117, 117, 117, 0.2)); border: 2px solid #757575; border-radius: 10px; padding: 15px; position: relative; transition: all 0.3s;">
                        <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 5px; color: #fff; font-weight: bold; font-size: 12px;">x1</div>
                        <div style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #5abaaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: help; font-size: 14px;">i</div>
                        
                        <div style="text-align: center; margin-top: 25px; margin-bottom: 12px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">ðŸ¹</div>
                            <div style="color: #d4a76a; font-size: 20px; font-weight: bold; margin-bottom: 6px;">T1 Arrow</div>
                            <div style="color: #8a9aaa; font-size: 13px;">Level requirement: 1</div>
                            <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">5 XP / craft</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #cad2da;">T1 Ore: 1</span>
                                <span class="material-count" data-material="ore-t1" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: #cad2da;">T1 Logs: 1</span>
                                <span class="material-count" data-material="logs-t1" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                        </div>

                        <button class="craft-arrow-btn" data-tier="1" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">CRAFT ALL</button>
                    </div>

                    <!-- T2 Arrow Card -->
                    <div class="arrow-craft-card" data-tier="2" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.2)); border: 2px solid #4caf50; border-radius: 10px; padding: 15px; position: relative; transition: all 0.3s;">
                        <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 5px; color: #fff; font-weight: bold; font-size: 12px;">x1</div>
                        <div style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #5abaaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: help; font-size: 14px;">i</div>
                        
                        <div style="text-align: center; margin-top: 25px; margin-bottom: 12px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">ðŸ¹</div>
                            <div style="color: #d4a76a; font-size: 20px; font-weight: bold; margin-bottom: 6px;">T2 Arrow</div>
                            <div style="color: #8a9aaa; font-size: 13px;">Level requirement: 10</div>
                            <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">10 XP / craft</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #cad2da;">T2 Ore: 1</span>
                                <span class="material-count" data-material="ore-t2" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: #cad2da;">T2 Logs: 1</span>
                                <span class="material-count" data-material="logs-t2" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                        </div>

                        <button class="craft-arrow-btn" data-tier="2" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">CRAFT ALL</button>
                    </div>

                    <!-- T3 Arrow Card -->
                    <div class="arrow-craft-card" data-tier="3" style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.3), rgba(25, 118, 210, 0.2)); border: 2px solid #2196f3; border-radius: 10px; padding: 15px; position: relative; transition: all 0.3s;">
                        <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 5px; color: #fff; font-weight: bold; font-size: 12px;">x1</div>
                        <div style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #5abaaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: help; font-size: 14px;">i</div>
                        
                        <div style="text-align: center; margin-top: 25px; margin-bottom: 12px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">ðŸ¹</div>
                            <div style="color: #d4a76a; font-size: 20px; font-weight: bold; margin-bottom: 6px;">T3 Arrow</div>
                            <div style="color: #8a9aaa; font-size: 13px;">Level requirement: 20</div>
                            <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">20 XP / craft</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #cad2da;">T3 Ore: 1</span>
                                <span class="material-count" data-material="ore-t3" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: #cad2da;">T3 Logs: 1</span>
                                <span class="material-count" data-material="logs-t3" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                        </div>

                        <button class="craft-arrow-btn" data-tier="3" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">CRAFT ALL</button>
                    </div>

                    <!-- T4 Arrow Card -->
                    <div class="arrow-craft-card" data-tier="4" style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.3), rgba(123, 31, 162, 0.2)); border: 2px solid #9c27b0; border-radius: 10px; padding: 15px; position: relative; transition: all 0.3s;">
                        <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 5px; color: #fff; font-weight: bold; font-size: 12px;">x1</div>
                        <div style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #5abaaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: help; font-size: 14px;">i</div>
                        
                        <div style="text-align: center; margin-top: 25px; margin-bottom: 12px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">ðŸ¹</div>
                            <div style="color: #d4a76a; font-size: 20px; font-weight: bold; margin-bottom: 6px;">T4 Arrow</div>
                            <div style="color: #8a9aaa; font-size: 13px;">Level requirement: 40</div>
                            <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">30 XP / craft</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #cad2da;">T4 Ore: 1</span>
                                <span class="material-count" data-material="ore-t4" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: #cad2da;">T4 Logs: 1</span>
                                <span class="material-count" data-material="logs-t4" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                        </div>

                        <button class="craft-arrow-btn" data-tier="4" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">CRAFT ALL</button>
                    </div>

                    <!-- T5 Arrow Card -->
                    <div class="arrow-craft-card" data-tier="5" style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.3), rgba(245, 124, 0, 0.2)); border: 2px solid #ff9800; border-radius: 10px; padding: 15px; position: relative; transition: all 0.3s;">
                        <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 5px; color: #fff; font-weight: bold; font-size: 12px;">x1</div>
                        <div style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; background: #5abaaa; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: help; font-size: 14px;">i</div>
                        
                        <div style="text-align: center; margin-top: 25px; margin-bottom: 12px;">
                            <div style="font-size: 40px; margin-bottom: 8px;">ðŸ¹</div>
                            <div style="color: #d4a76a; font-size: 20px; font-weight: bold; margin-bottom: 6px;">T5 Arrow</div>
                            <div style="color: #8a9aaa; font-size: 13px;">Level requirement: 60</div>
                            <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">40 XP / craft</div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #cad2da;">T5 Ore: 1</span>
                                <span class="material-count" data-material="ore-t5" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: #cad2da;">T5 Logs: 1</span>
                                <span class="material-count" data-material="logs-t5" style="color: #5abaaa;">(<span>0</span>)</span>
                            </div>
                        </div>

                        <button class="craft-arrow-btn" data-tier="5" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">CRAFT ALL</button>
                    </div>
                </div>
            </div>
            
            <!-- Jewelry Tab Content -->
            <div id="amuletsTab" class="craft-tab-content" style="display: none;">
                <!-- Tier Tabs -->
                <div style="background: rgba(0,0,0,0.2); border-bottom: 2px solid #2a3a4a; display: flex; padding: 10px 20px; gap: 10px;">
                    <button class="amulet-tier-tab active" data-tier="1" style="padding: 8px 20px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 1;">T1</button>
                    <button class="amulet-tier-tab" data-tier="2" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T2</button>
                    <button class="amulet-tier-tab" data-tier="3" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T3</button>
                    <button class="amulet-tier-tab" data-tier="4" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T4</button>
                    <button class="amulet-tier-tab" data-tier="5" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T5</button>
                </div>

                <!-- Content -->
                <div id="amuletsContent" style="padding: 30px; overflow-y: auto; max-height: calc(100vh - 300px);">
                    <!-- Content will be dynamically populated based on selected tier -->
                </div>
            </div>

            <div id="ringsTab" class="craft-tab-content" style="display: none;">
                <!-- Tier Tabs -->
                <div style="background: rgba(0,0,0,0.2); border-bottom: 2px solid #2a3a4a; display: flex; padding: 10px 20px; gap: 10px;">
                    <button class="ring-tier-tab active" data-tier="1" style="padding: 8px 20px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 1;">T1</button>
                    <button class="ring-tier-tab" data-tier="2" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T2</button>
                    <button class="ring-tier-tab" data-tier="3" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T3</button>
                    <button class="ring-tier-tab" data-tier="4" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T4</button>
                    <button class="ring-tier-tab" data-tier="5" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T5</button>
                </div>

                <!-- Content -->
                <div id="ringsContent" style="padding: 30px; overflow-y: auto; max-height: calc(100vh - 300px);">
                    <!-- Content will be dynamically populated based on selected tier -->
                </div>
            </div>
        </div>
    </div>

    <!-- Username Selection Modal (Shows on first login) -->
    <div id="usernameSelectionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 2000; display: none; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; border-radius: 15px; padding: 40px; max-width: 500px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ðŸŽ®</div>
                <div style="color: #5abaaa; font-size: 28px; font-weight: bold; margin-bottom: 10px;">Choose Your Username</div>
                <div style="color: #8a9aaa; font-size: 14px;">This will be your permanent display name</div>
            </div>
            
            <div style="margin-bottom: 25px;">
                <input type="text" id="firstTimeUsernameInput" placeholder="Enter username (3-16 characters)" maxlength="16" style="width: 100%; padding: 15px; background: #0f1620; border: 2px solid #2a3a4a; border-radius: 8px; color: #fff; font-size: 16px; text-align: center; box-sizing: border-box;">
                <div id="usernameError" style="color: #ff4444; font-size: 12px; margin-top: 8px; text-align: center; min-height: 18px;"></div>
            </div>
            
            <button id="confirmUsername" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #2a5a4a, #1a4a3a); color: #5abaaa; border: 2px solid #3a6a5a; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s;">
                Confirm Username
            </button>
            
            <div style="color: #6a7a8a; font-size: 12px; text-align: center; margin-top: 20px;">
                âš ï¸ Username cannot be changed once set!
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1200px; height: 85vh; background: linear-gradient(135deg, #1a2845 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1000; border-radius: 15px; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 22px; font-weight: bold;">ðŸ‘¤ Player Profile</div>
            <button id="closeProfile" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">âœ–</button>
        </div>

        <!-- Guest Mode Warning Banner -->
        <div id="guestModeBanner" style="display: none; background: linear-gradient(135deg, rgba(255, 170, 102, 0.2) 0%, rgba(255, 138, 51, 0.1) 100%); border-bottom: 2px solid rgba(255, 170, 102, 0.3); padding: 12px 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="font-size: 24px;">âš ï¸</div>
                <div>
                    <div style="color: #ffaa66; font-weight: bold; font-size: 14px;">Guest Mode - View Only</div>
                    <div style="color: #cc8844; font-size: 12px;">Sign in with Google to save your profile and join clans</div>
                </div>
            </div>
        </div>

        <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 70px); display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            
            <!-- Left Column: User Info + Buttons -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- User Info -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 15px;">User info</div>
                    <div style="color: #8a9aaa; font-size: 13px; line-height: 1.8;">
                        <div style="margin-bottom: 8px;">Username: <span id="profileUsername" style="color: #5abaaa; font-weight: bold;">Loading...</span></div>
                        <div style="margin-bottom: 8px;">Game mode: <span style="color: #fff;">Ironman</span></div>
                        <div style="margin-bottom: 8px;">Current activity: <span id="profileActivity" style="color: #fff;">Idle</span></div>
                        <div style="margin-bottom: 8px;">Total level: <span id="profileTotalLevelMain" style="color: #5abaaa; font-weight: bold;">0</span><span style="color: #6a7a8a;">/2400</span></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <button onclick="alert('PvM Stats coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">PvM stats</button>
                <button onclick="alert('Collection Log coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">Collection log</button>
                <button onclick="alert('Item Withdrawal coming soon!')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #2a5a5a, #1a4a4a); color: #5abaaa; border: 2px solid #3a6a6a; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">Item withdrawal box</button>
                
                <!-- Housing Bonuses -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="color: #fff; font-size: 16px; font-weight: bold;">Housing Bonuses</div>
                        <button style="background: #2a5a5a; color: #5abaaa; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View breakdown</button>
                    </div>
                    <div style="color: #8a9aaa; font-size: 13px; line-height: 1.8;">
                        <div>Housing upgrade: <span style="color: #fff;">0%</span></div>
                        <div>Clan housing & upgrades: <span style="color: #fff;">0%</span></div>
                        <div>Equipment: <span style="color: #fff;">0%</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Skills + Pets/Shop -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Skills Grid -->
                <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                    <div style="color: #fff; font-size: 18px; font-weight: bold; margin-bottom: 20px;">Skills</div>
                    <div id="profileSkillsGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px;">
                        <!-- Skills will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Pets and Shop Unlocks -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="color: #fff; font-size: 16px; font-weight: bold;">Pets (0)</div>
                            <button style="background: #2a5a5a; color: #5abaaa; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View</button>
                        </div>
                        <div style="color: #8a9aaa; font-size: 13px;">
                            <div>Activity: <span style="color: #fff;">None</span></div>
                            <div>Pet: <span style="color: #fff;">None</span></div>
                            <div>Task: <span style="color: #fff;">None</span></div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(26, 40, 69, 0.6); border: 2px solid #2a3a4a; border-radius: 12px; padding: 20px;">
                        <div style="color: #fff; font-size: 16px; font-weight: bold; margin-bottom: 15px;">Shop unlocks</div>
                        <div style="color: #8a9aaa; font-size: 13px;">Nothing yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smithwright Modal -->
    <div id="smithwrightModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1400px; height: 85vh; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.9); z-index: 999; overflow: hidden;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #5abaaa; font-size: 22px; font-weight: bold;">ðŸ”¥ Smithwright Station</div>
            <button id="closeSmithwrightModal" style="background: #3a2a2a; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 18px;">âœ–</button>
        </div>

        <!-- Main Tabs (Bars vs Planks) -->
        <div style="background: rgba(0,0,0,0.3); border-bottom: 2px solid #2a3a4a; display: flex;">
            <div class="smith-main-tab active" data-category="bars" style="padding: 15px 30px; color: #5abaaa; font-weight: bold; cursor: pointer; border-bottom: 3px solid #5abaaa; background: rgba(90, 186, 170, 0.1);">Bars</div>
            <div class="smith-main-tab" data-category="planks" style="padding: 15px 30px; color: #8a9aaa; font-weight: bold; cursor: pointer; opacity: 0.6;">Planks</div>
        </div>

        <!-- Tier Tabs -->
        <div style="background: rgba(0,0,0,0.2); border-bottom: 2px solid #2a3a4a; display: flex; padding: 10px 20px; gap: 10px;">
            <button class="smith-tier-tab active" data-tier="1" style="padding: 8px 20px; background: linear-gradient(135deg, #5abaaa, #4a9a8a); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 1;">T1</button>
            <button class="smith-tier-tab" data-tier="2" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T2</button>
            <button class="smith-tier-tab" data-tier="3" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T3</button>
            <button class="smith-tier-tab" data-tier="4" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T4</button>
            <button class="smith-tier-tab" data-tier="5" style="padding: 8px 20px; background: rgba(90, 186, 170, 0.3); color: #8a9aaa; border: 1px solid #3a4a5a; border-radius: 6px; font-weight: bold; cursor: pointer; opacity: 0.6;">T5</button>
        </div>

        <!-- Auto Craft All Button -->
        <div style="background: rgba(0,0,0,0.15); border-bottom: 2px solid #2a3a4a; padding: 12px 20px; display: flex; justify-content: center; align-items: center; gap: 15px;">
            <button id="autoCraftAllSmithwright" style="padding: 12px 30px; background: #4a9a8a; color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                Auto Craft All
            </button>
        </div>

        <!-- Content -->
        <div id="smithwrightContent" style="padding: 30px; overflow-y: auto; height: calc(85vh - 260px);">
            <!-- Content will be dynamically populated based on selected category and tier -->
        </div>
    </div>

    <!-- Combat Zone Selection Modal -->
    <div id="combatModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92%; max-width: 1500px; height: 90vh; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 4px solid #ff6b6b; border-radius: 20px; box-shadow: 0 20px 80px rgba(255, 107, 107, 0.4), 0 10px 50px rgba(0,0,0,0.9); z-index: 999; overflow: hidden;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(238, 85, 85, 0.2) 100%); border-bottom: 3px solid #ff6b6b; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-size: 42px;">âš”ï¸</div>
                <div>
                    <div style="color: #ff6b6b; font-size: 26px; font-weight: bold; text-shadow: 0 2px 10px rgba(255, 107, 107, 0.5);">Combat Zones</div>
                    <div style="color: #8a9aaa; font-size: 13px; margin-top: 2px;">Select a zone to begin your adventure</div>
                </div>
            </div>
            <button id="closeCombatModal" style="background: linear-gradient(135deg, #ff6b6b, #ee5555); color: #fff; border: 2px solid #ff4444; padding: 12px 18px; cursor: pointer; border-radius: 10px; font-size: 20px; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);">âœ–</button>
        </div>

        <!-- Zone Tabs -->
        <div style="background: linear-gradient(135deg, rgba(26, 35, 50, 0.8) 0%, rgba(15, 22, 32, 0.8) 100%); border-bottom: 3px solid #2a3a4a; display: flex; overflow-x: auto; padding: 15px 25px; gap: 12px; box-shadow: inset 0 -2px 10px rgba(0,0,0,0.3);">
            <button class="combat-zone-tab active" data-zone="woods" style="padding: 12px 24px; background: linear-gradient(135deg, #ff6b6b, #ee5555); color: white; border: 3px solid #ff4444; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 1; white-space: nowrap; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">ðŸŒ² Woods</button>
            <button class="combat-zone-tab" data-zone="cave" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸ•³ï¸ Cave</button>
            <button class="combat-zone-tab" data-zone="wilderness" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸœï¸ Wilderness</button>
            <button class="combat-zone-tab" data-zone="graveyard" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸ’€ Haunted Graveyard</button>
            <button class="combat-zone-tab" data-zone="uncharted" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸ—ºï¸ Uncharted Grounds</button>
            <button class="combat-zone-tab" data-zone="lair" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸ¦ Lair of Beasts</button>
            <button class="combat-zone-tab" data-zone="valley" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">âš¡ Valley of Gods</button>
            <button class="combat-zone-tab" data-zone="exterminating" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5)); color: #8a9aaa; border: 2px solid #3a4a5a; border-radius: 10px; font-weight: bold; font-size: 14px; cursor: pointer; opacity: 0.7; white-space: nowrap; transition: all 0.3s;">ðŸ”¥ Exterminating</button>
        </div>

        <!-- Content -->
        <div id="combatContent" style="padding: 40px; overflow-y: auto; height: calc(90vh - 220px); background: linear-gradient(180deg, rgba(26, 35, 50, 0.3) 0%, rgba(15, 22, 32, 0.5) 100%);">
            <!-- Content will be dynamically populated based on selected zone -->
        </div>
    </div>

    <!-- Combat Preparation Modal -->
    <div id="combatPrepModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%); border: 3px solid #2a3a4a; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.9);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 2px solid #2a3a4a; background: linear-gradient(135deg, #2a3a4a, #1a2a3a);">
                <button id="backToCombatZonesBtn" style="background: rgba(255, 107, 107, 0.3); color: #ff6b6b; border: 2px solid #ff6b6b; padding: 8px 16px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px;">
                    â† Back
                </button>
                <div style="color: #5abaaa; font-size: 22px; font-weight: bold;">âš”ï¸ Combat Preparation</div>
                <div style="width: 80px;"></div> <!-- Spacer for centering -->
            </div>
            
            <!-- Attack Style Selection -->
            <div style="padding: 20px 30px; border-bottom: 2px solid #2a3a4a;">
                <div style="color: #cad2da; font-size: 16px; font-weight: bold; margin-bottom: 15px;">âš”ï¸ Attack Style</div>
                <div style="display: flex; gap: 15px;">
                    <!-- Melee Styles -->
                    <div style="flex: 1; background: rgba(26, 35, 50, 0.6); border: 2px solid #2a3a4a; border-radius: 10px; padding: 15px;">
                        <div style="color: #ff6b6b; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">ðŸ—¡ï¸ MELEE</div>
                        <div class="attack-style-option" data-combat-style="melee" data-attack-style="accurate" style="padding: 8px; margin-bottom: 8px; background: rgba(90, 186, 170, 0.2); border: 2px solid #5abaaa; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #5abaaa; font-size: 13px; font-weight: bold;">Accurate</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Attack XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">More accuracy</div>
                        </div>
                        <div class="attack-style-option" data-combat-style="melee" data-attack-style="aggressive" style="padding: 8px; margin-bottom: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Aggressive</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Strength XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">More damage</div>
                        </div>
                        <div class="attack-style-option" data-combat-style="melee" data-attack-style="controlled" style="padding: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Controlled</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Attack, Strength, Defense XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">Balanced training</div>
                        </div>
                    </div>
                    
                    <!-- Ranged Styles -->
                    <div style="flex: 1; background: rgba(26, 35, 50, 0.6); border: 2px solid #2a3a4a; border-radius: 10px; padding: 15px;">
                        <div style="color: #ff6b6b; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">ðŸ¹ RANGED</div>
                        <div class="attack-style-option" data-combat-style="ranged" data-attack-style="rapid" style="padding: 8px; margin-bottom: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Rapid</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Ranged XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">Faster attacks</div>
                        </div>
                        <div class="attack-style-option" data-combat-style="ranged" data-attack-style="longrange" style="padding: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Longrange</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Ranged, Defense XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">Greater reach</div>
                        </div>
                    </div>
                    
                    <!-- Magic Styles -->
                    <div style="flex: 1; background: rgba(26, 35, 50, 0.6); border: 2px solid #2a3a4a; border-radius: 10px; padding: 15px;">
                        <div style="color: #ff6b6b; font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">ðŸ”® MAGIC</div>
                        <div class="attack-style-option" data-combat-style="magic" data-attack-style="accurate" style="padding: 8px; margin-bottom: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Accurate</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Magic XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">More accuracy</div>
                        </div>
                        <div class="attack-style-option" data-combat-style="magic" data-attack-style="longrange" style="padding: 8px; background: rgba(42, 58, 74, 0.4); border: 2px solid #2a3a4a; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                            <div style="color: #cad2da; font-size: 13px; font-weight: bold;">Longrange</div>
                            <div style="color: #8a9aaa; font-size: 11px;">+Magic, Defense XP</div>
                            <div style="color: #6a7a8a; font-size: 10px; font-style: italic;">Greater reach</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Combat Settings -->
            <div style="padding: 20px 30px; border-bottom: 2px solid #2a3a4a;">
                <div style="margin-bottom: 20px;">
                    <div style="color: #cad2da; font-size: 16px; font-weight: bold; margin-bottom: 10px;">Auto eat</div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 60px; height: 30px; background: linear-gradient(135deg, #4a9a8a, #3a8a7a); border-radius: 15px; position: relative; cursor: not-allowed; opacity: 0.8;">
                            <div style="width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px; transition: all 0.3s;"></div>
                        </div>
                        <span style="color: #8a9aaa; font-size: 14px;">(Always On)</span>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="color: #cad2da; font-size: 16px; font-weight: bold;">Eat threshold</div>
                        <div id="eatThresholdValue" style="color: #5abaaa; font-size: 16px; font-weight: bold;">87%</div>
                    </div>
                    <input type="range" id="eatThresholdSlider" min="10" max="99" value="87" 
                        style="width: 100%; height: 8px; background: linear-gradient(90deg, #3a4a5a 0%, #5abaaa 87%, #3a4a5a 87%); border-radius: 5px; outline: none; cursor: pointer;">
                </div>
            </div>
            
            <!-- Food Inventory -->
            <div style="padding: 20px 30px; max-height: 300px; overflow-y: auto;">
                <div style="color: #cad2da; font-size: 16px; font-weight: bold; margin-bottom: 15px;">Available Food</div>
                <div id="combatFoodGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; min-height: 60px;">
                    <!-- Food items will be populated here -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="padding: 20px 30px; display: flex; gap: 15px; border-top: 2px solid #2a3a4a;">
                <button id="leavePrepBtn" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ff6b6b, #ee5555); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    Leave
                </button>
                <button id="createPartyBtn" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #5a7a9a, #4a6a8a); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    Create a party
                </button>
                <button id="startFightBtn" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #4a9a8a, #3a8a7a); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    Fight
                </button>
            </div>
        </div>
    </div>

    <!-- Raid Lobby Modal -->
    <div id="raidLobbyModal">
        <div class="lobby-container">
            <div class="lobby-header">
                <div class="lobby-title">
                    ðŸ° Raid Lobbies
                </div>
                <button class="lobby-close-btn" id="closeLobby">âœ–</button>
            </div>

            <div class="lobby-content">
                <!-- Main Lobby List View -->
                <div id="lobbyListView">
                    <div class="lobby-actions">
                        <button class="lobby-btn" id="createLobbyBtn">âž• Create New Lobby</button>
                        <button class="lobby-btn secondary" id="refreshLobbiesBtn">ðŸ”„ Refresh Lobbies</button>
                    </div>

                    <div class="lobby-section">
                        <div class="lobby-section-title">Available Raid Lobbies</div>
                        <div class="lobbies-grid" id="lobbiesGrid">
                            <!-- Lobbies will be populated here -->
                            <div class="no-lobbies">
                                <div class="no-lobbies-icon">ðŸ°</div>
                                <div class="no-lobbies-text">No active lobbies found. Create one to get started!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Lobby Form -->
                <div id="createLobbyView" style="display: none;">
                    <div class="create-lobby-form">
                        <h3 style="color: #5abaaa; margin-bottom: 20px;">Create New Raid Lobby</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Lobby Name</label>
                            <input type="text" class="form-input" id="lobbyName" placeholder="Enter lobby name..." maxlength="30">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Raid Type</label>
                            <select class="form-select" id="raidType">
                                <option value="basic">Basic Raid</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Max Players</label>
                            <select class="form-select" id="maxPlayers">
                                <option value="2">2 Players</option>
                                <option value="3">3 Players</option>
                                <option value="4" selected>4 Players</option>
                                <option value="5">5 Players</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Minimum Level Required</label>
                            <select class="form-select" id="minLevel">
                                <option value="1" selected>Level 1+</option>
                                <option value="10">Level 10+</option>
                                <option value="20">Level 20+</option>
                                <option value="30">Level 30+</option>
                                <option value="50">Level 50+</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button class="form-btn secondary" id="cancelCreateLobby">Cancel</button>
                            <button class="form-btn primary" id="confirmCreateLobby">Create Lobby</button>
                        </div>
                    </div>
                </div>

                <!-- Active Lobby View (When in a lobby) -->
                <div id="activeLobbyView" style="display: none;">
                    <div class="active-lobby-view">
                        <div class="active-lobby-header">
                            <div>
                                <div class="active-lobby-name" id="activeLobbyName">Lobby Name</div>
                                <div style="color: #8a9aaa; font-size: 14px; margin-top: 5px;">
                                    <span id="activeLobbyPlayerCount">0</span>/<span id="activeLobbyMaxPlayers">4</span> Players
                                </div>
                            </div>
                            <div>
                                <button class="lobby-btn" id="startRaidBtn" style="margin-right: 10px; display: none;">ðŸŽ® Start Raid</button>
                                <button class="lobby-btn secondary" id="leaveLobbyBtn">Leave Lobby</button>
                            </div>
                        </div>

                        <div class="lobby-section">
                            <div class="lobby-section-title">Party Members</div>
                            <div class="active-lobby-members-list" id="activeLobbyMembersList">
                                <!-- Members will be populated here -->
                            </div>
                        </div>

                        <div class="lobby-section">
                            <div class="lobby-section-title">Lobby Chat</div>
                            <div class="lobby-chat" id="lobbyChat">
                                <div class="lobby-chat-message">
                                    <span class="lobby-chat-sender">System:</span> Welcome to the lobby! Waiting for players...
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" class="form-input" id="lobbyChatInput" placeholder="Type a message..." maxlength="100" style="flex: 1;">
                                <button class="form-btn primary" id="sendChatBtn" style="width: 100px;">Send</button>
                            </div>
                        </div>

                        <div class="lobby-section" id="inviteSection">
                            <div class="lobby-section-title">Invite Players</div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" class="form-input" id="invitePlayerInput" placeholder="Enter player username..." style="flex: 1;">
                                <button class="form-btn primary" id="invitePlayerBtn" style="width: 120px;">Send Invite</button>
                            </div>
                            <div id="inviteStatus" style="color: #8a9aaa; font-size: 12px; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Housing/Building UI Modal -->
    <div id="housingModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1000px; height: 85vh; background: linear-gradient(135deg, #1a2845 0%, #0f1620 100%); border: 3px solid #2a3a4a; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); z-index: 1000; border-radius: 15px; overflow: hidden;">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%); border-bottom: 2px solid #3a4a5a; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #fff; font-size: 24px; font-weight: bold;">ðŸ—ï¸ Building</div>
                <button id="closeHousingBtn" style="background: #8a4a4a; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 20px; transition: all 0.3s;">âœ–</button>
            </div>

            <!-- Content -->
            <div style="flex: 1; overflow-y: auto; padding: 30px;">
                <!-- Houses Section -->
                <div style="margin-bottom: 40px;">
                    <div style="color: #5abaaa; font-size: 20px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #2a3a4a; padding-bottom: 10px;">ðŸ  Houses</div>
                    <div id="housesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Houses will be populated here -->
                    </div>
                </div>

                <!-- Training Dummies Section -->
                <div style="margin-bottom: 40px;">
                    <div style="color: #5abaaa; font-size: 20px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #2a3a4a; padding-bottom: 10px;">ðŸŽ¯ Training Dummies</div>
                    <div id="dummiesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Training dummies will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Polyfill for roundRect (for older browsers)
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }
        
        // Load background image for woodcutting zone
        const woodcuttingBg = new Image();
        woodcuttingBg.src = 'https://raw.githubusercontent.com/Graphic37/RPG/main/test%20background.png';
        let woodcuttingBgLoaded = false;
        woodcuttingBg.onload = () => {
            woodcuttingBgLoaded = true;
            console.log('Woodcutting background loaded successfully');
        };
        woodcuttingBg.onerror = () => {
            console.error('Failed to load woodcutting background image');
        };
        
        // Load background image for mining zone
        const miningBg = new Image();
        miningBg.src = 'https://raw.githubusercontent.com/Graphic37/RPG/main/2nd%20background.png';
        let miningBgLoaded = false;
        miningBg.onload = () => {
            miningBgLoaded = true;
            console.log('Mining background loaded successfully');
        };
        miningBg.onerror = () => {
            console.error('Failed to load mining background image');
        };
        
        // Load white rock sprites for mining zone
        const whiteRockFull = new Image();
        whiteRockFull.src = 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/common%20white%20rock.png';
        let whiteRockFullLoaded = false;
        whiteRockFull.onload = () => {
            whiteRockFullLoaded = true;
            console.log('White rock (full) loaded successfully');
        };
        whiteRockFull.onerror = () => {
            console.error('Failed to load white rock full image');
        };
        
        const whiteRockPhase1 = new Image();
        whiteRockPhase1.src = 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/white%20rock%201.png';
        let whiteRockPhase1Loaded = false;
        whiteRockPhase1.onload = () => {
            whiteRockPhase1Loaded = true;
            console.log('White rock (phase 1) loaded successfully');
        };
        whiteRockPhase1.onerror = () => {
            console.error('Failed to load white rock phase 1 image');
        };
        
        const whiteRockPhase2 = new Image();
        whiteRockPhase2.src = 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/white%20rock%202.png';
        let whiteRockPhase2Loaded = false;
        whiteRockPhase2.onload = () => {
            whiteRockPhase2Loaded = true;
            console.log('White rock (phase 2) loaded successfully');
        };
        whiteRockPhase2.onerror = () => {
            console.error('Failed to load white rock phase 2 image');
        };
        
        
        // Set canvas size
        function resizeCanvas() {
            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            
            // Get the actual displayed size of the canvas
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // If size changed, regenerate tiles and force redraw (only if game is initialized)
            if (oldWidth !== canvas.width || oldHeight !== canvas.height) {
                try {
                    // Regenerate room objects based on new canvas size
                    if (typeof initializeRoomObjects === 'function') {
                        initializeRoomObjects();
                    }
                    
                    // Only regenerate if game objects are initialized
                    if (typeof generateTiles === 'function') {
                        generateTiles();
                    }
                    
                    // Adjust player position if needed to stay in bounds
                    if (gameState && gameState.player) {
                        gameState.player.x = Math.min(gameState.player.x, canvas.width - 50);
                        gameState.player.y = Math.min(gameState.player.y, canvas.height - 50);
                    }
                } catch (e) {
                    // Ignore errors during initialization
                }
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game State
        const gameState = {
            currentRoom: 'woodcutting',
            player: {
                x: 400,
                y: 300,
                targetX: null,
                targetY: null,
                speed: 1,
                size: 20,
                gold: 100965,
                health: 10,  // Initialize health
                maxHealth: 10,  // Initialize maxHealth
                inventory: [
                    { name: 'Tester Staff', icon: 'ðŸª„', quantity: 1, slot: 'weapon', type: 'weapon', tier: 1, attackBonus: 10, magicBonus: 15 },
                    { name: 'Tester Bow', icon: 'ðŸ¹', quantity: 1, slot: 'weapon', type: 'weapon', tier: 1, attackBonus: 12, rangedBonus: 15 },
                    { name: 'Tester Arrows', icon: 'ðŸ¹', quantity: 100, slot: 'arrows', type: 'ammunition', tier: 1, rangedBonus: 5 },
                    { name: 'T1 Common Cooked Fish', icon: 'cookedfish_T1_Common', quantity: 20, stackable: true, type: 'food', tier: 1, rarity: 'Common' },
                    { name: 'T2 Roasted Acorn', icon: 'roastedacorn_T2', quantity: 15, stackable: true, type: 'food', tier: 2 },
                    { name: 'T1 Clue Scroll', icon: 'cluescroll_T1', quantity: 1, tier: 1, type: 'clue', rarity: 'Perfect' },
                    { name: 'T2 Clue Scroll', icon: 'cluescroll_T2', quantity: 1, tier: 2, type: 'clue', rarity: 'Perfect' },
                    { name: 'T3 Clue Scroll', icon: 'cluescroll_T3', quantity: 1, tier: 3, type: 'clue', rarity: 'Perfect' },
                    { name: 'T4 Clue Scroll', icon: 'cluescroll_T4', quantity: 1, tier: 4, type: 'clue', rarity: 'Perfect' },
                    { name: 'T5 Clue Scroll', icon: 'cluescroll_T5', quantity: 1, tier: 5, type: 'clue', rarity: 'Perfect' },
                    { name: 'T1 Clue Chest', icon: 'cluechest_T1', quantity: 1, tier: 1, type: 'cluechest' },
                    { name: 'T2 Clue Chest', icon: 'cluechest_T2', quantity: 1, tier: 2, type: 'cluechest' },
                    { name: 'T3 Clue Chest', icon: 'cluechest_T3', quantity: 1, tier: 3, type: 'cluechest' },
                    { name: 'T4 Clue Chest', icon: 'cluechest_T4', quantity: 1, tier: 4, type: 'cluechest' },
                    { name: 'T5 Clue Chest', icon: 'cluechest_T5', quantity: 1, tier: 5, type: 'cluechest' },
                    { name: 'T3 Rare Mage Book', icon: 'magebook_T3_Rare', quantity: 1, tier: 3, type: 'magebook', slot: 'arrows', rarity: 'Rare', charges: 0, magicBonus: 10 },
                    { name: 'T3 Pages', icon: 'pages_T3', quantity: 1021, tier: 3, type: 'pages', stackable: true }
                ],
                inventorySize: 98,
                equipment: {
                    head: null,
                    amulet: null,
                    cape: null,
                    chest: null,
                    legs: null,
                    boots: null,
                    gloves: null,
                    ring: null,
                    weapon: null,
                    arrows: null
                },
                tools: {
                    axe: null,
                    pickaxe: null,
                    fishingRod: null,
                    cookingUtensils: null,
                    lockpick: null,
                    hammer: null,
                    needle: null,
                    tongs: null,
                    grapplingHook: null
                },
                isPerformingAction: false,
                actionProgress: 0,
                actionDuration: 3000, // 3 seconds per action
                currentTarget: null,
                lastActionTime: 0,
                isAttacking: false, // Track if player is locked in attack animation
                attackLockoutEnd: 0, // Timestamp when attack lockout ends
                // Character animation state
                animation: {
                    currentState: 'idle', // idle, walking, attacking, hurt, dying, idleblink
                    frame: 0,
                    lastFrameTime: 0,
                    frameDelay: 100, // milliseconds between frames (10 FPS)
                    blinkTimer: 0, // Timer for occasional blinks
                    blinkDelay: 3000 + Math.random() * 2000, // Random delay between 3-5 seconds
                    facingLeft: false // Track which direction player is facing
                },
                skills: {
                    hitpoints: 10,
                    attack: 1,
                    mining: 1,
                    strength: 1,
                    agility: 1,

                    defence: 1,

                    fishing: 1,
                    ranged: 1,

                    cooking: 1,

                    crafting: 1,
                    
                    carpentry: 1,

                    magic: 1,

                    woodcutting: 1,


                    plundering: 1,
                    
                    smithwright: 1
                },
                // XP tracking for each skill
                skillXP: {
                    hitpoints: 0,
                    attack: 0,
                    mining: 0,
                    strength: 0,
                    agility: 0,
                    defence: 0,
                    fishing: 0,
                    ranged: 0,
                    cooking: 0,
                    crafting: 0,
                    carpentry: 0,
                    magic: 0,
                    woodcutting: 0,
                    plundering: 0,
                    smithwright: 0
                },
                // Alias for compatibility
                get experience() { return this.skillXP; }
            },
            camera: {
                x: 0,
                y: 0
            },
            tiles: [],
            objects: [],
            particles: [],
            inventoryOpen: false,
            afkMode: true,
            nextTargetTime: 0,
            inactivityTimer: 0,
            sprites: {},
            // Activity Tracker (OSRS-style)
            activityTracker: {
                startTime: Date.now(),
                itemsGained: 0,
                xpGained: 0,
                currentActivity: '',
                lastItem: null
            },
            // Buildings/Housing System
            buildings: {
                house: 0, // 0 = not built, 1-5 = tier built
                trainingDummy: 0, // 0 = not built, 1-5 = tier built
                // Progress tracking for each building
                houseProgress: [
                    { planks: 0, bars: 0 }, // Tier 1
                    { planks: 0, bars: 0 }, // Tier 2
                    { planks: 0, bars: 0 }, // Tier 3
                    { planks: 0, bars: 0 }, // Tier 4
                    { planks: 0, bars: 0 }  // Tier 5
                ],
                trainingDummyProgress: [
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }, // Tier 1
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }, // Tier 2
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }, // Tier 3
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }, // Tier 4
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }  // Tier 5
                ]
            },
            // Crafting queue for ammunition and other crafted items
            craftingQueue: [],
            
            // Combat system (OSRS-style)
            combat: {
                inCombat: false,
                monster: null,
                monsterPosition: { x: 0, y: 0 },
                monsterHealth: 0,
                monsterMaxHealth: 0,
                lastPlayerAttack: 0,
                lastMonsterAttack: 0,
                damageSplats: [], // Array of {damage, x, y, isPlayer, timestamp}
                combatStyle: 'melee', // melee, ranged, or magic
                attackStyle: 'accurate', // specific style: accurate, aggressive, controlled, rapid, longrange
                autoEat: true,  // Auto-eat is ON by default
                eatThreshold: 50, // Default eat at 50% health
                pickyEater: false // Whether to only eat best food
            },
            
            // Clue Scroll System
            clueScrolls: {
                T1: null, // Will store { active: true, steps: [{task, completed, description}] }
                T2: null,
                T3: null,
                T4: null,
                T5: null
            }
        };
        
        // Update player health based on hitpoints skill
        function updatePlayerHealth() {
            const hitpointsLevel = gameState.player.skills.hitpoints;
            gameState.player.maxHealth = 10 + (hitpointsLevel - 1);
            
            // If current health is not set or exceeds max, set to max
            if (!gameState.player.health || gameState.player.health > gameState.player.maxHealth) {
                gameState.player.health = gameState.player.maxHealth;
            }
        }
        
        // Call this on game initialization
        updatePlayerHealth();

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCsRx39EtpX9wv7sr-xSGG4VErBzehBQek",
  authDomain: "mmorpg-game-7c7c2.firebaseapp.com",
  databaseURL: "https://mmorpg-game-7c7c2-default-rtdb.firebaseio.com",
  projectId: "mmorpg-game-7c7c2",
  storageBucket: "mmorpg-game-7c7c2.firebasestorage.app",
  messagingSenderId: "984103556329",
  appId: "1:984103556329:web:aed09909095ec1eb5f0c78",
  measurementId: "G-B5NVV5PTC9"
};

        // Check if Firebase config is set up (not using placeholder values)
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY" && 
                                      firebaseConfig.projectId !== "YOUR_PROJECT_ID";

        // Initialize Firebase only if configured
        let auth = null;
        let database = null;
        
        if (isFirebaseConfigured) {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.log('Guest mode will work, but sign-in features disabled');
            }
        } else {
            console.log('Firebase not configured - Guest mode available, sign-in disabled');
        }

        // Global player profile
        let playerProfile = {
            username: null,
            clanId: null,
            clanName: null,
            clanRole: null,
            createdAt: Date.now()
        };

        // Auth state management
        let currentUser = null;
        let isGuestMode = false;

        // Google Sign In
        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            if (!isFirebaseConfigured || !auth) {
                showFloatingText('Firebase not configured. Please set up Firebase to use sign-in.', canvas.width / 2, 100, '#ff4444');
                showFloatingText('You can still play as guest!', canvas.width / 2, 140, '#ffaa66');
                return;
            }
            
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(async (result) => {
                    currentUser = result.user;
                    isGuestMode = false;
                    document.getElementById('loginModal').style.display = 'none';
                    updateUserUI();
                    await loadPlayerProfile();
                    showFloatingText('Welcome ' + (playerProfile.username || currentUser.displayName) + '!', canvas.width / 2, 100, '#FFD700');
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    showFloatingText('Login failed: ' + error.message, canvas.width / 2, 100, '#ff4444');
                });
        });

        // Guest Login
        document.getElementById('guestLoginBtn').addEventListener('click', () => {
            isGuestMode = true;
            
            // Create consistent guest user for testing
            currentUser = {
                uid: 'guest-testing',
                email: 'guest@testing.com',
                displayName: 'Guest'
            };
            
            // Set default Guest username
            playerProfile.username = 'Guest';
            
            document.getElementById('loginModal').style.display = 'none';
            updateUserUI();
            showFloatingText('ðŸ§ª Testing Mode - Full access enabled!', canvas.width / 2, 100, '#ffaa66');
            
            // Show reminder after a few seconds
            setTimeout(() => {
                showFloatingText('Note: Guest data may not persist between sessions', canvas.width / 2, 150, '#6a8a9a');
            }, 3000);
        });

        // ============================================
        // PROFILE & CLAN SYSTEM
        // ============================================
        
        // Profile functions removed as playerProfile is now global

        // Load player profile
        async function loadPlayerProfile() {
            if (!currentUser || !database) return;
            
            const profileRef = database.ref(`players/${currentUser.uid}/profile`);
            const snapshot = await profileRef.once('value');
            
            if (snapshot.exists()) {
                playerProfile = snapshot.val();
                
                // Check if username exists, if not show selection modal
                if (!playerProfile.username) {
                    showUsernameSelectionModal();
                }
            } else {
                // New profile - show username selection
                showUsernameSelectionModal();
            }
            
            updateProfileDisplay();
        }
        
        // Show username selection modal
        function showUsernameSelectionModal() {
            const modal = document.getElementById('usernameSelectionModal');
            modal.style.display = 'flex';
            document.getElementById('firstTimeUsernameInput').focus();
        }
        
        // Confirm username selection
        document.getElementById('confirmUsername').addEventListener('click', async () => {
            if (!currentUser || !database) return;
            
            const username = document.getElementById('firstTimeUsernameInput').value.trim();
            const errorDiv = document.getElementById('usernameError');
            
            if (!username || username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters';
                return;
            }
            
            if (username.length > 16) {
                errorDiv.textContent = 'Username must be 16 characters or less';
                return;
            }
            
            // Check if username is taken
            const usernamesRef = database.ref('usernames');
            const snapshot = await usernamesRef.orderByValue().equalTo(username).once('value');
            
            if (snapshot.exists()) {
                errorDiv.textContent = 'Username already taken';
                return;
            }
            
            // Save username (permanent!)
            playerProfile = {
                username: username,
                clanId: null,
                clanName: null,
                clanRole: null,
                createdAt: Date.now()
            };
            
            await database.ref(`players/${currentUser.uid}/profile`).set(playerProfile);
            await database.ref(`usernames/${currentUser.uid}`).set(username);
            
            document.getElementById('usernameSelectionModal').style.display = 'none';
            showFloatingText(`Welcome, ${username}!`, canvas.width / 2, 100, '#5abaaa');
            updateProfileDisplay();
        });

        // Update profile display
        function updateProfileDisplay() {
            // Show/hide guest mode banner
            const guestBanner = document.getElementById('guestModeBanner');
            if (guestBanner) {
                guestBanner.style.display = isGuestMode ? 'block' : 'none';
            }
            
            // Update username
            const usernameEl = document.getElementById('profileUsername');
            if (usernameEl) {
                if (isGuestMode) {
                    usernameEl.textContent = 'Guest (not saved)';
                } else if (playerProfile && playerProfile.username) {
                    usernameEl.textContent = playerProfile.username;
                } else {
                    usernameEl.textContent = 'Not set';
                }
            }
            
            // Update current activity
            const activityEl = document.getElementById('profileActivity');
            if (activityEl) {
                const activityNames = {
                    'woodcutting': 'Woodcutting',
                    'mining': 'Mining',
                    'fishing': 'Fishing',
                    'plundering': 'Plundering',
                    'agility': 'Agility',
                    'cooking': 'Cooking',
                    'combat': 'Combat',
                    'crafting': 'Crafting',
                    'raids': 'Raiding'
                };
                activityEl.textContent = activityNames[gameState.currentRoom] || 'Idle';
            }
            
            // Update stats
            const totalLevel = Object.values(gameState.player.skills).reduce((a, b) => a + b, 0);
            const totalLevelEl = document.getElementById('profileTotalLevelMain');
            if (totalLevelEl) {
                totalLevelEl.textContent = totalLevel;
            }
            
            // Populate skills grid
            const skillsGrid = document.getElementById('profileSkillsGrid');
            if (skillsGrid) {
                const skillIcons = {
                    hitpoints: 'â¤ï¸',
                    attack: 'âš”ï¸',
                    strength: 'ðŸ’ª',
                    defence: 'ðŸ›¡ï¸',
                    ranged: 'ðŸ¹',
                    magic: 'âœ¨',
                    woodcutting: 'ðŸª“',
                    mining: 'â›ï¸',
                    fishing: 'ðŸŽ£',
                    cooking: 'ðŸ—',
                    crafting: 'ðŸ§µ',
                    carpentry: 'ðŸ”¨',
                    plundering: 'ðŸ’°',
                    agility: 'ðŸƒ',
                    smithwright: 'ðŸ”§'
                };
                
                skillsGrid.innerHTML = '';
                for (let [skill, level] of Object.entries(gameState.player.skills)) {
                    const skillDiv = document.createElement('div');
                    skillDiv.style.cssText = 'text-align: center;';
                    skillDiv.innerHTML = `
                        <div style="font-size: 32px; margin-bottom: 5px;">${skillIcons[skill] || 'ðŸ“Š'}</div>
                        <div style="color: #fff; font-size: 14px; font-weight: bold;">Level: ${level}</div>
                    `;
                    skillsGrid.appendChild(skillDiv);
                }
            }
            
            // Clan display (still available for logged in users)
            if (!isGuestMode && playerProfile && playerProfile.clanId && playerProfile.clanName) {
                // Clan info can be shown elsewhere if needed
            }
        }

        // Load clan member count
        async function loadClanMemberCount() {
            if (!playerProfile.clanId || !database) return;
            
            const membersRef = database.ref(`clans/${playerProfile.clanId}/members`);
            const snapshot = await membersRef.once('value');
            const count = snapshot.numChildren();
            document.getElementById('clanMembersDisplay').textContent = count;
        }


        // Open profile modal
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Profile')) {
                item.addEventListener('click', () => {
                    if (!currentUser && !isGuestMode) {
                        showFloatingText('Sign in to view profile', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    
                    if (isGuestMode) {
                        // Guest mode: Show limited profile view
                        document.getElementById('profileModal').style.display = 'block';
                        updateProfileDisplay();
                        showFloatingText('âš ï¸ Sign in to save profile data', canvas.width / 2, 150, '#ffaa66');
                    } else {
                        document.getElementById('profileModal').style.display = 'block';
                        updateProfileDisplay();
                    }
                });
            }
        });

        // Close profile modal
        document.getElementById('closeProfile').addEventListener('click', () => {
            document.getElementById('profileModal').style.display = 'none';
            resetUIPosition('profileModal');
        });

        // Open clan menu (shortcut to profile clan section)
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Clan')) {
                item.addEventListener('click', () => {
                    if (!currentUser && !isGuestMode) {
                        showFloatingText('Sign in to join a clan', canvas.width / 2, 100, '#ff4444');
                        return;
                    }
                    // Open profile modal and scroll to clan section
                    document.getElementById('profileModal').style.display = 'block';
                    updateProfileDisplay();
                    
                    if (isGuestMode) {
                        showFloatingText('âš ï¸ Sign in to create or join clans', canvas.width / 2, 150, '#ffaa66');
                    }
                });
            }
        });

        // Create clan button (if exists - old profile UI)
        const createClanBtn = document.getElementById('createClanBtn');
        if (createClanBtn) {
            createClanBtn.addEventListener('click', () => {
                document.getElementById('createClanModal').style.display = 'block';
            });
        }

        // Close create clan modal
        const closeCreateClan = document.getElementById('closeCreateClan');
        if (closeCreateClan) {
            closeCreateClan.addEventListener('click', () => {
                document.getElementById('createClanModal').style.display = 'none';
            });
        }

        // Confirm create clan
        const confirmCreateClan = document.getElementById('confirmCreateClan');
        if (confirmCreateClan) {
            confirmCreateClan.addEventListener('click', async () => {
            if (!currentUser || !database) return;
            
            const clanName = document.getElementById('createClanName').value.trim();
            const clanTag = document.getElementById('createClanTag').value.trim().toUpperCase();
            
            if (!clanName || clanName.length < 3) {
                showFloatingText('Clan name must be at least 3 characters', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            if (!clanTag || clanTag.length < 3 || clanTag.length > 4) {
                showFloatingText('Clan tag must be 3-4 letters', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Check if clan name is taken
            const clansRef = database.ref('clans');
            const snapshot = await clansRef.orderByChild('name').equalTo(clanName).once('value');
            
            if (snapshot.exists()) {
                showFloatingText('Clan name already taken', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Create clan
            const newClanRef = clansRef.push();
            const clanId = newClanRef.key;
            
            await newClanRef.set({
                name: clanName,
                tag: clanTag,
                leaderId: currentUser.uid,
                leaderName: playerProfile.username,
                createdAt: Date.now(),
                memberCount: 1
            });
            
            // Add member
            await database.ref(`clans/${clanId}/members/${currentUser.uid}`).set({
                username: playerProfile.username,
                role: 'Leader',
                joinedAt: Date.now()
            });
            
            // Update player profile
            playerProfile.clanId = clanId;
            playerProfile.clanName = clanName;
            playerProfile.clanRole = 'Leader';
            await database.ref(`players/${currentUser.uid}/profile`).update({
                clanId: clanId,
                clanName: clanName,
                clanRole: 'Leader'
            });
            
            document.getElementById('createClanModal').style.display = 'none';
            updateProfileDisplay();
            showFloatingText(`Clan "${clanName}" created!`, canvas.width / 2, 100, '#5abaaa');
            });
        }

        // Join clan button (if exists - old profile UI)
        const joinClanBtn = document.getElementById('joinClanBtn');
        if (joinClanBtn) {
            joinClanBtn.addEventListener('click', async () => {
                document.getElementById('joinClanModal').style.display = 'block';
                await loadClanList();
            });
        }

        // Close join clan modal
        const closeJoinClan = document.getElementById('closeJoinClan');
        if (closeJoinClan) {
            closeJoinClan.addEventListener('click', () => {
                document.getElementById('joinClanModal').style.display = 'none';
            });
        }

        // Load clan list
        async function loadClanList() {
            if (!database) return;
            
            const clansRef = database.ref('clans');
            const snapshot = await clansRef.limitToFirst(50).once('value');
            
            const clanListDiv = document.getElementById('clanList');
            clanListDiv.innerHTML = '';
            
            if (!snapshot.exists()) {
                clanListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No clans available</div>';
                return;
            }
            
            snapshot.forEach((clanSnap) => {
                const clan = clanSnap.val();
                const clanId = clanSnap.key;
                
                const clanDiv = document.createElement('div');
                clanDiv.style.cssText = 'background: rgba(90, 138, 250, 0.1); border: 2px solid #2a3a4a; border-radius: 5px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;';
                clanDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: #5a8afa; font-weight: bold; font-size: 16px;">[${clan.tag}] ${clan.name}</div>
                            <div style="color: #8a9aaa; font-size: 12px; margin-top: 5px;">Leader: ${clan.leaderName} â€¢ Members: ${clan.memberCount || 0}</div>
                        </div>
                        <button class="joinClanButton" data-clan-id="${clanId}" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;">Join</button>
                    </div>
                `;
                
                clanDiv.addEventListener('mouseenter', () => {
                    clanDiv.style.background = 'rgba(90, 138, 250, 0.2)';
                });
                
                clanDiv.addEventListener('mouseleave', () => {
                    clanDiv.style.background = 'rgba(90, 138, 250, 0.1)';
                });
                
                clanListDiv.appendChild(clanDiv);
            });
            
            // Add join button handlers
            document.querySelectorAll('.joinClanButton').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const clanId = btn.dataset.clanId;
                    await joinClan(clanId);
                });
            });
        }

        // Join clan
        async function joinClan(clanId) {
            if (!currentUser || !database) return;
            
            // Get clan info
            const clanRef = database.ref(`clans/${clanId}`);
            const clanSnapshot = await clanRef.once('value');
            
            if (!clanSnapshot.exists()) {
                showFloatingText('Clan not found', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            const clan = clanSnapshot.val();
            
            // Add member
            await database.ref(`clans/${clanId}/members/${currentUser.uid}`).set({
                username: playerProfile.username,
                role: 'Member',
                joinedAt: Date.now()
            });
            
            // Update member count
            await clanRef.update({
                memberCount: (clan.memberCount || 0) + 1
            });
            
            // Update player profile
            playerProfile.clanId = clanId;
            playerProfile.clanName = clan.name;
            playerProfile.clanRole = 'Member';
            await database.ref(`players/${currentUser.uid}/profile`).update({
                clanId: clanId,
                clanName: clan.name,
                clanRole: 'Member'
            });
            
            document.getElementById('joinClanModal').style.display = 'none';
            updateProfileDisplay();
            showFloatingText(`Joined clan "${clan.name}"!`, canvas.width / 2, 100, '#5abaaa');
        }

        // Leave clan button (if exists - old profile UI)
        const leaveClanBtn = document.getElementById('leaveClanBtn');
        if (leaveClanBtn) {
            leaveClanBtn.addEventListener('click', async () => {
                if (!currentUser || !database || !playerProfile.clanId) return;
                
                if (!confirm('Are you sure you want to leave your clan?')) return;
                
                const clanId = playerProfile.clanId;
                
                // Remove from clan members
                await database.ref(`clans/${clanId}/members/${currentUser.uid}`).remove();
                
                // Update member count
                const clanRef = database.ref(`clans/${clanId}`);
                const clanSnapshot = await clanRef.once('value');
                const clan = clanSnapshot.val();
                
                const newMemberCount = (clan.memberCount || 1) - 1;
                
                if (newMemberCount === 0) {
                    // Delete clan if no members left
                    await clanRef.remove();
                } else {
                    await clanRef.update({ memberCount: newMemberCount });
                }
                
                // Update player profile
                playerProfile.clanId = null;
                playerProfile.clanName = null;
                playerProfile.clanRole = null;
                await database.ref(`players/${currentUser.uid}/profile`).update({
                    clanId: null,
                    clanName: null,
                    clanRole: null
                });
                
                updateProfileDisplay();
                showFloatingText('Left clan', canvas.width / 2, 100, '#8a9aaa');
            });
        }

        // Search clans (if exists - old profile UI)
        const searchClanInput = document.getElementById('searchClanInput');
        if (searchClanInput) {
            searchClanInput.addEventListener('input', async (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    await loadClanList();
                    return;
                }
                
                const clansRef = database.ref('clans');
                const snapshot = await clansRef.once('value');
                
                const clanListDiv = document.getElementById('clanList');
                clanListDiv.innerHTML = '';
                
                let foundClans = false;
                
                snapshot.forEach((clanSnap) => {
                    const clan = clanSnap.val();
                    const clanId = clanSnap.key;
                    
                    if (clan.name.toLowerCase().includes(searchTerm) || clan.tag.toLowerCase().includes(searchTerm)) {
                        foundClans = true;
                        
                        const clanDiv = document.createElement('div');
                        clanDiv.style.cssText = 'background: rgba(90, 138, 250, 0.1); border: 2px solid #2a3a4a; border-radius: 5px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;';
                        clanDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #5a8afa; font-weight: bold; font-size: 16px;">[${clan.tag}] ${clan.name}</div>
                                    <div style="color: #8a9aaa; font-size: 12px; margin-top: 5px;">Leader: ${clan.leaderName} â€¢ Members: ${clan.memberCount || 0}</div>
                                </div>
                                <button class="joinClanButton" data-clan-id="${clanId}" style="background: linear-gradient(135deg, #2a5a8a, #1a4a7a); color: #5a8afa; border: 2px solid #3a6a9a; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold;">Join</button>
                            </div>
                        `;
                        
                        clanListDiv.appendChild(clanDiv);
                    }
                });
                
                if (!foundClans) {
                    clanListDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #8a9aaa;">No clans found</div>';
                }
                
                // Add join button handlers
                document.querySelectorAll('.joinClanButton').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const clanId = btn.dataset.clanId;
                        await joinClan(clanId);
                    });
                });
            });
        }

        // END PROFILE & CLAN SYSTEM
        // ============================================

        // Check auth state on load - only if Firebase is configured
        if (isFirebaseConfigured && auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    isGuestMode = false;
                    document.getElementById('loginModal').style.display = 'none';
                    updateUserUI();
                    await loadPlayerProfile(); // Load username and clan info
                } else if (!isGuestMode) {
                    currentUser = null;
                    document.getElementById('loginModal').style.display = 'flex';
                }
            });
        } else {
            // Firebase not configured - show login modal (guest mode available)
            document.getElementById('loginModal').style.display = 'flex';
        }

        // Update user UI in top bar
        function updateUserUI() {
            const topBar = document.getElementById('topBar');
            // Remove old user info if exists
            const oldInfo = document.querySelector('.user-info');
            if (oldInfo) oldInfo.remove();
            
            if (currentUser && auth) {
                // Logged in with Google
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                userInfo.innerHTML = `
                    <img src="${currentUser.photoURL}" class="user-avatar" alt="Avatar">
                    <span class="user-name">${currentUser.displayName}</span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                `;
                topBar.appendChild(userInfo);
                
                // Logout handler
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (auth) {
                        auth.signOut();
                        showFloatingText('Logged out', canvas.width / 2, 100, '#8a9aaa');
                    }
                });
            } else if (isGuestMode) {
                // Playing as guest
                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                
                if (isFirebaseConfigured) {
                    // Firebase is set up, show login option
                    userInfo.innerHTML = `
                        <span class="user-name" style="color: #8a9aaa;">ðŸ‘¤ Guest Mode</span>
                        <button class="logout-btn" id="loginBtn" style="background: linear-gradient(135deg, #4a7a6a, #3a6a5a); color: #5abaaa; border-color: #5a8a7a;">Login</button>
                    `;
                } else {
                    // Firebase not configured, can't login
                    userInfo.innerHTML = `
                        <span class="user-name" style="color: #8a9aaa;">ðŸ‘¤ Guest Mode</span>
                        <span style="color: #6a8a9a; font-size: 11px; margin-left: 10px;">(Login requires Firebase setup)</span>
                    `;
                }
                
                topBar.appendChild(userInfo);
                
                // Login button handler (only if Firebase configured)
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        isGuestMode = false;
                        document.getElementById('loginModal').style.display = 'flex';
                    });
                }
            }
        }


        // ========================================
        // GRAND EXCHANGE SYSTEM (OSRS-Style)
        // ========================================

        // Tradeable Resources
        // Sprite URLs (from game)
        const spriteUrls = {
            // Trees - Full grown by rarity
            'tree_common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/test%20tree.png',
            'tree_uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/uncommon%20tree.png',
            'tree_rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/rare%20tree.png',
            'tree_epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/epic%20tree.png',
            'tree_perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/perfect%20tree.png',
            
            // Tree growth stages (same for all rarities)
            'tree_stump': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/test%20stump.png',
            'tree_half': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/half%20tree.png',
            
            // Rocks/Ore - Full grown by rarity
            'ore_common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/common%20rock.png',
            'ore_uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/Uncommon%20rock.png',
            'ore_rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/rare%20rock.png',
            'ore_epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/epic%20rock.png',
            'ore_perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/Perfect%20Rock.png',
            
            // Rock growth stages (same for all rarities)
            'ore_stage1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/rock%201.png',
            'ore_stage2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Rocks/rock%202.png',
            
            // T1 Logs
            'log_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Common%20Log.png',
            'log_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Uncommon%20Log.png',
            'log_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Rare%20Log.png',
            'log_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Epic%20Log.png',
            'log_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Perfect%20Log.png',
            
            // T2 Logs
            'log_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T2%20Common%20Log.png',
            'log_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T2%20Uncommon%20Log.png',
            'log_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T2%20Rare%20Log.png',
            'log_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T2%20Epic%20Log.png',
            'log_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T2%20Perfect%20Log.png',
            
            // T3 Logs
            'log_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T3%20Common%20Log.png',
            'log_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T3%20Uncommon%20Log.png',
            'log_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T3%20Rare%20Log.png',
            'log_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T3%20Epic%20Log.png',
            'log_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T3%20Perfect%20Log.png',
            
            // T4 Logs
            'log_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T4%20Common%20Log.png',
            'log_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T4%20Uncommon%20Log.png',
            'log_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T4%20Rare%20Log.png',
            'log_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T4%20Epic%20Log.png',
            'log_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T4%20Perfect%20Log.png',
            
            // T5 Logs
            'log_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T5%20Common%20Log.png',
            'log_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T5%20Uncommon%20Log.png',
            'log_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T5%20Rare%20Log.png',
            'log_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T5%20Epic%20Log.png',
            'log_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T5%20Perfect%20Log.png',
            
            // T1 Ore - Using new Mining folder structure
            'ore_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Common%20Ore.png',
            'ore_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Uncommon%20Ore.png',
            'ore_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Rare%20Ore.png',
            'ore_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Epic%20Ore.png',
            'ore_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Perfect%20Ore.png',
            
            // T2 Ore
            'ore_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Common%20Ore.png',
            'ore_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Uncommon%20Ore.png',
            'ore_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Rare%20Ore.png',
            'ore_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Epic%20Ore.png',
            'ore_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Perfect%20ore.png',
            
            // T3 Ore
            'ore_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Common%20Ore.png',
            'ore_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Uncommon%20Ore.png',
            'ore_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Rare%20Ore.png',
            'ore_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Epic%20Ore.png',
            'ore_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Perfect%20Ore.png',
            
            // T4 Ore
            'ore_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Common%20Ore.png',
            'ore_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Uncommon%20Ore.png',
            'ore_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Rare%20Ore.png',
            'ore_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Epic%20Ore.png',
            'ore_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Perfect%20Ore.png',
            
            // T5 Ore
            'ore_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Common%20Ore.png',
            'ore_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Uncommon%20Ore.png',
            'ore_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Rare%20Ore.png',
            'ore_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Epic%20Ore.png',
            'ore_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Perfect%20Ore.png',
            
            // Emeralds (Rare drops from mining)
            'emerald': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Emerald.png', // Fallback for old emerald items
            'emerald_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Emerald.png',
            'emerald_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Emerald.png',
            'emerald_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Emerald.png',
            'emerald_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Emerald.png',
            'emerald_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Emerald.png',
            
            // T1 Raw Fish
            'fish_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Common%20Fish.png',
            'fish_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Uncommon%20Fish.png',
            'fish_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Rare%20Fish.png',
            'fish_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Epic%20Fish.png',
            'fish_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Perfect%20Fish.png',
            
            // T1 Cooked Fish
            'cookedfish_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Common%20Cooked%20Fish.png',
            'cookedfish_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Uncommon%20Cooked%20Fish.png',
            'cookedfish_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Rare%20Cooked%20Fish.png',
            'cookedfish_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Epic%20Cooked%20Fish.png',
            'cookedfish_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Perfect%20Cooked%20Fish.png',
            
            // T2 Fish  
            'fish_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Common%20Fish.png',
            'fish_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Uncommon%20Fish.png',
            'fish_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Rare%20Fish.png',
            'fish_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Epic%20Fish.png',
            'fish_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Perfect%20Fish.png',
            
            // T2 Cooked Fish
            'cookedfish_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Common%20Cooked%20Fish.png',
            'cookedfish_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Uncommon%20Cooked%20Fish.png',
            'cookedfish_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Rare%20Cooked%20Fish.png',
            'cookedfish_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Epic%20Cooked%20Fish.png',
            'cookedfish_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T2%20Perfect%20Cooked%20Fish.png',
            
            // T3 Fish
            'fish_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Common%20Fish.png',
            'fish_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Uncommon%20Fish.png',
            'fish_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Rare%20Fish.png',
            'fish_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Epic%20Fish.png',
            'fish_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Perfect%20Fish.png',
            
            // T3 Cooked Fish
            'cookedfish_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Common%20Cooked%20Fish.png',
            'cookedfish_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Uncommon%20Cooked%20Fish.png',
            'cookedfish_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Rare%20Cooked%20Fish.png',
            'cookedfish_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Epic%20Cooked%20Fish.png',
            'cookedfish_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T3%20Perfect%20Cooked%20Fish.png',
            
            // T4 Fish
            'fish_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Common%20Fish.png',
            'fish_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Uncommon%20Fish.png',
            'fish_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Rare%20Fish.png',
            'fish_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Epic%20Fish.png',
            'fish_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Perfect%20Fish.png',
            
            // T4 Cooked Fish
            'cookedfish_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Common%20Cooked%20Fish.png',
            'cookedfish_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Uncommon%20Cooked%20Fish.png',
            'cookedfish_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Rare%20Cooked%20Fish.png',
            'cookedfish_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Epic%20Cooked%20Fish.png',
            'cookedfish_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T4%20Perfect%20Cooked%20Fish.png',
            
            // T5 Fish
            'fish_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Common%20Fish.png',
            'fish_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Uncommon%20Fish.png',
            'fish_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Rare%20Fish.png',
            'fish_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Epic%20Fish.png',
            'fish_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Perfect%20Fish.png',
            
            // T5 Cooked Fish
            'cookedfish_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Common%20Cooked%20Fish.png',
            'cookedfish_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Uncommon%20Cooked%20Fish.png',
            'cookedfish_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Rare%20Cooked%20Fish.png',
            'cookedfish_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Epic%20Cooked%20Fish.png',
            'cookedfish_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T5%20Perfect%20Cooked%20Fish.png',
            
            // Acorns (from woodcutting)
            'acorn_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T1%20Acorn.png',
            'acorn_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T2%20Acorn.png',
            'acorn_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T3%20Acorn.png',
            'acorn_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T4%20Acorn.png',
            'acorn_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T5%20Acorn.png',
            
            // Roasted Acorns (from cooking)
            'roastedacorn_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T1%20Roasted%20Acorn.png',
            'roastedacorn_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T2%20Roasted%20Acorn.png',
            'roastedacorn_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T3%20Roasted%20Acorn.png',
            'roastedacorn_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T4%20Roasted%20Acorn.png',
            'roastedacorn_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T5%20Roasted%20Acorn.png',
            
            // T1 Bars (from Smithwright - ore conversion)
            'bar_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T1%20Common%20Bar.png',
            'bar_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T1%20Uncommon%20Bar.png',
            'bar_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T1%20Rare%20Bar.png',
            'bar_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T1%20Epic%20Bar.png',
            'bar_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T1%20Perfect%20Bar.png',
            
            // T2 Bars
            'bar_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T2%20Common%20Bar.png',
            'bar_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T2%20Uncommon%20Bar.png',
            'bar_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T2%20Rare%20Bar.png',
            'bar_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T2%20Epic%20Bar.png',
            'bar_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T2%20Perfect%20Bar.png',
            
            // T3 Bars
            'bar_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T3%20Common%20Bar.png',
            'bar_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T3%20Uncommon%20Bar.png',
            'bar_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T3%20Rare%20Bar.png',
            'bar_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T3%20Epic%20Bar.png',
            'bar_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T3%20Perfect%20Bar.png',
            
            // T4 Bars
            'bar_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T4%20Common%20Bar.png',
            'bar_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T4%20Uncommon%20Bar.png',
            'bar_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T4%20Rare%20Bar.png',
            'bar_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T4%20Epic%20Bar.png',
            'bar_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T4%20Perfect%20Bar.png',
            
            // T5 Bars
            'bar_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T5%20Common%20Bar.png',
            'bar_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T5%20Uncommon%20Bar.png',
            'bar_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T5%20Rare%20Bar.png',
            'bar_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T5%20Epic%20Bar.png',
            'bar_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Bars/T5%20Perfect%20Bar.png',
            
            // T1 Planks (from Smithwright - log conversion)
            'plank_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T1%20Common%20Plank.png',
            'plank_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T1%20Uncommon%20Plank.png',
            'plank_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T1%20Rare%20Plank.png',
            'plank_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T1%20Epic%20Plank.png',
            'plank_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T1%20Perfect%20Plank.png',
            
            // T2 Planks
            'plank_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T2%20Common%20Plank.png',
            'plank_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T2%20Uncommon%20Plank.png',
            'plank_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T2%20Rare%20Plank.png',
            'plank_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T2%20Epic%20Plank.png',
            'plank_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T2%20Perfect%20Plank.png',
            
            // T3 Planks
            'plank_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T3%20Common%20Plank.png',
            'plank_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T3%20Uncommon%20Plank.png',
            'plank_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T3%20Rare%20Plank.png',
            'plank_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T3%20Epic%20Plank.png',
            'plank_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T3%20Perfect%20Plank.png',
            
            // T4 Planks
            'plank_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T4%20Common%20Plank.png',
            'plank_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T4%20Uncommon%20Plank.png',
            'plank_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T4%20Rare%20Plank.png',
            'plank_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T4%20Epic%20Plank.png',
            'plank_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T4%20Perfect%20Plank.png',
            
            // T5 Planks
            'plank_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T5%20Common%20Plank.png',
            'plank_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T5%20Uncommon%20Plank.png',
            'plank_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T5%20Rare%20Plank.png',
            'plank_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T5%20Epic%20Plank.png',
            'plank_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/Smithwright/Planks/T5%20Perfect%20Plank.png',
            
            // Default fallbacks
            'log': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T1%20Common%20Log.png',
            'ore': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Common%20Ore.png',
            'fish': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T1%20Common%20Fish.png',
            'rune': null, // Runes will use emoji icons for now
            
            // Player Character Animations
            // Attacking Animation (12 frames)
            'char_attacking_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_000.png',
            'char_attacking_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_001.png',
            'char_attacking_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_002.png',
            'char_attacking_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_003.png',
            'char_attacking_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_004.png',
            'char_attacking_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_005.png',
            'char_attacking_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_006.png',
            'char_attacking_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_007.png',
            'char_attacking_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_008.png',
            'char_attacking_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_009.png',
            'char_attacking_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_010.png',
            'char_attacking_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Attacking/Attacking_011.png',
            
            // Dying Animation (15 frames)
            'char_dying_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_000.png',
            'char_dying_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_001.png',
            'char_dying_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_002.png',
            'char_dying_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_003.png',
            'char_dying_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_004.png',
            'char_dying_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_005.png',
            'char_dying_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_006.png',
            'char_dying_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_007.png',
            'char_dying_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_008.png',
            'char_dying_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_009.png',
            'char_dying_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_010.png',
            'char_dying_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_011.png',
            'char_dying_12': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_012.png',
            'char_dying_13': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_013.png',
            'char_dying_14': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Dying/Dying_014.png',
            
            // Hurt Animation (12 frames)
            'char_hurt_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_000.png',
            'char_hurt_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_001.png',
            'char_hurt_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_002.png',
            'char_hurt_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_003.png',
            'char_hurt_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_004.png',
            'char_hurt_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_005.png',
            'char_hurt_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_006.png',
            'char_hurt_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_007.png',
            'char_hurt_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_008.png',
            'char_hurt_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_009.png',
            'char_hurt_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_010.png',
            'char_hurt_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Hurt/Hurt_011.png',
            
            // Idle Animation (12 frames)
            'char_idle_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_000.png',
            'char_idle_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_001.png',
            'char_idle_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_002.png',
            'char_idle_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_003.png',
            'char_idle_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_004.png',
            'char_idle_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_005.png',
            'char_idle_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_006.png',
            'char_idle_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_007.png',
            'char_idle_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_008.png',
            'char_idle_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_009.png',
            'char_idle_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_010.png',
            'char_idle_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle/Idle_011.png',
            
            // Idle Blinking Animation (12 frames)
            'char_idleblink_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_000.png',
            'char_idleblink_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_001.png',
            'char_idleblink_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_002.png',
            'char_idleblink_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_003.png',
            'char_idleblink_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_004.png',
            'char_idleblink_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_005.png',
            'char_idleblink_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_006.png',
            'char_idleblink_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_007.png',
            'char_idleblink_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_008.png',
            'char_idleblink_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_009.png',
            'char_idleblink_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_010.png',
            'char_idleblink_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Idle%20Blinking/Idle%20Blinking_011.png',
            
            // Walking Animation (18 frames)
            'char_walking_0': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_000.png',
            'char_walking_1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_001.png',
            'char_walking_2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_002.png',
            'char_walking_3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_003.png',
            'char_walking_4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_004.png',
            'char_walking_5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_005.png',
            'char_walking_6': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_006.png',
            'char_walking_7': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_007.png',
            'char_walking_8': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_008.png',
            'char_walking_9': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_009.png',
            'char_walking_10': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_010.png',
            'char_walking_11': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_011.png',
            
            // Acorns (one per tier)
            'acorn_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T1%20Acorn.png',
            'acorn_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T2%20Acorn.png',
            'acorn_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T3%20Acorn.png',
            'acorn_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T4%20Acorn.png',
            'acorn_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T5%20Acorn.png',
            
            // Roasted Acorns (one per tier)
            'roastedacorn_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T1%20Roasted%20Acorn.png',
            'roastedacorn_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T2%20Roasted%20Acorn.png',
            'roastedacorn_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T3%20Roasted%20Acorn.png',
            'roastedacorn_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T4%20Roasted%20Acorn.png',
            'roastedacorn_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Acorns/T5%20Roasted%20Acorn.png',
            
            // T1 Emerald Amulets
            'amulet_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T1%20Common%20Emerald%20Amulet.png',
            'amulet_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T1%20Uncommon%20Emerald%20Amulet.png',
            'amulet_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T1%20Rare%20Emerald%20Amulet.png',
            'amulet_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T1%20Epic%20Emerald%20Amulet.png',
            'amulet_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T1%20Perfect%20Emerald%20Amulet.png',
            
            // T2 Emerald Amulets
            'amulet_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T2%20Common%20Emerald%20Amulet.png',
            'amulet_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T2%20Uncommon%20Emerald%20Amulet.png',
            'amulet_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T2%20Rare%20Emerald%20Amulet.png',
            'amulet_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T2%20Epic%20Emerald%20Amulet.png',
            'amulet_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T2%20Perfect%20Emerald%20Amulet.png',
            
            // T3 Emerald Amulets
            'amulet_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T3%20Common%20Emerald%20Amulet.png',
            'amulet_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T3%20Uncommon%20Emerald%20Amulet.png',
            'amulet_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T3%20Rare%20Emerald%20Amulet.png',
            'amulet_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T3%20Epic%20Emerald%20Amulet.png',
            'amulet_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T3%20Perfect%20Emerald%20Amulet.png',
            
            // T4 Emerald Amulets
            'amulet_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T4%20Common%20Emerald%20Amulet.png',
            'amulet_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T4%20Uncommon%20Emerald%20Amulet.png',
            'amulet_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T4%20Rare%20Emerald%20Amulet.png',
            'amulet_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T4%20Epic%20Emerald%20Amulet.png',
            'amulet_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T4%20Perfect%20Emerald%20Amulet.png',
            
            // T5 Emerald Amulets
            'amulet_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T5%20Common%20Emerald%20Amulet.png',
            'amulet_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T5%20Uncommon%20Emerald%20Amulet.png',
            'amulet_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T5%20Rare%20Emerald%20Amulet.png',
            'amulet_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T5%20Epic%20Emerald%20Amulet.png',
            'amulet_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T5%20Perfect%20Emerald%20Amulet.png',
            
            'char_walking_12': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_012.png',
            'char_walking_13': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_013.png',
            'char_walking_14': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_014.png',
            'char_walking_15': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_015.png',
            'char_walking_16': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_016.png',
            'char_walking_17': 'https://raw.githubusercontent.com/Graphic37/RPG/main/TestCharacter/Walking/Walking_017.png',
            
            // Clue Scrolls
            'cluescroll_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T1%20Clue%20Scroll.png',
            'cluescroll_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T2%20Clue%20Scroll.png',
            'cluescroll_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T3%20Clue%20Scroll.png',
            'cluescroll_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T4%20Clue%20Scroll.png',
            'cluescroll_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T5%20Clue%20Scroll.png',
            
            // Clue Chests
            'cluechest_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T1%20Clue%20Chest.png',
            'cluechest_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T2%20Clue%20Chest.png',
            'cluechest_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T3%20Clue%20Chest.png',
            'cluechest_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T4%20Clue%20Chest.png',
            'cluechest_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Clue%20Scrolls/T5%20Clue%20Chest.png',
            
            // Mage Books (T1-T5, Epic/Perfect/Rare)
            'magebook_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T1%20Epic%20Book.png',
            'magebook_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T1%20Perfect%20Book.png',
            'magebook_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T1%20Rare%20Book.png',
            'magebook_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T2%20Epic%20Book.png',
            'magebook_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T2%20Perfect%20Book.png',
            'magebook_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T2%20Rare%20Book.png',
            'magebook_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T3%20Epic%20Book.png',
            'magebook_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T3%20Perfect%20Book.png',
            'magebook_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T3%20Rare%20Book.png',
            'magebook_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T4%20Epic%20Book.png',
            'magebook_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T4%20Perfect%20Book.png',
            'magebook_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T4%20Rare%20Book.png',
            'magebook_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T5%20Epic%20Book.png',
            'magebook_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T5%20Perfect%20Book.png',
            'magebook_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T5%20Rare%20Book.png',
            
            // Mage Book Pages (T1-T5)
            'pages_T1': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T1%20Pages.png',
            'pages_T2': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T2%20Pages.png',
            'pages_T3': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T3%20Pages.png',
            'pages_T4': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T4%20Pages.png',
            'pages_T5': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mage%20Book/T5%20Pages.png',
            
            // ============ TOOLS ============
            
            // Axes (Woodcutting)
            'axe_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T1%20Common%20Axe.png',
            'axe_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T1%20Uncommon%20Axe.png',
            'axe_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T1%20Rare%20Axe.png',
            'axe_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T1%20Epic%20Axe.png',
            'axe_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T1%20Perfect%20Axe.png',
            
            'axe_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T2%20Common%20Axe.png',
            'axe_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T2%20Uncommon%20Axe.png',
            'axe_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T2%20Rare%20Axe.png',
            'axe_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T2%20Epic%20Axe.png',
            'axe_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T2%20Perfect%20Axe.png',
            
            'axe_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T3%20Common%20Axe.png',
            'axe_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T3%20Uncommon%20Axe.png',
            'axe_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T3%20Rare%20Axe.png',
            'axe_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T3%20Epic%20Axe.png',
            'axe_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T3%20Perfect%20Axe.png',
            
            'axe_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T4%20Common%20Axe.png',
            'axe_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T4%20Uncommon%20Axe.png',
            'axe_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T4%20Rare%20Axe.png',
            'axe_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T4%20Epic%20Axe.png',
            'axe_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T4%20Perfect%20Axe.png',
            
            'axe_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T5%20Common%20Axe.png',
            'axe_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T5%20Uncommon%20Axe.png',
            'axe_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T5%20Rare%20Axe.png',
            'axe_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T5%20Epic%20Axe.png',
            'axe_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Axe/T5%20Perfect%20Axe.png',
            
            // Cooking Knives (Cooking)
            'cookingknife_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T1%20Common%20Cooking%20Knife.png',
            'cookingknife_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T1%20Uncommon%20Cooking%20Knife.png',
            'cookingknife_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T1%20Rare%20Cooking%20Knife.png',
            'cookingknife_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T1%20Epic%20Cooking%20Knife.png',
            'cookingknife_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T1%20Perfect%20Cooking%20Knife.png',
            
            'cookingknife_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T2%20Common%20Cooking%20Knife.png',
            'cookingknife_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T2%20Uncommon%20Cooking%20Knife.png',
            'cookingknife_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T2%20Rare%20Cooking%20Knife.png',
            'cookingknife_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T2%20Epic%20Cooking%20Knife.png',
            'cookingknife_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T2%20Perfect%20Cooking%20Knife.png',
            
            'cookingknife_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T3%20Common%20Cooking%20Knife.png',
            'cookingknife_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T3%20Uncommon%20Cooking%20Knife.png',
            'cookingknife_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T3%20Rare%20Cooking%20Knife.png',
            'cookingknife_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T3%20Epic%20Cooking%20Knife.png',
            'cookingknife_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T3%20Perfect%20Cooking%20Knife.png',
            
            'cookingknife_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T4%20Common%20Cooking%20Knife.png',
            'cookingknife_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T4%20Uncommon%20Cooking%20Knife.png',
            'cookingknife_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T4%20Rare%20Cooking%20Knife.png',
            'cookingknife_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T4%20Epic%20Cooking%20Knife.png',
            'cookingknife_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T4%20Perfect%20Cooking%20Knife.png',
            
            'cookingknife_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T5%20Common%20Cooking%20Knife.png',
            'cookingknife_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T5%20Uncommon%20Cooking%20Knife.png',
            'cookingknife_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T5%20Rare%20Cooking%20Knife.png',
            'cookingknife_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T5%20Epic%20Cooking%20Knife.png',
            'cookingknife_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Cooking/T5%20Perfect%20Cooking%20Knife.png',
            
            // Fishing Poles (Fishing)
            'fishingpole_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T1%20Common%20Fishing%20Pole.png',
            'fishingpole_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T1%20Uncommon%20Fishing%20Pole.png',
            'fishingpole_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T1%20Rare%20Fishing%20Pole.png',
            'fishingpole_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T1%20Epic%20Fishing%20Pole.png',
            'fishingpole_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T1%20Perfect%20Fishing%20Net.png',
            
            'fishingpole_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T2%20Common%20Fishing%20Pole.png',
            'fishingpole_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T2%20Uncommon%20Fishing%20Pole.png',
            'fishingpole_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T2%20Rare%20Fishing%20Pole.png',
            'fishingpole_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T2%20Epic%20Fishing%20Pole.png',
            'fishingpole_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T2%20Perfect%20Fishing%20Net.png',
            
            'fishingpole_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T3%20Common%20Fishing%20Pole.png',
            'fishingpole_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T3%20Uncommon%20Fishing%20Pole.png',
            'fishingpole_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T3%20Rare%20Fishing%20Pole.png',
            'fishingpole_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T3%20Epic%20Fishing%20Pole.png',
            'fishingpole_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T3%20Perfect%20Fishing%20Net.png',
            
            'fishingpole_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T4%20Common%20Fishing%20Pole.png',
            'fishingpole_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T4%20Uncommon%20Fishing%20Pole.png',
            'fishingpole_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T4%20Rare%20Fishing%20Pole.png',
            'fishingpole_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T4%20Epic%20Fishing%20Pole.png',
            'fishingpole_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T4%20Perfect%20Fishing%20Net.png',
            
            'fishingpole_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T5%20Common%20Fishing%20Pole.png',
            'fishingpole_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T5%20Uncommon%20Fishing%20Pole.png',
            'fishingpole_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T5%20Rare%20Fishing%20Pole.png',
            'fishingpole_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T5%20Epic%20Fishing%20Pole.png',
            'fishingpole_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Fishing/T5%20Perfect%20Fishing%20Net.png',
            
            // Hammers (Carpentry)
            'hammer_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T1%20Common%20Hammer.png',
            'hammer_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T1%20Uncommon%20Hammer.png',
            'hammer_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T1%20Rare%20Hammer.png',
            'hammer_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T1%20Epic%20Hammer.png',
            'hammer_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T1%20Perfect%20Hammer.png',
            
            'hammer_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T2%20Common%20Hammer.png',
            'hammer_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T2%20Uncommon%20Hammer.png',
            'hammer_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T2%20Rare%20Hammer.png',
            'hammer_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T2%20Epic%20Hammer.png',
            'hammer_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T2%20Perfect%20Hammer.png',
            
            'hammer_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T3%20Common%20Hammer.png',
            'hammer_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T3%20Uncommon%20Hammer.png',
            'hammer_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T3%20Rare%20Hammer.png',
            'hammer_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T3%20Epic%20Hammer.png',
            'hammer_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T3%20Perfect%20Hammer.png',
            
            'hammer_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T4%20Common%20Hammer.png',
            'hammer_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T4%20Uncommon%20Hammer.png',
            'hammer_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T4%20Rare%20Hammer.png',
            'hammer_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T4%20Epic%20Hammer.png',
            'hammer_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T4%20Perfect%20Hammer.png',
            
            'hammer_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T5%20Common%20Hammer.png',
            'hammer_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T5%20Uncommon%20Hammer.png',
            'hammer_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T5%20Rare%20Hammer.png',
            'hammer_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T5%20Epic%20Hammer.png',
            'hammer_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Hammer/T5%20Perfect%20Hammer.png',
            
            // Pickaxes (Mining) - Additional files from Mining folder
            'pickaxe_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Common%20Pickaxe.png',
            'pickaxe_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Uncommon%20Pickaxe.png',
            'pickaxe_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Rare%20Pickaxe.png',
            'pickaxe_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Epic%20Pickaxe.png',
            'pickaxe_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Perfect%20Pickaxe.png',
            
            'pickaxe_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Common%20Pickaxe.png',
            'pickaxe_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Uncommon%20Pickaxe.png',
            'pickaxe_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Rare%20Pickaxe.png',
            'pickaxe_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Epic%20Pickaxe.png',
            'pickaxe_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T2%20Perfect%20Pickaxe.png',
            
            'pickaxe_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Common%20Pickaxe.png',
            'pickaxe_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Uncommon%20Pickaxe.png',
            'pickaxe_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Rare%20Pickaxe.png',
            'pickaxe_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Epic%20Pickaxe.png',
            'pickaxe_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T3%20Perfect%20Pickaxe.png',
            
            'pickaxe_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Common%20Pickaxe.png',
            'pickaxe_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Uncommon%20Pickaxe.png',
            'pickaxe_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Rare%20Pickaxe.png',
            'pickaxe_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Epic%20Pickaxe.png',
            'pickaxe_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T4%20Perfect%20Pickaxe.png',
            
            'pickaxe_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Common%20Pickaxe.png',
            'pickaxe_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Uncommon%20Pickaxe.png',
            'pickaxe_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Rare%20Pickaxe.png',
            'pickaxe_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Epic%20Pickaxe.png',
            'pickaxe_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T5%20Perfect%20Pickaxe.png',
            
            // Plundering Keys (Plundering)
            'plunderingkey_T1_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T1%20Common%20Plundering%20Key.png',
            'plunderingkey_T1_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T1%20Uncommon%20Plundering%20Key.png',
            'plunderingkey_T1_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T1%20Rare%20Plundering%20Key.png',
            'plunderingkey_T1_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T1%20Epic%20Plundering%20Key.png',
            'plunderingkey_T1_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T1%20Perfect%20Plundering%20Key.png',
            
            'plunderingkey_T2_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T2%20Common%20Plundering%20Key.png',
            'plunderingkey_T2_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T2%20Uncommon%20Plundering%20Key.png',
            'plunderingkey_T2_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T2%20Rare%20Plundering%20Key.png',
            'plunderingkey_T2_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T2%20Epic%20Plundering%20Key.png',
            'plunderingkey_T2_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T2%20Perfect%20Plundering%20Key.png',
            
            'plunderingkey_T3_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T3%20Common%20Plundering%20Key.png',
            'plunderingkey_T3_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T3%20Uncommon%20Plundering%20Key.png',
            'plunderingkey_T3_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T3%20Rare%20Plundering%20Key.png',
            'plunderingkey_T3_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T3%20Epic%20Plundering%20Key.png',
            'plunderingkey_T3_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T3%20Perfect%20Plundering%20Key.png',
            
            'plunderingkey_T4_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T4%20Common%20Plundering%20Key.png',
            'plunderingkey_T4_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T4%20Uncommon%20Plundering%20Key.png',
            'plunderingkey_T4_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T4%20Rare%20Plundering%20Key.png',
            'plunderingkey_T4_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T4%20Epic%20Plundering%20Key.png',
            'plunderingkey_T4_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T4%20Perfect%20Plundering%20Key.png',
            
            'plunderingkey_T5_Common': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T5%20Common%20Plundering%20Key.png',
            'plunderingkey_T5_Uncommon': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T5%20Uncommon%20Plundering%20Key.png',
            'plunderingkey_T5_Rare': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T5%20Rare%20Plundering%20Key.png',
            'plunderingkey_T5_Epic': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T5%20Epic%20Plundering%20Key.png',
            'plunderingkey_T5_Perfect': 'https://raw.githubusercontent.com/Graphic37/RPG/main/Plundering/T5%20Perfect%20Plundering%20Key.png'
        };

        // Generate TRADEABLE_ITEMS with all rarity variations
        const TRADEABLE_ITEMS = {};
        
        // Test sprite URLs access
        console.log('Testing sprite URLs:', {
            ore_T1_Common: spriteUrls['ore_T1_Common'],
            ore_T1_Uncommon: spriteUrls['ore_T1_Uncommon'],
            totalKeys: Object.keys(spriteUrls).length
        });
        
        // Test: Add a known working sprite to first ore item
        setTimeout(() => {
            if (TRADEABLE_ITEMS['T1 Common Ore']) {
                console.log('Setting sprite for T1 Common Ore');
                TRADEABLE_ITEMS['T1 Common Ore'].sprite = 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T1%20Common%20Ore.png';
            }
        }, 1000);
        
        // Rarity multipliers for pricing
        const rarityMultipliers = {
            'Common': 1,
            'Uncommon': 1.5,
            'Rare': 2.5,
            'Epic': 4,
            'Perfect': 7
        };
        
        // Base items with their tier prices
        const baseItems = [
            { name: 'Logs', icon: 'ðŸªµ', sprite: 'log', prices: [10, 25, 50, 75, 100] },
            { name: 'Ore', icon: 'â›ï¸', sprite: 'ore', prices: [15, 30, 60, 90, 120] },
            { name: 'Raw Fish', icon: 'ðŸŸ', sprite: 'fish', prices: [12, 28, 55, 80, 110] },
            { name: 'Rune', icon: 'âœ¨', sprite: 'rune', prices: [25, 55, 110, 170, 240] }
        ];
        
        // Acorns (no rarity variants - just tiers)
        for (let tier = 1; tier <= 5; tier++) {
            const basePrice = 5 + (tier * 5);
            TRADEABLE_ITEMS[`T${tier} Acorn`] = {
                icon: 'ðŸŒ°',
                basePrice: basePrice,
                tier: tier,
                sprite: spriteUrls[`acorn_T${tier}`] || null,
                stackable: true,
                type: 'food',
                rarity: 'common'
            };
            
            TRADEABLE_ITEMS[`T${tier} Roasted Acorn`] = {
                icon: 'ðŸ¥œ',
                basePrice: basePrice * 2,
                tier: tier,
                sprite: spriteUrls[`roastedacorn_T${tier}`] || null,
                stackable: true,
                type: 'food',
                rarity: 'common'
            };
        }
        
        // Generate entries for all tier and rarity combinations
        let debugCount = 0;
        
        // Test direct access to spriteUrls right before generation
        console.log('Direct spriteUrls test before generation:', {
            hasOreT1Common: !!spriteUrls['ore_T1_Common'],
            oreT1Common: spriteUrls['ore_T1_Common'],
            spriteUrlsType: typeof spriteUrls,
            spriteUrlsKeys: Object.keys(spriteUrls).length
        });
        
        baseItems.forEach(item => {
            for (let tier = 1; tier <= 5; tier++) {
                const basePrice = item.prices[tier - 1];
                Object.keys(rarityMultipliers).forEach(rarity => {
                    const itemKey = `T${tier} ${rarity} ${item.name}`;
                    
                    // Build the sprite key
                    const spriteKey = `${item.sprite}_T${tier}_${rarity}`;
                    
                    // Look up the sprite URL
                    const spriteUrl = spriteUrls[spriteKey];
                    
                    // Debug first few lookups
                    if (debugCount < 5) {
                        console.log(`Sprite lookup ${debugCount}:`, {
                            itemKey,
                            spriteKey,
                            spriteUrl: spriteUrl ? 'Found' : 'Not found',
                            url: spriteUrl
                        });
                        debugCount++;
                    }
                    
                    TRADEABLE_ITEMS[itemKey] = {
                        icon: item.icon,
                        basePrice: Math.floor(basePrice * rarityMultipliers[rarity]),
                        tier: tier,
                        rarity: rarity,
                        sprite: spriteUrl || null
                    };
                });
            }
        });
        
        // Debug: Log some examples
        console.log('TRADEABLE_ITEMS generated:', {
            'T1 Common Ore': TRADEABLE_ITEMS['T1 Common Ore'],
            'T1 Uncommon Ore': TRADEABLE_ITEMS['T1 Uncommon Ore'],
            'T1 Rare Ore': TRADEABLE_ITEMS['T1 Rare Ore'],
            totalItems: Object.keys(TRADEABLE_ITEMS).length
        });
        
        // Add Cooked Fish items (food category)
        const cookedFishPrices = [15, 35, 65, 95, 130]; // Slightly higher than raw fish
        for (let tier = 1; tier <= 5; tier++) {
            const basePrice = cookedFishPrices[tier - 1];
            Object.keys(rarityMultipliers).forEach(rarity => {
                const itemKey = `T${tier} ${rarity} Cooked Fish`;
                const spriteKey = `cookedfish_T${tier}_${rarity}`;
                TRADEABLE_ITEMS[itemKey] = {
                    icon: 'ðŸ–',
                    basePrice: Math.floor(basePrice * rarityMultipliers[rarity]),
                    tier: tier,
                    rarity: rarity,
                    sprite: spriteUrls[spriteKey] || null
                };
            });
        }
        
        // Add Arrows (ammunition)
        const arrowPrices = [5, 10, 15, 25, 35]; // Prices for each tier (lower since 1 ore + 1 log = 1 arrow)
        for (let tier = 1; tier <= 5; tier++) {
            TRADEABLE_ITEMS[`T${tier} Arrow`] = {
                icon: 'ðŸ¹',
                basePrice: arrowPrices[tier - 1],
                tier: tier,
                sprite: null,
                stackable: true,
                type: 'arrows' // Changed from 'ammunition' to match equipment slot
            };
        }
        
        // Add Emeralds (rare gems from white rock - 1% drop)
        const emeraldPrices = [100, 250, 500, 1000, 2000]; // High value rare items
        for (let tier = 1; tier <= 5; tier++) {
            TRADEABLE_ITEMS[`T${tier} Emerald`] = {
                icon: `emerald_T${tier}`,
                spriteKey: `emerald_T${tier}`,
                basePrice: emeraldPrices[tier - 1],
                tier: tier,
                stackable: true,
                type: 'gem',
                rarity: 'epic'
            };
        }
        
        // Add Bars (processed ore from Smithwright)
        const barBasePrices = [20, 40, 80, 120, 160]; // Slightly higher than ore
        for (let tier = 1; tier <= 5; tier++) {
            const basePrice = barBasePrices[tier - 1];
            Object.keys(rarityMultipliers).forEach(rarity => {
                const itemKey = `T${tier} ${rarity} Bar`;
                const spriteKey = `bar_T${tier}_${rarity}`;
                
                TRADEABLE_ITEMS[itemKey] = {
                    icon: 'âš™ï¸',
                    basePrice: Math.floor(basePrice * rarityMultipliers[rarity]),
                    tier: tier,
                    rarity: rarity,
                    sprite: spriteUrls[spriteKey] || null,
                    stackable: true,
                    type: 'processed'
                };
            });
        }
        
        // Add Planks (processed logs from Smithwright)
        const plankBasePrices = [15, 35, 70, 100, 135]; // Slightly higher than logs
        for (let tier = 1; tier <= 5; tier++) {
            const basePrice = plankBasePrices[tier - 1];
            Object.keys(rarityMultipliers).forEach(rarity => {
                const itemKey = `T${tier} ${rarity} Plank`;
                const spriteKey = `plank_T${tier}_${rarity}`;
                
                TRADEABLE_ITEMS[itemKey] = {
                    icon: 'ðŸ“',
                    basePrice: Math.floor(basePrice * rarityMultipliers[rarity]),
                    tier: tier,
                    rarity: rarity,
                    sprite: spriteUrls[spriteKey] || null,
                    stackable: true,
                    type: 'processed'
                };
            });
        }
        
        // More detailed debugging
        console.log('Ore items sprites:', Object.keys(TRADEABLE_ITEMS)
            .filter(key => key.includes('Ore'))
            .slice(0, 5)
            .map(key => ({ 
                key, 
                hasSprite: !!TRADEABLE_ITEMS[key].sprite,
                sprite: TRADEABLE_ITEMS[key].sprite
            }))
        );

        // ==================== TOOL ITEMS ====================
        // Tools provide speed bonuses for their respective skills
        // Each tier provides incrementally better bonuses
        
        const TOOL_ITEMS = {
            // Woodcutting Tools (Axes) - All Rarities
            'T1 Common Axe': { icon: 'ðŸª“', spriteKey: 'axe_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T1 Uncommon Axe': { icon: 'ðŸª“', spriteKey: 'axe_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T1 Rare Axe': { icon: 'ðŸª“', spriteKey: 'axe_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T1 Epic Axe': { icon: 'ðŸª“', spriteKey: 'axe_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T1 Perfect Axe': { icon: 'ðŸª“', spriteKey: 'axe_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            
            'T2 Common Axe': { icon: 'ðŸª“', spriteKey: 'axe_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T2 Uncommon Axe': { icon: 'ðŸª“', spriteKey: 'axe_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T2 Rare Axe': { icon: 'ðŸª“', spriteKey: 'axe_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T2 Epic Axe': { icon: 'ðŸª“', spriteKey: 'axe_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T2 Perfect Axe': { icon: 'ðŸª“', spriteKey: 'axe_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            
            'T3 Common Axe': { icon: 'ðŸª“', spriteKey: 'axe_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T3 Uncommon Axe': { icon: 'ðŸª“', spriteKey: 'axe_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T3 Rare Axe': { icon: 'ðŸª“', spriteKey: 'axe_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T3 Epic Axe': { icon: 'ðŸª“', spriteKey: 'axe_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T3 Perfect Axe': { icon: 'ðŸª“', spriteKey: 'axe_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            
            'T4 Common Axe': { icon: 'ðŸª“', spriteKey: 'axe_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T4 Uncommon Axe': { icon: 'ðŸª“', spriteKey: 'axe_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T4 Rare Axe': { icon: 'ðŸª“', spriteKey: 'axe_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T4 Epic Axe': { icon: 'ðŸª“', spriteKey: 'axe_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T4 Perfect Axe': { icon: 'ðŸª“', spriteKey: 'axe_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            
            'T5 Common Axe': { icon: 'ðŸª“', spriteKey: 'axe_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T5 Uncommon Axe': { icon: 'ðŸª“', spriteKey: 'axe_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T5 Rare Axe': { icon: 'ðŸª“', spriteKey: 'axe_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T5 Epic Axe': { icon: 'ðŸª“', spriteKey: 'axe_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            'T5 Perfect Axe': { icon: 'ðŸª“', spriteKey: 'axe_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'woodcutting', slot: 'axe', type: 'tool' },
            
            // Mining Tools (Pickaxes) - All Rarities
            'T1 Common Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T1 Uncommon Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T1 Rare Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T1 Epic Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T1 Perfect Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            
            'T2 Common Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T2 Uncommon Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T2 Rare Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T2 Epic Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T2 Perfect Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            
            'T3 Common Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T3 Uncommon Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T3 Rare Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T3 Epic Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T3 Perfect Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            
            'T4 Common Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T4 Uncommon Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T4 Rare Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T4 Epic Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T4 Perfect Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            
            'T5 Common Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T5 Uncommon Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T5 Rare Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T5 Epic Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            'T5 Perfect Pickaxe': { icon: 'â›ï¸', spriteKey: 'pickaxe_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'mining', slot: 'pickaxe', type: 'tool' },
            
            // Fishing Tools (Fishing Poles) - All Rarities
            'T1 Common Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T1 Uncommon Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T1 Rare Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T1 Epic Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T1 Perfect Fishing Net': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            
            'T2 Common Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T2 Uncommon Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T2 Rare Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T2 Epic Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T2 Perfect Fishing Net': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            
            'T3 Common Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T3 Uncommon Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T3 Rare Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T3 Epic Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T3 Perfect Fishing Net': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            
            'T4 Common Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T4 Uncommon Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T4 Rare Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T4 Epic Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T4 Perfect Fishing Net': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            
            'T5 Common Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T5 Uncommon Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T5 Rare Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T5 Epic Fishing Pole': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            'T5 Perfect Fishing Net': { icon: 'ðŸŽ£', spriteKey: 'fishingpole_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'fishing', slot: 'fishingRod', type: 'tool' },
            
            // Cooking Tools (Cooking Knives) - All Rarities
            'T1 Common Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T1 Uncommon Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T1 Rare Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T1 Epic Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T1 Perfect Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            
            'T2 Common Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T2 Uncommon Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T2 Rare Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T2 Epic Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T2 Perfect Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            
            'T3 Common Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T3 Uncommon Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T3 Rare Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T3 Epic Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T3 Perfect Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            
            'T4 Common Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T4 Uncommon Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T4 Rare Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T4 Epic Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T4 Perfect Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            
            'T5 Common Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T5 Uncommon Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T5 Rare Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T5 Epic Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            'T5 Perfect Cooking Knife': { icon: 'ðŸ³', spriteKey: 'cookingknife_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'cooking', slot: 'cookingUtensils', type: 'tool' },
            
            // Plundering Tools (Plundering Keys) - All Rarities
            'T1 Common Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T1 Uncommon Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T1 Rare Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T1 Epic Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T1 Perfect Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            
            'T2 Common Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T2 Uncommon Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T2 Rare Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T2 Epic Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T2 Perfect Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            
            'T3 Common Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T3 Uncommon Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T3 Rare Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T3 Epic Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T3 Perfect Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            
            'T4 Common Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T4 Uncommon Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T4 Rare Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T4 Epic Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T4 Perfect Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            
            'T5 Common Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T5 Uncommon Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T5 Rare Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T5 Epic Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            'T5 Perfect Plundering Key': { icon: 'ðŸ—ï¸', spriteKey: 'plunderingkey_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'plundering', slot: 'lockpick', type: 'tool' },
            
            // Carpentry Tools (Hammers) - All Rarities
            'T1 Common Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T1_Common', speedBonus: 5, tier: 1, rarity: 'Common', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T1 Uncommon Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T1_Uncommon', speedBonus: 7, tier: 1, rarity: 'Uncommon', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T1 Rare Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T1_Rare', speedBonus: 10, tier: 1, rarity: 'Rare', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T1 Epic Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T1_Epic', speedBonus: 15, tier: 1, rarity: 'Epic', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T1 Perfect Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T1_Perfect', speedBonus: 25, tier: 1, rarity: 'Perfect', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            
            'T2 Common Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T2_Common', speedBonus: 10, tier: 2, rarity: 'Common', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T2 Uncommon Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T2_Uncommon', speedBonus: 12, tier: 2, rarity: 'Uncommon', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T2 Rare Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T2_Rare', speedBonus: 15, tier: 2, rarity: 'Rare', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T2 Epic Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T2_Epic', speedBonus: 20, tier: 2, rarity: 'Epic', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T2 Perfect Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T2_Perfect', speedBonus: 30, tier: 2, rarity: 'Perfect', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            
            'T3 Common Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T3_Common', speedBonus: 15, tier: 3, rarity: 'Common', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T3 Uncommon Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T3_Uncommon', speedBonus: 17, tier: 3, rarity: 'Uncommon', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T3 Rare Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T3_Rare', speedBonus: 20, tier: 3, rarity: 'Rare', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T3 Epic Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T3_Epic', speedBonus: 25, tier: 3, rarity: 'Epic', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T3 Perfect Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T3_Perfect', speedBonus: 35, tier: 3, rarity: 'Perfect', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            
            'T4 Common Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T4_Common', speedBonus: 20, tier: 4, rarity: 'Common', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T4 Uncommon Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T4_Uncommon', speedBonus: 22, tier: 4, rarity: 'Uncommon', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T4 Rare Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T4_Rare', speedBonus: 25, tier: 4, rarity: 'Rare', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T4 Epic Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T4_Epic', speedBonus: 30, tier: 4, rarity: 'Epic', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T4 Perfect Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T4_Perfect', speedBonus: 40, tier: 4, rarity: 'Perfect', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            
            'T5 Common Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T5_Common', speedBonus: 25, tier: 5, rarity: 'Common', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T5 Uncommon Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T5_Uncommon', speedBonus: 27, tier: 5, rarity: 'Uncommon', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T5 Rare Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T5_Rare', speedBonus: 30, tier: 5, rarity: 'Rare', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T5 Epic Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T5_Epic', speedBonus: 35, tier: 5, rarity: 'Epic', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            'T5 Perfect Hammer': { icon: 'ðŸ”¨', spriteKey: 'hammer_T5_Perfect', speedBonus: 45, tier: 5, rarity: 'Perfect', skill: 'carpentry', slot: 'hammer', type: 'tool' },
            
            // Crafting Tools (Needles) - Keep original (no sprites yet)
            'T1 Needle': { icon: 'ðŸª¡', speedBonus: 5, tier: 1, skill: 'crafting', slot: 'needle', type: 'tool' },
            'T2 Needle': { icon: 'ðŸª¡', speedBonus: 10, tier: 2, skill: 'crafting', slot: 'needle', type: 'tool' },
            'T3 Needle': { icon: 'ðŸª¡', speedBonus: 15, tier: 3, skill: 'crafting', slot: 'needle', type: 'tool' },
            'T4 Needle': { icon: 'ðŸª¡', speedBonus: 20, tier: 4, skill: 'crafting', slot: 'needle', type: 'tool' },
            'T5 Needle': { icon: 'ðŸª¡', speedBonus: 25, tier: 5, skill: 'crafting', slot: 'needle', type: 'tool' },
            
            // Smithwright Tools (Tongs) - Keep original (no sprites yet)
            'T1 Tongs': { icon: 'ðŸ”§', speedBonus: 5, tier: 1, skill: 'smithwright', slot: 'tongs', type: 'tool' },
            'T2 Tongs': { icon: 'ðŸ”§', speedBonus: 10, tier: 2, skill: 'smithwright', slot: 'tongs', type: 'tool' },
            'T3 Tongs': { icon: 'ðŸ”§', speedBonus: 15, tier: 3, skill: 'smithwright', slot: 'tongs', type: 'tool' },
            'T4 Tongs': { icon: 'ðŸ”§', speedBonus: 20, tier: 4, skill: 'smithwright', slot: 'tongs', type: 'tool' },
            'T5 Tongs': { icon: 'ðŸ”§', speedBonus: 25, tier: 5, skill: 'smithwright', slot: 'tongs', type: 'tool' },
            
            // Agility Tools (Grappling Hooks) - Keep original (no sprites yet)
            'T1 Grappling Hook': { icon: 'ðŸª', speedBonus: 5, tier: 1, skill: 'agility', slot: 'grapplingHook', type: 'tool' },
            'T2 Grappling Hook': { icon: 'ðŸª', speedBonus: 10, tier: 2, skill: 'agility', slot: 'grapplingHook', type: 'tool' },
            'T3 Grappling Hook': { icon: 'ðŸª', speedBonus: 15, tier: 3, skill: 'agility', slot: 'grapplingHook', type: 'tool' },
            'T4 Grappling Hook': { icon: 'ðŸª', speedBonus: 20, tier: 4, skill: 'agility', slot: 'grapplingHook', type: 'tool' },
            'T5 Grappling Hook': { icon: 'ðŸª', speedBonus: 25, tier: 5, skill: 'agility', slot: 'grapplingHook', type: 'tool' }
        };
        
        // Add all tools to TRADEABLE_ITEMS for Grand Exchange
        Object.keys(TOOL_ITEMS).forEach(toolName => {
            const tool = TOOL_ITEMS[toolName];
            
            // Calculate base price based on RESOURCE COSTS to craft
            // Assumption: Tools require 3-5 bars/planks of the same tier/rarity
            const barBasePrices = [20, 40, 80, 120, 160]; // T1-T5 bar base prices
            const plankBasePrices = [15, 35, 70, 100, 135]; // T1-T5 plank base prices
            
            // Most tools use bars (metal), fishing poles use planks (wood)
            const isWoodenTool = tool.skill === 'fishing';
            const resourceBasePrice = isWoodenTool ? 
                plankBasePrices[tool.tier - 1] : 
                barBasePrices[tool.tier - 1];
            
            // Apply rarity multiplier to resource cost
            let rarityMult = 1;
            if (tool.rarity) {
                const rarityMultipliers = {
                    'Common': 1,
                    'Uncommon': 1.5,
                    'Rare': 2.5,
                    'Epic': 4,
                    'Perfect': 7
                };
                rarityMult = rarityMultipliers[tool.rarity] || 1;
            }
            
            // Tools cost approximately 4 bars/planks to craft
            const materialCost = Math.floor(resourceBasePrice * rarityMult * 4);
            
            // Add small crafting fee (10% markup)
            const finalPrice = Math.floor(materialCost * 1.1);
            
            TRADEABLE_ITEMS[toolName] = {
                icon: tool.icon,
                basePrice: finalPrice, // Guide price based on material costs
                tier: tool.tier,
                rarity: tool.rarity,
                sprite: tool.spriteKey ? (spriteUrls[tool.spriteKey] || null) : null,
                type: 'tool',
                skill: tool.skill,
                slot: tool.slot,
                speedBonus: tool.speedBonus
            };
        });
        
        console.log('Tool items loaded:', Object.keys(TOOL_ITEMS).length, 'tools');
        console.log('Tools added to Grand Exchange:', Object.keys(TRADEABLE_ITEMS).filter(k => TRADEABLE_ITEMS[k].type === 'tool').length);
        
        // ==================== END TOOL ITEMS ====================

        // Grand Exchange State
        let playerOffers = {
            buy: [null, null, null, null],
            sell: [null, null, null, null]
        };
        let guidePrices = {};
        let selectedSlot = null;
        let selectedGEItem = null;
        let selectedGEItemMaxQty = 0;
        let selectedGEItemFullName = null; // Full name with rarity for sell items
        let geListeners = [];
        let geInitialized = false;

        // Initialize Grand Exchange
        function initGrandExchange() {
            if (!isFirebaseConfigured || !database) {
                console.log('Grand Exchange requires Firebase');
                return;
            }
            
            loadPlayerOffers();
            loadGuidePrices();
            setupGEEventListeners();
            startOfferMatching();
            initializeMarketTracking(); // Track market trends and price history
        }

        // Load player's offers from Firebase
        function loadPlayerOffers() {
            if (!currentUser) return;

            const offersRef = database.ref(`grandExchange/playerOffers/${currentUser.uid}`);
            offersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Ensure both buy and sell are actual arrays, not objects
                    // Firebase can convert arrays with nulls to objects
                    const buyArray = data.buy ? Object.values(data.buy) : [null, null, null, null];
                    const sellArray = data.sell ? Object.values(data.sell) : [null, null, null, null];
                    
                    // Ensure arrays have exactly 4 slots
                    while (buyArray.length < 4) buyArray.push(null);
                    while (sellArray.length < 4) sellArray.push(null);
                    
                    playerOffers = {
                        buy: buyArray.slice(0, 4),
                        sell: sellArray.slice(0, 4)
                    };
                    updateOfferSlots();
                }
            });
        }

        // Load guide prices
        function loadGuidePrices() {
            const pricesRef = database.ref('grandExchange/guidePrices');
            pricesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    guidePrices = data;
                } else {
                    // Initialize with base prices
                    Object.keys(TRADEABLE_ITEMS).forEach(itemName => {
                        guidePrices[itemName] = TRADEABLE_ITEMS[itemName].basePrice;
                    });
                    database.ref('grandExchange/guidePrices').set(guidePrices);
                }
            });
        }

        // Update offer slots display
        function updateOfferSlots() {
            console.log('updateOfferSlots called, playerOffers:', playerOffers);
            
            // Ensure playerOffers has proper structure
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];
            
            ['buy', 'sell'].forEach(type => {
                playerOffers[type].forEach((offer, index) => {
                    const slot = document.querySelector(`.offer-slot[data-slot-type="${type}"][data-slot-index="${index}"]`);
                    console.log(`Slot ${type}[${index}]:`, { slot, offer });
                    if (!slot) {
                        console.warn(`Slot not found for ${type}[${index}]`);
                        return;
                    }
                    
                    if (offer) {
                        slot.classList.remove('empty');
                        
                        const progress = (offer.quantityFilled / offer.quantity) * 100;
                        
                        if (offer.quantityFilled >= offer.quantity) {
                            slot.classList.add('completed');
                            slot.classList.remove('active', 'partial');
                        } else if (offer.quantityFilled > 0) {
                            slot.classList.add('partial');
                            slot.classList.remove('active', 'completed');
                        } else {
                            slot.classList.add('active');
                            slot.classList.remove('partial', 'completed');
                        }

                        let itemData = TRADEABLE_ITEMS[offer.itemName];
                        
                        // BACKWARDS COMPATIBILITY: Handle old format "Logs (Tier 1)" -> "T1 Common Logs"
                        if (!itemData && offer.itemName) {
                            const oldFormatMatch = offer.itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                            if (oldFormatMatch) {
                                const [, baseName, tier] = oldFormatMatch;
                                const newItemName = `T${tier} Common ${baseName}`;
                                console.log('Converting old format:', { old: offer.itemName, new: newItemName });
                                itemData = TRADEABLE_ITEMS[newItemName];
                                // Update the offer itemName for future use
                                offer.itemName = newItemName;
                            }
                        }
                        
                        // Try to get sprite from multiple sources
                        let iconDisplay = 'ðŸ“¦'; // Default fallback
                        
                        // 1. Try stored icon key + spriteUrls lookup
                        if (offer.icon && spriteUrls[offer.icon]) {
                            iconDisplay = `<img src="${spriteUrls[offer.icon]}" style="width: 32px; height: 32px; object-fit: contain;">`;
                        }
                        // 2. Try TRADEABLE_ITEMS sprite
                        else if (itemData?.sprite) {
                            iconDisplay = `<img src="${itemData.sprite}" style="width: 32px; height: 32px; object-fit: contain;">`;
                        }
                        // 3. Try TRADEABLE_ITEMS icon (emoji)
                        else if (itemData?.icon) {
                            iconDisplay = itemData.icon;
                        }
                        // 4. Try stored icon directly (might be emoji)
                        else if (offer.icon && !offer.icon.includes('_')) {
                            iconDisplay = offer.icon;
                        }
                        
                        // Determine progress bar color
                        let progressColor = '#00ff00'; // Green for completed
                        if (progress === 0) {
                            progressColor = '#555555'; // Dark gray for empty
                        } else if (progress < 100) {
                            progressColor = '#ffaa00'; // Yellow/orange for partial
                        }
                        
                        const displayName = offer.itemName || 'Unknown Item';
                        
                        const html = `
                            <div class="slot-item-icon">${iconDisplay}</div>
                            <div class="slot-item-name">${displayName}</div>
                            <div class="slot-quantity">${offer.quantityFilled}/${offer.quantity}</div>
                            <div class="slot-progress-bar">
                                <div class="slot-progress-fill" style="width: ${progress}%; background-color: ${progressColor};"></div>
                            </div>
                            <div class="slot-status">${offer.pricePerItem} gp</div>
                        `;
                        console.log(`Setting slot ${type}[${index}] HTML:`, html);
                        slot.innerHTML = html;
                    } else {
                        slot.classList.add('empty');
                        slot.classList.remove('active', 'partial', 'completed');
                        slot.innerHTML = '';
                    }
                });
            });
        }

        // Setup event listeners
        function setupGEEventListeners() {
            // Slot clicks
            document.querySelectorAll('.offer-slot').forEach(slot => {
                slot.addEventListener('click', () => handleSlotClick(slot));
            });

            // Close button
            document.getElementById('closeGE').addEventListener('click', () => {
                document.getElementById('grandExchangeModal').style.display = 'none';
                resetUIPosition('grandExchangeModal');
            });
            
            // Collect All button
            document.getElementById('collectAllOffers').addEventListener('click', collectAllOffers);
            
            // Cancel All button
            document.getElementById('cancelAllOffers').addEventListener('click', cancelAllOffers);

            // Buy offer form
            setupBuyOfferForm();
            
            // Sell offer form
            setupSellOfferForm();
            
            // Cancel/collect buttons
            document.getElementById('cancelOffer').addEventListener('click', handleCancelOffer);
            document.getElementById('collectOffer').addEventListener('click', handleCollectOffer);
        }

        // Handle slot click
        function handleSlotClick(slot) {
            const type = slot.dataset.slotType;
            const index = parseInt(slot.dataset.slotIndex);
            selectedSlot = { type, index };

            const offer = playerOffers[type][index];

            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));

            if (offer) {
                displayOfferStatus(offer, type, index);
                document.getElementById('viewOffer').classList.add('active');
            } else {
                if (type === 'buy') {
                    resetBuyForm();
                    document.getElementById('createBuyOffer').classList.add('active');
                } else {
                    resetSellForm();
                    loadGEInventory();
                    document.getElementById('createSellOffer').classList.add('active');
                }
            }
        }

        // Setup buy offer form
        function setupBuyOfferForm() {
            const searchInput = document.getElementById('buyItemSearch');
            const resultsDiv = document.getElementById('buyItemResults');
            const priceInput = document.getElementById('buyPrice');
            const quantityInput = document.getElementById('buyQuantity');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                if (query.length === 0) {
                    resultsDiv.innerHTML = '';
                    return;
                }

                // Use smart search with multi-word AND logic
                const results = Object.keys(TRADEABLE_ITEMS).filter(name => 
                    smartSearchMatch(name, query)
                );

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 20px; color: #8a7a6a; text-align: center;">No items found. Try different keywords.</div>';
                    return;
                }

                resultsDiv.innerHTML = results.map(itemName => {
                    const item = TRADEABLE_ITEMS[itemName];
                    const guidePrice = guidePrices[itemName] || item.basePrice;
                    
                    // Prioritize item.sprite, then generate URL based on pattern
                    let imageUrl = item.sprite;
                    
                    // If no sprite defined, try to generate URL based on item name pattern
                    if (!imageUrl) {
                        // Special handling for Raw Fish and Cooked Fish (4-word patterns)
                        let match = itemName.match(/^T(\d+)\s+(\w+)\s+(Raw|Cooked)\s+Fish$/);
                        if (match) {
                            const [_, tier, rarity, fishType] = match;
                            
                            if (fishType === 'Raw') {
                                // Raw Fish uses regular Fish sprites
                                imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                            } else if (fishType === 'Cooked') {
                                // Cooked Fish uses Cooked Fish sprites
                                imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Cooked%20Fish.png`;
                            }
                        } else {
                            // Parse the item name to get components (e.g., "T1 Common Ore")
                            match = itemName.match(/^T(\d+)\s+(\w+)\s+(\w+)$/);
                            if (match) {
                                const [_, tier, rarity, type] = match;
                                
                                // Build the GitHub URL directly based on new repo structure
                                if (type === 'Ore') {
                                    imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T${tier}%20${rarity}%20Ore.png`;
                                } else if (type === 'Logs') {
                                    imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T${tier}%20${rarity}%20Log.png`;
                                } else if (type === 'Fish') {
                                    imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                                } else if (type === 'Rune') {
                                    // Runes use emoji icons, no sprite needed
                                    imageUrl = null;
                                } else if (type === 'Bar') {
                                    imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Bars/T${tier}%20${rarity}%20Bar.png`;
                                } else if (type === 'Plank') {
                                    imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Planks/T${tier}%20${rarity}%20Plank.png`;
                                }
                            }
                        }
                    }
                    
                    // Use image if we have a URL, otherwise fall back to emoji icon
                    const iconDisplay = imageUrl 
                        ? `<img src="${imageUrl}" alt="${itemName}" style="width: 100%; height: 100%;" onerror="this.style.display='none'; this.nextSibling.style.display='inline'"><span style="display:none">${item.icon}</span>` 
                        : item.icon;
                    
                    return `
                        <div class="ge-item-result" data-item="${itemName}">
                            <div class="ge-item-result-icon">${iconDisplay}</div>
                            <div class="ge-item-result-info">
                                <div class="ge-item-result-name">${itemName}</div>
                                <div class="ge-item-result-price">Guide: ${guidePrice} gp</div>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsDiv.querySelectorAll('.ge-item-result').forEach(result => {
                    result.addEventListener('click', () => {
                        selectBuyItem(result.dataset.item);
                    });
                });
            });

            // OSRS-Style +/- buttons for quantity
            const buyQtyMinus = document.getElementById('buyQtyMinus');
            const buyQtyPlus = document.getElementById('buyQtyPlus');
            if (buyQtyMinus) {
                buyQtyMinus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.max(1, current - 1);
                    updateBuyTotal();
                });
            }
            if (buyQtyPlus) {
                buyQtyPlus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = current + 1;
                    updateBuyTotal();
                });
            }

            // OSRS-Style +/- buttons for price
            const buyPriceMinus = document.getElementById('buyPriceMinus');
            const buyPricePlus = document.getElementById('buyPricePlus');
            const buyPriceGuide = document.getElementById('buyPriceGuide');
            const buyPriceMore = document.getElementById('buyPriceMore');
            
            if (buyPriceMinus) {
                buyPriceMinus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = Math.max(1, current - 1);
                    updateBuyTotal();
                });
            }
            if (buyPricePlus) {
                buyPricePlus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = current + 1;
                    updateBuyTotal();
                });
            }
            if (buyPriceGuide) {
                buyPriceGuide.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = guidePrice;
                    updateBuyTotal();
                });
            }
            if (buyPriceMore) {
                buyPriceMore.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = Math.ceil(guidePrice * 1.05);
                    updateBuyTotal();
                });
            }

            // Price controls (old style - keep for compatibility)
            document.querySelectorAll('#createBuyOffer .ge-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (!selectedGEItem) return;
                    
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    
                    if (action === 'guide') {
                        priceInput.value = guidePrice;
                    } else if (action === '5%') {
                        priceInput.value = Math.ceil(guidePrice * 1.05);
                    } else if (action === '10%') {
                        priceInput.value = Math.ceil(guidePrice * 1.10);
                    }
                    updateBuyTotal();
                });
            });

            // Quantity controls
            document.querySelectorAll('#createBuyOffer .ge-qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const qtyStr = btn.dataset.qty;
                    const current = parseInt(quantityInput.value) || 1;
                    
                    if (qtyStr === '-max') {
                        quantityInput.value = 1;
                    } else {
                        const qty = parseInt(qtyStr);
                        quantityInput.value = current + qty;
                    }
                    updateBuyTotal();
                });
            });

            // Back button
            const buyBackBtn = document.getElementById('buyBackBtn');
            if (buyBackBtn) {
                buyBackBtn.addEventListener('click', () => {
                    resetBuyForm();
                    document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                    document.getElementById('emptyState').classList.add('active');
                });
            }

            priceInput.addEventListener('input', updateBuyTotal);
            quantityInput.addEventListener('input', updateBuyTotal);

            document.getElementById('confirmBuy').addEventListener('click', confirmBuyOffer);
        }

        // Select buy item
        function selectBuyItem(itemName) {
            selectedGEItem = itemName;
            const item = TRADEABLE_ITEMS[itemName];
            const guidePrice = guidePrices[itemName] || item.basePrice;

            // Hide search, show item display
            document.getElementById('buySearchGroup').style.display = 'none';
            document.getElementById('buySelectedItem').style.display = 'block';
            
            // Update item display - prioritize item.sprite, then generate URL
            const iconEl = document.getElementById('buyItemIcon');
            
            // Prioritize item.sprite property
            let imageUrl = item.sprite;
            
            // If no sprite defined, try to generate URL based on item name pattern
            if (!imageUrl) {
                // Special handling for Raw Fish and Cooked Fish
                let match = itemName.match(/^T(\d+)\s+(\w+)\s+(Raw|Cooked)\s+Fish$/);
                if (match) {
                    const [_, tier, rarity, fishType] = match;
                    
                    if (fishType === 'Raw') {
                        // Raw Fish uses regular Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                    } else if (fishType === 'Cooked') {
                        // Cooked Fish uses Cooked Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Cooked%20Fish.png`;
                    }
                } else {
                    match = itemName.match(/^T(\d+)\s+(\w+)\s+(\w+)$/);
                    if (match) {
                        const [_, tier, rarity, type] = match;
                        
                        if (type === 'Ore') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T${tier}%20${rarity}%20Ore.png`;
                        } else if (type === 'Logs') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T${tier}%20${rarity}%20Log.png`;
                        } else if (type === 'Fish') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                        } else if (type === 'Rune') {
                            imageUrl = `null; // Runes use emoji icons`;
                        } else if (type === 'Bar') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Bars/T${tier}%20${rarity}%20Bar.png`;
                        } else if (type === 'Plank') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Planks/T${tier}%20${rarity}%20Plank.png`;
                        }
                    }
                }
            }
            
            if (imageUrl) {
                iconEl.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentNode.innerText='${item.icon}'">`;
            } else {
                iconEl.textContent = item.icon;
            }
            
            document.getElementById('buyItemName').textContent = itemName;
            
            // Enhanced price info with market trends
            let priceInfo = `Guide price: ${guidePrice} gp`;
            if (marketData[itemName]) {
                const data = marketData[itemName];
                const arrow = data.priceChange > 0 ? 'ðŸ“ˆ' : data.priceChange < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                priceInfo += ` <span style="color: ${changeColor};">${arrow} ${data.priceChange !== 0 ? data.priceChange.toFixed(1) + '%' : ''}</span>`;
                if (data.totalVolume > 0) {
                    priceInfo += `<br><span style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</span>`;
                }
            }
            document.getElementById('buyItemPriceInfo').innerHTML = priceInfo;

            document.getElementById('buyItemSearch').value = itemName;
            document.getElementById('buyItemResults').innerHTML = '';
            document.getElementById('buyPrice').value = guidePrice;
            document.getElementById('buyGuidePrice').textContent = `Guide price: ${guidePrice} gp`;
            
            document.getElementById('buyPriceGroup').style.display = 'block';
            document.getElementById('buyQuantityGroup').style.display = 'block';
            document.getElementById('buyTotal').style.display = 'block';
            document.getElementById('buyActions').style.display = 'flex';

            updateBuyTotal();
        }

        // Update buy total
        function updateBuyTotal() {
            const price = parseInt(document.getElementById('buyPrice').value) || 0;
            const quantity = parseInt(document.getElementById('buyQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('buyTotalAmount').textContent = total.toLocaleString();
        }

        // Confirm buy offer
        async function confirmBuyOffer() {
            if (!selectedSlot || !selectedGEItem) return;
            
            // Check if database is available
            if (!database) {
                showFloatingText('Market unavailable - database not connected', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Ensure we have a user (even guest)
            if (!currentUser) {
                currentUser = {
                    uid: 'guest-testing',
                    email: 'guest@testing.com',
                    displayName: 'Guest'
                };
            }

            const price = parseInt(document.getElementById('buyPrice').value);
            const quantity = parseInt(document.getElementById('buyQuantity').value);
            const total = price * quantity;

            if (price <= 0 || quantity <= 0) {
                showFloatingText('Invalid price or quantity', canvas.width / 2, 100, '#ff4444');
                return;
            }

            if (gameState.player.gold < total) {
                showFloatingText('Not enough gold!', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Deduct gold
            gameState.player.gold -= total;

            // Construct icon key from item name (e.g., "T1 Common Ore" -> "ore_T1_Common")
            let itemIcon = null;
            const match = selectedGEItem.match(/^T(\d+)\s+(\w+)\s+(.+)$/);
            if (match) {
                const [, tier, rarity, baseName] = match;
                const baseKey = baseName.toLowerCase();
                itemIcon = `${baseKey}_T${tier}_${rarity}`;
            }

            const offer = {
                itemName: selectedGEItem,
                icon: itemIcon,
                pricePerItem: price,
                quantity: quantity,
                quantityFilled: 0,
                type: 'buy',
                playerId: currentUser.uid,
                playerName: (playerProfile && playerProfile.username) ? playerProfile.username : (currentUser.email ? currentUser.email.split('@')[0] : 'Player'),
                timestamp: Date.now(),
                status: 'active',
                collectedItems: 0,
                goldSpent: total
            };

            // Ensure playerOffers has both buy and sell arrays
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];

            playerOffers.buy[selectedSlot.index] = offer;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            const offerRef = database.ref('grandExchange/activeOffers/buy').push();
            await offerRef.set({
                ...offer,
                offerId: offerRef.key,
                slotIndex: selectedSlot.index
            });

            // Update UI immediately
            updateOfferSlots();
            
            resetBuyForm();
            showFloatingText('Buy offer created!', canvas.width / 2, 100, '#00ff00');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Reset buy form
        function resetBuyForm() {
            document.getElementById('buyItemSearch').value = '';
            document.getElementById('buyItemResults').innerHTML = '';
            document.getElementById('buySearchGroup').style.display = 'block';
            document.getElementById('buySelectedItem').style.display = 'none';
            document.getElementById('buyPriceGroup').style.display = 'none';
            document.getElementById('buyQuantityGroup').style.display = 'none';
            document.getElementById('buyTotal').style.display = 'none';
            document.getElementById('buyActions').style.display = 'none';
            selectedGEItem = null;
        }

        // Setup sell offer form
        function setupSellOfferForm() {
            const searchInput = document.getElementById('sellItemSearch');
            const resultsDiv = document.getElementById('sellItemResults');
            const priceInput = document.getElementById('sellPrice');
            const quantityInput = document.getElementById('sellQuantity');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                loadGEInventory(query);
            });


            // OSRS-Style +/- buttons for quantity
            const sellQtyMinus = document.getElementById('sellQtyMinus');
            const sellQtyPlus = document.getElementById('sellQtyPlus');
            if (sellQtyMinus) {
                sellQtyMinus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.max(1, current - 1);
                    updateSellTotal();
                });
            }
            if (sellQtyPlus) {
                sellQtyPlus.addEventListener('click', () => {
                    const current = parseInt(quantityInput.value) || 1;
                    quantityInput.value = Math.min(current + 1, selectedGEItemMaxQty);
                    updateSellTotal();
                });
            }

            // OSRS-Style +/- buttons for price
            const sellPriceMinus = document.getElementById('sellPriceMinus');
            const sellPricePlus = document.getElementById('sellPricePlus');
            const sellPriceGuide = document.getElementById('sellPriceGuide');
            
            if (sellPriceMinus) {
                sellPriceMinus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = Math.max(1, current - 1);
                    updateSellTotal();
                });
            }
            if (sellPricePlus) {
                sellPricePlus.addEventListener('click', () => {
                    const current = parseInt(priceInput.value) || 1;
                    priceInput.value = current + 1;
                    updateSellTotal();
                });
            }
            if (sellPriceGuide) {
                sellPriceGuide.addEventListener('click', () => {
                    if (!selectedGEItem) return;
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    priceInput.value = guidePrice;
                    updateSellTotal();
                });
            }

            // Back button
            const sellBackBtn = document.getElementById('sellBackBtn');
            if (sellBackBtn) {
                sellBackBtn.addEventListener('click', () => {
                    resetSellForm();
                    document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                    document.getElementById('emptyState').classList.add('active');
                });
            }


            // Price controls
            document.querySelectorAll('#createSellOffer .ge-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (!selectedGEItem) return;
                    
                    const guidePrice = guidePrices[selectedGEItem] || TRADEABLE_ITEMS[selectedGEItem].basePrice;
                    
                    if (action === 'guide') {
                        priceInput.value = guidePrice;
                    } else if (action === '-5%') {
                        priceInput.value = Math.floor(guidePrice * 0.95);
                    } else if (action === '-10%') {
                        priceInput.value = Math.floor(guidePrice * 0.90);
                    }
                    updateSellTotal();
                });
            });

            // Quantity controls
            document.querySelectorAll('#createSellOffer .ge-qty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.qty === 'max') {
                        quantityInput.value = selectedGEItemMaxQty;
                    } else {
                        const qty = parseInt(btn.dataset.qty);
                        const current = parseInt(quantityInput.value) || 0;
                        quantityInput.value = Math.min(current + qty, selectedGEItemMaxQty);
                    }
                    updateSellTotal();
                });
            });

            priceInput.addEventListener('input', updateSellTotal);
            quantityInput.addEventListener('input', () => {
                const val = parseInt(quantityInput.value) || 0;
                quantityInput.value = Math.min(val, selectedGEItemMaxQty);
                updateSellTotal();
            });

            document.getElementById('confirmSell').addEventListener('click', confirmSellOffer);
        }

        // Load inventory for GE
        function loadGEInventory(searchQuery = '') {
            const resultsDiv = document.getElementById('sellItemResults');
            
            console.log('loadGEInventory called with search:', searchQuery);
            console.log('Current inventory:', gameState.player.inventory.filter(i => i).map(i => ({ name: i.name, tier: i.tier, rarity: i.rarity })));
            
            // Filter inventory for tradeable items using smart search
            const tradeableInventory = gameState.player.inventory.filter(item => {
                if (!item) return false;
                
                // Use the full item name (includes tier and rarity)
                const isTradeable = TRADEABLE_ITEMS[item.name];
                if (!isTradeable) {
                    console.log('Item NOT tradeable:', { itemName: item.name, allKeys: Object.keys(TRADEABLE_ITEMS).slice(0, 10) });
                }
                return isTradeable && smartSearchMatch(item.name, searchQuery);
            });

            if (tradeableInventory.length === 0) {
                const message = searchQuery 
                    ? `No items found matching "${searchQuery}". Try different keywords.`
                    : 'No tradeable items';
                resultsDiv.innerHTML = `<div style="padding: 20px; color: #8a7a6a; text-align: center;">${message}</div>`;
                return;
            }

            resultsDiv.innerHTML = tradeableInventory.map(item => {
                const itemData = TRADEABLE_ITEMS[item.name];
                const guidePrice = guidePrices[item.name] || itemData.basePrice;
                
                // Direct URL generation based on item name pattern
                let imageUrl = null;
                
                // Special handling for Raw Fish and Cooked Fish
                let match = item.name.match(/^T(\d+)\s+(\w+)\s+(Raw|Cooked)\s+Fish$/);
                if (match) {
                    const [_, tier, rarity, fishType] = match;
                    
                    if (fishType === 'Raw') {
                        // Raw Fish uses regular Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                    } else if (fishType === 'Cooked') {
                        // Cooked Fish uses Cooked Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Cooked%20Fish.png`;
                    }
                } else {
                    // Parse the item name to get components (e.g., "T1 Common Ore")
                    match = item.name.match(/^T(\d+)\s+(\w+)\s+(\w+)$/);
                    if (match) {
                        const [_, tier, rarity, type] = match;
                        
                        // Build the GitHub URL directly based on new repo structure
                        if (type === 'Ore') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T${tier}%20${rarity}%20Ore.png`;
                        } else if (type === 'Logs') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T${tier}%20${rarity}%20Log.png`;
                        } else if (type === 'Fish') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                        } else if (type === 'Rune') {
                            imageUrl = `null; // Runes use emoji icons`;
                        }
                    }
                }
                
                const iconDisplay = imageUrl ? 
                    `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.nextSibling.style.display='inline'"><span style="display:none">${itemData.icon}</span>` : 
                    itemData.icon;
                
                // Show item name with quantity
                const displayName = `${item.name} (${item.quantity})`;
                
                return `
                    <div class="ge-item-result" data-item="${item.name}" data-quantity="${item.quantity}">
                        <div class="ge-item-result-icon">${iconDisplay}</div>
                        <div class="ge-item-result-info">
                            <div class="ge-item-result-name">${displayName}</div>
                            <div class="ge-item-result-price">Guide: ${guidePrice} gp</div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsDiv.querySelectorAll('.ge-item-result').forEach(result => {
                result.addEventListener('click', () => {
                    selectSellItem(result.dataset.item, parseInt(result.dataset.quantity));
                });
            });
        }

        // Select sell item
        function selectSellItem(itemName, availableQty) {
            console.log('selectSellItem called with:', { itemName, availableQty });
            selectedGEItem = itemName;
            selectedGEItemMaxQty = availableQty;
            selectedGEItemFullName = itemName; // Full name is the same as itemName now
            const item = TRADEABLE_ITEMS[itemName];
            console.log('TRADEABLE_ITEMS lookup:', { itemName, item, exists: !!item });
            
            if (!item) {
                console.error('Item not found in TRADEABLE_ITEMS!', { itemName, availableKeys: Object.keys(TRADEABLE_ITEMS).filter(k => k.includes('Ore')) });
                showFloatingText('Error: Item not tradeable!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            const guidePrice = guidePrices[itemName] || item.basePrice;

            // Hide search, show item display
            document.getElementById('sellSearchGroup').style.display = 'none';
            document.getElementById('sellSelectedItem').style.display = 'block';
            
            // Update item display - prioritize item.sprite, then generate URL
            const iconEl = document.getElementById('sellItemIcon');
            
            // Prioritize item.sprite property
            let imageUrl = item.sprite;
            
            // If no sprite defined, try to generate URL based on item name pattern
            if (!imageUrl) {
                // Special handling for Raw Fish and Cooked Fish
                let match = itemName.match(/^T(\d+)\s+(\w+)\s+(Raw|Cooked)\s+Fish$/);
                if (match) {
                    const [_, tier, rarity, fishType] = match;
                    
                    if (fishType === 'Raw') {
                        // Raw Fish uses regular Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                    } else if (fishType === 'Cooked') {
                        // Cooked Fish uses Cooked Fish sprites
                        imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Cooked%20Fish.png`;
                    }
                } else {
                    match = itemName.match(/^T(\d+)\s+(\w+)\s+(\w+)$/);
                    if (match) {
                        const [_, tier, rarity, type] = match;
                        
                        if (type === 'Ore') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/T${tier}%20${rarity}%20Ore.png`;
                        } else if (type === 'Logs') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Logs/T${tier}%20${rarity}%20Log.png`;
                        } else if (type === 'Fish') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Fish/T${tier}%20${rarity}%20Fish.png`;
                        } else if (type === 'Rune') {
                            imageUrl = `null; // Runes use emoji icons`;
                        } else if (type === 'Bar') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Bars/T${tier}%20${rarity}%20Bar.png`;
                        } else if (type === 'Plank') {
                            imageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Planks/T${tier}%20${rarity}%20Plank.png`;
                        }
                    }
                }
            }
            
            if (imageUrl) {
                iconEl.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentNode.innerText='${item.icon}'">`;
            } else {
                iconEl.textContent = item.icon;
            }
            
            document.getElementById('sellItemName').textContent = itemName; // Show full name with rarity
            document.getElementById('sellItemAvailable').textContent = `Available: ${availableQty}`;
            
            // Enhanced price info with market trends
            let priceInfo = `Guide price: ${guidePrice} gp`;
            if (marketData[itemName]) {
                const data = marketData[itemName];
                const arrow = data.priceChange > 0 ? 'ðŸ“ˆ' : data.priceChange < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                priceInfo += ` <span style="color: ${changeColor};">${arrow} ${data.priceChange !== 0 ? data.priceChange.toFixed(1) + '%' : ''}</span>`;
                if (data.totalVolume > 0) {
                    priceInfo += `<br><span style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</span>`;
                }
            }
            document.getElementById('sellItemPriceInfo').innerHTML = priceInfo;

            document.getElementById('sellItemSearch').value = itemName;
            document.getElementById('sellPrice').value = guidePrice;
            document.getElementById('sellQuantity').max = availableQty;
            document.getElementById('sellQuantity').value = 1;
            document.getElementById('sellGuidePrice').textContent = `Guide price: ${guidePrice} gp`;
            
            document.getElementById('sellPriceGroup').style.display = 'block';
            document.getElementById('sellQuantityGroup').style.display = 'block';
            document.getElementById('sellTotal').style.display = 'block';
            document.getElementById('sellActions').style.display = 'flex';

            updateSellTotal();
        }

        // Update sell total
        function updateSellTotal() {
            const price = parseInt(document.getElementById('sellPrice').value) || 0;
            const quantity = parseInt(document.getElementById('sellQuantity').value) || 0;
            const total = price * quantity;
            const afterTax = Math.floor(total * 0.99);
            document.getElementById('sellTotalAmount').textContent = afterTax.toLocaleString();
        }

        // Confirm sell offer
        async function confirmSellOffer() {
            console.log('confirmSellOffer called:', { selectedSlot, selectedGEItem, selectedGEItemFullName });
            if (!selectedSlot || !selectedGEItem) return;
            
            // Check if database is available
            if (!database) {
                showFloatingText('Market unavailable - database not connected', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Ensure we have a user (even guest)
            if (!currentUser) {
                currentUser = {
                    uid: 'guest-testing',
                    email: 'guest@testing.com',
                    displayName: 'Guest'
                };
            }

            const price = parseInt(document.getElementById('sellPrice').value);
            const quantity = parseInt(document.getElementById('sellQuantity').value);

            if (price <= 0 || quantity <= 0) {
                showFloatingText('Invalid price or quantity', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Remove items from inventory using full name (includes rarity)
            const itemIndex = gameState.player.inventory.findIndex(item => 
                item && item.name === selectedGEItemFullName
            );

            if (itemIndex === -1 || gameState.player.inventory[itemIndex].quantity < quantity) {
                showFloatingText('Not enough items!', canvas.width / 2, 100, '#ff4444');
                return;
            }

            // Get the item's icon for display before removing from inventory
            const itemIcon = gameState.player.inventory[itemIndex]?.icon || null;

            gameState.player.inventory[itemIndex].quantity -= quantity;
            if (gameState.player.inventory[itemIndex].quantity <= 0) {
                gameState.player.inventory.splice(itemIndex, 1);
            }

            console.log('Creating sell offer with itemName:', selectedGEItem);
            const offer = {
                itemName: selectedGEItem,
                icon: itemIcon,
                pricePerItem: price,
                quantity: quantity,
                quantityFilled: 0,
                type: 'sell',
                playerId: currentUser.uid,
                playerName: (playerProfile && playerProfile.username) ? playerProfile.username : (currentUser.email ? currentUser.email.split('@')[0] : 'Player'),
                timestamp: Date.now(),
                status: 'active',
                collectedGold: 0
            };
            console.log('Created offer object:', offer);

            // Ensure playerOffers has both buy and sell arrays
            if (!playerOffers.buy) playerOffers.buy = [null, null, null, null];
            if (!playerOffers.sell) playerOffers.sell = [null, null, null, null];
            
            playerOffers.sell[selectedSlot.index] = offer;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            const offerRef = database.ref('grandExchange/activeOffers/sell').push();
            await offerRef.set({
                ...offer,
                offerId: offerRef.key,
                slotIndex: selectedSlot.index
            });

            // Update UI immediately
            updateOfferSlots();
            updateInventoryDisplay();
            
            resetSellForm();
            showFloatingText('Sell offer created!', canvas.width / 2, 100, '#00ff00');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Reset sell form
        function resetSellForm() {
            document.getElementById('sellItemSearch').value = '';
            document.getElementById('sellItemResults').innerHTML = '';
            document.getElementById('sellSearchGroup').style.display = 'block';
            document.getElementById('sellSelectedItem').style.display = 'none';
            document.getElementById('sellPriceGroup').style.display = 'none';
            document.getElementById('sellQuantityGroup').style.display = 'none';
            document.getElementById('sellTotal').style.display = 'none';
            document.getElementById('sellActions').style.display = 'none';
            selectedGEItem = null;
            selectedGEItemMaxQty = 0;
            selectedGEItemFullName = null;
        }

        // Display offer status
        function displayOfferStatus(offer, type, index) {
            const statusDiv = document.getElementById('offerStatus');
            
            // Check if offer or itemName is invalid
            if (!offer || !offer.itemName) {
                statusDiv.innerHTML = `
                    <div class="ge-status-row">
                        <span class="ge-status-label">Error:</span>
                        <span class="ge-status-value">Unknown Item</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="cancelOffer('${type}', ${index})" class="ge-btn-secondary" style="width: 100%;">Cancel Offer</button>
                    </div>
                `;
                return;
            }
            
            const percentage = (offer.quantityFilled / offer.quantity * 100).toFixed(0);
            
            // BACKWARDS COMPATIBILITY: Handle old format
            let displayItemName = offer.itemName;
            if (!TRADEABLE_ITEMS[offer.itemName]) {
                const oldFormatMatch = offer.itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                if (oldFormatMatch) {
                    const [, baseName, tier] = oldFormatMatch;
                    displayItemName = `T${tier} Common ${baseName}`;
                }
            }
            
            statusDiv.innerHTML = `
                <div class="ge-status-row">
                    <span class="ge-status-label">Item:</span>
                    <span class="ge-status-value">${displayItemName}</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Type:</span>
                    <span class="ge-status-value">${type === 'buy' ? 'ðŸ”½ Buying' : 'ðŸ”¼ Selling'}</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Price per item:</span>
                    <span class="ge-status-value">${offer.pricePerItem} gp</span>
                </div>
                <div class="ge-status-row">
                    <span class="ge-status-label">Progress:</span>
                    <span class="ge-status-value">${offer.quantityFilled} / ${offer.quantity}</span>
                </div>
                <div class="ge-progress-bar">
                    <div class="ge-progress-fill" style="width: ${percentage}%"></div>
                    <div class="ge-progress-text">${percentage}%</div>
                </div>
            `;

            // Show/hide buttons based on offer status
            const cancelBtn = document.getElementById('cancelOffer');
            const collectBtn = document.getElementById('collectOffer');
            
            if (offer.quantityFilled >= offer.quantity) {
                // Offer is 100% complete - show collect only
                collectBtn.style.display = 'block';
                collectBtn.textContent = 'Collect Items';
                cancelBtn.style.display = 'none';
            } else if (offer.quantityFilled > 0) {
                // Offer is partially filled - show BOTH buttons
                collectBtn.style.display = 'block';
                collectBtn.textContent = 'Collect Partial';
                cancelBtn.style.display = 'block';
            } else {
                // Offer is 0% filled - show cancel only
                collectBtn.style.display = 'none';
                collectBtn.textContent = 'Collect Items'; // Reset text
                cancelBtn.style.display = 'block';
            }
        }

        // Handle cancel offer
        async function handleCancelOffer() {
            if (!selectedSlot) return;

            const { type, index } = selectedSlot;
            const offer = playerOffers[type][index];

            if (!offer) return;
            
            // Only prevent canceling 100% completed offers
            if (offer.quantityFilled >= offer.quantity) {
                showFloatingText('Offer is complete - use Collect Items instead', canvas.width / 2, 100, '#ffaa66');
                return;
            }

            const hasPartialFill = offer.quantityFilled > 0;
            const confirmMsg = hasPartialFill 
                ? 'Cancel this offer? Already filled items will be returned to you.'
                : 'Cancel this offer?';
            
            if (!confirm(confirmMsg)) return;

            // Return items/gold for partial fills
            if (type === 'buy') {
                const unfilled = offer.quantity - offer.quantityFilled;
                const goldToReturn = unfilled * offer.pricePerItem;
                gameState.player.gold += goldToReturn;
                
                // Return filled items if any
                if (offer.quantityFilled > 0) {
                    // Check if itemName is valid
                    if (!offer.itemName) {
                        console.error('Cannot return items: itemName is undefined', { offer });
                        showFloatingText('Error: Unknown item in offer', canvas.width / 2, 100, '#ff4444');
                        // Still remove the offer and return gold
                        gameState.player.gold += offer.quantityFilled * offer.pricePerItem;
                    } else {
                        // BACKWARDS COMPATIBILITY: Convert old format to new
                        let itemName = offer.itemName;
                        if (!TRADEABLE_ITEMS[itemName]) {
                            const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                            if (oldFormatMatch) {
                                const [, baseName, tier] = oldFormatMatch;
                                itemName = `T${tier} Common ${baseName}`;
                            }
                        }
                        
                        const itemData = TRADEABLE_ITEMS[itemName];
                        if (!itemData) {
                            console.error('Cannot return items: item not found', { itemName, offer });
                            showFloatingText('Error returning items!', canvas.width / 2, 100, '#ff4444');
                            return;
                        }
                        
                        const itemToAdd = {
                            name: itemName,
                            tier: itemData.tier,
                            rarity: itemData.rarity,
                            rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                            icon: itemData.icon,
                            stackable: true,
                            type: 'resource'
                        };
                        
                        // Add sprite if available
                        if (itemData.sprite) {
                            const spriteKey = getResourceIcon(offer.itemName.includes('Fish') ? 'fish' : 
                                                             offer.itemName.includes('Ore') ? 'ore' :
                                                             offer.itemName.includes('Logs') ? 'log' :
                                                             offer.itemName.includes('Rune') ? 'rune' : '',
                                                             itemData.tier, itemData.rarity);
                            if (gameState.sprites[spriteKey]) {
                                itemToAdd.customSprite = gameState.sprites[spriteKey];
                            }
                        }
                        
                        for (let i = 0; i < offer.quantityFilled; i++) {
                            addToInventory(itemToAdd);
                        }
                    }
                }
            } else {
                // Return unsold items
                const unsold = offer.quantity - offer.quantityFilled;
                if (unsold > 0) {
                    // Check if itemName is valid
                    if (!offer.itemName) {
                        console.error('Cannot return items: itemName is undefined', { offer });
                        showFloatingText('Error: Unknown item in offer', canvas.width / 2, 100, '#ff4444');
                        // Continue to remove the offer
                    } else {
                        // BACKWARDS COMPATIBILITY: Convert old format to new
                        let itemName = offer.itemName;
                        if (!TRADEABLE_ITEMS[itemName]) {
                            const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                            if (oldFormatMatch) {
                                const [, baseName, tier] = oldFormatMatch;
                                itemName = `T${tier} Common ${baseName}`;
                            }
                        }
                        
                        const itemData = TRADEABLE_ITEMS[itemName];
                        if (!itemData) {
                            console.error('Cannot return items: item not found', { itemName, offer });
                            showFloatingText('Error returning items!', canvas.width / 2, 100, '#ff4444');
                            // Continue to remove the offer and return collected gold
                        } else {
                            const itemToAdd = {
                                name: itemName,
                                tier: itemData.tier,
                                rarity: itemData.rarity,
                                rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                                icon: itemData.icon,
                                stackable: true,
                                type: 'resource'
                            };
                            
                            // Add sprite if available
                            if (itemData.sprite) {
                                const spriteKey = getResourceIcon(offer.itemName.includes('Fish') ? 'fish' : 
                                                                 offer.itemName.includes('Ore') ? 'ore' :
                                                                 offer.itemName.includes('Logs') ? 'log' :
                                                                 offer.itemName.includes('Rune') ? 'rune' : '',
                                                                 itemData.tier, itemData.rarity);
                                if (gameState.sprites[spriteKey]) {
                                    itemToAdd.customSprite = gameState.sprites[spriteKey];
                                }
                            }
                            
                            for (let i = 0; i < unsold; i++) {
                                addToInventory(itemToAdd);
                            }
                        }
                    }
                }
                
                // Return collected gold if any
                if (offer.quantityFilled > 0) {
                    const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                    gameState.player.gold += goldReceived;
                }
            }

            // Remove from active offers
            const activeOffersRef = database.ref(`grandExchange/activeOffers/${type}`);
            const snapshot = await activeOffersRef.once('value');
            snapshot.forEach(child => {
                if (child.val().playerId === currentUser.uid && child.val().slotIndex === index) {
                    child.ref.remove();
                }
            });

            playerOffers[type][index] = null;
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);

            updateOfferSlots();
            updateInventoryDisplay();
            
            showFloatingText('Offer cancelled', canvas.width / 2, 100, '#ffaa66');
            
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            document.getElementById('emptyState').classList.add('active');
        }

        // Handle collect offer
        async function handleCollectOffer() {
            if (!selectedSlot) return;

            const { type, index } = selectedSlot;
            const offer = playerOffers[type][index];

            if (!offer || offer.quantityFilled === 0) return;
            
            const isFullyComplete = offer.quantityFilled >= offer.quantity;
            const confirmMsg = isFullyComplete 
                ? `Collect all ${offer.quantityFilled} items?`
                : `Collect ${offer.quantityFilled} of ${offer.quantity} items? (Offer will remain active for the rest)`;
            
            if (!confirm(confirmMsg)) return;

            if (type === 'buy') {
                // BACKWARDS COMPATIBILITY: Convert old format to new
                let itemName = offer.itemName;
                if (!TRADEABLE_ITEMS[itemName]) {
                    const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                    if (oldFormatMatch) {
                        const [, baseName, tier] = oldFormatMatch;
                        itemName = `T${tier} Common ${baseName}`;
                    }
                }
                
                // Add items to inventory - itemName now includes full rarity info
                const itemData = TRADEABLE_ITEMS[itemName];
                
                if (!itemData) {
                    console.error('Cannot collect: item not found in TRADEABLE_ITEMS', { itemName, offer });
                    showFloatingText('Error collecting items!', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                // Create item with the exact name from the offer
                const itemToAdd = {
                    name: itemName,
                    tier: itemData.tier,
                    rarity: itemData.rarity,
                    rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                    icon: itemData.icon,
                    stackable: true,
                    type: 'resource'
                };
                
                // Add all collected items
                for (let i = 0; i < offer.quantityFilled; i++) {
                    addToInventory(itemToAdd);
                }
                
                showFloatingText(`Collected ${offer.quantityFilled}x ${itemName}!`, canvas.width / 2, 100, '#FFD700');
            } else {
                // Add gold (sell offer)
                const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                gameState.player.gold += goldReceived;
                showFloatingText(`Collected ${goldReceived} gold!`, canvas.width / 2, 100, '#FFD700');
            }

            if (isFullyComplete) {
                // Offer is 100% complete - remove it entirely
                playerOffers[type][index] = null;
                
                // Remove from active offers in database
                const activeOffersRef = database.ref(`grandExchange/activeOffers/${type}`);
                const snapshot = await activeOffersRef.once('value');
                snapshot.forEach(child => {
                    if (child.val().playerId === currentUser.uid && child.val().slotIndex === index) {
                        child.ref.remove();
                    }
                });
            } else {
                // Partial collection - reset quantityFilled but keep offer active
                const collectedAmount = offer.quantityFilled;
                offer.quantityFilled = 0;
                
                if (type === 'buy') {
                    offer.collectedItems = (offer.collectedItems || 0) + collectedAmount;
                } else {
                    offer.collectedGold = (offer.collectedGold || 0) + Math.floor(offer.pricePerItem * collectedAmount * 0.99);
                }
                
                playerOffers[type][index] = offer;
                
                // Update the active offer in database
                const activeOffersRef = database.ref(`grandExchange/activeOffers/${type}`);
                const snapshot = await activeOffersRef.once('value');
                snapshot.forEach(child => {
                    const activeOffer = child.val();
                    if (activeOffer.playerId === currentUser.uid && activeOffer.slotIndex === index) {
                        child.ref.update({ quantityFilled: 0 });
                    }
                });
            }
            
            await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);
            updateOfferSlots();
            updateInventoryDisplay();

            if (isFullyComplete) {
                document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                document.getElementById('emptyState').classList.add('active');
            } else {
                // Refresh the offer status display
                displayOfferStatus(playerOffers[type][index], type, index);
            }
        }

        // Collect all completed offers
        async function collectAllOffers() {
            let totalGold = 0;
            let totalItems = 0;
            let offersCleared = false;

            // Check all buy and sell offers
            for (let type of ['buy', 'sell']) {
                for (let index = 0; index < playerOffers[type].length; index++) {
                    const offer = playerOffers[type][index];
                    
                    // Only collect completed offers
                    if (offer && offer.quantityFilled >= offer.quantity) {
                        offersCleared = true;
                        
                        if (type === 'buy') {
                            // BACKWARDS COMPATIBILITY: Convert old format to new
                            let itemName = offer.itemName;
                            if (!TRADEABLE_ITEMS[itemName]) {
                                const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                                if (oldFormatMatch) {
                                    const [, baseName, tier] = oldFormatMatch;
                                    itemName = `T${tier} Common ${baseName}`;
                                }
                            }
                            
                            // Add items to inventory - itemName now includes full rarity info
                            const itemData = TRADEABLE_ITEMS[itemName];
                            
                            if (itemData) {
                                const itemToAdd = {
                                    name: itemName,
                                    tier: itemData.tier,
                                    rarity: itemData.rarity,
                                    rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                                    icon: itemData.icon,
                                    stackable: true,
                                    type: 'resource'
                                };
                                
                                // Add sprite if available
                                if (itemData.sprite) {
                                    const spriteKey = getResourceIcon(offer.itemName.includes('Fish') ? 'fish' : 
                                                                     offer.itemName.includes('Ore') ? 'ore' :
                                                                     offer.itemName.includes('Logs') ? 'log' :
                                                                     offer.itemName.includes('Rune') ? 'rune' : '',
                                                                     itemData.tier, itemData.rarity);
                                    if (gameState.sprites[spriteKey]) {
                                        itemToAdd.customSprite = gameState.sprites[spriteKey];
                                    }
                                }
                                
                                for (let i = 0; i < offer.quantityFilled; i++) {
                                    addToInventory(itemToAdd);
                                }
                                
                                totalItems += offer.quantityFilled;
                            } else {
                                console.error('collectAllOffers: Item not found', { itemName, offer });
                            }
                        } else {
                            // Add gold
                            const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                            gameState.player.gold += goldReceived;
                            totalGold += goldReceived;
                        }
                        
                        // Clear the offer
                        playerOffers[type][index] = null;
                    }
                }
            }

            if (offersCleared) {
                // Save to Firebase
                await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);
                
                // Update UI
                updateOfferSlots();
                updateInventoryDisplay();
                
                // Show summary message
                let message = 'Collected: ';
                if (totalItems > 0) message += `${totalItems} items`;
                if (totalGold > 0 && totalItems > 0) message += ' + ';
                if (totalGold > 0) message += `${totalGold} gold`;
                
                showFloatingText(message, canvas.width / 2, 100, '#FFD700');
            } else {
                showFloatingText('No completed offers to collect', canvas.width / 2, 100, '#ff9933');
            }
        }

        // Cancel All active (non-completed) offers
        async function cancelAllOffers() {
            let totalGoldReturned = 0;
            let totalItemsReturned = 0;
            let offersCancelled = 0;

            if (!confirm('Cancel all active offers? This will return items and gold to you.')) {
                return;
            }

            // Check all buy and sell offers
            for (let type of ['buy', 'sell']) {
                for (let index = 0; index < playerOffers[type].length; index++) {
                    const offer = playerOffers[type][index];
                    
                    // Only cancel non-completed offers
                    if (offer && offer.quantityFilled < offer.quantity) {
                        offersCancelled++;
                        
                        if (type === 'buy') {
                            // Return unfilled gold
                            const unfilled = offer.quantity - offer.quantityFilled;
                            const goldToReturn = unfilled * offer.pricePerItem;
                            gameState.player.gold += goldToReturn;
                            totalGoldReturned += goldToReturn;
                            
                            // Return filled items if any
                            if (offer.quantityFilled > 0) {
                                let itemName = offer.itemName;
                                if (!TRADEABLE_ITEMS[itemName]) {
                                    const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                                    if (oldFormatMatch) {
                                        const [, baseName, tier] = oldFormatMatch;
                                        itemName = `T${tier} Common ${baseName}`;
                                    }
                                }
                                
                                const itemData = TRADEABLE_ITEMS[itemName];
                                if (itemData) {
                                    const itemToAdd = {
                                        name: itemName,
                                        tier: itemData.tier,
                                        rarity: itemData.rarity,
                                        rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                                        icon: itemData.icon,
                                        stackable: true,
                                        type: 'resource'
                                    };
                                    
                                    // Add sprite if available
                                    if (itemData.sprite) {
                                        const spriteKey = getResourceIcon(offer.itemName.includes('Fish') ? 'fish' : 
                                                                         offer.itemName.includes('Ore') ? 'ore' :
                                                                         offer.itemName.includes('Logs') ? 'log' :
                                                                         offer.itemName.includes('Rune') ? 'rune' : '',
                                                                         itemData.tier, itemData.rarity);
                                        if (gameState.sprites[spriteKey]) {
                                            itemToAdd.customSprite = gameState.sprites[spriteKey];
                                        }
                                    }
                                    
                                    for (let i = 0; i < offer.quantityFilled; i++) {
                                        addToInventory(itemToAdd);
                                    }
                                    totalItemsReturned += offer.quantityFilled;
                                }
                            }
                        } else {
                            // Return unsold items
                            const unsold = offer.quantity - offer.quantityFilled;
                            if (unsold > 0) {
                                let itemName = offer.itemName;
                                if (!TRADEABLE_ITEMS[itemName]) {
                                    const oldFormatMatch = itemName.match(/^(.+?)\s+\(Tier\s+(\d+)\)$/);
                                    if (oldFormatMatch) {
                                        const [, baseName, tier] = oldFormatMatch;
                                        itemName = `T${tier} Common ${baseName}`;
                                    }
                                }
                                
                                const itemData = TRADEABLE_ITEMS[itemName];
                                if (itemData) {
                                    const itemToAdd = {
                                        name: itemName,
                                        tier: itemData.tier,
                                        rarity: itemData.rarity,
                                        rarityColor: resourceRarities[itemData.rarity.toLowerCase()]?.color || '#ffffff',
                                        icon: itemData.icon,
                                        stackable: true,
                                        type: 'resource'
                                    };
                                    
                                    // Add sprite if available
                                    if (itemData.sprite) {
                                        const spriteKey = getResourceIcon(offer.itemName.includes('Fish') ? 'fish' : 
                                                                         offer.itemName.includes('Ore') ? 'ore' :
                                                                         offer.itemName.includes('Logs') ? 'log' :
                                                                         offer.itemName.includes('Rune') ? 'rune' : '',
                                                                         itemData.tier, itemData.rarity);
                                        if (gameState.sprites[spriteKey]) {
                                            itemToAdd.customSprite = gameState.sprites[spriteKey];
                                        }
                                    }
                                    
                                    for (let i = 0; i < unsold; i++) {
                                        addToInventory(itemToAdd);
                                    }
                                    totalItemsReturned += unsold;
                                }
                            }
                            
                            // Return collected gold if any
                            if (offer.quantityFilled > 0) {
                                const goldReceived = Math.floor(offer.pricePerItem * offer.quantityFilled * 0.99);
                                gameState.player.gold += goldReceived;
                                totalGoldReturned += goldReceived;
                            }
                        }
                        
                        // Remove from active offers in database
                        const activeOffersRef = database.ref(`grandExchange/activeOffers/${type}`);
                        const snapshot = await activeOffersRef.once('value');
                        snapshot.forEach(child => {
                            if (child.val().playerId === currentUser.uid && child.val().slotIndex === index) {
                                child.ref.remove();
                            }
                        });
                        
                        // Clear the offer
                        playerOffers[type][index] = null;
                    }
                }
            }

            if (offersCancelled > 0) {
                // Save to Firebase
                await database.ref(`grandExchange/playerOffers/${currentUser.uid}`).set(playerOffers);
                
                // Update UI
                updateOfferSlots();
                updateInventoryDisplay();
                
                // Show summary message
                let message = `Cancelled ${offersCancelled} offer${offersCancelled > 1 ? 's' : ''}. Returned: `;
                if (totalItemsReturned > 0) message += `${totalItemsReturned} items`;
                if (totalGoldReturned > 0 && totalItemsReturned > 0) message += ' + ';
                if (totalGoldReturned > 0) message += `${totalGoldReturned} gold`;
                
                showFloatingText(message, canvas.width / 2, 100, '#ff6b6b');
                
                // Close any open detail panels
                document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
                document.getElementById('emptyState').classList.add('active');
            } else {
                showFloatingText('No active offers to cancel', canvas.width / 2, 100, '#ff9933');
            }
        }

        // Start automatic matching system
        function startOfferMatching() {
            database.ref('grandExchange/activeOffers/buy').on('child_added', matchBuyOffer);
            database.ref('grandExchange/activeOffers/sell').on('child_added', matchSellOffer);
        }

        // Match buy offers
        async function matchBuyOffer(buySnapshot) {
            const buyOffer = buySnapshot.val();
            
            if (buyOffer.quantityFilled >= buyOffer.quantity) return;

            const sellOffersRef = database.ref('grandExchange/activeOffers/sell');
            const sellSnapshot = await sellOffersRef.orderByChild('itemName').equalTo(buyOffer.itemName).once('value');

            const sellOffers = [];
            sellSnapshot.forEach((sellSnap) => {
                sellOffers.push({ snap: sellSnap, offer: sellSnap.val() });
            });

            // Sort by price (lowest first) for fair matching
            sellOffers.sort((a, b) => a.offer.pricePerItem - b.offer.pricePerItem);

            for (const { snap: sellSnap, offer: sellOffer } of sellOffers) {
                // Check if buy offer is already filled
                if (buyOffer.quantityFilled >= buyOffer.quantity) break;
                
                if (sellOffer.pricePerItem <= buyOffer.pricePerItem && 
                    sellOffer.quantityFilled < sellOffer.quantity) {
                    
                    const buyerNeed = buyOffer.quantity - buyOffer.quantityFilled;
                    const sellerHas = sellOffer.quantity - sellOffer.quantityFilled;
                    const tradeQty = Math.min(buyerNeed, sellerHas);

                    await executeTrade(buyOffer, sellOffer, tradeQty, buySnapshot.key, sellSnap.key);
                }
            }
        }

        // Match sell offers
        async function matchSellOffer(sellSnapshot) {
            const sellOffer = sellSnapshot.val();
            
            if (sellOffer.quantityFilled >= sellOffer.quantity) return;

            const buyOffersRef = database.ref('grandExchange/activeOffers/buy');
            const buySnapshot = await buyOffersRef.orderByChild('itemName').equalTo(sellOffer.itemName).once('value');

            const buyOffers = [];
            buySnapshot.forEach((buySnap) => {
                buyOffers.push({ snap: buySnap, offer: buySnap.val() });
            });

            // Sort by price (highest first) for fair matching
            buyOffers.sort((a, b) => b.offer.pricePerItem - a.offer.pricePerItem);

            for (const { snap: buySnap, offer: buyOffer } of buyOffers) {
                // Check if sell offer is already filled
                if (sellOffer.quantityFilled >= sellOffer.quantity) break;
                
                if (buyOffer.pricePerItem >= sellOffer.pricePerItem && 
                    buyOffer.quantityFilled < buyOffer.quantity) {
                    
                    const buyerNeed = buyOffer.quantity - buyOffer.quantityFilled;
                    const sellerHas = sellOffer.quantity - sellOffer.quantityFilled;
                    const tradeQty = Math.min(buyerNeed, sellerHas);

                    await executeTrade(buyOffer, sellOffer, tradeQty, buySnap.key, sellSnapshot.key);
                }
            }
        }

        // Execute trade
        async function executeTrade(buyOffer, sellOffer, quantity, buyOfferId, sellOfferId) {
            buyOffer.quantityFilled += quantity;
            sellOffer.quantityFilled += quantity;

            const sellerReceives = Math.floor(sellOffer.pricePerItem * quantity * 0.99);

            // Update player offers
            await database.ref(`grandExchange/playerOffers/${buyOffer.playerId}/buy/${buyOffer.slotIndex}`).update({
                quantityFilled: buyOffer.quantityFilled
            });

            await database.ref(`grandExchange/playerOffers/${sellOffer.playerId}/sell/${sellOffer.slotIndex}`).update({
                quantityFilled: sellOffer.quantityFilled,
                collectedGold: firebase.database.ServerValue.increment(sellerReceives)
            });

            // Update active offers
            await database.ref(`grandExchange/activeOffers/buy/${buyOfferId}`).update({
                quantityFilled: buyOffer.quantityFilled
            });

            await database.ref(`grandExchange/activeOffers/sell/${sellOfferId}`).update({
                quantityFilled: sellOffer.quantityFilled
            });

            // Record trade first
            const transactionPrice = (buyOffer.pricePerItem + sellOffer.pricePerItem) / 2;
            await database.ref('grandExchange/tradeHistory').push({
                itemName: buyOffer.itemName,
                quantity: quantity,
                price: transactionPrice,
                buyerId: buyOffer.playerId,
                sellerId: sellOffer.playerId,
                timestamp: Date.now()
            });
            
            // Update guide price based on average sold prices
            // Query recent trades for this specific item
            const recentTradesSnapshot = await database.ref('grandExchange/tradeHistory')
                .orderByChild('itemName')
                .equalTo(buyOffer.itemName)
                .limitToLast(15)
                .once('value');
            
            if (recentTradesSnapshot.exists()) {
                let totalPrice = 0;
                let tradeCount = 0;
                
                recentTradesSnapshot.forEach(child => {
                    const trade = child.val();
                    totalPrice += trade.price;
                    tradeCount++;
                });
                
                const avgPrice = Math.floor(totalPrice / tradeCount);
                await database.ref(`grandExchange/guidePrices/${buyOffer.itemName}`).set(avgPrice);
                guidePrices[buyOffer.itemName] = avgPrice;
            }

            // Remove completed offers
            if (buyOffer.quantityFilled >= buyOffer.quantity) {
                await database.ref(`grandExchange/activeOffers/buy/${buyOfferId}`).remove();
            }
            if (sellOffer.quantityFilled >= sellOffer.quantity) {
                await database.ref(`grandExchange/activeOffers/sell/${sellOfferId}`).remove();
            }
        }

        // MARKET TRENDS & ANALYTICS (OSRS-Style)
        let marketData = {}; // Stores price history and volume for each item
        
        // Smart search function for GE item filtering
        function smartSearchMatch(itemName, searchQuery) {
            if (!searchQuery || searchQuery.trim() === '') return true;
            
            const itemLower = itemName.toLowerCase();
            const searchWords = searchQuery.toLowerCase().trim().split(/\s+/).filter(w => w.length > 0);
            
            // Item must match ALL search words (AND logic)
            return searchWords.every(word => itemLower.includes(word));
        }
        
        // Initialize market data tracking
        function initializeMarketTracking() {
            if (!database) return;
            
            // Listen for trades to track market activity
            database.ref('grandExchange/tradeHistory').limitToLast(50).on('child_added', (snapshot) => {
                const trade = snapshot.val();
                if (!marketData[trade.itemName]) {
                    marketData[trade.itemName] = {
                        prices: [],
                        volumes: [],
                        lastPrice: trade.price,
                        totalVolume: 0,
                        priceChange: 0
                    };
                }
                
                const item = marketData[trade.itemName];
                item.prices.push({ price: trade.price, time: trade.timestamp });
                item.volumes.push(trade.quantity);
                item.totalVolume += trade.quantity;
                
                // Calculate price change
                if (item.prices.length > 1) {
                    const oldPrice = item.prices[item.prices.length - 2].price;
                    item.priceChange = ((trade.price - oldPrice) / oldPrice) * 100;
                }
                
                item.lastPrice = trade.price;
                
                // Keep only last 20 trades per item
                if (item.prices.length > 20) {
                    item.prices.shift();
                    item.volumes.shift();
                }
            });
        }
        
        // Show market trends UI
        function showMarketTrends() {
            document.querySelectorAll('.ge-details-content').forEach(el => el.classList.remove('active'));
            
            const trendsDiv = document.getElementById('marketTrends');
            if (!trendsDiv) {
                // Create the market trends section if it doesn't exist
                createMarketTrendsUI();
            }
            
            updateTrendingItems();
            updateRecentTrades();
            
            const trendsElement = document.getElementById('marketTrends');
            if (trendsElement) {
                trendsElement.style.display = 'block';
            }
        }
        
        // Create market trends UI if not exists
        function createMarketTrendsUI() {
            const emptyState = document.getElementById('emptyState');
            if (!emptyState) return;
            
            const trendsHTML = `
                <div class="ge-details-content" id="marketTrends" style="display: none;">
                    <div class="details-title">ðŸ“ˆ Market Activity</div>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(74, 154, 138, 0.1); border-radius: 5px;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 10px; font-size: 14px;">ðŸ”¥ Most Traded Items</div>
                        <div id="trendingItems" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
                    </div>
                    
                    <div style="padding: 10px; background: rgba(90, 138, 250, 0.1); border-radius: 5px;">
                        <div style="color: #5a8afa; font-weight: bold; margin-bottom: 10px; font-size: 14px;">ðŸ“Š Recent Trades</div>
                        <div id="recentTrades" style="max-height: 250px; overflow-y: auto; font-size: 12px;"></div>
                    </div>
                    
                    <button class="ge-action-btn" onclick="closeMarketTrends()" style="margin-top: 15px; width: 100%;">Close</button>
                </div>
            `;
            
            emptyState.insertAdjacentHTML('afterend', trendsHTML);
        }
        
        // Update trending items display
        function updateTrendingItems() {
            const trendingDiv = document.getElementById('trendingItems');
            if (!trendingDiv) return;
            
            // Sort items by total volume
            const sortedItems = Object.entries(marketData)
                .sort(([, a], [, b]) => b.totalVolume - a.totalVolume)
                .slice(0, 10);
            
            if (sortedItems.length === 0) {
                trendingDiv.innerHTML = '<div style="color: #8a7a6a; padding: 10px; text-align: center;">No market data yet</div>';
                return;
            }
            
            trendingDiv.innerHTML = sortedItems.map(([itemName, data]) => {
                const arrow = data.priceChange > 0 ? 'ðŸ“ˆ' : data.priceChange < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
                const changeColor = data.priceChange > 0 ? '#00ff00' : data.priceChange < 0 ? '#ff4444' : '#8a7a6a';
                const changeText = data.priceChange !== 0 ? `${data.priceChange.toFixed(1)}%` : 'Stable';
                
                return `
                    <div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 3px; border-left: 3px solid ${changeColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #cad2da; font-weight: bold;">${itemName}</div>
                                <div style="color: #8a7a6a; font-size: 11px;">Volume: ${data.totalVolume} traded</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #FFD700;">${data.lastPrice.toLocaleString()} gp</div>
                                <div style="color: ${changeColor}; font-size: 11px;">${arrow} ${changeText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update recent trades display
        function updateRecentTrades() {
            if (!database) return;
            
            const tradesDiv = document.getElementById('recentTrades');
            if (!tradesDiv) return;
            
            database.ref('grandExchange/tradeHistory').limitToLast(15).once('value', (snapshot) => {
                const trades = [];
                snapshot.forEach(child => trades.push(child.val()));
                trades.reverse(); // Show newest first
                
                if (trades.length === 0) {
                    tradesDiv.innerHTML = '<div style="color: #8a7a6a; padding: 10px; text-align: center;">No recent trades</div>';
                    return;
                }
                
                tradesDiv.innerHTML = trades.map(trade => {
                    const timeAgo = getTimeAgo(trade.timestamp);
                    const total = trade.price * trade.quantity;
                    
                    return `
                        <div style="padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.2); border-radius: 3px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="color: #5abaaa; font-weight: bold;">${trade.itemName}</span>
                                <span style="color: #8a7a6a; font-size: 11px;">${timeAgo}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px;">
                                <span style="color: #cad2da;">${trade.quantity}x @ ${trade.price.toLocaleString()} gp</span>
                                <span style="color: #FFD700;">Total: ${total.toLocaleString()} gp</span>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }
        
        // Helper function to format time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        // Close market trends
        function closeMarketTrends() {
            const trendsDiv = document.getElementById('marketTrends');
            if (trendsDiv) {
                trendsDiv.style.display = 'none';
            }
            document.getElementById('emptyState').classList.add('active');
        }
        
        // MARKET WIKI FUNCTIONS
        let currentWikiFilter = 'rises';
        let currentWikiPeriod = 7;
        
        function openMarketWiki() {
            document.getElementById('marketWikiModal').style.display = 'flex';
            updateWikiTable();
            generateSearchSuggestions();
        }
        
        function closeMarketWiki() {
            document.getElementById('marketWikiModal').style.display = 'none';
            // Clear search when closing
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) searchInput.value = '';
        }
        
        // Generate smart search suggestions based on available items
        function generateSearchSuggestions() {
            const suggestionTags = document.getElementById('suggestionTags');
            if (!suggestionTags) return;
            
            // Extract common keywords from item names
            const keywords = new Set();
            Object.keys(marketData).forEach(itemName => {
                const words = itemName.toLowerCase().split(/\s+/);
                words.forEach(word => {
                    if (word.length >= 2) { // Only meaningful words
                        keywords.add(word);
                    }
                });
            });
            
            // Common search terms (always show these)
            const commonTerms = ['t1', 't2', 't3', 'logs', 'ore', 'common', 'uncommon', 'rare', 'epic', 'perfect'];
            const suggestionsSet = new Set([...commonTerms, ...Array.from(keywords).slice(0, 10)]);
            const suggestions = Array.from(suggestionsSet).slice(0, 12);
            
            if (suggestions.length > 0) {
                suggestionTags.innerHTML = suggestions.map(tag => `
                    <button 
                        onclick="applySearchSuggestion('${tag}')" 
                        style="background: #5a4a3a; border: 2px solid #7a6a5a; border-radius: 15px; padding: 6px 12px; color: #d4a76a; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.2s;"
                        onmouseover="this.style.background='#6a5a4a'; this.style.transform='scale(1.05)'"
                        onmouseout="this.style.background='#5a4a3a'; this.style.transform='scale(1)'"
                    >
                        ${tag}
                    </button>
                `).join('');
                document.getElementById('searchSuggestions').style.display = 'block';
            }
        }
        
        // Apply search suggestion when clicked
        function applySearchSuggestion(term) {
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) {
                const currentValue = searchInput.value.trim();
                // Add term to existing search or replace
                searchInput.value = currentValue ? `${currentValue} ${term}` : term;
                filterWikiTable();
                searchInput.focus();
            }
        }
        
        function updateWikiTable() {
            const tbody = document.getElementById('wikiTableBody');
            const resultCount = document.getElementById('wikiResultCount');
            if (!tbody) return;
            
            // Get search query
            const searchInput = document.getElementById('wikiSearchInput');
            const searchQuery = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            // Get all items from marketData
            let items = Object.entries(marketData).map(([name, data]) => {
                // Calculate start and end prices
                const prices = data.prices || [];
                if (prices.length < 2) return null;
                
                const startPrice = prices[0].price;
                const endPrice = prices[prices.length - 1].price;
                const rise = endPrice - startPrice;
                const changePercent = ((rise / startPrice) * 100);
                
                // Check if valuable (change >= 50%)
                const isValuable = Math.abs(changePercent) >= 50;
                
                return {
                    name,
                    startPrice,
                    endPrice,
                    rise,
                    changePercent,
                    isValuable,
                    volume: data.totalVolume || 0
                };
            }).filter(item => item !== null);
            
            // Apply smart search filter
            if (searchQuery) {
                // Split search into words
                const searchWords = searchQuery.split(/\s+/).filter(w => w.length > 0);
                
                items = items.filter(item => {
                    const itemNameLower = item.name.toLowerCase();
                    
                    // Item must match ALL search words (AND logic)
                    return searchWords.every(word => {
                        // Check if item name contains this word
                        return itemNameLower.includes(word);
                    });
                });
                
                // Show clear button
                const clearBtn = document.getElementById('clearSearchBtn');
                if (clearBtn) clearBtn.style.display = 'block';
            } else {
                // Hide clear button
                const clearBtn = document.getElementById('clearSearchBtn');
                if (clearBtn) clearBtn.style.display = 'none';
            }
            
            // Apply filters (only if not searching, or combine with search)
            if (currentWikiFilter === 'rises') {
                items = items.filter(item => item.rise > 0).sort((a, b) => b.changePercent - a.changePercent);
            } else if (currentWikiFilter === 'falls') {
                items = items.filter(item => item.rise < 0).sort((a, b) => a.changePercent - b.changePercent);
            } else if (currentWikiFilter === 'valuable') {
                items = items.filter(item => item.isValuable).sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
            } else if (currentWikiFilter === 'most-traded') {
                items = items.sort((a, b) => b.volume - a.volume);
            }
            
            // Update result count
            if (resultCount) {
                resultCount.textContent = items.length;
            }
            
            // Generate table rows
            if (items.length === 0) {
                const noResultsMsg = searchQuery 
                    ? `No items found matching "${searchQuery}". Try different keywords or clear search.`
                    : 'No market data available yet. Start trading items to see price statistics!';
                    
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: #8a7a6a; font-size: 16px;">
                            ${noResultsMsg}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = items.map(item => {
                const changeColor = item.changePercent > 0 ? '#00ff00' : item.changePercent < 0 ? '#ff4444' : '#8a7a6a';
                const arrow = item.changePercent > 0 ? 'ðŸ“ˆ' : item.changePercent < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
                const checkmark = item.isValuable ? 'âœ“' : '';
                
                return `
                    <tr style="border-bottom: 1px solid #3a2a1a;">
                        <td style="padding: 15px; color: #d4a76a; font-size: 14px; font-weight: bold;">
                            ${item.name}
                        </td>
                        <td style="padding: 15px; text-align: center; color: #FFD700; font-size: 18px;">
                            ${checkmark}
                        </td>
                        <td style="padding: 15px; text-align: right; color: #cad2da; font-size: 14px;">
                            ${item.startPrice.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: #cad2da; font-size: 14px;">
                            ${item.endPrice.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: ${changeColor}; font-size: 14px; font-weight: bold;">
                            ${item.rise > 0 ? '+' : ''}${item.rise.toLocaleString()} gp
                        </td>
                        <td style="padding: 15px; text-align: right; color: ${changeColor}; font-size: 14px; font-weight: bold;">
                            ${arrow} ${item.changePercent > 0 ? '+' : ''}${item.changePercent.toFixed(0)}%
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Smart filter function for wiki table
        function filterWikiTable() {
            updateWikiTable();
        }
        
        // Clear search function
        function clearWikiSearch() {
            const searchInput = document.getElementById('wikiSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterWikiTable();
            }
        }
        
        // Set up wiki filter buttons
        document.addEventListener('DOMContentLoaded', () => {
            // Filter buttons
            document.querySelectorAll('.wiki-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.wiki-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentWikiFilter = btn.dataset.filter;
                    updateWikiTable();
                });
            });
            
            // Period buttons
            document.querySelectorAll('.wiki-period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.wiki-period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentWikiPeriod = parseInt(btn.dataset.period);
                    updateWikiTable();
                });
            });
        });
        
        // Enhanced item display with price history
        function showItemPriceHistory(itemName) {
            const data = marketData[itemName];
            if (!data || data.prices.length < 2) {
                return 'No price history available';
            }
            
            const minPrice = Math.min(...data.prices.map(p => p.price));
            const maxPrice = Math.max(...data.prices.map(p => p.price));
            const avgPrice = data.prices.reduce((sum, p) => sum + p.price, 0) / data.prices.length;
            
            return `
                <div style="font-size: 11px; color: #8a7a6a; margin-top: 5px;">
                    Avg: ${Math.floor(avgPrice)} gp | Min: ${minPrice} gp | Max: ${maxPrice} gp
                </div>
            `;
        }


        // Load sprites - extend existing spriteUrls with additional variants
        Object.assign(spriteUrls, {
            ore_uncommon_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/uncommon%20t1%20ore.png',
            ore_rare_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/rare%20tier%201.png',
            ore_epic_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/epic%20tier%201.png',
            ore_perfect_t1: 'https://raw.githubusercontent.com/Graphic37/RPG/main/Mining/perfect%20tier%201.png',
            // Add more tier sprites as they become available
        });
        
        // Tilemap data from exported JSON
        const mapData = {"tileSize":16,"mapWidth":55,"mapHeight":45,"layers":[{"name":"Layer_1","tiles":[{"id":"0","x":23,"y":23},{"id":"1","x":24,"y":23},{"id":"2","x":25,"y":23},{"id":"3","x":26,"y":23},{"id":"4","x":23,"y":24},{"id":"5","x":24,"y":24},{"id":"6","x":25,"y":24},{"id":"7","x":26,"y":24},{"id":"8","x":23,"y":25},{"id":"9","x":24,"y":25},{"id":"10","x":25,"y":25},{"id":"11","x":26,"y":25},{"id":"12","x":23,"y":26},{"id":"13","x":24,"y":26},{"id":"14","x":25,"y":26},{"id":"15","x":26,"y":26},{"id":"16","x":23,"y":27},{"id":"17","x":24,"y":27},{"id":"18","x":25,"y":27},{"id":"19","x":26,"y":27}],"collider":false}]}; // Truncated for brevity
        
        // Tile type definitions - map tile IDs to types
        const tileTypes = {
            // Trees (0-19 appear to be tree tiles in 4x5 blocks)
            trees: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
            // Stone borders (20-35 appear to be stone tiles)
            stones: [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35],
            // Grass/ground (36 and others)
            grass: [36],
            // Border/edge tiles
            borders: [60, 61, 62, 63, 64, 65, 66, 67]
        };
        
        // Tilemap data - will be loaded from JSON
        let tilemapData = null;
        
        // Load the tilemap JSON
        async function loadTilemap() {
            try {
                // Using embedded data instead of fetch for simplicity
                tilemapData = {
                    tileSize: 16,
                    mapWidth: 55,
                    mapHeight: 45,
                    layers: [{
                        name: "Layer_1",
                        tiles: [] // Simplified - would contain full tile data
                    }]
                };
                console.log('Tilemap data initialized');
            } catch (error) {
                console.log('Tilemap loading failed, using procedural generation');
            }
        }
        
        // Extract tree positions from tilemap for interactions
        function extractTreesFromTilemap() {
            // Pre-calculated tree positions from the tilemap
            // These are the 6 trees found in the map
            const treePositions = [
                { x: 800, y: 816 },   // Tree at grid (23, 23)
                { x: 320, y: 1104 },  // Tree at grid (8, 32)
                { x: 1472, y: 1104 }, // Tree at grid (44, 32)
                { x: 1440, y: 208 },  // Tree at grid (43, 4)
                { x: 1248, y: 592 },  // Tree at grid (37, 16)
                { x: 448, y: 528 }    // Tree at grid (12, 14)
            ];
            
            // Convert to tree objects with variants
            const treeObjects = treePositions.map(pos => ({
                type: 'tree',
                x: pos.x,
                y: pos.y,
                variant: ['oak', 'maple', 'birch'][Math.floor(Math.random() * 3)]
            }));
            
            // Return tree objects instead of directly updating rooms
            return treeObjects;
        }
        
        // Render tilemap background
        function drawTilemap() {
            if (!tilemapData || !rooms || !rooms[gameState.currentRoom] || !rooms[gameState.currentRoom].usesTilemap) {
                drawTiles(); // Use original tile system
                return;
            }
            
            const layer = tilemapData.layers[0];
            const scaleFactor = 2; // Scale up the 16x16 tiles
            
            // Create a map for quick tile lookup
            const tileMap = new Map();
            layer.tiles.forEach(tile => {
                const key = `${tile.x},${tile.y}`;
                tileMap.set(key, tile.id);
            });
            
            // Draw all tiles
            for (let y = 0; y < tilemapData.mapHeight; y++) {
                for (let x = 0; x < tilemapData.mapWidth; x++) {
                    const key = `${x},${y}`;
                    const tileId = tileMap.get(key);
                    
                    const drawX = x * tilemapData.tileSize * scaleFactor - gameState.camera.x;
                    const drawY = y * tilemapData.tileSize * scaleFactor - gameState.camera.y;
                    
                    // Skip if outside viewport
                    if (drawX < -32 || drawX > canvas.width || drawY < -32 || drawY > canvas.height) {
                        continue;
                    }
                    
                    // Draw based on tile ID
                    if (tileId !== undefined) {
                        drawTileById(parseInt(tileId), drawX, drawY, scaleFactor);
                    } else {
                        // Draw default grass
                        ctx.fillStyle = '#4a6a5a';
                        ctx.fillRect(drawX, drawY, tilemapData.tileSize * scaleFactor, tilemapData.tileSize * scaleFactor);
                    }
                }
            }
        }
        
        // Draw individual tile based on its ID
        function drawTileById(id, x, y, scale) {
            const size = tilemapData.tileSize * scale;
            
            if (id >= 0 && id <= 19) {
                // Tree tiles - draw as brown/green
                const treeColors = ['#228B22', '#32CD32', '#2E8B57', '#3CB371'];
                ctx.fillStyle = treeColors[id % 4];
                ctx.fillRect(x, y, size, size);
                
                // Add some texture
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fillRect(x + 2, y + 2, size - 4, size - 4);
            } else if (id >= 20 && id <= 35) {
                // Stone border tiles
                ctx.fillStyle = '#8B7D6B';
                ctx.fillRect(x, y, size, size);
                
                // Stone texture
                ctx.fillStyle = '#A0826D';
                ctx.fillRect(x + 4, y + 4, size - 8, size - 8);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + 1, y + 1, size - 2, size - 2);
            } else if (id === 36) {
                // Grass tile
                ctx.fillStyle = '#4a6a5a';
                ctx.fillRect(x, y, size, size);
                
                // Grass texture
                for (let i = 0; i < 3; i++) {
                    ctx.strokeStyle = `rgba(0,0,0,${0.05 + i * 0.02})`;
                    ctx.beginPath();
                    ctx.moveTo(x + Math.random() * size, y + size);
                    ctx.lineTo(x + Math.random() * size, y + size - 5);
                    ctx.stroke();
                }
            } else if (id >= 60 && id <= 67) {
                // Border/edge tiles
                ctx.fillStyle = '#2a3a2a';
                ctx.fillRect(x, y, size, size);
            } else {
                // Default tile
                ctx.fillStyle = '#3a5a4a';
                ctx.fillRect(x, y, size, size);
            }
        }
        
        // Initialize tilemap loading
        loadTilemap();
        
        // Resource tier definitions with level requirements
        const resourceRarities = {
            common: { name: 'Common', multiplier: 1, color: '#8a8a8a', chance: 0.80 },
            uncommon: { name: 'Uncommon', multiplier: 2, color: '#00FF00', chance: 0.10 },
            rare: { name: 'Rare', multiplier: 3, color: '#4169E1', chance: 0.05 },
            epic: { name: 'Epic', multiplier: 4, color: '#9370DB', chance: 0.01 },
            perfect: { name: 'Perfect', multiplier: 5, color: '#FFD700', chance: 0.001 }
        };
        
        const resourceTiers = {
            woodcutting: [
                { name: 'Logs', tier: 1, baseIcon: 'log', levelReq: 1, exp: 10 },
                { name: 'Logs', tier: 2, baseIcon: 'log', levelReq: 20, exp: 25 },
                { name: 'Logs', tier: 3, baseIcon: 'log', levelReq: 40, exp: 50 },
                { name: 'Logs', tier: 4, baseIcon: 'log', levelReq: 60, exp: 75 },
                { name: 'Logs', tier: 5, baseIcon: 'log', levelReq: 80, exp: 100 }
            ],
            mining: [
                { name: 'Ore', tier: 1, baseIcon: 'ore', levelReq: 1, exp: 10 },
                { name: 'Ore', tier: 2, baseIcon: 'ore', levelReq: 20, exp: 25 },
                { name: 'Ore', tier: 3, baseIcon: 'ore', levelReq: 40, exp: 50 },
                { name: 'Ore', tier: 4, baseIcon: 'ore', levelReq: 60, exp: 75 },
                { name: 'Ore', tier: 5, baseIcon: 'ore', levelReq: 80, exp: 100 }
            ],
            fishing: [
                { name: 'Raw Fish', tier: 1, baseIcon: 'fish', levelReq: 1, exp: 10 },
                { name: 'Raw Fish', tier: 2, baseIcon: 'fish', levelReq: 20, exp: 25 },
                { name: 'Raw Fish', tier: 3, baseIcon: 'fish', levelReq: 40, exp: 50 },
                { name: 'Raw Fish', tier: 4, baseIcon: 'fish', levelReq: 60, exp: 75 },
                { name: 'Raw Fish', tier: 5, baseIcon: 'fish', levelReq: 80, exp: 100 }
            ],
            plundering: [
                { name: 'Plunder', tier: 1, baseIcon: 'gold', levelReq: 1, exp: 15, goldMin: 50, goldMax: 100 },
                { name: 'Plunder', tier: 2, baseIcon: 'gold', levelReq: 20, exp: 35, goldMin: 100, goldMax: 250 },
                { name: 'Plunder', tier: 3, baseIcon: 'gold', levelReq: 40, exp: 70, goldMin: 250, goldMax: 500 },
                { name: 'Plunder', tier: 4, baseIcon: 'gold', levelReq: 60, exp: 110, goldMin: 500, goldMax: 1000 },
                { name: 'Plunder', tier: 5, baseIcon: 'gold', levelReq: 80, exp: 150, goldMin: 1000, goldMax: 2500 }
            ],
            agility: [
                { name: 'Lap', tier: 1, baseIcon: 'ticket', levelReq: 1, exp: 10 },
                { name: 'Lap', tier: 2, baseIcon: 'ticket', levelReq: 20, exp: 25 },
                { name: 'Lap', tier: 3, baseIcon: 'ticket', levelReq: 40, exp: 50 },
                { name: 'Lap', tier: 4, baseIcon: 'ticket', levelReq: 60, exp: 75 },
                { name: 'Lap', tier: 5, baseIcon: 'ticket', levelReq: 80, exp: 100 }
            ]
        };
        
        // Get rarity for a resource
        function getRarity() {
            const roll = Math.random();
            let cumulative = 0;
            
            for (const [key, rarity] of Object.entries(resourceRarities)) {
                cumulative += rarity.chance;
                if (roll <= cumulative) {
                    return { key, ...rarity };
                }
            }
            
            return { key: 'common', ...resourceRarities.common };
        }
        
        // Get icon name based on resource, tier, and rarity
        function getResourceIcon(baseIcon, tier, rarity) {
            // Convert rarity to proper case (e.g., "common" -> "Common", "uncommon" -> "Uncommon")
            const rarityProper = rarity.charAt(0).toUpperCase() + rarity.slice(1).toLowerCase();
            
            // Generate the icon name in the format: baseIcon_T{tier}_{Rarity}
            return `${baseIcon}_T${tier}_${rarityProper}`;
        }
        
        // Get available tier based on skill level
        function getAvailableTier(skill, skillLevel) {
            const tiers = resourceTiers[skill];
            if (!tiers) return null;
            
            // Filter to only tiers the player can gather at their level
            const availableTiers = tiers.filter(t => skillLevel >= t.levelReq);
            if (availableTiers.length === 0) return null;
            
            // Calculate chances based on available tiers
            // Higher tiers are rarer, but become more common as you level up
            const maxTier = availableTiers[availableTiers.length - 1].tier;
            const weights = availableTiers.map(t => {
                // Base weight decreases for higher tiers
                let weight = Math.pow(0.5, t.tier - 1);
                // Boost weight if player is significantly over-leveled for this tier
                if (skillLevel > t.levelReq + 20) {
                    weight *= 0.5; // Make lower tiers less common when over-leveled
                }
                return weight;
            });
            
            // Normalize weights
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            const normalizedWeights = weights.map(w => w / totalWeight);
            
            // Roll for tier
            const roll = Math.random();
            let cumulative = 0;
            
            for (let i = 0; i < availableTiers.length; i++) {
                cumulative += normalizedWeights[i];
                if (roll <= cumulative) {
                    return availableTiers[i];
                }
            }
            
            // Fallback to highest available
            return availableTiers[availableTiers.length - 1];
        }

        // Load sprite images
        let characterSpritesLoaded = 0;
        const totalCharacterSprites = 81; // Total character animation frames (12+15+12+12+12+18)
        
        Object.keys(spriteUrls).forEach(key => {
            // Skip null or undefined sprite URLs
            if (!spriteUrls[key]) {
                return;
            }
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = spriteUrls[key];
            img.onload = () => {
                gameState.sprites[key] = img;
                if (key.startsWith('char_')) {
                    characterSpritesLoaded++;
                    if (characterSpritesLoaded === totalCharacterSprites) {
                        console.log(`âœ“ All ${totalCharacterSprites} character sprites loaded successfully!`);
                    }
                }
                if (gameState.inventoryOpen) {
                    updateInventoryDisplay();
                }
            };
            img.onerror = () => {
                // Sprite failed to load - use fallback
                // console.error(`Failed to load sprite: ${key}`);
            };
        });

        // Room Configurations with better graphics
        const rooms = {
            woodcutting: {
                name: 'Woodcutting Area',
                groundTiles: ['#4a6a5a', '#3a5a4a', '#5a7a6a'],
                pathTiles: ['#8a7a6a', '#7a6a5a'],
                decorations: ['grass', 'rock', 'flower'],
                objects: [] // Will be populated dynamically
            },
            fishing: {
                name: 'Fishing Spot',
                groundTiles: ['#3a5a6a', '#2a4a5a', '#4a6a7a'],
                pathTiles: ['#6a5a4a', '#5a4a3a'],
                decorations: ['rock', 'reed'],
                objects: [] // Will be populated dynamically
            },
            mining: {
                name: 'Mine',
                groundTiles: ['#3a3a4a', '#2a2a3a', '#4a4a5a'],
                pathTiles: ['#5a5a6a', '#4a4a5a'],
                decorations: ['rock', 'crystal'],
                objects: [] // Will be populated dynamically
            },
            combat: {
                name: 'Combat Training (Auto)', // Auto/idle combat area
                groundTiles: ['#5a4a4a', '#4a3a3a', '#6a5a5a'],
                pathTiles: ['#7a6a6a', '#6a5a5a'],
                decorations: ['weapon_rack', 'banner'],
                objects: [] // Will be populated dynamically
            },
            cooking: {
                name: 'Cooking Area',
                groundTiles: ['#6a5a4a', '#5a4a3a', '#7a6a5a'],
                pathTiles: ['#8a7a6a', '#7a6a5a'],
                decorations: ['barrel', 'crate'],
                objects: [] // Will be populated dynamically
            },
            raids: {
                name: 'Boss Arena (Manual)', // Manual combat bossing area
                groundTiles: ['#4a3a3a', '#3a2a2a', '#5a4a4a'],
                pathTiles: ['#6a5a5a', '#5a4a4a'],
                decorations: ['skull', 'torch'],
                objects: [] // Will be populated dynamically
            },

            crafting: {
                name: 'Crafting Workshop',
                groundTiles: ['#5a4a3a', '#4a3a2a', '#6a5a4a'],
                pathTiles: ['#7a6a5a', '#6a5a4a'],
                decorations: ['tools', 'blueprint'],
                objects: [] // Will be populated dynamically
            },
            plundering: {
                name: 'Plundering District',
                groundTiles: ['#2a2a3a', '#3a3a4a', '#1a1a2a'],
                pathTiles: ['#4a4a5a', '#3a3a4a'],
                decorations: ['chest', 'coin'],
                objects: [] // Will be populated dynamically
            },
            agility: {
                name: 'Agility Course',
                groundTiles: ['#5a5a4a', '#4a4a3a', '#6a6a5a'],
                pathTiles: ['#7a7a6a', '#6a6a5a'],
                decorations: ['marker', 'flag'],
                objects: [] // Will be populated dynamically
            },
            smithwright: {
                name: 'Smithwright',
                groundTiles: ['#4a3a2a', '#3a2a1a', '#5a4a3a'],
                pathTiles: ['#6a5a4a', '#5a4a3a'],
                decorations: ['anvil', 'forge'],
                objects: [] // Will be populated dynamically
            }

        };
        
        // Initialize objects for each room based on canvas size
        function initializeRoomObjects() {
            const w = canvas.width;
            const h = canvas.height;
            const margin = 150; // Keep objects away from edges
            
            // Woodcutting - spread trees across the area
            rooms.woodcutting.objects = [
                { type: 'tree', x: w * 0.2, y: h * 0.3, variant: 'oak', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.4, y: h * 0.25, variant: 'maple', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.6, y: h * 0.4, variant: 'birch', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.75, y: h * 0.35, variant: 'oak', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.3, y: h * 0.6, variant: 'maple', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.65, y: h * 0.65, variant: 'birch', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.45, y: h * 0.5, variant: 'oak', rarity: getRarity(), state: 'full' },
                { type: 'tree', x: w * 0.8, y: h * 0.6, variant: 'maple', rarity: getRarity(), state: 'full' }
            ];
            
            // Fishing - pond in center with spots around it
            const pondW = w * 0.3;
            const pondH = h * 0.25;
            rooms.fishing.objects = [
                { type: 'pond', x: w * 0.5, y: h * 0.45, width: pondW, height: pondH },
                { type: 'fishingSpot', x: w * 0.4, y: h * 0.4, rarity: getRarity() },
                { type: 'fishingSpot', x: w * 0.6, y: h * 0.4, rarity: getRarity() },
                { type: 'fishingSpot', x: w * 0.5, y: h * 0.6, rarity: getRarity() }
            ];
            
            // Mining - rocks spread around
            // First rock is the white rock (replaces top-left spawn, always common rarity)
            rooms.mining.objects = [
                { type: 'ore', x: w * 0.25, y: h * 0.3, variant: 'whiteRock', rarity: { key: 'common', name: 'Common', color: '#ffffff', multiplier: 1 }, state: 'full' },
                { type: 'ore', x: w * 0.5, y: h * 0.25, variant: 'iron', rarity: getRarity(), state: 'full' },
                { type: 'ore', x: w * 0.35, y: h * 0.5, variant: 'silver', rarity: getRarity(), state: 'full' },
                { type: 'ore', x: w * 0.65, y: h * 0.4, variant: 'gold', rarity: getRarity(), state: 'full' },
                { type: 'ore', x: w * 0.75, y: h * 0.6, variant: 'iron', rarity: getRarity(), state: 'full' },
                { type: 'ore', x: w * 0.45, y: h * 0.65, variant: 'copper', rarity: getRarity(), state: 'full' }
            ];
            
            // Combat - dummies in a line
            // Generate combat mobs based on selected zone
            const currentZone = gameState.selectedZone || 'woods';
            const zoneData = combatZones && combatZones[currentZone] ? combatZones[currentZone] : null;
            
            if (zoneData && zoneData.monsters) {
                rooms.combat.objects = [];
                // Only 4 mob spawn positions
                const positions = [
                    { x: w * 0.3, y: h * 0.35 },
                    { x: w * 0.7, y: h * 0.35 },
                    { x: w * 0.35, y: h * 0.65 },
                    { x: w * 0.65, y: h * 0.65 }
                ];
                
                // Spawn 4 mobs - randomly select from available monsters in zone
                for (let i = 0; i < 4; i++) {
                    const randomIndex = Math.floor(Math.random() * zoneData.monsters.length);
                    const monsterTemplate = zoneData.monsters[randomIndex];
                    rooms.combat.objects.push({
                        type: 'mob',
                        mobData: { ...monsterTemplate }, // Copy monster data
                        x: positions[i].x,
                        y: positions[i].y,
                        spawnX: positions[i].x, // Remember spawn location
                        spawnY: positions[i].y,
                        health: monsterTemplate.health,
                        maxHealth: monsterTemplate.health,
                        inCombat: false,
                        targetX: null,
                        targetY: null
                    });
                }
            } else {
                // Fallback to empty if no zone data
                rooms.combat.objects = [];
            }
            
            // Cooking
            rooms.cooking.objects = [
                { type: 'stove', x: w * 0.3, y: h * 0.35 },
                { type: 'stove', x: w * 0.5, y: h * 0.35 },
                { type: 'stove', x: w * 0.7, y: h * 0.35 },
                { type: 'table', x: w * 0.5, y: h * 0.6 }
            ];
            
            // Raids
            rooms.raids.objects = [
                { type: 'chest', x: w * 0.3, y: h * 0.3 },
                { type: 'chest', x: w * 0.7, y: h * 0.3 },
                { type: 'chest', x: w * 0.5, y: h * 0.25 },
                { type: 'boss', x: w * 0.5, y: h * 0.6 }
            ];
            
            // Crafting
            rooms.crafting.objects = [
                { type: 'workbench', x: w * 0.3, y: h * 0.35 },
                { type: 'anvil', x: w * 0.55, y: h * 0.35 },
                { type: 'forge', x: w * 0.7, y: h * 0.35 }
            ];
            
            // Plundering - treasure chests with random loot
            rooms.plundering.objects = [
                { type: 'chest', x: w * 0.25, y: h * 0.3, tier: 1, state: 'full' },
                { type: 'chest', x: w * 0.45, y: h * 0.25, tier: 2, state: 'full' },
                { type: 'chest', x: w * 0.65, y: h * 0.35, tier: 3, state: 'full' },
                { type: 'chest', x: w * 0.35, y: h * 0.55, tier: 4, state: 'full' },
                { type: 'chest', x: w * 0.6, y: h * 0.6, tier: 5, state: 'full' },
                { type: 'chest', x: w * 0.5, y: h * 0.45, tier: 3, state: 'full' }
            ];
            
            // Agility - obstacles in a course
            rooms.agility.objects = [
                { type: 'obstacle', x: w * 0.25, y: h * 0.3 },
                { type: 'obstacle', x: w * 0.5, y: h * 0.25 },
                { type: 'obstacle', x: w * 0.7, y: h * 0.35 },
                { type: 'obstacle', x: w * 0.65, y: h * 0.6 },
                { type: 'obstacle', x: w * 0.35, y: h * 0.65 }
            ];
            
            // Smithwright - forges and anvils for processing
            rooms.smithwright.objects = [
                { type: 'forge', x: w * 0.3, y: h * 0.35 },
                { type: 'anvil', x: w * 0.5, y: h * 0.35 },
                { type: 'forge', x: w * 0.7, y: h * 0.35 },
                { type: 'anvil', x: w * 0.4, y: h * 0.6 },
                { type: 'forge', x: w * 0.6, y: h * 0.6 }
            ];
        }

        // Initialize tiles for better graphics
        function generateTiles() {
            const room = rooms[gameState.currentRoom];
            gameState.tiles = [];
            const tileSize = 50;
            
            for (let x = 0; x < canvas.width + tileSize; x += tileSize) {
                for (let y = 0; y < canvas.height + tileSize; y += tileSize) {
                    const tileType = Math.random() > 0.8 ? 'path' : 'ground';
                    const tiles = tileType === 'path' ? room.pathTiles : room.groundTiles;
                    const color = tiles[Math.floor(Math.random() * tiles.length)];
                    
                    gameState.tiles.push({
                        x, y,
                        size: tileSize,
                        color,
                        type: tileType
                    });
                }
            }
        }

        // Draw functions with better graphics
        function drawTiles() {
            gameState.tiles.forEach(tile => {
                // Main tile
                ctx.fillStyle = tile.color;
                ctx.fillRect(tile.x - gameState.camera.x, tile.y - gameState.camera.y, tile.size, tile.size);
                
                // Add subtle grid lines
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1;
                ctx.strokeRect(tile.x - gameState.camera.x, tile.y - gameState.camera.y, tile.size, tile.size);
                
                // Add texture
                if (tile.type === 'path') {
                    ctx.fillStyle = 'rgba(0,0,0,0.1)';
                    ctx.fillRect(
                        tile.x - gameState.camera.x + 5, 
                        tile.y - gameState.camera.y + 5, 
                        tile.size - 10, 
                        tile.size - 10
                    );
                }
            });
        }

        function drawTree(x, y, variant, treeState = 'full', rarity = null) {
            // Determine which sprite to use based on tree state and rarity
            let spriteKey = 'tree_common'; // Default
            
            if (treeState === 'stump') {
                spriteKey = 'tree_stump';
            } else if (treeState === 'half') {
                spriteKey = 'tree_half';
            } else if (treeState === 'full' && rarity) {
                // Use rarity-specific tree sprite
                const rarityKey = rarity.key || 'common';
                spriteKey = `tree_${rarityKey}`;
            }
            
            // Try to use sprite first
            if (spriteUrls[spriteKey] && gameState.sprites[spriteKey]) {
                const sprite = gameState.sprites[spriteKey];
                const spriteWidth = 120;
                const spriteHeight = 100;
                
                // Draw centered on x, y position (y is at the bottom of the tree)
                ctx.drawImage(
                    sprite,
                    x - spriteWidth / 2,  // Center horizontally
                    y - spriteHeight + 10,  // Position so y is near the base
                    spriteWidth,
                    spriteHeight
                );
                return;
            }
            
            // Fallback to canvas drawing if sprite not loaded (only for full tree)
            if (treeState !== 'full') return; // Don't draw fallback for stump/half
            
            const colors = {
                oak: { trunk: '#654321', leaves: ['#228B22', '#32CD32', '#3CB371'] },
                maple: { trunk: '#8B4513', leaves: ['#FF8C00', '#FF7F50', '#FF6347'] },
                birch: { trunk: '#F5F5DC', leaves: ['#90EE90', '#98FB98', '#8FBC8F'] }
            };
            
            const tree = colors[variant] || colors.oak;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(x, y + 30, 35, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Trunk
            const gradient = ctx.createLinearGradient(x - 20, y, x + 20, y);
            gradient.addColorStop(0, tree.trunk);
            gradient.addColorStop(0.5, '#8B7355');
            gradient.addColorStop(1, tree.trunk);
            ctx.fillStyle = gradient;
            ctx.fillRect(x - 20, y - 20, 40, 60);
            
            // Leaves layers
            tree.leaves.forEach((color, i) => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x - 20 + i * 10, y - 30 - i * 5, 35 - i * 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + 20 - i * 10, y - 25 - i * 5, 30 - i * 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x, y - 50 - i * 5, 40 - i * 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Highlight
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            ctx.arc(x - 10, y - 45, 15, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawOre(x, y, variant, oreState = 'full', rarity = null) {
            // Special handling for white rock variant
            if (variant === 'whiteRock') {
                let whiteRockSprite = null;
                let spriteLoaded = false;
                
                if (oreState === 'stage1') {
                    whiteRockSprite = whiteRockPhase1;
                    spriteLoaded = whiteRockPhase1Loaded;
                } else if (oreState === 'stage2') {
                    whiteRockSprite = whiteRockPhase2;
                    spriteLoaded = whiteRockPhase2Loaded;
                } else if (oreState === 'full') {
                    whiteRockSprite = whiteRockFull;
                    spriteLoaded = whiteRockFullLoaded;
                }
                
                if (whiteRockSprite && spriteLoaded) {
                    const spriteWidth = 120;
                    const spriteHeight = 100;
                    
                    // Draw centered on x, y position
                    ctx.drawImage(
                        whiteRockSprite,
                        x - spriteWidth / 2,
                        y - spriteHeight / 2,
                        spriteWidth,
                        spriteHeight
                    );
                    return;
                }
                // If sprite not loaded, fall through to regular ore drawing
            }
            
            // Regular ore drawing for other variants
            // Determine which sprite to use based on ore state and rarity
            let spriteKey = 'ore_common'; // Default
            
            if (oreState === 'stage1') {
                spriteKey = 'ore_stage1';
            } else if (oreState === 'stage2') {
                spriteKey = 'ore_stage2';
            } else if (oreState === 'full' && rarity) {
                // Use rarity-specific ore sprite
                const rarityKey = rarity.key || 'common';
                spriteKey = `ore_${rarityKey}`;
            }
            
            // Try to use sprite first
            if (spriteUrls[spriteKey] && gameState.sprites[spriteKey]) {
                const sprite = gameState.sprites[spriteKey];
                const spriteWidth = 120;
                const spriteHeight = 100;
                
                // Draw centered on x, y position
                ctx.drawImage(
                    sprite,
                    x - spriteWidth / 2,
                    y - spriteHeight / 2,
                    spriteWidth,
                    spriteHeight
                );
                return;
            }
            
            // Fallback to canvas drawing if sprite not loaded (only for full ore)
            if (oreState !== 'full') return; // Don't draw fallback for stages
            
            const colors = {
                copper: ['#B87333', '#CD7F32', '#A0522D'],
                iron: ['#434343', '#565656', '#2F2F2F'],
                silver: ['#C0C0C0', '#D3D3D3', '#A9A9A9'],
                gold: ['#FFD700', '#FFED4E', '#FFA500']
            };
            
            const ore = colors[variant] || colors.iron;
            
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(x, y + 20, 30, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Rock base
            ctx.fillStyle = '#2a2a3a';
            ctx.beginPath();
            ctx.moveTo(x - 35, y + 20);
            ctx.lineTo(x - 25, y - 30);
            ctx.lineTo(x, y - 35);
            ctx.lineTo(x + 25, y - 30);
            ctx.lineTo(x + 35, y + 20);
            ctx.closePath();
            ctx.fill();
            
            // Ore veins
            ore.forEach((color, i) => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 4 - i;
                ctx.beginPath();
                ctx.moveTo(x - 20 + i * 5, y - 20);
                ctx.lineTo(x + 20 - i * 5, y + 10);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(x - 10, y - 25 + i * 5);
                ctx.lineTo(x + 15, y - 5 + i * 5);
                ctx.stroke();
            });
            
            // Sparkle effect
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 3; i++) {
                const sparkleX = x - 15 + Math.random() * 30;
                const sparkleY = y - 20 + Math.random() * 30;
                ctx.beginPath();
                ctx.arc(sparkleX, sparkleY, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawAttackRangeIndicator() {
            // Only show in combat zone
            if (gameState.currentRoom !== 'combat') return;
            
            // Determine attack range and color based on equipped weapon/combat style
            const equippedWeapon = gameState.player.equipment.weapon;
            let attackRange = 100; // Default melee (increased)
            let rangeColor = 'rgba(255, 100, 100, 0.15)'; // Red for melee
            let borderColor = 'rgba(255, 100, 100, 0.4)';
            
            if (equippedWeapon) {
                const weaponStyle = getCombatStyleFromItem(equippedWeapon);
                if (weaponStyle === 'ranged') {
                    attackRange = 200; // Ranged (increased)
                    rangeColor = 'rgba(100, 255, 100, 0.15)'; // Green for ranged
                    borderColor = 'rgba(100, 255, 100, 0.4)';
                } else if (weaponStyle === 'magic') {
                    attackRange = 230; // Magic (increased)
                    rangeColor = 'rgba(100, 150, 255, 0.15)'; // Blue for magic
                    borderColor = 'rgba(100, 150, 255, 0.4)';
                }
            }
            
            // Draw range circle around player
            const screenX = gameState.player.x - gameState.camera.x;
            const screenY = gameState.player.y - gameState.camera.y;
            
            // Fill circle
            ctx.fillStyle = rangeColor;
            ctx.beginPath();
            ctx.arc(screenX, screenY, attackRange, 0, Math.PI * 2);
            ctx.fill();
            
            // Border circle with dashed line
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(screenX, screenY, attackRange, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]); // Reset dash
        }

        // Update player animation state and frames
        function updatePlayerAnimation() {
            const now = Date.now();
            const anim = gameState.player.animation;
            
            // Update facing direction based on movement or combat target
            if (gameState.player.targetX !== null) {
                const dx = gameState.player.targetX - gameState.player.x;
                if (Math.abs(dx) > 5) { // Only update if significant horizontal movement
                    anim.facingLeft = dx < 0;
                }
            } else if (gameState.combat.inCombat && gameState.combat.monsterPosition) {
                // Face the monster in combat
                const dx = gameState.combat.monsterPosition.x - gameState.player.x;
                if (Math.abs(dx) > 5) {
                    anim.facingLeft = dx < 0;
                }
            }
            
            // Determine animation state based on player state
            const isMoving = gameState.player.targetX !== null;
            const isInCombat = gameState.combat.inCombat;
            const isDead = gameState.player.skills.hitpoints <= 0;
            
            // State priority: dying > hurt > attacking > walking > idle/idleblink
            if (isDead && anim.currentState !== 'dying') {
                anim.currentState = 'dying';
                anim.frame = 0;
                anim.lastFrameTime = now;
            } else if (anim.currentState === 'hurt' && anim.frame >= 11) {
                // Hurt animation complete, return to appropriate state
                if (isMoving) {
                    anim.currentState = 'walking';
                } else {
                    anim.currentState = 'idle';
                }
                anim.frame = 0;
                anim.lastFrameTime = now;
            } else if (gameState.player.isAttacking && anim.currentState !== 'attacking' && anim.currentState !== 'hurt') {
                anim.currentState = 'attacking';
                anim.frame = 0;
                anim.lastFrameTime = now;
            } else if (isMoving && !gameState.player.isAttacking && anim.currentState !== 'walking' && anim.currentState !== 'hurt') {
                anim.currentState = 'walking';
                anim.frame = 0;
                anim.lastFrameTime = now;
            } else if (!isMoving && !gameState.player.isAttacking && !isDead && anim.currentState !== 'hurt') {
                // Handle idle and occasional blinking
                if (anim.currentState === 'walking' || anim.currentState === 'attacking') {
                    anim.currentState = 'idle';
                    anim.frame = 0;
                    anim.lastFrameTime = now;
                    anim.blinkTimer = now + (3000 + Math.random() * 2000);
                }
                
                // Check if it's time to blink
                if (anim.currentState === 'idle' && now >= anim.blinkTimer) {
                    anim.currentState = 'idleblink';
                    anim.frame = 0;
                    anim.lastFrameTime = now;
                }
                
                // Return to idle after blink animation completes
                if (anim.currentState === 'idleblink' && anim.frame >= 11) {
                    anim.currentState = 'idle';
                    anim.frame = 0;
                    anim.lastFrameTime = now;
                    anim.blinkTimer = now + (3000 + Math.random() * 2000);
                }
            }
            
            // Update animation frame
            if (now - anim.lastFrameTime >= anim.frameDelay) {
                anim.lastFrameTime = now;
                
                // Get max frames for current animation
                const maxFrames = {
                    idle: 11,
                    idleblink: 11,
                    walking: 17,
                    attacking: 11,
                    hurt: 11,
                    dying: 14
                };
                
                const max = maxFrames[anim.currentState] || 11;
                
                // Increment frame
                anim.frame++;
                
                // Loop animations (except dying)
                if (anim.currentState === 'dying') {
                    // Stop on last frame
                    if (anim.frame > max) {
                        anim.frame = max;
                    }
                } else {
                    // Loop back to 0
                    if (anim.frame > max) {
                        anim.frame = 0;
                    }
                }
            }
        }

        function drawPlayer() {
            const { x, y, size } = gameState.player;
            const anim = gameState.player.animation;
            
            // Get current sprite
            const spriteKey = `char_${anim.currentState}_${anim.frame}`;
            const sprite = gameState.sprites[spriteKey];
            
            // Apply camera offset for drawing
            const screenX = x - gameState.camera.x;
            const screenY = y - gameState.camera.y;
            
            if (sprite && sprite.complete) {
                // Character sprite size - increased for better visibility
                const spriteWidth = 96;   // Larger sprite
                const spriteHeight = 96;  // Larger sprite
                
                // Draw shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(screenX, screenY + size, size * 0.8, size * 0.4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Save context for flipping
                ctx.save();
                
                // Flip sprite horizontally if facing left
                if (anim.facingLeft) {
                    ctx.translate(screenX, screenY);
                    ctx.scale(-1, 1);
                    ctx.translate(-screenX, -screenY);
                }
                
                // Draw character sprite centered on player position
                ctx.drawImage(
                    sprite,
                    screenX - spriteWidth / 2,
                    screenY - spriteHeight / 2,
                    spriteWidth,
                    spriteHeight
                );
                
                // Restore context
                ctx.restore();
            } else {
                // Debug: Log missing sprite (only occasionally to avoid spam)
                if (Math.random() < 0.01) { // 1% chance to log
                    console.log('Missing sprite:', spriteKey, 'Sprite exists:', !!sprite, 'Complete:', sprite?.complete);
                }
                
                // Fallback to simple character if sprites not loaded
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(screenX, screenY + size, size * 0.8, size * 0.4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Body
                const bodyGradient = ctx.createLinearGradient(screenX - size, screenY - size, screenX + size, screenY + size);
                bodyGradient.addColorStop(0, '#4a7a8a');
                bodyGradient.addColorStop(0.5, '#5a8a9a');
                bodyGradient.addColorStop(1, '#3a6a7a');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(screenX - size * 0.6, screenY - size * 0.5, size * 1.2, size * 1.5);
                
                // Head
                ctx.fillStyle = '#f4c2a0';
                ctx.beginPath();
                ctx.arc(screenX, screenY - size, size * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                // Hair
                ctx.fillStyle = '#3a2a1a';
                ctx.beginPath();
                ctx.arc(screenX, screenY - size * 1.1, size * 0.6, Math.PI, 0);
                ctx.fill();
            }
            
            // Name (always draw)
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            const displayName = (playerProfile && playerProfile.username) ? playerProfile.username : 'Player';
            ctx.strokeText(displayName, screenX, screenY - size * 2);
            ctx.fillText(displayName, screenX, screenY - size * 2);
        }

        function drawRoom() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw custom background for woodcutting zone if loaded
            if (gameState.currentRoom === 'woodcutting' && woodcuttingBgLoaded) {
                // Draw the background image to cover the entire canvas
                ctx.drawImage(woodcuttingBg, 0, 0, canvas.width, canvas.height);
            } else if (gameState.currentRoom === 'mining' && miningBgLoaded) {
                // Draw the mining background image to cover the entire canvas
                ctx.drawImage(miningBg, 0, 0, canvas.width, canvas.height);
            } else {
                // Draw background gradient for other zones
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#1a2a3a');
                gradient.addColorStop(1, '#0a1a2a');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Draw tiles or tilemap (skip for zones with custom backgrounds)
            if (!(gameState.currentRoom === 'woodcutting' && woodcuttingBgLoaded) && 
                !(gameState.currentRoom === 'mining' && miningBgLoaded)) {
                if (rooms[gameState.currentRoom] && rooms[gameState.currentRoom].usesTilemap && tilemapData) {
                    drawTilemap();
                } else {
                    drawTiles();
                }
            }
            
            // Draw room objects
            const room = rooms[gameState.currentRoom];
            if (room.objects) {
                room.objects.forEach(obj => {
                    const drawX = obj.x - gameState.camera.x;
                    const drawY = obj.y - gameState.camera.y;
                    
                    // Check if this is the current target
                    const isTargeted = gameState.player.currentTarget === obj;
                    
                    switch(obj.type) {
                        case 'tree':
                            drawTree(drawX, drawY, obj.variant, obj.state || 'full', obj.rarity);
                            break;
                        case 'ore':
                            drawOre(drawX, drawY, obj.variant, obj.state || 'full', obj.rarity);
                            break;
                        case 'pond':
                            ctx.fillStyle = '#4682B4';
                            ctx.fillRect(drawX - obj.width/2, drawY - obj.height/2, obj.width, obj.height);
                            break;
                        case 'fishingSpot':
                            // Apply glow for non-common rarities - optimized for performance
                            if (obj.rarity && obj.rarity.key !== 'common') {
                                // Use ring instead of shadowBlur for better performance
                                ctx.strokeStyle = obj.rarity.color;
                                ctx.lineWidth = 5;
                                ctx.globalAlpha = 0.6;
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 35, 0, Math.PI * 2);
                                ctx.stroke();
                                ctx.globalAlpha = 1;
                            }
                            ctx.fillStyle = 'rgba(100, 150, 200, 0.5)';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY, 20, 0, Math.PI * 2);
                            ctx.fill();
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.6)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.stroke();
                            break;
                        case 'dummy':
                            // Combat dummy
                            ctx.fillStyle = '#8B7355';
                            ctx.fillRect(drawX - 15, drawY - 10, 30, 40);
                            ctx.fillStyle = '#A0826D';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY - 25, 15, 0, Math.PI * 2);
                            ctx.fill();
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(255, 100, 100, 0.6)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 18, drawY - 40, 36, 70);
                            break;
                        case 'mob':
                            // Draw mob/monster
                            if (!obj.mobData) break;
                            
                            // Get monster icon
                            const monsterIcon = getMonsterIcon(obj.mobData.name);
                            
                            // Draw mob with colored background based on level/tier
                            const mobSize = 50;
                            
                            // Glow effect if in combat
                            if (obj.inCombat) {
                                ctx.shadowBlur = 15;
                                ctx.shadowColor = '#ff0000';
                            }
                            
                            // Background circle
                            ctx.fillStyle = obj.inCombat ? 'rgba(255, 50, 50, 0.4)' : 'rgba(80, 80, 100, 0.3)';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY, mobSize / 2, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Reset shadow
                            ctx.shadowBlur = 0;
                            
                            // Draw emoji/icon
                            ctx.font = `${mobSize}px Arial`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(monsterIcon, drawX, drawY);
                            
                            // Outline/selection ring
                            ctx.strokeStyle = isTargeted ? '#FFD700' : (obj.inCombat ? '#ff4444' : 'rgba(150, 150, 150, 0.5)');
                            ctx.lineWidth = isTargeted ? 4 : 2;
                            ctx.beginPath();
                            ctx.arc(drawX, drawY, mobSize / 2 + 5, 0, Math.PI * 2);
                            ctx.stroke();
                            
                            // Health bar is now only drawn by drawHealthBars() function (the big one)
                            
                            // Name label
                            ctx.font = '12px Arial';
                            ctx.fillStyle = '#ffffff';
                            ctx.strokeStyle = '#000000';
                            ctx.lineWidth = 3;
                            ctx.strokeText(obj.mobData.name, drawX, drawY + mobSize / 2 + 15);
                            ctx.fillText(obj.mobData.name, drawX, drawY + mobSize / 2 + 15);
                            
                            // Level indicator
                            ctx.font = 'bold 10px Arial';
                            ctx.fillStyle = '#ffdd44';
                            ctx.strokeText(`Lv ${obj.mobData.level}`, drawX, drawY + mobSize / 2 + 28);
                            ctx.fillText(`Lv ${obj.mobData.level}`, drawX, drawY + mobSize / 2 + 28);
                            
                            break;
                        case 'stove':
                            // Cooking stove
                            ctx.fillStyle = '#3a3a3a';
                            ctx.fillRect(drawX - 30, drawY - 20, 60, 40);
                            // Fire
                            ctx.fillStyle = '#FF4500';
                            for (let i = 0; i < 3; i++) {
                                ctx.fillRect(drawX - 20 + i * 15, drawY - 10, 10, 15);
                            }
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 32, drawY - 22, 64, 44);
                            break;
                        case 'table':
                            ctx.fillStyle = '#8B6508';
                            ctx.fillRect(drawX - 40, drawY - 15, 80, 30);
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 42, drawY - 17, 84, 34);
                            break;
                        case 'chest':
                            // Treasure chest
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(drawX - 25, drawY - 15, 50, 30);
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(drawX - 5, drawY - 10, 10, 15);
                            ctx.strokeStyle = '#654321';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(drawX - 25, drawY - 15, 50, 30);
                            // Add selection outline
                            if (isTargeted) {
                                ctx.strokeStyle = '#FFD700';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(drawX - 28, drawY - 18, 56, 36);
                            }
                            break;
                        case 'boss':
                            // Boss enemy
                            ctx.fillStyle = '#8B0000';
                            ctx.fillRect(drawX - 20, drawY - 15, 40, 50);
                            ctx.fillStyle = '#FF0000';
                            ctx.beginPath();
                            ctx.arc(drawX, drawY - 30, 18, 0, Math.PI * 2);
                            ctx.fill();
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(255, 100, 100, 0.6)';
                            ctx.lineWidth = isTargeted ? 4 : 2;
                            ctx.strokeRect(drawX - 23, drawY - 50, 46, 85);
                            break;
                        case 'pest':
                            // Pest (rat/spider)
                            if (obj.variant === 'rat') {
                                ctx.fillStyle = '#5a4a3a';
                                ctx.beginPath();
                                ctx.ellipse(drawX, drawY, 15, 10, 0, 0, Math.PI * 2);
                                ctx.fill();
                                // Add outline
                                ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(255, 100, 100, 0.6)';
                                ctx.lineWidth = isTargeted ? 3 : 2;
                                ctx.stroke();
                            } else {
                                ctx.fillStyle = '#2a2a2a';
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 12, 0, Math.PI * 2);
                                ctx.fill();
                                // Spider legs
                                ctx.strokeStyle = '#2a2a2a';
                                ctx.lineWidth = 2;
                                for (let i = 0; i < 8; i++) {
                                    const angle = (i / 8) * Math.PI * 2;
                                    ctx.beginPath();
                                    ctx.moveTo(drawX, drawY);
                                    ctx.lineTo(drawX + Math.cos(angle) * 20, drawY + Math.sin(angle) * 20);
                                    ctx.stroke();
                                }
                                // Add outline
                                ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(255, 100, 100, 0.6)';
                                ctx.lineWidth = isTargeted ? 3 : 2;
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 25, 0, Math.PI * 2);
                                ctx.stroke();
                            }
                            break;
                        case 'workbench':
                            // Crafting workbench
                            ctx.fillStyle = '#654321';
                            ctx.fillRect(drawX - 35, drawY - 15, 70, 35);
                            ctx.fillStyle = '#8B7355';
                            ctx.fillRect(drawX - 30, drawY - 12, 60, 5);
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 37, drawY - 17, 74, 39);
                            break;
                        case 'anvil':
                            // Blacksmith anvil
                            ctx.fillStyle = '#2a2a3a';
                            ctx.fillRect(drawX - 20, drawY - 10, 40, 25);
                            ctx.fillStyle = '#3a3a4a';
                            ctx.beginPath();
                            ctx.moveTo(drawX - 25, drawY - 10);
                            ctx.lineTo(drawX + 25, drawY - 10);
                            ctx.lineTo(drawX + 20, drawY - 20);
                            ctx.lineTo(drawX - 20, drawY - 20);
                            ctx.closePath();
                            ctx.fill();
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 27, drawY - 22, 54, 47);
                            break;
                        case 'forge':
                            // Forge/furnace
                            ctx.fillStyle = '#3a3a3a';
                            ctx.fillRect(drawX - 30, drawY - 25, 60, 50);
                            // Fire inside
                            ctx.fillStyle = '#FF6500';
                            ctx.fillRect(drawX - 20, drawY - 5, 40, 20);
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(drawX - 15, drawY, 30, 10);
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 32, drawY - 27, 64, 54);
                            break;
                        case 'chest':
                            // Draw treasure chest with tier indicator
                            const tierColors = {
                                1: '#8a8a8a',
                                2: '#5abaaa', 
                                3: '#5a8afa',
                                4: '#aa5afa',
                                5: '#FFD700'
                            };
                            const chestColor = tierColors[obj.tier] || '#8a8a8a';
                            
                            // Glow effect for higher tiers (if not empty)
                            if (obj.state === 'full' && obj.tier >= 3) {
                                ctx.strokeStyle = chestColor;
                                ctx.lineWidth = 4;
                                ctx.globalAlpha = 0.5;
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 35, 0, Math.PI * 2);
                                ctx.stroke();
                                ctx.globalAlpha = 1;
                            }
                            
                            // Draw chest icon
                            ctx.font = '40px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText('ðŸ“¦', drawX, drawY);
                            
                            // Draw tier number on chest
                            if (obj.state === 'full') {
                                ctx.font = 'bold 16px Arial';
                                ctx.fillStyle = chestColor;
                                ctx.strokeStyle = '#000';
                                ctx.lineWidth = 3;
                                ctx.strokeText(`T${obj.tier}`, drawX, drawY - 25);
                                ctx.fillText(`T${obj.tier}`, drawX, drawY - 25);
                            }
                            
                            // Add outline/selection
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(138, 43, 226, 0.6)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.beginPath();
                            ctx.arc(drawX, drawY, 25, 0, Math.PI * 2);
                            ctx.stroke();
                            break;
                        case 'obstacle':
                            // Draw obstacle
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(drawX - 25, drawY - 15, 50, 30);
                            ctx.fillStyle = '#654321';
                            ctx.fillRect(drawX - 20, drawY - 10, 40, 20);
                            // Add outline
                            ctx.strokeStyle = isTargeted ? '#FFD700' : 'rgba(90, 186, 170, 0.5)';
                            ctx.lineWidth = isTargeted ? 3 : 2;
                            ctx.strokeRect(drawX - 27, drawY - 17, 54, 34);
                            break;
                        case 'treasure':
                            // Treasure spot
                            if (obj.variant === 'buried') {
                                // X marks the spot
                                ctx.strokeStyle = '#8B4513';
                                ctx.lineWidth = 4;
                                ctx.beginPath();
                                ctx.moveTo(drawX - 20, drawY - 20);
                                ctx.lineTo(drawX + 20, drawY + 20);
                                ctx.stroke();
                                ctx.beginPath();
                                ctx.moveTo(drawX - 20, drawY + 20);
                                ctx.lineTo(drawX + 20, drawY - 20);
                                ctx.stroke();
                                // Add outline
                                if (isTargeted) {
                                    ctx.strokeStyle = '#FFD700';
                                    ctx.lineWidth = 3;
                                    ctx.beginPath();
                                    ctx.arc(drawX, drawY, 30, 0, Math.PI * 2);
                                    ctx.stroke();
                                }
                            } else {
                                // Treasure chest
                                ctx.fillStyle = '#FFD700';
                                ctx.fillRect(drawX - 25, drawY - 15, 50, 30);
                                ctx.strokeStyle = '#8B4513';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(drawX - 25, drawY - 15, 50, 30);
                                // Gems
                                ctx.fillStyle = '#FF0000';
                                ctx.beginPath();
                                ctx.arc(drawX - 10, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.fillStyle = '#00FF00';
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.fillStyle = '#0000FF';
                                ctx.beginPath();
                                ctx.arc(drawX + 10, drawY, 5, 0, Math.PI * 2);
                                ctx.fill();
                                // Add selection outline
                                if (isTargeted) {
                                    ctx.strokeStyle = '#FFD700';
                                    ctx.lineWidth = 4;
                                    ctx.strokeRect(drawX - 28, drawY - 18, 56, 36);
                                }
                            }
                            break;
                    }
                    
                    // Add pulsing glow effect for targeted node
                    if (isTargeted) {
                        const pulse = Math.sin(Date.now() / 200) * 0.3 + 0.7;
                        ctx.strokeStyle = `rgba(255, 215, 0, ${pulse})`;
                        ctx.lineWidth = 5;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.arc(drawX, drawY, 40, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                });
            }
            
            // Draw particles
            gameState.particles.forEach((particle, index) => {
                ctx.fillStyle = particle.color;
                ctx.globalAlpha = particle.alpha;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                
                // Update particle
                if (particle.vx !== undefined && particle.vy !== undefined) {
                    // Physics-based particle with velocity
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.vx *= 0.95; // Air resistance
                    particle.vy *= 0.95;
                } else {
                    // Simple upward-moving particle
                    particle.y -= particle.speed;
                }
                
                // Apply decay if specified, otherwise use default
                const decayRate = particle.decay || 0.02;
                particle.alpha -= decayRate;
                particle.size *= 0.98;
            });
            
            // Clean up dead particles (filter instead of splice to avoid iteration issues)
            gameState.particles = gameState.particles.filter(p => p.alpha > 0);
            
            // Prevent memory leak - cap particles at 1000
            if (gameState.particles.length > 1000) {
                gameState.particles = gameState.particles.slice(-1000);
            }
        }

        // Movement
        function movePlayer() {
            // Check if player is locked in attack animation
            if (gameState.player.isAttacking && Date.now() < gameState.player.attackLockoutEnd) {
                // Player can't move during attack lockout
                return;
            } else if (gameState.player.isAttacking) {
                // Attack lockout has expired, allow movement again
                gameState.player.isAttacking = false;
            }
            
            if (gameState.player.targetX !== null) {
                const dx = gameState.player.targetX - gameState.player.x;
                const dy = gameState.player.targetY - gameState.player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 10) {
                    // Calculate base movement direction
                    let moveX = (dx / distance) * gameState.player.speed;
                    let moveY = (dy / distance) * gameState.player.speed;
                    
                    // Apply soft collision with objects (trees, rocks, etc.)
                    const room = rooms[gameState.currentRoom];
                    if (room.objects) {
                        const COLLISION_DISTANCE = 90; // Distance at which to start avoiding (doubled)
                        const PUSH_STRENGTH = 0.8; // How strong the avoidance is
                        
                        room.objects.forEach(obj => {
                            // Skip the current target to avoid circular avoidance
                            if (obj === gameState.player.currentTarget) return;
                            
                            // Skip non-solid objects
                            if (obj.type === 'pond' || obj.type === 'fishingSpot') return;
                            
                            // Skip regrowing resources (smaller/not solid)
                            if ((obj.type === 'tree' || obj.type === 'ore' || obj.type === 'chest') && obj.state !== 'full') return;
                            
                            // Calculate distance to object
                            const objDx = obj.x - gameState.player.x;
                            const objDy = obj.y - gameState.player.y;
                            const objDistance = Math.sqrt(objDx * objDx + objDy * objDy);
                            
                            // If close to object, apply soft push away
                            if (objDistance < COLLISION_DISTANCE && objDistance > 0) {
                                // Calculate push force (stronger when closer)
                                const pushForce = (1 - objDistance / COLLISION_DISTANCE) * PUSH_STRENGTH;
                                
                                // Push away from object
                                const pushX = -(objDx / objDistance) * pushForce * gameState.player.speed;
                                const pushY = -(objDy / objDistance) * pushForce * gameState.player.speed;
                                
                                moveX += pushX;
                                moveY += pushY;
                            }
                        });
                    }
                    
                    // Apply movement with soft collision adjustments
                    gameState.player.x += moveX;
                    gameState.player.y += moveY;
                    
                    // Add movement particles
                    if (Math.random() > 0.7) {
                        gameState.particles.push({
                            x: gameState.player.x + (Math.random() - 0.5) * 20,
                            y: gameState.player.y + 20,
                            size: 3,
                            color: '#8a7a6a',
                            speed: 1,
                            alpha: 0.5
                        });
                    }
                } else {
                    // Reached a target and stopped moving - check if it's a mob to initiate combat
                    if (gameState.player.currentTarget && gameState.player.currentTarget.type === 'mob') {
                        // Initiate combat with this mob
                        const mob = gameState.player.currentTarget;
                        
                        // Check if any mob is already in combat
                        const room = rooms[gameState.currentRoom];
                        const mobInCombat = room.objects && room.objects.find(obj => obj.type === 'mob' && obj.inCombat);
                        
                        if (mobInCombat) {
                            showFloatingText('Already in combat!', canvas.width / 2, 100, '#ff4444');
                            gameState.player.currentTarget = null;
                            gameState.player.targetX = null;
                            gameState.player.targetY = null;
                            return;
                        }
                        
                        // Mark mob as in combat
                        mob.inCombat = true;
                        
                        // Initialize combat state
                        gameState.combat.monster = mob.mobData;
                        gameState.combat.monsterHealth = mob.health;
                        gameState.combat.monsterMaxHealth = mob.maxHealth;
                        gameState.combat.inCombat = true;
                        gameState.combat.damageSplats = [];
                        gameState.combat.monsterNode = mob; // Reference to the actual node
                        
                        // Position monster for display
                        gameState.combat.monsterPosition = {
                            x: mob.x,
                            y: mob.y
                        };
                        
                        // Show combat initiated message
                        showFloatingText(`Engaging ${mob.mobData.name}!`, canvas.width / 2, 100, '#ff6b6b');
                        
                        // Reset attack timers
                        gameState.combat.lastPlayerAttack = Date.now();
                        gameState.combat.lastMonsterAttack = Date.now();
                        
                        // Clear the current target so player doesn't keep pathing to it
                        gameState.player.currentTarget = null;
                        gameState.player.targetX = null;
                        gameState.player.targetY = null;
                        gameState.player.isPerformingAction = false;
                        
                        return;
                    }
                    
                    // Start performing action if we reached target
                    if (gameState.player.currentTarget && !gameState.player.isPerformingAction) {
                        gameState.player.isPerformingAction = true;
                        gameState.player.actionProgress = 0;
                        gameState.player.lastActionTime = Date.now();
                        
                        // Apply tool speed bonus to action duration
                        const baseActionDuration = 3000; // 3 seconds base
                        const speedBonus = getToolSpeedBonus(gameState.currentRoom);
                        // Speed bonus reduces the time: 5% = 0.95x time, 25% = 0.75x time
                        gameState.player.actionDuration = baseActionDuration * (1 - speedBonus / 100);
                    }
                }
            }
        }

        // AFK Activity System
        function selectNextTarget() {
            const room = rooms[gameState.currentRoom];
            if (!room.objects || room.objects.length === 0) return;
            
            // Select random object
            const availableObjects = room.objects.filter(obj => {
                // Don't target ponds, only fishing spots
                if (obj.type === 'pond') return false;
                
                // Don't target mobs - combat must be manual
                if (obj.type === 'mob') return false;
                
                // Don't target resources that are regrowing
                if ((obj.type === 'tree' || obj.type === 'ore' || obj.type === 'chest') && obj.state !== 'full') return false;
                
                return true;
            });
            
            if (availableObjects.length > 0) {
                const target = availableObjects[Math.floor(Math.random() * availableObjects.length)];
                gameState.player.currentTarget = target;
                gameState.player.targetX = target.x;
                gameState.player.targetY = target.y;
            }
        }

        function performAction() {
            if (!gameState.player.isPerformingAction || !gameState.player.currentTarget) return;
            
            const now = Date.now();
            const elapsed = now - gameState.player.lastActionTime;
            gameState.player.actionProgress = Math.min(elapsed / gameState.player.actionDuration, 1);
            
            // Draw progress bar above player
            drawActionProgress();
            
            // Action complete
            if (gameState.player.actionProgress >= 1) {
                completeAction();
                
                // Respawn gathering nodes with new rarity
                if (['woodcutting', 'mining', 'fishing', 'plundering'].includes(gameState.currentRoom) && 
                    gameState.player.currentTarget) {
                    const target = gameState.player.currentTarget;
                    
                    if (target.type === 'tree') {
                        // Start tree regrowth sequence
                        target.state = 'stump';
                        target.regrowthStartTime = now;
                        // Tree will be: stump (0-2s) -> half (2-4s) -> full (4s+)
                    } else if (target.type === 'ore') {
                        // Start ore regrowth sequence
                        target.state = 'stage1';
                        target.regrowthStartTime = now;
                        // Ore will be: stage1 (0-2s) -> stage2 (2-4s) -> full (4s+)
                    } else if (target.type === 'chest') {
                        // Start chest respawn sequence
                        target.state = 'depleted';
                        target.regrowthStartTime = now;
                        // Chest will be: depleted (0-3s) -> refilling (3-6s) -> full (6s+)
                    } else if (target.type === 'fishingSpot') {
                        // Roll new rarity for fishing spots (they don't regrow visually)
                        target.rarity = getRarity();
                    }
                }
                
                // Special handling for smithwright/crafting - auto-walk to next node
                if ((gameState.currentRoom === 'smithwright' && gameState.smithwrightActivity && gameState.smithwrightActivity.active) ||
                    (gameState.currentRoom === 'crafting' && gameState.craftingQueue && gameState.craftingQueue.length > 0)) {
                    
                    // Find all available nodes for this activity
                    const room = rooms[gameState.currentRoom];
                    let availableNodes = [];
                    
                    if (gameState.currentRoom === 'smithwright') {
                        availableNodes = room.objects.filter(obj => 
                            obj.type === 'forge' || obj.type === 'anvil'
                        );
                    } else if (gameState.currentRoom === 'crafting') {
                        availableNodes = room.objects.filter(obj => 
                            obj.type === 'workbench' || obj.type === 'anvil' || obj.type === 'forge'
                        );
                    }
                    
                    if (availableNodes.length > 0) {
                        // Find a DIFFERENT node than the current one
                        let nextNode = null;
                        const currentNode = gameState.player.currentTarget;
                        
                        // Filter out the current node to force movement
                        const otherNodes = availableNodes.filter(node => node !== currentNode);
                        
                        if (otherNodes.length > 0) {
                            // Find the closest different node
                            let closestDistance = Infinity;
                            otherNodes.forEach(node => {
                                const dx = node.x - gameState.player.x;
                                const dy = node.y - gameState.player.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                if (distance < closestDistance) {
                                    closestDistance = distance;
                                    nextNode = node;
                                }
                            });
                        } else {
                            // All nodes are the same (only 1 node total), just use any node
                            nextNode = availableNodes[0];
                        }
                        
                        if (nextNode) {
                            // Set next node as target and continue
                            gameState.player.currentTarget = nextNode;
                            gameState.player.targetX = nextNode.x;
                            gameState.player.targetY = nextNode.y;
                            gameState.player.isPerformingAction = false;
                            return; // Don't reset target
                        }
                    }
                }
                
                gameState.player.isPerformingAction = false;
                gameState.player.currentTarget = null;
                gameState.player.targetX = null;
                gameState.player.targetY = null;
                
                // Schedule next action
                gameState.nextTargetTime = now + 1000; // Wait 1 second before next action
            }
        }

        function completeAction() {
            const room = rooms[gameState.currentRoom];
            
            // Get tier-based reward for resource gathering rooms
            let reward = null;
            
            if (['woodcutting', 'mining', 'fishing', 'plundering', 'agility'].includes(gameState.currentRoom)) {
                // Get the skill level for this activity
                const skillLevel = gameState.player.skills[gameState.currentRoom] || 1;
                
                // Get available tier based on skill level
                const resource = getAvailableTier(gameState.currentRoom, skillLevel);
                
                if (resource) {
                    // Use node rarity for gathering skills (woodcutting, mining, fishing, plundering)
                    let rarity;
                    if (['woodcutting', 'mining', 'fishing', 'plundering'].includes(gameState.currentRoom) && 
                        gameState.player.currentTarget && gameState.player.currentTarget.rarity) {
                        // Use the node's assigned rarity
                        rarity = gameState.player.currentTarget.rarity;
                    } else {
                        // Roll for rarity (for agility, or if node has no rarity)
                        rarity = getRarity();
                    }
                    const tierBonus = resource.tier;
                    
                    // Calculate rewards with rarity multiplier
                    const expReward = Math.floor(resource.exp * rarity.multiplier);
                    
                    // Special case: Plundering gives gold instead of items
                    if (resource.baseIcon === 'gold') {
                        const goldAmount = Math.floor(
                            (resource.goldMin + Math.random() * (resource.goldMax - resource.goldMin)) * rarity.multiplier
                        );
                        reward = {
                            gold: goldAmount,
                            xp: expReward,
                            item: null,
                            skill: gameState.currentRoom
                        };
                    } else {
                        // Get appropriate icon based on rarity
                        let iconName = getResourceIcon(resource.baseIcon, resource.tier, rarity.key);
                        
                        // Create item name with tier and rarity
                        const itemName = `T${resource.tier} ${rarity.name} ${resource.name}`;
                        
                        reward = {
                            gold: 0,
                            xp: expReward,
                            item: {
                                name: itemName,
                                icon: iconName,
                                tier: resource.tier,
                                rarity: rarity.key,
                                rarityColor: rarity.color,
                                stackable: true,
                                type: 'resource'
                            },
                            skill: gameState.currentRoom
                        };
                    }
                    
                    // White rock special: 1% chance to get emerald
                    if (gameState.currentRoom === 'mining' && 
                        gameState.player.currentTarget && 
                        gameState.player.currentTarget.variant === 'whiteRock') {
                        
                        // 1% chance
                        if (Math.random() < 0.01) {
                            // Get player's mining tier
                            const miningLevel = gameState.player.skills.mining || 1;
                            let emeraldTier = 1;
                            if (miningLevel >= 80) emeraldTier = 5;
                            else if (miningLevel >= 60) emeraldTier = 4;
                            else if (miningLevel >= 40) emeraldTier = 3;
                            else if (miningLevel >= 20) emeraldTier = 2;
                            
                            // Create emerald item
                            const emerald = {
                                name: `T${emeraldTier} Emerald`,
                                icon: `emerald_T${emeraldTier}`,
                                tier: emeraldTier,
                                rarity: 'epic',
                                rarityColor: '#9c27b0',
                                stackable: true,
                                type: 'gem'
                            };
                            
                            // Add emerald to inventory
                            addToInventory(emerald);
                            
                            // Show special notification
                            showFloatingText(`ðŸ’Ž RARE! T${emeraldTier} Emerald! ðŸ’Ž`, gameState.player.x, gameState.player.y - 50, '#00ff00');
                            
                            // Add special particles for emerald drop
                            for (let i = 0; i < 30; i++) {
                                gameState.particles.push({
                                    x: gameState.player.x + (Math.random() - 0.5) * 80,
                                    y: gameState.player.y + (Math.random() - 0.5) * 80,
                                    size: 10,
                                    color: '#00ff00',
                                    speed: 4,
                                    alpha: 1
                                });
                            }
                        }
                    }
                    
                    // Special effects for rare drops
                    if (rarity.key === 'perfect') {
                        // Add extra particles for perfect drops
                        for (let i = 0; i < 20; i++) {
                            gameState.particles.push({
                                x: gameState.player.x + (Math.random() - 0.5) * 60,
                                y: gameState.player.y + (Math.random() - 0.5) * 60,
                                size: 8,
                                color: '#FFD700',
                                speed: 3,
                                alpha: 1
                            });
                        }
                    } else if (rarity.key === 'epic') {
                        // Epic drop
                    }
                    
                } else {
                    // Shouldn't happen, but fallback
                    reward = {
                        gold: 10,
                        xp: 10,
                        item: null,
                        skill: gameState.currentRoom
                    };
                }
            } else if (gameState.currentRoom === 'smithwright') {
                // Smithwright - craft based on player's selected activity
                // BUT only do automatic crafting if the modal is CLOSED (manual control when modal is open)
                const smithwrightModal = document.getElementById('smithwrightModal');
                const isModalOpen = smithwrightModal && smithwrightModal.style.display === 'block';
                
                if (isModalOpen) {
                    // Modal is open - player is in control, don't auto-craft
                    reward = {
                        gold: 0,
                        xp: 0,
                        item: null,
                        skill: 'smithwright'
                    };
                } else if (gameState.smithwrightActivity && gameState.smithwrightActivity.active) {
                    // Modal is closed and player has set an activity - do automatic crafting
                    const activity = gameState.smithwrightActivity;
                    const qualityData = smithQualityData[activity.quality];
                    const tierData = smithTierData[activity.tier];
                    const sourceType = activity.category === 'bars' ? 'Ore' : 'Log';
                    const productType = activity.category === 'bars' ? 'Bar' : 'Plank';
                    
                    // Find matching material (tier AND quality must BOTH match - only that specific rarity!)
                    const materialItem = gameState.player.inventory.find(item => 
                        item && item.name && 
                        item.name.includes(`T${activity.tier}`) && 
                        item.name.includes(activity.quality) && 
                        item.name.includes(sourceType)
                    );
                    
                    if (materialItem) {
                        // Remove one material
                        if (materialItem.quantity > 1) {
                            materialItem.quantity--;
                        } else {
                            const materialIndex = gameState.player.inventory.indexOf(materialItem);
                            gameState.player.inventory.splice(materialIndex, 1);
                        }
                        
                        // Check success based on quality
                        const success = Math.random() < qualityData.successChance;
                        
                        if (success) {
                            // Create product with matching tier and quality
                            const productName = `T${activity.tier} ${activity.quality} ${productType}`;
                            const convertedItem = {
                                name: productName,
                                icon: activity.category === 'bars' ? 'ðŸ”©' : 'ðŸªµ',
                                tier: activity.tier,
                                rarity: activity.quality.toLowerCase(),
                                rarityColor: qualityData.color,
                                stackable: true,
                                type: 'processed'
                            };
                            
                            const xp = Math.round(tierData.baseXP * qualityData.xpMult);
                            reward = {
                                gold: 0,
                                xp: xp,
                                item: convertedItem,
                                skill: 'smithwright',
                                convertedFrom: materialItem.name
                            };
                        } else {
                            // Failed craft - no product but still give small XP
                            const failXp = Math.round(tierData.baseXP * 0.1);
                            reward = {
                                gold: 0,
                                xp: failXp,
                                item: null,
                                skill: 'smithwright'
                            };
                            showFloatingText('Craft failed!', gameState.player.x, gameState.player.y - 40, '#ff8a8a');
                        }
                    } else {
                        // No matching materials found
                        reward = {
                            gold: 0,
                            xp: 0,
                            item: null,
                            skill: 'smithwright'
                        };
                        showFloatingText(`Out of ${activity.quality} ${tierData.name} ${sourceType}!`, gameState.player.x, gameState.player.y - 40, '#ff8a8a');
                        
                        // Stop the current activity
                        gameState.smithwrightActivity.active = false;
                        
                        // Check if there's a queue and start the next activity
                        if (gameState.smithwrightQueue && gameState.smithwrightQueue.length > 0) {
                            // Remove completed job from queue
                            gameState.smithwrightQueue.shift();
                            
                            // Start next job if available
                            if (gameState.smithwrightQueue.length > 0) {
                                const nextJob = gameState.smithwrightQueue[0];
                                setTimeout(() => {
                                    setSmithwrightActivity(nextJob.category, nextJob.tier, nextJob.quality);
                                    showFloatingText(`Auto-crafting ${nextJob.quality} T${nextJob.tier}! (${gameState.smithwrightQueue.length} types remaining)`, gameState.player.x, gameState.player.y - 60, '#d4a76a');
                                }, 500); // Small delay for smoother transition
                            } else {
                                showFloatingText('All smithwright jobs complete!', gameState.player.x, gameState.player.y - 60, '#5abaaa');
                                gameState.smithwrightQueue = null;
                            }
                        }
                    }
                } else {
                    // No activity set - idle
                    reward = {
                        gold: 0,
                        xp: 0,
                        item: null,
                        skill: 'smithwright'
                    };
                    showFloatingText('Open smithwright menu to select what to craft', gameState.player.x, gameState.player.y - 40, '#ffaa44');
                }
            } else if (gameState.currentRoom === 'crafting') {
                // Crafting - handle arrow crafting from queue or generic crafting
                const craftingLevel = gameState.player.skills.crafting || 1;
                
                // Check if there's an arrow in the crafting queue
                if (gameState.craftingQueue && gameState.craftingQueue.length > 0) {
                    const craftJob = gameState.craftingQueue[0]; // Get first job
                    
                    if (craftJob.type === 'arrow') {
                        const tier = craftJob.tier;
                        
                        // Find and consume materials
                        const inventory = gameState.player.inventory;
                        let oreFound = false;
                        let logsFound = false;
                        
                        // Find and remove ore
                        for (let i = 0; i < inventory.length; i++) {
                            const item = inventory[i];
                            if (item && item.name.includes(`T${tier}`) && item.name.includes('Ore') && !oreFound) {
                                if (item.quantity > 1) {
                                    item.quantity--;
                                } else {
                                    inventory.splice(i, 1);
                                }
                                oreFound = true;
                                break;
                            }
                        }
                        
                        // Find and remove logs
                        for (let i = 0; i < inventory.length; i++) {
                            const item = inventory[i];
                            if (item && item.name.includes(`T${tier}`) && item.name.includes('Log') && !logsFound) {
                                if (item.quantity > 1) {
                                    item.quantity--;
                                } else {
                                    inventory.splice(i, 1);
                                }
                                logsFound = true;
                                break;
                            }
                        }
                        
                        if (oreFound && logsFound) {
                            // Successfully crafted arrow
                            const arrow = {
                                name: `T${tier} Arrow`,
                                icon: 'ðŸ¹',
                                tier: tier,
                                stackable: true,
                                type: 'arrows',
                                quantity: 1
                            };
                            
                            // XP amounts: 5, 10, 20, 30, 40 for T1-T5
                            const xpAmounts = [5, 10, 20, 30, 40];
                            const xp = xpAmounts[tier - 1];
                            
                            reward = {
                                gold: 0,
                                xp: xp,
                                item: arrow,
                                skill: 'crafting'
                            };
                            
                            // Remove job from queue
                            gameState.craftingQueue.shift();
                            
                            showFloatingText(`Crafted T${tier} Arrow! +${xp} XP`, gameState.player.x, gameState.player.y - 40, '#5abaaa');
                        } else {
                            // Missing materials
                            reward = {
                                gold: 0,
                                xp: 0,
                                item: null,
                                skill: 'crafting'
                            };
                            showFloatingText('Missing materials for arrow!', gameState.player.x, gameState.player.y - 40, '#ff4444');
                            // Remove failed job from queue
                            gameState.craftingQueue.shift();
                        }
                    }
                } else {
                    // No crafting jobs - do generic crafting
                    let craftedItem = null;
                    let craftedFrom = null;
                    
                    // Check for planks first
                    const plankItem = gameState.player.inventory.find(item => 
                        item && item.name && item.name.toLowerCase().includes('plank')
                    );
                    
                    if (plankItem) {
                        // Use plank to craft - properly handle quantity
                        if (plankItem.quantity > 1) {
                            plankItem.quantity--;
                        } else {
                            const plankIndex = gameState.player.inventory.indexOf(plankItem);
                            gameState.player.inventory.splice(plankIndex, 1);
                        }
                        
                        // Create crafted item with same tier and rarity
                        const craftedName = plankItem.name.replace('Plank', 'Crafted Item');
                        craftedItem = {
                            name: craftedName,
                            icon: 'ðŸ”¨',
                            tier: plankItem.tier || 1,
                            rarity: plankItem.rarity || 'common',
                            rarityColor: plankItem.rarityColor || '#ffffff',
                            stackable: true,
                            type: 'crafted'
                        };
                        craftedFrom = plankItem.name;
                    } else {
                        // Check for bars
                        const barItem = gameState.player.inventory.find(item => 
                            item && item.name && item.name.toLowerCase().includes('bar')
                        );
                        
                        if (barItem) {
                            // Use bar to craft - properly handle quantity
                            if (barItem.quantity > 1) {
                                barItem.quantity--;
                            } else {
                                const barIndex = gameState.player.inventory.indexOf(barItem);
                                gameState.player.inventory.splice(barIndex, 1);
                            }
                            
                            // Create crafted item with same tier and rarity
                            const craftedName = barItem.name.replace('Bar', 'Armor Piece');
                            craftedItem = {
                                name: craftedName,
                                icon: 'ðŸ›¡ï¸',
                                tier: barItem.tier || 1,
                                rarity: barItem.rarity || 'common',
                                rarityColor: barItem.rarityColor || '#ffffff',
                                stackable: true,
                                type: 'crafted'
                            };
                            craftedFrom = barItem.name;
                        }
                    }
                    
                    if (craftedItem) {
                        const tierBonus = craftedItem.tier || 1;
                        reward = {
                            gold: 0,
                            xp: Math.floor(40 * tierBonus),
                            item: craftedItem,
                            skill: 'crafting',
                            convertedFrom: craftedFrom
                        };
                    } else {
                        // No items to craft with - train with low rewards
                        reward = {
                            gold: 0,
                            xp: 5,
                            item: null,
                            skill: 'crafting'
                        };
                        // ALWAYS show tip that this is inefficient - 100% of the time
                        showFloatingText('Tip: Bring planks or bars for better XP!', gameState.player.x, gameState.player.y - 40, '#ffaa44');
                    }
                }
            } else if (gameState.currentRoom === 'cooking') {
                // Cooking - convert fish and acorns to cooked food
                const cookingLevel = gameState.player.skills.cooking || 1;
                
                // Find items in inventory to cook
                let cookedItem = null;
                let cookedFrom = null;
                
                // Check for fish first
                const fishItem = gameState.player.inventory.find(item => 
                    item && item.name && (item.name.toLowerCase().includes('raw fish') || (item.name.toLowerCase().includes('fish') && !item.name.toLowerCase().includes('cooked')))
                );
                
                if (fishItem) {
                    // Convert fish to cooked fish - properly handle quantity
                    if (fishItem.quantity > 1) {
                        fishItem.quantity--;
                    } else {
                        const fishIndex = gameState.player.inventory.indexOf(fishItem);
                        gameState.player.inventory.splice(fishIndex, 1);
                    }
                    
                    // Create cooked fish with same tier and rarity
                    let cookedName;
                    if (fishItem.name.includes('Cooked')) {
                        // Already cooked, keep the name
                        cookedName = fishItem.name;
                    } else if (fishItem.name.includes('Raw Fish')) {
                        // Replace "Raw Fish" with "Cooked Fish"
                        cookedName = fishItem.name.replace('Raw Fish', 'Cooked Fish');
                    } else if (fishItem.name.includes('Fish')) {
                        // Just has "Fish", replace with "Cooked Fish"
                        cookedName = fishItem.name.replace('Fish', 'Cooked Fish');
                    } else {
                        // Fallback
                        cookedName = 'Cooked ' + fishItem.name;
                    }
                    const cookedSpriteKey = `cookedfish_T${fishItem.tier || 1}_${fishItem.rarity || 'Common'}`;
                    const cookedSprite = gameState.sprites[cookedSpriteKey];
                    
                    cookedItem = {
                        name: cookedName,
                        icon: cookedSpriteKey, // This is the sprite lookup key
                        tier: fishItem.tier || 1,
                        rarity: fishItem.rarity || 'common',
                        rarityColor: fishItem.rarityColor || '#ffffff',
                        stackable: true,
                        type: 'food'
                    };
                    
                    // If sprite loaded, attach it
                    if (cookedSprite) {
                        cookedItem.customSprite = cookedSprite;
                    }
                    
                    cookedFrom = fishItem.name;
                    
                    const tierBonus = fishItem.tier || 1;
                    const rarityBonus = resourceRarities[fishItem.rarity]?.multiplier || 1;
                    
                    reward = {
                        gold: Math.floor((8 + tierBonus * 6) * rarityBonus),
                        xp: Math.floor((15 + tierBonus * 8) * rarityBonus),
                        item: cookedItem,
                        skill: 'cooking',
                        convertedFrom: cookedFrom
                    };
                } else {
                    // Check for acorns
                    const acornItem = gameState.player.inventory.find(item => 
                        item && item.name && item.name.toLowerCase().includes('acorn') && !item.name.toLowerCase().includes('roasted')
                    );
                    
                    if (acornItem) {
                        // Convert acorn to roasted acorn - properly handle quantity
                        if (acornItem.quantity > 1) {
                            acornItem.quantity--;
                        } else {
                            const acornIndex = gameState.player.inventory.indexOf(acornItem);
                            gameState.player.inventory.splice(acornIndex, 1);
                        }
                        
                        // Create roasted acorn with same tier
                        const roastedName = acornItem.name.replace('Acorn', 'Roasted Acorn');
                        const roastedSpriteKey = `roastedacorn_T${acornItem.tier || 1}`;
                        const roastedSprite = gameState.sprites[roastedSpriteKey];
                        
                        cookedItem = {
                            name: roastedName,
                            icon: roastedSpriteKey,
                            tier: acornItem.tier || 1,
                            stackable: true,
                            type: 'food'
                        };
                        
                        // If sprite loaded, attach it
                        if (roastedSprite) {
                            cookedItem.customSprite = roastedSprite;
                        }
                        
                        cookedFrom = acornItem.name;
                        
                        reward = {
                            gold: 0,
                            xp: 10 + (acornItem.tier || 1) * 5,
                            item: cookedItem,
                            skill: 'cooking',
                            convertedFrom: cookedFrom
                        };
                    } else {
                        // No items to cook - just give XP for practice cooking
                        reward = {
                            gold: 0,
                            xp: 15, // Reduced XP since no ingredients
                            skill: 'cooking'
                        };
                        // Show tip that bringing fish or acorns is better
                        showFloatingText('Bring raw fish or acorns for better rewards!', gameState.player.x, gameState.player.y - 40, '#ffaa44');
                    }
                }
            } else {
                // Use default rewards for other rooms
                const rewards = {
                    raids: { gold: 100, xp: 80, item: { name: 'Raid Loot', icon: 'ðŸ’Ž', stackable: false, type: 'valuable' }, skill: 'combat' },
                    combat: { gold: 35, xp: 50, item: null, skill: 'combat' }
                };
                
                reward = rewards[gameState.currentRoom] || { gold: 10, xp: 20, item: null, skill: 'combat' };
            }
            
            // Add gold
            gameState.player.gold += reward.gold;
            document.getElementById('goldAmount').textContent = gameState.player.gold.toLocaleString();
            document.getElementById('invGold').textContent = gameState.player.gold.toLocaleString();
            
            // Add item to inventory
            if (reward.item) {
                addToInventory(reward.item);
            }
            
            // 5% chance to get an acorn when woodcutting
            if (gameState.currentRoom === 'woodcutting' && reward.item && Math.random() < 0.05) {
                const acornTier = reward.item.tier; // Use same tier as the logs
                const acornIcon = `acorn_T${acornTier}`;
                const acornItem = {
                    name: `T${acornTier} Acorn`,
                    icon: acornIcon,
                    tier: acornTier,
                    stackable: true,
                    type: 'resource'
                };
                addToInventory(acornItem);
                showFloatingText(`+1 Acorn!`, gameState.player.x, gameState.player.y - 58, '#8B4513');
                gameState.activityTracker.itemsGained++;
            }
            
            // 2% chance to get a clue scroll from gathering activities (woodcutting, mining, fishing, plundering)
            if (['woodcutting', 'mining', 'fishing', 'plundering'].includes(gameState.currentRoom) && reward.item && Math.random() < 0.02) {
                const clueTier = reward.item.tier; // Use same tier as the resource
                
                // Check if player already has this tier of clue scroll
                const alreadyHasClue = gameState.player.inventory.some(item => 
                    item && item.name === `T${clueTier} Clue Scroll`
                );
                
                // Only drop if player doesn't already have this tier
                if (!alreadyHasClue) {
                    const clueScrollItem = {
                        name: `T${clueTier} Clue Scroll`,
                        icon: `cluescroll_T${clueTier}`,
                        tier: clueTier,
                        type: 'clue',
                        rarity: 'Perfect',
                        customSprite: spriteUrls[`cluescroll_T${clueTier}`] || null
                    };
                    addToInventory(clueScrollItem);
                    
                    // Generate clue scroll tasks
                    if (clueTier === 1) {
                        generateT1ClueScrollTasks();
                    }
                    
                    showFloatingText(`ðŸ“œ T${clueTier} Clue Scroll!`, gameState.player.x, gameState.player.y - 64, '#d4a76a');
                    
                    // Special particles for clue scroll
                    for (let i = 0; i < 15; i++) {
                        gameState.particles.push({
                            x: gameState.player.x + (Math.random() - 0.5) * 60,
                            y: gameState.player.y + (Math.random() - 0.5) * 60,
                            size: 6,
                            color: '#d4a76a',
                            speed: 2.5,
                            alpha: 1
                        });
                    }
                    
                    gameState.activityTracker.itemsGained++;
                }
            }
            
            // Add XP and check for level up
            console.log('Reward received:', reward);
            if (reward.xp && reward.skill) {
                console.log(`Calling addSkillXP(${reward.skill}, ${reward.xp})`);
                addSkillXP(reward.skill, reward.xp);
                
                // Track activity for stats display
                gameState.activityTracker.xpGained += reward.xp;
            } else {
                console.warn('No XP or skill in reward:', { xp: reward.xp, skill: reward.skill });
            }
            
            // Track items gained
            if (reward.item) {
                gameState.activityTracker.itemsGained++;
                gameState.activityTracker.lastItem = reward.item.name;
            }
            
            // Update activity tracker display
            updateActivityTracker();
            
            // Add success particles
            for (let i = 0; i < 10; i++) {
                gameState.particles.push({
                    x: gameState.player.x + (Math.random() - 0.5) * 40,
                    y: gameState.player.y + (Math.random() - 0.5) * 40,
                    size: 5,
                    color: '#FFD700',
                    speed: 2,
                    alpha: 1
                });
            }
            
            // Show floating text
            if (reward.gold > 0) {
                showFloatingText(`+${reward.gold} Gold`, gameState.player.x, gameState.player.y - 40, '#FFD700');
            }
            if (reward.xp) {
                showFloatingText(`+${reward.xp} XP`, gameState.player.x, gameState.player.y - 46, '#00BFFF');
            }
            if (reward.item) {
                if (reward.convertedFrom) {
                    // Show conversion message for smithwright
                    showFloatingText(`${reward.convertedFrom} â†’ ${reward.item.name}`, gameState.player.x, gameState.player.y - 52, '#FFA500');
                } else {
                    showFloatingText(`+1 - ${reward.item.name}`, gameState.player.x, gameState.player.y - 52, reward.item.rarityColor || '#5abaaa');
                }
            }
            
            // Check clue scroll progress
            checkClueScrollProgress(reward);
        }
        
        // ==================== CLUE SCROLL SYSTEM ====================
        
        // T1 Clue Scroll possible tasks
        const T1_CLUE_TASKS = [
            { task: 'cook_acorn', description: 'Cook an Acorn', checkFn: (reward) => reward.skill === 'cooking' && reward.item && reward.item.name && reward.item.name.includes('Roasted Acorn') },
            { task: 'mine_emerald', description: 'Mine an Emerald', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.name && reward.item.name.includes('Emerald') },
            { task: 'catch_uncommon_fish', description: 'Catch an Uncommon Fish', checkFn: (reward) => reward.skill === 'fishing' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Fish') },
            { task: 'mine_uncommon_ore', description: 'Mine an Uncommon Ore', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Ore') },
            { task: 'smith_uncommon_bar', description: 'Smith an Uncommon Bar', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Bar') },
            { task: 'make_uncommon_plank', description: 'Make an Uncommon Plank', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Plank') },
            { task: 'cut_uncommon_log', description: 'Cut an Uncommon Log', checkFn: (reward) => reward.skill === 'woodcutting' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Log') },
            { task: 'cook_uncommon_fish', description: 'Cook an Uncommon Fish', checkFn: (reward) => reward.skill === 'cooking' && reward.item && reward.item.name && reward.item.name.includes('Uncommon') && reward.item.name.includes('Cooked Fish') }
        ];
        
        // T2 Clue Scroll possible tasks
        const T2_CLUE_TASKS = [
            { task: 'cook_t2_acorn', description: 'Cook a T2 Acorn', checkFn: (reward) => reward.skill === 'cooking' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Roasted Acorn') },
            { task: 'mine_t2_ore', description: 'Mine a T2 Ore', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Ore') },
            { task: 'catch_t2_fish', description: 'Catch a T2 Fish', checkFn: (reward) => reward.skill === 'fishing' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Fish') },
            { task: 'cut_t2_log', description: 'Cut a T2 Log', checkFn: (reward) => reward.skill === 'woodcutting' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Log') },
            { task: 'smith_t2_bar', description: 'Smith a T2 Bar', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Bar') },
            { task: 'make_t2_plank', description: 'Make a T2 Plank', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 2 && reward.item.name && reward.item.name.includes('Plank') }
        ];
        
        // T3 Clue Scroll possible tasks
        const T3_CLUE_TASKS = [
            { task: 'cook_t3_acorn', description: 'Cook a T3 Acorn', checkFn: (reward) => reward.skill === 'cooking' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Roasted Acorn') },
            { task: 'mine_t3_ore', description: 'Mine a T3 Ore', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Ore') },
            { task: 'catch_t3_fish', description: 'Catch a T3 Fish', checkFn: (reward) => reward.skill === 'fishing' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Fish') },
            { task: 'cut_t3_log', description: 'Cut a T3 Log', checkFn: (reward) => reward.skill === 'woodcutting' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Log') },
            { task: 'smith_t3_bar', description: 'Smith a T3 Bar', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Bar') },
            { task: 'make_t3_plank', description: 'Make a T3 Plank', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 3 && reward.item.name && reward.item.name.includes('Plank') }
        ];
        
        // T4 Clue Scroll possible tasks
        const T4_CLUE_TASKS = [
            { task: 'cook_rare_item', description: 'Cook a Rare Item', checkFn: (reward) => reward.skill === 'cooking' && reward.item && reward.item.rarity === 'rare' },
            { task: 'mine_t4_ore', description: 'Mine a T4 Ore', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.tier === 4 && reward.item.name && reward.item.name.includes('Ore') },
            { task: 'catch_t4_fish', description: 'Catch a T4 Fish', checkFn: (reward) => reward.skill === 'fishing' && reward.item && reward.item.tier === 4 && reward.item.name && reward.item.name.includes('Fish') },
            { task: 'cut_t4_log', description: 'Cut a T4 Log', checkFn: (reward) => reward.skill === 'woodcutting' && reward.item && reward.item.tier === 4 && reward.item.name && reward.item.name.includes('Log') },
            { task: 'smith_t4_bar', description: 'Smith a T4 Bar', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 4 && reward.item.name && reward.item.name.includes('Bar') }
        ];
        
        // T5 Clue Scroll possible tasks
        const T5_CLUE_TASKS = [
            { task: 'mine_t5_ore', description: 'Mine a T5 Ore', checkFn: (reward) => reward.skill === 'mining' && reward.item && reward.item.tier === 5 && reward.item.name && reward.item.name.includes('Ore') },
            { task: 'catch_t5_fish', description: 'Catch a T5 Fish', checkFn: (reward) => reward.skill === 'fishing' && reward.item && reward.item.tier === 5 && reward.item.name && reward.item.name.includes('Fish') },
            { task: 'cut_t5_log', description: 'Cut a T5 Log', checkFn: (reward) => reward.skill === 'woodcutting' && reward.item && reward.item.tier === 5 && reward.item.name && reward.item.name.includes('Log') },
            { task: 'smith_t5_bar', description: 'Smith a T5 Bar', checkFn: (reward) => reward.skill === 'smithwright' && reward.item && reward.item.tier === 5 && reward.item.name && reward.item.name.includes('Bar') },
            { task: 'catch_legendary', description: 'Obtain a Legendary Item', checkFn: (reward) => reward.item && reward.item.rarity === 'legendary' }
        ];
        
        // Generate random clue scroll tasks for any tier
        function generateClueScrollTasks(tier, taskPool, numTasks = 2) {
            const availableTasks = [...taskPool];
            const selectedTasks = [];
            
            for (let i = 0; i < numTasks; i++) {
                if (availableTasks.length === 0) break;
                const randomIndex = Math.floor(Math.random() * availableTasks.length);
                selectedTasks.push({
                    ...availableTasks[randomIndex],
                    completed: false,
                    stepNumber: i + 1
                });
                availableTasks.splice(randomIndex, 1);
            }
            
            gameState.clueScrolls[tier] = {
                active: true,
                steps: selectedTasks
            };
            
            console.log(`${tier} Clue Scroll tasks generated:`, selectedTasks);
            updateClueScrollUI();
        }
        
        // Generate random T1 clue scroll tasks
        function generateT1ClueScrollTasks() {
            generateClueScrollTasks('T1', T1_CLUE_TASKS, 2);
        }
        
        // Generate T2-T5 clue scroll tasks
        function generateT2ClueScrollTasks() {
            generateClueScrollTasks('T2', T2_CLUE_TASKS, 2);
        }
        
        function generateT3ClueScrollTasks() {
            generateClueScrollTasks('T3', T3_CLUE_TASKS, 3);
        }
        
        function generateT4ClueScrollTasks() {
            generateClueScrollTasks('T4', T4_CLUE_TASKS, 4);
        }
        
        function generateT5ClueScrollTasks() {
            generateClueScrollTasks('T5', T5_CLUE_TASKS, 5);
        }
        
        // Generate random T1 clue scroll tasks (deprecated, uses common function now)
        function generateT1ClueScrollTasks_OLD() {
            // This function is deprecated - generateT1ClueScrollTasks() now uses generateClueScrollTasks()
        }
        
        // Update Clue Scroll UI Display
        function updateClueScrollUI() {
            // Update all tier panels
            ['T1', 'T2', 'T3', 'T4', 'T5'].forEach(tier => {
                const panel = document.getElementById(`clueScrollPanel_${tier}`);
                const tasksContainer = document.getElementById(`clueScrollTasks_${tier}`);
                const progressBar = document.getElementById(`clueProgressBar_${tier}`);
                const progressText = document.getElementById(`clueProgressText_${tier}`);
                
                // Check if this tier's clue scroll is active
                if (gameState.clueScrolls[tier] && gameState.clueScrolls[tier].active) {
                    const clue = gameState.clueScrolls[tier];
                    const totalTasks = clue.steps.length;
                    const completedTasks = clue.steps.filter(step => step.completed).length;
                    const progressPercent = (completedTasks / totalTasks) * 100;
                    
                    // Show the panel
                    panel.classList.add('active');
                    
                    // Clear existing tasks
                    tasksContainer.innerHTML = '';
                    
                    // Add tasks
                    clue.steps.forEach(step => {
                        const taskDiv = document.createElement('div');
                        taskDiv.className = 'clue-task' + (step.completed ? ' completed' : '');
                        
                        taskDiv.innerHTML = `
                            <div class="clue-task-checkbox">${step.completed ? 'âœ“' : ''}</div>
                            <div class="clue-task-text">
                                <div class="clue-task-number">Task ${step.stepNumber}</div>
                                <div class="clue-task-description">${step.description}</div>
                            </div>
                        `;
                        
                        tasksContainer.appendChild(taskDiv);
                    });
                    
                    // Update progress bar
                    progressBar.style.width = progressPercent + '%';
                    progressText.textContent = `${completedTasks}/${totalTasks} Complete`;
                    
                } else {
                    // Hide the panel if no active clue scroll
                    panel.classList.remove('active');
                }
            });
        }
        
        // Check if a clue scroll task is completed
        function checkClueScrollProgress(reward) {
            // Check all active clue scrolls
            ['T1', 'T2', 'T3', 'T4', 'T5'].forEach(tier => {
                if (gameState.clueScrolls[tier] && gameState.clueScrolls[tier].active) {
                    const clue = gameState.clueScrolls[tier];
                    let anyCompleted = false;
                    
                    clue.steps.forEach(step => {
                        // Safety check: ensure checkFn exists
                        if (!step.checkFn) {
                            console.warn(`Step missing checkFn for ${tier}:`, step);
                            return; // Skip this step
                        }
                        
                        if (!step.completed && step.checkFn(reward)) {
                            step.completed = true;
                            anyCompleted = true;
                            showFloatingText(`âœ“ ${tier} Clue Step ${step.stepNumber}: ${step.description}!`, gameState.player.x, gameState.player.y - 70, '#FFD700');
                            
                            // Gold particles for step completion
                            for (let i = 0; i < 20; i++) {
                                gameState.particles.push({
                                    x: gameState.player.x + (Math.random() - 0.5) * 80,
                                    y: gameState.player.y + (Math.random() - 0.5) * 80,
                                    size: 8,
                                    color: '#FFD700',
                                    speed: 3,
                                    alpha: 1
                                });
                            }
                        }
                    });
                    
                    // Update UI if any task was completed
                    if (anyCompleted) {
                        updateClueScrollUI();
                    }
                    
                    // Check if all steps are completed
                    if (anyCompleted && clue.steps.every(step => step.completed)) {
                        completeClueScroll(tier);
                    }
                }
            });
        }
        
        // Complete clue scroll and give rewards (works for any tier)
        function completeClueScroll(tier) {
            // Remove clue scroll from inventory
            const clueIndex = gameState.player.inventory.findIndex(item => 
                item && item.name === `${tier} Clue Scroll`
            );
            
            if (clueIndex !== -1) {
                gameState.player.inventory.splice(clueIndex, 1);
            }
            
            // Clear the clue scroll state
            gameState.clueScrolls[tier] = null;
            
            // Hide the clue scroll UI
            updateClueScrollUI();
            
            // Show completion message
            showFloatingText(`ðŸŽ‰ ${tier} CLUE SCROLL COMPLETE! ðŸŽ‰`, canvas.width / 2, 100, '#FFD700');
            
            // Massive particle explosion
            for (let i = 0; i < 50; i++) {
                gameState.particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 200,
                    y: 100 + (Math.random() - 0.5) * 100,
                    size: 10 + Math.random() * 5,
                    color: ['#FFD700', '#FFA500', '#FF6347'][Math.floor(Math.random() * 3)],
                    speed: 3 + Math.random() * 2,
                    alpha: 1
                });
            }
            
            // Give clue chest instead of immediate rewards
            const clueChest = {
                name: `${tier} Clue Chest`,
                icon: `cluechest_${tier}`,
                quantity: 1,
                tier: parseInt(tier.replace('T', '')),
                type: 'cluechest'
            };
            
            addToInventory(clueChest);
            showFloatingText(`Received ${tier} Clue Chest!`, canvas.width / 2, 180, '#FFD700');
            
            console.log(`${tier} Clue Scroll completed! Received Clue Chest.`);
            
            // Update inventory display
            initInventory();
            saveGame();
        }
        
        // Give rewards for completing a clue scroll
        
        // Open a clue chest with exciting animation
        function openClueChest(item, slotIndex) {
            if (!item || !item.type === 'cluechest') return;
            
            const tier = `T${item.tier}`; // Convert numeric tier to 'T1', 'T2', etc.
            
            // Get rewards BEFORE removing chest from inventory
            const rewards = getClueScrollRewards(tier);
            
            // Remove one chest from inventory
            const chestIndex = gameState.player.inventory.findIndex(inv => 
                inv && inv.name === item.name
            );
            
            if (chestIndex === -1) return;
            
            if (gameState.player.inventory[chestIndex].quantity > 1) {
                gameState.player.inventory[chestIndex].quantity--;
            } else {
                gameState.player.inventory.splice(chestIndex, 1);
            }
            
            // Update inventory display immediately
            initInventory();
            
            // Create MASSIVE particle explosion from center of screen
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // First wave - golden explosion
            for (let i = 0; i < 100; i++) {
                const angle = (Math.PI * 2 * i) / 100;
                const speed = 5 + Math.random() * 10;
                gameState.particles.push({
                    x: centerX,
                    y: centerY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: 8 + Math.random() * 8,
                    color: ['#FFD700', '#FFA500', '#FFED4E'][Math.floor(Math.random() * 3)],
                    speed: 0,
                    alpha: 1,
                    decay: 0.02
                });
            }
            
            // Second wave - colorful sparks
            setTimeout(() => {
                for (let i = 0; i < 150; i++) {
                    gameState.particles.push({
                        x: centerX + (Math.random() - 0.5) * 100,
                        y: centerY + (Math.random() - 0.5) * 100,
                        vx: (Math.random() - 0.5) * 15,
                        vy: (Math.random() - 0.5) * 15,
                        size: 5 + Math.random() * 5,
                        color: ['#FF6347', '#FF1493', '#00CED1', '#7FFF00', '#FFD700'][Math.floor(Math.random() * 5)],
                        speed: 0,
                        alpha: 1,
                        decay: 0.015
                    });
                }
            }, 100);
            
            // Third wave - glitter effect
            setTimeout(() => {
                for (let i = 0; i < 200; i++) {
                    gameState.particles.push({
                        x: centerX + (Math.random() - 0.5) * 300,
                        y: centerY + (Math.random() - 0.5) * 300,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8 - 2, // Slight upward bias
                        size: 2 + Math.random() * 4,
                        color: '#FFFFFF',
                        speed: 0,
                        alpha: 1,
                        decay: 0.025
                    });
                }
            }, 250);
            
            // Show reward modal after animation delay
            setTimeout(() => {
                showClueRewardModal(tier, rewards);
                saveGame();
            }, 600);
        }
        
        // Show the clue reward modal
        function showClueRewardModal(tier, rewards) {
            const modal = document.getElementById('clueRewardModal');
            const title = document.getElementById('clueRewardTitle');
            const itemsContainer = document.getElementById('clueRewardItems');
            
            // Store rewards for OK button
            modal.rewardData = { tier, rewards };
            
            // Set title
            title.textContent = `${tier} CLUE CHEST OPENED!`;
            
            // Clear previous items
            itemsContainer.innerHTML = '';
            
            // Add reward items to modal
            rewards.forEach(reward => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'clue-reward-item';
                
                // Get sprite for the item
                const sprite = gameState.sprites[reward.icon];
                const iconHTML = sprite ? 
                    `<img src="${sprite.src}" class="clue-reward-item-icon" />` :
                    `<div class="clue-reward-item-icon" style="background: #4a3a2a; border-radius: 8px;"></div>`;
                
                itemDiv.innerHTML = `
                    ${iconHTML}
                    <div class="clue-reward-item-name">${reward.name}</div>
                    <div class="clue-reward-item-quantity">x${reward.quantity.toLocaleString()}</div>
                `;
                
                itemsContainer.appendChild(itemDiv);
            });
            
            // Show modal
            modal.classList.add('active');
        }
        
        // Get rewards for a clue scroll tier (returns array, doesn't add to inventory yet)
        function getClueScrollRewards(tier) {
            let rewardPool = [];
            let numRewards = 2;
            
            // Define reward pools for each tier
            if (tier === 'T1') {
                rewardPool = [
                    { name: 'T1 Common Ore', quantity: 100, icon: 'ore_T1_Common', tier: 1, type: 'ore', rarity: 'Common' },
                    { name: 'T1 Common Log', quantity: 100, icon: 'log_T1_Common', tier: 1, type: 'log', rarity: 'Common' },
                    { name: 'T1 Emerald', quantity: 5, icon: 'emerald_T1', tier: 1, type: 'gem', rarity: 'epic' },
                    { name: 'T1 Acorn', quantity: 50, icon: 'acorn_T1', tier: 1, type: 'seed' },
                    { name: 'T1 Roasted Acorn', quantity: 50, icon: 'roastedacorn_T1', tier: 1, type: 'food' },
                    { name: 'T1 Common Plank', quantity: 50, icon: 'plank_T1_Common', tier: 1, type: 'plank', rarity: 'Common' },
                    { name: 'T1 Common Bar', quantity: 50, icon: 'bar_T1_Common', tier: 1, type: 'bar', rarity: 'Common' },
                    { name: 'T1 Common Fish', quantity: 100, icon: 'fish_T1_Common', tier: 1, type: 'fish', rarity: 'Common' },
                    { name: 'T1 Common Cooked Fish', quantity: 50, icon: 'cookedfish_T1_Common', tier: 1, type: 'food', rarity: 'Common' },
                    { name: 'Gold', quantity: Math.floor(100 + Math.random() * 101), icon: 'gold', type: 'currency' }
                ];
            } else if (tier === 'T2') {
                rewardPool = [
                    { name: 'T2 Uncommon Ore', quantity: 75, icon: 'ore_T2_Uncommon', tier: 2, type: 'ore', rarity: 'Uncommon' },
                    { name: 'T2 Uncommon Log', quantity: 75, icon: 'log_T2_Uncommon', tier: 2, type: 'log', rarity: 'Uncommon' },
                    { name: 'T2 Uncommon Fish', quantity: 75, icon: 'fish_T2_Uncommon', tier: 2, type: 'fish', rarity: 'Uncommon' },
                    { name: 'T2 Uncommon Bar', quantity: 40, icon: 'bar_T2_Uncommon', tier: 2, type: 'bar', rarity: 'Uncommon' },
                    { name: 'T2 Uncommon Plank', quantity: 40, icon: 'plank_T2_Uncommon', tier: 2, type: 'plank', rarity: 'Uncommon' },
                    { name: 'Gold', quantity: Math.floor(200 + Math.random() * 201), icon: 'gold', type: 'currency' }
                ];
            } else if (tier === 'T3') {
                rewardPool = [
                    { name: 'T3 Rare Ore', quantity: 50, icon: 'ore_T3_Rare', tier: 3, type: 'ore', rarity: 'Rare' },
                    { name: 'T3 Rare Log', quantity: 50, icon: 'log_T3_Rare', tier: 3, type: 'log', rarity: 'Rare' },
                    { name: 'T3 Rare Fish', quantity: 50, icon: 'fish_T3_Rare', tier: 3, type: 'fish', rarity: 'Rare' },
                    { name: 'T3 Rare Bar', quantity: 30, icon: 'bar_T3_Rare', tier: 3, type: 'bar', rarity: 'Rare' },
                    { name: 'T3 Rare Plank', quantity: 30, icon: 'plank_T3_Rare', tier: 3, type: 'plank', rarity: 'Rare' },
                    { name: 'Gold', quantity: Math.floor(400 + Math.random() * 301), icon: 'gold', type: 'currency' }
                ];
            } else if (tier === 'T4') {
                rewardPool = [
                    { name: 'T4 Epic Ore', quantity: 30, icon: 'ore_T4_Epic', tier: 4, type: 'ore', rarity: 'Epic' },
                    { name: 'T4 Epic Log', quantity: 30, icon: 'log_T4_Epic', tier: 4, type: 'log', rarity: 'Epic' },
                    { name: 'T4 Epic Fish', quantity: 30, icon: 'fish_T4_Epic', tier: 4, type: 'fish', rarity: 'Epic' },
                    { name: 'T4 Epic Bar', quantity: 20, icon: 'bar_T4_Epic', tier: 4, type: 'bar', rarity: 'Epic' },
                    { name: 'T4 Epic Plank', quantity: 20, icon: 'plank_T4_Epic', tier: 4, type: 'plank', rarity: 'Epic' },
                    { name: 'Gold', quantity: Math.floor(700 + Math.random() * 501), icon: 'gold', type: 'currency' }
                ];
            } else if (tier === 'T5') {
                rewardPool = [
                    { name: 'T5 Perfect Ore', quantity: 20, icon: 'ore_T5_Perfect', tier: 5, type: 'ore', rarity: 'Perfect' },
                    { name: 'T5 Perfect Log', quantity: 20, icon: 'log_T5_Perfect', tier: 5, type: 'log', rarity: 'Perfect' },
                    { name: 'T5 Perfect Fish', quantity: 20, icon: 'fish_T5_Perfect', tier: 5, type: 'fish', rarity: 'Perfect' },
                    { name: 'T5 Perfect Bar', quantity: 15, icon: 'bar_T5_Perfect', tier: 5, type: 'bar', rarity: 'Perfect' },
                    { name: 'T5 Perfect Plank', quantity: 15, icon: 'plank_T5_Perfect', tier: 5, type: 'plank', rarity: 'Perfect' },
                    { name: 'Gold', quantity: Math.floor(1000 + Math.random() * 1001), icon: 'gold', type: 'currency' }
                ];
            }
            
            // Select random rewards
            const availableRewards = [...rewardPool];
            const selectedRewards = [];
            
            for (let i = 0; i < numRewards && availableRewards.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * availableRewards.length);
                selectedRewards.push(availableRewards[randomIndex]);
                availableRewards.splice(randomIndex, 1);
            }
            
            return selectedRewards;
        }
        
        // Complete T1 clue scroll and give rewards (deprecated - uses completeClueScroll now)
        function completeT1ClueScroll() {
            completeClueScroll('T1');
        }
        
        // Give rewards to player (actually adds to inventory)
        function giveClueScrollRewards(tier, rewards) {
            rewards.forEach((reward, index) => {
                if (reward.type === 'currency') {
                    gameState.player.gold += reward.quantity;
                } else {
                    // Get rarity color
                    let rarityColor = '#ffffff';
                    if (reward.rarity) {
                        const rarityData = getRarityData(reward.rarity.toLowerCase());
                        rarityColor = rarityData.color;
                    }
                    
                    // Get sprite if available
                    let customSprite = null;
                    if (gameState.sprites[reward.icon]) {
                        customSprite = gameState.sprites[reward.icon];
                    }
                    
                    // Check if item already exists in inventory (for stacking)
                    const existingItemIndex = gameState.player.inventory.findIndex(invItem => 
                        invItem && invItem.name === reward.name
                    );
                    
                    if (existingItemIndex !== -1) {
                        // Add to existing stack
                        gameState.player.inventory[existingItemIndex].quantity += reward.quantity;
                    } else {
                        // Create new item with all necessary properties
                        const rewardItem = {
                            name: reward.name,
                            icon: reward.icon,
                            quantity: reward.quantity,
                            tier: reward.tier,
                            type: reward.type,
                            stackable: true,
                            rarityColor: rarityColor
                        };
                        
                        if (reward.rarity) {
                            rewardItem.rarity = reward.rarity;
                        }
                        
                        if (customSprite) {
                            rewardItem.customSprite = customSprite;
                        }
                        
                        gameState.player.inventory.push(rewardItem);
                    }
                }
            });
            
            console.log(`${tier} Clue Chest rewards given:`, rewards);
            initInventory();
            saveGame();
        }
        
        // Setup OK button for clue reward modal
        document.getElementById('clueRewardOkBtn').addEventListener('click', () => {
            const modal = document.getElementById('clueRewardModal');
            const itemsContainer = document.getElementById('clueRewardItems');
            
            // Get the rewards from the modal (we need to store them)
            if (modal.rewardData) {
                giveClueScrollRewards(modal.rewardData.tier, modal.rewardData.rewards);
                modal.rewardData = null;
            }
            
            // Hide modal
            modal.classList.remove('active');
        });
        
        // ==================== END CLUE SCROLL SYSTEM ====================
        
        // Update Activity Tracker Display (OSRS-style)
        function updateActivityTracker() {
            const tracker = gameState.activityTracker;
            const elapsedSeconds = (Date.now() - tracker.startTime) / 1000;
            const elapsedHours = elapsedSeconds / 3600;
            
            // Calculate per-hour rates
            const itemsPerHour = elapsedHours > 0 ? Math.floor(tracker.itemsGained / elapsedHours) : 0;
            const xpPerHour = elapsedHours > 0 ? Math.floor(tracker.xpGained / elapsedHours) : 0;
            
            // Update display
            document.getElementById('itemsPerHour').textContent = itemsPerHour.toLocaleString();
            document.getElementById('xpPerHour').textContent = xpPerHour.toLocaleString();
            
            // Update session items
            document.getElementById('sessionItems').textContent = tracker.itemsGained.toLocaleString();
            
            // Update total skill XP
            let currentSkill = gameState.currentRoom;
            
            // For combat, use the primary skill being trained based on attack style
            if (currentSkill === 'combat' && gameState.combat.combatStyle && gameState.combat.attackStyle) {
                const combatStyle = gameState.combat.combatStyle;
                const attackStyle = gameState.combat.attackStyle;
                
                if (combatStyle === 'melee') {
                    if (attackStyle === 'accurate') {
                        currentSkill = 'attack';
                    } else if (attackStyle === 'aggressive') {
                        currentSkill = 'strength';
                    } else if (attackStyle === 'controlled') {
                        currentSkill = 'attack'; // Show attack as primary for controlled
                    }
                } else if (combatStyle === 'ranged') {
                    currentSkill = 'ranged';
                } else if (combatStyle === 'magic') {
                    currentSkill = 'magic';
                }
            }
            
            const totalXP = gameState.player.skillXP[currentSkill] || 0;
            document.getElementById('totalSkillXP').textContent = totalXP.toLocaleString();
            
            // Calculate and display level progress
            const currentLevel = gameState.player.skills[currentSkill] || 1;
            const xpForCurrentLevel = getXPForLevel(currentLevel);
            const xpForNextLevel = getXPForLevel(currentLevel + 1);
            const xpInCurrentLevel = totalXP - xpForCurrentLevel;
            const xpNeededForNextLevel = xpForNextLevel - xpForCurrentLevel;
            const progressPercent = Math.min(100, Math.floor((xpInCurrentLevel / xpNeededForNextLevel) * 100));
            const xpRemaining = xpForNextLevel - totalXP;
            
            // Update level progress elements
            document.getElementById('currentLevel').textContent = `Lvl ${currentLevel}`;
            document.getElementById('nextLevel').textContent = `Lvl ${currentLevel + 1}`;
            document.getElementById('levelProgress').textContent = `${progressPercent}%`;
            document.getElementById('levelProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('xpToNextLevel').textContent = `${xpRemaining.toLocaleString()} XP to level`;
            
            // Update activity name
            const activityNames = {
                'woodcutting': 'Woodcutting',
                'mining': 'Mining',
                'fishing': 'Fishing',
                'plundering': 'Plundering',
                'agility': 'Agility',
                'cooking': 'Cooking',
                'combat': 'Combat',
                'crafting': 'Crafting',
                'smithwright': 'Smithwright',
                'raids': 'Raiding'
            };
            
            let activityName = activityNames[gameState.currentRoom] || gameState.currentRoom;
            
            // For combat, show specific skill being trained based on attack style
            if (gameState.currentRoom === 'combat' && gameState.combat.combatStyle && gameState.combat.attackStyle) {
                const combatStyle = gameState.combat.combatStyle;
                const attackStyle = gameState.combat.attackStyle;
                
                if (combatStyle === 'melee') {
                    if (attackStyle === 'accurate') {
                        activityName = 'Attack';
                    } else if (attackStyle === 'aggressive') {
                        activityName = 'Strength';
                    } else if (attackStyle === 'controlled') {
                        activityName = 'Attack/Str/Def';
                    }
                } else if (combatStyle === 'ranged') {
                    if (attackStyle === 'rapid') {
                        activityName = 'Ranged';
                    } else if (attackStyle === 'longrange') {
                        activityName = 'Ranged/Defence';
                    }
                } else if (combatStyle === 'magic') {
                    if (attackStyle === 'accurate') {
                        activityName = 'Magic';
                    } else if (attackStyle === 'longrange') {
                        activityName = 'Magic/Defence';
                    }
                }
            }
            
            document.getElementById('activityName').textContent = activityName;
        }
        
        // Reset activity tracker when changing rooms
        function resetActivityTracker() {
            gameState.activityTracker = {
                startTime: Date.now(),
                itemsGained: 0,
                xpGained: 0,
                currentActivity: gameState.currentRoom,
                lastItem: null
            };
            updateActivityTracker();
        }
        
        // Calculate XP required for a level (uses exponential formula like OSRS)
        function getXPForLevel(level) {
            let total = 0;
            for (let i = 1; i < level; i++) {
                total += Math.floor(i + 300 * Math.pow(2, i / 7));
            }
            return Math.floor(total / 4);
        }
        
        // Add XP to a skill and check for level ups
        function addSkillXP(skill, xp) {
            // Ensure skillXP object exists
            if (!gameState.player.skillXP) {
                console.warn('skillXP object not initialized, creating it now');
                gameState.player.skillXP = {
                    hitpoints: 0, attack: 0, mining: 0, strength: 0, agility: 0,
                    defence: 0, fishing: 0, ranged: 0, cooking: 0, crafting: 0,
                    magic: 0, woodcutting: 0, plundering: 0, smithwright: 0
                };
            }
            
            if (!gameState.player.skillXP[skill]) {
                gameState.player.skillXP[skill] = 0;
            }
            
            gameState.player.skillXP[skill] += xp;
            console.log(`Added ${xp} XP to ${skill}. Total XP: ${gameState.player.skillXP[skill]}`);
            
            // Update skills display to show new XP
            updateSkillsDisplay();
            
            // Check for level up
            const currentLevel = gameState.player.skills[skill] || 1;
            const xpForNextLevel = getXPForLevel(currentLevel + 1);
            
            console.log(`${skill} - Level: ${currentLevel}, XP: ${gameState.player.skillXP[skill]}/${xpForNextLevel}`);
            
            if (gameState.player.skillXP[skill] >= xpForNextLevel) {
                gameState.player.skills[skill]++;
                console.log(`LEVEL UP! ${skill} is now level ${gameState.player.skills[skill]}`);
                updateSkillsDisplay();
                showFloatingText(`Level Up! ${skill} ${gameState.player.skills[skill]}`, 
                                gameState.player.x, gameState.player.y - 80, '#FFD700');
                
                // Extra particles for level up
                for (let i = 0; i < 30; i++) {
                    gameState.particles.push({
                        x: gameState.player.x + (Math.random() - 0.5) * 80,
                        y: gameState.player.y + (Math.random() - 0.5) * 80,
                        size: 8,
                        color: '#FFD700',
                        speed: 3,
                        alpha: 1
                    });
                }
            }
        }

        function cleanupInventory() {
            // Remove null entries from inventory
            gameState.player.inventory = gameState.player.inventory.filter(item => item !== null && item !== undefined);
        }

        function addToInventory(item) {
            // Clean up any null entries first
            cleanupInventory();
            
            // Check if item is stackable and already exists
            if (item.stackable) {
                // For stackable items, we only need to compare the name since it includes tier and rarity
                const existingItem = gameState.player.inventory.find(invItem => 
                    invItem && invItem.name === item.name
                );
                
                if (existingItem) {
                    // Increment quantity of existing stack
                    existingItem.quantity = (existingItem.quantity || 1) + 1;
                } else if (gameState.player.inventory.length < gameState.player.inventorySize) {
                    // Add new stack
                    gameState.player.inventory.push({
                        ...item,
                        quantity: 1
                    });
                }
            } else {
                // Non-stackable items
                if (gameState.player.inventory.length < gameState.player.inventorySize) {
                    gameState.player.inventory.push({
                        ...item,
                        quantity: 1
                    });
                }
            }
            
            updateInventoryDisplay();
        }

        function updateSkillsDisplay() {
            // Ensure skillXP exists
            if (!gameState.player.skillXP) {
                gameState.player.skillXP = {
                    hitpoints: 0, attack: 0, mining: 0, strength: 0, agility: 0,
                    defence: 0, fishing: 0, ranged: 0, cooking: 0, crafting: 0,
                    carpentry: 0, magic: 0, woodcutting: 0, plundering: 0, smithwright: 0
                };
            }
            
            // Update skill levels in the sidebar
            const skillNames = ['hitpoints', 'attack', 'mining', 'strength', 'agility', 
                               'defence', 'fishing', 'ranged', 'cooking', 
                               'crafting', 'carpentry', 'magic', 'woodcutting',
                               'plundering', 'smithwright'];
            
            const skillItems = document.querySelectorAll('.skill-item');
            let totalLevel = 0;
            
            skillItems.forEach((item, index) => {
                if (skillNames[index]) {
                    const skillName = skillNames[index];
                    const level = gameState.player.skills[skillName] || 1;
                    const currentXP = gameState.player.skillXP[skillName] || 0;
                    const xpForThisLevel = getXPForLevel(level);
                    const xpForNextLevel = getXPForLevel(level + 1);
                    const xpNeeded = xpForNextLevel - currentXP;
                    const xpProgress = currentXP - xpForThisLevel;
                    const xpToLevel = xpForNextLevel - xpForThisLevel;
                    const percentToLevel = Math.max(0, Math.min(100, Math.floor((xpProgress / xpToLevel) * 100)));
                    
                    const levelSpan = item.querySelector('.skill-level');
                    if (levelSpan) {
                        levelSpan.textContent = level;
                        totalLevel += level;
                        
                        // Add tier info for gathering skills
                        if (['mining', 'fishing', 'woodcutting', 'plundering', 'agility', 'carpentry'].includes(skillName)) {
                            let tierInfo = 'T1';
                            if (level >= 80) tierInfo = 'T5';
                            else if (level >= 60) tierInfo = 'T4';
                            else if (level >= 40) tierInfo = 'T3';
                            else if (level >= 20) tierInfo = 'T2';
                            
                            // Show next tier requirement
                            let nextTier = '';
                            if (level < 20) nextTier = `\nT2 unlocks at level 20`;
                            else if (level < 40) nextTier = `\nT3 unlocks at level 40`;
                            else if (level < 60) nextTier = `\nT4 unlocks at level 60`;
                            else if (level < 80) nextTier = `\nT5 unlocks at level 80`;
                            
                            item.title = `${skillName.charAt(0).toUpperCase() + skillName.slice(1)}\nLevel: ${level} (${tierInfo})\nXP: ${currentXP.toLocaleString()} / ${xpForNextLevel.toLocaleString()}\n${xpNeeded.toLocaleString()} XP to next level (${percentToLevel}%)${nextTier}`;
                        } else {
                            item.title = `${skillName.charAt(0).toUpperCase() + skillName.slice(1)}\nLevel: ${level}\nXP: ${currentXP.toLocaleString()} / ${xpForNextLevel.toLocaleString()}\n${xpNeeded.toLocaleString()} XP to next level (${percentToLevel}%)`;
                        }
                    }
                }
            });
            
            document.getElementById('totalLevel').textContent = totalLevel;
        }

        function updateCharacterStats() {
            // Calculate total level
            const totalLevel = Object.values(gameState.player.skills).reduce((sum, level) => sum + level, 0);
            document.getElementById('charLevel').textContent = totalLevel;
            
            // Update offense stats
            const attack = gameState.player.skills.attack || 1;
            const strength = gameState.player.skills.strength || 1;
            const ranged = gameState.player.skills.ranged || 1;
            const magic = gameState.player.skills.magic || 1;
            
            // Calculate damage based on weapon if equipped
            let damage = strength;
            if (gameState.player.equipment.weapon) {
                damage += (gameState.player.equipment.weapon.damage || 0);
            }
            
            document.getElementById('charOffense').innerHTML = `
                <div>Damage: <span style="float: right; color: #fff;">${damage}</span></div>
                <div>Attack: <span style="float: right; color: #fff;">${attack}</span></div>
                <div>Strength: <span style="float: right; color: #fff;">${strength}</span></div>
                <div>Ranged: <span style="float: right; color: #fff;">${ranged}</span></div>
                <div>Magic: <span style="float: right; color: #fff;">${magic}</span></div>
            `;
            
            // Update defense stats
            const defence = gameState.player.skills.defence || 1;
            let armor = 0;
            
            // Calculate total armor from equipped items
            Object.values(gameState.player.equipment).forEach(item => {
                if (item && item.defence) {
                    armor += item.defence;
                }
            });
            
            document.getElementById('charDefense').innerHTML = `
                <div>Defense: <span style="float: right; color: #fff;">${defence}</span></div>
                <div>Armor: <span style="float: right; color: #fff;">${armor}</span></div>
            `;
            
            // Update life stats
            const hitpoints = gameState.player.skills.hitpoints || 10;
            document.getElementById('charLife').innerHTML = `
                <div>Hitpoints: <span style="float: right; color: #fff;">${hitpoints}</span></div>
            `;
            
            // Update gold
            document.getElementById('charGold').textContent = gameState.player.gold.toLocaleString();
            
            // Update equipment slots to show equipped items
            const equipmentSlots = ['head', 'cape', 'amulet', 'arrows', 'weapon', 'chest', 'shield', 'legs', 'gloves', 'boots', 'ring'];
            equipmentSlots.forEach(slot => {
                const slotElement = document.getElementById(`charSlot${slot.charAt(0).toUpperCase() + slot.slice(1)}`);
                if (slotElement) {
                    const equippedItem = gameState.player.equipment[slot];
                    if (equippedItem && equippedItem.name) {
                        // Show item is equipped with a highlight
                        slotElement.style.borderColor = '#FFD700';
                        slotElement.style.background = '#3a2a1a';
                        slotElement.title = equippedItem.name;
                    } else {
                        // Empty slot
                        slotElement.style.borderColor = '#5a4a3a';
                        slotElement.style.background = '#2a1a0a';
                        slotElement.title = `${slot.toUpperCase()} (empty)`;
                    }
                }
            });
        }

        function showFloatingText(text, x, y, color) {
            if (!gameState.floatingTexts) gameState.floatingTexts = [];
            
            // Check for recently created floating texts at similar positions
            // and offset this one to prevent overlapping
            let yOffset = -10; // Base offset
            const recentTexts = gameState.floatingTexts.filter(t => {
                // Check if text is at similar x position (within 50 pixels)
                // and was created recently (alpha still high)
                return Math.abs(t.x - x) < 50 && t.alpha > 0.9;
            });
            
            // Stack new texts above existing ones
            if (recentTexts.length > 0) {
                // Each additional text gets stacked 25 pixels higher
                yOffset -= recentTexts.length * 25;
            }
            
            const floatingText = {
                text,
                x,
                y: y + yOffset,
                color,
                alpha: 1,
                speed: 0.8 // Slower upward movement
            };
            
            gameState.floatingTexts.push(floatingText);
        }

        function drawActionProgress() {
            if (!gameState.player.isPerformingAction) return;
            
            const barWidth = 60;
            const barHeight = 8;
            const x = gameState.player.x - barWidth / 2;
            const y = gameState.player.y - gameState.player.size * 2.5;
            
            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Progress
            ctx.fillStyle = '#5abaaa';
            ctx.fillRect(x, y, barWidth * gameState.player.actionProgress, barHeight);
            
            // Border
            ctx.strokeStyle = '#2a4a5a';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, barWidth, barHeight);
        }

        function drawFloatingTexts() {
            if (!gameState.floatingTexts) return;
            
            gameState.floatingTexts.forEach((text, index) => {
                // Add shadow for better readability
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                ctx.fillStyle = text.color;
                ctx.globalAlpha = text.alpha;
                ctx.font = 'bold 18px Arial'; // Larger font
                ctx.textAlign = 'center';
                ctx.fillText(text.text, text.x, text.y);
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                ctx.globalAlpha = 1;
                
                // Update - much slower movement and fade
                text.y -= text.speed * 0.4; // Slower upward drift
                text.alpha -= 0.0008; // Even slower fade - XP drops last much longer (was 0.0013)
            });
            
            // Clean up dead texts (filter instead of splice to avoid iteration issues)
            gameState.floatingTexts = gameState.floatingTexts.filter(t => t.alpha > 0);
            
            // Prevent memory leak - cap floating texts at 100
            if (gameState.floatingTexts.length > 100) {
                gameState.floatingTexts = gameState.floatingTexts.slice(-100);
            }
        }

        function checkInteraction() {
            // Only for combat room (manual interaction)
            if (gameState.currentRoom !== 'combat') return;
            
            const room = rooms[gameState.currentRoom];
            if (!room.objects) return;
            
            room.objects.forEach(obj => {
                const distance = Math.sqrt(
                    Math.pow(gameState.player.x - obj.x, 2) + 
                    Math.pow(gameState.player.y - obj.y, 2)
                );
                
                if (distance < 80) {
                    // Combat action
                    gameState.player.gold += 35;
                    document.getElementById('goldAmount').textContent = gameState.player.gold.toLocaleString();
                    document.getElementById('invGold').textContent = gameState.player.gold.toLocaleString();
                    
                    // Combat particles
                    for (let i = 0; i < 15; i++) {
                        gameState.particles.push({
                            x: obj.x + (Math.random() - 0.5) * 40,
                            y: obj.y + (Math.random() - 0.5) * 40,
                            size: 5,
                            color: '#FF4500',
                            speed: 3,
                            alpha: 1
                        });
                    }
                    
                    showFloatingText('Hit!', obj.x, obj.y - 40, '#FF4500');
                    showFloatingText('+35 Gold', gameState.player.x, gameState.player.y - 40, '#FFD700');
                }
            });
        }

        // Initialize inventory
        function initInventory() {
            updateInventoryDisplay();
        }

        function updateInventoryDisplay() {
            // Clean up any null entries first
            cleanupInventory();
            
            const grid = document.getElementById('inventoryGrid');
            const scrollContainer = grid.parentElement;
            const scrollPosition = scrollContainer.scrollTop;
            
            grid.innerHTML = '';
            
            // Create all 98 slots
            for (let i = 0; i < 98; i++) {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                slot.dataset.index = i;
                
                if (i < gameState.player.inventory.length) {
                    const item = gameState.player.inventory[i];
                    if (item) {
                        slot.classList.add('occupied');
                        slot.style.position = 'relative';
                        
                        // Add rarity border
                        if (item.rarityColor) {
                            slot.style.borderColor = item.rarityColor;
                            slot.style.boxShadow = `0 0 5px ${item.rarityColor}40`;
                        }
                        
                        // Create container for item display - fill entire slot
                        const itemDisplay = document.createElement('div');
                        itemDisplay.style.position = 'absolute';
                        itemDisplay.style.top = '4px';  // Small padding
                        itemDisplay.style.left = '4px';
                        itemDisplay.style.right = '4px';
                        itemDisplay.style.bottom = '4px';
                        
                        // Use sprite image if available
                        // Check for: customSprite, spriteKey (for tools), gameState.sprites, or spriteUrls
                        const spriteSource = item.customSprite || 
                                           (item.spriteKey && (gameState.sprites[item.spriteKey] || spriteUrls[item.spriteKey])) ||
                                           gameState.sprites[item.icon] || 
                                           spriteUrls[item.icon];
                        
                        if (spriteSource) {
                            const img = document.createElement('img');
                            // Prioritize customSprite, then spriteKey, then gameState.sprites, then spriteUrls
                            if (item.customSprite) {
                                img.src = item.customSprite.src;
                            } else if (item.spriteKey && gameState.sprites[item.spriteKey]) {
                                img.src = gameState.sprites[item.spriteKey].src;
                            } else if (item.spriteKey && spriteUrls[item.spriteKey]) {
                                img.src = spriteUrls[item.spriteKey];
                            } else if (gameState.sprites[item.icon]) {
                                img.src = gameState.sprites[item.icon].src;
                            } else if (spriteUrls[item.icon]) {
                                // Fallback to spriteUrls for food items (Cooked Fish, Roasted Acorns)
                                img.src = spriteUrls[item.icon];
                            }
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'contain';
                            img.style.imageRendering = 'pixelated';
                            img.style.imageRendering = '-moz-crisp-edges';
                            img.style.imageRendering = 'crisp-edges';
                            itemDisplay.appendChild(img);
                            
                            // Add tier and rarity indicator for resources
                            if (item.tier) {
                                const tierBadge = document.createElement('div');
                                tierBadge.style.position = 'absolute';
                                tierBadge.style.top = '2px';
                                tierBadge.style.left = '2px';
                                tierBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                tierBadge.style.color = item.rarityColor || ['#8a8a8a', '#5abaaa', '#5a8afa', '#aa5afa', '#FFD700'][item.tier - 1];
                                tierBadge.style.fontSize = '10px';
                                tierBadge.style.fontWeight = 'bold';
                                tierBadge.style.padding = '2px 4px';
                                tierBadge.style.borderRadius = '3px';
                                tierBadge.style.border = `1px solid ${item.rarityColor || '#8a8a8a'}`;
                                tierBadge.textContent = `T${item.tier}`;
                                itemDisplay.appendChild(tierBadge);
                                
                                // Add rarity indicator if not common
                                if (item.rarity && item.rarity !== 'common') {
                                    const rarityBadge = document.createElement('div');
                                    rarityBadge.style.position = 'absolute';
                                    rarityBadge.style.top = '2px';
                                    rarityBadge.style.right = '2px';
                                    rarityBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                    rarityBadge.style.color = item.rarityColor;
                                    rarityBadge.style.fontSize = '8px';
                                    rarityBadge.style.fontWeight = 'bold';
                                    rarityBadge.style.padding = '1px 3px';
                                    rarityBadge.style.borderRadius = '3px';
                                    rarityBadge.style.border = `1px solid ${item.rarityColor}`;
                                    rarityBadge.textContent = item.rarity.charAt(0).toUpperCase();
                                    itemDisplay.appendChild(rarityBadge);
                                }
                            }
                        } else if (item.icon === 'ore') {
                            // Fallback canvas drawing for ore if sprite not loaded
                            const canvas = document.createElement('canvas');
                            const slotSize = slot.offsetWidth || 50;
                            canvas.width = slotSize - 8;
                            canvas.height = slotSize - 8;
                            const ctx = canvas.getContext('2d');
                            ctx.imageSmoothingEnabled = false;
                            
                            // Draw ore
                            ctx.fillStyle = '#696969';
                            ctx.fillRect(canvas.width * 0.2, canvas.height * 0.3, canvas.width * 0.6, canvas.height * 0.4);
                            ctx.fillStyle = '#C0C0C0';
                            ctx.fillRect(canvas.width * 0.3, canvas.height * 0.35, canvas.width * 0.4, canvas.height * 0.3);
                            
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            itemDisplay.appendChild(canvas);
                        } else if (item.icon === 'fish') {
                            // Fallback for fish - use emoji
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 42px; text-align: center; line-height: 1.2;">ðŸŸ</div>`;
                        } else if (item.icon && item.icon.startsWith && item.icon.startsWith('cookedfish')) {
                            // Fallback for cooked fish - use cooked meat emoji
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 42px; text-align: center; line-height: 1.2;">ðŸ–</div>`;
                            
                            // Add tier and rarity badges
                            if (item.tier) {
                                const tierBadge = document.createElement('div');
                                tierBadge.style.position = 'absolute';
                                tierBadge.style.top = '2px';
                                tierBadge.style.left = '2px';
                                tierBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                tierBadge.style.color = item.rarityColor || ['#8a8a8a', '#5abaaa', '#5a8afa', '#aa5afa', '#FFD700'][item.tier - 1];
                                tierBadge.style.fontSize = '10px';
                                tierBadge.style.fontWeight = 'bold';
                                tierBadge.style.padding = '2px 4px';
                                tierBadge.style.borderRadius = '3px';
                                tierBadge.style.border = `1px solid ${item.rarityColor || '#8a8a8a'}`;
                                tierBadge.textContent = `T${item.tier}`;
                                itemDisplay.appendChild(tierBadge);
                                
                                if (item.rarity && item.rarity !== 'common') {
                                    const rarityBadge = document.createElement('div');
                                    rarityBadge.style.position = 'absolute';
                                    rarityBadge.style.top = '2px';
                                    rarityBadge.style.right = '2px';
                                    rarityBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                    rarityBadge.style.color = item.rarityColor;
                                    rarityBadge.style.fontSize = '8px';
                                    rarityBadge.style.fontWeight = 'bold';
                                    rarityBadge.style.padding = '1px 3px';
                                    rarityBadge.style.borderRadius = '3px';
                                    rarityBadge.style.border = `1px solid ${item.rarityColor}`;
                                    rarityBadge.textContent = item.rarity.charAt(0).toUpperCase();
                                    itemDisplay.appendChild(rarityBadge);
                                }
                            }
                        } else if (item.icon === 'log') {
                            // Fallback canvas drawing if image not loaded - fill slot
                            const canvas = document.createElement('canvas');
                            const slotSize = slot.offsetWidth || 50;  // Get actual slot size
                            canvas.width = slotSize - 8;  // Account for padding
                            canvas.height = slotSize - 8;
                            const ctx = canvas.getContext('2d');
                            ctx.imageSmoothingEnabled = false;
                            
                            // Draw log to fill canvas
                            const logHeight = canvas.height * 0.5;
                            const logY = (canvas.height - logHeight) / 2;
                            
                            ctx.fillStyle = '#8B4513';
                            ctx.fillRect(4, logY, canvas.width - 8, logHeight);
                            ctx.fillStyle = '#654321';
                            ctx.fillRect(4, logY, canvas.width - 8, logHeight * 0.25);
                            ctx.fillStyle = '#A0522D';
                            ctx.fillRect(6, logY + logHeight * 0.3, canvas.width - 12, logHeight * 0.4);
                            
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            itemDisplay.appendChild(canvas);
                        } else if (item.type === 'magebook') {
                            // Fallback for magebooks - use book emoji
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 48px; text-align: center; line-height: 1.2;">ðŸ“–</div>`;
                            
                            // Add tier badge
                            if (item.tier) {
                                const tierBadge = document.createElement('div');
                                tierBadge.style.position = 'absolute';
                                tierBadge.style.top = '2px';
                                tierBadge.style.left = '2px';
                                tierBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                tierBadge.style.color = item.rarityColor || ['#8a8a8a', '#5abaaa', '#5a8afa', '#aa5afa', '#FFD700'][item.tier - 1];
                                tierBadge.style.fontSize = '10px';
                                tierBadge.style.fontWeight = 'bold';
                                tierBadge.style.padding = '2px 4px';
                                tierBadge.style.borderRadius = '3px';
                                tierBadge.style.border = `1px solid ${item.rarityColor || '#8a8a8a'}`;
                                tierBadge.textContent = `T${item.tier}`;
                                itemDisplay.appendChild(tierBadge);
                                
                                // Add rarity indicator if not common
                                if (item.rarity && item.rarity !== 'common') {
                                    const rarityBadge = document.createElement('div');
                                    rarityBadge.style.position = 'absolute';
                                    rarityBadge.style.top = '2px';
                                    rarityBadge.style.right = '2px';
                                    rarityBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                    rarityBadge.style.color = item.rarityColor;
                                    rarityBadge.style.fontSize = '8px';
                                    rarityBadge.style.fontWeight = 'bold';
                                    rarityBadge.style.padding = '1px 3px';
                                    rarityBadge.style.borderRadius = '3px';
                                    rarityBadge.style.border = `1px solid ${item.rarityColor}`;
                                    rarityBadge.textContent = item.rarity.charAt(0).toUpperCase();
                                    itemDisplay.appendChild(rarityBadge);
                                }
                            }
                        } else if (item.type === 'pages') {
                            // Fallback for pages - use page emoji
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 48px; text-align: center; line-height: 1.2;">ðŸ“„</div>`;
                            
                            // Add tier badge
                            if (item.tier) {
                                const tierBadge = document.createElement('div');
                                tierBadge.style.position = 'absolute';
                                tierBadge.style.top = '2px';
                                tierBadge.style.left = '2px';
                                tierBadge.style.background = 'rgba(0, 0, 0, 0.8)';
                                tierBadge.style.color = item.rarityColor || ['#8a8a8a', '#5abaaa', '#5a8afa', '#aa5afa', '#FFD700'][item.tier - 1];
                                tierBadge.style.fontSize = '10px';
                                tierBadge.style.fontWeight = 'bold';
                                tierBadge.style.padding = '2px 4px';
                                tierBadge.style.borderRadius = '3px';
                                tierBadge.style.border = `1px solid ${item.rarityColor || '#8a8a8a'}`;
                                tierBadge.textContent = `T${item.tier}`;
                                itemDisplay.appendChild(tierBadge);
                            }
                        } else {
                            // Use emoji for other items - make it larger
                            itemDisplay.innerHTML = `<div class="item-icon" style="font-size: 48px; text-align: center; line-height: 1.2;">${item.icon || 'ðŸ“¦'}</div>`;
                        }
                        
                        slot.appendChild(itemDisplay);
                        
                        // Add quantity/charges display
                        if (item.type === 'magebook' && item.charges !== undefined) {
                            // Show charges for mage books
                            const chargesDiv = document.createElement('div');
                            chargesDiv.className = 'item-quantity';
                            chargesDiv.textContent = item.charges.toLocaleString();
                            chargesDiv.style.color = item.charges > 0 ? '#5abaaa' : '#ff6b6b';
                            slot.appendChild(chargesDiv);
                        } else if (item.quantity > 1) {
                            // Show quantity for stackable items
                            const qty = document.createElement('div');
                            qty.className = 'item-quantity';
                            qty.textContent = item.quantity > 9999 ? '9,999+' : item.quantity.toLocaleString();
                            slot.appendChild(qty);
                        }
                        
                        slot.dataset.item = JSON.stringify(item);
                        
                        // Add click handler for equipping
                        slot.addEventListener('click', (e) => handleItemClick(i, item, e));
                    }
                } else {
                    slot.classList.add('empty');
                }
                
                grid.appendChild(slot);
            }
            
            // Update space counter
            document.getElementById('invSpace').textContent = gameState.player.inventory.length;
            
            // Restore scroll position
            requestAnimationFrame(() => {
                scrollContainer.scrollTop = scrollPosition;
            });
        }

        function handleItemClick(index, item, event) {
            // Check if item is a clue chest - open it immediately with animation!
            if (item.type === 'cluechest') {
                openClueChest(item, index);
                return;
            }
            
            // Check if item is a tool
            if (item.type === 'tool' && TOOL_ITEMS[item.name]) {
                handleToolClick(item);
                return;
            }
            
            // Check if item is tradeable (resources, food, or arrows)
            const isTradeable = TRADEABLE_ITEMS[item.name];
            
            if (isTradeable && (item.type === 'resource' || item.type === 'food' || item.type === 'arrows')) {
                // Quick-sell feature: Open Grand Exchange with item pre-selected
                if (isFirebaseConfigured && database) {
                    // Allow guests for testing purposes
                    if (isGuestMode && !currentUser) {
                        currentUser = {
                            uid: 'guest-' + Math.random().toString(36).substr(2, 9),
                            email: 'guest@temporary.com',
                            displayName: 'Guest'
                        };
                        showFloatingText('âš ï¸ Testing as Guest - Data will not persist!', canvas.width / 2, 100, '#ffaa66');
                    }
                    
                    // Open Grand Exchange
                    document.getElementById('grandExchangeModal').style.display = 'flex';
                    if (!geInitialized) {
                        initGrandExchange();
                        geInitialized = true;
                    }
                    
                    // Wait a moment for modal to render, then select a sell slot and item
                    setTimeout(() => {
                        // Find first empty sell slot
                        const sellSlots = document.querySelectorAll('.offer-slot[data-slot-type="sell"]');
                        let emptySlot = null;
                        
                        for (let slot of sellSlots) {
                            if (slot.classList.contains('empty')) {
                                emptySlot = slot;
                                break;
                            }
                        }
                        
                        if (emptySlot) {
                            // Simulate clicking the empty slot
                            emptySlot.click();
                            
                            // Wait another moment for the sell form to show
                            setTimeout(() => {
                                // Pre-select the item
                                selectSellItem(item.name, item.quantity);
                            }, 100);
                        } else {
                            showFloatingText('All sell slots are full!', canvas.width / 2, 100, '#ff4444');
                        }
                    }, 100);
                    
                    showFloatingText(`Quick-sell: ${item.name}`, canvas.width / 2, 200, '#5abaaa');
                } else {
                    showFloatingText('Grand Exchange requires Firebase setup', canvas.width / 2, 100, '#ff4444');
                }
                return;
            }
            
            // Show context menu for item
            showInventoryContextMenu(item, index, event);
        }
        
        // Context menu for inventory items
        function showInventoryContextMenu(item, index, event) {
            // Remove any existing context menu
            const existing = document.getElementById('inventoryContextMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'inventoryContextMenu';
            menu.style.cssText = `
                position: fixed;
                background: linear-gradient(135deg, rgba(26, 35, 50, 0.98), rgba(15, 22, 32, 0.98));
                border: 2px solid #2a3a4a;
                border-radius: 8px;
                padding: 8px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                min-width: 150px;
            `;
            
            const options = [];
            
            // Determine if item is equippable
            const equipSlots = ['head', 'amulet', 'cape', 'chest', 'legs', 'boots', 'gloves', 'ring', 'weapon', 'off-hand', 'arrows'];
            
            if ((item.type && equipSlots.includes(item.type)) || (item.slot && equipSlots.includes(item.slot))) {
                options.push({
                    text: 'Equip',
                    action: () => equipItem(item, index)
                });
            }
            
            // Add Charge option for Mage Books
            if (item.type === 'magebook') {
                options.push({
                    text: 'Charge',
                    action: () => chargeMageBook(item, index)
                });
            }
            
            // Always show info option
            options.push({
                text: 'Info',
                action: () => showItemInfo(item)
            });
            
            // Add drop option
            options.push({
                text: 'Drop',
                action: () => dropItem(index)
            });
            
            // Create menu options
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.textContent = opt.text;
                btn.style.cssText = `
                    padding: 8px 12px;
                    color: #cad2da;
                    cursor: pointer;
                    border-radius: 4px;
                    transition: all 0.2s;
                    font-size: 14px;
                `;
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'rgba(74, 154, 138, 0.3)';
                    btn.style.color = '#5abaaa';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'transparent';
                    btn.style.color = '#cad2da';
                });
                btn.addEventListener('click', () => {
                    opt.action();
                    menu.remove();
                });
                menu.appendChild(btn);
            });
            
            // Position menu
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.right + 10 + 'px';
            menu.style.top = rect.top + 'px';
            
            // Add to document
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 100);
        }
        
        // Equip item function with combat style checking
        function equipItem(item, index) {
            // Check if in combat zone and switching combat styles
            if (gameState.currentRoom === 'combat') {
                const itemStyle = getCombatStyleFromItem(item);
                const currentStyle = gameState.combat.combatStyle;
                
                if (itemStyle && currentStyle && itemStyle !== currentStyle) {
                    showFloatingText('Cannot change combat style in combat zone!', canvas.width / 2, 200, '#ff4444');
                    return;
                }
            }
            
            // Use slot property if available, otherwise use type
            const slotKey = item.slot || item.type;
            const currentEquipped = gameState.player.equipment[slotKey];
            
            // Swap items
            gameState.player.equipment[slotKey] = item;
            
            // Remove from inventory
            gameState.player.inventory.splice(index, 1);
            
            // Add previously equipped item back to inventory if exists
            if (currentEquipped) {
                gameState.player.inventory.push(currentEquipped);
            }
            
            updateInventoryDisplay();
            updateEquipmentDisplay();
            showFloatingText(`Equipped ${item.name}`, canvas.width / 2, 200, '#5abaaa');
        }
        
        // Helper to determine combat style from item
        function getCombatStyleFromItem(item) {
            if (!item || item.type !== 'weapon') return null;
            
            const name = item.name.toLowerCase();
            if (name.includes('bow') || name.includes('arrow')) return 'ranged';
            if (name.includes('staff') || name.includes('wand')) return 'magic';
            return 'melee';
        }
        
        // Show item info
        function showItemInfo(item) {
            let info = `${item.name}\n`;
            if (item.tier) info += `Tier: ${item.tier}\n`;
            if (item.rarity) info += `Rarity: ${item.rarity}\n`;
            if (item.type === 'magebook') {
                const charges = item.charges || 0;
                info += `Charges: ${charges}\n`;
            }
            if (item.attackBonus) info += `Attack: +${item.attackBonus}\n`;
            if (item.defenseBonus) info += `Defense: +${item.defenseBonus}\n`;
            if (item.magicBonus) info += `Magic: +${item.magicBonus}\n`;
            if (item.rangedBonus) info += `Ranged: +${item.rangedBonus}\n`;
            
            showFloatingText(info, canvas.width / 2, 200, '#5abaaa');
        }
        
        // Drop item
        function dropItem(index) {
            const item = gameState.player.inventory[index];
            
            // If dropping a clue scroll, clear its active tasks
            if (item && item.type === 'clue') {
                const tier = `T${item.tier}`;
                // Clear the clue scroll state
                gameState.clueScrolls[tier] = null;
                // Hide the clue scroll UI
                updateClueScrollUI();
                showFloatingText(`${tier} Clue Scroll abandoned`, canvas.width / 2, 200, '#ff6b6b');
            } else {
                showFloatingText(`Dropped ${item.name}`, canvas.width / 2, 200, '#8a9aaa');
            }
            
            gameState.player.inventory.splice(index, 1);
            updateInventoryDisplay();
        }
        
        // Charge a mage book with pages
        function chargeMageBook(mageBook, bookIndex) {
            if (!mageBook || mageBook.type !== 'magebook') return;
            
            const bookTier = mageBook.tier;
            
            // Find all pages of the same tier in inventory
            let totalPages = 0;
            const pageIndices = [];
            
            gameState.player.inventory.forEach((item, index) => {
                if (item && item.type === 'pages' && item.tier === bookTier) {
                    totalPages += item.quantity || 1;
                    pageIndices.push(index);
                }
            });
            
            if (totalPages === 0) {
                showFloatingText(`No T${bookTier} Pages found in inventory`, canvas.width / 2, 200, '#ff6b6b');
                return;
            }
            
            // Initialize charges if not present
            if (!mageBook.charges) {
                mageBook.charges = 0;
            }
            
            // Add all pages to the book
            mageBook.charges += totalPages;
            
            // Remove all pages from inventory (in reverse order to avoid index issues)
            pageIndices.sort((a, b) => b - a);
            pageIndices.forEach(index => {
                gameState.player.inventory.splice(index, 1);
            });
            
            // Update displays
            updateInventoryDisplay();
            updateEquipmentDisplay();
            
            showFloatingText(`Charged ${mageBook.name} with ${totalPages} pages (Total: ${mageBook.charges})`, canvas.width / 2, 200, '#5abaaa');
            
            saveGame();
        }
        
        // Context menu for equipped items
        function showEquipmentContextMenu(item, slotKey, event) {
            // Remove any existing context menu
            const existing = document.getElementById('equipmentContextMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'equipmentContextMenu';
            menu.style.cssText = `
                position: fixed;
                background: linear-gradient(135deg, rgba(26, 35, 50, 0.98), rgba(15, 22, 32, 0.98));
                border: 2px solid #2a3a4a;
                border-radius: 8px;
                padding: 8px;
                z-index: 10000;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                min-width: 150px;
            `;
            
            const options = [];
            
            // Unequip option
            options.push({
                text: 'Unequip',
                action: () => unequipItem(slotKey)
            });
            
            // Info option
            options.push({
                text: 'Info',
                action: () => showItemInfo(item)
            });
            
            // Create menu options
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.textContent = opt.text;
                btn.style.cssText = `
                    padding: 8px 12px;
                    color: #cad2da;
                    cursor: pointer;
                    border-radius: 4px;
                    transition: all 0.2s;
                    font-size: 14px;
                `;
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'rgba(74, 154, 138, 0.3)';
                    btn.style.color = '#5abaaa';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'transparent';
                    btn.style.color = '#cad2da';
                });
                btn.addEventListener('click', () => {
                    opt.action();
                    menu.remove();
                });
                menu.appendChild(btn);
            });
            
            // Position menu
            const rect = event.target.getBoundingClientRect();
            menu.style.left = rect.right + 10 + 'px';
            menu.style.top = rect.top + 'px';
            
            // Add to document
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 100);
        }
        
        // Unequip item function
        function unequipItem(slotKey) {
            const currentEquipped = gameState.player.equipment[slotKey];
            if (!currentEquipped) return;
            
            // Check if in combat zone
            if (gameState.currentRoom === 'combat') {
                const itemStyle = getCombatStyleFromItem(currentEquipped);
                const currentStyle = gameState.combat.combatStyle;
                
                if (itemStyle && currentStyle && itemStyle !== currentStyle) {
                    showFloatingText('Cannot change combat style in combat zone!', canvas.width / 2, 200, '#ff4444');
                    return;
                }
            }
            
            // Unequip item
            gameState.player.equipment[slotKey] = null;
            gameState.player.inventory.push(currentEquipped);
            updateInventoryDisplay();
            updateEquipmentDisplay();
            showFloatingText(`Unequipped ${currentEquipped.name}`, canvas.width / 2, 200, '#8a9aaa');
        }

        function updateEquipmentDisplay() {
            const equipSlots = document.querySelectorAll('.equip-slot');
            
            equipSlots.forEach(slot => {
                const slotName = slot.dataset.slot;
                if (!slotName) return; // Skip if no slot name (shouldn't happen)
                
                // Convert slot name to equipment key (e.g., "Off-Hand" -> "off-hand")
                const slotKey = slotName.toLowerCase().replace(' ', '-');
                const equipped = gameState.player.equipment[slotKey];
                
                if (equipped) {
                    slot.classList.remove('empty');
                    slot.classList.add('equipped');
                    slot.dataset.icon = equipped.icon || '';
                    slot.dataset.item = equipped.name;
                } else {
                    slot.classList.add('empty');
                    slot.classList.remove('equipped');
                    slot.dataset.icon = '';
                    slot.dataset.item = '';
                }
                
                // Remove existing click handlers by cloning
                const newSlot = slot.cloneNode(true);
                slot.parentNode.replaceChild(newSlot, slot);
                
                // Add click handler for equipment context menu
                newSlot.addEventListener('click', (e) => {
                    const currentEquipped = gameState.player.equipment[slotKey];
                    if (currentEquipped) {
                        showEquipmentContextMenu(currentEquipped, slotKey, e);
                    }
                });
            });
            
            // Re-setup tooltips after updating
            if (typeof setupEquipmentTooltips === 'function') {
                setupEquipmentTooltips();
            }
        }

        // Setup equipment slot tooltips
        function setupEquipmentTooltips() {
            const tooltip = document.querySelector('.tooltip');
            if (!tooltip) return;
            
            document.querySelectorAll('.equip-slot').forEach(slot => {
                // Remove existing listeners by cloning
                const newSlot = slot.cloneNode(true);
                slot.parentNode.replaceChild(newSlot, slot);
                
                newSlot.addEventListener('mouseenter', (e) => {
                    const slotName = newSlot.dataset.slot;
                    const itemName = newSlot.dataset.item;
                    
                    if (itemName) {
                        tooltip.innerHTML = `<span class="tooltip-item">${slotName} slot: ${itemName}</span>`;
                    } else {
                        tooltip.innerHTML = `<span class="tooltip-empty">${slotName} slot: Empty</span>`;
                    }
                    
                    tooltip.classList.add('show');
                    
                    // Position tooltip
                    const rect = newSlot.getBoundingClientRect();
                    tooltip.style.left = (rect.left - tooltip.offsetWidth - 10) + 'px';
                    tooltip.style.top = (rect.top + rect.height/2 - tooltip.offsetHeight/2) + 'px';
                });
                
                newSlot.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });
        }

        // Game loop
        // Update tree and ore regrowth states
        function updateResourceRegrowth() {
            const room = rooms[gameState.currentRoom];
            if (!room.objects) return;
            
            const now = Date.now();
            room.objects.forEach(obj => {
                if (obj.regrowthStartTime) {
                    const timeSinceCut = now - obj.regrowthStartTime;
                    
                    if (obj.type === 'tree') {
                        if (timeSinceCut < 2000) {
                            // 0-2 seconds: stump
                            obj.state = 'stump';
                        } else if (timeSinceCut < 4000) {
                            // 2-4 seconds: half grown
                            obj.state = 'half';
                        } else {
                            // 4+ seconds: fully grown
                            obj.state = 'full';
                            obj.regrowthStartTime = null; // Clear timer
                            // Roll new rarity when tree is fully regrown
                            obj.rarity = getRarity();
                        }
                    } else if (obj.type === 'ore') {
                        if (timeSinceCut < 2000) {
                            // 0-2 seconds: stage 1
                            obj.state = 'stage1';
                        } else if (timeSinceCut < 4000) {
                            // 2-4 seconds: stage 2
                            obj.state = 'stage2';
                        } else {
                            // 4+ seconds: fully grown
                            obj.state = 'full';
                            obj.regrowthStartTime = null; // Clear timer
                            // Roll new rarity when ore is fully regrown
                            // Exception: white rock is always common
                            if (obj.variant === 'whiteRock') {
                                obj.rarity = { key: 'common', name: 'Common', color: '#ffffff', multiplier: 1 };
                            } else {
                                obj.rarity = getRarity();
                            }
                        }
                    } else if (obj.type === 'chest') {
                        // Runes have longer respawn time as they're rare
                        if (timeSinceCut < 3000) {
                            // 0-3 seconds: depleted
                            obj.state = 'depleted';
                        } else if (timeSinceCut < 6000) {
                            // 3-6 seconds: forming
                            obj.state = 'forming';
                        } else {
                            // 6+ seconds: fully formed
                            obj.state = 'full';
                            obj.regrowthStartTime = null; // Clear timer
                            // Roll new rarity when rune is fully formed
                            obj.rarity = getRarity();
                        }
                    }
                }
            });
        }

        function gameLoop() {
            drawRoom();
            
            // Update resource regrowth (trees and ore)
            updateResourceRegrowth();
            
            // Update combat (OSRS-style real-time)
            updateCombat();
            
            // Check for inactivity and auto-enable AFK mode
            if (!gameState.afkMode && gameState.currentRoom !== 'combat') {
                const inactivityTime = Date.now() - gameState.inactivityTimer;
                const remainingTime = Math.max(0, 3000 - inactivityTime);
                const remainingSeconds = Math.ceil(remainingTime / 1000);
                
                const indicator = document.getElementById('autoResumeIndicator');
                const countdown = document.getElementById('autoResumeCountdown');
                
                // Show countdown indicator
                if (indicator && countdown) {
                    if (remainingTime > 0) {
                        indicator.style.display = 'block';
                        countdown.textContent = remainingSeconds;
                    } else {
                        indicator.style.display = 'none';
                    }
                }
                
                // If player hasn't clicked in 3 seconds, re-enable AFK mode
                if (inactivityTime > 3000) {
                    gameState.afkMode = true;
                    const btn = document.getElementById('afkToggle');
                    const textSpan = document.getElementById('afkModeText');
                    if (btn) {
                        textSpan.textContent = 'AFK Mode';
                        btn.classList.add('active');
                    }
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                    // Show notification about auto-resume
                    showFloatingText('ðŸŸ¢ Auto-resumed AFK Mode', canvas.width / 2, 150, '#5abaaa');
                    // Reset target for AFK mode to start
                    gameState.nextTargetTime = Date.now() + 1000;
                }
            } else {
                // Hide countdown when in AFK mode
                const indicator = document.getElementById('autoResumeIndicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }
            
            // AFK Activity Logic (works for all rooms except combat)
            if (gameState.afkMode && gameState.currentRoom !== 'combat') {
                // Select new target if needed
                if (!gameState.player.currentTarget && !gameState.player.targetX && Date.now() > gameState.nextTargetTime) {
                    selectNextTarget();
                }
                
                // Perform current action
                performAction();
            } else if (!gameState.afkMode && gameState.currentRoom !== 'combat') {
                // Manual mode - only perform action if player clicked on something
                if (gameState.player.isPerformingAction) {
                    performAction();
                }
            }
            
            movePlayer();
            
            // Update mob AI in combat room
            if (gameState.currentRoom === 'combat') {
                updateMobs();
                updateCombat();
            }
            
            // Draw monster if in combat
            drawMonster();
            
            // Draw attack range indicator (behind player)
            drawAttackRangeIndicator();
            
            // Update player animation state and frames
            updatePlayerAnimation();
            
            drawPlayer();
            drawActionProgress();
            
            // Draw combat UI elements
            if (gameState.currentRoom === 'combat') {
                drawHealthBars();
                updateDamageSplats();
            }
            
            drawFloatingTexts();
            
            requestAnimationFrame(gameLoop);
        }

        // Event listeners
        canvas.addEventListener('click', (e) => {
            if (!gameState.inventoryOpen) {
                // Get canvas-relative coordinates
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // Convert click coordinates to world coordinates by adding camera offset
                const worldClickX = clickX + gameState.camera.x;
                const worldClickY = clickY + gameState.camera.y;
                
                // Check if click is on a node/object
                const room = rooms[gameState.currentRoom];
                let clickedObject = null;
                
                if (room.objects) {
                    // Find the closest object within click range (50px)
                    const CLICK_RANGE = 50;
                    let closestDistance = CLICK_RANGE;
                    
                    room.objects.forEach(obj => {
                        // Skip resources that are regrowing (not in 'full' state)
                        if ((obj.type === 'tree' || obj.type === 'ore' || obj.type === 'chest') && obj.state !== 'full') {
                            return;
                        }
                        
                        // Use world coordinates for distance check
                        const distance = Math.sqrt(
                            Math.pow(worldClickX - obj.x, 2) + 
                            Math.pow(worldClickY - obj.y, 2)
                        );
                        
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            clickedObject = obj;
                        }
                    });
                }
                
                // Reset gathering progress when clicking a new target
                if (clickedObject && gameState.player.currentTarget !== clickedObject) {
                    gameState.player.isPerformingAction = false;
                    gameState.player.actionProgress = 0;
                    gameState.player.lastActionTime = 0;
                }
                
                // If clicked on an object, set it as current target
                if (clickedObject) {
                    gameState.player.currentTarget = clickedObject;
                    
                    // Determine attack range based on combat style (for combat zone)
                    let attackRange = 10; // Default melee range
                    if (gameState.currentRoom === 'combat' && clickedObject.type === 'mob') {
                        // Detect combat style from equipped weapon
                        const equippedWeapon = gameState.player.equipment.weapon;
                        let detectedStyle = 'melee';
                        
                        if (equippedWeapon) {
                            detectedStyle = getCombatStyleFromItem(equippedWeapon);
                        }
                        
                        // Use detected style or fallback to combat state
                        const combatStyle = detectedStyle || gameState.combat.combatStyle || 'melee';
                        
                        if (combatStyle === 'ranged') {
                            attackRange = 200; // Ranged attack distance (increased)
                        } else if (combatStyle === 'magic') {
                            attackRange = 230; // Magic attack distance (increased)
                        } else {
                            attackRange = 100; // Melee attack distance (increased)
                        }
                    }
                    
                    // Check if player is already close enough to the node (using player position)
                    const dx = clickedObject.x - gameState.player.x;
                    const dy = clickedObject.y - gameState.player.y;
                    const distanceToNode = Math.sqrt(dx * dx + dy * dy);
                    
                    // If already within range, start action immediately
                    if (distanceToNode <= attackRange) {
                        gameState.player.isPerformingAction = true;
                        gameState.player.actionProgress = 0;
                        gameState.player.lastActionTime = Date.now();
                        gameState.player.targetX = null;
                        gameState.player.targetY = null;
                        
                        // Apply tool speed bonus to action duration
                        const baseActionDuration = 3000; // 3 seconds base
                        const speedBonus = getToolSpeedBonus(gameState.currentRoom);
                        gameState.player.actionDuration = baseActionDuration * (1 - speedBonus / 100);
                    } else {
                        // For ranged/magic, move to edge of attack range, not to the target
                        if (gameState.currentRoom === 'combat' && clickedObject.type === 'mob' && attackRange > 10) {
                            // Calculate position at edge of attack range
                            const angle = Math.atan2(dy, dx);
                            const targetDistance = attackRange - 5; // Stay just within range
                            gameState.player.targetX = clickedObject.x - Math.cos(angle) * targetDistance;
                            gameState.player.targetY = clickedObject.y - Math.sin(angle) * targetDistance;
                        } else {
                            // For melee or non-combat, move to the target position
                            gameState.player.targetX = clickedObject.x;
                            gameState.player.targetY = clickedObject.y;
                        }
                    }
                    
                    // Add minimal click feedback particles (reduced for performance)
                    for (let i = 0; i < 5; i++) {
                        gameState.particles.push({
                            x: clickX + (Math.random() - 0.5) * 20,
                            y: clickY + (Math.random() - 0.5) * 20,
                            size: 3 + Math.random() * 2,
                            color: '#FFD700',
                            speed: 2 + Math.random(),
                            alpha: 1
                        });
                    }
                    
                    // Show floating text feedback (removed to reduce lag)
                    // showFloatingText('Target Selected!', clickX, clickY - 30, '#FFD700');
                } else {
                    // Clicked on empty space - just move there using world coordinates
                    gameState.player.targetX = worldClickX;
                    gameState.player.targetY = worldClickY;
                    gameState.player.currentTarget = null;
                }
                
                // Auto-switch to active/manual mode on click
                if (gameState.afkMode) {
                    gameState.afkMode = false;
                    const btn = document.getElementById('afkToggle');
                    btn.textContent = 'Manual Mode';
                    btn.classList.remove('active');
                }
                
                // Reset inactivity timer
                gameState.inactivityTimer = Date.now();
            }
        });

        // AFK Mode toggle
        document.getElementById('afkToggle').addEventListener('click', () => {
            gameState.afkMode = !gameState.afkMode;
            const btn = document.getElementById('afkToggle');
            const textSpan = document.getElementById('afkModeText');
            
            if (gameState.afkMode) {
                textSpan.textContent = 'AFK Mode';
                btn.classList.add('active');
                showFloatingText('ðŸŸ¢ AFK Mode Enabled', canvas.width / 2, 150, '#5abaaa');
                // Reset target for AFK mode to start
                gameState.nextTargetTime = Date.now() + 1000;
            } else {
                textSpan.textContent = 'Manual Mode';
                btn.classList.remove('active');
                showFloatingText('ðŸ”´ Manual Mode - Auto-resume in 3s', canvas.width / 2, 150, '#FFD700');
                // Clear any current AFK targets
                gameState.player.currentTarget = null;
                gameState.player.targetX = null;
                gameState.player.targetY = null;
                gameState.player.isPerformingAction = false;
                // Reset inactivity timer when switching to manual mode
                gameState.inactivityTimer = Date.now();
            }
        });

        // Grand Exchange / Player Market menu handler
        document.querySelectorAll('.menu-item').forEach(item => {
            const text = item.textContent.trim();
            if (text.includes('Player market')) {
                item.addEventListener('click', () => {
                    if (isFirebaseConfigured && database) {
                        // Allow guests for testing purposes
                        if (isGuestMode && !currentUser) {
                            // Create consistent guest user for testing
                            currentUser = {
                                uid: 'guest-testing',
                                email: 'guest@testing.com',
                                displayName: 'Guest'
                            };
                            showFloatingText('ðŸ§ª Testing as Guest - Market access enabled!', canvas.width / 2, 100, '#ffaa66');
                        }
                        
                        document.getElementById('grandExchangeModal').style.display = 'flex';
                        if (!geInitialized) {
                            initGrandExchange();
                            geInitialized = true;
                        }
                    } else {
                        showFloatingText('Grand Exchange requires Firebase setup', canvas.width / 2, 100, '#ff4444');
                    }
                });
            }
        });

        // Room switching from sidebar
        document.querySelectorAll('.menu-item[data-room]').forEach(item => {
            item.addEventListener('click', () => {
                const room = item.dataset.room;
                
                // Special handling for raids - open lobby instead
                if (room === 'raids') {
                    openRaidLobby();
                    return;
                }
                
                // Special handling for crafting - open crafting modal
                if (room === 'crafting') {
                    document.getElementById('ammunitionCraftingModal').style.display = 'block';
                    updateCraftingMaterialCounts();
                    // Don't return - still switch room
                }
                
                // Special handling for smithwright - open smithwright modal
                if (room === 'smithwright') {
                    document.getElementById('smithwrightModal').style.display = 'block';
                    populateSmithwrightContent('bars', 1);
                    // Don't return - still switch room
                }
                
                // Special handling for combat - open combat modal
                if (room === 'combat') {
                    document.getElementById('combatModal').style.display = 'block';
                    populateCombatContent('woods');
                    return; // Don't switch room yet
                }
                
                if (rooms[room]) {
                    // Clean up combat state when leaving combat room
                    if (gameState.currentRoom === 'combat' && room !== 'combat') {
                        // Full combat state reset
                        gameState.combat.inCombat = false;
                        gameState.combat.monster = null;
                        gameState.combat.monsterHealth = 0;
                        gameState.combat.monsterMaxHealth = 0;
                        gameState.combat.monsterNode = null;
                        gameState.combat.monsterPosition = { x: 0, y: 0 };
                        gameState.combat.damageSplats = [];
                        gameState.combat.lastPlayerAttack = 0;
                        gameState.combat.lastMonsterAttack = 0;
                        gameState.selectedZone = null;
                        
                        // Reset all mobs in combat room
                        if (rooms.combat && rooms.combat.objects) {
                            rooms.combat.objects.forEach(obj => {
                                if (obj.type === 'mob') {
                                    obj.inCombat = false;
                                    obj.health = obj.maxHealth;
                                    obj.x = obj.spawnX;
                                    obj.y = obj.spawnY;
                                    obj.targetX = null;
                                    obj.targetY = null;
                                }
                            });
                        }
                    }
                    
                    // Update active state
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Change room
                    gameState.currentRoom = room;
                    let roomDisplayName = rooms[room].name;
                    
                    // Add tier info for gathering rooms
                    if (['woodcutting', 'mining', 'fishing', 'plundering', 'agility'].includes(room)) {
                        const skillLevel = gameState.player.skills[room] || 1;
                        let maxTier = 1;
                        if (skillLevel >= 80) maxTier = 5;
                        else if (skillLevel >= 60) maxTier = 4;
                        else if (skillLevel >= 40) maxTier = 3;
                        else if (skillLevel >= 20) maxTier = 2;
                        
                        roomDisplayName += ` (T1-T${maxTier} Available)`;
                    }
                    
                    document.getElementById('currentRoom').textContent = roomDisplayName;
                    generateTiles();
                    
                    // Reset player position and state
                    gameState.player.x = canvas.width / 2;
                    gameState.player.y = canvas.height / 2;
                    gameState.player.targetX = null;
                    gameState.player.targetY = null;
                    gameState.player.currentTarget = null;
                    gameState.player.isPerformingAction = false;
                    gameState.nextTargetTime = Date.now() + 1000; // Start activities after 1 second
                    
                    // Show room info based on mode with tier info
                    let infoText = gameState.afkMode ? 
                        (room === 'combat' ? 'Combat - Manual Only!' : `AFK Mode - Auto ${room.charAt(0).toUpperCase() + room.slice(1)}`) :
                        `Manual Mode - ${room.charAt(0).toUpperCase() + room.slice(1)}`;
                    
                    // Add skill level and tier info for gathering rooms
                    if (['woodcutting', 'mining', 'fishing', 'plundering', 'agility'].includes(room)) {
                        const skillLevel = gameState.player.skills[room] || 1;
                        let maxTier = 1;
                        if (skillLevel >= 80) maxTier = 5;
                        else if (skillLevel >= 60) maxTier = 4;
                        else if (skillLevel >= 40) maxTier = 3;
                        else if (skillLevel >= 20) maxTier = 2;
                        
                        infoText += ` - Level ${skillLevel} (T${maxTier} Max)`;
                    }
                    
                    showFloatingText(infoText, canvas.width / 2, 100, '#FFD700');
                    
                    // Save game after room change
                    saveGame();
                }
            });
        });

        // Sidebar toggle
        // Sidebar toggle
        document.querySelector('.sidebar-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('leftSidebar');
            const canvas = document.getElementById('gameCanvas');
            sidebar.classList.toggle('collapsed');
            this.textContent = sidebar.classList.contains('collapsed') ? 'âŸ©' : 'âŸ¨';
            
            // Adjust canvas position
            if (sidebar.classList.contains('collapsed')) {
                canvas.classList.add('expanded');
            } else {
                canvas.classList.remove('expanded');
            }
        });
        
        // Inventory toggle
        document.addEventListener('keydown', (e) => {
            // Close all menus with Escape key
            if (e.key === 'Escape') {
                e.preventDefault();
                
                // Close inventory
                if (gameState.inventoryOpen) {
                    gameState.inventoryOpen = false;
                    document.getElementById('inventoryUI').style.display = 'none';
                }
                
                // Close character stats
                const charStatsUI = document.getElementById('characterStatsUI');
                if (charStatsUI && charStatsUI.style.display === 'block') {
                    charStatsUI.style.display = 'none';
                }
                
                // Close combat modal
                const combatModal = document.getElementById('combatModal');
                if (combatModal && combatModal.style.display === 'block') {
                    combatModal.style.display = 'none';
                }
                
                // Close combat prep modal
                const combatPrepModal = document.getElementById('combatPrepModal');
                if (combatPrepModal && combatPrepModal.style.display === 'block') {
                    combatPrepModal.style.display = 'none';
                }
                
                // Close grand exchange
                const grandExchangeModal = document.getElementById('grandExchangeModal');
                if (grandExchangeModal && grandExchangeModal.style.display === 'flex') {
                    grandExchangeModal.style.display = 'none';
                }
                
                // Close smithwright modal
                const smithwrightModal = document.getElementById('smithwrightModal');
                if (smithwrightModal && smithwrightModal.style.display === 'block') {
                    smithwrightModal.style.display = 'none';
                }
                
                // Close ammunition crafting modal
                const ammunitionCraftingModal = document.getElementById('ammunitionCraftingModal');
                if (ammunitionCraftingModal && ammunitionCraftingModal.style.display === 'block') {
                    ammunitionCraftingModal.style.display = 'none';
                }
                
                // Close profile modal
                const profileModal = document.getElementById('profileModal');
                if (profileModal && profileModal.style.display === 'block') {
                    profileModal.style.display = 'none';
                }
                
                // Close create clan modal
                const createClanModal = document.getElementById('createClanModal');
                if (createClanModal && createClanModal.style.display === 'block') {
                    createClanModal.style.display = 'none';
                }
                
                // Close join clan modal
                const joinClanModal = document.getElementById('joinClanModal');
                if (joinClanModal && joinClanModal.style.display === 'block') {
                    joinClanModal.style.display = 'none';
                }
                
                // Close market wiki modal
                const marketWikiModal = document.getElementById('marketWikiModal');
                if (marketWikiModal && marketWikiModal.style.display === 'flex') {
                    marketWikiModal.style.display = 'none';
                }
                
                // Close raid lobby modal
                const raidLobbyModal = document.getElementById('raidLobbyModal');
                if (raidLobbyModal && raidLobbyModal.style.display === 'flex') {
                    raidLobbyModal.style.display = 'none';
                }
                
                // Close any context menus
                const inventoryContextMenu = document.getElementById('inventoryContextMenu');
                if (inventoryContextMenu) {
                    inventoryContextMenu.remove();
                }
                
                const equipmentContextMenu = document.getElementById('equipmentContextMenu');
                if (equipmentContextMenu) {
                    equipmentContextMenu.remove();
                }
                
                return; // Don't process other keys if Escape was pressed
            }
            
            if (e.key === 'Tab') {
                e.preventDefault();
                gameState.inventoryOpen = !gameState.inventoryOpen;
                document.getElementById('inventoryUI').style.display = 
                    gameState.inventoryOpen ? 'block' : 'none';
            }
            
            // Toggle Character Stats with 'C' key
            if (e.key === 'c' || e.key === 'C') {
                const charStatsUI = document.getElementById('characterStatsUI');
                if (charStatsUI.style.display === 'none' || !charStatsUI.style.display) {
                    updateCharacterStats(); // Update stats before showing
                    charStatsUI.style.display = 'block';
                } else {
                    charStatsUI.style.display = 'none';
                }
            }
        });

        // Close button
        document.getElementById('closeInventory').addEventListener('click', () => {
            gameState.inventoryOpen = false;
            document.getElementById('inventoryUI').style.display = 'none';
            resetUIPosition('inventoryUI');
        });

        // Inventory button
        document.querySelectorAll('.menu-item').forEach(item => {
            if (item.textContent.trim().includes('Inventory')) {
                item.addEventListener('click', () => {
                    gameState.inventoryOpen = true;
                    document.getElementById('inventoryUI').style.display = 'block';
                });
            }
        });

        // Sort button
        document.getElementById('sortBtn').addEventListener('click', () => {
            // Define rarity order (lower index = lower rarity)
            const rarityOrder = {
                'common': 0,
                'uncommon': 1,
                'rare': 2,
                'epic': 3,
                'perfect': 4,
                'legendary': 5
            };
            
            // Define resource type order
            const getResourceType = (itemName) => {
                const nameLower = itemName.toLowerCase();
                if (nameLower.includes('log')) return 'wood';
                if (nameLower.includes('ore')) return 'ore';
                if (nameLower.includes('fish')) return 'fish';
                if (nameLower.includes('cooked')) return 'food';
                // Equipment types
                if (nameLower.includes('sword') || nameLower.includes('dagger') || 
                    nameLower.includes('bow') || nameLower.includes('staff')) return 'weapon';
                if (nameLower.includes('armor') || nameLower.includes('helm') || 
                    nameLower.includes('boots') || nameLower.includes('gloves')) return 'armor';
                if (nameLower.includes('ring') || nameLower.includes('amulet')) return 'accessory';
                return 'other';
            };
            
            const resourceTypeOrder = {
                'wood': 0,
                'ore': 1,
                'fish': 2,
                'food': 3,
                'weapon': 4,
                'armor': 5,
                'accessory': 6,
                'other': 7
            };
            
            // Sort inventory
            gameState.player.inventory.sort((a, b) => {
                // Skip null/undefined items
                if (!a) return 1;
                if (!b) return -1;
                
                // First, sort by resource type
                const typeA = getResourceType(a.name || '');
                const typeB = getResourceType(b.name || '');
                const typeOrder = (resourceTypeOrder[typeA] || 999) - (resourceTypeOrder[typeB] || 999);
                if (typeOrder !== 0) return typeOrder;
                
                // Then sort by tier (if items have tiers)
                const tierA = a.tier || 0;
                const tierB = b.tier || 0;
                if (tierA !== tierB) return tierA - tierB;
                
                // Finally sort by rarity
                const rarityA = rarityOrder[a.rarity] !== undefined ? rarityOrder[a.rarity] : 999;
                const rarityB = rarityOrder[b.rarity] !== undefined ? rarityOrder[b.rarity] : 999;
                return rarityA - rarityB;
            });
            
            // Update display
            updateInventoryDisplay();
            showFloatingText('Inventory Sorted!', canvas.width / 2, 200, '#5abaaa');
            
            // Visual feedback on inventory slots
            const slots = document.querySelectorAll('.inv-slot');
            slots.forEach((slot, index) => {
                setTimeout(() => {
                    slot.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        slot.style.transform = 'scale(1)';
                    }, 100);
                }, index * 20);
            });
        });

        // Inventory Search functionality
        const invSearchInput = document.querySelector('.inv-search-bar .search-input');
        const invSearchButtons = document.querySelectorAll('.inv-search-bar .search-btn');
        
        // Store original inventory for reset
        let filteredInventory = null;
        
        // Search button (first button)
        if (invSearchButtons[0]) {
            invSearchButtons[0].addEventListener('click', () => {
                const searchTerm = invSearchInput.value.trim().toLowerCase();
                
                if (!searchTerm) {
                    showFloatingText('Please enter a search term', canvas.width / 2, 100, '#ffaa66');
                    return;
                }
                
                // Filter inventory
                filteredInventory = gameState.player.inventory.filter(item => {
                    if (!item) return false;
                    return item.name.toLowerCase().includes(searchTerm);
                });
                
                // Display filtered results
                displayFilteredInventory(filteredInventory, searchTerm);
                showFloatingText(`Found ${filteredInventory.length} items`, canvas.width / 2, 100, '#5abaaa');
            });
        }
        
        // Reset button (second button)
        if (invSearchButtons[1]) {
            invSearchButtons[1].addEventListener('click', () => {
                invSearchInput.value = '';
                filteredInventory = null;
                updateInventoryDisplay();
                showFloatingText('Search Reset', canvas.width / 2, 100, '#5abaaa');
            });
        }
        
        // Allow Enter key to search
        invSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && invSearchButtons[0]) {
                invSearchButtons[0].click();
            }
        });
        
        // Function to display filtered inventory
        function displayFilteredInventory(items, searchTerm) {
            const container = document.getElementById('inventoryGrid');
            const scrollContainer = container.parentElement;
            const scrollPosition = scrollContainer.scrollTop;
            
            container.innerHTML = '';
            
            if (items.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 40px; color: #8a9aaa; font-size: 16px;';
                emptyMsg.textContent = `No items matching "${searchTerm}" found`;
                container.appendChild(emptyMsg);
                return;
            }
            
            items.forEach((item, idx) => {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                
                if (item) {
                    // Get sprite URL
                    let spriteUrl = null;
                    if (item.icon && spriteUrls[item.icon]) {
                        spriteUrl = spriteUrls[item.icon];
                    }
                    
                    const rarityClass = item.rarity ? item.rarity.toLowerCase() : 'common';
                    const rarityColors = {
                        common: '#6a7a8a',
                        uncommon: '#5a7a5a',
                        rare: '#5a6a8a',
                        epic: '#7a5a8a',
                        perfect: '#aa9a5a',
                        legendary: '#aa6a3a'
                    };
                    const borderColor = rarityColors[rarityClass] || rarityColors.common;
                    
                    slot.style.borderColor = borderColor;
                    slot.style.background = `linear-gradient(135deg, rgba(0,0,0,0.3), ${borderColor}15)`;
                    
                    if (spriteUrl) {
                        slot.innerHTML = `
                            <img src="${spriteUrl}" 
                                 style="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated;" 
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='${item.icon || 'ðŸ“¦'}'">
                            <div class="inv-quantity">${item.quantity || 1}</div>
                        `;
                    } else {
                        slot.innerHTML = `
                            <div class="inv-icon">${item.icon || 'ðŸ“¦'}</div>
                            <div class="inv-quantity">${item.quantity || 1}</div>
                        `;
                    }
                }
                
                container.appendChild(slot);
            });
            
            // Restore scroll position
            requestAnimationFrame(() => {
                scrollContainer.scrollTop = scrollPosition;
            });
        }

        // ==================== RAID LOBBY SYSTEM ====================
        
        // Global lobby state
        let currentLobbyId = null;
        let lobbyListeners = {};
        
        // Open raid lobby modal
        function openRaidLobby() {
            // Allow guests for testing
            if (isGuestMode && !currentUser) {
                currentUser = {
                    uid: 'guest-testing',
                    email: 'guest@testing.com',
                    displayName: 'Guest'
                };
                showFloatingText('ðŸ§ª Testing as Guest - Raid access enabled!', canvas.width / 2, 100, '#ffaa66');
            }
            
            document.getElementById('raidLobbyModal').style.display = 'flex';
            showLobbyListView();
            loadAvailableLobbies();
        }
        
        // Close lobby modal
        document.getElementById('closeLobby').addEventListener('click', () => {
            document.getElementById('raidLobbyModal').style.display = 'none';
            resetUIPosition('raidLobbyModal');
            // Clean up listeners if leaving a lobby
            if (currentLobbyId) {
                cleanupLobbyListeners();
            }
        });
        
        // Show lobby list view
        function showLobbyListView() {
            document.getElementById('lobbyListView').style.display = 'block';
            document.getElementById('createLobbyView').style.display = 'none';
            document.getElementById('activeLobbyView').style.display = 'none';
        }
        
        // Show create lobby view
        function showCreateLobbyView() {
            document.getElementById('lobbyListView').style.display = 'none';
            document.getElementById('createLobbyView').style.display = 'block';
            document.getElementById('activeLobbyView').style.display = 'none';
        }
        
        // Show active lobby view
        function showActiveLobbyView() {
            document.getElementById('lobbyListView').style.display = 'none';
            document.getElementById('createLobbyView').style.display = 'none';
            document.getElementById('activeLobbyView').style.display = 'block';
        }
        
        // Create lobby button
        document.getElementById('createLobbyBtn').addEventListener('click', () => {
            showCreateLobbyView();
        });
        
        // Cancel create lobby
        document.getElementById('cancelCreateLobby').addEventListener('click', () => {
            showLobbyListView();
        });
        
        // Refresh lobbies button
        document.getElementById('refreshLobbiesBtn').addEventListener('click', () => {
            loadAvailableLobbies();
            showFloatingText('Lobbies Refreshed!', canvas.width / 2, 100, '#5abaaa');
        });
        
        // Confirm create lobby
        document.getElementById('confirmCreateLobby').addEventListener('click', async () => {
            const lobbyName = document.getElementById('lobbyName').value.trim();
            const raidType = document.getElementById('raidType').value;
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const minLevel = parseInt(document.getElementById('minLevel').value);
            
            if (!lobbyName) {
                showFloatingText('Please enter a lobby name', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            if (!database) {
                showFloatingText('Database not available', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            try {
                // Create new lobby in Firebase
                const lobbyRef = database.ref('raidLobbies').push();
                const lobbyId = lobbyRef.key;
                
                const lobbyData = {
                    id: lobbyId,
                    name: lobbyName,
                    raidType: raidType,
                    maxPlayers: maxPlayers,
                    minLevel: minLevel,
                    leaderId: currentUser.uid,
                    leaderName: playerProfile.username || currentUser.displayName,
                    status: 'waiting', // waiting, in-progress, completed
                    createdAt: Date.now(),
                    members: {
                        [currentUser.uid]: {
                            username: playerProfile.username || currentUser.displayName,
                            totalLevel: Object.values(gameState.player.skills).reduce((a, b) => a + b, 0),
                            joinedAt: Date.now(),
                            isLeader: true
                        }
                    }
                };
                
                await lobbyRef.set(lobbyData);
                currentLobbyId = lobbyId;
                
                // Join the lobby
                await joinLobby(lobbyId);
                
                showFloatingText('Lobby Created!', canvas.width / 2, 100, '#5abaaa');
                
                // Clear form
                document.getElementById('lobbyName').value = '';
                
            } catch (error) {
                console.error('Error creating lobby:', error);
                showFloatingText('Failed to create lobby', canvas.width / 2, 100, '#ff4444');
            }
        });
        
        // Load available lobbies
        async function loadAvailableLobbies() {
            if (!database) return;
            
            try {
                const lobbiesRef = database.ref('raidLobbies');
                const snapshot = await lobbiesRef.once('value');
                const lobbies = snapshot.val() || {};
                
                const lobbiesGrid = document.getElementById('lobbiesGrid');
                lobbiesGrid.innerHTML = '';
                
                const lobbyArray = Object.values(lobbies).filter(lobby => 
                    lobby.status === 'waiting' && 
                    Object.keys(lobby.members || {}).length < lobby.maxPlayers
                );
                
                if (lobbyArray.length === 0) {
                    lobbiesGrid.innerHTML = `
                        <div class="no-lobbies">
                            <div class="no-lobbies-icon">ðŸ°</div>
                            <div class="no-lobbies-text">No active lobbies found. Create one to get started!</div>
                        </div>
                    `;
                    return;
                }
                
                lobbyArray.forEach(lobby => {
                    const memberCount = Object.keys(lobby.members || {}).length;
                    const isFull = memberCount >= lobby.maxPlayers;
                    
                    const lobbyCard = document.createElement('div');
                    lobbyCard.className = 'lobby-card';
                    lobbyCard.innerHTML = `
                        <div class="lobby-card-header">
                            <div class="lobby-card-title">${lobby.name}</div>
                            <div class="lobby-card-status ${isFull ? 'full' : 'waiting'}">
                                ${isFull ? 'FULL' : 'WAITING'}
                            </div>
                        </div>
                        <div class="lobby-card-info">
                            <div class="lobby-card-info-row">
                                <span>Raid Type:</span>
                                <span>${lobby.raidType.charAt(0).toUpperCase() + lobby.raidType.slice(1)}</span>
                            </div>
                            <div class="lobby-card-info-row">
                                <span>Players:</span>
                                <span>${memberCount}/${lobby.maxPlayers}</span>
                            </div>
                            <div class="lobby-card-info-row">
                                <span>Min Level:</span>
                                <span>${lobby.minLevel}+</span>
                            </div>
                            <div class="lobby-card-info-row">
                                <span>Leader:</span>
                                <span class="lobby-card-leader">${lobby.leaderName}</span>
                            </div>
                        </div>
                        <div class="lobby-card-members">
                            ${Object.values(lobby.members || {}).map(member => 
                                `<div class="lobby-member-badge">${member.username}</div>`
                            ).join('')}
                        </div>
                        <div class="lobby-card-actions">
                            ${!isFull ? `<button class="lobby-card-btn join" onclick="joinLobby('${lobby.id}')">Join Lobby</button>` : ''}
                            <button class="lobby-card-btn" onclick="viewLobbyDetails('${lobby.id}')">View Details</button>
                        </div>
                    `;
                    lobbiesGrid.appendChild(lobbyCard);
                });
                
            } catch (error) {
                console.error('Error loading lobbies:', error);
                showFloatingText('Failed to load lobbies', canvas.width / 2, 100, '#ff4444');
            }
        }
        
        // Join lobby
        async function joinLobby(lobbyId) {
            if (!database || !currentUser) return;
            
            try {
                const lobbyRef = database.ref(`raidLobbies/${lobbyId}`);
                const snapshot = await lobbyRef.once('value');
                const lobby = snapshot.val();
                
                if (!lobby) {
                    showFloatingText('Lobby not found', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                const memberCount = Object.keys(lobby.members || {}).length;
                if (memberCount >= lobby.maxPlayers) {
                    showFloatingText('Lobby is full', canvas.width / 2, 100, '#ff4444');
                    return;
                }
                
                // Check if already in lobby
                if (lobby.members && lobby.members[currentUser.uid]) {
                    // Already in this lobby, just show it
                    currentLobbyId = lobbyId;
                    setupActiveLobby(lobbyId, lobby);
                    return;
                }
                
                // Add player to lobby
                await lobbyRef.child(`members/${currentUser.uid}`).set({
                    username: playerProfile.username || currentUser.displayName,
                    totalLevel: Object.values(gameState.player.skills).reduce((a, b) => a + b, 0),
                    joinedAt: Date.now(),
                    isLeader: false
                });
                
                // Add chat message
                await lobbyRef.child('chat').push({
                    sender: 'System',
                    message: `${playerProfile.username || currentUser.displayName} joined the lobby`,
                    timestamp: Date.now()
                });
                
                currentLobbyId = lobbyId;
                
                // Setup active lobby view
                await lobbyRef.once('value', (snapshot) => {
                    setupActiveLobby(lobbyId, snapshot.val());
                });
                
                showFloatingText('Joined Lobby!', canvas.width / 2, 100, '#5abaaa');
                
            } catch (error) {
                console.error('Error joining lobby:', error);
                showFloatingText('Failed to join lobby', canvas.width / 2, 100, '#ff4444');
            }
        }
        
        // Setup active lobby view
        function setupActiveLobby(lobbyId, lobbyData) {
            showActiveLobbyView();
            
            document.getElementById('activeLobbyName').textContent = lobbyData.name;
            document.getElementById('activeLobbyMaxPlayers').textContent = lobbyData.maxPlayers;
            
            // Show start button only for leader
            const isLeader = currentUser && lobbyData.leaderId === currentUser.uid;
            document.getElementById('startRaidBtn').style.display = isLeader ? 'block' : 'none';
            
            // Setup real-time listeners
            setupLobbyListeners(lobbyId);
        }
        
        // Setup real-time listeners for lobby
        function setupLobbyListeners(lobbyId) {
            if (!database) return;
            
            // Clean up existing listeners
            cleanupLobbyListeners();
            
            const lobbyRef = database.ref(`raidLobbies/${lobbyId}`);
            
            // Listen for member changes
            lobbyListeners.members = lobbyRef.child('members').on('value', (snapshot) => {
                const members = snapshot.val() || {};
                updateLobbyMembers(members);
            });
            
            // Listen for chat messages
            lobbyListeners.chat = lobbyRef.child('chat').on('child_added', (snapshot) => {
                const message = snapshot.val();
                addChatMessage(message);
            });
            
            // Listen for lobby deletion
            lobbyListeners.lobby = lobbyRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // Lobby was deleted
                    showFloatingText('Lobby was closed', canvas.width / 2, 100, '#ff4444');
                    currentLobbyId = null;
                    cleanupLobbyListeners();
                    showLobbyListView();
                    loadAvailableLobbies();
                }
            });
        }
        
        // Clean up lobby listeners
        function cleanupLobbyListeners() {
            if (!database || !currentLobbyId) return;
            
            const lobbyRef = database.ref(`raidLobbies/${currentLobbyId}`);
            
            if (lobbyListeners.members) {
                lobbyRef.child('members').off('value', lobbyListeners.members);
            }
            if (lobbyListeners.chat) {
                lobbyRef.child('chat').off('child_added', lobbyListeners.chat);
            }
            if (lobbyListeners.lobby) {
                lobbyRef.off('value', lobbyListeners.lobby);
            }
            
            lobbyListeners = {};
        }
        
        // Update lobby members display
        function updateLobbyMembers(members) {
            const membersList = document.getElementById('activeLobbyMembersList');
            const memberCount = Object.keys(members).length;
            
            document.getElementById('activeLobbyPlayerCount').textContent = memberCount;
            
            membersList.innerHTML = '';
            
            Object.entries(members).forEach(([userId, member]) => {
                const memberCard = document.createElement('div');
                memberCard.className = `member-card ${member.isLeader ? 'leader' : ''}`;
                memberCard.innerHTML = `
                    <div class="member-name">${member.username}</div>
                    <div class="member-role ${member.isLeader ? 'leader' : ''}">
                        ${member.isLeader ? 'ðŸ‘‘ Leader' : 'âš”ï¸ Member'}
                    </div>
                    <div style="color: #8a9aaa; font-size: 12px; margin-top: 5px;">
                        Total Level: ${member.totalLevel}
                    </div>
                `;
                membersList.appendChild(memberCard);
            });
        }
        
        // Add chat message
        function addChatMessage(message) {
            const chatDiv = document.getElementById('lobbyChat');
            const messageEl = document.createElement('div');
            messageEl.className = 'lobby-chat-message';
            messageEl.innerHTML = `
                <span class="lobby-chat-sender">${message.sender}:</span> ${message.message}
            `;
            chatDiv.appendChild(messageEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
        
        // Send chat message
        document.getElementById('sendChatBtn').addEventListener('click', async () => {
            const input = document.getElementById('lobbyChatInput');
            const message = input.value.trim();
            
            if (!message || !currentLobbyId || !database) return;
            
            try {
                await database.ref(`raidLobbies/${currentLobbyId}/chat`).push({
                    sender: playerProfile.username || currentUser.displayName,
                    message: message,
                    timestamp: Date.now()
                });
                
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        });
        
        // Allow Enter key to send message
        document.getElementById('lobbyChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendChatBtn').click();
            }
        });
        
        // Leave lobby
        document.getElementById('leaveLobbyBtn').addEventListener('click', async () => {
            if (!currentLobbyId || !database || !currentUser) return;
            
            try {
                const lobbyRef = database.ref(`raidLobbies/${currentLobbyId}`);
                const snapshot = await lobbyRef.once('value');
                const lobby = snapshot.val();
                
                if (!lobby) return;
                
                const isLeader = lobby.leaderId === currentUser.uid;
                
                // Remove player from lobby
                await lobbyRef.child(`members/${currentUser.uid}`).remove();
                
                // Add leave message
                await lobbyRef.child('chat').push({
                    sender: 'System',
                    message: `${playerProfile.username || currentUser.displayName} left the lobby`,
                    timestamp: Date.now()
                });
                
                // If leader leaves, delete the lobby
                if (isLeader) {
                    await lobbyRef.remove();
                    showFloatingText('Lobby Closed', canvas.width / 2, 100, '#ffaa66');
                } else {
                    showFloatingText('Left Lobby', canvas.width / 2, 100, '#5abaaa');
                }
                
                cleanupLobbyListeners();
                currentLobbyId = null;
                showLobbyListView();
                loadAvailableLobbies();
                
            } catch (error) {
                console.error('Error leaving lobby:', error);
                showFloatingText('Failed to leave lobby', canvas.width / 2, 100, '#ff4444');
            }
        });
        
        // Invite player
        document.getElementById('invitePlayerBtn').addEventListener('click', async () => {
            const input = document.getElementById('invitePlayerInput');
            const username = input.value.trim();
            const statusEl = document.getElementById('inviteStatus');
            
            if (!username || !currentLobbyId || !database) {
                statusEl.textContent = 'Please enter a valid username';
                statusEl.style.color = '#ff4444';
                return;
            }
            
            try {
                // Find player by username
                const usersRef = database.ref('users');
                const snapshot = await usersRef.orderByChild('username').equalTo(username).once('value');
                const users = snapshot.val();
                
                if (!users || Object.keys(users).length === 0) {
                    statusEl.textContent = `Player "${username}" not found`;
                    statusEl.style.color = '#ff4444';
                    return;
                }
                
                const targetUserId = Object.keys(users)[0];
                
                // Send invitation
                await database.ref(`invitations/${targetUserId}`).push({
                    type: 'raid_lobby',
                    lobbyId: currentLobbyId,
                    from: playerProfile.username || currentUser.displayName,
                    fromId: currentUser.uid,
                    timestamp: Date.now()
                });
                
                statusEl.textContent = `Invitation sent to ${username}!`;
                statusEl.style.color = '#5abaaa';
                input.value = '';
                
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
                
            } catch (error) {
                console.error('Error sending invitation:', error);
                statusEl.textContent = 'Failed to send invitation';
                statusEl.style.color = '#ff4444';
            }
        });
        
        // Start raid (placeholder)
        document.getElementById('startRaidBtn').addEventListener('click', () => {
            showFloatingText('Raid system coming soon!', canvas.width / 2, 100, '#ffaa66');
            // In the future, this will actually start the raid
        });
        
        // View lobby details
        function viewLobbyDetails(lobbyId) {
            // For now, just join the lobby to view
            joinLobby(lobbyId);
        }
        
        // Make functions globally accessible
        window.joinLobby = joinLobby;
        window.viewLobbyDetails = viewLobbyDetails;
        
        // ==================== END RAID LOBBY SYSTEM ====================

        // ==================== HOUSING/BUILDING SYSTEM ====================
        
        // Building cost definitions
        const buildingCosts = {
            house: [
                { tier: 1, planks: { amount: 500, tier: 1, rarity: 'common' }, bars: { amount: 500, tier: 1, rarity: 'common' } },
                { tier: 2, planks: { amount: 1000, tier: 2, rarity: 'common' }, bars: { amount: 1000, tier: 2, rarity: 'common' } },
                { tier: 3, planks: { amount: 1500, tier: 3, rarity: 'common' }, bars: { amount: 1500, tier: 3, rarity: 'common' } },
                { tier: 4, planks: { amount: 2000, tier: 4, rarity: 'common' }, bars: { amount: 2000, tier: 4, rarity: 'common' } },
                { tier: 5, planks: { amount: 2500, tier: 5, rarity: 'common' }, bars: { amount: 2500, tier: 5, rarity: 'common' } }
            ],
            trainingDummy: [
                { 
                    tier: 1, 
                    planks: [
                        { amount: 20, tier: 1, rarity: 'uncommon' },
                        { amount: 10, tier: 1, rarity: 'rare' },
                        { amount: 5, tier: 1, rarity: 'epic' },
                        { amount: 1, tier: 1, rarity: 'perfect' }
                    ],
                    bars: [
                        { amount: 20, tier: 1, rarity: 'uncommon' },
                        { amount: 10, tier: 1, rarity: 'rare' },
                        { amount: 5, tier: 1, rarity: 'epic' },
                        { amount: 1, tier: 1, rarity: 'perfect' }
                    ]
                },
                { 
                    tier: 2, 
                    planks: [
                        { amount: 40, tier: 2, rarity: 'uncommon' },
                        { amount: 20, tier: 2, rarity: 'rare' },
                        { amount: 10, tier: 2, rarity: 'epic' },
                        { amount: 2, tier: 2, rarity: 'perfect' }
                    ],
                    bars: [
                        { amount: 40, tier: 2, rarity: 'uncommon' },
                        { amount: 20, tier: 2, rarity: 'rare' },
                        { amount: 10, tier: 2, rarity: 'epic' },
                        { amount: 2, tier: 2, rarity: 'perfect' }
                    ]
                },
                { 
                    tier: 3, 
                    planks: [
                        { amount: 80, tier: 3, rarity: 'uncommon' },
                        { amount: 40, tier: 3, rarity: 'rare' },
                        { amount: 20, tier: 3, rarity: 'epic' },
                        { amount: 4, tier: 3, rarity: 'perfect' }
                    ],
                    bars: [
                        { amount: 80, tier: 3, rarity: 'uncommon' },
                        { amount: 40, tier: 3, rarity: 'rare' },
                        { amount: 20, tier: 3, rarity: 'epic' },
                        { amount: 4, tier: 3, rarity: 'perfect' }
                    ]
                },
                { 
                    tier: 4, 
                    planks: [
                        { amount: 160, tier: 4, rarity: 'uncommon' },
                        { amount: 80, tier: 4, rarity: 'rare' },
                        { amount: 40, tier: 4, rarity: 'epic' },
                        { amount: 8, tier: 4, rarity: 'perfect' }
                    ],
                    bars: [
                        { amount: 160, tier: 4, rarity: 'uncommon' },
                        { amount: 80, tier: 4, rarity: 'rare' },
                        { amount: 40, tier: 4, rarity: 'epic' },
                        { amount: 8, tier: 4, rarity: 'perfect' }
                    ]
                },
                { 
                    tier: 5, 
                    planks: [
                        { amount: 320, tier: 5, rarity: 'uncommon' },
                        { amount: 160, tier: 5, rarity: 'rare' },
                        { amount: 80, tier: 5, rarity: 'epic' },
                        { amount: 16, tier: 5, rarity: 'perfect' }
                    ],
                    bars: [
                        { amount: 320, tier: 5, rarity: 'uncommon' },
                        { amount: 160, tier: 5, rarity: 'rare' },
                        { amount: 80, tier: 5, rarity: 'epic' },
                        { amount: 16, tier: 5, rarity: 'perfect' }
                    ]
                }
            ]
        };

        // Rarity colors
        const rarityColors = {
            'common': '#ffffff',
            'uncommon': '#1eff00',
            'rare': '#0070dd',
            'epic': '#a335ee',
            'perfect': '#FFD700'
        };

        // Open/Close Housing Modal
        document.getElementById('buildMenuItem').addEventListener('click', () => {
            document.getElementById('housingModal').style.display = 'block';
            populateHousingUI();
        });

        document.getElementById('closeHousingBtn').addEventListener('click', () => {
            document.getElementById('housingModal').style.display = 'none';
            resetUIPosition('housingModal');
        });

        // Populate Housing UI
        function populateHousingUI() {
            const housesGrid = document.getElementById('housesGrid');
            const dummiesGrid = document.getElementById('dummiesGrid');
            
            housesGrid.innerHTML = '';
            dummiesGrid.innerHTML = '';

            // Populate Houses
            for (let i = 0; i < 5; i++) {
                const tier = i + 1;
                const isBuilt = gameState.buildings.house >= tier;
                const isLocked = gameState.buildings.house < tier - 1;
                const canBuild = gameState.buildings.house === tier - 1;
                
                const card = createBuildingCard('house', tier, isBuilt, isLocked, canBuild);
                housesGrid.appendChild(card);
            }

            // Populate Training Dummies
            for (let i = 0; i < 5; i++) {
                const tier = i + 1;
                const isBuilt = gameState.buildings.trainingDummy >= tier;
                const isLocked = gameState.buildings.trainingDummy < tier - 1;
                const canBuild = gameState.buildings.trainingDummy === tier - 1;
                
                const card = createBuildingCard('trainingDummy', tier, isBuilt, isLocked, canBuild);
                dummiesGrid.appendChild(card);
            }
        }

        // Create Building Card
        function createBuildingCard(buildingType, tier, isBuilt, isLocked, canBuild) {
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(135deg, #2a3a4a 0%, #1a2a3a 100%);
                border: 2px solid ${isBuilt ? '#5abaaa' : isLocked ? '#4a3a3a' : '#3a4a5a'};
                border-radius: 10px;
                padding: 20px;
                transition: all 0.3s;
                opacity: ${isLocked ? '0.5' : '1'};
                position: relative;
            `;

            const icon = buildingType === 'house' ? 'ðŸ ' : 'ðŸŽ¯';
            const name = buildingType === 'house' ? 'House' : 'Training Dummy';
            
            // Status badge
            let statusBadge = '';
            if (isBuilt) {
                statusBadge = '<div style="position: absolute; top: 10px; right: 10px; background: #4a8a5a; color: #6afa6a; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold;">BUILT</div>';
            } else if (isLocked) {
                statusBadge = '<div style="position: absolute; top: 10px; right: 10px; background: #8a4a4a; color: #fa6a6a; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold;">LOCKED</div>';
            }

            // Get current progress
            const progressKey = buildingType === 'house' ? 'houseProgress' : 'trainingDummyProgress';
            const progress = gameState.buildings[progressKey][tier - 1];
            
            // Build costs with progress bars and sliders
            const costs = buildingCosts[buildingType][tier - 1];
            let costsHTML = '';

            if (buildingType === 'house') {
                const plankProgress = (progress.planks / costs.planks.amount) * 100;
                const barProgress = (progress.bars / costs.bars.amount) * 100;
                
                // Check available materials
                const planksAvailable = countMaterialsInInventory('plank', costs.planks.tier, costs.planks.rarity);
                const barsAvailable = countMaterialsInInventory('bar', costs.bars.tier, costs.bars.rarity);
                const planksNeeded = Math.max(0, costs.planks.amount - progress.planks);
                const barsNeeded = Math.max(0, costs.bars.amount - progress.bars);
                const maxPlanks = Math.min(planksAvailable, planksNeeded);
                const maxBars = Math.min(barsAvailable, barsNeeded);
                
                costsHTML = `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a3a4a;">
                        <div style="color: #8a9aaa; font-size: 14px; margin-bottom: 10px; font-weight: bold;">Required Materials:</div>
                        
                        <!-- Planks -->
                        <div style="margin-bottom: 12px;">
                            <div style="color: ${rarityColors[costs.planks.rarity]}; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between;">
                                <span>ðŸ“ T${costs.planks.tier}+ Common Planks</span>
                                <span>${progress.planks}/${costs.planks.amount}</span>
                            </div>
                            <div style="background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                                <div style="background: linear-gradient(90deg, #4a9a8a, #5abaaa); height: 100%; width: ${plankProgress}%; transition: width 0.3s;"></div>
                            </div>
                            ${!isBuilt && planksNeeded > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="color: #8a9aaa; font-size: 12px;">Available: ${planksAvailable}</span>
                                        <span style="color: #5abaaa; font-size: 12px;">Contribute: <span id="plank-amount-${tier}">${maxPlanks}</span></span>
                                    </div>
                                    <input type="range" id="plank-slider-${buildingType}-${tier}" 
                                        min="0" max="${maxPlanks}" value="${maxPlanks}" 
                                        oninput="document.getElementById('plank-amount-${tier}').textContent = this.value"
                                        style="width: 100%; height: 6px; background: #1a2a3a; border-radius: 3px; outline: none; cursor: pointer;">
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Bars -->
                        <div style="margin-bottom: 8px;">
                            <div style="color: ${rarityColors[costs.bars.rarity]}; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between;">
                                <span>âš™ï¸ T${costs.bars.tier}+ Common Bars</span>
                                <span>${progress.bars}/${costs.bars.amount}</span>
                            </div>
                            <div style="background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                                <div style="background: linear-gradient(90deg, #4a9a8a, #5abaaa); height: 100%; width: ${barProgress}%; transition: width 0.3s;"></div>
                            </div>
                            ${!isBuilt && barsNeeded > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="color: #8a9aaa; font-size: 12px;">Available: ${barsAvailable}</span>
                                        <span style="color: #5abaaa; font-size: 12px;">Contribute: <span id="bar-amount-${tier}">${maxBars}</span></span>
                                    </div>
                                    <input type="range" id="bar-slider-${buildingType}-${tier}" 
                                        min="0" max="${maxBars}" value="${maxBars}" 
                                        oninput="document.getElementById('bar-amount-${tier}').textContent = this.value"
                                        style="width: 100%; height: 6px; background: #1a2a3a; border-radius: 3px; outline: none; cursor: pointer;">
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                // Training Dummy with multiple rarities, progress bars, and sliders
                costsHTML = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a3a4a;">';
                costsHTML += '<div style="color: #8a9aaa; font-size: 14px; margin-bottom: 10px; font-weight: bold;">Required Materials:</div>';
                
                // Planks
                costs.planks.forEach((req, idx) => {
                    const progressKey = `${req.rarity}Planks`;
                    const currentProgress = progress[progressKey] || 0;
                    const progressPercent = (currentProgress / req.amount) * 100;
                    const available = countMaterialsInInventory('plank', req.tier, req.rarity);
                    const needed = Math.max(0, req.amount - currentProgress);
                    const maxAmount = Math.min(available, needed);
                    
                    costsHTML += `
                        <div style="margin-bottom: 12px;">
                            <div style="color: ${rarityColors[req.rarity]}; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between;">
                                <span>ðŸ“ T${req.tier}+ ${req.rarity.charAt(0).toUpperCase() + req.rarity.slice(1)} Planks</span>
                                <span>${currentProgress}/${req.amount}</span>
                            </div>
                            <div style="background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                                <div style="background: linear-gradient(90deg, ${rarityColors[req.rarity]}, ${rarityColors[req.rarity]}); height: 100%; width: ${progressPercent}%; transition: width 0.3s; opacity: 0.8;"></div>
                            </div>
                            ${!isBuilt && needed > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="color: #8a9aaa; font-size: 12px;">Available: ${available}</span>
                                        <span style="color: #5abaaa; font-size: 12px;">Contribute: <span id="${req.rarity}-plank-amount-${tier}">${maxAmount}</span></span>
                                    </div>
                                    <input type="range" id="${req.rarity}-plank-slider-${buildingType}-${tier}" 
                                        min="0" max="${maxAmount}" value="${maxAmount}" 
                                        oninput="document.getElementById('${req.rarity}-plank-amount-${tier}').textContent = this.value"
                                        style="width: 100%; height: 6px; background: #1a2a3a; border-radius: 3px; outline: none; cursor: pointer;">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Bars
                costs.bars.forEach((req, idx) => {
                    const progressKey = `${req.rarity}Bars`;
                    const currentProgress = progress[progressKey] || 0;
                    const progressPercent = (currentProgress / req.amount) * 100;
                    const available = countMaterialsInInventory('bar', req.tier, req.rarity);
                    const needed = Math.max(0, req.amount - currentProgress);
                    const maxAmount = Math.min(available, needed);
                    
                    costsHTML += `
                        <div style="margin-bottom: 12px;">
                            <div style="color: ${rarityColors[req.rarity]}; font-size: 13px; margin-bottom: 5px; display: flex; justify-content: space-between;">
                                <span>âš™ï¸ T${req.tier}+ ${req.rarity.charAt(0).toUpperCase() + req.rarity.slice(1)} Bars</span>
                                <span>${currentProgress}/${req.amount}</span>
                            </div>
                            <div style="background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 4px; height: 8px; overflow: hidden; margin-bottom: 8px;">
                                <div style="background: linear-gradient(90deg, ${rarityColors[req.rarity]}, ${rarityColors[req.rarity]}); height: 100%; width: ${progressPercent}%; transition: width 0.3s; opacity: 0.8;"></div>
                            </div>
                            ${!isBuilt && needed > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="color: #8a9aaa; font-size: 12px;">Available: ${available}</span>
                                        <span style="color: #5abaaa; font-size: 12px;">Contribute: <span id="${req.rarity}-bar-amount-${tier}">${maxAmount}</span></span>
                                    </div>
                                    <input type="range" id="${req.rarity}-bar-slider-${buildingType}-${tier}" 
                                        min="0" max="${maxAmount}" value="${maxAmount}" 
                                        oninput="document.getElementById('${req.rarity}-bar-amount-${tier}').textContent = this.value"
                                        style="width: 100%; height: 6px; background: #1a2a3a; border-radius: 3px; outline: none; cursor: pointer;">
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                costsHTML += '</div>';
            }

            // Build/Contribute button
            let buttonHTML = '';
            if (!isBuilt && !isLocked) {
                buttonHTML = `
                    <button onclick="contributeMaterials('${buildingType}', ${tier})" style="
                        width: 100%;
                        padding: 12px;
                        background: linear-gradient(135deg, #4a9a8a, #3a8a7a);
                        color: white;
                        border: 2px solid #5abaaa;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                        margin-top: 15px;
                        transition: all 0.3s;
                    ">
                        ðŸ”¨ Contribute Materials
                    </button>
                `;
            }

            card.innerHTML = `
                ${statusBadge}
                <div style="font-size: 40px; text-align: center; margin-bottom: 10px;">${icon}</div>
                <div style="color: #fff; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 5px;">${name} Tier ${tier}</div>
                <div style="color: #8a9aaa; font-size: 13px; text-align: center; margin-bottom: 10px;">
                    ${isBuilt ? 'Construction Complete' : isLocked ? 'Complete previous tier first' : 'In Progress'}
                </div>
                ${costsHTML}
                ${buttonHTML}
            `;

            return card;
        }

        // Contribute Materials Function
        window.contributeMaterials = function(buildingType, tier) {
            const costs = buildingCosts[buildingType][tier - 1];
            const progressKey = buildingType === 'house' ? 'houseProgress' : 'trainingDummyProgress';
            const progress = gameState.buildings[progressKey][tier - 1];
            
            let contributedAny = false;
            let contributedItems = [];

            if (buildingType === 'house') {
                // Get slider values
                const plankSlider = document.getElementById(`plank-slider-${buildingType}-${tier}`);
                const barSlider = document.getElementById(`bar-slider-${buildingType}-${tier}`);
                
                // Contribute planks
                const planksToContribute = plankSlider ? parseInt(plankSlider.value) : 0;
                if (planksToContribute > 0) {
                    removeMaterialsFromInventory('plank', costs.planks.tier, costs.planks.rarity, planksToContribute);
                    progress.planks += planksToContribute;
                    contributedItems.push(`${planksToContribute} Planks`);
                    contributedAny = true;
                }

                // Contribute bars
                const barsToContribute = barSlider ? parseInt(barSlider.value) : 0;
                if (barsToContribute > 0) {
                    removeMaterialsFromInventory('bar', costs.bars.tier, costs.bars.rarity, barsToContribute);
                    progress.bars += barsToContribute;
                    contributedItems.push(`${barsToContribute} Bars`);
                    contributedAny = true;
                }

                // Check if building is complete
                if (progress.planks >= costs.planks.amount && progress.bars >= costs.bars.amount) {
                    gameState.buildings[buildingType] = tier;
                    showFloatingText(`ðŸ  House Tier ${tier} Complete!`, canvas.width / 2, 100, '#5abaaa');
                } else if (contributedAny) {
                    showFloatingText(`Added: ${contributedItems.join(', ')}`, canvas.width / 2, 100, '#5abaaa');
                } else {
                    showFloatingText('No materials selected to contribute', canvas.width / 2, 100, '#ff4444');
                }

            } else {
                // Training Dummy - contribute each rarity using slider values
                costs.planks.forEach(req => {
                    const progressKey = `${req.rarity}Planks`;
                    const slider = document.getElementById(`${req.rarity}-plank-slider-${buildingType}-${tier}`);
                    const toContribute = slider ? parseInt(slider.value) : 0;
                    
                    if (toContribute > 0) {
                        removeMaterialsFromInventory('plank', req.tier, req.rarity, toContribute);
                        progress[progressKey] = (progress[progressKey] || 0) + toContribute;
                        contributedItems.push(`${toContribute} ${req.rarity} Planks`);
                        contributedAny = true;
                    }
                });

                costs.bars.forEach(req => {
                    const progressKey = `${req.rarity}Bars`;
                    const slider = document.getElementById(`${req.rarity}-bar-slider-${buildingType}-${tier}`);
                    const toContribute = slider ? parseInt(slider.value) : 0;
                    
                    if (toContribute > 0) {
                        removeMaterialsFromInventory('bar', req.tier, req.rarity, toContribute);
                        progress[progressKey] = (progress[progressKey] || 0) + toContribute;
                        contributedItems.push(`${toContribute} ${req.rarity} Bars`);
                        contributedAny = true;
                    }
                });

                // Check if building is complete
                let allComplete = true;
                costs.planks.forEach(req => {
                    const progressKey = `${req.rarity}Planks`;
                    if ((progress[progressKey] || 0) < req.amount) allComplete = false;
                });
                costs.bars.forEach(req => {
                    const progressKey = `${req.rarity}Bars`;
                    if ((progress[progressKey] || 0) < req.amount) allComplete = false;
                });

                if (allComplete) {
                    gameState.buildings[buildingType] = tier;
                    showFloatingText(`ðŸŽ¯ Training Dummy Tier ${tier} Complete!`, canvas.width / 2, 100, '#5abaaa');
                } else if (contributedAny) {
                    showFloatingText(`Added: ${contributedItems.join(', ')}`, canvas.width / 2, 100, '#5abaaa');
                } else {
                    showFloatingText('No materials selected to contribute', canvas.width / 2, 100, '#ff4444');
                }
            }

            // Save and refresh
            if (contributedAny) {
                // Update inventory first
                updateInventoryDisplay();
                
                // Immediately refresh housing UI to show new progress
                populateHousingUI();
                
                // Save after UI update
                saveGame();
            }
        };

        // Count materials in inventory
        function countMaterialsInInventory(materialType, minTier, rarity) {
            let count = 0;
            gameState.player.inventory.forEach(item => {
                if (item && item.name && item.name.toLowerCase().includes(materialType)) {
                    // Check if tier meets minimum requirement
                    if (item.tier >= minTier) {
                        // Check if rarity matches (or is better)
                        const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'perfect'];
                        const itemRarityIndex = rarityOrder.indexOf(item.rarity);
                        const requiredRarityIndex = rarityOrder.indexOf(rarity);
                        
                        if (itemRarityIndex >= requiredRarityIndex) {
                            // Add the quantity of this stack to the count
                            count += (item.quantity || 1);
                        }
                    }
                }
            });
            return count;
        }

        // Remove materials from inventory
        function removeMaterialsFromInventory(materialType, minTier, rarity, amount) {
            let removed = 0;
            for (let i = gameState.player.inventory.length - 1; i >= 0 && removed < amount; i--) {
                const item = gameState.player.inventory[i];
                if (item && item.name && item.name.toLowerCase().includes(materialType)) {
                    if (item.tier >= minTier) {
                        const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'perfect'];
                        const itemRarityIndex = rarityOrder.indexOf(item.rarity);
                        const requiredRarityIndex = rarityOrder.indexOf(rarity);
                        
                        if (itemRarityIndex >= requiredRarityIndex) {
                            // Calculate how many to remove from this stack
                            const itemQuantity = item.quantity || 1;
                            const toRemove = Math.min(itemQuantity, amount - removed);
                            
                            if (toRemove >= itemQuantity) {
                                // Remove entire stack
                                gameState.player.inventory.splice(i, 1);
                                removed += itemQuantity;
                            } else {
                                // Decrement quantity
                                item.quantity -= toRemove;
                                removed += toRemove;
                            }
                        }
                    }
                }
            }
        }

        // Ensure buildings exist in gameState (backwards compatibility)
        if (!gameState.buildings) {
            gameState.buildings = {
                house: 0,
                trainingDummy: 0,
                houseProgress: [
                    { planks: 0, bars: 0 },
                    { planks: 0, bars: 0 },
                    { planks: 0, bars: 0 },
                    { planks: 0, bars: 0 },
                    { planks: 0, bars: 0 }
                ],
                trainingDummyProgress: [
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                    { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }
                ]
            };
        }
        
        // Add progress tracking if missing
        if (!gameState.buildings.houseProgress) {
            gameState.buildings.houseProgress = [
                { planks: 0, bars: 0 },
                { planks: 0, bars: 0 },
                { planks: 0, bars: 0 },
                { planks: 0, bars: 0 },
                { planks: 0, bars: 0 }
            ];
        }
        if (!gameState.buildings.trainingDummyProgress) {
            gameState.buildings.trainingDummyProgress = [
                { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 },
                { uncommonPlanks: 0, rarePlanks: 0, epicPlanks: 0, perfectPlanks: 0, uncommonBars: 0, rareBars: 0, epicBars: 0, perfectBars: 0 }
            ];
        }

        // ==================== END HOUSING/BUILDING SYSTEM ====================

        // ==================== SAVE/LOAD SYSTEM ====================
        
        function saveGame() {
            try {
                const saveData = {
                    player: gameState.player,
                    buildings: gameState.buildings,
                    currentRoom: gameState.currentRoom,
                    afkMode: gameState.afkMode,
                    activityTracker: gameState.activityTracker,
                    clueScrolls: gameState.clueScrolls
                };
                localStorage.setItem('mmorpgSave', JSON.stringify(saveData));
                console.log('Game saved successfully');
            } catch (error) {
                console.error('Error saving game:', error);
            }
        }
        
        function loadGame() {
            try {
                const savedData = localStorage.getItem('mmorpgSave');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Restore player data
                    if (data.player) {
                        gameState.player.gold = data.player.gold || 0;
                        gameState.player.inventory = data.player.inventory || [];
                        gameState.player.skills = data.player.skills || gameState.player.skills;
                        gameState.player.skillXP = data.player.skillXP || gameState.player.skillXP;
                        gameState.player.equipment = data.player.equipment || gameState.player.equipment;
                        gameState.player.inventorySize = data.player.inventorySize || 98;
                    }
                    
                    // Restore buildings
                    if (data.buildings) {
                        gameState.buildings = data.buildings;
                    }
                    
                    // Restore room
                    if (data.currentRoom) {
                        gameState.currentRoom = data.currentRoom;
                    }
                    
                    // Restore AFK mode
                    if (data.afkMode !== undefined) {
                        gameState.afkMode = data.afkMode;
                    }
                    
                    // Restore clue scrolls
                    if (data.clueScrolls) {
                        gameState.clueScrolls = data.clueScrolls;
                        
                        // Restore checkFn functions for each tier's steps
                        // Functions can't be saved to localStorage, so we need to re-attach them
                        const taskPools = {
                            'T1': T1_CLUE_TASKS,
                            'T2': T2_CLUE_TASKS,
                            'T3': T3_CLUE_TASKS,
                            'T4': T4_CLUE_TASKS,
                            'T5': T5_CLUE_TASKS
                        };
                        
                        ['T1', 'T2', 'T3', 'T4', 'T5'].forEach(tier => {
                            if (gameState.clueScrolls[tier] && gameState.clueScrolls[tier].steps) {
                                gameState.clueScrolls[tier].steps.forEach(step => {
                                    // Find matching task from pool and restore checkFn
                                    const matchingTask = taskPools[tier].find(t => t.task === step.task);
                                    if (matchingTask) {
                                        step.checkFn = matchingTask.checkFn;
                                    }
                                });
                            }
                        });
                    }
                    
                    console.log('Game loaded successfully');
                    return true;
                }
            } catch (error) {
                console.error('Error loading game:', error);
            }
            return false;
        }
        
        // Auto-save every 30 seconds
        setInterval(() => {
            saveGame();
        }, 30000);
        
        // Save when page is about to unload
        window.addEventListener('beforeunload', () => {
            saveGame();
        });
        
        // ==================== END SAVE/LOAD SYSTEM ====================

        // ==================== DRAGGABLE UI SYSTEM ====================
        
        // Store default positions for UI elements
        const defaultPositions = {
            inventoryUI: { top: null, left: null, transform: null },
            grandExchangeModal: { top: null, left: null, transform: null },
            profileModal: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
            housingModal: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
            raidLobbyModal: { top: null, left: null, transform: null }
        };
        
        // Make an element draggable by its header
        function makeDraggable(elementId, handleSelector) {
            const element = document.getElementById(elementId);
            const handle = element.querySelector(handleSelector);
            
            if (!element || !handle) return;
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            
            // Add draggable cursor to handle
            handle.style.cursor = 'move';
            
            handle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                // Don't drag if clicking on buttons
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                // Get current position
                const rect = element.getBoundingClientRect();
                initialX = e.clientX - rect.left;
                initialY = e.clientY - rect.top;
                
                isDragging = true;
                handle.style.cursor = 'grabbing';
                
                // Remove transform and set fixed position
                element.style.transform = 'none';
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                // Keep element within viewport
                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                currentX = Math.max(0, Math.min(currentX, maxX));
                currentY = Math.max(0, Math.min(currentY, maxY));
                
                element.style.left = currentX + 'px';
                element.style.top = currentY + 'px';
            }
            
            function dragEnd() {
                if (!isDragging) return;
                
                isDragging = false;
                handle.style.cursor = 'move';
            }
        }
        
        // Reset UI element to default position
        function resetUIPosition(elementId) {
            const element = document.getElementById(elementId);
            const defaults = defaultPositions[elementId];
            
            if (element && defaults) {
                element.style.top = defaults.top;
                element.style.left = defaults.left;
                element.style.transform = defaults.transform;
            }
        }
        
        // Initialize draggable UIs after DOM is ready
        setTimeout(() => {
            // Make inventory draggable
            makeDraggable('inventoryUI', '.inv-header');
            
            // Make grand exchange draggable
            makeDraggable('grandExchangeModal', '.ge-header');
            
            // Raid lobby NOT draggable (disabled to prevent glitches)
            // makeDraggable('raidLobbyModal', '.lobby-header');
            
            // Make profile draggable - find the header div
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                const profileHeader = profileModal.children[0];
                if (profileHeader) {
                    makeDraggableByElement('profileModal', profileHeader);
                }
            }
            
            // Housing NOT draggable (disabled to prevent glitches)
            // const housingModal = document.getElementById('housingModal');
            // if (housingModal) {
            //     const housingHeader = housingModal.querySelector('div > div:first-child');
            //     if (housingHeader) {
            //         makeDraggableByElement('housingModal', housingHeader);
            //     }
            // }
        }, 100);
        
        // Make element draggable by passing element directly
        function makeDraggableByElement(elementId, handle) {
            const element = document.getElementById(elementId);
            
            if (!element || !handle) return;
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            
            // Add draggable cursor to handle
            handle.style.cursor = 'move';
            
            handle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                // Don't drag if clicking on buttons
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                // Get current position
                const rect = element.getBoundingClientRect();
                initialX = e.clientX - rect.left;
                initialY = e.clientY - rect.top;
                
                isDragging = true;
                handle.style.cursor = 'grabbing';
                
                // Remove transform and set fixed position
                element.style.transform = 'none';
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                // Keep element within viewport
                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                currentX = Math.max(0, Math.min(currentX, maxX));
                currentY = Math.max(0, Math.min(currentY, maxY));
                
                element.style.left = currentX + 'px';
                element.style.top = currentY + 'px';
            }
            
            function dragEnd() {
                if (!isDragging) return;
                
                isDragging = false;
                handle.style.cursor = 'move';
            }
        }
        
        // ==================== AMMUNITION CRAFTING SYSTEM ====================
        
        // Close crafting modal
        document.getElementById('closeCraftingModal').addEventListener('click', () => {
            document.getElementById('ammunitionCraftingModal').style.display = 'none';
        });
        
        // Close smithwright modal
        document.getElementById('closeSmithwrightModal').addEventListener('click', () => {
            document.getElementById('smithwrightModal').style.display = 'none';
        });
        
        // Auto Craft All - Smithwright
        document.getElementById('autoCraftAllSmithwright').addEventListener('click', () => {
            autoCraftAllSmithwright();
        });
        
        // Hover effects for Auto Craft All Smithwright button
        const autoCraftSmithBtn = document.getElementById('autoCraftAllSmithwright');
        autoCraftSmithBtn.addEventListener('mouseenter', () => {
            autoCraftSmithBtn.style.background = '#3a8a7a';
        });
        autoCraftSmithBtn.addEventListener('mouseleave', () => {
            autoCraftSmithBtn.style.background = '#4a9a8a';
        });
        
        // Auto Craft All - Crafting
        document.getElementById('autoCraftAllCrafting').addEventListener('click', () => {
            autoCraftAllCrafting();
        });
        
        // Hover effects for Auto Craft All Crafting button
        const autoCraftCraftBtn = document.getElementById('autoCraftAllCrafting');
        autoCraftCraftBtn.addEventListener('mouseenter', () => {
            autoCraftCraftBtn.style.background = '#3a8a7a';
        });
        autoCraftCraftBtn.addEventListener('mouseleave', () => {
            autoCraftCraftBtn.style.background = '#4a9a8a';
        });
        
        // Close combat modal
        // Close button hover effects
        const closeCombatBtn = document.getElementById('closeCombatModal');
        closeCombatBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1) rotate(90deg)';
            this.style.background = 'linear-gradient(135deg, #ff7b7b, #ff6565)';
        });
        closeCombatBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1) rotate(0deg)';
            this.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5555)';
        });
        
        closeCombatBtn.addEventListener('click', () => {
            document.getElementById('combatModal').style.display = 'none';
        });
        
        // Combat Prep Modal Event Listeners
        
        // Back button - return to zone selection
        const backBtn = document.getElementById('backToCombatZonesBtn');
        backBtn.addEventListener('click', () => {
            document.getElementById('combatPrepModal').style.display = 'none';
            document.getElementById('combatModal').style.display = 'block';
            showFloatingText('Back to zone selection', canvas.width / 2, 100, '#5abaaa');
        });
        
        // Back button hover effects
        backBtn.addEventListener('mouseover', () => {
            backBtn.style.background = 'rgba(255, 107, 107, 0.5)';
            backBtn.style.transform = 'translateX(-3px)';
        });
        backBtn.addEventListener('mouseout', () => {
            backBtn.style.background = 'rgba(255, 107, 107, 0.3)';
            backBtn.style.transform = 'translateX(0)';
        });
        
        // Leave button
        document.getElementById('leavePrepBtn').addEventListener('click', () => {
            document.getElementById('combatPrepModal').style.display = 'none';
            selectedMonsterData = null;
            selectedZone = null;
            gameState.selectedZone = null;
            showFloatingText('Combat cancelled', canvas.width / 2, 100, '#ff6b6b');
        });
        
        // Create party button
        document.getElementById('createPartyBtn').addEventListener('click', () => {
            showFloatingText('Party system coming soon!', canvas.width / 2, 100, '#5abaaa');
        });
        
        // Fight button - actually start combat
        document.getElementById('startFightBtn').addEventListener('click', () => {
            startActualCombat();
        });
        
        // Eat threshold slider
        const eatThresholdSlider = document.getElementById('eatThresholdSlider');
        const eatThresholdValue = document.getElementById('eatThresholdValue');
        
        eatThresholdSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            eatThresholdValue.textContent = value + '%';
            
            // Update slider gradient
            e.target.style.background = `linear-gradient(90deg, #3a4a5a 0%, #5abaaa ${value}%, #3a4a5a ${value}%)`;
        });
        
        // Store eat threshold in gameState if not exists
        if (!gameState.combat.eatThreshold) {
            gameState.combat.eatThreshold = 87;
        }
        
        eatThresholdSlider.addEventListener('change', (e) => {
            gameState.combat.eatThreshold = parseInt(e.target.value);
            saveGame();
        });
        
        // Attack style selection
        document.querySelectorAll('.attack-style-option').forEach(option => {
            option.addEventListener('click', () => {
                // Check if this style is disabled
                if (option.dataset.disabled === 'true') {
                    const combatStyle = option.dataset.combatStyle;
                    if (combatStyle === 'ranged') {
                        showFloatingText('Equip a bow and arrows first!', canvas.width / 2, 150, '#ff6b6b');
                    } else if (combatStyle === 'magic') {
                        showFloatingText('Equip a staff or wand first!', canvas.width / 2, 150, '#ff6b6b');
                    }
                    return;
                }
                
                const combatStyle = option.dataset.combatStyle;
                const attackStyle = option.dataset.attackStyle;
                
                // Update game state
                gameState.combat.combatStyle = combatStyle;
                gameState.combat.attackStyle = attackStyle;
                
                // Update visual selection
                document.querySelectorAll('.attack-style-option').forEach(opt => {
                    if (opt.dataset.disabled !== 'true') {
                        opt.style.background = 'rgba(42, 58, 74, 0.4)';
                        opt.style.borderColor = '#2a3a4a';
                        opt.querySelector('div:first-child').style.color = '#cad2da';
                    }
                });
                
                option.style.background = 'rgba(90, 186, 170, 0.2)';
                option.style.borderColor = '#5abaaa';
                option.querySelector('div:first-child').style.color = '#5abaaa';
                
                // Show floating text
                const styleNames = {
                    'accurate': 'Accurate',
                    'aggressive': 'Aggressive',
                    'controlled': 'Controlled',
                    'rapid': 'Rapid',
                    'longrange': 'Longrange'
                };
                showFloatingText(`${combatStyle.toUpperCase()}: ${styleNames[attackStyle]}`, canvas.width / 2, 150, '#5abaaa');
                
                // Save game
                saveGame();
            });
            
            // Hover effects
            option.addEventListener('mouseover', () => {
                if (option.dataset.disabled !== 'true' && option.style.borderColor !== 'rgb(90, 186, 170)') {
                    option.style.borderColor = '#4a6a7a';
                }
            });
            
            option.addEventListener('mouseout', () => {
                if (option.dataset.disabled !== 'true' && option.style.borderColor !== 'rgb(90, 186, 170)') {
                    option.style.borderColor = '#2a3a4a';
                }
            });
        });
        
        // Update material counts in crafting UI
        function updateCraftingMaterialCounts() {
            const inventory = gameState.player.inventory;
            
            // Count materials by tier
            const materialCounts = {
                'ore-t1': 0, 'ore-t2': 0, 'ore-t3': 0, 'ore-t4': 0, 'ore-t5': 0,
                'logs-t1': 0, 'logs-t2': 0, 'logs-t3': 0, 'logs-t4': 0, 'logs-t5': 0
            };
            
            inventory.forEach(item => {
                if (!item) return;
                const quantity = item.quantity || 1;
                
                // Check for ore
                if (item.name.includes('Ore')) {
                    if (item.name.includes('T1')) materialCounts['ore-t1'] += quantity;
                    else if (item.name.includes('T2')) materialCounts['ore-t2'] += quantity;
                    else if (item.name.includes('T3')) materialCounts['ore-t3'] += quantity;
                    else if (item.name.includes('T4')) materialCounts['ore-t4'] += quantity;
                    else if (item.name.includes('T5')) materialCounts['ore-t5'] += quantity;
                }
                // Check for logs
                if (item.name.includes('Log')) {
                    if (item.name.includes('T1')) materialCounts['logs-t1'] += quantity;
                    else if (item.name.includes('T2')) materialCounts['logs-t2'] += quantity;
                    else if (item.name.includes('T3')) materialCounts['logs-t3'] += quantity;
                    else if (item.name.includes('T4')) materialCounts['logs-t4'] += quantity;
                    else if (item.name.includes('T5')) materialCounts['logs-t5'] += quantity;
                }
            });
            
            // Update UI
            document.querySelectorAll('.material-count').forEach(el => {
                const material = el.dataset.material;
                const count = materialCounts[material] || 0;
                el.querySelector('span').textContent = count;
                
                // Color code based on availability
                if (count >= 1) {
                    el.style.color = '#5abaaa'; // Green - can craft
                } else {
                    el.style.color = '#ff4444'; // Red - no materials
                }
            });
            
            // Enable/disable craft buttons based on materials and level
            document.querySelectorAll('.craft-arrow-btn').forEach(btn => {
                const tier = parseInt(btn.dataset.tier);
                const hasOre = materialCounts[`ore-t${tier}`] >= 1;
                const hasLogs = materialCounts[`logs-t${tier}`] >= 1;
                const craftingLevel = gameState.player.skills.crafting || 1;
                
                // Level requirements: 1, 10, 20, 40, 60
                const levelReqs = [1, 10, 20, 40, 60];
                const meetsLevel = craftingLevel >= levelReqs[tier - 1];
                
                if (hasOre && hasLogs && meetsLevel) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    
                    if (!meetsLevel) {
                        btn.title = `Requires Crafting level ${levelReqs[tier - 1]}`;
                    } else {
                        btn.title = 'Insufficient materials';
                    }
                }
            });
        }
        
        // Craft arrows - Navigate to crafting zone (CRAFT ALL)
        // Auto Craft All Crafting - intelligently crafts all available arrows
        function autoCraftAllCrafting() {
            const inventory = gameState.player.inventory;
            const craftingLevel = gameState.player.skills.crafting || 1;
            const levelReqs = [1, 10, 20, 40, 60]; // T1-T5 requirements
            
            // Count materials for each tier
            const tierMaterials = {};
            for (let tier = 1; tier <= 5; tier++) {
                tierMaterials[tier] = {
                    ore: 0,
                    logs: 0
                };
            }
            
            // Scan inventory for materials
            inventory.forEach(item => {
                if (!item || !item.name) return;
                
                for (let tier = 1; tier <= 5; tier++) {
                    if (item.name.includes(`T${tier}`)) {
                        if (item.name.includes('Ore')) {
                            tierMaterials[tier].ore += (item.quantity || 1);
                        } else if (item.name.includes('Log')) {
                            tierMaterials[tier].logs += (item.quantity || 1);
                        }
                        break;
                    }
                }
            });
            
            // Create crafting queue for all available tiers
            if (!gameState.craftingQueue) {
                gameState.craftingQueue = [];
            } else {
                // Clear existing queue
                gameState.craftingQueue = [];
            }
            
            let totalArrows = 0;
            for (let tier = 1; tier <= 5; tier++) {
                // Check level requirement
                if (craftingLevel < levelReqs[tier - 1]) continue;
                
                // Calculate craftable arrows (limited by whichever material is less)
                const arrowsTocraft = Math.min(tierMaterials[tier].ore, tierMaterials[tier].logs);
                
                if (arrowsTocraft > 0) {
                    // Add to queue
                    for (let i = 0; i < arrowsTocraft; i++) {
                        gameState.craftingQueue.push({
                            type: 'arrow',
                            tier: tier,
                            timestamp: Date.now()
                        });
                    }
                    totalArrows += arrowsTocraft;
                }
            }
            
            if (totalArrows === 0) {
                showFloatingText('No materials found to craft arrows!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Close modal and navigate to crafting room
            document.getElementById('ammunitionCraftingModal').style.display = 'none';
            
            gameState.currentRoom = 'crafting';
            generateTiles();
            initializeRoomObjects();
            document.getElementById('currentRoom').textContent = rooms['crafting'].name;
            
            // Visual feedback
            showFloatingText(`Auto-crafting ${totalArrows} arrows across all tiers!`, canvas.width / 2, 100, '#d4a76a');
            
            // Automatically select the first crafting node and start walking
            const room = rooms[gameState.currentRoom];
            if (room.objects) {
                const craftingNodes = room.objects.filter(obj => 
                    obj.type === 'workbench' || obj.type === 'anvil' || obj.type === 'forge'
                );
                
                if (craftingNodes.length > 0) {
                    // Find the closest node
                    let closestNode = craftingNodes[0];
                    let closestDistance = Infinity;
                    
                    craftingNodes.forEach(node => {
                        const dx = node.x - gameState.player.x;
                        const dy = node.y - gameState.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestNode = node;
                        }
                    });
                    
                    // Set as target and start walking
                    gameState.player.currentTarget = closestNode;
                    gameState.player.targetX = closestNode.x;
                    gameState.player.targetY = closestNode.y;
                }
            }
            
            // Particles
            for (let i = 0; i < 15; i++) {
                gameState.particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 100,
                    y: 100 + (Math.random() - 0.5) * 50,
                    size: 6,
                    color: '#d4a76a',
                    speed: 2.5,
                    alpha: 1
                });
            }
        }
        
        function craftArrows(tier) {
            const craftingLevel = gameState.player.skills.crafting || 1;
            const levelReqs = [1, 10, 20, 40, 60];
            
            // Check level requirement
            if (craftingLevel < levelReqs[tier - 1]) {
                showFloatingText(`Need Crafting level ${levelReqs[tier - 1]}!`, canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Count available materials
            const inventory = gameState.player.inventory;
            let oreCount = 0;
            let logsCount = 0;
            
            inventory.forEach((item) => {
                if (!item) return;
                
                if (item.name.includes(`T${tier}`) && item.name.includes('Ore')) {
                    oreCount += (item.quantity || 1);
                }
                
                if (item.name.includes(`T${tier}`) && item.name.includes('Log')) {
                    logsCount += (item.quantity || 1);
                }
            });
            
            // Calculate how many arrows can be crafted (limited by whichever material is less)
            const arrowsTocraft = Math.min(oreCount, logsCount);
            
            if (arrowsTocraft < 1) {
                showFloatingText('Insufficient materials!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Store crafting jobs for when player reaches crafting nodes
            if (!gameState.craftingQueue) {
                gameState.craftingQueue = [];
            }
            
            // Add all arrows to crafting queue
            for (let i = 0; i < arrowsTocraft; i++) {
                gameState.craftingQueue.push({
                    type: 'arrow',
                    tier: tier,
                    timestamp: Date.now()
                });
            }
            
            // Close crafting modal
            document.getElementById('ammunitionCraftingModal').style.display = 'none';
            
            // Navigate to crafting room
            gameState.currentRoom = 'crafting';
            generateTiles();
            initializeRoomObjects();
            document.getElementById('currentRoom').textContent = rooms['crafting'].name;
            
            // Visual feedback
            showFloatingText(`Travel to crafting nodes to craft ${arrowsTocraft}x T${tier} Arrows!`, canvas.width / 2, 100, '#5abaaa');
            
            // Automatically select the first crafting node and start walking
            const room = rooms[gameState.currentRoom];
            if (room.objects) {
                const craftingNodes = room.objects.filter(obj => 
                    obj.type === 'workbench' || obj.type === 'anvil' || obj.type === 'forge'
                );
                
                if (craftingNodes.length > 0) {
                    // Find the closest node
                    let closestNode = craftingNodes[0];
                    let closestDistance = Infinity;
                    
                    craftingNodes.forEach(node => {
                        const dx = node.x - gameState.player.x;
                        const dy = node.y - gameState.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestNode = node;
                        }
                    });
                    
                    // Set as target and start walking
                    gameState.player.currentTarget = closestNode;
                    gameState.player.targetX = closestNode.x;
                    gameState.player.targetY = closestNode.y;
                }
            }
            
            // Particles
            for (let i = 0; i < 10; i++) {
                gameState.particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 80,
                    y: 100 + (Math.random() - 0.5) * 40,
                    size: 5,
                    color: '#5abaaa',
                    speed: 2,
                    alpha: 1
                });
            }
        }
        
        // Add event listeners to craft buttons
        document.querySelectorAll('.craft-arrow-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tier = parseInt(btn.dataset.tier);
                craftArrows(tier);
            });
        });
        
        // Hover effects for arrow cards
        document.querySelectorAll('.arrow-craft-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 20px rgba(90, 186, 170, 0.3)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });
        
        // ==================== END AMMUNITION CRAFTING SYSTEM ====================
        
        // ==================== JEWELRY/AMULET CRAFTING SYSTEM ====================
        
        // Tab switching for crafting modal
        document.querySelectorAll('.craft-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update tab styles
                document.querySelectorAll('.craft-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.6';
                    t.style.borderBottom = 'none';
                    t.style.background = 'transparent';
                });
                tab.classList.add('active');
                tab.style.color = '#5abaaa';
                tab.style.opacity = '1';
                tab.style.borderBottom = '3px solid #5abaaa';
                tab.style.background = 'rgba(90, 186, 170, 0.1)';
                
                // Hide all tab contents
                document.querySelectorAll('.craft-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show selected tab content
                if (tabName === 'ammunition') {
                    document.getElementById('ammunitionTab').style.display = 'block';
                    updateCraftingMaterialCounts(); // Update ammunition materials
                } else if (tabName === 'amulets') {
                    document.getElementById('amuletsTab').style.display = 'block';
                    populateAmuletsContent(1); // Load T1 amulets by default
                } else if (tabName === 'rings') {
                    document.getElementById('ringsTab').style.display = 'block';
                    populateRingsContent(1); // Load T1 rings by default
                }
                // Add other tabs here as needed
            });
        });
        
        // Update jewelry material counts
        function updateJewelryMaterialCounts() {
            const inventory = gameState.player.inventory;
            const materialCounts = {
                'emerald-t1': 0, 'emerald-t2': 0, 'emerald-t3': 0, 'emerald-t4': 0, 'emerald-t5': 0,
                'bar-t1': 0, 'bar-t2': 0, 'bar-t3': 0, 'bar-t4': 0, 'bar-t5': 0
            };
            
            inventory.forEach((item) => {
                if (!item) return;
                
                // Count emeralds
                if (item.name.includes('Emerald')) {
                    if (item.name.includes('T1')) materialCounts['emerald-t1'] += (item.quantity || 1);
                    else if (item.name.includes('T2')) materialCounts['emerald-t2'] += (item.quantity || 1);
                    else if (item.name.includes('T3')) materialCounts['emerald-t3'] += (item.quantity || 1);
                    else if (item.name.includes('T4')) materialCounts['emerald-t4'] += (item.quantity || 1);
                    else if (item.name.includes('T5')) materialCounts['emerald-t5'] += (item.quantity || 1);
                }
                
                // Count bars (from smithwright)
                if (item.name.includes('Bar')) {
                    if (item.name.includes('T1')) materialCounts['bar-t1'] += (item.quantity || 1);
                    else if (item.name.includes('T2')) materialCounts['bar-t2'] += (item.quantity || 1);
                    else if (item.name.includes('T3')) materialCounts['bar-t3'] += (item.quantity || 1);
                    else if (item.name.includes('T4')) materialCounts['bar-t4'] += (item.quantity || 1);
                    else if (item.name.includes('T5')) materialCounts['bar-t5'] += (item.quantity || 1);
                }
            });
            
            // Update material count displays
            document.querySelectorAll('.amulet-craft-card').forEach(card => {
                const tier = parseInt(card.dataset.tier);
                const emeraldCount = card.querySelector('.material-count[data-material="emerald-t' + tier + '"] span');
                const barCount = card.querySelector('.material-count[data-material="bar-t' + tier + '"] span');
                
                if (emeraldCount) emeraldCount.textContent = materialCounts[`emerald-t${tier}`];
                if (barCount) barCount.textContent = materialCounts[`bar-t${tier}`];
            });
            
            // Update material count colors (green if have, red if don't)
            document.querySelectorAll('.amulet-craft-card .material-count').forEach(el => {
                const count = parseInt(el.querySelector('span').textContent);
                if (count > 0) {
                    el.style.color = '#5abaaa'; // Green - have materials
                } else {
                    el.style.color = '#ff4444'; // Red - no materials
                }
            });
            
            // Enable/disable craft buttons based on materials and level
            document.querySelectorAll('.craft-amulet-btn').forEach(btn => {
                const tier = parseInt(btn.dataset.tier);
                const emeraldsNeeded = Math.pow(2, tier - 1); // 1, 2, 4, 8, 16
                const barsNeeded = 5 * Math.pow(2, tier - 1); // 5, 10, 20, 40, 80
                const hasEmeralds = materialCounts[`emerald-t${tier}`] >= emeraldsNeeded;
                const hasBars = materialCounts[`bar-t${tier}`] >= barsNeeded;
                const craftingLevel = gameState.player.skills.crafting || 1;
                
                // Level requirements: 1, 20, 40, 60, 80
                const levelReqs = [1, 20, 40, 60, 80];
                const meetsLevel = craftingLevel >= levelReqs[tier - 1];
                
                if (hasEmeralds && hasBars && meetsLevel) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    
                    if (!meetsLevel) {
                        btn.title = `Requires Crafting level ${levelReqs[tier - 1]}`;
                    } else {
                        btn.title = 'Insufficient materials';
                    }
                }
            });
        }
        
        // Craft amulet
        function craftAmulet(tier) {
            const craftingLevel = gameState.player.skills.crafting || 1;
            const levelReqs = [1, 20, 40, 60, 80];
            
            // Check level requirement
            if (craftingLevel < levelReqs[tier - 1]) {
                showFloatingText(`Need Crafting level ${levelReqs[tier - 1]}!`, canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Count available materials
            const inventory = gameState.player.inventory;
            const emeraldsNeeded = Math.pow(2, tier - 1); // 1, 2, 4, 8, 16
            const barsNeeded = 5 * Math.pow(2, tier - 1); // 5, 10, 20, 40, 80
            let emeraldCount = 0;
            let barCount = 0;
            let barRarity = null; // Track the rarity of bars found
            
            inventory.forEach((item) => {
                if (!item) return;
                
                if (item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                    emeraldCount += (item.quantity || 1);
                }
                
                if (item.name.includes(`T${tier}`) && item.name.includes('Bar')) {
                    barCount += (item.quantity || 1);
                    // Extract rarity from bar name (e.g., "T1 Common Bar")
                    if (!barRarity && item.rarity) {
                        barRarity = item.rarity;
                    }
                }
            });
            
            // Check if have enough materials
            if (emeraldCount < emeraldsNeeded || barCount < barsNeeded) {
                showFloatingText('Insufficient materials!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Consume materials
            let emeraldsConsumed = 0;
            let barsConsumed = 0;
            
            // Remove emeralds
            for (let i = inventory.length - 1; i >= 0 && emeraldsConsumed < emeraldsNeeded; i--) {
                const item = inventory[i];
                if (item && item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                    const toConsume = Math.min((item.quantity || 1), emeraldsNeeded - emeraldsConsumed);
                    if (item.quantity && item.quantity > toConsume) {
                        item.quantity -= toConsume;
                    } else {
                        inventory.splice(i, 1);
                    }
                    emeraldsConsumed += toConsume;
                }
            }
            
            // Remove bars and determine amulet rarity
            for (let i = inventory.length - 1; i >= 0 && barsConsumed < barsNeeded; i--) {
                const item = inventory[i];
                if (item && item.name.includes(`T${tier}`) && item.name.includes('Bar')) {
                    const toConsume = Math.min((item.quantity || 1), barsNeeded - barsConsumed);
                    if (item.quantity && item.quantity > toConsume) {
                        item.quantity -= toConsume;
                    } else {
                        inventory.splice(i, 1);
                    }
                    barsConsumed += toConsume;
                }
            }
            
            // Create amulet with rarity based on bars used
            const rarityName = barRarity || 'common';
            const rarityData = getRarityData(rarityName);
            const xpGained = [10, 20, 40, 80, 160][tier - 1] * (rarityData ? rarityData.multiplier : 1);
            
            const amulet = {
                name: `T${tier} ${rarityData ? rarityData.name : 'Common'} Amulet`,
                icon: 'ðŸ“¿',
                tier: tier,
                rarity: rarityName,
                rarityColor: rarityData ? rarityData.color : '#ffffff',
                stackable: true,
                type: 'jewelry',
                slot: 'amulet' // For future equipment system
            };
            
            // Add amulet to inventory
            addToInventory(amulet);
            
            // Grant XP
            gameState.player.skillXP.crafting = (gameState.player.skillXP.crafting || 0) + xpGained;
            checkLevelUp('crafting');
            
            // Close crafting modal
            document.getElementById('ammunitionCraftingModal').style.display = 'none';
            
            // Visual feedback
            showFloatingText(`Crafted ${amulet.name}! +${xpGained} XP`, canvas.width / 2, 100, rarityData ? rarityData.color : '#5abaaa');
            
            // Particles
            for (let i = 0; i < 15; i++) {
                gameState.particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 80,
                    y: 100 + (Math.random() - 0.5) * 40,
                    size: 5,
                    color: rarityData ? rarityData.color : '#5abaaa',
                    speed: 2,
                    alpha: 1
                });
            }
            
            // Update inventory and material counts
            initInventory();
            updateJewelryMaterialCounts();
            saveGame();
        }
        
        // Helper function to get rarity data
        function getRarityData(rarityKey) {
            const rarities = {
                'common': { name: 'Common', color: '#ffffff', multiplier: 1 },
                'uncommon': { name: 'Uncommon', color: '#4caf50', multiplier: 1.5 },
                'rare': { name: 'Rare', color: '#2196f3', multiplier: 2 },
                'epic': { name: 'Epic', color: '#9c27b0', multiplier: 3 },
                'perfect': { name: 'Perfect', color: '#ffd700', multiplier: 5 }
            };
            return rarities[rarityKey] || rarities['common'];
        }
        
        // Add event listeners to amulet craft buttons
        document.querySelectorAll('.craft-amulet-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tier = parseInt(btn.dataset.tier);
                craftAmulet(tier);
            });
        });
        
        // Hover effects for amulet cards
        document.querySelectorAll('.amulet-craft-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 20px rgba(90, 186, 170, 0.3)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });
        
        // ==================== END JEWELRY/AMULET CRAFTING SYSTEM ====================
        
        // ==================== SMITHWRIGHT SYSTEM ====================
        
        // Quality colors and level requirements
        const smithQualityData = {
            'Common': { color: '#9e9e9e', levelReq: 0, xpMult: 1, successChance: 1.0 },
            'Uncommon': { color: '#4caf50', levelReq: 0, xpMult: 1.5, successChance: 0.85 },
            'Rare': { color: '#2196f3', levelReq: 0, xpMult: 2, successChance: 0.70 },
            'Epic': { color: '#9c27b0', levelReq: 0, xpMult: 3, successChance: 0.50 },
            'Perfect': { color: '#ffd700', levelReq: 0, xpMult: 5, successChance: 0.30 }
        };
        
        const smithTierData = {
            1: { name: 'T1', levelReq: 1, baseXP: 5, baseTime: 2700 },
            2: { name: 'T2', levelReq: 20, baseXP: 10, baseTime: 3200 },
            3: { name: 'T3', levelReq: 40, baseXP: 20, baseTime: 3700 },
            4: { name: 'T4', levelReq: 60, baseXP: 30, baseTime: 4200 },
            5: { name: 'T5', levelReq: 80, baseXP: 40, baseTime: 4700 }
        };
        
        // Current smithwright selection
        let currentSmithCategory = 'bars';
        let currentSmithTier = 1;
        
        // Populate smithwright content based on category and tier
        function populateSmithwrightContent(category, tier) {
            currentSmithCategory = category;
            currentSmithTier = tier;
            
            const content = document.getElementById('smithwrightContent');
            const qualities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Perfect'];
            
            content.innerHTML = '';
            
            // Create grid
            const grid = document.createElement('div');
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;';
            
            // Handle jewelry category differently
            if (category === 'jewelry') {
                qualities.forEach(quality => {
                    const card = createJewelryCard(tier, quality);
                    grid.appendChild(card);
                });
            } else {
                qualities.forEach(quality => {
                    const card = createSmithwrightCard(category, tier, quality);
                    grid.appendChild(card);
                });
            }
            
            content.appendChild(grid);
        }
        
        // Create a smithwright crafting card
        function createSmithwrightCard(category, tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            const itemType = category === 'bars' ? 'Bar' : 'Plank';
            const sourceType = category === 'bars' ? 'Ore' : 'Log';
            
            // Get the sprite URL for this item
            const spriteKey = `${category === 'bars' ? 'bar' : 'plank'}_T${tier}_${quality}`;
            const spriteUrl = spriteUrls[spriteKey] || '';
            
            const card = document.createElement('div');
            card.className = 'smith-craft-card';
            card.style.cssText = `
                background: linear-gradient(135deg, ${qualityData.color}33, ${qualityData.color}22);
                border: 2px solid ${qualityData.color};
                border-radius: 10px;
                padding: 20px;
                position: relative;
                transition: all 0.3s;
                cursor: pointer;
            `;
            
            // Check if player meets level requirement
            const playerLevel = gameState.player.skills.smithwright || 1;
            const canCraft = playerLevel >= tierData.levelReq;
            
            if (!canCraft) {
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
            }
            
            // Get material count - count from inventory array (must match tier AND rarity)
            let materialCount = 0;
            
            gameState.player.inventory.forEach(item => {
                if (item && item.name && item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes(sourceType)) {
                    materialCount += (item.quantity || 1);
                }
            });
            
            card.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center; height: 80px;">
                        <img src="${spriteUrl}" alt="${quality} ${itemType}" style="max-width: 80px; max-height: 80px; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 48px;\\'>${category === 'bars' ? 'ðŸ”©' : 'ðŸªµ'}</div>';">
                    </div>
                    <div style="color: ${qualityData.color}; font-size: 18px; font-weight: bold; margin-bottom: 5px;">${quality} ${itemType}</div>
                    <div style="color: #8a9aaa; font-size: 13px;">${tierData.name} - Level ${tierData.levelReq}+</div>
                    <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">${Math.round(tierData.baseXP * qualityData.xpMult)} XP / craft</div>
                    <div style="color: #d4a76a; font-size: 11px; margin-top: 2px;">${(qualityData.successChance * 100).toFixed(0)}% Success Rate</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Costs (Per Craft)</div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                        <span style="color: #cad2da;">${quality} ${tierData.name} ${sourceType}: 1</span>
                        <span style="color: ${materialCount > 0 ? '#5abaaa' : '#ff4444'};">(${materialCount})</span>
                    </div>
                </div>
                
                <button class="smith-craft-btn" 
                    data-category="${category}" 
                    data-tier="${tier}" 
                    data-quality="${quality}"
                    style="width: 100%; padding: 12px; background: ${canCraft && materialCount > 0 ? 'linear-gradient(135deg, #5abaaa, #4a9a8a)' : '#555'}; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: ${canCraft && materialCount > 0 ? 'pointer' : 'not-allowed'}; transition: all 0.3s;"
                    ${!canCraft || materialCount <= 0 ? 'disabled' : ''}>
                    ${!canCraft ? 'LOCKED' : materialCount <= 0 ? 'NO MATERIALS' : 'START CRAFTING'}
                </button>
            `;
            
            // Add click handler for the button
            if (canCraft && materialCount > 0) {
                const button = card.querySelector('.smith-craft-btn');
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    setSmithwrightActivity(category, tier, quality);
                });
                
                button.addEventListener('mouseenter', () => {
                    button.style.background = 'linear-gradient(135deg, #4a9a8a, #3a8a7a)';
                    button.style.transform = 'scale(1.02)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                    button.style.transform = 'scale(1)';
                });
            }
            
            return card;
        }
        
        // Auto Craft All Smithwright - intelligently crafts all available materials
        function autoCraftAllSmithwright() {
            const category = currentSmithCategory; // 'bars' or 'planks'
            const sourceType = category === 'bars' ? 'Ore' : 'Log';
            const inventory = gameState.player.inventory;
            
            // Collect all unique material types (tier + quality combos) from inventory
            const materialGroups = {};
            
            inventory.forEach(item => {
                if (!item || !item.name) return;
                
                // Look for ores or logs
                if (item.name.includes(sourceType)) {
                    // Extract tier (T1, T2, etc)
                    let tier = null;
                    for (let t = 1; t <= 5; t++) {
                        if (item.name.includes(`T${t}`)) {
                            tier = t;
                            break;
                        }
                    }
                    
                    // Extract quality
                    let quality = null;
                    const qualities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Perfect'];
                    for (const q of qualities) {
                        if (item.name.includes(q)) {
                            quality = q;
                            break;
                        }
                    }
                    
                    if (tier && quality) {
                        const key = `${tier}-${quality}`;
                        if (!materialGroups[key]) {
                            materialGroups[key] = {
                                tier: tier,
                                quality: quality,
                                count: 0
                            };
                        }
                        materialGroups[key].count += (item.quantity || 1);
                    }
                }
            });
            
            // Check if we have any materials
            const groupKeys = Object.keys(materialGroups);
            if (groupKeys.length === 0) {
                showFloatingText('No materials found!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Create a queue of smithwright activities
            if (!gameState.smithwrightQueue) {
                gameState.smithwrightQueue = [];
            }
            
            let totalJobs = 0;
            groupKeys.forEach(key => {
                const group = materialGroups[key];
                totalJobs += group.count;
                
                // Add to queue
                gameState.smithwrightQueue.push({
                    category: category,
                    tier: group.tier,
                    quality: group.quality,
                    count: group.count
                });
            });
            
            // Start the first smithwright activity
            if (gameState.smithwrightQueue.length > 0) {
                const firstJob = gameState.smithwrightQueue[0];
                setSmithwrightActivity(firstJob.category, firstJob.tier, firstJob.quality);
                
                showFloatingText(`Auto-crafting ${totalJobs} items (${groupKeys.length} types)!`, canvas.width / 2, 100, '#d4a76a');
            }
        }
        
        // Set smithwright activity (player selects what to craft)
        function setSmithwrightActivity(category, tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            const productType = category === 'bars' ? 'Bar' : 'Plank';
            
            // Store the activity settings
            gameState.smithwrightActivity = {
                category: category,
                tier: tier,
                quality: quality,
                active: true
            };
            
            // Close the modal
            document.getElementById('smithwrightModal').style.display = 'none';
            
            // Show confirmation
            showFloatingText(`Now crafting ${quality} ${tierData.name} ${productType}s - walking to nodes`, canvas.width / 2, 100, qualityData.color);
            
            // Automatically select the first crafting node and start walking
            const room = rooms[gameState.currentRoom];
            if (room.objects) {
                const craftingNodes = room.objects.filter(obj => 
                    obj.type === 'forge' || obj.type === 'anvil'
                );
                
                if (craftingNodes.length > 0) {
                    // Find the closest node
                    let closestNode = craftingNodes[0];
                    let closestDistance = Infinity;
                    
                    craftingNodes.forEach(node => {
                        const dx = node.x - gameState.player.x;
                        const dy = node.y - gameState.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestNode = node;
                        }
                    });
                    
                    // Set as target and start walking
                    gameState.player.currentTarget = closestNode;
                    gameState.player.targetX = closestNode.x;
                    gameState.player.targetY = closestNode.y;
                }
            }
            
            saveGame();
        }
        
        // Create amulet crafting card
        function createAmuletCard(tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            
            // Calculate requirements - doubles each tier
            const emeraldsNeeded = Math.pow(2, tier - 1); // T1=1, T2=2, T3=4, T4=8, T5=16
            const barsNeeded = emeraldsNeeded * 5; // T1=5, T2=10, T3=20, T4=40, T5=80
            
            const card = document.createElement('div');
            card.className = 'smith-craft-card';
            card.style.cssText = `
                background: linear-gradient(135deg, ${qualityData.color}33, ${qualityData.color}22);
                border: 2px solid ${qualityData.color};
                border-radius: 10px;
                padding: 20px;
                position: relative;
                transition: all 0.3s;
                cursor: pointer;
            `;
            
            // Check if player meets level requirement
            const playerLevel = gameState.player.skills.smithwright || 1;
            const canCraft = playerLevel >= tierData.levelReq;
            
            if (!canCraft) {
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
            }
            
            // Get material counts from inventory array
            let emeraldCount = 0;
            let barCount = 0;
            
            gameState.player.inventory.forEach(item => {
                if (item && item.name) {
                    if (item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                        emeraldCount += (item.quantity || 1);
                    }
                    if (item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                        barCount += (item.quantity || 1);
                    }
                }
            });
            
            const hasEnoughMaterials = emeraldCount >= emeraldsNeeded && barCount >= barsNeeded;
            
            // Get amulet image URL
            const amuletImageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Amulets/T${tier}%20${quality}%20Emerald%20Amulet.png`;
            
            card.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center; height: 80px;">
                        <img src="${amuletImageUrl}" alt="${quality} Amulet" style="max-width: 80px; max-height: 80px; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>ðŸ“¿</div>';">
                    </div>
                    <div style="color: ${qualityData.color}; font-size: 18px; font-weight: bold; margin-bottom: 5px;">${quality} Amulet</div>
                    <div style="color: #8a9aaa; font-size: 13px;">${tierData.name} - Level ${tierData.levelReq}+</div>
                    <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">${Math.round(tierData.baseXP * qualityData.xpMult * 2)} XP / craft</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Materials Required</div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                        <span style="color: #cad2da;">${tierData.name} Emerald: ${emeraldsNeeded}</span>
                        <span style="color: ${emeraldCount >= emeraldsNeeded ? '#5abaaa' : '#ff4444'};">(${emeraldCount})</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                        <span style="color: #cad2da;">${quality} ${tierData.name} Bars: ${barsNeeded}</span>
                        <span style="color: ${barCount >= barsNeeded ? '#5abaaa' : '#ff4444'};">(${barCount})</span>
                    </div>
                </div>
                
                <button class="amulet-craft-btn" 
                    data-tier="${tier}" 
                    data-quality="${quality}"
                    style="width: 100%; padding: 12px; background: ${canCraft && hasEnoughMaterials ? 'linear-gradient(135deg, #5abaaa, #4a9a8a)' : '#555'}; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: ${canCraft && hasEnoughMaterials ? 'pointer' : 'not-allowed'}; transition: all 0.3s;"
                    ${!canCraft || !hasEnoughMaterials ? 'disabled' : ''}>
                    ${!canCraft ? 'LOCKED' : !hasEnoughMaterials ? 'NEED MATERIALS' : 'CRAFT'}
                </button>
            `;
            
            // Add click handler for the button
            if (canCraft && hasEnoughMaterials) {
                const button = card.querySelector('.amulet-craft-btn');
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    craftAmulet(tier, quality);
                });
                
                button.addEventListener('mouseenter', () => {
                    button.style.background = 'linear-gradient(135deg, #4a9a8a, #3a8a7a)';
                    button.style.transform = 'scale(1.02)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                    button.style.transform = 'scale(1)';
                });
            }
            
            return card;
        }
        
        // Create ring crafting card
        function createRingCard(tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            
            // Calculate requirements - doubles each tier
            const emeraldsNeeded = Math.pow(2, tier - 1); // T1=1, T2=2, T3=4, T4=8, T5=16
            const barsNeeded = emeraldsNeeded * 5; // T1=5, T2=10, T3=20, T4=40, T5=80
            
            const card = document.createElement('div');
            card.className = 'smith-craft-card';
            card.style.cssText = `
                background: linear-gradient(135deg, ${qualityData.color}33, ${qualityData.color}22);
                border: 2px solid ${qualityData.color};
                border-radius: 10px;
                padding: 20px;
                position: relative;
                transition: all 0.3s;
                cursor: pointer;
            `;
            
            // Check if player meets level requirement
            const playerLevel = gameState.player.skills.smithwright || 1;
            const canCraft = playerLevel >= tierData.levelReq;
            
            if (!canCraft) {
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
            }
            
            // Get material counts from inventory array
            let emeraldCount = 0;
            let barCount = 0;
            
            gameState.player.inventory.forEach(item => {
                if (item && item.name) {
                    if (item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                        emeraldCount += (item.quantity || 1);
                    }
                    if (item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                        barCount += (item.quantity || 1);
                    }
                }
            });
            
            const hasEnoughMaterials = emeraldCount >= emeraldsNeeded && barCount >= barsNeeded;
            
            // Get ring image URL
            const ringImageUrl = `https://raw.githubusercontent.com/Graphic37/RPG/main/Rings/T${tier}%20${quality}%20Emerald%20Ring.png`;
            
            card.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="margin-bottom: 10px; display: flex; justify-content: center; align-items: center; height: 80px;">
                        <img src="${ringImageUrl}" alt="${quality} Ring" style="max-width: 80px; max-height: 80px; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 64px;\\'>ðŸ’</div>';">
                    </div>
                    <div style="color: ${qualityData.color}; font-size: 18px; font-weight: bold; margin-bottom: 5px;">${quality} Ring</div>
                    <div style="color: #8a9aaa; font-size: 13px;">${tierData.name} - Level ${tierData.levelReq}+</div>
                    <div style="color: #5abaaa; font-size: 12px; margin-top: 4px;">${Math.round(tierData.baseXP * qualityData.xpMult * 2)} XP / craft</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="color: #8a9aaa; font-size: 13px; font-weight: bold; margin-bottom: 8px;">Materials Required</div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px;">
                        <span style="color: #cad2da;">${tierData.name} Emerald: ${emeraldsNeeded}</span>
                        <span style="color: ${emeraldCount >= emeraldsNeeded ? '#5abaaa' : '#ff4444'};">(${emeraldCount})</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px;">
                        <span style="color: #cad2da;">${quality} ${tierData.name} Bars: ${barsNeeded}</span>
                        <span style="color: ${barCount >= barsNeeded ? '#5abaaa' : '#ff4444'};">(${barCount})</span>
                    </div>
                </div>
                
                <button class="ring-craft-btn" 
                    data-tier="${tier}" 
                    data-quality="${quality}"
                    style="width: 100%; padding: 12px; background: ${canCraft && hasEnoughMaterials ? 'linear-gradient(135deg, #5abaaa, #4a9a8a)' : '#555'}; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: ${canCraft && hasEnoughMaterials ? 'pointer' : 'not-allowed'}; transition: all 0.3s;"
                    ${!canCraft || !hasEnoughMaterials ? 'disabled' : ''}>
                    ${!canCraft ? 'LOCKED' : !hasEnoughMaterials ? 'NEED MATERIALS' : 'CRAFT'}
                </button>
            `;
            
            // Add click handler for the button
            if (canCraft && hasEnoughMaterials) {
                const button = card.querySelector('.ring-craft-btn');
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    craftRing(tier, quality);
                });
                
                button.addEventListener('mouseenter', () => {
                    button.style.background = 'linear-gradient(135deg, #4a9a8a, #3a8a7a)';
                    button.style.transform = 'scale(1.02)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                    button.style.transform = 'scale(1)';
                });
            }
            
            return card;
        }
        
        // Craft amulet
        function craftAmulet(tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            
            // Calculate requirements
            const emeraldsNeeded = Math.pow(2, tier - 1);
            const barsNeeded = emeraldsNeeded * 5;
            
            // Count available materials from inventory array
            let emeraldCount = 0;
            let barCount = 0;
            
            gameState.player.inventory.forEach(item => {
                if (item && item.name) {
                    if (item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                        emeraldCount += (item.quantity || 1);
                    }
                    if (item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                        barCount += (item.quantity || 1);
                    }
                }
            });
            
            if (emeraldCount < emeraldsNeeded || barCount < barsNeeded) {
                showFloatingText('Not enough materials!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Remove emeralds from inventory
            let emeraldsRemaining = emeraldsNeeded;
            for (let i = gameState.player.inventory.length - 1; i >= 0 && emeraldsRemaining > 0; i--) {
                const item = gameState.player.inventory[i];
                if (item && item.name && item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                    const toRemove = Math.min(item.quantity || 1, emeraldsRemaining);
                    if ((item.quantity || 1) > toRemove) {
                        item.quantity -= toRemove;
                    } else {
                        gameState.player.inventory.splice(i, 1);
                    }
                    emeraldsRemaining -= toRemove;
                }
            }
            
            // Remove bars from inventory
            let barsRemaining = barsNeeded;
            for (let i = gameState.player.inventory.length - 1; i >= 0 && barsRemaining > 0; i--) {
                const item = gameState.player.inventory[i];
                if (item && item.name && item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                    const toRemove = Math.min(item.quantity || 1, barsRemaining);
                    if ((item.quantity || 1) > toRemove) {
                        item.quantity -= toRemove;
                    } else {
                        gameState.player.inventory.splice(i, 1);
                    }
                    barsRemaining -= toRemove;
                }
            }
            
            // Add amulet to inventory
            const amuletName = `T${tier} ${quality} Emerald Amulet`;
            const existingAmulet = gameState.player.inventory.find(item => 
                item && item.name === amuletName
            );
            
            if (existingAmulet) {
                existingAmulet.quantity = (existingAmulet.quantity || 1) + 1;
            } else {
                gameState.player.inventory.push({
                    name: amuletName,
                    icon: 'ðŸ“¿',
                    tier: tier,
                    rarity: quality.toLowerCase(),
                    rarityColor: qualityData.color,
                    stackable: true,
                    quantity: 1,
                    type: 'jewelry',
                    slot: 'neck'
                });
            }
            
            // Add XP (doubled for jewelry)
            const xp = Math.round(tierData.baseXP * qualityData.xpMult * 2);
            addSkillXP('smithwright', xp);
            
            // Update UI
            updateInventoryUI();
            populateAmuletsContent(tier);
            
            // Show results
            showFloatingText(`Crafted ${quality} ${tierData.name} Amulet! +${xp} XP`, canvas.width / 2, 100, qualityData.color);
            
            saveGame();
        }
        
        // Craft ring
        function craftRing(tier, quality) {
            const qualityData = smithQualityData[quality];
            const tierData = smithTierData[tier];
            
            // Calculate requirements
            const emeraldsNeeded = Math.pow(2, tier - 1);
            const barsNeeded = emeraldsNeeded * 5;
            
            // Count available materials from inventory array
            let emeraldCount = 0;
            let barCount = 0;
            
            gameState.player.inventory.forEach(item => {
                if (item && item.name) {
                    if (item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                        emeraldCount += (item.quantity || 1);
                    }
                    if (item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                        barCount += (item.quantity || 1);
                    }
                }
            });
            
            if (emeraldCount < emeraldsNeeded || barCount < barsNeeded) {
                showFloatingText('Not enough materials!', canvas.width / 2, 100, '#ff4444');
                return;
            }
            
            // Remove emeralds from inventory
            let emeraldsRemaining = emeraldsNeeded;
            for (let i = gameState.player.inventory.length - 1; i >= 0 && emeraldsRemaining > 0; i--) {
                const item = gameState.player.inventory[i];
                if (item && item.name && item.name.includes(`T${tier}`) && item.name.includes('Emerald')) {
                    const toRemove = Math.min(item.quantity || 1, emeraldsRemaining);
                    if ((item.quantity || 1) > toRemove) {
                        item.quantity -= toRemove;
                    } else {
                        gameState.player.inventory.splice(i, 1);
                    }
                    emeraldsRemaining -= toRemove;
                }
            }
            
            // Remove bars from inventory
            let barsRemaining = barsNeeded;
            for (let i = gameState.player.inventory.length - 1; i >= 0 && barsRemaining > 0; i--) {
                const item = gameState.player.inventory[i];
                if (item && item.name && item.name.includes(`T${tier}`) && item.name.includes(quality) && item.name.includes('Bar')) {
                    const toRemove = Math.min(item.quantity || 1, barsRemaining);
                    if ((item.quantity || 1) > toRemove) {
                        item.quantity -= toRemove;
                    } else {
                        gameState.player.inventory.splice(i, 1);
                    }
                    barsRemaining -= toRemove;
                }
            }
            
            // Add ring to inventory
            const ringName = `T${tier} ${quality} Emerald Ring`;
            const existingRing = gameState.player.inventory.find(item => 
                item && item.name === ringName
            );
            
            if (existingRing) {
                existingRing.quantity = (existingRing.quantity || 1) + 1;
            } else {
                gameState.player.inventory.push({
                    name: ringName,
                    icon: 'ðŸ’',
                    tier: tier,
                    rarity: quality.toLowerCase(),
                    rarityColor: qualityData.color,
                    stackable: true,
                    quantity: 1,
                    type: 'jewelry',
                    slot: 'ring'
                });
            }
            
            // Add XP (doubled for jewelry)
            const xp = Math.round(tierData.baseXP * qualityData.xpMult * 2);
            addSkillXP('smithwright', xp);
            
            // Update UI
            updateInventoryUI();
            populateRingsContent(tier);
            
            // Show results
            showFloatingText(`Crafted ${quality} ${tierData.name} Ring! +${xp} XP`, canvas.width / 2, 100, qualityData.color);
            
            saveGame();
        }
        
        // Tab switching for main tabs (Bars vs Planks vs Jewelry)
        document.querySelectorAll('.smith-main-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const category = tab.dataset.category;
                
                // Update tab styles
                document.querySelectorAll('.smith-main-tab').forEach(t => {
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.6';
                    t.style.borderBottom = 'none';
                    t.style.background = 'transparent';
                });
                
                tab.style.color = '#5abaaa';
                tab.style.opacity = '1';
                tab.style.borderBottom = '3px solid #5abaaa';
                tab.style.background = 'rgba(90, 186, 170, 0.1)';
                
                // Update content
                populateSmithwrightContent(category, currentSmithTier);
            });
        });
        
        // Tab switching for tier tabs
        document.querySelectorAll('.smith-tier-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tier = parseInt(tab.dataset.tier);
                
                // Update tab styles
                document.querySelectorAll('.smith-tier-tab').forEach(t => {
                    t.style.background = 'rgba(90, 186, 170, 0.3)';
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.6';
                    t.style.border = '1px solid #3a4a5a';
                });
                
                tab.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                tab.style.color = 'white';
                tab.style.opacity = '1';
                tab.style.border = 'none';
                
                // Update content
                populateSmithwrightContent(currentSmithCategory, tier);
            });
        });
        
        // Tab switching for amulet tier tabs
        document.querySelectorAll('.amulet-tier-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tier = parseInt(tab.dataset.tier);
                
                // Update tab styles
                document.querySelectorAll('.amulet-tier-tab').forEach(t => {
                    t.style.background = 'rgba(90, 186, 170, 0.3)';
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.6';
                    t.style.border = '1px solid #3a4a5a';
                });
                
                tab.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                tab.style.color = 'white';
                tab.style.opacity = '1';
                tab.style.border = 'none';
                
                // Update content
                populateAmuletsContent(tier);
            });
        });
        
        // Tab switching for ring tier tabs
        document.querySelectorAll('.ring-tier-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tier = parseInt(tab.dataset.tier);
                
                // Update tab styles
                document.querySelectorAll('.ring-tier-tab').forEach(t => {
                    t.style.background = 'rgba(90, 186, 170, 0.3)';
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.6';
                    t.style.border = '1px solid #3a4a5a';
                });
                
                tab.style.background = 'linear-gradient(135deg, #5abaaa, #4a9a8a)';
                tab.style.color = 'white';
                tab.style.opacity = '1';
                tab.style.border = 'none';
                
                // Update content
                populateRingsContent(tier);
            });
        });
        
        // Populate amulets content for a specific tier
        function populateAmuletsContent(tier) {
            const content = document.getElementById('amuletsContent');
            const qualities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Perfect'];
            
            content.innerHTML = '';
            
            // Create grid
            const grid = document.createElement('div');
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;';
            
            qualities.forEach(quality => {
                const card = createAmuletCard(tier, quality);
                grid.appendChild(card);
            });
            
            content.appendChild(grid);
        }
        
        // Populate rings content for a specific tier
        function populateRingsContent(tier) {
            const content = document.getElementById('ringsContent');
            const qualities = ['Common', 'Uncommon', 'Rare', 'Epic', 'Perfect'];
            
            content.innerHTML = '';
            
            // Create grid
            const grid = document.createElement('div');
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;';
            
            qualities.forEach(quality => {
                const card = createRingCard(tier, quality);
                grid.appendChild(card);
            });
            
            content.appendChild(grid);
        }
        
        // ==================== END SMITHWRIGHT SYSTEM ====================
        
        // ==================== COMBAT ZONE SELECTION SYSTEM ====================
        
        // Monster data by zone
        const combatZones = {
            woods: {
                name: 'Woods',
                monsters: [
                    { name: 'Turkey', melee: 1, ranged: 0, defense: 0, health: 4, magic: 0, attackSpeed: 4, weakness: 'None', level: 1, xp: 10, gold: 5 },
                    { name: 'Fox', melee: 2, ranged: 3, defense: 3, health: 6, magic: 0, attackSpeed: 2.5, weakness: 'None', level: 3, xp: 15, gold: 8 },
                    { name: 'Wolf', melee: 5, ranged: 4, defense: 5, health: 8, magic: 0, attackSpeed: 2.5, weakness: 'None', level: 5, xp: 20, gold: 12 }
                ]
            },
            cave: {
                name: 'Cave',
                monsters: [
                    { name: 'Bat', melee: 3, ranged: 2, defense: 2, health: 5, magic: 0, attackSpeed: 2, weakness: 'Ranged', level: 4, xp: 18, gold: 10 },
                    { name: 'Spider', melee: 6, ranged: 0, defense: 4, health: 10, magic: 2, attackSpeed: 3, weakness: 'Magic', level: 7, xp: 25, gold: 15 },
                    { name: 'Cave Bear', melee: 10, ranged: 0, defense: 8, health: 15, magic: 0, attackSpeed: 3.5, weakness: 'Ranged', level: 10, xp: 35, gold: 25 }
                ]
            },
            wilderness: {
                name: 'Wilderness',
                monsters: [
                    { name: 'Boar', melee: 8, ranged: 0, defense: 6, health: 12, magic: 0, attackSpeed: 3, weakness: 'Ranged', level: 8, xp: 30, gold: 18 },
                    { name: 'Wild Dog', melee: 7, ranged: 5, defense: 5, health: 10, magic: 0, attackSpeed: 2, weakness: 'None', level: 9, xp: 32, gold: 20 },
                    { name: 'Lynx', melee: 12, ranged: 8, defense: 7, health: 14, magic: 0, attackSpeed: 2, weakness: 'Magic', level: 12, xp: 40, gold: 28 }
                ]
            },
            graveyard: {
                name: 'Haunted graveyard',
                monsters: [
                    { name: 'Zombie', melee: 10, ranged: 0, defense: 8, health: 18, magic: 0, attackSpeed: 4, weakness: 'Magic', level: 13, xp: 45, gold: 30 },
                    { name: 'Skeleton', melee: 15, ranged: 10, defense: 10, health: 16, magic: 5, attackSpeed: 3, weakness: 'Melee', level: 15, xp: 50, gold: 35 },
                    { name: 'Ghost', melee: 8, ranged: 12, defense: 5, health: 12, magic: 15, attackSpeed: 2, weakness: 'Magic', level: 18, xp: 60, gold: 42 }
                ]
            },
            uncharted: {
                name: 'Uncharted grounds',
                monsters: [
                    { name: 'Dire Wolf', melee: 18, ranged: 10, defense: 12, health: 20, magic: 0, attackSpeed: 2.5, weakness: 'Magic', level: 20, xp: 70, gold: 50 },
                    { name: 'Ogre', melee: 25, ranged: 0, defense: 18, health: 30, magic: 0, attackSpeed: 4, weakness: 'Ranged', level: 25, xp: 90, gold: 65 },
                    { name: 'Troll', melee: 22, ranged: 5, defense: 20, health: 35, magic: 8, attackSpeed: 3.5, weakness: 'Magic', level: 28, xp: 100, gold: 75 }
                ]
            },
            lair: {
                name: 'Lair of beasts',
                monsters: [
                    { name: 'Grizzly Bear', melee: 30, ranged: 0, defense: 22, health: 40, magic: 0, attackSpeed: 3, weakness: 'Ranged', level: 30, xp: 120, gold: 85 },
                    { name: 'Sabertooth', melee: 35, ranged: 15, defense: 25, health: 38, magic: 0, attackSpeed: 2, weakness: 'Magic', level: 35, xp: 150, gold: 100 },
                    { name: 'Wyvern', melee: 28, ranged: 40, defense: 28, health: 45, magic: 20, attackSpeed: 2.5, weakness: 'Melee', level: 40, xp: 180, gold: 120 }
                ]
            },
            valley: {
                name: 'The Valley of Gods',
                monsters: [
                    { name: 'Minotaur', melee: 45, ranged: 10, defense: 35, health: 60, magic: 15, attackSpeed: 3, weakness: 'Ranged', level: 45, xp: 220, gold: 150 },
                    { name: 'Chimera', melee: 40, ranged: 35, defense: 30, health: 55, magic: 30, attackSpeed: 2.5, weakness: 'Magic', level: 50, xp: 260, gold: 180 },
                    { name: 'Hydra', melee: 50, ranged: 45, defense: 40, health: 70, magic: 25, attackSpeed: 2, weakness: 'Melee', level: 55, xp: 300, gold: 220 }
                ]
            },
            exterminating: {
                name: 'Exterminating',
                monsters: [
                    { name: 'Demon', melee: 60, ranged: 50, defense: 45, health: 80, magic: 40, attackSpeed: 2, weakness: 'Magic', level: 60, xp: 350, gold: 260 },
                    { name: 'Ancient Dragon', melee: 70, ranged: 60, defense: 55, health: 100, magic: 50, attackSpeed: 2.5, weakness: 'Ranged', level: 70, xp: 450, gold: 350 },
                    { name: 'Dark Lord', melee: 80, ranged: 70, defense: 65, health: 120, magic: 70, attackSpeed: 2, weakness: 'None', level: 80, xp: 600, gold: 500 }
                ]
            }
        };
        
        // Monster drop tables (item, tier, drop chance)
        const monsterDrops = {
            // Woods monsters
            'Turkey': [
                { item: 'Raw Fish', tier: 1, chance: 0.15, quantity: [1, 3] },
                { item: 'Logs', tier: 1, chance: 0.10, quantity: [1, 2] }
            ],
            'Fox': [
                { item: 'Raw Fish', tier: 1, chance: 0.20, quantity: [2, 4] },
                { item: 'Logs', tier: 1, chance: 0.15, quantity: [1, 3] },
                { item: 'Ore', tier: 1, chance: 0.05, quantity: [1, 2] }
            ],
            'Wolf': [
                { item: 'Raw Fish', tier: 1, chance: 0.25, quantity: [2, 5] },
                { item: 'Logs', tier: 1, chance: 0.20, quantity: [2, 4] },
                { item: 'Ore', tier: 1, chance: 0.10, quantity: [1, 2] }
            ],
            // Cave monsters
            'Bat': [
                { item: 'Raw Fish', tier: 1, chance: 0.18, quantity: [1, 3] },
                { item: 'Ore', tier: 1, chance: 0.15, quantity: [1, 3] }
            ],
            'Spider': [
                { item: 'Raw Fish', tier: 2, chance: 0.22, quantity: [2, 4] },
                { item: 'Ore', tier: 2, chance: 0.20, quantity: [1, 3] },
                { item: 'Logs', tier: 1, chance: 0.12, quantity: [1, 2] }
            ],
            'Cave Bear': [
                { item: 'Raw Fish', tier: 2, chance: 0.28, quantity: [3, 6] },
                { item: 'Ore', tier: 2, chance: 0.25, quantity: [2, 4] },
                { item: 'Logs', tier: 2, chance: 0.15, quantity: [1, 3] }
            ],
            // Wilderness monsters
            'Boar': [
                { item: 'Raw Fish', tier: 2, chance: 0.25, quantity: [2, 5] },
                { item: 'Logs', tier: 2, chance: 0.20, quantity: [2, 4] },
                { item: 'Ore', tier: 1, chance: 0.15, quantity: [1, 3] }
            ],
            'Wild Dog': [
                { item: 'Raw Fish', tier: 2, chance: 0.27, quantity: [3, 5] },
                { item: 'Logs', tier: 2, chance: 0.22, quantity: [2, 4] },
                { item: 'Ore', tier: 2, chance: 0.18, quantity: [1, 3] }
            ],
            'Lynx': [
                { item: 'Raw Fish', tier: 2, chance: 0.30, quantity: [3, 6] },
                { item: 'Logs', tier: 2, chance: 0.25, quantity: [2, 5] },
                { item: 'Ore', tier: 2, chance: 0.22, quantity: [2, 4] }
            ],
            // Graveyard monsters
            'Zombie': [
                { item: 'Raw Fish', tier: 3, chance: 0.28, quantity: [3, 6] },
                { item: 'Ore', tier: 3, chance: 0.25, quantity: [2, 5] },
                { item: 'Logs', tier: 2, chance: 0.20, quantity: [2, 4] }
            ],
            'Skeleton': [
                { item: 'Raw Fish', tier: 3, chance: 0.30, quantity: [4, 7] },
                { item: 'Ore', tier: 3, chance: 0.28, quantity: [3, 5] },
                { item: 'Logs', tier: 3, chance: 0.22, quantity: [2, 4] }
            ],
            'Ghost': [
                { item: 'Raw Fish', tier: 3, chance: 0.32, quantity: [4, 8] },
                { item: 'Ore', tier: 3, chance: 0.30, quantity: [3, 6] },
                { item: 'Logs', tier: 3, chance: 0.25, quantity: [2, 5] }
            ],
            // Uncharted grounds monsters
            'Dire Wolf': [
                { item: 'Raw Fish', tier: 3, chance: 0.35, quantity: [4, 8] },
                { item: 'Logs', tier: 3, chance: 0.30, quantity: [3, 6] },
                { item: 'Ore', tier: 3, chance: 0.28, quantity: [2, 5] }
            ],
            'Ogre': [
                { item: 'Raw Fish', tier: 4, chance: 0.38, quantity: [5, 10] },
                { item: 'Ore', tier: 4, chance: 0.35, quantity: [3, 7] },
                { item: 'Logs', tier: 3, chance: 0.30, quantity: [3, 6] }
            ],
            'Troll': [
                { item: 'Raw Fish', tier: 4, chance: 0.40, quantity: [5, 10] },
                { item: 'Ore', tier: 4, chance: 0.38, quantity: [4, 8] },
                { item: 'Logs', tier: 4, chance: 0.32, quantity: [3, 6] }
            ],
            // Lair of beasts monsters
            'Grizzly Bear': [
                { item: 'Raw Fish', tier: 4, chance: 0.42, quantity: [6, 12] },
                { item: 'Logs', tier: 4, chance: 0.38, quantity: [4, 8] },
                { item: 'Ore', tier: 4, chance: 0.35, quantity: [3, 7] }
            ],
            'Sabertooth': [
                { item: 'Raw Fish', tier: 4, chance: 0.45, quantity: [7, 14] },
                { item: 'Logs', tier: 4, chance: 0.40, quantity: [5, 10] },
                { item: 'Ore', tier: 4, chance: 0.38, quantity: [4, 8] }
            ],
            'Wyvern': [
                { item: 'Raw Fish', tier: 5, chance: 0.48, quantity: [8, 15] },
                { item: 'Ore', tier: 5, chance: 0.45, quantity: [5, 10] },
                { item: 'Logs', tier: 4, chance: 0.42, quantity: [4, 9] }
            ],
            // Valley of Gods monsters
            'Minotaur': [
                { item: 'Raw Fish', tier: 5, chance: 0.50, quantity: [8, 16] },
                { item: 'Ore', tier: 5, chance: 0.48, quantity: [6, 12] },
                { item: 'Logs', tier: 5, chance: 0.45, quantity: [5, 10] }
            ],
            'Chimera': [
                { item: 'Raw Fish', tier: 5, chance: 0.52, quantity: [10, 18] },
                { item: 'Ore', tier: 5, chance: 0.50, quantity: [7, 14] },
                { item: 'Logs', tier: 5, chance: 0.48, quantity: [6, 12] }
            ],
            'Hydra': [
                { item: 'Raw Fish', tier: 5, chance: 0.55, quantity: [12, 20] },
                { item: 'Ore', tier: 5, chance: 0.52, quantity: [8, 16] },
                { item: 'Logs', tier: 5, chance: 0.50, quantity: [7, 14] }
            ],
            // Exterminating monsters
            'Demon': [
                { item: 'Raw Fish', tier: 5, chance: 0.58, quantity: [12, 22] },
                { item: 'Ore', tier: 5, chance: 0.55, quantity: [10, 18] },
                { item: 'Logs', tier: 5, chance: 0.52, quantity: [8, 16] }
            ],
            'Ancient Dragon': [
                { item: 'Raw Fish', tier: 5, chance: 0.62, quantity: [15, 25] },
                { item: 'Ore', tier: 5, chance: 0.60, quantity: [12, 20] },
                { item: 'Logs', tier: 5, chance: 0.58, quantity: [10, 18] }
            ],
            'Dark Lord': [
                { item: 'Raw Fish', tier: 5, chance: 0.70, quantity: [20, 30] },
                { item: 'Ore', tier: 5, chance: 0.68, quantity: [15, 25] },
                { item: 'Logs', tier: 5, chance: 0.65, quantity: [12, 22] }
            ]
        };
        
        // Current combat zone
        let currentCombatZone = 'woods';
        
        // Populate combat content based on zone
        function populateCombatContent(zone) {
            currentCombatZone = zone;
            
            const content = document.getElementById('combatContent');
            const zoneData = combatZones[zone];
            
            if (!zoneData) return;
            
            content.innerHTML = '';
            
            // Create zone display
            const zoneCard = document.createElement('div');
            zoneCard.style.cssText = `
                max-width: 1200px;
                margin: 0 auto;
                background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(238, 85, 85, 0.08));
                border: 4px solid #ff6b6b;
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 10px 40px rgba(255, 107, 107, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            `;
            
            // Zone title with description
            const titleContainer = document.createElement('div');
            titleContainer.style.cssText = 'text-align: center; margin-bottom: 35px; padding-bottom: 25px; border-bottom: 3px solid rgba(255, 107, 107, 0.3);';
            
            const title = document.createElement('div');
            title.style.cssText = 'color: #ff6b6b; font-size: 36px; font-weight: bold; text-shadow: 0 2px 15px rgba(255, 107, 107, 0.5); margin-bottom: 10px;';
            title.textContent = `âš”ï¸ ${zoneData.name}`;
            titleContainer.appendChild(title);
            
            const description = document.createElement('div');
            description.style.cssText = 'color: #8a9aaa; font-size: 15px; font-style: italic; max-width: 600px; margin: 0 auto;';
            description.textContent = getZoneDescription(zone);
            titleContainer.appendChild(description);
            
            zoneCard.appendChild(titleContainer);
            
            // Monsters in this zone
            const monstersHeader = document.createElement('div');
            monstersHeader.style.cssText = 'display: flex; align-items: center; gap: 12px; color: #cad2da; font-size: 22px; font-weight: bold; margin-bottom: 25px; padding: 15px 20px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 5px solid #ff6b6b;';
            monstersHeader.innerHTML = '<span style="font-size: 28px;">ðŸ‘¹</span><span>Monsters in this zone</span>';
            zoneCard.appendChild(monstersHeader);
            
            // Monster list
            const monsterList = document.createElement('div');
            monsterList.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-bottom: 35px;';
            
            zoneData.monsters.forEach(monster => {
                const monsterItem = document.createElement('div');
                monsterItem.style.cssText = `
                    background: linear-gradient(135deg, rgba(26, 35, 50, 0.9), rgba(15, 22, 32, 0.9));
                    border: 3px solid #3a4a5a;
                    border-radius: 15px;
                    padding: 20px;
                    text-align: center;
                    transition: all 0.3s;
                    cursor: default;
                    position: relative;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
                `;
                
                monsterItem.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.borderColor = '#ff6b6b';
                    this.style.boxShadow = '0 8px 25px rgba(255, 107, 107, 0.4)';
                });
                
                monsterItem.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.borderColor = '#3a4a5a';
                    this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.5)';
                });
                
                // Loot bag button
                const lootBagBtn = document.createElement('div');
                lootBagBtn.style.cssText = `
                    position: absolute;
                    top: 12px;
                    right: 12px;
                    width: 42px;
                    height: 42px;
                    background: linear-gradient(135deg, rgba(212, 167, 106, 0.9), rgba(180, 140, 80, 0.9));
                    border: 3px solid #d4a76a;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 4px 12px rgba(212, 167, 106, 0.4);
                    z-index: 10;
                `;
                lootBagBtn.innerHTML = 'ðŸ’°';
                lootBagBtn.title = 'View Drops';
                
                lootBagBtn.addEventListener('mouseenter', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(1.15) rotate(10deg)';
                    this.style.boxShadow = '0 6px 20px rgba(212, 167, 106, 0.6)';
                    this.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(212, 167, 106, 0.9))';
                });
                
                lootBagBtn.addEventListener('mouseleave', function(e) {
                    e.stopPropagation();
                    this.style.transform = 'scale(1) rotate(0deg)';
                    this.style.boxShadow = '0 4px 12px rgba(212, 167, 106, 0.4)';
                    this.style.background = 'linear-gradient(135deg, rgba(212, 167, 106, 0.9), rgba(180, 140, 80, 0.9))';
                });
                
                lootBagBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showMonsterDrops(monster.name);
                });
                
                monsterItem.appendChild(lootBagBtn);
                
                monsterItem.innerHTML += `
                    <div style="font-size: 56px; margin-bottom: 12px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));">${getMonsterIcon(monster.name)}</div>
                    <div style="color: #ff6b6b; font-size: 19px; font-weight: bold; margin-bottom: 10px; text-shadow: 0 1px 5px rgba(255, 107, 107, 0.5);">${monster.name}</div>
                    <div style="display: inline-block; background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(238, 85, 85, 0.2)); border: 2px solid #ff6b6b; border-radius: 8px; padding: 6px 16px; margin-bottom: 15px;">
                        <span style="color: #ff6b6b; font-size: 14px; font-weight: bold;">Level ${monster.level}</span>
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.4); padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid rgba(255, 107, 107, 0.2);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px; background: rgba(255, 107, 107, 0.1); border-radius: 6px;">
                                <span style="font-size: 18px;">ðŸ—¡ï¸</span>
                                <span style="color: #cad2da; font-weight: bold;">${monster.melee}</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px; background: rgba(255, 107, 107, 0.1); border-radius: 6px;">
                                <span style="font-size: 18px;">ðŸ¹</span>
                                <span style="color: #cad2da; font-weight: bold;">${monster.ranged}</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px; background: rgba(255, 107, 107, 0.1); border-radius: 6px;">
                                <span style="font-size: 18px;">ðŸ”®</span>
                                <span style="color: #cad2da; font-weight: bold;">${monster.magic}</span>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 6px; background: rgba(255, 107, 107, 0.1); border-radius: 6px;">
                                <span style="font-size: 18px;">ðŸ›¡ï¸</span>
                                <span style="color: #cad2da; font-weight: bold;">${monster.defense}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-around; padding-top: 8px; border-top: 1px solid rgba(255, 107, 107, 0.2);">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px;">â¤ï¸</span>
                                <span style="color: #ff6b6b; font-weight: bold; font-size: 13px;">${monster.health} HP</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px;">ðŸ’°</span>
                                <span style="color: #ffd700; font-weight: bold; font-size: 13px;">${monster.gold} gp</span>
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(212, 167, 106, 0.2), rgba(180, 140, 80, 0.2)); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(212, 167, 106, 0.3); margin-bottom: 8px;">
                        <div style="color: #d4a76a; font-size: 11px; font-weight: bold; margin-bottom: 3px;">ATTACK SPEED</div>
                        <div style="color: #cad2da; font-size: 13px; font-weight: bold;">${monster.attackSpeed}s</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(90, 186, 170, 0.2), rgba(70, 156, 140, 0.2)); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(90, 186, 170, 0.3);">
                        <div style="color: #5abaaa; font-size: 11px; font-weight: bold; margin-bottom: 3px;">WEAKNESS</div>
                        <div style="color: #cad2da; font-size: 13px; font-weight: bold;">${monster.weakness}</div>
                    </div>
                `;
                
                monsterList.appendChild(monsterItem);
            });
            
            zoneCard.appendChild(monsterList);
            
            // Enter zone button
            const enterBtn = document.createElement('button');
            enterBtn.innerHTML = '<span style="font-size: 24px; margin-right: 10px;">âš”ï¸</span><span>Enter Zone</span>';
            enterBtn.style.cssText = `
                width: 100%;
                padding: 20px;
                background: linear-gradient(135deg, #ff6b6b, #ee5555);
                color: white;
                border: 3px solid #ff4444;
                border-radius: 15px;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            `;
            
            enterBtn.addEventListener('mouseenter', function() {
                this.style.background = 'linear-gradient(135deg, #ff7b7b, #ff6565)';
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 10px 30px rgba(255, 107, 107, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
            });
            
            enterBtn.addEventListener('mouseleave', function() {
                this.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5555)';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 6px 20px rgba(255, 107, 107, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            });
            
            enterBtn.addEventListener('click', () => {
                enterCombatZone(zone);
            });
            
            zoneCard.appendChild(enterBtn);
            content.appendChild(zoneCard);
        }
        
        // Get zone description
        function getZoneDescription(zone) {
            const descriptions = {
                'woods': 'A peaceful forest teeming with wildlife and beginner-friendly creatures.',
                'cave': 'Dark caverns filled with dangerous beasts lurking in the shadows.',
                'wilderness': 'An unforgiving wasteland where only the strongest survive.',
                'graveyard': 'A haunted realm where the undead roam freely.',
                'uncharted': 'Mysterious lands filled with exotic and powerful creatures.',
                'lair': 'The domain of fearsome beasts and legendary monsters.',
                'valley': 'A divine battleground where godlike entities test mortals.',
                'exterminating': 'The ultimate proving grounds for master warriors.'
            };
            return descriptions[zone] || 'A dangerous combat zone awaits.';
        }
        
        // Show monster drop table
        function showMonsterDrops(monsterName) {
            const drops = monsterDrops[monsterName] || [];
            
            // Create modal backdrop
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.2s;
            `;
            
            // Create drop table container
            const container = document.createElement('div');
            container.style.cssText = `
                background: linear-gradient(135deg, #1a2332 0%, #0f1620 100%);
                border: 4px solid #d4a76a;
                border-radius: 20px;
                padding: 30px;
                max-width: 600px;
                width: 90%;
                box-shadow: 0 20px 80px rgba(212, 167, 106, 0.5), 0 10px 50px rgba(0,0,0,0.9);
                animation: slideIn 0.3s;
            `;
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
                padding-bottom: 20px;
                border-bottom: 3px solid rgba(212, 167, 106, 0.3);
            `;
            header.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 42px;">ðŸ’°</div>
                    <div>
                        <div style="color: #d4a76a; font-size: 24px; font-weight: bold; text-shadow: 0 2px 10px rgba(212, 167, 106, 0.5);">${monsterName} Drops</div>
                        <div style="color: #8a9aaa; font-size: 13px; margin-top: 3px;">Possible loot from this monster</div>
                    </div>
                </div>
                <button id="closeDropModal" style="background: linear-gradient(135deg, #ff6b6b, #ee5555); color: #fff; border: 2px solid #ff4444; padding: 10px 16px; cursor: pointer; border-radius: 10px; font-size: 18px; font-weight: bold; transition: all 0.3s;">âœ–</button>
            `;
            
            // Drops list
            const dropsList = document.createElement('div');
            dropsList.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 12px;
                max-height: 400px;
                overflow-y: auto;
                padding-right: 10px;
            `;
            
            if (drops.length === 0) {
                dropsList.innerHTML = '<div style="color: #8a9aaa; text-align: center; padding: 20px; font-style: italic;">This monster has no special drops</div>';
            } else {
                drops.forEach(drop => {
                    const dropItem = document.createElement('div');
                    dropItem.style.cssText = `
                        background: linear-gradient(135deg, rgba(26, 35, 50, 0.8), rgba(15, 22, 32, 0.8));
                        border: 2px solid #3a4a5a;
                        border-radius: 12px;
                        padding: 15px 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        transition: all 0.3s;
                    `;
                    
                    dropItem.addEventListener('mouseenter', function() {
                        this.style.borderColor = '#d4a76a';
                        this.style.transform = 'translateX(5px)';
                        this.style.boxShadow = '0 4px 15px rgba(212, 167, 106, 0.3)';
                    });
                    
                    dropItem.addEventListener('mouseleave', function() {
                        this.style.borderColor = '#3a4a5a';
                        this.style.transform = 'translateX(0)';
                        this.style.boxShadow = 'none';
                    });
                    
                    const quantityText = drop.quantity ? `${drop.quantity[0]}-${drop.quantity[1]}x` : '1x';
                    const chancePercent = (drop.chance * 100).toFixed(1);
                    
                    dropItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 32px;">${getItemIcon(drop.item)}</div>
                            <div>
                                <div style="color: #cad2da; font-size: 16px; font-weight: bold;">T${drop.tier} ${drop.item}</div>
                                <div style="color: #8a9aaa; font-size: 12px; margin-top: 2px;">${quantityText} per drop</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: linear-gradient(135deg, rgba(90, 186, 170, 0.3), rgba(70, 156, 140, 0.2)); border: 2px solid #5abaaa; border-radius: 8px; padding: 6px 12px;">
                                <div style="color: #5abaaa; font-size: 14px; font-weight: bold;">${chancePercent}%</div>
                                <div style="color: #6a8a9a; font-size: 10px;">drop rate</div>
                            </div>
                        </div>
                    `;
                    
                    dropsList.appendChild(dropItem);
                });
            }
            
            // Note about rarities
            const note = document.createElement('div');
            note.style.cssText = `
                margin-top: 20px;
                padding: 15px;
                background: rgba(90, 186, 170, 0.1);
                border: 2px solid rgba(90, 186, 170, 0.3);
                border-radius: 10px;
            `;
            note.innerHTML = `
                <div style="color: #5abaaa; font-size: 12px; font-weight: bold; margin-bottom: 8px;">ðŸ“Œ RARITY RATES</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
                    <div style="color: #8a8a8a;">Common: <span style="color: #cad2da; font-weight: bold;">80%</span></div>
                    <div style="color: #00FF00;">Uncommon: <span style="color: #cad2da; font-weight: bold;">10%</span></div>
                    <div style="color: #4169E1;">Rare: <span style="color: #cad2da; font-weight: bold;">5%</span></div>
                    <div style="color: #9370DB;">Epic: <span style="color: #cad2da; font-weight: bold;">1%</span></div>
                    <div style="color: #FFD700;">Perfect: <span style="color: #cad2da; font-weight: bold;">0.1%</span></div>
                </div>
            `;
            
            // Assemble modal
            container.appendChild(header);
            container.appendChild(dropsList);
            container.appendChild(note);
            modal.appendChild(container);
            document.body.appendChild(modal);
            
            // Close button handler
            document.getElementById('closeDropModal').addEventListener('click', () => {
                modal.style.animation = 'fadeOut 0.2s';
                setTimeout(() => document.body.removeChild(modal), 200);
            });
            
            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.animation = 'fadeOut 0.2s';
                    setTimeout(() => document.body.removeChild(modal), 200);
                }
            });
        }
        
        // Get item icon emoji
        function getItemIcon(itemType) {
            const icons = {
                'Logs': 'ðŸªµ',
                'Ore': 'â›ï¸',
                'Raw Fish': 'ðŸŸ',
                'Plunder': 'ðŸ’°',
                'Lap': 'ðŸŽŸï¸'
            };
            return icons[itemType] || 'ðŸ“¦';
        }
        
        // Enter a combat zone (selects random monster from zone)
        function enterCombatZone(zone) {
            const zoneData = combatZones[zone];
            if (!zoneData || !zoneData.monsters.length) return;
            
            // Pick a random monster from this zone
            const randomMonster = zoneData.monsters[Math.floor(Math.random() * zoneData.monsters.length)];
            
            // Store the zone so we can respawn from it
            gameState.selectedZone = zone;
            
            // Close combat modal and show prep screen
            selectCombatMonster(randomMonster, zone);
        }
        
        // Create a monster selection card
        function createMonsterCard(monster, zone) {
            const card = document.createElement('div');
            card.className = 'monster-card';
            card.style.cssText = `
                background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(238, 85, 85, 0.1));
                border: 2px solid #ff6b6b;
                border-radius: 10px;
                padding: 20px;
                position: relative;
                transition: all 0.3s;
                cursor: pointer;
            `;
            
            // Check if player meets level requirement
            const playerLevel = gameState.player.skills.combat || 1;
            const canFight = playerLevel >= monster.level;
            
            if (!canFight) {
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
            }
            
            // Level requirement badge
            const levelBadge = document.createElement('div');
            levelBadge.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.7);
                padding: 5px 12px;
                border-radius: 15px;
                color: ${canFight ? '#5abaaa' : '#ff4444'};
                font-weight: bold;
                font-size: 12px;
            `;
            levelBadge.textContent = `Lvl ${monster.level}`;
            card.appendChild(levelBadge);
            
            card.innerHTML += `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ðŸ¦Š</div>
                    <div style="color: #ff6b6b; font-size: 20px; font-weight: bold; margin-bottom: 8px;">${monster.name}</div>
                    <div style="color: #d4a76a; font-size: 12px;">Attack speed: ${monster.attackSpeed}s</div>
                    <div style="color: #8a9aaa; font-size: 11px; margin-top: 4px;">Weakness: ${monster.weakness}</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ðŸ—¡ï¸</span>
                            <span style="color: #cad2da;">${monster.melee}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ðŸ¹</span>
                            <span style="color: #cad2da;">${monster.ranged}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ðŸ›¡ï¸</span>
                            <span style="color: #cad2da;">${monster.defense}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">â¤ï¸</span>
                            <span style="color: #cad2da;">${monster.health}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ðŸ”®</span>
                            <span style="color: #cad2da;">${monster.magic}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 16px;">ðŸ’°</span>
                            <span style="color: #ffd700;">${monster.gold}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(90, 186, 170, 0.2); padding: 8px; border-radius: 6px; margin-bottom: 12px; text-align: center;">
                    <span style="color: #5abaaa; font-size: 13px; font-weight: bold;">+${monster.xp} XP per kill</span>
                </div>
                
                <button class="select-monster-btn" 
                    data-monster="${monster.name}" 
                    data-zone="${zone}"
                    style="width: 100%; padding: 12px; background: ${canFight ? 'linear-gradient(135deg, #ff6b6b, #ee5555)' : '#555'}; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: ${canFight ? 'pointer' : 'not-allowed'}; transition: all 0.3s;"
                    ${!canFight ? 'disabled' : ''}>
                    ${canFight ? 'SELECT TARGET' : 'LEVEL TOO LOW'}
                </button>
            `;
            
            // Add click handler for the button
            if (canFight) {
                const button = card.querySelector('.select-monster-btn');
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectCombatMonster(monster, zone);
                });
                
                button.addEventListener('mouseenter', () => {
                    button.style.background = 'linear-gradient(135deg, #ee5555, #dd4444)';
                    button.style.transform = 'scale(1.02)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5555)';
                    button.style.transform = 'scale(1)';
                });
            }
            
            return card;
        }
        
        // Select a monster for combat
        let selectedMonsterData = null;
        let selectedZone = null;
        
        function selectCombatMonster(monster, zone) {
            // Store selection
            selectedMonsterData = monster;
            selectedZone = zone;
            
            // Close combat zone modal
            document.getElementById('combatModal').style.display = 'none';
            
            // Populate prep screen
            populateCombatPrepScreen(monster, zone);
            
            // Show prep modal
            document.getElementById('combatPrepModal').style.display = 'block';
        }
        
        function populateCombatPrepScreen(monster, zone) {
            const zoneData = combatZones[zone];
            
            // Check equipped weapon to determine available attack styles
            const equippedWeapon = gameState.player.equipment.weapon;
            const equippedArrows = gameState.player.equipment.arrows;
            
            let canUseMelee = true; // Always available
            let canUseRanged = false;
            let canUseMagic = false;
            
            // Check for ranged weapon (arrows no longer required)
            if (equippedWeapon && equippedWeapon.name) {
                const weaponName = equippedWeapon.name.toLowerCase();
                if (weaponName.includes('bow')) {
                    canUseRanged = true;
                } else if (weaponName.includes('staff') || weaponName.includes('wand')) {
                    canUseMagic = true;
                }
            }
            
            // Update attack style options to disable unavailable styles
            document.querySelectorAll('.attack-style-option').forEach(option => {
                const combatStyle = option.dataset.combatStyle;
                let isDisabled = false;
                
                if (combatStyle === 'ranged' && !canUseRanged) {
                    isDisabled = true;
                    option.style.opacity = '0.3';
                    option.style.cursor = 'not-allowed';
                    option.title = 'Requires bow equipped';
                } else if (combatStyle === 'magic' && !canUseMagic) {
                    isDisabled = true;
                    option.style.opacity = '0.3';
                    option.style.cursor = 'not-allowed';
                    option.title = 'Requires staff or wand equipped';
                } else {
                    option.style.opacity = '1';
                    option.style.cursor = 'pointer';
                    option.title = '';
                }
                
                option.dataset.disabled = isDisabled;
            });
            
            // If current style is disabled, switch to melee accurate
            if ((gameState.combat.combatStyle === 'ranged' && !canUseRanged) ||
                (gameState.combat.combatStyle === 'magic' && !canUseMagic)) {
                gameState.combat.combatStyle = 'melee';
                gameState.combat.attackStyle = 'accurate';
            }
            
            // Get food items from inventory
            const foodItems = gameState.player.inventory.filter(item => 
                item.name && (
                    item.name.includes('Cooked Fish') || 
                    item.name.includes('Roasted') ||
                    item.name.includes('Bread') ||
                    item.name.includes('Food') ||
                    (item.icon && (item.icon === 'ðŸ–' || item.icon === 'ðŸž' || item.icon === 'ðŸ¥–' || item.icon === 'ðŸ—'))
                )
            );
            
            // Populate food grid
            const foodGrid = document.getElementById('combatFoodGrid');
            if (foodItems.length === 0) {
                foodGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: #8a9aaa; padding: 20px;">
                        No food available. Cook some food first!
                    </div>
                `;
            } else {
                foodGrid.innerHTML = foodItems.map(item => {
                    // Determine if we have a sprite for this item
                    let hasSprite = false;
                    let spriteUrl = '';
                    
                    if (item.customSprite) {
                        hasSprite = true;
                        spriteUrl = item.customSprite.src;
                    } else if (gameState.sprites[item.icon]) {
                        hasSprite = true;
                        spriteUrl = gameState.sprites[item.icon].src;
                    } else if (spriteUrls[item.icon]) {
                        hasSprite = true;
                        spriteUrl = spriteUrls[item.icon];
                    }
                    
                    return `
                    <div style="background: rgba(26, 35, 50, 0.6); border: 2px solid #2a3a4a; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='#5abaaa'; this.style.transform='translateY(-2px)'"
                        onmouseout="this.style.borderColor='#2a3a4a'; this.style.transform='translateY(0)'">
                        <div style="width: 48px; height: 48px; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center;">
                            ${hasSprite ? 
                                `<img src="${spriteUrl}" style="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated;" />` :
                                `<div style="font-size: 32px;">${item.icon || 'ðŸ–'}</div>`
                            }
                        </div>
                        <div style="color: #cad2da; font-size: 12px; font-weight: bold; margin-bottom: 3px;">${item.name}</div>
                        <div style="color: #8a9aaa; font-size: 11px;">Qty: ${item.quantity || 1}</div>
                    </div>
                `}).join('');
            }
            
            // Set slider to saved value
            const savedThreshold = gameState.combat.eatThreshold || 87;
            const slider = document.getElementById('eatThresholdSlider');
            const valueDisplay = document.getElementById('eatThresholdValue');
            slider.value = savedThreshold;
            valueDisplay.textContent = savedThreshold + '%';
            slider.style.background = `linear-gradient(90deg, #3a4a5a 0%, #5abaaa ${savedThreshold}%, #3a4a5a ${savedThreshold}%)`;
            
            // Set attack style to saved values
            const currentCombatStyle = gameState.combat.combatStyle || 'melee';
            const currentAttackStyle = gameState.combat.attackStyle || 'accurate';
            
            // Update visual selection for attack styles
            document.querySelectorAll('.attack-style-option').forEach(opt => {
                const optCombatStyle = opt.dataset.combatStyle;
                const optAttackStyle = opt.dataset.attackStyle;
                
                if (optCombatStyle === currentCombatStyle && optAttackStyle === currentAttackStyle) {
                    opt.style.background = 'rgba(90, 186, 170, 0.2)';
                    opt.style.borderColor = '#5abaaa';
                    opt.querySelector('div:first-child').style.color = '#5abaaa';
                } else {
                    opt.style.background = 'rgba(42, 58, 74, 0.4)';
                    opt.style.borderColor = '#2a3a4a';
                    opt.querySelector('div:first-child').style.color = '#cad2da';
                }
            });
        }
        
        function getMonsterIcon(name) {
            const icons = {
                'Turkey': 'ðŸ¦ƒ',
                'Chicken': 'ðŸ”',
                'Cow': 'ðŸ„',
                'Rat': 'ðŸ€',
                'Spider': 'ðŸ•·ï¸',
                'Wolf': 'ðŸº',
                'Bear': 'ðŸ»',
                'Dragon': 'ðŸ‰',
                'Goblin': 'ðŸ‘º',
                'Skeleton': 'ðŸ’€',
                'Zombie': 'ðŸ§Ÿ',
                'Ghost': 'ðŸ‘»',
                'Demon': 'ðŸ˜ˆ',
                'Troll': 'ðŸ§Œ'
            };
            return icons[name] || 'ðŸ‘¹';
        }
        
        function startActualCombat() {
            if (!selectedMonsterData || !selectedZone) return;
            
            const monster = selectedMonsterData;
            const zone = selectedZone;
            
            // Ensure player has HP
            if (!gameState.player.skills.hitpoints || gameState.player.skills.hitpoints <= 0) {
                gameState.player.skills.hitpoints = 10; // Reset to 10 if somehow at 0
                showFloatingText('HP restored to 10!', canvas.width / 2, 150, '#5abaaa');
            }
            
            // CRITICAL: Full combat state reset before entering
            gameState.combat.inCombat = false;
            gameState.combat.monster = null;
            gameState.combat.monsterHealth = 0;
            gameState.combat.monsterMaxHealth = 0;
            gameState.combat.monsterNode = null;
            gameState.combat.monsterPosition = { x: 0, y: 0 };
            gameState.combat.damageSplats = [];
            gameState.combat.lastPlayerAttack = 0;
            gameState.combat.lastMonsterAttack = 0;
            
            // Store selected zone
            gameState.selectedZone = zone;
            
            // Switch to combat room
            gameState.currentRoom = 'combat';
            document.getElementById('currentRoom').textContent = `Combat - ${combatZones[zone].name}`;
            
            // Reset player position
            gameState.player.x = canvas.width / 2;
            gameState.player.y = canvas.height / 2;
            gameState.player.targetX = null;
            gameState.player.targetY = null;
            gameState.player.currentTarget = null;
            gameState.player.isPerformingAction = false;
            
            // CRITICAL: Reset all mobs in the combat room to fresh state
            if (rooms.combat && rooms.combat.objects) {
                rooms.combat.objects.forEach(obj => {
                    if (obj.type === 'mob') {
                        obj.inCombat = false;
                        obj.health = obj.maxHealth;
                        obj.x = obj.spawnX;
                        obj.y = obj.spawnY;
                        obj.targetX = null;
                        obj.targetY = null;
                    }
                });
            }
            
            // CRITICAL: Regenerate room objects to get fresh mob spawns
            initializeRoomObjects();
            
            // Update sidebar active state
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.menu-item[data-room="combat"]')?.classList.add('active');
            
            // Generate tiles for combat room
            generateTiles();
            
            // Close prep modal
            document.getElementById('combatPrepModal').style.display = 'none';
            
            // Show confirmation
            showFloatingText(`Entered ${combatZones[zone].name}!`, canvas.width / 2, 100, '#ff6b6b');
            
            // Update activity tracker to show the skill being trained
            updateActivityTracker();
            
            // Save game
            saveGame();
        }
        
        // Tab switching for combat zones
        document.querySelectorAll('.combat-zone-tab').forEach(tab => {
            // Add hover effects
            tab.addEventListener('mouseenter', function() {
                if (!this.classList.contains('active')) {
                    this.style.opacity = '1';
                    this.style.background = 'linear-gradient(135deg, rgba(255, 107, 107, 0.4), rgba(238, 85, 85, 0.3))';
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.3)';
                }
            });
            
            tab.addEventListener('mouseleave', function() {
                if (!this.classList.contains('active')) {
                    this.style.opacity = '0.7';
                    this.style.background = 'linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5))';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                }
            });
            
            tab.addEventListener('click', function() {
                const zone = this.dataset.zone;
                
                // Update tab styles
                document.querySelectorAll('.combat-zone-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'linear-gradient(135deg, rgba(42, 58, 74, 0.5), rgba(32, 48, 64, 0.5))';
                    t.style.color = '#8a9aaa';
                    t.style.opacity = '0.7';
                    t.style.border = '2px solid #3a4a5a';
                    t.style.boxShadow = 'none';
                });
                
                this.classList.add('active');
                this.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5555)';
                this.style.color = 'white';
                this.style.opacity = '1';
                this.style.border = '3px solid #ff4444';
                this.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
                
                // Update content
                populateCombatContent(zone);
            });
        });
        
        // ==================== END COMBAT ZONE SELECTION SYSTEM ====================
        
        // ==================== OSRS-STYLE COMBAT MECHANICS ====================
        
        // Stub function for level ups (prevents crashes)
        function checkLevelUp(skill) {
            // TODO: Implement proper level up system
            // For now, just prevent crashes
            return;
        }
        
        // Calculate hit chance (accuracy)
        function calculateHitChance(attacker, defender, style) {
            let attackBonus = 0;
            let defenseBonus = 0;
            
            if (style === 'melee') {
                attackBonus = attacker.attack || 1;
                defenseBonus = defender.defense || defender.defence || 1;
            } else if (style === 'ranged') {
                attackBonus = attacker.ranged || 1;
                defenseBonus = defender.defense || defender.defence || 1;
            } else if (style === 'magic') {
                attackBonus = attacker.magic || 1;
                defenseBonus = defender.defense || defender.defence || 1;
            }
            
            // OSRS-style accuracy formula (simplified)
            const effectiveAttack = attackBonus + 8;
            const effectiveDefense = defenseBonus + 8;
            const attackRoll = effectiveAttack * (64 + attackBonus);
            const defenseRoll = effectiveDefense * (64 + defenseBonus);
            
            let hitChance = 0.5;
            if (attackRoll > defenseRoll) {
                hitChance = 1 - (defenseRoll + 2) / (2 * (attackRoll + 1));
            } else {
                hitChance = attackRoll / (2 * (defenseRoll + 1));
            }
            
            return Math.min(Math.max(hitChance, 0.05), 0.95); // 5% minimum, 95% maximum
        }
        
        // Calculate damage
        function calculateDamage(attacker, defender, style) {
            const hitChance = calculateHitChance(attacker, defender, style);
            
            // Check if hit lands
            if (Math.random() > hitChance) {
                return 0; // Miss
            }
            
            // Calculate max hit - adjusted for lower stat ranges
            let maxHit = 0;
            if (style === 'melee') {
                const strength = attacker.strength || attacker.melee || 1;
                // Simplified formula: each point gives roughly 1 damage, with scaling
                maxHit = Math.max(1, Math.floor(strength * 0.8 + strength * strength * 0.05));
            } else if (style === 'ranged') {
                const ranged = attacker.ranged || 1;
                maxHit = Math.max(1, Math.floor(ranged * 0.8 + ranged * ranged * 0.05));
            } else if (style === 'magic') {
                const magic = attacker.magic || 1;
                maxHit = Math.max(1, Math.floor(magic * 0.8 + magic * magic * 0.05));
            }
            
            // Random damage between 1 and maxHit (always at least 1 on hit)
            return Math.max(1, Math.floor(Math.random() * (maxHit + 1)));
        }
        
        // Player attacks monster
        function playerAttack() {
            if (!gameState.combat.inCombat || !gameState.combat.monster) return;
            
            // Check if player is within attack range
            const dx = gameState.combat.monsterPosition.x - gameState.player.x;
            const dy = gameState.combat.monsterPosition.y - gameState.player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Determine attack range based on combat style
            let attackRange = 100; // Melee range (increased)
            const combatStyle = gameState.combat.combatStyle || 'melee';
            
            if (combatStyle === 'ranged') {
                attackRange = 200; // Ranged (increased)
            } else if (combatStyle === 'magic') {
                attackRange = 230; // Magic (increased)
            }
            
            // Player can only attack if within range
            if (distance > attackRange) return;
            
            const now = Date.now();
            const attackSpeed = 2400; // Base attack speed in ms (2.4 seconds, OSRS standard)
            
            if (now - gameState.combat.lastPlayerAttack < attackSpeed) return;
            
            gameState.combat.lastPlayerAttack = now;
            
            // LOCK PLAYER IN PLACE during attack animation
            // Player can't move for 800ms (attack animation duration)
            gameState.player.isAttacking = true;
            gameState.player.attackLockoutEnd = now + 800;
            // Clear movement targets to stop any ongoing movement
            gameState.player.targetX = null;
            gameState.player.targetY = null;
            
            // Determine combat style based on equipped weapon or player choice
            const style = gameState.combat.combatStyle || 'melee';
            
            // Calculate damage
            const damage = calculateDamage(
                {
                    attack: gameState.player.skills.attack,
                    strength: gameState.player.skills.strength,
                    ranged: gameState.player.skills.ranged,
                    magic: gameState.player.skills.magic
                },
                gameState.combat.monster,
                style
            );
            
            // Apply damage
            gameState.combat.monsterHealth -= damage;
            
            // Also update the mob node's health if it exists
            if (gameState.combat.monsterNode) {
                gameState.combat.monsterNode.health = gameState.combat.monsterHealth;
            }
            
            // CONSUME ARROWS/BOOK CHARGES IF EQUIPPED
            if (style === 'ranged') {
                // Consume 1 arrow if equipped
                const equippedArrows = gameState.player.equipment.arrows;
                if (equippedArrows && equippedArrows.quantity > 0) {
                    equippedArrows.quantity--;
                    if (equippedArrows.quantity <= 0) {
                        // Remove arrows when depleted
                        gameState.player.equipment.arrows = null;
                        updateEquipmentDisplay();
                        showFloatingText('Out of arrows!', canvas.width / 2, 100, '#ff6b6b');
                    }
                    updateEquipmentDisplay();
                }
            } else if (style === 'magic') {
                // Consume 1 page (charge) from book if equipped
                const equippedBook = gameState.player.equipment.arrows; // Books use arrow slot
                if (equippedBook && equippedBook.type === 'magebook' && equippedBook.charges > 0) {
                    equippedBook.charges--;
                    if (equippedBook.charges <= 0) {
                        showFloatingText(`${equippedBook.name} out of charges!`, canvas.width / 2, 100, '#ff6b6b');
                    }
                    updateEquipmentDisplay();
                }
            }
            
            // Create damage splat
            createDamageSplat(
                damage,
                gameState.combat.monsterPosition.x,
                gameState.combat.monsterPosition.y - 50,
                false // false = player hitting monster (red splat)
            );
            
            // Add XP for hitting
            if (damage > 0) {
                const combatStyle = gameState.combat.combatStyle || 'melee';
                const attackStyle = gameState.combat.attackStyle || 'accurate';
                let totalXP = 0;
                
                if (combatStyle === 'melee') {
                    const xp = damage * 4;
                    
                    if (attackStyle === 'accurate') {
                        // All XP to Attack
                        addSkillXP('attack', xp);
                        totalXP += xp;
                    } else if (attackStyle === 'aggressive') {
                        // All XP to Strength
                        addSkillXP('strength', xp);
                        totalXP += xp;
                    } else if (attackStyle === 'controlled') {
                        // Split between Attack, Strength, and Defense
                        const splitXp = Math.floor(xp / 3);
                        addSkillXP('attack', splitXp);
                        addSkillXP('strength', splitXp);
                        addSkillXP('defence', splitXp);
                        totalXP += splitXp * 3;
                    }
                } else if (combatStyle === 'ranged') {
                    const xp = damage * 4;
                    
                    if (attackStyle === 'rapid') {
                        // All XP to Ranged
                        addSkillXP('ranged', xp);
                        totalXP += xp;
                    } else if (attackStyle === 'longrange') {
                        // Split between Ranged and Defense
                        const splitXp = Math.floor(xp / 2);
                        addSkillXP('ranged', splitXp);
                        addSkillXP('defence', splitXp);
                        totalXP += splitXp * 2;
                    }
                } else if (combatStyle === 'magic') {
                    const xp = damage * 4;
                    
                    if (attackStyle === 'accurate') {
                        // All XP to Magic
                        addSkillXP('magic', xp);
                        totalXP += xp;
                    } else if (attackStyle === 'longrange') {
                        // Split between Magic and Defense
                        const splitXp = Math.floor(xp / 2);
                        addSkillXP('magic', splitXp);
                        addSkillXP('defence', splitXp);
                        totalXP += splitXp * 2;
                    }
                }
                
                // Add defense XP if not already added by longrange or controlled
                if (attackStyle !== 'controlled' && attackStyle !== 'longrange') {
                    const defXP = Math.floor(damage * 1.33);
                    addSkillXP('defence', defXP);
                    totalXP += defXP;
                }
                
                // Always add hitpoints XP
                const hpXP = Math.floor(damage * 1.33);
                addSkillXP('hitpoints', hpXP);
                totalXP += hpXP;
                
                // Track XP for activity tracker
                if (gameState.activityTracker) {
                    gameState.activityTracker.xpGained += totalXP;
                    updateActivityTracker();
                }
                
                // Build XP message with skill icons
                let xpIcons = '';
                
                if (combatStyle === 'melee') {
                    if (attackStyle === 'accurate') {
                        xpIcons = 'âš”ï¸';
                    } else if (attackStyle === 'aggressive') {
                        xpIcons = 'ðŸ’ª';
                    } else if (attackStyle === 'controlled') {
                        xpIcons = 'âš”ï¸ðŸ’ªðŸ›¡ï¸';
                    }
                } else if (combatStyle === 'ranged') {
                    if (attackStyle === 'rapid') {
                        xpIcons = 'ðŸ¹';
                    } else if (attackStyle === 'longrange') {
                        xpIcons = 'ðŸ¹ðŸ›¡ï¸';
                    }
                } else if (combatStyle === 'magic') {
                    if (attackStyle === 'accurate') {
                        xpIcons = 'âœ¨';
                    } else if (attackStyle === 'longrange') {
                        xpIcons = 'âœ¨ðŸ›¡ï¸';
                    }
                }
                
                // Always show HP icon
                xpIcons += 'â¤ï¸';
                
                // Show XP drop floating text with icons
                showFloatingText(
                    `${xpIcons} +${Math.round(totalXP)} XP`, 
                    gameState.combat.monsterPosition.x, 
                    gameState.combat.monsterPosition.y - 70,
                    '#5abaaa'
                );
            }
            
            // Check if monster is dead
            if (gameState.combat.monsterHealth <= 0) {
                monsterDeath();
            }
        }
        
        // Monster attacks player
        function monsterAttack() {
            if (!gameState.combat.inCombat || !gameState.combat.monster) return;
            if (gameState.combat.monsterHealth <= 0) return;
            
            // Check if monster is within attack range (melee only)
            const dx = gameState.player.x - gameState.combat.monsterPosition.x;
            const dy = gameState.player.y - gameState.combat.monsterPosition.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const MELEE_RANGE = 100; // Same as mob movement stop range (increased)
            
            // Monster can only attack if within melee range
            if (distance > MELEE_RANGE) return;
            
            const now = Date.now();
            const attackSpeed = gameState.combat.monster.attackSpeed * 1000; // Convert to ms
            
            if (now - gameState.combat.lastMonsterAttack < attackSpeed) return;
            
            gameState.combat.lastMonsterAttack = now;
            
            // Determine monster's attack style - ALWAYS MELEE for all mobs
            let style = 'melee';
            const monster = gameState.combat.monster;
            
            // Calculate damage
            const damage = calculateDamage(
                gameState.combat.monster,
                {
                    defence: gameState.player.skills.defence,
                    defense: gameState.player.skills.defence
                },
                style
            );
            
            // Apply damage to player
            gameState.player.skills.hitpoints -= damage;
            
            // Trigger hurt animation if damage > 0 and not dead
            if (damage > 0 && gameState.player.skills.hitpoints > 0) {
                gameState.player.animation.currentState = 'hurt';
                gameState.player.animation.frame = 0;
                gameState.player.animation.lastFrameTime = Date.now();
            }
            
            // Create damage splat
            createDamageSplat(
                damage,
                gameState.player.x,
                gameState.player.y - 40,
                true // true = monster hitting player (blue splat)
            );
            
            // Check if player is dead
            if (gameState.player.skills.hitpoints <= 0) {
                playerDeath();
            }
        }
        
        // Create damage splat
        function createDamageSplat(damage, x, y, isPlayerDamage) {
            gameState.combat.damageSplats.push({
                damage: damage,
                x: x,
                y: y,
                isPlayerDamage: isPlayerDamage,
                timestamp: Date.now(),
                offsetY: 0
            });
        }
        
        // Update and render damage splats
        function updateDamageSplats() {
            const now = Date.now();
            const splatDuration = 1000; // Splats last 1 second
            
            // Update splats
            gameState.combat.damageSplats = gameState.combat.damageSplats.filter(splat => {
                const age = now - splat.timestamp;
                if (age > splatDuration) return false;
                
                // Float upward
                splat.offsetY -= 1;
                return true;
            });
            
            // Render splats
            gameState.combat.damageSplats.forEach(splat => {
                const age = now - splat.timestamp;
                const opacity = 1 - (age / splatDuration);
                
                // Draw splat background
                ctx.save();
                ctx.globalAlpha = opacity;
                
                const splatX = splat.x - gameState.camera.x;
                const splatY = splat.y - gameState.camera.y + splat.offsetY;
                
                // Background circle/box
                if (splat.damage === 0) {
                    // Miss - blue
                    ctx.fillStyle = '#4a7a9a';
                } else {
                    // Hit - red
                    ctx.fillStyle = '#ff4444';
                }
                
                // Draw rounded rectangle background
                const width = 50;
                const height = 30;
                const radius = 5;
                ctx.beginPath();
                ctx.roundRect(splatX - width/2, splatY - height/2, width, height, radius);
                ctx.fill();
                
                // Draw damage text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(splat.damage === 0 ? 'MISS' : splat.damage.toString(), splatX, splatY);
                
                ctx.restore();
            });
        }
        
        // Draw combat visual effects
        
        // Draw health bars
        function drawHealthBars() {
            if (!gameState.combat.inCombat) return;
            
            // Monster health bar
            if (gameState.combat.monster && gameState.combat.monsterHealth > 0) {
                const monsterX = gameState.combat.monsterPosition.x - gameState.camera.x;
                const monsterY = gameState.combat.monsterPosition.y - gameState.camera.y - 80;
                const barWidth = 100;
                const barHeight = 12;
                
                // Background
                ctx.fillStyle = '#2a2a2a';
                ctx.fillRect(monsterX - barWidth/2, monsterY, barWidth, barHeight);
                
                // Health
                const healthPercent = gameState.combat.monsterHealth / gameState.combat.monsterMaxHealth;
                ctx.fillStyle = healthPercent > 0.5 ? '#44ff44' : (healthPercent > 0.25 ? '#ffaa44' : '#ff4444');
                ctx.fillRect(monsterX - barWidth/2, monsterY, barWidth * healthPercent, barHeight);
                
                // Border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(monsterX - barWidth/2, monsterY, barWidth, barHeight);
                
                // Health text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText(`${gameState.combat.monsterHealth}/${gameState.combat.monsterMaxHealth}`, monsterX, monsterY + barHeight + 2);
            }
            
            // Player health bar (bottom of screen)
            const playerBarX = canvas.width / 2;
            const playerBarY = canvas.height - 40;
            const barWidth = 200;
            const barHeight = 20;
            
            // Max HP is 10 (base starting value)
            const maxHp = 10;
            const currentHp = Math.max(0, gameState.player.skills.hitpoints);
            
            // Background
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(playerBarX - barWidth/2, playerBarY, barWidth, barHeight);
            
            // Health
            const healthPercent = currentHp / maxHp;
            ctx.fillStyle = healthPercent > 0.5 ? '#44ff44' : (healthPercent > 0.25 ? '#ffaa44' : '#ff4444');
            ctx.fillRect(playerBarX - barWidth/2, playerBarY, barWidth * healthPercent, barHeight);
            
            // Border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.strokeRect(playerBarX - barWidth/2, playerBarY, barWidth, barHeight);
            
            // Health text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`HP: ${currentHp}/${maxHp}`, playerBarX, playerBarY + barHeight/2);
        }
        
        // Draw monster
        function drawMonster() {
            if (!gameState.combat.inCombat || !gameState.combat.monster || gameState.combat.monsterHealth <= 0) return;
            
            const monsterX = gameState.combat.monsterPosition.x - gameState.camera.x;
            const monsterY = gameState.combat.monsterPosition.y - gameState.camera.y;
            
            // Draw simple monster representation (can be replaced with actual sprites)
            ctx.save();
            
            // Monster body
            ctx.fillStyle = '#8a4a4a';
            ctx.beginPath();
            ctx.arc(monsterX, monsterY, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // Monster name
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeText(gameState.combat.monster.name, monsterX, monsterY - 100);
            ctx.fillText(gameState.combat.monster.name, monsterX, monsterY - 100);
            
            ctx.restore();
        }
        
        // Monster death
        function monsterDeath() {
            if (!gameState.combat.monster) return;
            
            const monster = gameState.combat.monster;
            const combatStyle = gameState.combat.combatStyle || 'melee';
            const attackStyle = gameState.combat.attackStyle || 'accurate';
            
            // Hitpoints always gets full XP
            addSkillXP('hitpoints', monster.xp);
            
            // Distribute XP based on combat and attack style
            const xpMessage = [];
            
            if (combatStyle === 'melee') {
                if (attackStyle === 'accurate') {
                    // All XP to Attack
                    addSkillXP('attack', monster.xp);
                    xpMessage.push(`+${monster.xp} Attack XP`);
                } else if (attackStyle === 'aggressive') {
                    // All XP to Strength
                    addSkillXP('strength', monster.xp);
                    xpMessage.push(`+${monster.xp} Strength XP`);
                } else if (attackStyle === 'controlled') {
                    // Split between Attack, Strength, and Defense
                    const splitXp = Math.floor(monster.xp / 3);
                    addSkillXP('attack', splitXp);
                    addSkillXP('strength', splitXp);
                    addSkillXP('defence', splitXp);
                    xpMessage.push(`+${splitXp} Attack, Strength, Defence XP`);
                }
            } else if (combatStyle === 'ranged') {
                if (attackStyle === 'rapid') {
                    // All XP to Ranged
                    addSkillXP('ranged', monster.xp);
                    xpMessage.push(`+${monster.xp} Ranged XP`);
                } else if (attackStyle === 'longrange') {
                    // Split between Ranged and Defense
                    const splitXp = Math.floor(monster.xp / 2);
                    addSkillXP('ranged', splitXp);
                    addSkillXP('defence', splitXp);
                    xpMessage.push(`+${splitXp} Ranged, Defence XP`);
                }
            } else if (combatStyle === 'magic') {
                if (attackStyle === 'accurate') {
                    // All XP to Magic
                    addSkillXP('magic', monster.xp);
                    xpMessage.push(`+${monster.xp} Magic XP`);
                } else if (attackStyle === 'longrange') {
                    // Split between Magic and Defense
                    const splitXp = Math.floor(monster.xp / 2);
                    addSkillXP('magic', splitXp);
                    addSkillXP('defence', splitXp);
                    xpMessage.push(`+${splitXp} Magic, Defence XP`);
                }
            }
            
            // Award gold
            gameState.player.inventory.gold = (gameState.player.inventory.gold || 0) + monster.gold;
            
            // Show rewards - build reward text
            let rewardParts = [`${monster.name} defeated!`, `+${monster.xp} HP XP`];
            if (xpMessage.length > 0) {
                rewardParts.push(xpMessage.join(', '));
            }
            if (monster.gold > 0) {
                rewardParts.push(`+${monster.gold} gold`);
            }
            const rewardText = rewardParts.join(', ');
            showFloatingText(rewardText, canvas.width / 2, canvas.height / 2, '#5abaaa');
            
            // Handle mob node if it exists
            if (gameState.combat.monsterNode) {
                const mobNode = gameState.combat.monsterNode;
                
                // Mark mob as not in combat
                mobNode.inCombat = false;
                
                // Return mob to spawn position
                if (mobNode.spawnX && mobNode.spawnY) {
                    mobNode.x = mobNode.spawnX;
                    mobNode.y = mobNode.spawnY;
                }
                
                // IMMEDIATELY reset health so mob can be attacked again
                mobNode.health = mobNode.maxHealth;
                
                // Just show respawn message after 5 seconds (health already reset)
                setTimeout(() => {
                    showFloatingText(`${mobNode.mobData.name} has respawned`, canvas.width / 2, 150, '#8a9aaa');
                }, 5000);
            }
            
            // End combat
            gameState.combat.inCombat = false;
            gameState.combat.monster = null;
            gameState.combat.monsterHealth = 0;
            gameState.combat.damageSplats = [];
            gameState.combat.monsterNode = null;
        }
        
        // Player death
        function playerDeath() {
            gameState.player.skills.hitpoints = 10; // Respawn with 10 HP
            
            // If there's a mob node in combat, mark it as not in combat and return to spawn
            if (gameState.combat.monsterNode) {
                const mobNode = gameState.combat.monsterNode;
                mobNode.inCombat = false;
                
                // Return mob to spawn position
                if (mobNode.spawnX && mobNode.spawnY) {
                    mobNode.x = mobNode.spawnX;
                    mobNode.y = mobNode.spawnY;
                }
            }
            
            gameState.combat.inCombat = false;
            gameState.combat.monster = null;
            gameState.combat.monsterHealth = 0;
            gameState.combat.damageSplats = [];
            gameState.combat.monsterNode = null;
            gameState.selectedZone = null; // Exit the combat zone
            
            showFloatingText('You have been defeated! Respawning...', canvas.width / 2, canvas.height / 2, '#ff4444');
        }
        
        // Update mob AI - make mobs chase player when in combat
        function updateMobs() {
            const room = rooms[gameState.currentRoom];
            if (!room.objects) return;
            
            room.objects.forEach(obj => {
                if (obj.type !== 'mob') return;
                
                // If this mob is in combat, move toward player
                if (obj.inCombat) {
                    const dx = gameState.player.x - obj.x;
                    const dy = gameState.player.y - obj.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Melee attack range - stop moving when within range
                    const ATTACK_RANGE = 100; // Increased to match player melee
                    const MOB_SPEED = 0.6; // Much slower than player to enable kiting
                    
                    if (distance > ATTACK_RANGE) {
                        // Move toward player
                        const moveX = (dx / distance) * MOB_SPEED;
                        const moveY = (dy / distance) * MOB_SPEED;
                        
                        obj.x += moveX;
                        obj.y += moveY;
                        
                        // Update combat position if this is the current combat target
                        if (gameState.combat.monsterNode === obj) {
                            gameState.combat.monsterPosition.x = obj.x;
                            gameState.combat.monsterPosition.y = obj.y;
                        }
                    }
                } else {
                    // Not in combat - slowly return to spawn position if moved
                    if (obj.spawnX && obj.spawnY) {
                        const dx = obj.spawnX - obj.x;
                        const dy = obj.spawnY - obj.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 5) {
                            const returnSpeed = 1;
                            const moveX = (dx / distance) * returnSpeed;
                            const moveY = (dy / distance) * returnSpeed;
                            
                            obj.x += moveX;
                            obj.y += moveY;
                        }
                    }
                }
            });
        }
        
        // Combat update loop (called in main game loop)
        function updateCombat() {
            if (!gameState.combat.inCombat) return;
            if (gameState.currentRoom !== 'combat') return;
            
            // AUTO-EATING SYSTEM - FIXED
            // Check if auto-eat is enabled
            if (gameState.combat.autoEat) {
                // Check if player needs to eat based on health threshold
                const healthPercent = (gameState.player.health / gameState.player.maxHealth) * 100;
                const eatThreshold = gameState.combat.eatThreshold || 50;
                
                if (healthPercent < eatThreshold) {
                    // Find food in inventory - check for type === 'food' or specific food items
                    const foodItems = gameState.player.inventory.filter(item => 
                        item && (item.type === 'food' || (item.name && (
                            item.name.includes('Cooked Fish') || 
                            item.name.includes('Roasted Acorn')
                        )))
                    );
                    
                    if (foodItems.length > 0) {
                        // Eat the first available food
                        const food = foodItems[0];
                        const healAmount = getFoodHealAmount(food.name);
                        
                        // Heal the player
                        gameState.player.health = Math.min(
                            gameState.player.health + healAmount,
                            gameState.player.maxHealth
                        );
                        
                        // Consume the food
                        food.quantity = (food.quantity || 1) - 1;
                        if (food.quantity <= 0) {
                            // Remove from inventory
                            const index = gameState.player.inventory.indexOf(food);
                            if (index > -1) {
                                gameState.player.inventory.splice(index, 1);
                            }
                        }
                        
                        // Show visual feedback
                        showFloatingText(`+${healAmount} HP (${food.name})`, gameState.player.x, gameState.player.y - 60, '#00ff00');
                        
                        // Update displays
                        updateSkillsDisplay();
                        initInventory();
                        
                        // Save game
                        saveGame();
                    }
                }
            }
            
            // Both player and monster attack on their own timers
            playerAttack();
            monsterAttack();
            
            // Update activity tracker to show current combat skill being trained
            // Only update every 30 frames (roughly twice per second) to avoid performance issues
            if (!gameState.combatTrackerFrame) gameState.combatTrackerFrame = 0;
            gameState.combatTrackerFrame++;
            if (gameState.combatTrackerFrame >= 30) {
                updateActivityTracker();
                gameState.combatTrackerFrame = 0;
            }
        }
        
        // Get healing amount from food
        function getFoodHealAmount(foodName) {
            // For testing: ALL cooked food heals +1 HP
            if (foodName.includes('Cooked Fish') || 
                foodName.includes('Roasted Acorn')) {
                return 1;
            }
            return 0;
        }
        
        // ==================== END OSRS-STYLE COMBAT MECHANICS ====================
        
        // ==================== TOOLS SYSTEM ====================
        
        // Toggle between gear and tools view
        function setupEquipmentToggle() {
            const gearBtn = document.getElementById('gearToggleBtn');
            const toolsBtn = document.getElementById('toolsToggleBtn');
            const gearGrid = document.getElementById('gearGrid');
            const toolsGrid = document.getElementById('toolsGrid');
            const bonusHeader = document.getElementById('bonusHeader');
            const gearBonuses = document.getElementById('gearBonuses');
            const toolBonuses = document.getElementById('toolBonuses');
            
            gearBtn.addEventListener('click', () => {
                gearBtn.classList.add('active');
                toolsBtn.classList.remove('active');
                gearGrid.style.display = 'grid';
                toolsGrid.classList.remove('active');
                bonusHeader.textContent = 'EQUIPMENT BONUSES';
                gearBonuses.style.display = 'block';
                toolBonuses.style.display = 'none';
            });
            
            toolsBtn.addEventListener('click', () => {
                toolsBtn.classList.add('active');
                gearBtn.classList.remove('active');
                gearGrid.style.display = 'none';
                toolsGrid.classList.add('active');
                bonusHeader.textContent = 'TOOL BONUSES';
                gearBonuses.style.display = 'none';
                toolBonuses.style.display = 'block';
                updateToolsDisplay();
            });
        }
        
        // Update tools display
        function updateToolsDisplay() {
            const toolSlots = document.querySelectorAll('#toolsGrid .equip-slot');
            
            toolSlots.forEach(slot => {
                const slotType = slot.dataset.slot;
                const slotKey = slotType.toLowerCase().replace(/ /g, '');
                const tool = gameState.player.tools[slotKey];
                
                if (tool) {
                    slot.classList.remove('empty');
                    slot.classList.add('equipped');
                    
                    // Check if tool has a sprite available
                    const hasSprite = tool.spriteKey && (gameState.sprites[tool.spriteKey] || spriteUrls[tool.spriteKey]);
                    
                    let toolDisplay = '';
                    if (hasSprite) {
                        // Use sprite image
                        const spriteImg = gameState.sprites[tool.spriteKey] || { src: spriteUrls[tool.spriteKey] };
                        toolDisplay = `
                            <img src="${spriteImg.src}" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 90%; object-fit: contain; image-rendering: pixelated;" />
                        `;
                    } else {
                        // Fallback to emoji icon
                        toolDisplay = `
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px;">
                                ${tool.icon}
                            </div>
                        `;
                    }
                    
                    // Get rarity color if available
                    let tierColor = '#5abaaa';
                    if (tool.rarity) {
                        const rarityData = getRarityData(tool.rarity.toLowerCase());
                        tierColor = rarityData.color;
                    }
                    
                    // Create tool display with tier badge
                    slot.innerHTML = `
                        ${toolDisplay}
                        <div style="position: absolute; bottom: 3px; right: 3px; background: rgba(0,0,0,0.8); color: ${tierColor}; font-size: 11px; font-weight: bold; padding: 2px 5px; border-radius: 3px; border: 1px solid ${tierColor};">
                            T${tool.tier}
                        </div>
                    `;
                } else {
                    slot.classList.add('empty');
                    slot.classList.remove('equipped');
                    slot.innerHTML = '';
                }
            });
            
            // Update tool bonuses display
            updateToolBonusesDisplay();
        }
        
        // Update tool bonuses display
        function updateToolBonusesDisplay() {
            const toolBonuses = document.getElementById('toolBonuses');
            let html = '';
            
            const skillMap = {
                axe: { name: 'Woodcutting', icon: 'ðŸª“' },
                pickaxe: { name: 'Mining', icon: 'â›ï¸' },
                fishingRod: { name: 'Fishing', icon: 'ðŸŽ£' },
                cookingUtensils: { name: 'Cooking', icon: 'ðŸ³' },
                lockpick: { name: 'Plundering', icon: 'ðŸ—ï¸' },
                hammer: { name: 'Carpentry', icon: 'ðŸ”¨' },
                needle: { name: 'Crafting', icon: 'ðŸª¡' },
                tongs: { name: 'Smithwright', icon: 'ðŸ”§' },
                grapplingHook: { name: 'Agility', icon: 'ðŸª' }
            };
            
            Object.keys(gameState.player.tools).forEach(toolKey => {
                const tool = gameState.player.tools[toolKey];
                const skillInfo = skillMap[toolKey];
                
                if (skillInfo) {
                    const bonus = tool ? `+${tool.speedBonus}%` : '0%';
                    const color = tool ? '#5abaaa' : '#5a6a7a';
                    
                    html += `
                        <div class="bonus-stat">
                            <span class="bonus-icon">${skillInfo.icon}</span>
                            <span style="font-size: 12px; color: ${color};">${skillInfo.name}: ${bonus} Speed</span>
                        </div>
                    `;
                }
            });
            
            toolBonuses.innerHTML = html;
        }
        
        // Get tool speed bonus for a skill
        function getToolSpeedBonus(skill) {
            const toolMap = {
                woodcutting: 'axe',
                mining: 'pickaxe',
                fishing: 'fishingRod',
                cooking: 'cookingUtensils',
                plundering: 'lockpick',
                carpentry: 'hammer',
                crafting: 'needle',
                smithwright: 'tongs',
                agility: 'grapplingHook'
            };
            
            const toolSlot = toolMap[skill];
            if (!toolSlot) return 0;
            
            const tool = gameState.player.tools[toolSlot];
            return tool ? tool.speedBonus : 0;
        }
        
        // Handle tool click in inventory
        function handleToolClick(item) {
            const toolData = TOOL_ITEMS[item.name];
            if (!toolData) return;
            
            const slotKey = toolData.slot;
            const currentTool = gameState.player.tools[slotKey];
            
            // Unequip current tool if exists
            if (currentTool) {
                const toolToReturn = {
                    name: currentTool.name,
                    icon: currentTool.icon,
                    quantity: 1,
                    tier: currentTool.tier,
                    speedBonus: currentTool.speedBonus,
                    skill: currentTool.skill,
                    slot: currentTool.slot,
                    type: 'tool'
                };
                
                // Preserve spriteKey and rarity if they exist
                if (currentTool.spriteKey) toolToReturn.spriteKey = currentTool.spriteKey;
                if (currentTool.rarity) toolToReturn.rarity = currentTool.rarity;
                
                gameState.player.inventory.push(toolToReturn);
            }
            
            // Equip new tool
            const newTool = {
                name: item.name,
                icon: toolData.icon,
                tier: toolData.tier,
                speedBonus: toolData.speedBonus,
                skill: toolData.skill,
                slot: toolData.slot,
                type: 'tool'
            };
            
            // Preserve spriteKey and rarity from toolData
            if (toolData.spriteKey) newTool.spriteKey = toolData.spriteKey;
            if (toolData.rarity) newTool.rarity = toolData.rarity;
            
            gameState.player.tools[slotKey] = newTool;
            
            // Remove from inventory
            const index = gameState.player.inventory.findIndex(i => i === item);
            if (index !== -1) {
                gameState.player.inventory.splice(index, 1);
            }
            
            showFloatingText(`Equipped ${item.name}!`, canvas.width / 2, 100, '#5abaaa');
            updateToolsDisplay();
            initInventory();
            saveGame();
        }
        
        // Handle tool unequip from tools panel
        function setupToolSlotClickHandlers() {
            const toolSlots = document.querySelectorAll('#toolsGrid .equip-slot');
            
            toolSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    const slotType = slot.dataset.slot;
                    const slotKey = slotType.toLowerCase().replace(/ /g, '');
                    const tool = gameState.player.tools[slotKey];
                    
                    if (tool) {
                        // Unequip tool
                        const toolToReturn = {
                            name: tool.name,
                            icon: tool.icon,
                            quantity: 1,
                            tier: tool.tier,
                            speedBonus: tool.speedBonus,
                            skill: tool.skill,
                            slot: tool.slot,
                            type: 'tool'
                        };
                        
                        // Preserve spriteKey and rarity if they exist
                        if (tool.spriteKey) toolToReturn.spriteKey = tool.spriteKey;
                        if (tool.rarity) toolToReturn.rarity = tool.rarity;
                        
                        gameState.player.inventory.push(toolToReturn);
                        
                        gameState.player.tools[slotKey] = null;
                        
                        showFloatingText(`Unequipped ${tool.name}!`, canvas.width / 2, 100, '#ff8a8a');
                        updateToolsDisplay();
                        initInventory();
                        saveGame();
                    }
                });
            });
        }
        
        // ==================== END TOOLS SYSTEM ====================
        
        // ==================== END DRAGGABLE UI SYSTEM ====================

        // Initialize
        // Load saved game data first
        loadGame();
        
        // Ensure skillXP is initialized (for backwards compatibility with old saves)
        if (!gameState.player.skillXP) {
            console.log('Initializing skillXP object');
            gameState.player.skillXP = {
                hitpoints: 0,
                attack: 0,
                mining: 0,
                strength: 0,
                agility: 0,
                defence: 0,
                fishing: 0,
                ranged: 0,
                cooking: 0,
                crafting: 0,
                carpentry: 0,
                magic: 0,
                woodcutting: 0,
                plundering: 0,
                smithwright: 0
            };
        }
        
        // Ensure carpentry skill exists (for backwards compatibility)
        if (!gameState.player.skills.carpentry) {
            gameState.player.skills.carpentry = 1;
        }
        if (!gameState.player.skillXP.carpentry) {
            gameState.player.skillXP.carpentry = 0;
        }
        
        // Ensure smithwright skill exists (for backwards compatibility)
        if (!gameState.player.skills.smithwright) {
            gameState.player.skills.smithwright = 1;
        }
        if (!gameState.player.skillXP.smithwright) {
            gameState.player.skillXP.smithwright = 0;
        }
        
        // Ensure tools exist (for backwards compatibility)
        if (!gameState.player.tools) {
            gameState.player.tools = {
                axe: null,
                pickaxe: null,
                fishingRod: null,
                cookingUtensils: null,
                chisel: null,
                hammer: null,
                needle: null,
                tongs: null,
                grapplingHook: null
            };
        }
        
        // Initialize room objects based on screen size
        initializeRoomObjects();
        
        generateTiles();
        initInventory();
        updateEquipmentDisplay();
        updateSkillsDisplay();
        setupEquipmentToggle();
        setupToolSlotClickHandlers();
        updateToolsDisplay();
        
        // Set initial room display with tier info
        if (['woodcutting', 'mining', 'fishing', 'plundering', 'agility'].includes(gameState.currentRoom)) {
            const skillLevel = gameState.player.skills[gameState.currentRoom] || 1;
            let maxTier = 1;
            if (skillLevel >= 80) maxTier = 5;
            else if (skillLevel >= 60) maxTier = 4;
            else if (skillLevel >= 40) maxTier = 3;
            else if (skillLevel >= 20) maxTier = 2;
            
            const roomName = rooms[gameState.currentRoom].name;
            document.getElementById('currentRoom').textContent = `${roomName} (T1-T${maxTier} Available)`;
        }
        
        // Ensure playerProfile has a default username
        if (!playerProfile.username) {
            playerProfile.username = 'Player';
        }
        
        // Initialize inactivity timer
        gameState.inactivityTimer = Date.now();
        
        gameLoop();
        
        // Initialize clue scrolls from inventory
        const tierGenerators = {
            'T1': generateT1ClueScrollTasks,
            'T2': generateT2ClueScrollTasks,
            'T3': generateT3ClueScrollTasks,
            'T4': generateT4ClueScrollTasks,
            'T5': generateT5ClueScrollTasks
        };
        
        ['T1', 'T2', 'T3', 'T4', 'T5'].forEach(tier => {
            const hasClueScroll = gameState.player.inventory.some(item => 
                item && item.name === `${tier} Clue Scroll`
            );
            
            // Only generate tasks if player has the clue scroll and no active tasks yet
            if (hasClueScroll && (!gameState.clueScrolls[tier] || !gameState.clueScrolls[tier].active)) {
                if (tierGenerators[tier]) {
                    tierGenerators[tier]();
                }
            }
        });
        
        // Initialize clue scroll UI if there's an active clue scroll
        updateClueScrollUI();
        
        // Add tooltip element to body
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        document.body.appendChild(tooltip);
        
        // Initial tooltip setup
        setupEquipmentTooltips();
        
        // Make Activity Tracker Draggable
        const activityTracker = document.getElementById('activityTracker');
        const dragHandle = document.getElementById('trackerDragHandle');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        // Load saved position from localStorage
        const savedPosition = localStorage.getItem('activityTrackerPosition');
        if (savedPosition) {
            const { x, y } = JSON.parse(savedPosition);
            activityTracker.style.left = x + 'px';
            activityTracker.style.right = 'auto';
            activityTracker.style.top = y + 'px';
            xOffset = x;
            yOffset = y;
        } else {
            // Initialize offset based on current position (right: 30px)
            const rect = activityTracker.getBoundingClientRect();
            xOffset = rect.left;
            yOffset = rect.top;
        }

        dragHandle.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            // Get current actual position before dragging
            const rect = activityTracker.getBoundingClientRect();
            xOffset = rect.left;
            yOffset = rect.top;
            
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === dragHandle || dragHandle.contains(e.target)) {
                isDragging = true;
                dragHandle.style.cursor = 'grabbing';
                
                // Convert from right positioning to left positioning
                activityTracker.style.left = xOffset + 'px';
                activityTracker.style.right = 'auto';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                // Keep tracker within viewport bounds
                const rect = activityTracker.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                
                xOffset = Math.max(0, Math.min(xOffset, maxX));
                yOffset = Math.max(0, Math.min(yOffset, maxY));

                activityTracker.style.left = xOffset + 'px';
                activityTracker.style.top = yOffset + 'px';
            }
        }

        function dragEnd(e) {
            if (isDragging) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                dragHandle.style.cursor = 'grab';
                
                // Save position to localStorage
                localStorage.setItem('activityTrackerPosition', JSON.stringify({ x: xOffset, y: yOffset }));
            }
        }
        
        // X button functionality  
        const xButton = document.querySelector('.cat-icon.x-btn');
        if (xButton) {
            xButton.addEventListener('click', () => {
                // Clear all category filters
                document.querySelectorAll('.cat-icon').forEach(cat => {
                    cat.classList.remove('active');
                });
                // Clear selected items
                document.querySelectorAll('.inv-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                });
                showFloatingText('Cleared', canvas.width / 2, 200, '#5abaaa');
            });
        }
        
        // Make Clue Scroll Panels Draggable and Minimizable
        ['T1', 'T2', 'T3', 'T4', 'T5'].forEach(tier => {
            const panel = document.getElementById(`clueScrollPanel_${tier}`);
            const header = panel.querySelector('.clue-scroll-header');
            const minimizeBtn = panel.querySelector('.clue-minimize-btn');
            
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            // Load saved position from localStorage
            const savedPosition = localStorage.getItem(`clueScrollPosition_${tier}`);
            if (savedPosition) {
                const { x, y, minimized } = JSON.parse(savedPosition);
                panel.style.left = x + 'px';
                panel.style.right = 'auto';
                panel.style.top = y + 'px';
                xOffset = x;
                yOffset = y;
                if (minimized) {
                    panel.classList.add('minimized');
                    minimizeBtn.textContent = '+';
                }
            }
            
            // Minimize button
            minimizeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                panel.classList.toggle('minimized');
                minimizeBtn.textContent = panel.classList.contains('minimized') ? '+' : 'âˆ’';
                
                // Save minimized state
                const rect = panel.getBoundingClientRect();
                localStorage.setItem(`clueScrollPosition_${tier}`, JSON.stringify({
                    x: rect.left,
                    y: rect.top,
                    minimized: panel.classList.contains('minimized')
                }));
            });
            
            // Dragging
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                // Don't drag if clicking on minimize button
                if (e.target.closest('.clue-minimize-btn')) {
                    return;
                }
                
                const rect = panel.getBoundingClientRect();
                xOffset = rect.left;
                yOffset = rect.top;
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                isDragging = true;
                header.style.cursor = 'grabbing';
                
                // Convert from right positioning to left positioning
                panel.style.left = xOffset + 'px';
                panel.style.right = 'auto';
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    // Keep panel within viewport bounds
                    const rect = panel.getBoundingClientRect();
                    const maxX = window.innerWidth - rect.width;
                    const maxY = window.innerHeight - rect.height;
                    
                    xOffset = Math.max(0, Math.min(xOffset, maxX));
                    yOffset = Math.max(0, Math.min(yOffset, maxY));
                    
                    panel.style.left = xOffset + 'px';
                    panel.style.top = yOffset + 'px';
                }
            }
            
            function dragEnd(e) {
                if (isDragging) {
                    isDragging = false;
                    header.style.cursor = 'grab';
                    
                    // Save position to localStorage
                    localStorage.setItem(`clueScrollPosition_${tier}`, JSON.stringify({
                        x: xOffset,
                        y: yOffset,
                        minimized: panel.classList.contains('minimized')
                    }));
                }
            }
        });
        
        // Handle monitor/window changes - force redraw when window becomes visible or is focused
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                resizeCanvas();
            }
        });
        
        window.addEventListener('focus', () => {
            resizeCanvas();
        });
        
        // Start AFK activities after a short delay
        setTimeout(() => {
            showFloatingText('Use the AFK/Manual button to toggle modes', canvas.width / 2, 100, '#FFD700');
        }, 500);
    </script>
</body>
</html>